<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Art Fest — Home & Live Scores</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg-1: #eef6ff;
      --bg-2: #f8fafc;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --muted: #6b7280;
      --card: #ffffff;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#0f172a}
    .container-wide{max-width:1200px;margin:18px auto;padding:0 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:12px;background:linear-gradient(90deg,#fff, #fbfdff);box-shadow:0 6px 22px rgba(16,24,40,0.06);margin-bottom:18px}
    .brand{font-weight:800;color:var(--accent);display:flex;gap:10px;align-items:center}
    .subtle{color:var(--muted)}
    .card-neo{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(12,20,60,0.04);border:1px solid rgba(14,39,81,0.03)}
    .team-card{border-radius:10px;padding:10px;margin:6px;border:1px solid rgba(37,99,235,0.06);background:linear-gradient(180deg,#ffffff,#fbfdff)}
    .team-name{font-weight:800}
    .score-value{font-weight:900;font-size:20px;color:var(--accent)}
    .btn-accent{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:0}
    .live-dot{width:10px;height:10px;border-radius:50%;background:#ef4444;display:inline-block;margin-right:8px;box-shadow:0 6px 18px rgba(239,68,68,0.18)}
    .leaderboard-wrap{display:flex;gap:12px;align-items:center}
    .chart-panel{min-height:260px;padding:6px;border-radius:10px}
    .search { max-width:480px; }
    @media(max-width:900px){ .leaderboard-wrap{flex-direction:column;align-items:stretch} }
    footer{margin-top:22px;text-align:center;color:var(--muted);padding:18px 0}
  </style>
</head>
<body>
  <div class="container container-wide">
    <div class="topbar">
      <div class="brand">
        <span class="badge bg-primary rounded-pill"><i class="bi bi-palette-fill"></i></span>
        <div>
          <div style="font-size:18px">Art Fest Management</div>
          <div style="font-size:12px" class="subtle">Live scores • teams • events</div>
        </div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <div class="subtle me-3">Status: <span id="connStatus">Connecting...</span></div>
        <input id="globalSearch" class="form-control form-control-sm search" placeholder="Search teams or events">
        <button id="openLogin" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-lg-7">
        <div class="card-neo">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div style="font-weight:800">Live Leaderboard</div>
              <div class="subtle" style="font-size:13px">Updated as admins publish results</div>
            </div>
            <div class="subtle" id="lastUpdate">—</div>
          </div>

          <div class="leaderboard-wrap">
            <div style="flex:1">
              <canvas id="leaderChart" style="height:360px"></canvas>
            </div>

            <div style="width:260px">
              <div style="font-weight:700;margin-bottom:8px">Top teams</div>
              <div id="topTeams" style="display:flex;flex-direction:column;gap:8px"></div>
            </div>
          </div>
        </div>

        <div class="card-neo mt-3">
          <div style="font-weight:800">Recent Events</div>
          <div id="eventsPanel" style="margin-top:10px;max-height:260px;overflow:auto"></div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card-neo">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div style="font-weight:800">Quick Access</div>
            <div class="subtle">Choose portal</div>
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#loginModal" data-role="Leader" data-page="leader.html">Leader Login</button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#loginModal" data-role="Participant" data-page="participant.html">Participant Login</button>
            <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#loginModal" data-role="Admin" data-page="admin.html">Admin Login</button>
          </div>

          <hr style="margin:14px 0">

          <div style="font-weight:700">Top Highlights</div>
          <div class="subtle mt-2" id="highlights">Loading...</div>
        </div>

        <div class="card-neo mt-3">
          <div style="font-weight:800">Search results</div>
          <div id="searchResults" style="margin-top:10px;max-height:260px;overflow:auto"></div>
        </div>
      </div>
    </div>

    <footer>&copy; <span id="year"></span> Art Fest • Live scoreboard</footer>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="loginForm">
          <div class="modal-header">
            <h5 class="modal-title" id="loginTitle">Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="loginRole" value="">
            <input type="hidden" id="loginPage" value="">

            <div id="adminFields" class="d-none">
              <label class="form-label">Admin username</label>
              <input id="adminUsername" class="form-control mb-2" value="admin">
              <label class="form-label">Password</label>
              <input id="adminPassword" type="password" class="form-control" placeholder="••••••">
            </div>

            <div id="leaderFields" class="d-none">
              <label class="form-label">Team</label>
              <select id="leaderTeamSelect" class="form-select mb-2"><option>Loading teams...</option></select>
              <label class="form-label">Team Password</label>
              <input id="leaderPassword" type="password" class="form-control" placeholder="Team password (leave blank if none)">
            </div>

            <div id="participantFields" class="d-none">
              <label class="form-label">Chess #</label>
              <input id="participantChess" class="form-control" placeholder="e.g. 1234 or A12">
            </div>

            <div id="loginError" class="text-danger small mt-2 d-none"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            <button id="loginSubmit" class="btn btn-primary" type="submit">Login</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Toast root -->
  <div id="toastRoot" style="position:fixed;right:18px;bottom:18px;z-index:12000"></div>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase + app script (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // ====== CONFIG: use your project's config ======
    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ====== UI helpers ======
    const $ = id => document.getElementById(id);
    function toast(msg, kind='light') {
      const t = document.createElement('div');
      t.className = 'toast align-items-center text-bg-' + (kind==='light'?'dark':kind) + ' border-0';
      t.style.minWidth = '220px';
      t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      $('toastRoot').appendChild(t);
      const bs = new bootstrap.Toast(t, { delay: 3500 });
      bs.show();
      t.addEventListener('hidden.bs.toast', ()=> t.remove());
    }
    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // ====== Elements ======
    const connStatus = $('connStatus'), lastUpdate = $('lastUpdate'), topTeams = $('topTeams'), eventsPanel = $('eventsPanel');
    const leaderChartCtx = $('leaderChart').getContext('2d');
    const searchInput = $('globalSearch'), searchResults = $('searchResults'), highlights = $('highlights');

    // login elements
    const loginModal = document.getElementById('loginModal');
    const loginModalInstance = bootstrap.Modal.getOrCreateInstance(loginModal);
    const loginRoleField = $('loginRole'), loginPageField = $('loginPage');
    const adminFields = $('adminFields'), leaderFields = $('leaderFields'), participantFields = $('participantFields');
    const leaderTeamSelect = $('leaderTeamSelect'), leaderPassword = $('leaderPassword'), participantChess = $('participantChess');
    const loginError = $('loginError');

    // admin credentials (change as needed)
    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = '1234';

    // data caches
    let TEAMS = []; // array of team objects
    let TEAMS_DBKEY = {}; // id -> dbKey in firebase
    let STUDENTS = [];
    let EVENTS = [];
    let PARTICIPATIONS = [];
    let RESULTS = [];
    let ATTENDANCE = {};

    // ====== Chart setup ======
    let leaderChart = new Chart(leaderChartCtx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label:'Score', data: [], backgroundColor: [], borderRadius:8 }] },
      options: {
        indexAxis: 'y',
        animation: { duration: 800 },
        plugins: { legend: { display: false } },
        scales: { x: { grid: { color: 'rgba(12,20,40,0.04)' }, ticks: { color: '#334155' } }, y: { ticks: { color: '#334155' } } }
      }
    });

    // ====== Firebase listeners ======
    onValue(ref(db, 'teams'), snap => {
      const v = snap.val() || {};
      TEAMS = Object.values(v);
      TEAMS_DBKEY = {};
      Object.entries(v).forEach(([k,obj]) => { if(obj && obj.id !== undefined) TEAMS_DBKEY[String(obj.id)] = k; });
      renderLeaderboard();
      populateLeaderTeamSelect();
      $('connStatus').textContent = 'Connected';
      $('lastUpdate').textContent = new Date().toLocaleTimeString();
      $('year').textContent = new Date().getFullYear();
    });

    onValue(ref(db, 'students'), snap => { STUDENTS = Object.values(snap.val() || {}); renderEventsPanel(); });
    onValue(ref(db, 'events'), snap => { EVENTS = Object.values(snap.val() || {}); renderEventsPanel(); });
    onValue(ref(db, 'participations'), snap => { PARTICIPATIONS = Object.values(snap.val() || {}); renderEventsPanel(); });
    onValue(ref(db, 'results'), snap => { RESULTS = Object.values(snap.val() || {}); renderLeaderboard(); renderEventsPanel(); });
    onValue(ref(db, 'attendance'), snap => { ATTENDANCE = snap.val() || {}; /* may use later */ });

    // ====== Rendering functions ======
    function renderLeaderboard(){
      // sort teams by score desc then name
      const arr = (TEAMS || []).slice().sort((a,b) => {
        const sa = Number(a.score || 0), sb = Number(b.score || 0);
        if(sb !== sa) return sb - sa;
        return (a.name||'').localeCompare(b.name||'');
      });

      // top 8 for chart
      const top = arr.slice(0, 8);
      leaderChart.data.labels = top.map(t => t.name || t.id);
      leaderChart.data.datasets[0].data = top.map(t => Number(t.score || 0));
      leaderChart.data.datasets[0].backgroundColor = top.map((t,i) => i === 0 ? 'rgba(37,99,235,0.95)' : `rgba(96,165,250,${0.22 + i*0.04})`);
      leaderChart.update();

      // populate topTeams list
      topTeams.innerHTML = '';
      top.forEach((t, idx) => {
        const div = document.createElement('div');
        div.className = 'team-card d-flex justify-content-between align-items-center';
        div.innerHTML = `<div><div class="team-name">${escapeHtml(t.name || t.id)}</div><div class="subtle" style="font-size:13px">Team ID: ${escapeHtml(String(t.id))}</div></div><div class="text-end"><div class="score-value">${Number(t.score||0)}</div><div class="subtle" style="font-size:12px">${t.leaderId?('Leader: '+escapeHtml(String(t.leaderId))):''}</div></div>`;
        topTeams.appendChild(div);
      });

      // highlights (top 3)
      const h = top.slice(0,3).map((t,i) => `${i+1}. ${escapeHtml(t.name||t.id)} — ${Number(t.score||0)} pts`).join('<br>');
      highlights.innerHTML = h || 'No teams yet';
      lastUpdate.textContent = new Date().toLocaleTimeString();
    }

    function renderEventsPanel(){
      // show latest events and whether they have results/participants
      eventsPanel.innerHTML = '';
      if(!EVENTS.length) { eventsPanel.innerHTML = '<div class="subtle">No events</div>'; return; }
      // sort by createdAt desc if available else by name
      const arr = EVENTS.slice().sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      arr.forEach(ev => {
        const participants = PARTICIPATIONS.filter(p => String(p.eventId) === String(ev.id));
        const approved = participants.filter(p => String(p.status||'').toLowerCase() === 'approved').length;
        const anyResult = RESULTS.some(r => String(r.eventId) === String(ev.id));
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center p-2';
        div.innerHTML = `<div><div style="font-weight:700">${escapeHtml(ev.name)}</div><div class="subtle" style="font-size:13px">${escapeHtml(ev.type||'')} · ${escapeHtml(ev.level||'')}</div></div><div style="text-align:right"><div class="subtle" style="font-size:13px">${approved} approved</div>${anyResult?'<div class="badge bg-success">Result</div>':''}</div>`;
        eventsPanel.appendChild(div);
      });
    }

    // ====== Leader team select population for login modal ======
    function populateLeaderTeamSelect(){
      const sel = leaderTeamSelect;
      const prev = sel.value;
      sel.innerHTML = '<option value="">Select team</option>';
      (TEAMS || []).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(t => {
        sel.innerHTML += `<option value="${encodeURIComponent(String(t.id))}">${escapeHtml(t.name||t.id)}</option>`;
      });
      try { if(prev) sel.value = prev; } catch(e){}
    }

    // ====== Login modal behavior ======
    // show appropriate fields depending on which login button opened modal
    document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#loginModal"]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        const role = btn.dataset.role || 'Leader';
        const page = btn.dataset.page || (role === 'Leader' ? 'leader.html' : role === 'Participant' ? 'participant.html' : 'admin.html');
        $('loginTitle').textContent = role + ' Login';
        loginRoleField.value = role;
        loginPageField.value = page;
        loginError.classList.add('d-none');
        // show/hide fields
        adminFields.classList.toggle('d-none', role!=='Admin');
        leaderFields.classList.toggle('d-none', role!=='Leader');
        participantFields.classList.toggle('d-none', role!=='Participant');
        // pre-populate team select
        populateLeaderTeamSelect();
      });
    });

    // handle login form
    $('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.classList.add('d-none');
      const role = loginRoleField.value;
      const page = loginPageField.value;
      if(role === 'Admin'){
        const u = $('adminUsername').value.trim();
        const p = $('adminPassword').value || '';
        if(u === ADMIN_USERNAME && p === ADMIN_PASSWORD){
          // set session + redirect
          sessionStorage.setItem('user', JSON.stringify({ role:'Admin', username: u }));
          loginModalInstance.hide();
          window.location.href = page;
          return;
        } else {
          showLoginError('Invalid admin credentials');
          return;
        }
      }

      if(role === 'Leader'){
        const encodedTid = leaderTeamSelect.value;
        if(!encodedTid){ showLoginError('Select a team'); return; }
        const tid = decodeURIComponent(encodedTid);
        const team = (TEAMS || []).find(t => String(t.id) === String(tid));
        if(!team){ showLoginError('Team not found'); return; }
        const pwd = (leaderPassword.value || '').toString();
        const expected = (team.password || '').toString();
        if(expected === '' || pwd === expected){
          // on success: store session and redirect to leader page with ?leader=LEADERCHESS
          // set session storage with leader info so leader page can auto-detect
          sessionStorage.setItem('user', JSON.stringify({ role:'Leader', teamId: String(tid), leaderId: String(team.leaderId || '') }));
          loginModalInstance.hide();
          // prefer redirect with ?leader=CHESS (leaderId)
          const leaderChess = team.leaderId || '';
          const redirectUrl = page + (leaderChess ? `?leader=${encodeURIComponent(String(leaderChess))}` : `?team=${encodeURIComponent(String(tid))}`);
          window.location.href = redirectUrl;
          return;
        } else {
          showLoginError('Incorrect team password');
          return;
        }
      }

      if(role === 'Participant'){
        const chess = participantChess.value.trim();
        if(!chess){ showLoginError('Enter chess number'); return; }
        // look up students in cache
        // students are objects with id field (chess) or maybe key is chess
        // attempt to find matching student
        const found = (STUDENTS || []).find(s => String(s.id) === String(chess) || String(s.chess || '') === String(chess));
        if(found){
          sessionStorage.setItem('user', JSON.stringify({ role:'Participant', studentId: String(found.id) }));
          loginModalInstance.hide();
          window.location.href = page + `?chess=${encodeURIComponent(String(found.id))}`;
          return;
        } else {
          // fallback: try firebase read once (possibility encoding differ)
          try {
            const snap = await get(ref(db, `students/${encodeURIComponent(chess)}`));
            if(snap.exists()){
              sessionStorage.setItem('user', JSON.stringify({ role:'Participant', studentId: String(chess) }));
              loginModalInstance.hide();
              window.location.href = page + `?chess=${encodeURIComponent(chess)}`;
              return;
            }
          } catch(_) {}
          showLoginError('Participant not found');
          return;
        }
      }

      showLoginError('Unsupported role');
    });

    function showLoginError(msg){
      loginError.textContent = msg;
      loginError.classList.remove('d-none');
    }

    // ====== search handling ======
    searchInput.addEventListener('input', (e) => {
      const q = (e.target.value || '').trim().toLowerCase();
      if(!q){ searchResults.innerHTML = '<div class="subtle">No search query</div>'; return; }
      const teamsMatched = (TEAMS || []).filter(t => (t.name||'').toLowerCase().includes(q) || String(t.id||'').toLowerCase().includes(q));
      const eventsMatched = (EVENTS || []).filter(ev => (ev.name||'').toLowerCase().includes(q) || (ev.type||'').toLowerCase().includes(q));
      let html = '';
      if(teamsMatched.length){
        html += `<div style="font-weight:700">Teams</div>`;
        teamsMatched.slice(0,10).forEach(t => html += `<div class="p-2">${escapeHtml(t.name||t.id)} — ${Number(t.score||0)} pts</div>`);
      }
      if(eventsMatched.length){
        html += `<div style="font-weight:700;margin-top:6px">Events</div>`;
        eventsMatched.slice(0,10).forEach(ev => html += `<div class="p-2">${escapeHtml(ev.name)} — ${escapeHtml(ev.type||'')} ${escapeHtml(ev.level||'')}</div>`);
      }
      if(!html) html = '<div class="subtle">No results</div>';
      searchResults.innerHTML = html;
    });

    // ====== Helpers & small UX touches ======
    // animate top teams when updated: keep a snapshot of previous scores
    let LAST_SCORES = {};
    function animateTopChanges(){
      (TEAMS || []).forEach(t => {
        const prev = LAST_SCORES[t.id] || 0;
        const now = Number(t.score || 0);
        if(prev !== now){
          // find matching node in topTeams and flash it
          const nodes = topTeams.querySelectorAll('.team-card');
          nodes.forEach(n => {
            if(n.textContent.includes(String(t.name || t.id))){
              n.classList.add('border-2');
              n.style.transition = 'transform .35s ease';
              n.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.02)' }, { transform: 'scale(1)' }], { duration: 450 });
            }
          });
        }
        LAST_SCORES[t.id] = now;
      });
    }

    // call animateTopChanges each time leaderboard renders
    const origRenderLeaderboard = renderLeaderboard;
    renderLeaderboard = function(){
      origRenderLeaderboard();
      animateTopChanges();
    };

    // initial UI text
    $('highlights').textContent = 'Waiting for data...';
    $('searchResults').innerHTML = '<div class="subtle">Search for teams or events</div>';

    // small defensive init in case Firebase connection slow
    setTimeout(()=> {
      if(($('connStatus').textContent || '') === 'Connecting...') $('connStatus').textContent = 'Connecting...';
    }, 2000);

    // Expose debug objects
    window._ARTFEST = { TEAMS, EVENTS, STUDENTS, RESULTS, PARTICIPATIONS };

  </script>
</body>
</html>