<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Art Fest Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    body {
      background: #eef3ff;
      font-family: "Inter", system-ui, sans-serif;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(12px);
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 6px 20px rgba(0, 20, 60, 0.06);
      transition: 0.2s ease;
    }

    .glass-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 14px 30px rgba(0, 20, 60, 0.10);
    }

    .login-card {
      background: rgba(255, 255, 255, 0.55);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.05);
    }

    .hero {
      padding: 50px 0;
      text-align: center;
    }

    .score-card {
      border-radius: 14px;
      background: white;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
      text-align: center;
    }

    .score-num {
      font-size: 40px;
      font-weight: 900;
      color: #1c2b5e;
    }

    /* Leader preview */
    #leaderTeamBox {
      background: #ffffffa8;
      border: 1px solid #d4ddff;
      padding: 10px;
      border-radius: 10px;
      transition: 0.3s ease;
    }

    .score-bar {
      height: 10px;
      background: #e6e9ff;
      border-radius: 6px;
      overflow: hidden;
    }

    .inner-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4b7dff, #8b5dff);
      transition: width 0.4s ease;
    }

    .btn-main {
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 15px;
      width: 100%;
    }

  </style>
</head>

<body>

  <nav class="navbar bg-white shadow-sm">
    <div class="container d-flex justify-content-between">
      <span class="fw-bold text-primary">ðŸŽ¨ Art Fest Portal</span>
      <span class="text-muted">Status: <span id="connStatus">Connecting...</span></span>
    </div>
  </nav>

  <main class="container py-4">

    <!-- HERO -->
    <div class="hero">
      <h1 class="fw-bold">Welcome to Art Fest</h1>
      <p class="text-muted">Choose your portal and continue</p>
    </div>

    <!-- LOGIN OPTIONS -->
    <div class="row g-4">
      <div class="col-md-4">
        <div class="glass-card text-center">
          <i class="bi bi-shield-lock fs-1 text-primary"></i>
          <h5 class="mt-2">Admin Portal</h5>
          <button class="btn btn-primary mt-2 btn-main" data-bs-toggle="modal" data-bs-target="#loginModal"
            data-role="Admin" data-page="admin.html">
            Login as Admin
          </button>
        </div>
      </div>

      <div class="col-md-4">
        <div class="glass-card text-center">
          <i class="bi bi-people-fill fs-1 text-success"></i>
          <h5 class="mt-2">Leader Portal</h5>
          <button class="btn btn-success mt-2 btn-main" data-bs-toggle="modal" data-bs-target="#loginModal"
            data-role="Leader" data-page="leader.html">
            Login as Leader
          </button>
        </div>
      </div>

      <div class="col-md-4">
        <div class="glass-card text-center">
          <i class="bi bi-person-circle fs-1 text-info"></i>
          <h5 class="mt-2">Participant Portal</h5>
          <button class="btn btn-info mt-2 btn-main" data-bs-toggle="modal" data-bs-target="#loginModal"
            data-role="Participant" data-page="participant.html">
            Login as Participant
          </button>
        </div>
      </div>
    </div>

    <!-- LIVE SCOREBOARD -->
    <div class="mt-5">
      <h4 class="fw-bold mb-2">Live Scoreboard</h4>
      <div id="scoreGrid" class="row g-3"></div>
    </div>

  </main>

  <!-- LOGIN MODAL -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <form id="loginForm">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">

            <input type="hidden" id="login-role">
            <input type="hidden" id="login-page">

            <!-- Admin -->
            <div id="adminFields" class="d-none">
              <input id="adminUsername" class="form-control mb-2" placeholder="Admin Username">
              <input id="adminPassword" type="password" class="form-control mb-2" placeholder="Password">
            </div>

            <!-- Leader -->
            <div id="leaderFields" class="d-none">
              <input id="leaderChess" class="form-control mb-2" placeholder="Leader Chess #" />
              <input id="leaderPass" type="password" class="form-control mb-2" placeholder="Team Password" />

              <div id="leaderTeamBox" class="d-none">
                <div><b>Team:</b> <span id="leaderTeamName">â€”</span></div>
                <div><b>Score:</b> <span id="leaderTeamScore">0</span></div>
                <div class="score-bar mt-2"><div id="leaderTeamBar" class="inner-bar"></div></div>
              </div>
            </div>

            <!-- Participant -->
            <div id="participantField" class="d-none">
              <input id="participantChess" class="form-control mb-2" placeholder="Chess Number">
            </div>

            <div id="loginError" class="text-danger small d-none"></div>

          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Continue</button>
          </div>

        </form>

      </div>
    </div>
  </div>

  <!-- Toasts -->
  <div id="toastRoot" style="position:fixed;right:20px;bottom:20px;z-index:10000;"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    /* CONFIG */
    const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = id => document.getElementById(id);

    /* ---------------------------
       SHOW LOGIN FIELDS BASED ON ROLE
    ---------------------------- */
    document.querySelectorAll("[data-bs-target='#loginModal']").forEach(btn => {
      btn.addEventListener("click", () => {
        const role = btn.dataset.role;
        const page = btn.dataset.page;

        $("login-role").value = role;
        $("login-page").value = page;

        $("adminFields").classList.add("d-none");
        $("leaderFields").classList.add("d-none");
        $("participantField").classList.add("d-none");

        if (role === "Admin") $("adminFields").classList.remove("d-none");
        if (role === "Leader") $("leaderFields").classList.remove("d-none");
        if (role === "Participant") $("participantField").classList.remove("d-none");
      });
    });

    /* ---------------------------
       LIVE LEADER TEAM PREVIEW
    ---------------------------- */
    async function updateLeaderPreview() {
      const chess = $("leaderChess").value.trim();
      const pass = $("leaderPass").value.trim();
      const box = $("leaderTeamBox");

      if (!chess || !pass) {
        box.classList.add("d-none");
        return;
      }

      const teams = (await get(ref(db, "teams"))).val() || {};

      for (let key in teams) {
        const t = teams[key];
        if (String(t.leaderId) === chess && String(t.password) === pass) {
          $("leaderTeamName").textContent = t.name;
          animateScore($("leaderTeamScore"), $("leaderTeamBar"), Number(t.score || 0));
          box.classList.remove("d-none");
          return;
        }
      }

      box.classList.add("d-none");
    }

    $("leaderChess").addEventListener("input", updateLeaderPreview);
    $("leaderPass").addEventListener("input", updateLeaderPreview);

    /* ---------------------------
       SCORE ANIMATION
    ---------------------------- */
    function animateScore(numEl, barEl, target) {
      let val = 0;
      const step = Math.max(1, Math.floor(target / 40));

      const timer = setInterval(() => {
        val += step;
        if (val >= target) {
          val = target;
          clearInterval(timer);
        }
        numEl.textContent = val;
        barEl.style.width = Math.min(val, 100) + "%";
      }, 20);
    }

    /* ---------------------------
       LOGIN HANDLER
    ---------------------------- */
    $("loginForm").addEventListener("submit", async e => {
      e.preventDefault();
      const role = $("login-role").value;
      const page = $("login-page").value;

      /* ADMIN */
      if (role === "Admin") {
        if ($("adminUsername").value === "admin" &&
          $("adminPassword").value === "1234") {
          sessionStorage.setItem("user", JSON.stringify({ role: "Admin" }));
          location.href = page;
          return;
        }
        return showError("Invalid admin credentials");
      }

      /* LEADER */
      if (role === "Leader") {
        const chess = $("leaderChess").value.trim();
        const pass = $("leaderPass").value.trim();
        const teams = (await get(ref(db, "teams"))).val() || {};

        for (let k in teams) {
          const t = teams[k];
          if (String(t.leaderId) === chess && String(t.password) === pass) {
            sessionStorage.setItem("user",
              JSON.stringify({ role: "Leader", leaderId: chess, teamId: t.id }));
            location.href = page + "?leader=" + chess;
            return;
          }
        }
        return showError("Invalid leader credentials");
      }

      /* PARTICIPANT */
      if (role === "Participant") {
        const chess = $("participantChess").value.trim();
        const students = (await get(ref(db, "students"))).val() || {};

        for (let k in students) {
          if (String(students[k].id) === chess) {
            sessionStorage.setItem("user", JSON.stringify({ role: "Participant", id: chess }));
            location.href = page + "?id=" + chess;
            return;
          }
        }

        return showError("No participant found with that chess number");
      }
    });

    function showError(msg) {
      $("loginError").textContent = msg;
      $("loginError").classList.remove("d-none");
    }

    /* ---------------------------
       LIVE SCOREBOARD
    ---------------------------- */
    onValue(ref(db, "teams"), snap => {
      const teams = snap.val() || {};
      const grid = $("scoreGrid");
      grid.innerHTML = "";

      Object.values(teams)
        .sort((a, b) => Number(b.score || 0) - Number(a.score || 0))
        .forEach(t => {
          const div = document.createElement("div");
          div.className = "col-md-3";
          div.innerHTML = `
            <div class="score-card">
              <div class="fw-bold">${t.name}</div>
              <div class="score-num" data-score>${t.score || 0}</div>
            </div>`;
          grid.appendChild(div);
        });
    });

  </script>

</body>

</html>