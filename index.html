<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Art Fest — Entry</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .hero { padding: 4rem 0; text-align:center; background: #eaf2ff }
    .role-card { border-radius: 12px; transition: transform .18s ease; }
    .role-card:hover { transform: translateY(-6px); }
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary" href="#">Art Fest Management</a>
    </div>
  </nav>

  <header class="hero">
    <div class="container">
      <h1 class="display-5 fw-bold">Welcome to Art Fest</h1>
      <p class="lead text-muted">Choose your portal — Admin, Team Leader or Participant.</p>
    </div>
  </header>

  <main class="container py-5">
    <div class="row g-4 justify-content-center">
      <div class="col-lg-4 col-md-6">
        <div class="card role-card shadow-sm p-4 text-center">
          <i class="bi bi-shield-lock display-3 text-primary mb-3"></i>
          <h4 class="mb-2">Admin Portal</h4>
          <p class="text-muted">Full control over events, teams, attendance and results.</p>
          <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#loginModal" data-role="Admin" data-page="admin.html">Login as Admin</button>
        </div>
      </div>

      <div class="col-lg-4 col-md-6">
        <div class="card role-card shadow-sm p-4 text-center">
          <i class="bi bi-people-fill display-3 text-success mb-3"></i>
          <h4 class="mb-2">Team Leader Portal</h4>
          <p class="text-muted">Manage your team and submit participants to events.</p>
          <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#loginModal" data-role="Leader" data-page="leader.html">Login as Leader</button>
        </div>
      </div>

      <div class="col-lg-4 col-md-6">
        <div class="card role-card shadow-sm p-4 text-center">
          <i class="bi bi-person-fill display-3 text-info mb-3"></i>
          <h4 class="mb-2">Participant Portal</h4>
          <p class="text-muted">View your events, results and attendance.</p>
          <button class="btn btn-info mt-2" data-bs-toggle="modal" data-bs-target="#loginModal" data-role="Participant" data-page="participant.html">Login as Participant</button>
        </div>
      </div>
    </div>
  </main>

  <footer class="py-4 text-center text-muted">
    &copy; <span id="current-year"></span> Art Fest Management
  </footer>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="loginForm">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="login-role" value="">
            <input type="hidden" id="login-page" value="">

            <div id="field-username" class="mb-3">
              <label class="form-label">Username</label>
              <input id="username" class="form-control" placeholder="admin" />
            </div>

            <div id="field-password" class="mb-3">
              <label class="form-label">Password</label>
              <input id="password" type="password" class="form-control" placeholder="••••••" />
            </div>

            <div id="field-chess" class="mb-3 d-none">
              <label class="form-label">Chess Number</label>
              <input id="chessNumber" class="form-control" placeholder="Enter chess number (e.g. 1234)" />
            </div>

            <div id="login-error" class="text-danger small d-none"></div>
          </div>

          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button id="loginBtn" type="submit" class="btn btn-primary">Login</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase + Login Script (module) -->
  <script type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // --- UI bindings ---
    const loginModal = document.getElementById('loginModal');
    const loginForm = document.getElementById('loginForm');
    const loginModalEl = bootstrap.Modal.getOrCreateInstance(loginModal);
    const loginModalLabel = document.getElementById('loginModalLabel');

    const fieldUsername = document.getElementById('field-username');
    const fieldPassword = document.getElementById('field-password');
    const fieldChess = document.getElementById('field-chess');

    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const chessInput = document.getElementById('chessNumber');

    const loginRoleInput = document.getElementById('login-role');
    const loginPageInput = document.getElementById('login-page');
    const loginError = document.getElementById('login-error');

    // Default admin credentials (Option A)
    // Change ADMIN_PASSWORD here if you want a different one.
    const ADMIN_USERNAME = 'admin';
    const ADMIN_PASSWORD = '1234';

    // When a role button opens the modal, adapt the fields
    document.querySelectorAll('[data-bs-toggle="modal"][data-bs-target="#loginModal"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const role = btn.dataset.role;
        const page = btn.dataset.page;
        loginRoleInput.value = role;
        loginPageInput.value = page;
        loginError.classList.add('d-none');
        usernameInput.value = '';
        passwordInput.value = '';
        chessInput.value = '';

        if (role === 'Admin') {
          loginModalLabel.textContent = 'Admin Login';
          fieldUsername.classList.remove('d-none');
          fieldPassword.classList.remove('d-none');
          fieldChess.classList.add('d-none');
        } else {
          // Leader or Participant: only chess number needed
          loginModalLabel.textContent = role + ' Login';
          fieldUsername.classList.add('d-none');
          fieldPassword.classList.add('d-none');
          fieldChess.classList.remove('d-none');
        }
      });
    });

    // Utility: show error text inside modal
    function showLoginError(msg) {
      loginError.textContent = msg;
      loginError.classList.remove('d-none');
    }

    // On submit, perform role-specific checks and redirect
    loginForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      loginError.classList.add('d-none');
      const role = loginRoleInput.value;
      const page = loginPageInput.value;

      try {
        if (role === 'Admin') {
          const uname = usernameInput.value.trim();
          const pwd = passwordInput.value;
          if (uname === ADMIN_USERNAME && pwd === ADMIN_PASSWORD) {
            sessionStorage.setItem('user', JSON.stringify({ role: 'Admin', username: uname }));
            loginModalEl.hide();
            location.href = page;
            return;
          } else {
            showLoginError('Invalid admin username or password.');
            return;
          }
        }

        // Leader or Participant: use chessNumber and verify existence in Firebase
        const chessRaw = chessInput.value.trim();
        if (!chessRaw) { showLoginError('Enter your chess number.'); return; }
        const chessNum = parseInt(chessRaw, 10);
        if (Number.isNaN(chessNum)) { showLoginError('Chess number must be numeric.'); return; }

        // read students and teams from firebase once
        const dbRef = ref(database);
        const snapshot = await get(dbRef);
        const data = snapshot.val() || {};

        // participant: check student exists
        if (role === 'Participant') {
          const students = data.students || {};
          if (students[String(chessNum)]) {
            sessionStorage.setItem('user', JSON.stringify({ role: 'Participant', studentId: chessNum }));
            loginModalEl.hide();
            location.href = page;
            return;
          } else {
            showLoginError('No participant found with that chess number.');
            return;
          }
        }

        // leader: find a team whose leaderId equals chessNum
        if (role === 'Leader') {
          const teams = data.teams || {};
          // teams stored as objects - search through them
          const teamEntries = Object.entries(teams);
          const found = teamEntries.find(([key, t]) => {
            // t.leaderId may be number or string
            return t && (t.leaderId === chessNum || t.leaderId === String(chessNum));
          });

          if (found) {
            const [teamKey, teamObj] = found;
            sessionStorage.setItem('user', JSON.stringify({
              role: 'Leader',
              leaderId: chessNum,
              teamId: teamObj.id || parseInt(teamKey, 10),
              teamName: teamObj.name || ''
            }));
            loginModalEl.hide();
            location.href = page;
            return;
          } else {
            showLoginError('No team found with that leader chess number.');
            return;
          }
        }

        showLoginError('Unsupported role.');
      } catch (err) {
        console.error('Login error', err);
        showLoginError('Network or Firebase error. Check console for details.');
      }
    });

    // small UX: auto-fill admin username on modal open
    document.getElementById('loginModal').addEventListener('shown.bs.modal', () => {
      if (loginRoleInput.value === 'Admin') {
        usernameInput.focus();
        usernameInput.value = ADMIN_USERNAME;
      } else {
        chessInput.focus();
      }
    });

    // current year in footer
    document.getElementById('current-year').textContent = new Date().getFullYear();

  </script>
</body>
</html>
