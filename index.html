<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markaz Fest | Portal</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<style>
/* -------------------------------------- */
/* UI OVERHAUL (Matching Admin/Leader Dark Theme) */
/* -------------------------------------- */
:root{
  /* Main Palette */
  --bg: #0d121c; /* Deep Dark Blue */
  --card: #1c2738; /* Card Background */
  --text: #e2e8f0; /* Off-White Text */
  --muted: #94a3b8; /* Slate Grey Muted */
  
  /* Accents */
  --accent-main: #f97316; /* Vibrant Orange */
  --accent-secondary: #3b82f6; /* Bright Blue */
  --success: #10b981;
  --danger: #ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

/* Layout */
.container-portal{
  max-width:450px; /* Reduced width for mobile-first feel */
  margin:auto;
  padding:16px;
}
.card-ui{
  background:var(--card);
  border-radius:14px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  margin-bottom:16px;
  border: 1px solid #334155;
}

/* Navbar (Simplified for home page) */
.navbar{
  background:var(--bg);
  padding:12px 16px;
  display:flex;
  justify-content:center;
  align-items:center;
  border-bottom:1px solid #334155;
}
.brand{
  font-weight:900;
  color:var(--accent-main);
  font-size:1.8rem;
}

/* Buttons */
.btn{
  padding:12px 14px;
  border-radius:10px;
  border:none;
  font-weight:700;
  cursor:pointer;
  transition: background 0.2s;
}
.btn-primary{ background:var(--accent-secondary); color:#fff; }
.btn-primary:hover{ background:#2563eb; color:#fff; }
.btn-success{ background:var(--success); color:#fff; }
.btn-success:hover{ background:#059669; color:#fff; }
.btn-outline-primary{ border:2px solid var(--accent-main); color:var(--accent-main); background:transparent;}
.btn-outline-primary:hover{ background:var(--accent-main); color:#fff; }
.btn-danger{ background:var(--danger); color:#fff; }

/* Stats Grid (1 column on mobile, 3 on desktop) */
.stats{
  display:grid;
  grid-template-columns:1fr; /* Single column on mobile */
  gap:12px;
  margin-top: 20px;
}
.stat{
  background:#334155;
  border-radius:10px;
  padding:16px;
  text-align:left;
  border-left: 5px solid var(--accent-secondary);
}
.stat h4{
  margin:0;
  font-size:2rem;
  font-weight:900;
}
.stat small{
  font-size:13px;
  color:var(--muted);
}
@media(min-width:768px){
  .stats{
    grid-template-columns:repeat(3,1fr);
  }
}

/* Score List */
.score-item{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  color:var(--text);
  border-bottom:1px dashed #334155;
  font-weight: 500;
}
.score-item:last-child{border-bottom:none}

/* Animated Chart Placeholder */
.chart-container {
    height: 150px;
    padding-top: 15px;
    background: #334155;
    border-radius: 10px;
    margin-top: 15px;
}
.bar {
    background: linear-gradient(to top, var(--accent-main), var(--accent-secondary));
    border-radius: 4px 4px 0 0;
    width: 10px;
    margin: 0 4px;
    transition: height 1.5s ease-out;
    height: 0;
    display: inline-block;
    vertical-align: bottom;
}

/* Modals */
.modal-content{ background: var(--card); color: var(--text); }
.modal-header{ border-bottom: 1px solid #334155; }
.modal-footer{ border-top: 1px solid #334155; }
.form-label { color: var(--text); }
.form-control, .form-select { background: #334155; border-color: #475569; color: var(--text); }
.form-control:focus, .form-select:focus { background: #334155; border-color: var(--accent-secondary); box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); }
.btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
</style>
</head>

<body>
<nav class="navbar">
  <div class="brand">Markaz Fest Portal</div>
</nav>

<div class="container-portal d-flex align-items-center justify-content-center min-vh-100">
  <div class="w-100">

    <div class="text-center mb-4">
      <h2 class="fw-bold text-light">Management Portal</h2>
      <div class="muted">Select your access level</div>
    </div>

    <div class="card-ui">
        <h6 class="fw-bold mb-3 text-light">Login Options</h6>
        <div class="d-grid gap-3">
          <button class="btn btn-primary" id="btnAdmin">
            <i class="bi bi-shield-lock"></i> Admin Login
          </button>
          <button class="btn btn-success" id="btnLeader">
            <i class="bi bi-people"></i> Leader Login
          </button>
          <button class="btn btn-outline-primary" id="btnParticipant">
            <i class="bi bi-person"></i> Participant Login
          </button>
        </div>
    </div>
    
    <div class="card-ui">
        <div class="stats">
          <div class="stat">
            <h4 id="statStudents">0</h4>
            <small>Students</small>
          </div>
          <div class="stat">
            <h4 id="statEvents">0</h4>
            <small>Programs</small>
          </div>
          <div class="stat">
            <h4 id="statTeams">0</h4>
            <small>Teams</small>
          </div>
        </div>
    </div>


    <div class="card-ui">
      <h6 class="fw-bold text-light">Live Team Scores (Animated)</h6>
      <div class="chart-container d-flex justify-content-around align-items-end" id="chartContainer">
        </div>
      <div id="scoreList" class="small text-muted mt-3">Loadingâ€¦</div>
    </div>

  </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="loginForm">
        <div class="modal-header">
          <h5 class="modal-title" id="loginTitle">Login</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="loginType">

          <div class="mb-3 d-none" id="teamBox">
            <label class="form-label">Team</label>
            <select id="teamSelect" class="form-select"></select>
          </div>
          
          <div class="mb-3 d-none" id="participantBox">
            <label class="form-label">Chess Number</label>
            <input id="chessInput" type="text" class="form-control" placeholder="Your Chess ID">
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <input id="passwordInput" type="password" class="form-control" placeholder="Required for Admin/Leader">
          </div>

          <div id="loginError" class="text-danger small d-none"></div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary w-100">Login</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

document.addEventListener("DOMContentLoaded", () => {
  // Use 'let' for the app and db variables outside the event listener
  let app;
  let db;
  let allStudents = {};
  let allTeams = {}; // Cache all teams

  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139"
    };
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
  } catch (e) {
    console.error("Firebase initialization failed:", e);
    document.getElementById("scoreList").innerHTML = "<div class='text-danger'>Error connecting to database.</div>";
    return;
  }
  
  const statStudents = document.getElementById("statStudents");
  const statEvents = document.getElementById("statEvents");
  const statTeams = document.getElementById("statTeams");
  const scoreList = document.getElementById("scoreList");
  const teamSelect = document.getElementById("teamSelect");
  const chartContainer = document.getElementById("chartContainer");
  const CHESS_ID_PREFIX = "C-"; // Assuming Chess IDs might start with a prefix

  // --- Realtime Listeners ---

  onValue(ref(db,"students"), s => {
    allStudents = s.val() || {};
    statStudents.textContent = Object.keys(allStudents).length;
  });

  onValue(ref(db,"events"), s => {
    statEvents.textContent = Object.keys(s.val()||{}).length;
  });

  onValue(ref(db,"teams"), s => {
    const teams = s.val()||{};
    allTeams = teams;
    statTeams.textContent = Object.keys(teams).length;

    teamSelect.innerHTML = `<option value="">Select Team</option>`;
    scoreList.innerHTML = "";
    chartContainer.innerHTML = "";
    
    // Sort teams by score (descending)
    const sortedTeams = Object.values(teams)
      .sort((a,b)=>(b.score||0)-(a.score||0));
      
    // Determine the max score for scaling the chart bars
    const maxScore = sortedTeams.length > 0 ? Math.max(...sortedTeams.map(t => t.score || 0)) : 100;
    
    // Render list and chart bars
    sortedTeams
      .forEach(t=>{
        // Populate Team Select
        teamSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        
        // Populate Score List
        scoreList.innerHTML += `
          <div class="score-item">
            <span>${t.name}</span>
            <strong>${t.score||0}</strong>
          </div>`;
          
        // Populate Chart (only show top 10 for readability)
        if (chartContainer.childElementCount < 10) {
            const score = t.score || 0;
            const heightPercent = (score / maxScore) * 85; // Scale height (max 85% of container height)
            
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.title = `${t.name}: ${score}`;
            bar.style.height = '0'; // Start at 0 for animation
            bar.style.width = '20px';
            
            // Wait for DOM to render, then set final height for animation
            setTimeout(() => {
                bar.style.height = `${Math.max(5, heightPercent)}%`; // Min height 5% to show bar name
            }, 100);
            
            chartContainer.appendChild(bar);
        }
      });
  });

  // --- Login Logic (Modified) ---
  
  const modal = new bootstrap.Modal(document.getElementById("loginModal"));
  const loginForm = document.getElementById("loginForm");
  const loginType = document.getElementById("loginType");
  const teamBox = document.getElementById("teamBox");
  const participantBox = document.getElementById("participantBox");
  const loginTitle = document.getElementById("loginTitle");
  const passwordInput = document.getElementById("passwordInput");
  const chessInput = document.getElementById("chessInput");
  const loginError = document.getElementById("loginError");

  btnAdmin.onclick = () => openLogin("admin");
  btnLeader.onclick = () => openLogin("leader");
  btnParticipant.onclick = () => openLogin("participant");

  function openLogin(type){
    loginType.value = type;
    loginError.classList.add("d-none");
    passwordInput.value = ""; // Clear password

    if(type === "admin"){
        loginTitle.textContent = "ADMIN LOGIN";
        teamBox.classList.add("d-none");
        participantBox.classList.add("d-none");
        passwordInput.placeholder = "Admin Password";
    } else if (type === "leader"){
        loginTitle.textContent = "LEADER LOGIN";
        teamBox.classList.remove("d-none");
        participantBox.classList.add("d-none");
        passwordInput.placeholder = "Leader Password";
    } else if (type === "participant"){
        loginTitle.textContent = "PARTICIPANT LOGIN";
        teamBox.classList.add("d-none");
        participantBox.classList.remove("d-none");
        passwordInput.placeholder = "Optional Password (if required)";
    }
    
    modal.show();
  }

  loginForm.onsubmit = async e => {
    e.preventDefault();
    const type = loginType.value;
    const pwd = passwordInput.value;
    const chessID = chessInput.value.trim();

    loginError.classList.add("d-none");

    if(type==="admin"){
      // ADMIN AUTH: Password "1234"
      if(pwd!=="1234"){ error("Wrong admin password"); return; }
      location.href="admin.html";
    }

    if(type==="leader"){
      const teamId = teamSelect.value;
      const team = Object.values(allTeams).find(t => String(t.id) === teamId);
      
      // LEADER AUTH: Team ID and Password Match
      if(!team || team.password !== pwd){
        error("Invalid team or password"); return;
      }
      
      // Look up leader's chess ID from the Team object
      if (!team.leaderId) {
          error("Team leader ID not set."); return;
      }
      
      sessionStorage.setItem("leaderAuth", JSON.stringify(team));
      // Use the leader's chess ID for the 'leader' URL parameter as intended in leader.html
      location.href=`leader.html?leader=${team.leaderId}`;
    }
    
    if (type === "participant") {
        if (!chessID) { error("Please enter your Chess Number."); return; }
        
        // PARTICIPANT AUTH: Check if Chess ID exists in students
        // Assuming chess IDs are the keys in the students object or use the 'id' field if not the key
        
        const student = Object.values(allStudents).find(s => String(s.id) === chessID);

        if (!student) {
            error("Invalid Chess Number.");
            return;
        }

        // Optional: If participant login requires a password (e.g., student.password)
        // For simplicity, we currently allow login if Chess ID is valid.
        
        sessionStorage.setItem("participantId", chessID);
        location.href="participant.html"; // Assuming participant.html exists
    }
  };

  function error(msg){
    loginError.textContent = msg;
    loginError.classList.remove("d-none");
  }
});
</script>

</body>
</html>
