<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fidak Fest | Portal</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<style>
/* -------------------------------------- */
/* UI OVERHAUL & THEME VARIABLES (UPGRADED) */
/* -------------------------------------- */

:root {
    /* --- DARK MODE (Default/Fallback) --- */
    --bg: #0d111d; /* Deeper space blue */
    --card: #161b2e; /* Darker card base */
    --text: #c9d1d9; /* Lighter text */
    --muted: #8b949e; 
    --shadow: rgba(0, 0, 0, 0.6); /* Richer shadow */
    --border: #30363d; /* Subtle dark border */
    
    /* Accents (More Vibrant) */
    --accent-main: #66ffc2; /* Neon Green/Mint for primary focus */
    --accent-secondary: #0087ff; /* Electric Blue for buttons */
    --success: #3fb950; 
    --danger: #f85149; 

    /* Glass effect */
    --card-hover-border: 1px solid rgba(102, 255, 194, 0.4);
    --logo-filter: invert(1) brightness(1.8) contrast(1.5);
}

/* --- LIGHT MODE Variables (UPGRADED) --- */
[data-theme="light"] {
    --bg: #f0f4f8; /* Very light cool grey */
    --card: #ffffff; 
    --text: #24292f; 
    --muted: #6a737d;
    --shadow: rgba(40, 44, 52, 0.1);
    --border: #eaeaea;
    
    --accent-main: #3d5afe; /* Deep Blue for primary focus */
    --accent-secondary: #00bcd4; 
    
    --card-hover-border: 1px solid rgba(61, 90, 254, 0.4);
    --logo-filter: none;
}

/* --- Base Styles --- */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;
  background:var(--bg);
  color:var(--text);
  transition: background-color 0.4s, color 0.4s;
  overflow-x: hidden;
}

/* -------------------------------------- */
/* INTRO ANIMATION STYLES (TIMING FIX) */
/* -------------------------------------- */
#intro-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: var(--bg);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: opacity 0.8s ease-out, visibility 0.8s;
}

#intro-overlay.fade-out {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
}

.intro-logo {
    width: 200px;
    height: auto;
    filter: var(--logo-filter);
    animation: logoFlyIn 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards, 
               logoGlow 1.5s infinite alternate 2s;
}

@keyframes logoFlyIn {
    0% { opacity: 0; transform: translateY(-100vh) scale(0.5); }
    70% { opacity: 1; transform: translateY(0) scale(1.1); }
    100% { opacity: 1; transform: scale(1); }
}

@keyframes logoGlow {
    0% { filter: var(--logo-filter) drop-shadow(0 0 5px var(--accent-secondary)); }
    100% { filter: var(--logo-filter) drop-shadow(0 0 15px var(--accent-main)); }
}

/* Layout */
.container-portal{
  max-width:550px; 
  margin:auto;
  padding:20px;
  opacity: 0;
  animation: contentFadeIn 1s ease-out forwards;
  animation-delay: 2.5s; /* REVISED DELAY */
}

@keyframes contentFadeIn {
    to { opacity: 1; }
}

/* CARD UPGRADE: Smoother edges, better shadows */
.card-ui{
  background:var(--card);
  border-radius:20px; /* Slightly larger radius */
  padding:30px; /* More padding */
  box-shadow:0 8px 30px var(--shadow); /* Modern shadow */
  margin-bottom:25px;
  border: 1px solid var(--border);
  transition: all 0.3s ease-in-out;
}
.card-ui:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 40px var(--shadow), 0 0 0 1px var(--accent-main);
}

/* Navbar */
.navbar{
  background:var(--bg);
  padding:15px 25px;
  transition: background-color 0.4s;
  position: sticky; /* Make it sticky */
  top: 0;
  z-index: 100;
  /* Add subtle separation line */
  box-shadow: 0 1px 0 rgba(102, 255, 194, 0.1); 
}

/* Buttons (UPGRADED) */
.btn{
  padding:16px 20px; /* Taller buttons */
  border-radius:14px; /* Smoother edges */
  font-weight:700;
  letter-spacing: 0.5px;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  border: none; /* Let background handle color */
}
.btn-primary{ background:var(--accent-secondary); color:#fff; }
.btn-primary:hover{ 
    background:#0077c9; 
    box-shadow: 0 8px 20px rgba(0, 135, 255, 0.5); 
    transform: translateY(-2px);
}
.btn-success{ background:var(--success); color:var(--bg); }
.btn-success:hover{ 
    background:#2fa83f; 
    color:#fff; 
    box-shadow: 0 8px 20px rgba(63, 185, 80, 0.5); 
    transform: translateY(-2px);
}
.btn-outline-primary{ border:2px solid var(--accent-main); color:var(--accent-main); background:transparent;}
.btn-outline-primary:hover{ 
    background:var(--accent-main); 
    color:var(--bg); 
    box-shadow: 0 8px 20px rgba(102, 255, 194, 0.5); 
    transform: translateY(-2px);
}


/* Stats Grid */
.stats{
  display:grid;
  grid-template-columns:repeat(3, 1fr); 
  gap:15px;
  margin-top: 20px;
}
.stat{
  background:var(--card); 
  border-radius:14px;
  padding:18px;
  text-align:center;
  /* UPGRADED STAT BOX: Cleaner focus ring/border */
  box-shadow: 0 0 0 1px var(--border), 0 5px 15px var(--shadow);
  transition: all 0.3s ease-in-out;
}
.stat:hover {
    box-shadow: 0 0 0 2px var(--accent-main), 0 8px 25px var(--shadow);
    transform: translateY(-3px);
}
.stat h4{
  margin:0 0 5px 0;
  font-size:2.8rem; /* Larger numbers */
  font-weight:900;
  color: var(--accent-main);
  transition: color 0.4s;
}
.stat small{
  font-size:14px;
  color:var(--muted);
}

/* -------------------------------------- */
/* GRAPH VISUALIZATION STYLES (REVERTED & DECENT) */
/* -------------------------------------- */
.chart-container {
    height: 220px;
    padding: 10px;
    background: var(--card);
    border-radius: 14px;
    margin-top: 15px;
    position: relative;
    overflow: hidden;
    /* UPGRADED CONTAINER SHADOW */
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1), 0 5px 20px var(--shadow);
}

.graph-line {
    position: absolute;
    bottom: 10px; 
    left: 0;
    width: 100%;
    height: calc(100% - 20px);
    border-left: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
}

/* Reverted back to the original dynamicGraph single div */
#dynamicGraph {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 100%;
    
    /* UPGRADED: Use the main accent color with soft gradient */
    background: linear-gradient(to top, rgba(102, 255, 194, 0.4), rgba(0, 135, 255, 0.1));
    transition: clip-path 1.8s ease-out; /* Slower, smoother animation */
    
    /* Set an initial clip-path for the animation to start from */
    clip-path: polygon(0% 100%, 100% 100%, 100% 100%, 0% 100%); 
}

/* Score List */
.score-item{
  display:flex;
  justify-content:space-between;
  padding:10px 0;
  color:var(--text);
  border-bottom:1px dashed var(--border);
  font-weight: 500;
  transition: border-color 0.4s;
}
.score-item:last-child{border-bottom:none}

/* Forms and Modals */
.modal-content{ 
    background: var(--card); 
    color: var(--text); 
    border-radius: 18px; /* Decent modal radius */
}
.modal-header{ border-bottom: 1px solid var(--border); }
.modal-footer{ border-top: 1px solid var(--border); }
.form-label { color: var(--muted); }
.form-control, .form-select { 
    background: var(--bg); /* Use BG for input fields */
    border: 1px solid var(--border); 
    color: var(--text); 
    padding: 12px;
    border-radius: 10px;
}
.form-control:focus, .form-select:focus { 
    background: var(--bg); 
    border-color: var(--accent-main); 
    box-shadow: 0 0 0 0.25rem rgba(102, 255, 194, 0.2); 
}
.btn-close { 
    /* Adjust filter to show up correctly against dark/light background */
    filter: invert(var(--theme-filter, 1)) grayscale(100%) brightness(200%); 
}
[data-theme="light"] .btn-close { filter: none; }
</style>
</head>

<body>

<div id="intro-overlay">
    <img src="IMG_2247.png" alt="Fidak Fest" class="intro-logo">
</div>

<nav class="navbar">
    <a href="#" class="text-decoration-none">
        <img src="IMG_2247.png" alt="Fidak Fest" class="navbar-logo">
    </a>
    <div class="dropdown">
        <button class="btn btn-theme dropdown-toggle no-arrow" type="button" id="themeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-sun" id="themeIconDisplay"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-theme" aria-labelledby="themeDropdown">
            <li>
                <a class="dropdown-item" href="#" data-theme-mode="light">
                    <span><i class="bi bi-sun me-2"></i> Light</span>
                    <i class="bi bi-check2 check-icon"></i>
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="#" data-theme-mode="dark">
                    <span><i class="bi bi-moon me-2"></i> Dark</span>
                    <i class="bi bi-check2 check-icon"></i>
                </a>
            </li>
            <li><hr class="dropdown-divider" style="border-color:var(--border)"></li>
            <li>
                <a class="dropdown-item" href="#" data-theme-mode="system">
                    <span><i class="bi bi-circle-half me-2"></i> System</span>
                    <i class="bi bi-check2 check-icon"></i>
                </a>
            </li>
        </ul>
    </div>
</nav>

<div class="container-portal d-flex align-items-center justify-content-center min-vh-100">
  <div class="w-100">

    <div class="text-center mb-5">
      <h2 class="fw-bold fs-1" style="color:var(--accent-main)">Fidak Fest Portal</h2>
      <div class="muted">Access Management and Live Data</div>
    </div>

    <div class="card-ui">
        <h5 class="fw-bold mb-3" style="color:var(--text)">ðŸš€ Access Options</h5>
        <div class="d-grid gap-3">
          <button class="btn btn-primary" id="btnAdmin">
            <i class="bi bi-shield-lock"></i> Admin Login
          </button>
          <button class="btn btn-success" id="btnLeader">
            <i class="bi bi-people"></i> Leader Login
          </button>
          <button class="btn btn-outline-primary" id="btnParticipant">
            <i class="bi bi-person"></i> Participant Login
          </button>
        </div>
    </div>
    
    <div class="card-ui">
        <h5 class="fw-bold mb-3" style="color:var(--text)">ðŸ“Š Festival Statistics</h5>
        <div class="stats">
          <div class="stat">
            <h4 id="statStudents">0</h4>
            <small>Total Students</small>
          </div>
          <div class="stat">
            <h4 id="statEvents">0</h4>
            <small>Programs Active</small>
          </div>
          <div class="stat">
            <h4 id="statTeams">0</h4>
            <small>Teams Competing</small>
          </div>
        </div>
    </div>


    <div class="card-ui">
      <h5 class="fw-bold mb-3" style="color:var(--text)">ðŸ“ˆ Live Score Trend (Line Graph)</h5>
      <div class="chart-container">
        <div id="dynamicGraph"></div>
        <div class="graph-line"></div>
      </div>
      <div id="scoreList" class="small text-muted mt-3">Loading Top Teams...</div>
    </div>

  </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="loginForm">
        <div class="modal-header">
          <h5 class="modal-title" id="loginTitle">Login</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" id="loginType">

          <div class="mb-3 d-none" id="teamBox">
            <label class="form-label">Team</label>
            <select id="teamSelect" class="form-select"></select>
          </div>
          
          <div class="mb-3 d-none" id="participantBox">
            <label class="form-label">Chess Number</label>
            <input id="chessInput" type="text" class="form-control" placeholder="Enter your Alphanumeric Chess ID">
          </div>

          <div class="mb-3" id="passwordBox">
            <label class="form-label">Password</label>
            <input id="passwordInput" type="password" class="form-control" placeholder="Required for Admin/Leader">
          </div>

          <div id="loginError" class="text-danger small d-none"></div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary w-100">Login</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

document.addEventListener("DOMContentLoaded", () => {

  // --- INTRO LOGIC (REVISED TIMING) ---
  const introOverlay = document.getElementById('intro-overlay');
  setTimeout(() => { introOverlay.classList.add('fade-out'); }, 2500); 
  setTimeout(() => { introOverlay.remove(); }, 3300); 
    
  // --- Theme Management ---
  const body = document.body;
  const themeToggles = document.querySelectorAll('[data-theme-mode]');
  const themeIconDisplay = document.getElementById('themeIconDisplay');

  function updateThemeUI(mode) {
      if (mode === 'system') {
          const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          body.removeAttribute('data-theme');
          body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
          body.removeAttribute('data-theme');
          body.setAttribute('data-theme', mode);
      }
      themeToggles.forEach(btn => {
          btn.classList.remove('active');
          if(btn.getAttribute('data-theme-mode') === mode) btn.classList.add('active');
      });
      themeIconDisplay.className = mode === 'light' ? "bi bi-sun-fill" : (mode === 'dark' ? "bi bi-moon-stars-fill" : "bi bi-circle-half");
  }

  function setTheme(mode) {
      localStorage.setItem('theme', mode);
      updateThemeUI(mode);
  }

  const savedTheme = localStorage.getItem('theme') || 'system';
  updateThemeUI(savedTheme);

  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (localStorage.getItem('theme') === 'system') updateThemeUI('system');
  });

  themeToggles.forEach(toggle => {
      toggle.addEventListener('click', (e) => {
          e.preventDefault();
          const target = e.target.closest('a');
          setTheme(target.getAttribute('data-theme-mode'));
      });
  });

  // --- Firebase Initialization ---
  let app;
  let db;
  let allStudents = {};
  let allTeams = {};

  try {
    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139"
    };
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
  } catch (e) {
    console.error("Firebase init failed:", e);
    document.getElementById("scoreList").innerHTML = "<div class='text-danger'>Error connecting to database.</div>";
  }
  
  const statStudents = document.getElementById("statStudents");
  const statEvents = document.getElementById("statEvents");
  const statTeams = document.getElementById("statTeams");
  const scoreList = document.getElementById("scoreList");
  const dynamicGraph = document.getElementById("dynamicGraph");

  // --- Graph Utility: Generates a Decent, single-area clip-path based on scores ---
  function updateGraph(maxScore) {
      const points = 10;
      let clipPath = 'polygon(0% 100%'; 
      const currentHighestScore = maxScore;
      
      for (let i = 0; i <= points; i++) {
          const x = (i / points) * 100;
          let yPercentage;
          
          if (i === 0) {
              yPercentage = 95; // Start near the bottom (100% is the baseline)
          } else if (i === points) {
              // End point is relative to the current max score against a conceptual max of 2000
              const conceptualMax = 2000; 
              // Convert final score to a height (0% is top, 100% is bottom)
              let height = (currentHighestScore / conceptualMax) * 80; // Max 80% height fill
              yPercentage = Math.max(15, 95 - height); // Keep between 15% (high) and 95% (low)
          } else {
              // Simulate score growth over time with some random fluctuation
              const timeProgress = i / points;
              // A simple curve mimicking growth (e.g., cubic)
              let scoreRatio = Math.pow(timeProgress, 3) * 0.9;
              // Add randomness
              scoreRatio += (Math.random() - 0.5) * 0.1;
              scoreRatio = Math.min(1, Math.max(0, scoreRatio)); // Clamp 0 to 1
              
              // Map score ratio to inverted Y-coordinate
              let height = scoreRatio * 80;
              yPercentage = Math.max(15, 95 - height); 
          }

          clipPath += `, ${x}% ${yPercentage.toFixed(0)}%`;
      }
      clipPath += `, 100% 100%)`; // Close the polygon at the bottom right

      dynamicGraph.style.clipPath = clipPath;
  }

  // --- Realtime Listeners ---
  onValue(ref(db,"students"), s => {
    allStudents = s.val() || {};
    statStudents.textContent = Object.keys(allStudents).length;
  });

  onValue(ref(db,"events"), s => {
    statEvents.textContent = Object.keys(s.val()||{}).length;
  });

  onValue(ref(db,"teams"), s => {
    const teams = s.val()||{};
    allTeams = teams;
    statTeams.textContent = Object.keys(teams).length;

    scoreList.innerHTML = "";
    
    // Sort teams by score (descending)
    const sortedTeams = Object.values(teams)
      .sort((a,b)=>(b.score||0)-(a.score||0));
      
    // Update Graph based on max score
    const maxScore = sortedTeams.length > 0 ? Math.max(...sortedTeams.map(t => t.score || 0)) : 0;
    updateGraph(maxScore);

    // Display top scores
    sortedTeams
      .slice(0, 5) // Show top 5 teams
      .forEach((t, index)=>{
        // Use accent main for the top team only, or use a neutral color
        const color = index === 0 ? 'var(--accent-main)' : 'var(--text)';
        scoreList.innerHTML += `
          <div class="score-item">
            <span class="d-flex align-items-center"><i class="bi bi-trophy-fill me-2" style="color:${color}"></i> ${t.name}</span>
            <strong>${t.score||0} pts</strong>
          </div>`;
      });
      if (sortedTeams.length === 0) {
        scoreList.innerHTML = "<div class='text-muted mt-2'>No team scores available.</div>";
      }
      
      // Update Team Select in Modal
      const teamSelect = document.getElementById("teamSelect");
      teamSelect.innerHTML = `<option value="">Select Team</option>`;
      Object.values(teams).forEach(t=>{
          teamSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });
  });

  // --- Login Logic (Unchanged from previous fix) ---
  const modal = new bootstrap.Modal(document.getElementById("loginModal"));
  const loginForm = document.getElementById("loginForm");
  const loginType = document.getElementById("loginType");
  const teamBox = document.getElementById("teamBox");
  const participantBox = document.getElementById("participantBox");
  const passwordBox = document.getElementById("passwordBox");
  const loginTitle = document.getElementById("loginTitle");
  const passwordInput = document.getElementById("passwordInput");
  const chessInput = document.getElementById("chessInput");
  const loginError = document.getElementById("loginError");

  const btnAdmin = document.getElementById("btnAdmin");
  const btnLeader = document.getElementById("btnLeader");
  const btnParticipant = document.getElementById("btnParticipant");

  function openLogin(type){
    loginType.value = type;
    loginError.classList.add("d-none");
    passwordInput.value = "";
    chessInput.value = "";

    if(type === "admin"){
        loginTitle.textContent = "ADMIN LOGIN";
        teamBox.classList.add("d-none");
        participantBox.classList.add("d-none");
        passwordBox.classList.remove("d-none");
        passwordInput.placeholder = "Admin Password";
    } else if (type === "leader"){
        loginTitle.textContent = "LEADER LOGIN";
        teamBox.classList.remove("d-none");
        participantBox.classList.add("d-none");
        passwordBox.classList.remove("d-none");
        passwordInput.placeholder = "Leader Password";
    } else if (type === "participant"){
        loginTitle.textContent = "PARTICIPANT LOGIN";
        teamBox.classList.add("d-none");
        participantBox.classList.remove("d-none");
        passwordBox.classList.add("d-none"); 
    }
    modal.show();
  }

  btnAdmin.onclick = () => openLogin("admin");
  btnLeader.onclick = () => openLogin("leader");
  btnParticipant.onclick = () => openLogin("participant");

  loginForm.onsubmit = async e => {
    e.preventDefault();
    const type = loginType.value;
    const pwd = passwordInput.value;
    const chessID = chessInput.value.trim();

    loginError.classList.add("d-none");

    if(type==="admin"){
      if(pwd!=="1234"){ error("Wrong admin password"); return; }
      location.href="admin.html";
    }

    if(type==="leader"){
      const teamId = document.getElementById("teamSelect").value;
      const team = Object.values(allTeams).find(t => String(t.id) === teamId);
      if(!team || team.password !== pwd){ error("Invalid team or password"); return; }
      if (!team.leaderId) { error("Team leader ID not set."); return; }
      sessionStorage.setItem("leaderAuth", JSON.stringify(team));
      location.href=`leader.html?leader=${team.leaderId}`;
    }
    
    if (type === "participant") {
        if (!chessID) { error("Please enter your Chess Number."); return; }
        
        if (Object.keys(allStudents).length === 0) {
            error("Data loading... please wait 2 seconds and try again.");
            return;
        }
        
        let student;
        const lowerCaseID = chessID.toLowerCase();
        
        student = Object.values(allStudents).find(s => {
            const firebaseKey = Object.keys(allStudents).find(key => allStudents[key] === s);
            if (firebaseKey && String(firebaseKey).trim().toLowerCase() === lowerCaseID) return true;
            
            const sId = String(s.id || '').trim().toLowerCase();
            const sChestNo = String(s.chestNo || '').trim().toLowerCase();
            const sChessNo = String(s.chessNo || '').trim().toLowerCase();
            
            return sId === lowerCaseID || sChestNo === lowerCaseID || sChessNo === lowerCaseID;
        });

        if (!student) {
            error("Invalid Chess Number or ID. Record not found.");
            return;
        }
        
        const studentID = student.id || student.chestNo || chessID;
        
        sessionStorage.setItem("participantId", studentID);
        sessionStorage.setItem("participantName", student.name || "Participant");
        location.href="participant.html"; 
    }
  };

  function error(msg){
    loginError.textContent = msg;
    loginError.classList.remove("d-none");
  }
});
</script>

</body>
</html>
