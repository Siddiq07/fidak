<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Art Fest</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Excel + PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    html, body {
      height:100%;
      width:100%;
      background:#f4f6ff;
      font-family:Inter, system-ui, sans-serif;
      overflow-x:hidden;
      color:#0f172a;
    }

    /* SIDEBAR */
    .sidebar {
      position:fixed;
      top:0;
      left:0;
      width:80px;
      height:100vh;
      background:#ffffff;
      border-right:1px solid #e3e8ef;
      padding:16px 10px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:18px;
      z-index:200;
    }

    .sidebar .logo { font-size:26px; color:#2563eb; font-weight:800; margin-bottom:8px; }

    .nav-item { width:100%; }
    .nav-item button {
      width:100%; height:56px; border:none;
      border-radius:14px; background:#f1f5ff;
      font-size:22px; color:#3b4252;
      display:flex; align-items:center; justify-content:center;
      transition:.2s;
    }
    .nav-item button.active {
      background:linear-gradient(180deg,#597bff,#7a5bff); color:white;
    }

    .logout-box { margin-top:auto; width:100%; }
    .logout-box button {
      width:100%; height:60px;
      border-radius:14px;
      border:2px solid #ef4444;
      background:white; color:#ef4444;
      font-size:22px;
    }

    /* MAIN CONTENT */
    .content {
      margin-left:80px !important;
      padding:20px;
      width:calc(100% - 80px) !important;
      min-height:100vh;
    }

    /* Fix blank space */
    main, #panels { margin:0 !important; padding:0 !important; width:100% !important; }

    /* TOPBAR */
    .topbar {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:20px;
    }
    .topbar h3 { font-weight:800; font-size:32px; }
    .muted { color:#6b7280; }

    /* Cards */
    .card-neo {
      background:#ffffff;
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,0.05);
      margin-bottom:16px;
    }

    /* Attendance Boxes */
    .small-box {
      width:58px; height:40px;
      border-radius:6px;
      background:#eef2ff;
      display:inline-flex; align-items:center; justify-content:center;
      font-weight:700; cursor:pointer;
      margin:6px;
    }
    .small-box.present { background:#22c55e; color:white; }
    .small-box.absent { background:#ef4444; color:white; }

    @media(max-width:900px){
      .sidebar { width:70px; }
      .content { margin-left:70px !important; width:calc(100% - 70px) !important; }
      .nav-item button { height:50px; }
    }
  </style>
</head>

<body>
<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">

    <div class="logo">
      <i class="bi bi-palette-fill"></i>
    </div>

    <nav class="mt-2 w-100">
      <div class="nav-item"><button id="btnStudents" data-target="#panel-students"><i class="bi bi-people-fill"></i></button></div>
      <div class="nav-item"><button id="btnTeams" data-target="#panel-teams"><i class="bi bi-people"></i></button></div>
      <div class="nav-item"><button id="btnEvents" data-target="#panel-events"><i class="bi bi-calendar-event"></i></button></div>
      <div class="nav-item"><button id="btnAttendance" data-target="#panel-attendance"><i class="bi bi-check2-all"></i></button></div>
      <div class="nav-item"><button id="btnApprovals" data-target="#panel-approvals"><i class="bi bi-card-checklist"></i></button></div>
      <div class="nav-item"><button id="btnResults" data-target="#panel-results"><i class="bi bi-list-ol"></i></button></div>
      <div class="nav-item"><button id="btnReports" data-target="#panel-reports"><i class="bi bi-bar-chart-line"></i></button></div>
    </nav>

    <div class="logout-box">
      <button id="logoutBtn"><i class="bi bi-box-arrow-right"></i></button>
    </div>

  </aside>

  <!-- MAIN CONTENT START -->
  <main class="content">

    <div class="topbar">
      <div>
        <h3>Admin Dashboard</h3>
        <div class="muted">Manage Students · Teams · Events · Attendance · Results</div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <button id="btnExportStudents" class="btn btn-outline-secondary">
          <i class="bi bi-file-earmark-pdf"></i> Export Students PDF
        </button>
        <div class="ms-2 muted">Year <span id="current-year"></span></div>
      </div>
    </div>
    <div id="panels-wrapper"></div>
    <!-- =========================
     PANELS — PART 2
========================= -->
<div id="panels">

<!-- --------------------------
     STUDENTS PANEL
--------------------------- -->
<section id="panel-students" class="card-neo">

  <h4 class="section-title">Manage Students</h4>

  <!-- IMPORT STUDENTS -->
  <div class="card-neo mb-3">
    <h5 class="section-title">Import Students (Excel)</h5>
    <div class="muted mb-2">Columns: Chess, Name, Level (Senior/Junior), Team (optional)</div>

    <input type="file" id="studentFile" accept=".xlsx,.xls" class="form-control mb-2">

    <div class="d-flex gap-2 mb-2">
      <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
      <button id="importStudents" class="btn btn-success">Import</button>
    </div>

    <div id="studentsPreview" style="max-height:260px; overflow:auto"></div>
  </div>

  <!-- ADD STUDENT MANUALLY -->
  <div class="card-neo mb-3">
    <h5 class="section-title">Add Student Manually</h5>

    <input id="manualChess" class="form-control mb-2" placeholder="Chess Number (alphanumeric)">
    <input id="manualName" class="form-control mb-2" placeholder="Full Name">

    <select id="manualLevel" class="form-select mb-2">
      <option value="Senior">Senior</option>
      <option value="Junior">Junior</option>
    </select>

    <select id="manualTeam" class="form-select mb-2">
      <option value="">Unassigned</option>
    </select>

    <button id="addManualStudent" class="btn btn-success w-100">Add Student</button>
  </div>

  <!-- STUDENTS TABLE -->
  <div class="card-neo">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="section-title m-0">All Students</h5>
      <input id="searchStudents" class="form-control w-auto" placeholder="Search name or chess #">
    </div>

    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Chess #</th>
            <th>Name</th>
            <th>Level</th>
            <th>Team</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="studentsTable"></tbody>
      </table>
    </div>
  </div>

</section>

<!-- --------------------------
     TEAMS PANEL
--------------------------- -->
<section id="panel-teams" class="card-neo d-none">

  <h4 class="section-title">Teams & Leaders</h4>

  <!-- ADD TEAM -->
  <div class="card-neo mb-3">
    <h5 class="section-title">Create Team</h5>

    <input id="teamName" class="form-control mb-2" placeholder="Team Name">

    <select id="teamLeader" class="form-select mb-2">
      <option value="">Choose Leader (Chess #)</option>
    </select>

    <input id="teamPassword" class="form-control mb-2" placeholder="Password (optional)">

    <div class="d-flex gap-2">
      <button id="saveTeam" class="btn btn-success">Save Team</button>
      <button id="clearTeamForm" class="btn btn-outline-secondary">Clear</button>
    </div>
  </div>

  <!-- TEAM TABLE -->
  <div class="card-neo">
    <h5 class="section-title">Team List</h5>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Team</th>
            <th>Leader</th>
            <th>Members</th>
            <th>Attendance %</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="teamsTable"></tbody>
      </table>
    </div>
  </div>

</section>

<!-- --------------------------
     EVENTS PANEL
--------------------------- -->
<section id="panel-events" class="card-neo d-none">

  <h4 class="section-title">Events</h4>

  <!-- ADD EVENT -->
  <div class="card-neo mb-3">
    <h5 class="section-title">Add / Edit Event</h5>

    <input id="eventName" class="form-control mb-2" placeholder="Event Name">

    <select id="eventCategory" class="form-select mb-2">
      <option value="General">General</option>
      <option value="Senior">Senior</option>
      <option value="Junior">Junior</option>
      <option value="Special">Special</option>
    </select>

    <select id="eventType" class="form-select mb-2">
      <option>Stage</option>
      <option>Non-Stage</option>
    </select>

    <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Description / Rules"></textarea>

    <button id="saveEvent" class="btn btn-warning w-100">Save Event</button>
  </div>

  <!-- IMPORT EVENTS VIA EXCEL -->
  <div class="card-neo mb-3">
    <h5 class="section-title">Import Events (Excel)</h5>

    <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">

    <div class="d-flex gap-2">
      <button id="previewEvents" class="btn btn-outline-primary">Preview</button>
      <button id="importEvents" class="btn btn-success">Import</button>
    </div>

    <div id="eventsPreview" style="max-height:240px; overflow:auto" class="mt-2"></div>
  </div>

  <!-- EVENTS TABLE -->
  <div class="card-neo">
    <h5 class="section-title">Event List</h5>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr>
            <th>Name</th>
            <th>Category</th>
            <th>Type</th>
            <th>Description</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="eventsTable"></tbody>
      </table>
    </div>
  </div>

</section>

</div>
<!-- --------------------------
     ATTENDANCE PANEL
--------------------------- -->
<section id="panel-attendance" class="card-neo d-none">

  <h4 class="section-title">Attendance</h4>

  <!-- SELECT DATE & OPTIONS -->
  <div class="card-neo mb-3">

    <div class="row g-2">
      <div class="col-md-3">
        <input id="attDate" type="date" class="form-control">
      </div>

      <div class="col-md-3">
        <input id="attTime" type="time" class="form-control">
      </div>

      <div class="col-md-3">
        <input id="attDesc" class="form-control" placeholder="Description">
      </div>

      <div class="col-md-3">
        <select id="attMethod" class="form-select">
          <option value="all">All Students</option>
          <option value="team">By Team</option>
        </select>
      </div>

      <div class="col-md-3 d-none" id="attTeamWrap">
        <select id="attTeam" class="form-select"></select>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button id="loadAttendance" class="btn btn-primary">Load</button>
      <button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button>
      <button id="saveAttendance" class="btn btn-success">Save</button>
    </div>

  </div>

  <!-- ATTENDANCE BOXES -->
  <div id="attendanceMarkCard" class="card-neo mb-3" style="display:none">
    <h5 class="section-title">Mark Attendance</h5>
    <div class="muted mb-2">Tap ID to toggle · Name appears when clicking</div>

    <div id="attendanceBoxes" class="p-2"></div>
  </div>

  <!-- SAVED SESSIONS -->
  <div class="card-neo">
    <h5 class="section-title">Saved Sessions</h5>

    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Description</th>
            <th>Count</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="attendanceSessions"></tbody>
      </table>
    </div>
  </div>

</section>

<!-- --------------------------
     APPROVALS PANEL
--------------------------- -->
<section id="panel-approvals" class="card-neo d-none">

  <h4 class="section-title">Pending Approvals</h4>

  <div class="d-flex justify-content-between mb-2">
    <input id="searchApprovals" class="form-control w-auto" placeholder="Search event or student">
  </div>

  <div class="table-responsive" style="max-height:420px; overflow:auto">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Event</th>
          <th>Student</th>
          <th>Team</th>
          <th>Submitted</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody id="approvalsTable"></tbody>
    </table>
  </div>

  <hr>

  <h5 class="section-title">Approved List (Downloadable)</h5>
  <button id="downloadApprovedPDF" class="btn btn-outline-primary mb-2">
    <i class="bi bi-file-earmark-pdf"></i> Download PDF
  </button>

  <div id="approvedList"></div>

</section>

<!-- --------------------------
     RESULTS PANEL
--------------------------- -->
<section id="panel-results" class="card-neo d-none">

  <h4 class="section-title">Event Results</h4>

  <!-- Search -->
  <input id="searchResults" class="form-control mb-3" placeholder="Search student or event">

  <!-- Results Table -->
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>Event</th>
          <th>Student</th>
          <th>Team</th>
          <th>Position</th>
          <th>Points</th>
          <th>Published</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody id="resultsTable"></tbody>
    </table>
  </div>

</section>

<!-- --------------------------
     REPORTS PANEL
--------------------------- -->
<section id="panel-reports" class="card-neo d-none">

  <h4 class="section-title">Team Reports</h4>
  <div class="muted mb-2">Attendance percentage overview</div>

  <div class="table-responsive">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>Team</th>
          <th>Members</th>
          <th>Attendance %</th>
        </tr>
      </thead>
      <tbody id="reportsTable"></tbody>
    </table>
  </div>

</section>
<script type="module">
/* ===========================
   PART 4 — Admin JS (Firebase)
   =========================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getDatabase, ref, push, set, update, onValue, get, remove
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

/* --------------------
   Firebase config
   -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* --------------------
   Lightweight helpers
   -------------------- */
const $ = id => document.getElementById(id);
const toast = (msg, t='success') => {
  const root = document.getElementById('toastRoot') || document.body;
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${t} border-0`;
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  (root).appendChild(el);
  const b = new bootstrap.Toast(el, { delay: 2500 });
  b.show();
  el.addEventListener('hidden.bs.toast', ()=> el.remove());
};
const escapeHtml = s => s==null? '': String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const encodeKey = k => encodeURIComponent(String(k));
const decodeKey = k => decodeURIComponent(String(k));

/* --------------------
   Local cache
   -------------------- */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, participations: {}, results: {} };

/* --------------------
   Database refs & listeners
   -------------------- */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');

onValue(studentsRef, snap => {
  const obj = snap.val() || {};
  CACHE.students = Object.values(obj);
  KEYMAP.students = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id !== undefined) KEYMAP.students[v.id] = k; else if(v && v.id===undefined) KEYMAP.students[k] = k; });
  renderStudents();
  populateDropdowns();
});
onValue(teamsRef, snap => {
  const obj = snap.val() || {};
  CACHE.teams = Object.values(obj);
  KEYMAP.teams = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id !== undefined) KEYMAP.teams[v.id] = k; else KEYMAP.teams[k]=k; });
  renderTeams();
  populateDropdowns();
});
onValue(eventsRef, snap => {
  const obj = snap.val() || {};
  CACHE.events = Object.values(obj);
  KEYMAP.events = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.events[v.id] = k; else KEYMAP.events[k]=k; });
  renderEvents();
  populateDropdowns();
});
onValue(partsRef, snap => {
  const obj = snap.val() || {};
  CACHE.participations = Object.values(obj);
  KEYMAP.participations = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.participations[v.id] = k; });
  renderApprovals();
  renderEvents(); // to mark participated rows
});
onValue(resultsRef, snap => {
  const obj = snap.val() || {};
  CACHE.results = Object.values(obj);
  KEYMAP.results = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.results[v.id] = k; });
  renderResults();
  computeLiveScores();
});
onValue(attendanceRef, snap => {
  CACHE.attendance = snap.val() || {};
  renderAttendanceSessions();
  renderReports();
});

/* --------------------
   UI: Panel switching (sidebar buttons)
   -------------------- */
function showPanel(selector) {
  document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
  const el = document.querySelector(selector);
  if (el) el.classList.remove('d-none');
  // highlight active nav
  document.querySelectorAll('.nav-item button').forEach(b => b.classList.remove('active'));
  document.querySelector(`[data-target="${selector}"]`)?.classList.add('active');
}
['btnStudents','btnTeams','btnEvents','btnAttendance','btnApprovals','btnResults','btnReports'].forEach(id=>{
  const b = $(id);
  if(b) b.addEventListener('click', ()=> {
    const target = b.dataset.target;
    showPanel(target);
  });
});
// default show students
setTimeout(()=> showPanel('#panel-students'), 200);

/* --------------------
   XLSX helpers (preview + import)
   -------------------- */
function readExcelFile(file, callback) {
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type: 'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: '' });
    callback(json);
  };
  r.readAsBinaryString(file);
}

/* --------------------
   STUDENTS: Preview, import, add, render, edit, delete
   -------------------- */
let studentsPreviewRows = [];
$('previewStudents')?.addEventListener('click', ()=> {
  const f = $('studentFile').files[0];
  if(!f) return toast('Select an Excel file','danger');
  readExcelFile(f, json => {
    studentsPreviewRows = json.slice(0,1000);
    renderStudentsPreview();
  });
});
function renderStudentsPreview(){
  const wrap = $('studentsPreview');
  if(!studentsPreviewRows.length) { wrap.innerHTML = '<div class="muted">No preview</div>'; return; }
  let html = '<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>';
  studentsPreviewRows.forEach(r => {
    const chess = r['Chess']||r['Chess Number']||r['ID']||r['id']||'';
    const name = r['Name']||r['name']||'';
    const level = r['Level']||r['level']||'Senior';
    const team = r['Team']||r['team']||'';
    html += `<tr><td>${escapeHtml(chess)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(level)}</td><td>${escapeHtml(team)}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}
$('importStudents')?.addEventListener('click', async ()=> {
  if(!studentsPreviewRows.length) return toast('No preview to import','danger');
  const teamNameToId = {}; CACHE.teams.forEach(t => { if(t.name) teamNameToId[String(t.name).trim().toLowerCase()] = t.id; });
  const updates = {}; let imported = 0, skipped = 0;
  studentsPreviewRows.forEach(r => {
    const chess = String(r['Chess']||r['Chess Number']||r['ID']||r['id']||'').trim();
    const name = String(r['Name']||r['name']||'').trim();
    const level = String(r['Level']||r['level']||'Senior').trim();
    if(!chess || !name) { skipped++; return; }
    if(CACHE.students.some(s => String(s.id)===String(chess)) || CACHE.students.some(s=> String(s.name||'').trim().toLowerCase()===name.toLowerCase())) { skipped++; return; }
    const teamName = String(r['Team']||r['team']||'').trim();
    const teamId = teamName ? (teamNameToId[teamName.toLowerCase()]||null) : null;
    updates[`students/${encodeKey(chess)}`] = { id: chess, name, level, teamId: teamId ? String(teamId) : null };
    imported++;
  });
  if(!Object.keys(updates).length) return toast(`Imported ${imported}, skipped ${skipped}`,'warning');
  await update(ref(db, '/'), updates);
  studentsPreviewRows = [];
  $('studentsPreview').innerHTML = '';
  $('studentFile').value = '';
  toast(`Imported ${imported}, skipped ${skipped}`);
});
$('addManualStudent')?.addEventListener('click', async ()=> {
  const chess = $('manualChess').value.trim();
  const name = $('manualName').value.trim();
  const level = $('manualLevel').value || 'Senior';
  const teamId = $('manualTeam').value || null;
  if(!chess || !name) return toast('Enter chess and name','danger');
  if(CACHE.students.some(s=>String(s.id)===String(chess))) return toast('Chess already exists','danger');
  if(CACHE.students.some(s=> String(s.name||'').trim().toLowerCase() === name.toLowerCase())) return toast('Name already exists','danger');
  await set(ref(db, `students/${encodeKey(chess)}`), { id: chess, name, level, teamId: teamId? String(teamId): null });
  $('manualChess').value=''; $('manualName').value=''; $('manualTeam').value='';
  toast('Student added');
});
function renderStudents(){
  const tbody = $('studentsTable');
  if(!tbody) return;
  if(!CACHE.students.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No students</td></tr>'; return; }
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
  let html = '';
  CACHE.students.forEach(s => {
    const team = s.teamId? (teamMap[s.teamId]||'Unknown') : 'Unassigned';
    html += `<tr data-key="${encodeKey(s.id)}"><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'Senior')}</td><td>${escapeHtml(team)}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-student">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-student">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}
/* students actions (edit/delete) */
$('studentsTable')?.addEventListener('click', async (e)=> {
  const tr = e.target.closest('tr'); if(!tr) return;
  const dbKey = tr.dataset.key;
  if(e.target.classList.contains('btn-delete-student')){
    if(!confirm('Delete student?')) return;
    await remove(ref(db, `students/${dbKey}`));
    toast('Student deleted');
    return;
  } else if(e.target.classList.contains('btn-edit-student')){
    const snap = await get(ref(db, `students/${dbKey}`));
    const s = snap.val();
    if(!s) return toast('Student not found','danger');
    // show simple prompt-based edit (keeps UI compact)
    const newName = prompt('Edit name', s.name) || s.name;
    const newLevel = prompt('Level (Senior/Junior)', s.level||'Senior') || s.level;
    const newTeam = prompt('Team ID (leave blank for unassigned)', s.teamId||'') || s.teamId||null;
    if(!newName) return toast('Name required','danger');
    await update(ref(db, `students/${dbKey}`), { name: newName, level: newLevel, teamId: newTeam?String(newTeam):null });
    toast('Student updated');
  }
});

/* --------------------
   TEAMS: create/edit/delete, lock, render
   -------------------- */
$('saveTeam')?.addEventListener('click', async ()=> {
  const name = $('teamName').value.trim();
  const leader = $('teamLeader').value || null;
  const pwd = $('teamPassword').value.trim() || '';
  if(!name) return toast('Team name required','danger');
  const id = Date.now().toString();
  const p = push(ref(db, 'teams'));
  await set(p, { id, name, leaderId: leader?String(leader):null, password: pwd, score: 0, locked: false });
  $('teamName').value=''; $('teamLeader').value=''; $('teamPassword').value='';
  toast('Team saved');
});
function renderTeams(){
  const tbody = $('teamsTable');
  if(!tbody) return;
  if(!CACHE.teams.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No teams</td></tr>'; return; }
  const studentMap = {}; CACHE.students.forEach(s=> studentMap[s.id]=s);
  let html='';
  CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  CACHE.teams.forEach(t=>{
    const leader = t.leaderId? (studentMap[t.leaderId]? `${studentMap[t.leaderId].name} (${t.leaderId})` : t.leaderId) : '-';
    const membersCount = CACHE.students.filter(s=> String(s.teamId)===String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const lockLabel = t.locked ? 'Unlock' : 'Lock';
    html += `<tr data-key="${t.id}"><td>${escapeHtml(t.name)}</td><td>${escapeHtml(leader)}</td><td>${membersCount}</td><td>${pct}%</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-team" data-key="${t.id}">Edit</button>
      <button class="btn btn-sm btn-outline-secondary btn-toggle-lock" data-key="${t.id}">${lockLabel}</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-team" data-key="${t.id}">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}
$('teamsTable')?.addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-team')){
    if(!confirm('Delete team?')) return;
    const dbKey = KEYMAP.teams[id] || id;
    if(dbKey) await remove(ref(db, `teams/${dbKey}`));
    // unassign members
    const updates = {};
    CACHE.students.filter(s=> String(s.teamId)===String(id)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null);
    if(Object.keys(updates).length) await update(ref(db, '/'), updates);
    toast('Team deleted');
  } else if(btn.classList.contains('btn-edit-team')){
    const t = CACHE.teams.find(x=> String(x.id)===String(id));
    if(!t) return toast('Team not found','danger');
    const newName = prompt('Team name', t.name) || t.name;
    const newLeader = prompt('Leader chess # (leave blank to remove)', t.leaderId||'') || t.leaderId||null;
    const newPwd = prompt('Password (leave blank to keep)', t.password||'') || t.password||'';
    const dbKey = KEYMAP.teams[id] || id;
    await update(ref(db, `teams/${dbKey}`), { name: newName, leaderId: newLeader?String(newLeader):null, password: newPwd });
    toast('Team updated');
  } else if(btn.classList.contains('btn-toggle-lock')){
    const t = CACHE.teams.find(x=> String(x.id)===String(id));
    if(!t) return;
    const dbKey = KEYMAP.teams[id] || id;
    const newLocked = !t.locked;
    await update(ref(db, `teams/${dbKey}`), { locked: newLocked });
    toast(newLocked ? 'Team locked' : 'Team unlocked');
  }
});

/* --------------------
   EVENTS: add, import, edit, delete, render
   -------------------- */
$('saveEvent')?.addEventListener('click', async ()=> {
  const name = $('eventName').value.trim();
  const category = $('eventCategory').value || 'General';
  const type = $('eventType').value || 'Non-Stage';
  const desc = $('eventDescription').value.trim();
  if(!name) return toast('Event name required','danger');
  if(CACHE.events.some(e=> String(e.name||'').trim().toLowerCase()===name.toLowerCase())) return toast('Event exists','danger');
  const p = push(ref(db, 'events'));
  const id = Date.now().toString();
  await set(p, { id, name, category, type, description: desc, status: 'Open' });
  $('eventName').value=''; $('eventDescription').value='';
  toast('Event added');
});
$('previewEvents')?.addEventListener('click', ()=> {
  const f = $('eventFile').files[0];
  if(!f) return toast('Select Excel','danger');
  readExcelFile(f, json => {
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Category</th><th>Type</th><th>Description</th></tr></thead><tbody>';
    json.slice(0,500).forEach(r => {
      html += `<tr><td>${escapeHtml(r['Name']||r['Event']||'')}</td><td>${escapeHtml(r['Category']||r['category']||'General')}</td><td>${escapeHtml(r['Type']||r['type']||'Non-Stage')}</td><td>${escapeHtml(r['Description']||r['description']||'')}</td></tr>`;
    });
    html += '</tbody></table>';
    $('eventsPreview').innerHTML = html;
  });
});
$('importEvents')?.addEventListener('click', async ()=> {
  const f = $('eventFile').files[0];
  if(!f) return toast('Select Excel','danger');
  readExcelFile(f, async rows => {
    const updates = {}; let imported=0, skipped=0;
    rows.slice(0,500).forEach(r => {
      const name = String(r['Name']||r['Event']||r['name']||'').trim();
      if(!name){ skipped++; return; }
      if(CACHE.events.some(ev => String(ev.name||'').trim().toLowerCase()===name.toLowerCase())){ skipped++; return; }
      const category = String(r['Category']||r['category']||'General');
      const type = String(r['Type']||r['type']||'Non-Stage');
      const desc = String(r['Description']||r['description']||'');
      const id = Date.now().toString()+Math.floor(Math.random()*9999);
      updates[`events/${id}`] = { id, name, category, type, description: desc, status:'Open' };
      imported++;
    });
    if(Object.keys(updates).length) await update(ref(db, '/'), updates);
    toast(`Imported ${imported}, skipped ${skipped}`);
    $('eventFile').value=''; $('eventsPreview').innerHTML='';
  });
});
function renderEvents(){
  const tbody = $('eventsTable'); if(!tbody) return;
  if(!CACHE.events.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No events</td></tr>'; return; }
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.events.forEach(ev=>{
    const participated = CACHE.participations.some(p => String(p.eventId)===String(ev.id) && String(p.status||'').toLowerCase()==='approved');
    const cls = participated ? 'participated-row' : '';
    html += `<tr class="${cls}" data-key="${ev.id}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.category||'General')}</td><td>${escapeHtml(ev.type||'Non-Stage')}</td><td>${escapeHtml((ev.description||'').slice(0,120))}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-event" data-key="${ev.id}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-event" data-key="${ev.id}">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}
$('eventsTable')?.addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-event')) {
    if(!confirm('Delete event?')) return;
    const dbKey = KEYMAP.events[id] || id;
    if(dbKey) await remove(ref(db, `events/${dbKey}`));
    toast('Event removed');
  } else if(btn.classList.contains('btn-edit-event')) {
    const ev = CACHE.events.find(x=> String(x.id)===String(id));
    if(!ev) return toast('Event not found','danger');
    const newName = prompt('Event name', ev.name) || ev.name;
    const newCategory = prompt('Category (General/Senior/Junior/Special)', ev.category||'General') || ev.category;
    const newType = prompt('Type (Stage/Non-Stage)', ev.type||'Non-Stage') || ev.type;
    const newDesc = prompt('Description', ev.description||'') || ev.description;
    const dbKey = KEYMAP.events[id] || id;
    await update(ref(db, `events/${dbKey}`), { name: newName, category: newCategory, type: newType, description: newDesc });
    toast('Event updated');
  }
});

/* --------------------
   PARTICIPATIONS (leaders submit) -- Admin approves from Approvals panel
   Data format: { id, eventId, studentId, teamId, status: pending/approved/rejected, submittedAt }
   -------------------- */
/* For admin UI we only need approve/reject and download approved list */
function renderApprovals(){
  const tbody = $('approvalsTable'); if(!tbody) return;
  const q = ($('searchApprovals')?.value||'').trim().toLowerCase();
  const rows = [];
  CACHE.participations.forEach(p => {
    if(String(p.status||'').toLowerCase() !== 'pending') return;
    const ev = CACHE.events.find(e => String(e.id)===String(p.eventId)) || {};
    const student = CACHE.students.find(s => String(s.id)===String(p.studentId)) || { name: p.studentId };
    const team = CACHE.teams.find(t => String(t.id)===String(p.teamId)) || {};
    const text = `${ev.name||''} ${student.name||''} ${team.name||''}`.toLowerCase();
    if(q && !text.includes(q)) return;
    rows.push(`<tr data-key="${p.id}"><td>${escapeHtml(ev.name||p.eventId)}</td><td>${escapeHtml(student.name||p.studentId)}</td><td>${escapeHtml(team.name||p.teamId)}</td><td>${new Date(p.submittedAt||0).toLocaleString()}</td><td class="text-end">
      <button class="btn btn-sm btn-success btn-approve" data-key="${p.id}">Approve</button>
      <button class="btn btn-sm btn-danger btn-reject" data-key="${p.id}">Reject</button>
    </td></tr>`);
  });
  tbody.innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No pending participations</td></tr>';
}
$('approvalsTable')?.addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.key; const dbKey = KEYMAP.participations[id] || id;
  if(btn.classList.contains('btn-approve')) {
    await update(ref(db, `participations/${dbKey}`), { status: 'approved', approvedAt: Date.now() });
    toast('Approved');
  } else if(btn.classList.contains('btn-reject')) {
    await update(ref(db, `participations/${dbKey}`), { status: 'rejected', rejectedAt: Date.now() });
    toast('Rejected');
  }
  renderApprovals();
});

/* Approved list download */
$('downloadApprovedPDF')?.addEventListener('click', ()=> {
  const approved = CACHE.participations.filter(p => String(p.status||'').toLowerCase() === 'approved');
  if(!approved.length) return toast('No approved participations','danger');
  // build HTML
  let html = `<h3>Approved Participations</h3><ol>`;
  approved.forEach(a => {
    const ev = CACHE.events.find(e=>String(e.id)===String(a.eventId)) || {};
    const st = CACHE.students.find(s=>String(s.id)===String(a.studentId)) || {};
    const team = CACHE.teams.find(t=>String(t.id)===String(a.teamId)) || {};
    html += `<li><strong>${escapeHtml(ev.name||a.eventId)}</strong>: ${escapeHtml(st.name||a.studentId)} (${escapeHtml(st.id||'')}) — Team: ${escapeHtml(team.name||'')}</li>`;
  });
  html += '</ol>';
  const container = document.createElement('div'); container.innerHTML = html;
  html2pdf().from(container).set({ margin:10, filename:'approved_participations.pdf' }).save();
});

/* --------------------
   ATTENDANCE: load, mark, save, view, edit sessions
   -------------------- */
let attendanceEditingKey = null;
let attendanceToggleState = 'none';

$('attMethod')?.addEventListener('change', ()=> {
  const show = $('attMethod').value === 'team';
  $('attTeamWrap').classList.toggle('d-none', !show);
});
$('loadAttendance')?.addEventListener('click', ()=> {
  const method = $('attMethod').value;
  const teamId = $('attTeam').value;
  let list = [];
  if(method === 'all') list = CACHE.students.slice();
  else list = CACHE.students.filter(s => String(s.teamId) === String(teamId));
  const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
  list.forEach(s => {
    const div = document.createElement('div');
    div.className = 'small-box';
    div.dataset.key = encodeKey(s.id);
    div.textContent = s.id;
    div.title = s.name || '';
    div.addEventListener('click', ()=> {
      // toggle
      if(div.classList.contains('present')) { div.classList.remove('present'); div.classList.add('absent'); }
      else if(div.classList.contains('absent')) { div.classList.remove('absent'); }
      else div.classList.add('present');
      // show name in toast
      toast(`${s.id} — ${s.name}`, 'secondary');
    });
    wrap.appendChild(div);
  });
  $('attendanceMarkCard').style.display = list.length ? 'block' : 'none';
  attendanceToggleState = 'none';
  $('toggleAll').textContent = 'Toggle All';
  attendanceEditingKey = null;
});
$('toggleAll')?.addEventListener('click', ()=> {
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return;
  if(attendanceToggleState === 'none' || attendanceToggleState === 'absent'){
    boxes.forEach(b => { b.classList.remove('absent'); b.classList.add('present'); });
    attendanceToggleState = 'present'; $('toggleAll').textContent = 'Set All Absent';
  } else {
    boxes.forEach(b => { b.classList.remove('present'); b.classList.add('absent'); });
    attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Reset/None';
  }
});
$('saveAttendance')?.addEventListener('click', async ()=> {
  const date = $('attDate').value;
  const time = $('attTime').value || '';
  const desc = $('attDesc').value || '';
  if(!date) return toast('Select date','danger');
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return toast('Load students first','danger');
  const students = {};
  boxes.forEach(b => {
    const id = decodeKey(b.dataset.key);
    if(b.classList.contains('present')) students[id] = 'Present';
    else if(b.classList.contains('absent')) students[id] = 'Absent';
    else students[id] = 'Absent';
  });
  const payload = { date, time, description: desc, students, savedAt: Date.now() };
  if(attendanceEditingKey) {
    await set(ref(db, `attendance/${attendanceEditingKey}`), payload);
    toast('Attendance updated');
    attendanceEditingKey = null;
  } else {
    const p = push(ref(db, 'attendance'));
    await set(p, payload);
    toast('Attendance saved');
  }
  $('attendanceMarkCard').style.display = 'none';
});
function renderAttendanceSessions(){
  const tbody = $('attendanceSessions'); if(!tbody) return;
  const att = CACHE.attendance || {};
  const rows = Object.entries(att);
  if(!rows.length) { tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No sessions</td></tr>'; return; }
  rows.sort((a,b)=> (b[1].savedAt||0)-(a[1].savedAt||0));
  let html = '';
  rows.forEach(([k,v])=>{
    const count = v.students? Object.keys(v.students).length : 0;
    html += `<tr data-db="${k}"><td>${escapeHtml(v.date||'')}</td><td>${escapeHtml(v.time||'')}</td><td>${escapeHtml(v.description||'')}</td><td>${count}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-view-att" data-db="${k}">View</button>
      <button class="btn btn-sm btn-outline-secondary btn-edit-att" data-db="${k}">Edit</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}
$('attendanceSessions')?.addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return;
  const dbKey = btn.dataset.db;
  const snap = await get(ref(db, `attendance/${dbKey}`));
  const s = snap.val(); if(!s) return toast('Session not found','danger');
  if(btn.classList.contains('btn-view-att')){
    // show absent only
    const absent = [];
    if(s.students) for(const id in s.students) if(String(s.students[id]).toLowerCase() !== 'present') absent.push(`${id} — ${ (CACHE.students.find(x=>String(x.id)===String(id))||{} ).name || '' }`);
    alert(`Date: ${s.date} ${s.time || ''}\nDescription: ${s.description || ''}\n\nAbsent:\n${absent.join('\n')}`);
  } else if(btn.classList.contains('btn-edit-att')){
    attendanceEditingKey = dbKey;
    $('attDate').value = s.date || '';
    $('attTime').value = s.time || '';
    $('attDesc').value = s.description || '';
    const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
    CACHE.students.forEach(st => {
      const status = (s.students && s.students[st.id]) ? s.students[st.id] : 'Absent';
      const div = document.createElement('div');
      div.className = 'small-box ' + (String(status).toLowerCase()==='present' ? 'present' : 'absent');
      div.dataset.key = encodeKey(st.id);
      div.textContent = st.id;
      div.title = st.name || '';
      div.addEventListener('click', ()=> {
        if(div.classList.contains('present')) { div.classList.remove('present'); div.classList.add('absent'); }
        else if(div.classList.contains('absent')) { div.classList.remove('absent'); }
        else div.classList.add('present');
      });
      wrap.appendChild(div);
    });
    $('attendanceMarkCard').style.display = 'block';
    toast('Loaded session for edit');
  }
});

/* --------------------
   RESULTS: add result entries, publish toggle, edit
   Data: results/{key} = { id, eventId, placements: [{pos:1, studentId, points}, ...], published:bool, createdAt}
   -------------------- */
function buildResultsTable(){
  const tbody = $('resultsTable'); if(!tbody) return;
  if(!CACHE.results.length) { tbody.innerHTML = '<tr><td colspan="7" class="text-center muted">No results</td></tr>'; return; }
  CACHE.results.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  let html = '';
  CACHE.results.forEach(r => {
    const ev = CACHE.events.find(e=> String(e.id)===String(r.eventId)) || {};
    const placements = r.placements || [];
    placements.forEach(p => {
      const student = CACHE.students.find(s=> String(s.id)===String(p.studentId)) || {};
      const team = CACHE.teams.find(t=> String(t.id)===String(student.teamId)) || {};
      html += `<tr data-key="${r.id}">
          <td>${escapeHtml(ev.name||'')}</td>
          <td>${escapeHtml(student.name||p.studentId)} (${escapeHtml(p.studentId||'')})</td>
          <td>${escapeHtml(team.name||'')}</td>
          <td>${p.pos}</td>
          <td>${p.points}</td>
          <td>${r.published ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
          <td class="text-end"><button class="btn btn-sm btn-outline-primary btn-toggle-publish" data-key="${r.id}">${r.published?'Unpublish':'Publish'}</button></td>
        </tr>`;
    });
  });
  tbody.innerHTML = html;
}
function renderResults(){ buildResultsTable(); }

/* Add result via prompt (admin UI simple) */
$('resultsTable')?.parentElement?.previousElementSibling?.querySelectorAll('') // noop to avoid null - safe

// Create a basic Add Result flow via prompt when admin clicks an event row in events table (quick):
document.addEventListener('click', async (e)=> {
  if(e.target.classList && e.target.classList.contains('btn-add-result')) {
    // Not used, placeholder
  }
});

/* Toggle publish from results table (buttons added in buildResultsTable) */
$('resultsTable')?.addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return;
  if(btn.classList.contains('btn-toggle-publish')) {
    const id = btn.dataset.key; const dbKey = KEYMAP.results[id];
    if(!dbKey) return toast('Result key not found','danger');
    const snap = await get(ref(db, `results/${dbKey}`)); const r = snap.val();
    if(!r) return toast('Result not found','danger');
    const newPub = !r.published;
    await update(ref(db, `results/${dbKey}`), { published: newPub, publishedAt: newPub?Date.now():null });
    toast(newPub ? 'Published' : 'Unpublished');
  }
});

/* For workflow: when admin wants to add result quickly, we'll allow selecting event and selecting participants
   For brevity, implement a simple modalless prompt flow when admin double clicks an event row in Events table. */
$('eventsTable')?.addEventListener('dblclick', async (e)=> {
  const tr = e.target.closest('tr'); if(!tr) return;
  const eventId = tr.dataset.key;
  const participants = CACHE.participations.filter(p => String(p.eventId)===String(eventId) && String(p.status||'').toLowerCase()==='approved');
  if(!participants.length) return toast('No approved participants for this event', 'danger');
  // build mapping of studentId->name
  const map = {}; CACHE.students.forEach(s=> map[s.id]=s.name);
  // get top 3 via prompt selection (admin chooses ids)
  const listStr = participants.map(p=> `${p.studentId} — ${map[p.studentId]||''}`).join('\n');
  const first = prompt(`Event participants:\n${listStr}\n\nEnter StudentID for 1st place (or leave blank)`);
  const second = prompt('Enter StudentID for 2nd place (or leave blank)');
  const third = prompt('Enter StudentID for 3rd place (or leave blank)');
  const p1 = Number(prompt('Points for 1st (max 100)', '100')) || 0;
  const p2 = Number(prompt('Points for 2nd (max 100)', '50')) || 0;
  const p3 = Number(prompt('Points for 3rd (max 100)', '25')) || 0;
  const placements = [];
  if(first) placements.push({ pos:1, studentId:first, points:p1 });
  if(second) placements.push({ pos:2, studentId:second, points:p2 });
  if(third) placements.push({ pos:3, studentId:third, points:p3 });
  const id = Date.now().toString();
  const p = push(ref(db, 'results'));
  await set(p, { id, eventId, placements, published: false, createdAt: Date.now() });
  toast('Result added (Draft). Publish when ready.');
});

/* --------------------
   LIVE SCORES: compute team totals from published results
   -------------------- */
function computeLiveScores(){
  // reset team scores
  const teamScores = {};
  CACHE.teams.forEach(t => teamScores[t.id] = 0);
  CACHE.results.forEach(r => {
    if(!r.published) return;
    (r.placements||[]).forEach(pl => {
      const student = CACHE.students.find(s=> String(s.id)===String(pl.studentId));
      if(!student) return;
      const teamId = student.teamId;
      if(!teamId) return;
      if(!teamScores[teamId]) teamScores[teamId] = 0;
      teamScores[teamId] += Number(pl.points||0);
    });
  });
  // write back to DB (update teams score)
  const updates = {};
  Object.entries(teamScores).forEach(([tid,score]) => {
    const dbKey = KEYMAP.teams[tid];
    if(dbKey) updates[`teams/${dbKey}/score`] = Number(score);
  });
  if(Object.keys(updates).length) update(ref(db, '/'), updates);
  // render reports scoreboard if needed
  renderReports();
}

/* --------------------
   REPORTS: compute attendance % and show team scores too
   -------------------- */
function computeTeamAttendancePct(teamId){
  const members = CACHE.students.filter(s=> String(s.teamId)===String(teamId)).map(s=> s.id);
  if(!members.length) return 0;
  let total = 0, present = 0;
  const att = CACHE.attendance || {};
  for(const k in att){
    const sess = att[k];
    if(!sess || !sess.students) continue;
    members.forEach(m => {
      if(sess.students[m] !== undefined){
        total++;
        if(String(sess.students[m]).toLowerCase() === 'present') present++;
      }
    });
  }
  return total ? Math.round((present/total)*100) : 0;
}
function renderReports(){
  const tbody = $('reportsTable'); if(!tbody) return;
  if(!CACHE.teams.length) { tbody.innerHTML = '<tr><td colspan="3" class="text-center muted">No teams</td></tr>'; return; }
  const html = CACHE.teams.map(t => {
    const members = CACHE.students.filter(s=> String(s.teamId)===String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const score = t.score || 0;
    return `<tr><td>${escapeHtml(t.name)}</td><td>${members}</td><td>${pct}% (Score: ${score})</td></tr>`;
  }).join('');
  tbody.innerHTML = html;
}

/* --------------------
   Populate dropdowns used in many panels
   -------------------- */
function populateDropdowns(){
  const manualTeam = $('manualTeam'); if(manualTeam){ manualTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> manualTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const teamLeader = $('teamLeader'); if(teamLeader){ teamLeader.innerHTML = '<option value="">Choose Leader (Chess#)</option>'; CACHE.students.forEach(s=> teamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const attTeam = $('attTeam'); if(attTeam){ attTeam.innerHTML = '<option value="">Select team</option>'; CACHE.teams.forEach(t=> attTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  // results creation dropdowns and event selection (if present)
  const resultEvent = $('resultEvent'); if(resultEvent){ resultEvent.innerHTML = '<option value="">Select event</option>'; CACHE.events.forEach(e=> resultEvent.innerHTML += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`); }
}

/* --------------------
   Exports: Students PDF & students table download / approved list
   -------------------- */
$('btnExportStudents')?.addEventListener('click', ()=> {
  if(!CACHE.students.length) return toast('No students to export','danger');
  let html = `<h3>Students List</h3><table style="width:100%"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>`;
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id] = t.name);
  CACHE.students.forEach(s => html += `<tr><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'')}</td><td>${escapeHtml(teamMap[s.teamId]||'')}</td></tr>`);
  html += '</tbody></table>';
  const el = document.createElement('div'); el.innerHTML = html;
  html2pdf().from(el).set({ margin:10, filename:'students_list.pdf' }).save();
});

/* --------------------
   small utility renders & initializations
   -------------------- */
function renderResultsList(){ renderResults(); computeLiveScores(); }
function renderAll(){ renderStudents(); renderTeams(); renderEvents(); renderApprovals(); renderAttendanceSessions(); renderResults(); renderReports(); }
setTimeout(()=> renderAll(), 500);

/* --------------------
   Search filtering small bindings
   -------------------- */
$('searchStudents')?.addEventListener('input', ()=> {
  const q = $('searchStudents').value.trim().toLowerCase();
  const rows = Array.from(document.querySelectorAll('#studentsTable tr'));
  rows.forEach(r => {
    const text = r.textContent.toLowerCase();
    r.style.display = q && !text.includes(q) ? 'none' : '';
  });
});
$('searchApprovals')?.addEventListener('input', renderApprovals);
$('searchResults')?.addEventListener('input', ()=> {
  const q = $('searchResults').value.trim().toLowerCase();
  Array.from(document.querySelectorAll('#resultsTable tr')).forEach(r => {
    r.style.display = q && !r.textContent.toLowerCase().includes(q) ? 'none' : '';
  });
});

/* --------------------
   Small safety: ensure current year in topbar
   -------------------- */
try { $('current-year') && ($('current-year').textContent = new Date().getFullYear()); } catch(e){}

/* --------------------
   End of module
   -------------------- */
</script>
</body>
</html>