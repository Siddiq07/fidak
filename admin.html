<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Panel — Art Fest</title>

<!-- BOOTSTRAP -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<!-- EXCEL + PDF LIBRARIES (UI-only; logic in Part 4) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --bg:#f4f7fb;
  --card:#fff;
  --muted:#6b7280;
  --accent:#4f46e5;
  --success:#10b981;
  --danger:#ef4444;
  --glass: rgba(255,255,255,0.6);
}
*{box-sizing:border-box}
body{
  background:var(--bg);
  font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  color:#0f172a;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  margin:0;
}
.container-wide{max-width:1200px;margin:18px auto;padding:0 12px}
.card-neo{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  box-shadow:0 8px 22px rgba(12,20,40,0.06);
  border: 1px solid rgba(15,23,42,0.03);
}
.section-title{font-weight:700;margin-bottom:8px;font-size:15px}
.small-box{
  width:60px;height:38px;background:#eef2ff;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;margin:6px;cursor:pointer;font-weight:700;color:#0b1220;
  user-select:none;font-size:14px;
}
.small-box.present{background:var(--success);color:#fff}
.small-box.absent{background:var(--danger);color:#fff}
.btn-accent{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;border:0}
.table thead{background:#fbfbff}
.muted{color:var(--muted);font-size:13px}
.participated-row{background:#e8fff0}
.nav-pill-sm .nav-link{padding:.4rem .8rem;font-size:14px}

/* modals */
.modal-content{border-radius:12px;border:0}
.modal-header{background:#f6f9ff;border-bottom:0;border-radius:12px 12px 0 0}
.modal-title{font-weight:700}
.modal-body .form-label{font-weight:600}

/* small device tweaks */
@media (max-width:640px){
  .small-box{width:48px;height:32px;font-size:13px;margin:4px}
  .container-wide{padding:0 10px}
  .nav-pill-sm .nav-link{font-size:13px;padding:.35rem .6rem}
}

/* attendance tooltip */
.attendance-tooltip{
  position:fixed;pointer-events:none;background:rgba(0,0,0,0.75);color:#fff;padding:6px 8px;border-radius:6px;font-size:13px;transform:translate(-50%,-120%);
  transition:opacity .18s ease;opacity:0;z-index:40000;
}
.attendance-tooltip.show{opacity:1}
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar shadow-sm mb-3 bg-white">
  <div class="container container-wide d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <span class="badge text-bg-primary rounded-pill p-2"><i class="bi bi-award"></i></span>
      <div>
        <div style="font-weight:800;font-size:16px">Art Fest — Admin Panel</div>
        <div class="muted" style="font-size:13px">Manage Students · Teams · Events · Attendance · Results</div>
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <button id="openStudents" class="btn btn-outline-secondary">Students</button>
      <button id="openTeams" class="btn btn-outline-secondary">Teams</button>
      <button id="openEvents" class="btn btn-outline-secondary">Events</button>
      <button id="openAttendance" class="btn btn-outline-secondary">Attendance</button>
      <button id="openApprovals" class="btn btn-outline-secondary">Approvals</button>
      <button id="openResults" class="btn btn-outline-secondary">Results</button>
      <button id="openReports" class="btn btn-outline-secondary">Reports</button>
      <button id="logoutBtn" class="btn btn-outline-danger" title="Logout"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </div>
</nav>

<!-- TABS + PANELS WRAPPER -->
<main class="container container-wide">
  <div class="card-neo mb-3">

    <ul class="nav nav-pills nav-pill-sm" id="tabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-target="panel-students" type="button">Students</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-teams" type="button">Teams</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-events" type="button">Events</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-attendance" type="button">Attendance</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-approvals" type="button">Approvals</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-results" type="button">Results</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-reports" type="button">Reports</button></li>
    </ul>

    <div id="panels" class="mt-3">
      <!-- Panels (Student/Team/Event/Attendance/Approvals/Results/Reports) -->
      <!-- (Actual panel HTML content to be placed in Part 2 & Part 3) -->
      <!-- Keep this wrapper — Part 2 & 3 will fill panels -->
    </div>
  </div>
</main>

<!-- ===========================
     ALL MODALS (Edit Student, Full Team Edit, Edit Event, Confirm/Toasts)
     Place BEFORE Firebase script (Part 4 will use these)
     =========================== -->

<!-- EDIT STUDENT MODAL -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editStudentDbKey">

        <label class="form-label">Chess Number</label>
        <input id="editChess" class="form-control mb-2" readonly>

        <label class="form-label">Name</label>
        <input id="editName" class="form-control mb-2" required>

        <label class="form-label">Level</label>
        <select id="editLevel" class="form-select mb-2">
          <option value="Senior">Senior</option>
          <option value="Junior">Junior</option>
        </select>

        <label class="form-label">Team</label>
        <select id="editTeam" class="form-select mb-2">
          <option value="">Unassigned</option>
        </select>
      </div>

      <div class="modal-footer">
        <button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- FULL EDIT TEAM MODAL -->
<div class="modal fade" id="fullEditTeamModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <form id="fullEditTeamForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Team</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="fullEditTeamDbKey">
        <input type="hidden" id="fullEditTeamId">

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Team Name</label>
            <input id="editTeamName" class="form-control mb-2" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Leader (Chess#)</label>
            <select id="editTeamLeader" class="form-select mb-2">
              <option value="">Select leader</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Password (for leader)</label>
            <input id="editTeamPassword" class="form-control mb-2" placeholder="optional">
          </div>
          <div class="col-md-6 d-flex align-items-center">
            <div class="form-check ms-1 mt-2">
              <input class="form-check-input" type="checkbox" id="editTeamLock">
              <label class="form-check-label muted" for="editTeamLock">Lock team (disable login)</label>
            </div>
          </div>
        </div>

        <hr>
        <div>
          <label class="form-label">Members</label>
          <div id="editTeamMembers" style="max-height:240px; overflow:auto; border:1px dashed #eef2ff; padding:10px; border-radius:8px">
            <div class="muted">Members will be listed here</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" id="deleteTeamBtnModal" class="btn btn-danger">Delete Team</button>
        <button type="submit" class="btn btn-primary">Save Team</button>
      </div>
    </form>
  </div>
</div>

<!-- EDIT EVENT MODAL (G2 layout: Type -> Level -> Description) -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="editEventForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="editEventId">

        <label class="form-label">Event Name</label>
        <input id="editEventName" class="form-control mb-2" required>

        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Type</label>
            <select id="editEventType" class="form-select mb-2">
              <option>Stage</option>
              <option>Non-Stage</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Level</label>
            <select id="editEventLevel" class="form-select mb-2">
              <option>Junior</option>
              <option>Senior</option>
              <option>General</option>
              <option>Special</option>
            </select>
          </div>
        </div>

        <label class="form-label">Description / Rules</label>
        <textarea id="editEventDesc" class="form-control mb-2" rows="4" placeholder="Write rules, time limit, materials, etc."></textarea>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Event</button>
      </div>
    </form>
  </div>
</div>

<!-- DYNAMIC SMALL CONFIRM/INFO MODAL (re-usable) -->
<div class="modal fade" id="infoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center p-3" id="infoModalBody">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
</div>

<!-- Approved list container (for PDF rendering) -->
<div style="display:none" id="approvedGroupsContainer"></div>

<!-- Attendance tooltip element -->
<div class="attendance-tooltip" id="attendanceTooltip" role="tooltip" style="left:0;top:0;opacity:0"></div>

<!-- Toast root -->
<div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:30000"></div>

<!-- Keep page open — Firebase & logic scripts will be added in Part 4 -->
<!-- ============================
     PART 2 — ALL PANELS UI
     ============================ -->

<!-- ============================
     STUDENTS PANEL
     ============================ -->
<section id="panel-students" class="panel">
  <div class="row g-3">

    <!-- LEFT SIDE: IMPORT + MANUAL ADD -->
    <div class="col-lg-5">
      <div class="card-neo mb-3">
        <div class="section-title">Import Students (Excel)</div>
        <div class="muted mb-2">Columns: Chess, Name, Level, Team (optional)</div>

        <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">

        <div class="d-flex gap-2 mb-2">
          <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
          <button id="importStudents" class="btn btn-accent">Import</button>
        </div>

        <hr>

        <div class="section-title">Add Student Manually</div>

        <input id="manualChess" class="form-control mb-2" placeholder="Chess Number (alphanumeric)">
        <input id="manualName" class="form-control mb-2" placeholder="Full Name">

        <select id="manualLevel" class="form-select mb-2">
          <option>Senior</option>
          <option>Junior</option>
        </select>

        <select id="manualTeam" class="form-select mb-2">
          <option value="">Unassigned</option>
        </select>

        <button id="addManualStudent" class="btn btn-success w-100">Add Student</button>

        <hr>

        <div class="section-title">Preview</div>
        <div id="studentsPreview" style="max-height:260px; overflow:auto"></div>
      </div>
    </div>

    <!-- RIGHT SIDE: STUDENT LIST -->
    <div class="col-lg-7">
      <div class="card-neo">
        <div class="d-flex justify-content-between mb-2">
          <div class="section-title">All Students</div>
          <input id="searchStudents" class="form-control w-50" placeholder="Search name or chess #">
        </div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Chess #</th>
                <th>Name</th>
                <th>Level</th>
                <th>Team</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- ============================
     TEAMS PANEL
     ============================ -->
<section id="panel-teams" class="panel d-none">
  <div class="row g-3">

    <div class="col-lg-5">
      <div class="card-neo">
        <div class="section-title">Create Team</div>

        <input id="teamName" class="form-control mb-2" placeholder="Team Name">

        <select id="teamLeader" class="form-select mb-2">
          <option value="">Choose leader (Chess #)</option>
        </select>

        <input id="teamPassword" class="form-control mb-2" placeholder="Password">

        <button id="saveTeam" class="btn btn-success w-100">Save Team</button>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card-neo">
        <div class="section-title">Teams Overview</div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Team</th>
                <th>Leader</th>
                <th>Members</th>
                <th>Attendance %</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="teamsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- ============================
     EVENTS PANEL
     ============================ -->
<section id="panel-events" class="panel d-none">
  <div class="row g-3">

    <div class="col-lg-5">
      <div class="card-neo mb-3">
        <div class="section-title">Add Event</div>

        <input id="eventName" class="form-control mb-2" placeholder="Event Name">

        <div class="row g-2">
          <div class="col-md-6">
            <select id="eventType" class="form-select mb-2">
              <option>Stage</option>
              <option>Non-Stage</option>
            </select>
          </div>

          <div class="col-md-6">
            <select id="eventLevel" class="form-select mb-2">
              <option>Junior</option>
              <option>Senior</option>
              <option>General</option>
              <option>Special</option>
            </select>
          </div>
        </div>

        <textarea id="eventDescription" class="form-control mb-2" rows="3"
          placeholder="Description / rules"></textarea>

        <button id="saveEvent" class="btn btn-warning w-100">Add Event</button>
      </div>

      <!-- Import Events -->
      <div class="card-neo">
        <div class="section-title">Import Events (Excel)</div>

        <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">

        <div class="d-flex gap-2 mb-2">
          <button id="previewEvents" class="btn btn-outline-primary">Preview</button>
          <button id="importEvents" class="btn btn-accent">Import</button>
        </div>

        <div id="eventsPreview" style="max-height:220px; overflow:auto"></div>
      </div>
    </div>

    <div class="col-lg-7">
      <div class="card-neo">
        <div class="section-title">Events List</div>

        <div class="table-responsive">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Level</th>
                <th>Description</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="eventsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- ============================
     ATTENDANCE PANEL
     ============================ -->
<section id="panel-attendance" class="panel d-none">
  <div class="card-neo mb-3">

    <div class="row g-2 align-items-center">
      <div class="col-md-2">
        <input id="attDate" type="date" class="form-control">
      </div>
      <div class="col-md-2">
        <input id="attTime" type="time" class="form-control">
      </div>
      <div class="col-md-4">
        <input id="attDesc" class="form-control" placeholder="Description">
      </div>

      <div class="col-md-2">
        <select id="attMethod" class="form-select">
          <option value="all">All</option>
          <option value="team">By Team</option>
        </select>
      </div>

      <div class="col-md-2 d-none" id="attTeamWrap">
        <select id="attTeam" class="form-select"></select>
      </div>
    </div>

    <div class="mt-3 d-flex gap-2">
      <button id="loadAttendance" class="btn btn-info">Load Students</button>
      <button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button>
      <button id="saveAttendance" class="btn btn-success">Save Session</button>
    </div>

  </div>

  <div class="card-neo mb-3" id="attendanceMarkCard" style="display:none">
    <div class="section-title">Mark Attendance</div>
    <div class="muted mb-2">Tap a box to toggle Present/Absent</div>
    <div id="attendanceBoxes" style="padding:12px;"></div>
  </div>

  <div class="card-neo">
    <div class="section-title">Saved Sessions</div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Description</th>
            <th>Count</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="attendanceSessions"></tbody>
      </table>
    </div>

  </div>
</section>

<!-- ============================
     APPROVALS PANEL
     ============================ -->
<section id="panel-approvals" class="panel d-none">
  <div class="card-neo">
    <div class="d-flex justify-content-between">
      <div>
        <div class="section-title">Pending Approvals</div>
        <div class="muted">Approve or reject participants submitted by leaders</div>
      </div>

      <input id="searchApprovals" class="form-control w-50" placeholder="Search...">
    </div>

    <div class="table-responsive mt-3" style="max-height:420px; overflow:auto">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Event</th>
            <th>Student</th>
            <th>Team</th>
            <th>Submitted</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="approvalsTable"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ============================
     RESULTS PANEL
     ============================ -->
<section id="panel-results" class="panel d-none">
  <div class="card-neo">
    <div class="section-title">Results — Add & Publish</div>

    <div class="row g-2 mb-3">
      <div class="col-md-4">
        <select id="resultEvent" class="form-select">
          <option value="">Select Event</option>
        </select>
      </div>
      <div class="col-md-3">
        <select id="resultPosition" class="form-select">
          <option value="">Position</option>
          <option value="1">1st — (Gold)</option>
          <option value="2">2nd — (Silver)</option>
          <option value="3">3rd — (Bronze)</option>
        </select>
      </div>
      <div class="col-md-3">
        <input id="resultPoints" type="number" class="form-control" placeholder="Points">
      </div>
      <div class="col-md-2">
        <button id="saveResult" class="btn btn-success w-100">Save</button>
      </div>
    </div>

    <div class="section-title">All Results</div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead class="table-light">
          <tr>
            <th>Event</th>
            <th>1st</th>
            <th>2nd</th>
            <th>3rd</th>
            <th>Published</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- ============================
     REPORTS PANEL
     ============================ -->
<section id="panel-reports" class="panel d-none">
  <div class="card-neo">
    <div class="section-title">Team Attendance Report</div>

    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Team</th>
            <th>Members</th>
            <th>Attendance %</th>
          </tr>
        </thead>
        <tbody id="reportsTable"></tbody>
      </table>
    </div>
  </div>
</section>
<!-- ====================================================
     PART 3 — ALL MODALS / POPUPS
     ==================================================== -->

<!-- ============================
     EDIT STUDENT MODAL
     ============================ -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <label class="form-label">Chess Number</label>
        <input id="editChess" class="form-control mb-2" readonly>

        <label class="form-label">Full Name</label>
        <input id="editName" class="form-control mb-2" required>

        <label class="form-label">Level</label>
        <select id="editLevel" class="form-select mb-2">
          <option>Senior</option>
          <option>Junior</option>
        </select>

        <label class="form-label">Team</label>
        <select id="editTeam" class="form-select mb-2">
          <option value="">Unassigned</option>
        </select>

      </div>

      <div class="modal-footer">
        <button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>

    </form>
  </div>
</div>

<!-- ============================
     EDIT EVENT MODAL (UPDATED)
     ============================ -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editEventForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label class="form-label">Event Name</label>
        <input id="editEventName" class="form-control mb-2" required>

        <label class="form-label">Event Type</label>
        <select id="editEventType" class="form-select mb-2">
          <option>Stage</option>
          <option>Non-Stage</option>
        </select>

        <label class="form-label">Category</label>
        <select id="editEventLevel" class="form-select mb-2">
          <option>Junior</option>
          <option>Senior</option>
          <option>General</option>
          <option>Special</option>
        </select>

        <label class="form-label">Description</label>
        <textarea id="editEventDesc" class="form-control mb-2" rows="4"></textarea>
      </div>

      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>

    </form>
  </div>
</div>

<!-- ============================
     EDIT TEAM MODAL + LOCK SYSTEM
     ============================ -->
<div class="modal fade" id="editTeamModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editTeamForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Team</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <label class="form-label">Team Name</label>
        <input id="editTeamName" class="form-control mb-2" required>

        <label class="form-label">Leader (Chess #)</label>
        <select id="editTeamLeader" class="form-select mb-2">
          <option value="">Select Leader</option>
        </select>

        <label class="form-label">Password</label>
        <input id="editTeamPassword" class="form-control mb-2">

        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="teamLocked">
          <label class="form-check-label">Lock Team (leader cannot login)</label>
        </div>

      </div>

      <div class="modal-footer">
        <button type="button" id="deleteTeamBtn" class="btn btn-danger">Delete Team</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>

    </form>
  </div>
</div>

<!-- ============================
     VIEW ATTENDANCE (ABSENTEES ONLY)
     ============================ -->
<div class="modal fade" id="attendanceViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Attendance Details</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div id="attendanceViewContent"></div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-primary" id="downloadAbsenteesPdf">Download PDF</button>
      </div>

    </div>
  </div>
</div>

<!-- ============================
     RESULT VIEW / EDIT MODAL
     ============================ -->
<div class="modal fade" id="editResultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editResultForm" class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Edit Result</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <label class="form-label">Event</label>
        <input id="editResultEventName" class="form-control mb-2" readonly>

        <label class="form-label">1st Place</label>
        <select id="editResFirst" class="form-select mb-2"></select>

        <label class="form-label">Points</label>
        <input id="editPtsFirst" type="number" class="form-control mb-2">

        <label class="form-label">2nd Place</label>
        <select id="editResSecond" class="form-select mb-2"></select>

        <label class="form-label">Points</label>
        <input id="editPtsSecond" type="number" class="form-control mb-2">

        <label class="form-label">3rd Place</label>
        <select id="editResThird" class="form-select mb-2"></select>

        <label class="form-label">Points</label>
        <input id="editPtsThird" type="number" class="form-control mb-2">

      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" id="deleteResultBtn">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>

    </form>
  </div>
</div>
<script type="module">
/*
  Part 4 — Firebase logic (Admin)
  - Realtime listeners for students, teams, events, participations, results, attendance
  - CRUD operations
  - Approvals (approve/reject)
  - Attendance marking, view absentees & PDF
  - Results add / edit / publish
  - Team lock system
  - PDF exports for lists
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getDatabase, ref, push, set, update, onValue, get, remove
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Utility helpers */
const $ = id => document.getElementById(id);
function toast(msg, type='success'){
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0`;
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  $('toastRoot').appendChild(el);
  const t = new bootstrap.Toast(el, { delay: 3000 });
  t.show();
  el.addEventListener('hidden.bs.toast', ()=> el.remove());
}
function encodeKey(k){ return encodeURIComponent(String(k)); }
function decodeKey(k){ return decodeURIComponent(String(k)); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Local caches */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, participations: {}, results: {} };

/* DB refs */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');

/* realtime listeners */
onValue(studentsRef, snap => {
  const obj = snap.val() || {};
  CACHE.students = Object.values(obj);
  KEYMAP.students = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.students[String(v.id)] = k; });
  renderAll();
});
onValue(teamsRef, snap => {
  const obj = snap.val() || {};
  CACHE.teams = Object.values(obj);
  KEYMAP.teams = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.teams[String(v.id)] = k; });
  renderAll();
});
onValue(eventsRef, snap => {
  const obj = snap.val() || {};
  CACHE.events = Object.values(obj);
  KEYMAP.events = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.events[String(v.id)] = k; });
  renderAll();
});
onValue(partsRef, snap => {
  const obj = snap.val() || {};
  CACHE.participations = Object.values(obj);
  KEYMAP.participations = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.participations[String(v.id)] = k; });
  renderAll();
});
onValue(resultsRef, snap => {
  const obj = snap.val() || {};
  CACHE.results = Object.values(obj);
  KEYMAP.results = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.results[String(v.id)] = k; });
  renderAll();
});
onValue(attendanceRef, snap => {
  CACHE.attendance = snap.val() || {};
  renderAll();
});

/* UI tab wiring */
document.querySelectorAll('#tabs [data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
    const id = btn.getAttribute('data-target');
    $(id).classList.remove('d-none');
    document.querySelectorAll('#tabs .nav-link').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
  });
});
$('openStudents').addEventListener('click', ()=> document.querySelector('[data-target="panel-students"]').click());
$('openTeams').addEventListener('click', ()=> document.querySelector('[data-target="panel-teams"]').click());
$('openEvents').addEventListener('click', ()=> document.querySelector('[data-target="panel-events"]').click());
$('openAttendance').addEventListener('click', ()=> document.querySelector('[data-target="panel-attendance"]').click());
$('openApprovals').addEventListener('click', ()=> document.querySelector('[data-target="panel-approvals"]').click());
$('openResults').addEventListener('click', ()=> document.querySelector('[data-target="panel-results"]').click());
$('openReports').addEventListener('click', ()=> document.querySelector('[data-target="panel-reports"]').click());
$('logoutBtn').addEventListener('click', ()=> { sessionStorage.clear(); location.href='index.html'; });

/* Render everything */
function renderAll(){
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceSessions();
  renderApprovals();
  renderResults();
  renderReports();
  populateDropdowns();
}

/* ---------------------------
   STUDENTS
   --------------------------- */
function studentIdExists(id){ return CACHE.students.some(s => String(s.id) === String(id)); }
function studentNameExists(name){ if(!name) return false; const n = String(name).trim().toLowerCase(); return CACHE.students.some(s => String(s.name||'').trim().toLowerCase() === n); }

/* Excel preview/import for students */
let studentsPreviewRows = [];
$('previewStudents').addEventListener('click', ()=> {
  const f = $('studentFile').files[0];
  if(!f) return toast('Select Excel file','danger');
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' });
    studentsPreviewRows = json.slice(0,500);
    renderStudentsPreview();
  };
  r.readAsBinaryString(f);
});
function renderStudentsPreview(){
  const wrap = $('studentsPreview');
  if(!studentsPreviewRows.length){ wrap.innerHTML = '<div class="muted">No preview</div>'; return; }
  let html = `<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>`;
  studentsPreviewRows.forEach(r=>{
    const chess = (r['Chess']||r['Chess Number']||r['ID']||r['id']||'').toString();
    const name = (r['Name']||r['name']||'').toString();
    const level = (r['Level']||r['level']||'Senior').toString();
    const team = (r['Team']||r['team']||'').toString();
    html += `<tr><td>${escapeHtml(chess)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(level)}</td><td>${escapeHtml(team)}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}
$('importStudents').addEventListener('click', async ()=>{
  if(!studentsPreviewRows.length) return toast('No preview','danger');
  const teamNameToId = {}; CACHE.teams.forEach(t => { if(t.name) teamNameToId[String(t.name).trim().toLowerCase()] = t.id; });
  const updates = {}; let imported=0, skipped=0;
  studentsPreviewRows.forEach(r=>{
    const chessRaw = (r['Chess']||r['Chess Number']||r['ID']||r['id']||'').toString().trim();
    const nameRaw = (r['Name']||r['name']||'').toString().trim();
    const levelRaw = (r['Level']||r['level']||'Senior').toString().trim();
    if(!chessRaw || !nameRaw){ skipped++; return; }
    const chess = chessRaw;
    const name = nameRaw;
    if(studentIdExists(chess) || studentNameExists(name)){ skipped++; return; }
    const teamName = (r['Team']||r['team']||'').toString().trim();
    const teamId = teamName ? (teamNameToId[teamName.toLowerCase()] || null) : null;
    updates[`students/${encodeKey(chess)}`] = { id: chess, name, level: levelRaw||'Senior', teamId: teamId ? String(teamId) : null };
    imported++;
  });
  if(!Object.keys(updates).length) return toast(`Imported ${imported}, skipped ${skipped}`,'warning');
  await update(ref(db,'/'), updates);
  studentsPreviewRows = []; $('studentsPreview').innerHTML=''; $('studentFile').value='';
  toast(`Imported ${imported}, skipped ${skipped}`);
});

/* manual add student */
$('addManualStudent').addEventListener('click', async ()=>{
  const chessRaw = $('manualChess').value.trim();
  const name = $('manualName').value.trim();
  const level = $('manualLevel').value || 'Senior';
  const teamId = $('manualTeam').value || null;
  if(!chessRaw || !name) return toast('Enter chess ID and name','danger');
  if(studentIdExists(chessRaw)) return toast('Chess ID already exists','danger');
  if(studentNameExists(name)) return toast('Name already exists','danger');
  await set(ref(db, `students/${encodeKey(chessRaw)}`), { id: chessRaw, name, level, teamId: teamId ? String(teamId) : null });
  $('manualChess').value=''; $('manualName').value=''; $('manualTeam').value='';
  toast('Student saved');
});

/* render students list */
function renderStudents(){
  const tbody = $('studentsTable');
  const q = ($('searchStudents')?.value||'').trim().toLowerCase();
  if(!CACHE.students.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No students</td></tr>'; return; }
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
  let html = '';
  CACHE.students.forEach(s=>{
    const team = s.teamId ? (teamMap[s.teamId]||'Unknown') : 'Unassigned';
    const text = `${s.id} ${s.name} ${team}`.toLowerCase();
    if(q && !text.includes(q)) return;
    html += `<tr data-key="${encodeKey(s.id)}"><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'Senior')}</td><td>${escapeHtml(team)}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-student">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-student">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="5" class="text-center muted">No students</td></tr>';
}

/* student actions (edit/delete) */
$('studentsTable').addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  const dbKey = tr.dataset.key;
  if(e.target.classList.contains('btn-delete-student')){
    if(!confirm('Delete student?')) return;
    await remove(ref(db, `students/${dbKey}`));
    toast('Student deleted');
    return;
  } else if(e.target.classList.contains('btn-edit-student')){
    const snap = await get(ref(db, `students/${dbKey}`));
    const s = snap.val();
    if(!s) return toast('Student not found','danger');
    $('editStudentDbKey').value = dbKey;
    $('editChess').value = s.id;
    $('editName').value = s.name || '';
    $('editLevel').value = s.level || 'Senior';
    populateDropdowns();
    setTimeout(()=> { $('editTeam').value = s.teamId || ''; }, 50);
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
  }
});

/* edit student save / delete */
$('editStudentForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = $('editStudentDbKey').value;
  if(!dbKey) return toast('Missing key','danger');
  const newName = $('editName').value.trim();
  const newLevel = $('editLevel').value || 'Senior';
  const newTeam = $('editTeam').value || null;
  if(!newName) return toast('Name required','danger');
  const curSnap = await get(ref(db, `students/${dbKey}`));
  const cur = curSnap.val();
  if(!cur) return toast('Student not found','danger');
  if(String(newName).trim().toLowerCase() !== String(cur.name||'').trim().toLowerCase()){
    if(studentNameExists(newName)) return toast('Name already exists','danger');
  }
  await update(ref(db, `students/${dbKey}`), { name: newName, level: newLevel, teamId: newTeam ? String(newTeam) : null });
  toast('Student updated');
  bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});
$('deleteStudentBtn').addEventListener('click', async ()=>{
  if(!confirm('Delete this student?')) return;
  const dbKey = $('editStudentDbKey').value;
  if(!dbKey) return toast('Missing key','danger');
  await remove(ref(db, `students/${dbKey}`));
  toast('Student deleted');
  bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});

/* ---------------------------
   TEAMS
   --------------------------- */
$('saveTeam').addEventListener('click', async ()=>{
  const name = $('teamName').value.trim();
  const leader = $('teamLeader').value || null;
  const pwd = $('teamPassword').value.trim() || '';
  if(!name) return toast('Team name required','danger');
  const id = Date.now().toString();
  const p = push(ref(db, 'teams'));
  await set(p, { id, name, leaderId: leader ? String(leader) : null, password: pwd, locked: false, score: 0 });
  $('teamName').value=''; $('teamLeader').value=''; $('teamPassword').value='';
  toast('Team saved');
});

/* render teams */
function computeTeamAttendancePct(teamId){
  const attend = CACHE.attendance || {};
  const members = CACHE.students.filter(s => String(s.teamId) === String(teamId)).map(s=>String(s.id));
  if(!members.length) return 0;
  let total=0, present=0;
  for(const k in attend){
    const s = attend[k];
    if(!s || !s.students) continue;
    members.forEach(m=>{
      if(s.students && s.students[m] !== undefined){
        total++;
        if(String(s.students[m]).toLowerCase() === 'present') present++;
      }
    });
  }
  return total? Math.round((present/total)*100):0;
}
function renderTeams(){
  const tbody = $('teamsTable');
  if(!CACHE.teams.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No teams</td></tr>'; return; }
  CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.teams.forEach(t=>{
    const leader = CACHE.students.find(s => String(s.id) === String(t.leaderId));
    const members = CACHE.students.filter(s => String(s.teamId) === String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const lockBadge = t.locked ? '<span class="badge bg-danger">Locked</span>' : '';
    html += `<tr data-key="${t.id}"><td>${escapeHtml(t.name)} ${lockBadge}</td><td>${leader?escapeHtml(leader.name+' ('+leader.id+')'):'-'}</td><td>${members}</td><td>${pct}%</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-team" data-key="${t.id}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-team" data-key="${t.id}">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}

/* teams actions */
$('teamsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-team')){
    if(!confirm('Delete team?')) return;
    const dbKey = KEYMAP.teams[id] || id;
    if(dbKey) await remove(ref(db, `teams/${dbKey}`));
    // unassign members
    const updates = {};
    CACHE.students.filter(s => String(s.teamId) === String(id)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null);
    if(Object.keys(updates).length) await update(ref(db,'/'), updates);
    toast('Team deleted');
  } else if(btn.classList.contains('btn-edit-team')){
    const dbKey = KEYMAP.teams[id] || id;
    const snap = await get(ref(db, `teams/${dbKey}`));
    const t = snap.val();
    if(!t) return toast('Team not found','danger');
    $('fullEditTeamDbKey').value = dbKey;
    $('fullEditTeamId').value = t.id || id;
    $('editTeamName').value = t.name || '';
    $('editTeamLeader').value = t.leaderId || '';
    $('editTeamPassword').value = t.password || '';
    $('editTeamLock').checked = !!t.locked;
    // members list
    const membersWrap = $('editTeamMembers'); membersWrap.innerHTML = '';
    const members = CACHE.students.filter(s => String(s.teamId) === String(t.id));
    if(!members.length) membersWrap.innerHTML = '<div class="muted">No members</div>';
    else members.forEach(m => membersWrap.innerHTML += `<div style="padding:6px 4px;border-bottom:1px solid #f2f6ff">${escapeHtml(m.name)} <span class="muted">(${escapeHtml(m.id)})</span></div>`);
    new bootstrap.Modal(document.getElementById('fullEditTeamModal')).show();
  }
});

/* full edit team modal save/delete */
$('fullEditTeamForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = $('fullEditTeamDbKey').value;
  if(!dbKey) return toast('Missing key','danger');
  const name = $('editTeamName').value.trim();
  const leader = $('editTeamLeader').value || null;
  const pwd = $('editTeamPassword').value || '';
  const locked = !!$('editTeamLock').checked;
  await update(ref(db, `teams/${dbKey}`), { name, leaderId: leader ? String(leader) : null, password: pwd, locked });
  toast('Team updated');
  bootstrap.Modal.getInstance(document.getElementById('fullEditTeamModal')).hide();
});
$('deleteTeamBtnModal').addEventListener('click', async ()=>{
  if(!confirm('Delete this team?')) return;
  const dbKey = $('fullEditTeamDbKey').value;
  const teamId = $('fullEditTeamId').value;
  if(!dbKey) return toast('Missing team key','danger');
  await remove(ref(db, `teams/${dbKey}`));
  const updates = {};
  CACHE.students.filter(s => String(s.teamId) === String(teamId)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null);
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  toast('Team deleted');
  bootstrap.Modal.getInstance(document.getElementById('fullEditTeamModal')).hide();
});

/* ---------------------------
   EVENTS
   --------------------------- */
$('saveEvent').addEventListener('click', async ()=>{
  const name = $('eventName').value.trim();
  const type = $('eventType').value;
  const level = $('eventLevel').value;
  const desc = $('eventDescription').value.trim();
  if(!name) return toast('Event name required','danger');
  if(CACHE.events.some(e => String(e.name||'').trim().toLowerCase() === name.toLowerCase())) return toast('Event name already exists','danger');
  const p = push(ref(db, 'events'));
  const id = Date.now().toString();
  await set(p, { id, name, type, level, description: desc, status: 'Open', createdAt: Date.now() });
  $('eventName').value=''; $('eventDescription').value='';
  toast('Event added');
});

/* preview/import events Excel */
let eventsPreviewRows = [];
$('previewEvents').addEventListener('click', ()=> {
  const f = $('eventFile').files[0];
  if(!f) return toast('Choose event Excel','danger');
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    eventsPreviewRows = json;
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Level</th><th>Description</th></tr></thead><tbody>';
    json.forEach(rw => html += `<tr><td>${escapeHtml(rw['Name']||rw['Event']||rw['name']||'')}</td><td>${escapeHtml(rw['Type']||rw['type']||'')}</td><td>${escapeHtml(rw['Level']||rw['level']||'')}</td><td>${escapeHtml(rw['Description']||rw['description']||'')}</td></tr>`);
    html += '</tbody></table>';
    $('eventsPreview').innerHTML = html;
  };
  r.readAsBinaryString(f);
});
$('importEvents').addEventListener('click', async ()=>{
  if(!eventsPreviewRows.length) return toast('No preview','danger');
  const updates = {}; let imported=0, skipped=0;
  eventsPreviewRows.forEach(rw=>{
    const name = (rw['Name']||rw['Event']||rw['name']||'').toString().trim();
    if(!name){ skipped++; return; }
    if(CACHE.events.some(ev => String(ev.name||'').trim().toLowerCase()===name.toLowerCase())){ skipped++; return; }
    const type = (rw['Type']||rw['type']||'Non-Stage').toString();
    const level = (rw['Level']||rw['level']||'General').toString();
    const desc = (rw['Description']||rw['description']||'').toString();
    const id = Date.now().toString() + Math.floor(Math.random()*9999);
    updates[`events/${id}`] = { id, name, type, level, description: desc, status:'Open', createdAt: Date.now() };
    imported++;
  });
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  toast(`Imported ${imported}, skipped ${skipped}`);
  $('eventFile').value=''; $('eventsPreview').innerHTML=''; eventsPreviewRows = [];
});

/* render events */
function renderEvents(){
  const tbody = $('eventsTable');
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No events</td></tr>'; return; }
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.events.forEach(ev=>{
    const participated = CACHE.participations.some(p => String(p.eventId) === String(ev.id) && String(p.status||'').toLowerCase()==='approved');
    const rowClass = participated ? 'participated-row' : '';
    html += `<tr class="${rowClass}" data-key="${ev.id}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.type)}</td><td>${escapeHtml(ev.level||'General')}</td><td>${escapeHtml((ev.description||'').slice(0,120))}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-event" data-key="${ev.id}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-event" data-key="${ev.id}">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}

/* event actions (edit/delete) */
$('eventsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-event')){
    if(!confirm('Delete event?')) return;
    const dbKey = KEYMAP.events[id] || id;
    if(dbKey) await remove(ref(db, `events/${dbKey}`));
    toast('Event removed');
  } else if(btn.classList.contains('btn-edit-event')){
    const dbKey = KEYMAP.events[id] || id;
    const snap = await get(ref(db, `events/${dbKey}`));
    const ev = snap.val();
    if(!ev) return toast('Event not found','danger');
    $('editEventId').value = dbKey;
    $('editEventName').value = ev.name || '';
    $('editEventType').value = ev.type || 'Non-Stage';
    $('editEventLevel').value = ev.level || 'General';
    $('editEventDesc').value = ev.description || '';
    new bootstrap.Modal(document.getElementById('editEventModal')).show();
  }
});
$('editEventForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = $('editEventId').value;
  if(!dbKey) return toast('Missing event key','danger');
  const name = $('editEventName').value.trim();
  const type = $('editEventType').value;
  const level = $('editEventLevel').value;
  const desc = $('editEventDesc').value.trim();
  if(!name) return toast('Name required','danger');
  // ensure unique name (excluding current)
  const other = CACHE.events.find(e => String(e.name||'').trim().toLowerCase() === name.toLowerCase() && KEYMAP.events[e.id] !== dbKey);
  if(other) return toast('Event name exists','danger');
  await update(ref(db, `${dbKey.startsWith('events')? dbKey : 'events/'+dbKey}`), {}); // try to normalize (some keys may be raw ids)
  // safer update using path: if dbKey is actual firebase key (contains % etc) we stored KEYMAP mapping differently; simpler: directly update dbKey path if it exists
  // Try to update using full key:
  await update(ref(db, `events/${dbKey}`), { name, type, level, description: desc });
  toast('Event updated');
  bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
});

/* ---------------------------
   ATTENDANCE
   --------------------------- */
let attendanceToggleState = 'none';
let editingAttendanceDbKey = null;

$('attMethod').addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));
$('loadAttendance').addEventListener('click', ()=> {
  const method = $('attMethod').value;
  const teamId = $('attTeam').value;
  let list = [];
  if(method === 'all') list = CACHE.students.slice();
  else list = CACHE.students.filter(s => String(s.teamId) === String(teamId));
  const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
  // group by team: create separate small container for each team if method=all
  if(method === 'all'){
    const teamsMap = {};
    CACHE.teams.forEach(t => teamsMap[t.id] = t.name);
    // group students by teamId
    const byTeam = {};
    list.forEach(s => {
      const tid = s.teamId || '__unassigned';
      if(!byTeam[tid]) byTeam[tid] = [];
      byTeam[tid].push(s);
    });
    Object.keys(byTeam).forEach(tid => {
      const groupTitle = document.createElement('div');
      groupTitle.innerHTML = `<div style="font-weight:700;margin:8px 0">${escapeHtml(teamsMap[tid]||'Unassigned')}</div>`;
      wrap.appendChild(groupTitle);
      const groupBox = document.createElement('div');
      groupBox.style.marginBottom = '12px';
      byTeam[tid].forEach(s => {
        const div = document.createElement('div');
        div.className = 'small-box';
        div.dataset.key = encodeKey(s.id);
        div.dataset.name = s.name || '';
        div.textContent = s.id;
        div.title = s.name || '';
        div.addEventListener('click', ()=> toggleAttendanceBox(div));
        groupBox.appendChild(div);
      });
      wrap.appendChild(groupBox);
    });
  } else {
    list.forEach(s => {
      const div = document.createElement('div');
      div.className = 'small-box';
      div.dataset.key = encodeKey(s.id);
      div.dataset.name = s.name || '';
      div.textContent = s.id;
      div.title = s.name || '';
      div.addEventListener('click', ()=> toggleAttendanceBox(div));
      wrap.appendChild(div);
    });
  }
  // init: make all absent by default (red)
  Array.from(wrap.querySelectorAll('.small-box')).forEach(b => { b.classList.remove('present'); b.classList.add('absent'); });
  $('attendanceMarkCard').style.display = list.length ? 'block' : 'none';
  attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Set All Present';
  editingAttendanceDbKey = null;
});

function toggleAttendanceBox(el){
  if(el.classList.contains('present')){ el.classList.remove('present'); el.classList.add('absent'); }
  else if(el.classList.contains('absent')){ el.classList.remove('absent'); el.classList.add('present'); }
  else el.classList.add('present');
}
$('toggleAll').addEventListener('click', ()=>{
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return;
  if(attendanceToggleState === 'none' || attendanceToggleState === 'absent'){
    boxes.forEach(b => { b.classList.remove('absent'); b.classList.add('present'); });
    attendanceToggleState = 'present'; $('toggleAll').textContent = 'Set All Absent';
  } else {
    boxes.forEach(b => { b.classList.remove('present'); b.classList.add('absent'); });
    attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Set All Present';
  }
});

$('saveAttendance').addEventListener('click', async ()=>{
  const date = $('attDate').value;
  const time = $('attTime').value || '';
  if(!date) return toast('Select date','danger');
  const desc = $('attDesc').value || '';
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return toast('Load students first','danger');
  const studentsObj = {};
  boxes.forEach(b=>{
    const id = decodeKey(b.dataset.key);
    if(b.classList.contains('present')) studentsObj[id] = 'Present';
    else studentsObj[id] = 'Absent';
  });
  const payload = { date, time, description: desc, students: studentsObj, savedAt: Date.now() };
  if(editingAttendanceDbKey){
    await set(ref(db, `attendance/${editingAttendanceDbKey}`), payload);
    toast('Attendance updated');
    editingAttendanceDbKey = null;
  } else {
    const p = push(ref(db, 'attendance'));
    await set(p, payload);
    toast('Attendance saved');
  }
  $('attendanceMarkCard').style.display = 'none';
});

/* attendance sessions list render & actions */
function renderAttendanceSessions(){
  const tbody = $('attendanceSessions');
  const att = CACHE.attendance || {};
  const rows = Object.entries(att);
  if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No sessions</td></tr>'; return; }
  rows.sort((a,b)=> (b[1].savedAt||0) - (a[1].savedAt||0));
  let html = '';
  rows.forEach(([k,v])=>{
    const count = v.students ? Object.keys(v.students).length : 0;
    html += `<tr data-db="${k}"><td>${escapeHtml(v.date||'')}</td><td>${escapeHtml(v.time||'')}</td><td>${escapeHtml(v.description||'')}</td><td>${count}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-view-att" data-db="${k}">View</button>
      <button class="btn btn-sm btn-outline-secondary btn-edit-att" data-db="${k}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-att" data-db="${k}">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}
$('attendanceSessions').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const dbKey = btn.dataset.db;
  const snap = await get(ref(db, `attendance/${dbKey}`));
  const s = snap.val();
  if(!s) return toast('Session not found','danger');
  if(btn.classList.contains('btn-view-att')){
    // show only absentees in modal
    const abs = [];
    if(s.students) for(const id in s.students) if(String(s.students[id]).toLowerCase() !== 'present') abs.push({ id, status: s.students[id] });
    const container = $('attendanceViewContent'); container.innerHTML = '';
    const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:700">Date: ${escapeHtml(s.date)} ${escapeHtml(s.time||'')}</div><div class="muted">${escapeHtml(s.description||'')}</div><hr>`;
    container.appendChild(title);
    if(!abs.length) container.innerHTML += '<div class="muted">No absentees — everyone present</div>';
    else {
      const ul = document.createElement('ol');
      abs.forEach(a => {
        const student = CACHE.students.find(st => String(st.id) === String(a.id));
        ul.innerHTML += `<li>${escapeHtml(student?student.name:a.id)} <span class="muted">(${escapeHtml(a.id)})</span></li>`;
      });
      container.appendChild(ul);
    }
    new bootstrap.Modal(document.getElementById('attendanceViewModal')).show();
    // setup pdf download button
    $('downloadAbsenteesPdf').onclick = () => {
      const el = container;
      html2pdf().from(el).set({ margin:10, filename:`absentees_${s.date}.pdf` }).save();
    };
  } else if(btn.classList.contains('btn-edit-att')){
    editingAttendanceDbKey = dbKey;
    $('attDate').value = s.date || '';
    $('attTime').value = s.time || '';
    $('attDesc').value = s.description || '';
    const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
    CACHE.students.forEach(st => {
      const status = (s.students && s.students[st.id]) ? s.students[st.id] : 'Absent';
      const div = document.createElement('div');
      div.className = 'small-box ' + (status==='Present' ? 'present' : 'absent');
      div.dataset.key = encodeKey(st.id);
      div.dataset.name = st.name || '';
      div.textContent = st.id;
      div.addEventListener('click', ()=> toggleAttendanceBox(div));
      wrap.appendChild(div);
    });
    $('attendanceMarkCard').style.display = 'block';
    toast('Loaded session for edit — change and Save');
  } else if(btn.classList.contains('btn-delete-att')){
    if(!confirm('Delete this attendance session?')) return;
    await remove(ref(db, `attendance/${dbKey}`));
    toast('Session removed');
  }
});

/* ---------------------------
   APPROVALS (participations)
   --------------------------- */

/* Helper: leader will submit participations under /participations with status 'pending' — admin approves/rejects here */
function renderApprovals(){
  const tbody = $('approvalsTable');
  const q = ($('searchApprovals')?.value||'').trim().toLowerCase();
  const parts = CACHE.participations || [];
  const rows = [];
  parts.forEach(p=>{
    if(String(p.status).toLowerCase() !== 'pending') return;
    const ev = CACHE.events.find(e=> String(e.id)===String(p.eventId)) || {};
    const student = CACHE.students.find(s => String(s.id)===String(p.studentId)) || { name: p.studentId };
    const team = CACHE.teams.find(t => String(t.id)===String(p.teamId)) || {};
    const text = `${ev.name||''} ${student.name||''} ${team.name||''}`.toLowerCase();
    if(q && !text.includes(q)) return;
    rows.push(`<tr data-key="${p.id}"><td>${escapeHtml(ev.name||p.eventId)}</td><td>${escapeHtml(student.name||p.studentId)}</td><td>${escapeHtml(team.name||p.teamId)}</td><td>${new Date(p.submittedAt||0).toLocaleString()}</td><td class="text-end"><button class="btn btn-sm btn-success btn-approve" data-key="${p.id}">Approve</button> <button class="btn btn-sm btn-danger btn-reject" data-key="${p.id}">Reject</button></td></tr>`);
  });
  tbody.innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No pending participations</td></tr>';
}
$('approvalsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const key = btn.dataset.key;
  const dbKey = KEYMAP.participations[key] || key;
  if(btn.classList.contains('btn-approve')){
    await update(ref(db, `participations/${dbKey}`), { status: 'approved', approvedAt: Date.now() });
    toast('Approved');
    // optionally auto-add to approved list (we already set status)
  } else if(btn.classList.contains('btn-reject')){
    await update(ref(db, `participations/${dbKey}`), { status: 'rejected', rejectedAt: Date.now() });
    toast('Rejected');
  }
});

/* ---------------------------
   RESULTS
   --------------------------- */

/* Load participants for selected event into result selectors (only approved) */
$('resultEvent').addEventListener('change', ()=> {
  // nothing automatic here; user will choose position and save
});
$('refreshParticipants')?.addEventListener('click', ()=> {
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  const participants = CACHE.participations.filter(p => String(p.eventId) === String(ev) && String(p.status||'').toLowerCase()==='approved');
  const map = {}; CACHE.students.forEach(s => map[s.id] = s.name);
  const choices = participants.map(p => ({ id: p.studentId, name: map[p.studentId] || p.studentId }));
  ['resFirst','resSecond','resThird'].forEach(id => {
    const sel = $(id);
    if(!sel) return;
    sel.innerHTML = '<option value="">Select</option>';
    choices.forEach(c=> sel.innerHTML += `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.id)})</option>`);
  });
});

/* Save result (supports giving a single position at a time) */
$('saveResult')?.addEventListener('click', async ()=>{
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  const pos = $('resultPosition').value; if(!pos) return toast('Select position','danger');
  const pts = Number($('resultPoints').value) || 0;
  // need selected student for given position: we'll expect leader submitted participants and admin loaded appropriate select controls in UI (Part2 had a simple position flow)
  // To keep flexible: fetch approved participants and if only one participant exists, assign them. Otherwise user must choose via resFirst/resSecond/resThird flow (handled via refreshParticipants)
  // For simplicity if pos==1 try to read resFirst; if not present, prompt.
  let studentId = '';
  if(pos === '1') studentId = $('resFirst') ? $('resFirst').value : '';
  if(pos === '2') studentId = $('resSecond') ? $('resSecond').value : '';
  if(pos === '3') studentId = $('resThird') ? $('resThird').value : '';
  if(!studentId) return toast('Choose participant for this position','danger');
  const p = push(ref(db, 'results'));
  const id = Date.now().toString() + Math.floor(Math.random()*9999);
  const payload = { id, eventId: ev, position: Number(pos), studentId, points: pts, published: false, createdAt: Date.now() };
  await set(p, payload);
  toast('Result saved (draft). Use the table to publish.');
});

/* render results list — group by event and positions */
function renderResults(){
  const tbody = $('resultsTable');
  if(!CACHE.results.length){ tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No results</td></tr>'; return; }
  // create grouped view: list events & their positions
  // simpler: show most recent results rows
  CACHE.results.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  let html='';
  CACHE.results.forEach(r=>{
    const ev = CACHE.events.find(e => String(e.id)===String(r.eventId));
    const student = CACHE.students.find(s => String(s.id)===String(r.studentId)) || { name: r.studentId };
    const pub = r.published ? '<span class="badge bg-success">Published</span>' : '<span class="badge bg-secondary">Draft</span>';
    html += `<tr data-key="${r.id}"><td>${escapeHtml(ev?ev.name:'Unknown')}</td><td>${r.position===1?escapeHtml(student.name):''}</td><td>${r.position===2?escapeHtml(student.name):''}</td><td>${r.position===3?escapeHtml(student.name):''}</td><td>${pub}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-result" data-key="${r.id}">Edit</button>
      <button class="btn btn-sm btn-outline-secondary btn-toggle-publish" data-key="${r.id}">${r.published? 'Unpublish' : 'Publish'}</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-result" data-key="${r.id}">Delete</button>
    </td></tr>`;
  });
  tbody.innerHTML = html;
}

/* result table actions */
$('resultsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.key;
  const dbKey = KEYMAP.results[id] || id;
  if(btn.classList.contains('btn-toggle-publish')){
    const snap = await get(ref(db, `results/${dbKey}`)); const r = snap.val(); if(!r) return toast('Result not found','danger');
    const newVal = !r.published;
    await update(ref(db, `results/${dbKey}`), { published: newVal, publishedAt: newVal?Date.now():null });
    toast(newVal ? 'Published' : 'Unpublished');
    // update team scores when published: add points to student's team
    if(newVal){
      const stud = CACHE.students.find(s => String(s.id) === String(r.studentId));
      if(stud && stud.teamId){
        const team = CACHE.teams.find(t => String(t.id) === String(stud.teamId));
        if(team){
          const dbTeamKey = KEYMAP.teams[team.id];
          const newScore = (Number(team.score)||0) + (Number(r.points)||0);
          await update(ref(db, `teams/${dbTeamKey}`), { score: newScore });
        }
      }
    }
  } else if(btn.classList.contains('btn-edit-result')){
    // open edit modal with result data
    const snap = await get(ref(db, `results/${dbKey}`)); const r = snap.val(); if(!r) return toast('Result not found','danger');
    const ev = CACHE.events.find(e => String(e.id)===String(r.eventId));
    $('editResultEventName').value = ev?ev.name:'';
    // populate selects with participants
    const participants = CACHE.participations.filter(p => String(p.eventId) === String(r.eventId) && String(p.status||'').toLowerCase()==='approved');
    ['editResFirst','editResSecond','editResThird'].forEach(selId => {
      const sel = $(selId); sel.innerHTML = '<option value="">Select</option>';
      participants.forEach(p => { const name = (CACHE.students.find(s => String(s.id)===String(p.studentId))||{name:p.studentId}).name; sel.innerHTML += `<option value="${escapeHtml(p.studentId)}">${escapeHtml(name)} (${escapeHtml(p.studentId)})</option>`; });
    });
    $('editPtsFirst').value = r.position===1 ? (r.points||0) : 0;
    $('editPtsSecond').value = r.position===2 ? (r.points||0) : 0;
    $('editPtsThird').value = r.position===3 ? (r.points||0) : 0;
    // select correct position
    if(r.position===1) $('editResFirst').value = r.studentId;
    if(r.position===2) $('editResSecond').value = r.studentId;
    if(r.position===3) $('editResThird').value = r.studentId;
    // store edit id on modal
    document.getElementById('editResultForm').dataset.editKey = dbKey;
    new bootstrap.Modal(document.getElementById('editResultModal')).show();
  } else if(btn.classList.contains('btn-delete-result')){
    if(!confirm('Delete result?')) return;
    await remove(ref(db, `results/${dbKey}`));
    toast('Result deleted');
  }
});

/* edit result modal save/delete */
$('editResultForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = document.getElementById('editResultForm').dataset.editKey;
  if(!dbKey) return toast('Missing result key','danger');
  // determine which position has a student selected
  const first = $('editResFirst').value || '';
  const second = $('editResSecond').value || '';
  const third = $('editResThird').value || '';
  // prioritize the non-empty one matching previous position — we will update the stored result item (which stores position+student+points)
  const curSnap = await get(ref(db, `results/${dbKey}`)); const cur = curSnap.val(); if(!cur) return toast('Result not found','danger');
  let upd = {};
  if(cur.position === 1){ upd.studentId = first; upd.points = Number($('editPtsFirst').value) || 0; }
  else if(cur.position === 2){ upd.studentId = second; upd.points = Number($('editPtsSecond').value) || 0; }
  else if(cur.position === 3){ upd.studentId = third; upd.points = Number($('editPtsThird').value) || 0; }
  await update(ref(db, `results/${dbKey}`), upd);
  toast('Result updated');
  bootstrap.Modal.getInstance(document.getElementById('editResultModal')).hide();
});
$('deleteResultBtn').addEventListener('click', async ()=>{
  const dbKey = document.getElementById('editResultForm').dataset.editKey;
  if(!dbKey) return toast('Missing result key','danger');
  if(!confirm('Delete this result?')) return;
  await remove(ref(db, `results/${dbKey}`));
  toast('Deleted');
  bootstrap.Modal.getInstance(document.getElementById('editResultModal')).hide();
});

/* ---------------------------
   REPORTS (team attendance & live score)
   --------------------------- */
function renderReports(){
  const tbody = $('reportsTable');
  const teams = CACHE.teams || [];
  if(!teams.length){ tbody.innerHTML = '<tr><td colspan="3" class="text-center muted">No data</td></tr>'; return; }
  let html='';
  teams.forEach(t=>{
    const members = CACHE.students.filter(s => String(s.teamId) === String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const score = Number(t.score)||0;
    html += `<tr><td>${escapeHtml(t.name)}${t.locked? ' <span class="badge bg-danger">Locked</span>':''}</td><td>${members}</td><td>${pct}% — <small class="muted">Score: ${score}</small></td></tr>`;
  });
  tbody.innerHTML = html;
}

/* ---------------------------
   POPULATE DROPDOWNS & MISC
   --------------------------- */
function populateDropdowns(){
  const manualTeam = $('manualTeam'); if(manualTeam){ manualTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t => manualTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const teamLeader = $('teamLeader'); if(teamLeader){ teamLeader.innerHTML = '<option value="">Choose leader (Chess #)</option>'; CACHE.students.forEach(s => teamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const attTeam = $('attTeam'); if(attTeam){ attTeam.innerHTML = '<option value="">Select team</option>'; CACHE.teams.forEach(t=> attTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeam = $('editTeam'); if(editTeam){ editTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> editTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeamLeader = $('editTeamLeader'); if(editTeamLeader){ editTeamLeader.innerHTML = '<option value="">Select leader</option>'; CACHE.students.forEach(s => editTeamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const resEv = $('resultEvent'); if(resEv){ resEv.innerHTML = '<option value="">Select event</option>'; CACHE.events.forEach(e => resEv.innerHTML += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`); }
}

/* ---------------------------
   SEARCH handlers
   --------------------------- */
$('searchStudents')?.addEventListener('input', ()=> renderStudents());
$('searchApprovals')?.addEventListener('input', ()=> renderApprovals());

/* ---------------------------
   PDF Exports
   --------------------------- */
function downloadHtmlAsPdf(elementOrHtml, filename='export.pdf'){
  if(typeof elementOrHtml === 'string'){
    const wrapper = document.createElement('div'); wrapper.innerHTML = elementOrHtml;
    html2pdf().from(wrapper).set({ margin:10, filename }).save();
  } else {
    html2pdf().from(elementOrHtml).set({ margin:10, filename }).save();
  }
}

/* example: download students list as pdf */
function generateStudentsPdf(){
  let html = `<h3>Students</h3><table><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>`;
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
  CACHE.students.forEach(s => html += `<tr><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'')}</td><td>${escapeHtml(teamMap[s.teamId]||'Unassigned')}</td></tr>`);
  html += '</tbody></table>';
  downloadHtmlAsPdf(html, `students_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* example: events pdf (approved participants per event) */
function generateApprovedPdfForEvent(evId){
  // build text with event name and approved participants
  const ev = CACHE.events.find(e => String(e.id) === String(evId));
  const approved = CACHE.participations.filter(p => String(p.eventId) === String(evId) && String(p.status||'').toLowerCase()==='approved');
  let html = `<h3>${escapeHtml(ev?ev.name:'Event')}</h3>`;
  html += `<div>Participants (approved):</div><ol>`;
  approved.forEach(p => {
    const s = CACHE.students.find(st => String(st.id) === String(p.studentId));
    html += `<li>${escapeHtml(s? s.name : p.studentId)} ${s ? `(${escapeHtml(s.id)})` : ''}</li>`;
  });
  html += `</ol>`;
  downloadHtmlAsPdf(html, `${(ev?ev.name:'event')}_approved.pdf`);
}

/* Hook optional buttons: you may add dedicated buttons to trigger PDF exports; below examples if you want quick saving */
window.generateStudentsPdf = generateStudentsPdf;
window.generateApprovedPdfForEvent = generateApprovedPdfForEvent;

/* ---------------------------
   INITIAL render
   --------------------------- */
setTimeout(()=> renderAll(), 300);

/* ---------------------------
   Final: small safety fixes
   --------------------------- */
console.log('Admin script loaded — Firebase connections active');

</script>
</body>
</html>