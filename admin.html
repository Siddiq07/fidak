<!-- PART 1: HEAD + TOP NAV + BASE LAYOUT -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Art Fest (Updated)</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- xlsx + html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg: #f6f9ff;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-2: #7c3aed;
      --success: #10b981;
      --danger: #ef4444;
      --glass: rgba(255,255,255,0.7);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#0f172a;background:var(--bg)}

    /* top nav */
    .top-nav{background:linear-gradient(180deg, #ffffff, #fbfdff);border-bottom:1px solid rgba(12,20,60,0.04);backdrop-filter: blur(4px)}
    .brand{font-weight:800;color:var(--accent);font-size:19px}
    .nav-btn{border-radius:10px;padding:8px 12px}
    .nav-btn.active{box-shadow: inset 0 -3px 0 rgba(37,99,235,0.14);}

    /* layout */
    .container-wide{max-width:1200px;margin:18px auto;padding:0 12px}
    main{margin-top:0;padding-top:14px}

    /* cards */
    .card-neo{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(12,20,60,0.04);margin-bottom:16px}
    .section-title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}

    /* small-box for attendance / selection */
    .small-box{width:64px;height:46px;border-radius:8px;background:#f1f5ff;display:inline-flex;align-items:center;justify-content:center;margin:6px;cursor:pointer;font-weight:700;flex-direction:column;padding:6px}
    .small-box .chess{font-size:14px}
    .small-box .name{font-size:11px;color:var(--muted);margin-top:4px}
    .small-box.selected{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
    .small-box.present{background:var(--success);color:#fff}
    .small-box.absent{background:var(--danger);color:#fff}
    .small-box:hover{transform:translateY(-3px);transition:all .12s ease}

    /* participated highlight */
    .participated-row{background:#f0fff6 !important}

    /* compact table buttons */
    .table .btn{padding:6px 10px;font-size:13px;border-radius:8px}

    /* results event card */
    .event-row{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;border:1px solid rgba(12,20,60,0.04);margin-bottom:10px}
    .event-meta{flex:1}
    .event-actions{min-width:280px;text-align:right}

    /* responsive */
    @media (max-width:900px){
      .container-wide{padding:0 10px}
      .small-box{width:48px;height:44px;font-size:12px}
      .event-actions{min-width:120px;text-align:left}
    }

    /* search inputs */
    .form-control, .form-select {border-radius:10px;padding:10px}

    /* buttons */
    .btn-accent{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:0;border-radius:10px;padding:8px 14px}
    .muted-small{color:var(--muted);font-size:13px}

    /* pdf badge */
    .badge-draft{background:#e6eefc;color:#0b3a8c}
    .badge-pub{background:#e8fff0;color:#064e3b}

    /* compact helper */
    .small-muted {font-size:13px;color:var(--muted)}
  </style>
</head>
<body>

<!-- TOP NAV -->
<nav class="top-nav">
  <div class="container container-wide d-flex align-items-center justify-content-between py-2">
    <div class="d-flex align-items-center gap-3">
      <div class="brand d-flex align-items-center gap-2"><span class="badge bg-primary rounded-pill"><i class="bi bi-palette-fill"></i></span> Art Fest Admin</div>
      <div class="d-none d-md-flex align-items-center muted" style="font-size:14px">Manage Students · Teams · Events · Attendance · Results · Reports</div>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <div class="d-none d-md-block muted">Year <span id="current-year"></span></div>
      <button id="logoutBtn" class="btn btn-outline-danger nav-btn"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
  </div>

  <!-- second-row navigation (tabs) -->
  <div class="container container-wide d-flex gap-2 py-2">
    <button class="btn btn-light nav-btn active" data-target="#panel-students">Students</button>
    <button class="btn btn-light nav-btn" data-target="#panel-teams">Teams</button>
    <button class="btn btn-light nav-btn" data-target="#panel-events">Events</button>
    <button class="btn btn-light nav-btn" data-target="#panel-attendance">Attendance</button>
    <button class="btn btn-light nav-btn" data-target="#panel-results">Results</button>
    <button class="btn btn-light nav-btn" data-target="#panel-reports">Reports</button>
  </div>
</nav>

<main class="container container-wide">
  <!-- search / quick row -->
  <div class="d-flex flex-column flex-md-row gap-2 justify-content-between mb-3">
    <div class="d-flex gap-2 flex-grow-1">
      <input id="globalSearch" class="form-control" placeholder="Global search (students, teams, events) — press Enter to run">
      <button id="globalSearchBtn" class="btn btn-outline-secondary">Search</button>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <button id="openStudentsBtn" class="btn btn-accent">Open Students</button>
      <button id="openEventsBtn" class="btn btn-outline-secondary">Open Events</button>
    </div>
  </div>

  <div id="panels-wrapper"></div>

  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>
</main>
<!-- PART 2: PANELS (STUDENTS / TEAMS / EVENTS / ATTENDANCE) -->
<div id="panels" class="mt-2">

  <!-- STUDENTS -->
  <section id="panel-students" class="card-neo">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card-neo">
          <div class="section-title">Import Students (Excel)</div>
          <div class="muted mb-2">Columns: Chess, Name, Level (Senior/Junior), Team (optional)</div>
          <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
          <div class="d-flex gap-2 mb-2">
            <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
            <button id="importStudents" class="btn btn-accent">Import</button>
          </div>
          <hr>
          <div class="section-title">Add Student Manually</div>
          <input id="manualChess" class="form-control mb-2" placeholder="Chess ID (alphanumeric)">
          <input id="manualName" class="form-control mb-2" placeholder="Full Name">
          <select id="manualLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
          <select id="manualTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
          <button id="addManualStudent" class="btn btn-success w-100">Add Student</button>
          <hr>
          <div class="section-title">Preview</div>
          <div id="studentsPreview" style="max-height:260px;overflow:auto"></div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card-neo">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">All Students</div>
            <div class="d-flex gap-2">
              <input id="searchStudents" class="form-control" placeholder="Search name or chess #">
              <button id="downloadStudentsPdf" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-pdf"></i></button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Chess #</th><th>Name</th><th>Level</th><th>Team</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="studentsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEAMS -->
  <section id="panel-teams" class="card-neo d-none">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card-neo">
          <div class="section-title">Create Team</div>
          <input id="teamName" class="form-control mb-2" placeholder="Team Name">
          <select id="teamLeader" class="form-select mb-2"><option value="">Choose leader (Chess #)</option></select>
          <input id="teamPassword" class="form-control mb-2" placeholder="Password (optional)">
          <div class="d-flex gap-2">
            <button id="saveTeam" class="btn btn-success">Save Team</button>
            <button id="clearTeam" class="btn btn-outline-secondary">Clear</button>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card-neo">
          <div class="section-title">Teams & Quick Stats</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Score</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="teamsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- EVENTS -->
  <section id="panel-events" class="card-neo d-none">
    <div class="row g-3">
      <div class="col-lg-4">
        <div class="card-neo mb-3">
          <div class="section-title">Add Event</div>
          <input id="eventName" class="form-control mb-2" placeholder="Event Name">
          <select id="eventType" class="form-select mb-2">
            <option>Stage</option><option>Off-Stage</option><option>Group</option><option>Open</option><option>Special</option>
          </select>
          <select id="eventLevel" class="form-select mb-2">
            <option>Senior</option><option>Junior</option><option>Open</option><option>Special</option>
          </select>
          <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Description / rules"></textarea>
          <div class="d-flex gap-2"><button id="saveEvent" class="btn btn-warning">Save Event</button><button id="downloadEventsPdf" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-pdf"></i></button></div>
        </div>

        <div class="card-neo">
          <div class="section-title">Import Events (Excel)</div>
          <div class="muted mb-2">If same name but different Type/Level, it will be saved as distinct event</div>
          <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
          <div class="d-flex gap-2"><button id="previewEvents" class="btn btn-outline-primary">Preview</button><button id="importEvents" class="btn btn-accent">Import</button></div>
          <div class="mt-2 d-flex gap-2">
            <select id="filterEventType" class="form-select"><option value="">All Types</option><option>Stage</option><option>Off-Stage</option><option>Group</option><option>Open</option><option>Special</option></select>
            <select id="filterEventLevel" class="form-select"><option value="">All Levels</option><option>Junior</option><option>Senior</option><option>Open</option><option>Special</option></select>
            <button id="filterEventsBtn" class="btn btn-outline-secondary">Search</button>
          </div>
          <div id="eventsPreview" style="max-height:220px;overflow:auto" class="mt-2"></div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card-neo">
          <div class="section-title">Events List</div>
          <div class="muted-small mb-2">Light rows indicate event has results uploaded</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Level</th><th>Description</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="eventsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ATTENDANCE -->
  <section id="panel-attendance" class="card-neo d-none">
    <div class="card-neo mb-3">
      <div class="row g-2 align-items-center">
        <div class="col-md-2"><input id="attDate" type="date" class="form-control"></div>
        <div class="col-md-2"><input id="attTime" type="time" class="form-control"></div>
        <div class="col-md-4"><input id="attDesc" class="form-control" placeholder="Description"></div>
        <div class="col-md-2"><select id="attMethod" class="form-select"><option value="all">All</option><option value="team">By Team</option></select></div>
        <div class="col-md-2 d-none" id="attTeamWrap"><select id="attTeam" class="form-select"></select></div>
      </div>
      <div class="mt-3 d-flex gap-2"><button id="loadAttendance" class="btn btn-info">Load Students</button><button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button><button id="saveAttendance" class="btn btn-success">Save Session</button></div>
    </div>

    <div id="attendanceMarkCard" class="card-neo" style="display:none">
      <div class="section-title">Mark Attendance</div>
      <div class="muted mb-2">Click a box to toggle Present/Absent. Hover to see name.</div>
      <div id="attendanceBoxes" style="padding:12px;display:flex;flex-direction:column;gap:8px"></div>
    </div>

    <div class="card-neo">
      <div class="section-title">Saved Sessions</div>
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light"><tr><th>Date</th><th>Time</th><th>Description</th><th>Count</th><th class="text-end">Actions</th></tr></thead>
          <tbody id="attendanceSessions"></tbody>
        </table>
      </div>
    </div>
  </section>

</div>
<!-- PART 3: MODALS / HIDDEN FIELDS -->
<!-- Hidden inputs for bookkeeping -->
<input type="hidden" id="editStudentDbKey">
<input type="hidden" id="editEventDbKey">
<input type="hidden" id="editResultDbKey">

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Student</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">Chess #</label>
        <input id="editChess" class="form-control mb-2" readonly>
        <label class="form-label">Name</label>
        <input id="editName" class="form-control mb-2" required>
        <label class="form-label">Level</label>
        <select id="editLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
        <label class="form-label">Team</label>
        <select id="editTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
      </div>
      <div class="modal-footer"><button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editEventForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Event</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">Event Name</label>
        <input id="editEventName" class="form-control mb-2" required>
        <label class="form-label">Type</label>
        <select id="editEventType" class="form-select mb-2"><option>Stage</option><option>Off-Stage</option><option>Group</option><option>Open</option><option>Special</option></select>
        <label class="form-label">Level</label>
        <select id="editEventLevel" class="form-select mb-2"><option>Junior</option><option>Senior</option><option>Open</option><option>Special</option></select>
        <label class="form-label">Description</label>
        <textarea id="editEventDesc" class="form-control mb-2" rows="4"></textarea>
      </div>
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Save Event</button></div>
    </form>
  </div>
</div>

<!-- Edit Result Modal (edit all positions for one event) -->
<div class="modal fade" id="editResultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editResultForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Results — <span id="editResultEventTitle"></span></h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">1st — student (chess#)</label>
            <select id="editResFirst" class="form-select mb-2"><option value="">Select</option></select>
            <input id="editPtsFirst" type="number" class="form-control" placeholder="Points (default 5)">
          </div>
          <div class="col-md-6">
            <label class="form-label">2nd — student (chess#)</label>
            <select id="editResSecond" class="form-select mb-2"><option value="">Select</option></select>
            <input id="editPtsSecond" type="number" class="form-control" placeholder="Points (default 3)">
          </div>
          <div class="col-md-6">
            <label class="form-label">3rd — student (chess#)</label>
            <select id="editResThird" class="form-select mb-2"><option value="">Select</option></select>
            <input id="editPtsThird" type="number" class="form-control" placeholder="Points (default 1)">
          </div>
        </div>
      </div>
      <div class="modal-footer"><button type="button" id="deleteResultBtn" class="btn btn-danger">Delete All</button><button type="submit" class="btn btn-primary">Save Draft</button></div>
    </form>
  </div>
</div>

<!-- Attendance view modal (absentees) -->
<div class="modal fade" id="attendanceViewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Attendance Absentees</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="attendanceViewContent"></div>
      </div>
      <div class="modal-footer">
        <button id="downloadAbsenteesPdf" class="btn btn-primary">Download PDF</button>
      </div>
    </div>
  </div>
</div>
<!-- PART 4: SCRIPT (Firebase + UI logic) -->
<script type="module">
/* Admin script: Realtime Firebase + UI actions
   - Events: new types & levels
   - Results: single event row with Edit / Delete / Publish (awards points on publish)
   - Live score updates
   - PDF exports
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* helpers */
const $ = id => document.getElementById(id);
function toast(msg, type='success'){
  const el=document.createElement('div'); el.className=`toast align-items-center text-bg-${type} border-0`; el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  $('toastRoot').appendChild(el); const t=new bootstrap.Toast(el,{delay:3500}); t.show(); el.addEventListener('hidden.bs.toast', ()=> el.remove());
}
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function encodeKey(k){ return encodeURIComponent(String(k)); }
function decodeKey(k){ return decodeURIComponent(String(k)); }

/* caches & keymaps */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, participations: {}, results: {} };

/* db refs */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');

/* realtime listeners */
onValue(studentsRef, snap => { const obj = snap.val() || {}; CACHE.students = Object.values(obj); KEYMAP.students = {}; Object.entries(obj).forEach(([k,v])=>{ if(v && v.id!==undefined) KEYMAP.students[String(v.id)] = k; }); renderAll(); });
onValue(teamsRef, snap => { const obj = snap.val() || {}; CACHE.teams = Object.values(obj); KEYMAP.teams = {}; Object.entries(obj).forEach(([k,v])=>{ if(v && v.id!==undefined) KEYMAP.teams[String(v.id)] = k; }); renderAll(); });
onValue(eventsRef, snap => { const obj = snap.val() || {}; CACHE.events = Object.values(obj); KEYMAP.events = {}; Object.entries(obj).forEach(([k,v])=>{ if(v && v.id!==undefined) KEYMAP.events[String(v.id)] = k; }); renderAll(); });
onValue(partsRef, snap => { const obj = snap.val() || {}; CACHE.participations = Object.values(obj); KEYMAP.participations = {}; Object.entries(obj).forEach(([k,v])=>{ if(v && v.id!==undefined) KEYMAP.participations[String(v.id)] = k; }); renderAll(); });
onValue(resultsRef, snap => { const obj = snap.val() || {}; CACHE.results = Object.values(obj); KEYMAP.results = {}; Object.entries(obj).forEach(([k,v])=>{ if(v && v.id!==undefined) KEYMAP.results[String(v.id)] = k; }); renderAll(); });
onValue(attendanceRef, snap => { CACHE.attendance = snap.val() || {}; renderAll(); });

/* nav tabs */
document.querySelectorAll('[data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
    const panel = document.querySelector(btn.dataset.target);
    if(panel) panel.classList.remove('d-none');
    document.querySelectorAll('.top-nav .nav-btn').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});
$('openStudentsBtn')?.addEventListener('click', ()=> document.querySelector('[data-target="#panel-students"]').click());
$('openEventsBtn')?.addEventListener('click', ()=> document.querySelector('[data-target="#panel-events"]').click());

$('logoutBtn').addEventListener('click', ()=> { sessionStorage.clear(); location.href='index.html'; });

/* renderAll orchestrator */
function renderAll(){
  populateDropdowns();
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceSessions();
  renderResultsList(); // new combined event row layout
  renderReports();
  computeLiveScores();
}

/* ---------- STUDENT FUNCTIONS (preview/import/manual) ---------- */
let studentsPreviewRows = [];
$('previewStudents').addEventListener('click', ()=> {
  const f = $('studentFile').files[0]; if(!f) return toast('Select Excel file','danger');
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' });
    studentsPreviewRows = json.slice(0,500);
    renderStudentsPreview();
  };
  r.readAsBinaryString(f);
});
function renderStudentsPreview(){
  const wrap = $('studentsPreview'); if(!studentsPreviewRows.length){ wrap.innerHTML = '<div class="muted">No preview</div>'; return;}
  let html = `<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>`;
  studentsPreviewRows.forEach(r => {
    const chess = (r['Chess']||r['Chess Number']||r['ID']||'').toString();
    const name = (r['Name']||r['name']||'').toString();
    const level = (r['Level']||r['level']||'Senior').toString();
    const team = (r['Team']||r['team']||'').toString();
    html += `<tr><td>${escapeHtml(chess)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(level)}</td><td>${escapeHtml(team)}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}
$('importStudents').addEventListener('click', async ()=>{
  if(!studentsPreviewRows.length) return toast('No preview','danger');
  const teamNameToId = {}; CACHE.teams.forEach(t => { if(t.name) teamNameToId[String(t.name).trim().toLowerCase()] = t.id; });
  const updates = {}; let imported=0, skipped=0;
  studentsPreviewRows.forEach(r => {
    const chessRaw = (r['Chess']||r['Chess Number']||r['ID']||'').toString().trim();
    const nameRaw = (r['Name']||r['name']||'').toString().trim();
    const levelRaw = (r['Level']||r['level']||'Senior').toString().trim();
    if(!chessRaw || !nameRaw){ skipped++; return; }
    const chess = chessRaw; const name = nameRaw;
    if(CACHE.students.some(s => String(s.id) === String(chess)) || CACHE.students.some(s => String(s.name||'').trim().toLowerCase() === String(name).trim().toLowerCase())){ skipped++; return; }
    const teamName = (r['Team']||r['team']||'').toString().trim();
    const teamId = teamName ? (teamNameToId[teamName.toLowerCase()] || null) : null;
    updates[`students/${encodeKey(chess)}`] = { id: chess, name, level: levelRaw||'Senior', teamId: teamId ? String(teamId) : null };
    imported++;
  });
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  studentsPreviewRows = []; $('studentsPreview').innerHTML=''; $('studentFile').value='';
  toast(`Imported ${imported}, skipped ${skipped}`);
});

/* manual add */
$('addManualStudent').addEventListener('click', async ()=>{
  const chess = $('manualChess').value.trim(); const name = $('manualName').value.trim(); const level = $('manualLevel').value||'Senior'; const teamId = $('manualTeam').value || null;
  if(!chess || !name) return toast('Enter chess & name','danger');
  if(CACHE.students.some(s=>String(s.id)===String(chess))) return toast('Chess already exists','danger');
  if(CACHE.students.some(s=>String(s.name||'').trim().toLowerCase()===String(name).trim().toLowerCase())) return toast('Name already exists','danger');
  await set(ref(db, `students/${encodeKey(chess)}`), { id: chess, name, level, teamId: teamId ? String(teamId) : null });
  $('manualChess').value=''; $('manualName').value=''; $('manualTeam').value='';
  toast('Student saved');
});

/* render students */
function renderStudents(){
  const tbody = $('studentsTable'); const q = ($('searchStudents')?.value||'').trim().toLowerCase();
  if(!CACHE.students.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No students</td></tr>'; return; }
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
  let html='';
  CACHE.students.forEach(s => {
    const team = s.teamId ? (teamMap[s.teamId] || 'Unknown') : 'Unassigned';
    const text = `${s.id} ${s.name} ${team}`.toLowerCase();
    if(q && !text.includes(q)) return;
    html += `<tr data-key="${encodeKey(s.id)}"><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'Senior')}</td><td>${escapeHtml(team)}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-student">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-student">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="5" class="text-center muted">No students</td></tr>';
}

/* student actions */
$('studentsTable').addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr'); if(!tr) return; const dbKey = tr.dataset.key;
  if(e.target.classList.contains('btn-delete-student')){ if(!confirm('Delete student?')) return; await remove(ref(db, `students/${dbKey}`)); toast('Student deleted'); }
  else if(e.target.classList.contains('btn-edit-student')){
    const snap = await get(ref(db, `students/${dbKey}`)); const s = snap.val(); if(!s) return toast('Not found','danger');
    $('editStudentDbKey').value = dbKey; $('editChess').value = s.id; $('editName').value = s.name||''; $('editLevel').value = s.level||'Senior';
    populateDropdowns(); setTimeout(()=> $('editTeam').value = s.teamId || '', 50);
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
  }
});

/* edit student save/delete */
$('editStudentForm').addEventListener('submit', async (ev)=>{ ev.preventDefault();
  const dbKey = $('editStudentDbKey').value; if(!dbKey) return toast('Missing key','danger');
  const newName = $('editName').value.trim(); const newLevel = $('editLevel').value||'Senior'; const newTeam = $('editTeam').value || null;
  if(!newName) return toast('Name required','danger');
  const curSnap = await get(ref(db, `students/${dbKey}`)); const cur = curSnap.val(); if(!cur) return toast('Not found','danger');
  if(String(newName).trim().toLowerCase() !== String(cur.name||'').trim().toLowerCase()){ if(CACHE.students.some(s=>String(s.id)!==String(cur.id) && String(s.name||'').trim().toLowerCase()===String(newName).trim().toLowerCase())) return toast('Name exists','danger'); }
  await update(ref(db, `students/${dbKey}`), { name: newName, level: newLevel, teamId: newTeam ? String(newTeam) : null });
  toast('Student updated'); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});
$('deleteStudentBtn').addEventListener('click', async ()=>{ if(!confirm('Delete?')) return; const dbKey = $('editStudentDbKey').value; await remove(ref(db, `students/${dbKey}`)); toast('Deleted'); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide(); });

/* ---------- TEAMS ---------- */
$('saveTeam').addEventListener('click', async () => {
  const name = $('teamName').value.trim(); const leader = $('teamLeader').value || null; const pwd = $('teamPassword').value.trim() || '';
  if(!name) return toast('Team name required','danger');
  const id = Date.now().toString(); const p = push(ref(db, 'teams'));
  await set(p, { id, name, leaderId: leader ? String(leader) : null, password: pwd, locked:false, score:0 });
  $('teamName').value=''; $('teamLeader').value=''; $('teamPassword').value=''; toast('Team saved');
});

/* compute members count helper */
function countTeamMembers(teamId){ return CACHE.students.filter(s => String(s.teamId) === String(teamId)).length; }

/* render teams */
function renderTeams(){
  const tbody = $('teamsTable');
  if(!CACHE.teams.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No teams</td></tr>'; return; }
  CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.teams.forEach(t => {
    const leader = CACHE.students.find(s => String(s.id) === String(t.leaderId));
    const members = countTeamMembers(t.id);
    html += `<tr data-key="${t.id}"><td>${escapeHtml(t.name)}</td><td>${leader?escapeHtml(leader.name+' ('+leader.id+')'):'-'}</td><td>${members}</td><td>${Number(t.score)||0}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-team" data-key="${t.id}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-team" data-key="${t.id}">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html;
}

/* teams table actions */
$('teamsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-team')){ if(!confirm('Delete team?')) return; const dbKey = KEYMAP.teams[id] || id; if(dbKey) await remove(ref(db, `teams/${dbKey}`)); const updates = {}; CACHE.students.filter(s => String(s.teamId) === String(id)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null); if(Object.keys(updates).length) await update(ref(db,'/'), updates); toast('Team deleted'); }
  else if(btn.classList.contains('btn-edit-team')){
    const dbKey = KEYMAP.teams[id] || id; const snap = await get(ref(db, `teams/${dbKey}`)); const t = snap.val(); if(!t) return toast('Team not found','danger');
    // show a simple prompt editing (or open a modal - for brevity use prompt)
    const newName = prompt('Team name', t.name || '') || '';
    if(!newName) return;
    await update(ref(db, `teams/${dbKey}`), { name: newName });
    toast('Team updated');
  }
});

/* ---------- EVENTS ---------- */
/* uniqueness key uses name+type+level */
function eventKey(name,type,level){ return `${String(name||'').trim().toLowerCase()}||${String(type||'').trim().toLowerCase()}||${String(level||'').trim().toLowerCase()}`; }

$('saveEvent').addEventListener('click', async ()=>{
  const name = $('eventName').value.trim(); const type = $('eventType').value; const level = $('eventLevel').value; const desc = $('eventDescription').value.trim();
  if(!name) return toast('Event name required','danger');
  if(CACHE.events.some(e => eventKey(e.name,e.type,e.level) === eventKey(name,type,level))) return toast('Event (same name+type+level) already exists','danger');
  const p = push(ref(db, 'events')); const id = Date.now().toString();
  await set(p, { id, name, type, level, description: desc, status:'Open', createdAt: Date.now() });
  $('eventName').value=''; $('eventDescription').value=''; toast('Event added');
});

/* preview/import events */
let eventsPreviewRows = [];
$('previewEvents').addEventListener('click', ()=> {
  const f = $('eventFile').files[0]; if(!f) return toast('Choose file','danger');
  const r = new FileReader(); r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' }); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    eventsPreviewRows = json;
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Level</th><th>Description</th></tr></thead><tbody>';
    json.forEach(rw => html += `<tr><td>${escapeHtml(rw['Name']||rw['Event']||'')}</td><td>${escapeHtml(rw['Type']||'')}</td><td>${escapeHtml(rw['Level']||'')}</td><td>${escapeHtml(rw['Description']||'')}</td></tr>`);
    html += '</tbody></table>'; $('eventsPreview').innerHTML = html;
  }; r.readAsBinaryString(f);
});
$('importEvents').addEventListener('click', async ()=> {
  if(!eventsPreviewRows.length) return toast('No preview','danger');
  const updates = {}; let imported=0, skipped=0;
  eventsPreviewRows.forEach(rw => {
    const name = (rw['Name']||rw['Event']||rw['name']||'').toString().trim(); if(!name){ skipped++; return; }
    const type = (rw['Type']||rw['type']||'Off-Stage').toString().trim(); const level = (rw['Level']||rw['level']||'Open').toString().trim();
    if(CACHE.events.some(ev => eventKey(ev.name,ev.type,ev.level) === eventKey(name,type,level))){ skipped++; return; }
    const desc = (rw['Description']||rw['description']||'').toString();
    const id = Date.now().toString() + Math.floor(Math.random()*9999);
    updates[`events/${id}`] = { id, name, type, level, description: desc, status:'Open', createdAt: Date.now() };
    imported++;
  });
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  eventsPreviewRows = []; $('eventFile').value=''; $('eventsPreview').innerHTML='';
  toast(`Imported ${imported}, skipped ${skipped}`);
});

/* event filters */
$('filterEventsBtn')?.addEventListener('click', ()=> renderEvents());

function renderEvents(){
  const tbody = $('eventsTable');
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No events</td></tr>'; return; }
  const filterType = $('filterEventType').value || ''; const filterLevel = $('filterEventLevel').value || '';
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.events.forEach(ev => {
    if(filterType && ev.type !== filterType) return;
    if(filterLevel && ev.level !== filterLevel) return;
    const participated = CACHE.participations.some(p => String(p.eventId) === String(ev.id) && String(p.status||'').toLowerCase()==='approved');
    const rowClass = participated ? 'participated-row' : '';
    html += `<tr class="${rowClass}" data-key="${ev.id}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.type)}</td><td>${escapeHtml(ev.level||'Open')}</td><td>${escapeHtml((ev.description||'').slice(0,120))}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-event" data-key="${ev.id}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-event" data-key="${ev.id}">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="5" class="text-center muted">No events match filters</td></tr>';
}

/* event actions (edit/delete) */
$('eventsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-event')){ if(!confirm('Delete event?')) return; const dbKey = KEYMAP.events[id] || id; if(dbKey) await remove(ref(db, `events/${dbKey}`)); toast('Event removed'); }
  else if(btn.classList.contains('btn-edit-event')){ const dbKey = KEYMAP.events[id] || id; const snap = await get(ref(db, `events/${dbKey}`)); const ev = snap.val(); if(!ev) return toast('Not found','danger'); $('editEventDbKey').value = dbKey; $('editEventName').value = ev.name||''; $('editEventType').value = ev.type||'Off-Stage'; $('editEventLevel').value = ev.level||'Open'; $('editEventDesc').value = ev.description||''; new bootstrap.Modal(document.getElementById('editEventModal')).show(); }
});
$('editEventForm').addEventListener('submit', async (ev)=>{ ev.preventDefault(); const dbKey = $('editEventDbKey').value; if(!dbKey) return toast('Missing key','danger'); const name = $('editEventName').value.trim(); const type = $('editEventType').value; const level = $('editEventLevel').value; const desc = $('editEventDesc').value.trim(); if(!name) return toast('Name required','danger');
  const other = CACHE.events.find(e => eventKey(e.name,e.type,e.level) === eventKey(name,type,level) && KEYMAP.events[e.id] !== dbKey);
  if(other) return toast('Event with same name+type+level exists','danger');
  await update(ref(db, `events/${dbKey}`), { name, type, level, description: desc });
  toast('Event updated'); bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
});

/* ---------- ATTENDANCE (same as earlier, preserved) ---------- */
let attendanceToggleState = 'none';
let editingAttendanceDbKey = null;

$('attMethod').addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));
$('loadAttendance').addEventListener('click', ()=> {
  const method = $('attMethod').value; const teamId = $('attTeam').value;
  let list = method === 'all' ? CACHE.students.slice() : CACHE.students.filter(s => String(s.teamId) === String(teamId));
  const wrap = $('attendanceBoxes'); wrap.innerHTML = '';

  if(method === 'all'){
    // group by team
    const teamsMap = {}; CACHE.teams.forEach(t => teamsMap[t.id] = t.name);
    const byTeam = {};
    list.forEach(s => { const tid = s.teamId || '__unassigned'; if(!byTeam[tid]) byTeam[tid] = []; byTeam[tid].push(s); });
    Object.keys(byTeam).forEach(tid => {
      const groupTitle = document.createElement('div'); groupTitle.innerHTML = `<div style="font-weight:700;margin:8px 0">${escapeHtml(teamsMap[tid]||'Unassigned')}</div>`; wrap.appendChild(groupTitle);
      const groupBox = document.createElement('div'); groupBox.style.display='flex'; groupBox.style.flexWrap='wrap';
      byTeam[tid].forEach(s => {
        const div = document.createElement('div'); div.className = 'small-box absent'; div.dataset.key = encodeKey(s.id); div.dataset.name = s.name || ''; div.title = s.name || ''; div.innerHTML = `<div class="chess">${escapeHtml(s.id)}</div><div class="name">${escapeHtml(s.name)}</div>`;
        div.addEventListener('click', ()=> toggleAttendanceBox(div));
        groupBox.appendChild(div);
      });
      wrap.appendChild(groupBox);
    });
  } else {
    // team only - single row of boxes
    list.forEach(s => {
      const div = document.createElement('div'); div.className = 'small-box absent'; div.dataset.key = encodeKey(s.id); div.dataset.name = s.name || ''; div.title = s.name || ''; div.innerHTML = `<div class="chess">${escapeHtml(s.id)}</div><div class="name">${escapeHtml(s.name)}</div>`;
      div.addEventListener('click', ()=> toggleAttendanceBox(div));
      wrap.appendChild(div);
    });
  }

  $('attendanceMarkCard').style.display = list.length ? 'block' : 'none';
  attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Set All Present';
  editingAttendanceDbKey = null;
});

function toggleAttendanceBox(el){
  if(el.classList.contains('present')){ el.classList.remove('present'); el.classList.add('absent'); }
  else if(el.classList.contains('absent')){ el.classList.remove('absent'); el.classList.add('present'); }
  else el.classList.add('present');
}
$('toggleAll').addEventListener('click', ()=> {
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box')); if(!boxes.length) return;
  if(attendanceToggleState === 'none' || attendanceToggleState === 'absent'){ boxes.forEach(b => { b.classList.remove('absent'); b.classList.add('present'); }); attendanceToggleState = 'present'; $('toggleAll').textContent = 'Set All Absent'; }
  else { boxes.forEach(b => { b.classList.remove('present'); b.classList.add('absent'); }); attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Set All Present'; }
});

$('saveAttendance').addEventListener('click', async ()=> {
  const date = $('attDate').value; const time = $('attTime').value || ''; if(!date) return toast('Select date','danger');
  const desc = $('attDesc').value || ''; const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return toast('Load students first','danger');
  const studentsObj = {}; boxes.forEach(b => { const id = decodeKey(b.dataset.key); studentsObj[id] = b.classList.contains('present') ? 'Present' : 'Absent'; });
  const payload = { date, time, description: desc, students: studentsObj, savedAt: Date.now() };
  if(editingAttendanceDbKey){ await set(ref(db, `attendance/${editingAttendanceDbKey}`), payload); toast('Attendance updated'); editingAttendanceDbKey = null; } else { const p = push(ref(db, 'attendance')); await set(p, payload); toast('Attendance saved'); }
  $('attendanceMarkCard').style.display = 'none';
});

/* attendance sessions render + view/edit/delete */
function renderAttendanceSessions(){
  const tbody = $('attendanceSessions'); const att = CACHE.attendance || {}; const rows = Object.entries(att);
  if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No sessions</td></tr>'; return; }
  rows.sort((a,b)=> (b[1].savedAt||0) - (a[1].savedAt||0));
  let html=''; rows.forEach(([k,v]) => { const count = v.students ? Object.keys(v.students).length : 0; html += `<tr data-db="${k}"><td>${escapeHtml(v.date||'')}</td><td>${escapeHtml(v.time||'')}</td><td>${escapeHtml(v.description||'')}</td><td>${count}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-view-att" data-db="${k}">View</button> <button class="btn btn-sm btn-outline-secondary btn-edit-att" data-db="${k}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-att" data-db="${k}">Delete</button></td></tr>`; });
  tbody.innerHTML = html;
}
$('attendanceSessions').addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return; const dbKey = btn.dataset.db;
  const snap = await get(ref(db, `attendance/${dbKey}`)); const s = snap.val(); if(!s) return toast('Session not found','danger');
  if(btn.classList.contains('btn-view-att')){
    const abs = []; if(s.students) for(const id in s.students) if(String(s.students[id]).toLowerCase() !== 'present') abs.push({ id, status: s.students[id] });
    const container = $('attendanceViewContent'); container.innerHTML = '';
    const title = document.createElement('div'); title.innerHTML = `<div style="font-weight:700">Date: ${escapeHtml(s.date)} ${escapeHtml(s.time||'')}</div><div class="muted">${escapeHtml(s.description||'')}</div><hr>`;
    container.appendChild(title);
    if(!abs.length) container.innerHTML += '<div class="muted">No absentees — all present</div>';
    else {
      const listWrap = document.createElement('div');
      abs.forEach(a => {
        const st = CACHE.students.find(st => String(st.id) === String(a.id));
        const row = document.createElement('div'); row.style.padding='6px 4px'; row.style.borderBottom='1px solid #f1f5ff'; row.innerHTML = `<div style="font-size:15px">${escapeHtml(st?st.name:a.id)} <span class="muted" style="font-size:13px">(${escapeHtml(a.id)})</span></div>`;
        listWrap.appendChild(row);
      });
      container.appendChild(listWrap);
    }
    new bootstrap.Modal(document.getElementById('attendanceViewModal')).show();
    $('downloadAbsenteesPdf').onclick = ()=> { html2pdf().from(container).set({margin:10,filename:`absentees_${s.date}.pdf`}).save(); };
  } else if(btn.classList.contains('btn-edit-att')){
    editingAttendanceDbKey = dbKey; $('attDate').value = s.date||''; $('attTime').value = s.time||''; $('attDesc').value = s.description||'';
    const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
    const teamsMap = {}; CACHE.teams.forEach(t => teamsMap[t.id] = t.name); const byTeam = {};
    CACHE.students.forEach(st => { const tid = st.teamId || '__unassigned'; if(!byTeam[tid]) byTeam[tid] = []; byTeam[tid].push(st); });
    Object.keys(byTeam).forEach(tid => {
      const groupTitle = document.createElement('div'); groupTitle.innerHTML = `<div style="font-weight:700;margin:8px 0">${escapeHtml(teamsMap[tid]||'Unassigned')}</div>`; wrap.appendChild(groupTitle);
      const groupBox = document.createElement('div'); groupBox.style.display='flex'; groupBox.style.flexWrap='wrap';
      byTeam[tid].forEach(st => {
        const status = (s.students && s.students[st.id]) ? s.students[st.id] : 'Absent';
        const div = document.createElement('div'); div.className = 'small-box ' + (status==='Present' ? 'present' : 'absent'); div.dataset.key = encodeKey(st.id); div.dataset.name = st.name || ''; div.innerHTML = `<div class="chess">${escapeHtml(st.id)}</div><div class="name">${escapeHtml(st.name)}</div>`;
        div.addEventListener('click', ()=> toggleAttendanceBox(div)); groupBox.appendChild(div);
      });
      wrap.appendChild(groupBox);
    });
    $('attendanceMarkCard').style.display = 'block'; toast('Loaded session for edit');
  } else if(btn.classList.contains('btn-delete-att')){
    if(!confirm('Delete session?')) return; await remove(ref(db, `attendance/${dbKey}`)); toast('Deleted');
  }
});

/* ---------- APPROVALS (kept lightweight) ---------- */
function renderApprovals(){
  const tbody = $('approvalsTable'); if(!tbody) return;
  const q = ($('searchApprovals')?.value||'').trim().toLowerCase(); const parts = CACHE.participations || [];
  const rows = [];
  parts.forEach(p => {
    if(String(p.status).toLowerCase() !== 'pending') return;
    const ev = CACHE.events.find(e => String(e.id) === String(p.eventId)) || {};
    const student = CACHE.students.find(s => String(s.id) === String(p.studentId)) || { name: p.studentId };
    const team = CACHE.teams.find(t => String(t.id) === String(p.teamId)) || {};
    const text = `${ev.name||''} ${student.name||''} ${team.name||''}`.toLowerCase();
    if(q && !text.includes(q)) return;
    rows.push(`<tr data-key="${p.id}"><td>${escapeHtml(ev.name||p.eventId)}</td><td>${escapeHtml(student.name||p.studentId)}</td><td>${escapeHtml(team.name||p.teamId)}</td><td>${new Date(p.submittedAt||0).toLocaleString()}</td><td class="text-end"><button class="btn btn-sm btn-success btn-approve" data-key="${p.id}">Approve</button> <button class="btn btn-sm btn-danger btn-reject" data-key="${p.id}">Reject</button></td></tr>`);
  });
  tbody.innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No pending participations</td></tr>';
}
document.addEventListener('click', async (e) => {
  if(e.target.matches('.btn-approve')) {
    const key = e.target.dataset.key; const dbKey = KEYMAP.participations[key] || key; await update(ref(db, `participations/${dbKey}`), { status:'approved', approvedAt: Date.now() }); toast('Approved'); renderApprovals();
  } else if(e.target.matches('.btn-reject')){
    const key = e.target.dataset.key; const dbKey = KEYMAP.participations[key] || key; await update(ref(db, `participations/${dbKey}`), { status:'rejected', rejectedAt: Date.now() }); toast('Rejected'); renderApprovals();
  }
});

/* ---------- RESULTS (NEW combined event row layout) ---------- */

/*
Structure:
- For each event show a single row (event-meta + 1/2/3 with chess & name & team & points)
- Buttons: Edit (open modal), Delete All results for event, Publish (publish all results for event)
- Publish will mark results' published=true and award team points (1st=5,2nd=3,3rd=1) only when publishing (if not already published)
- Admin can set points when creating/editing (defaults will be applied)
*/

// points default mapping
const DEFAULT_POINTS = { 1:5, 2:3, 3:1 };

function renderResultsList(){
  const containerId = 'resultsTable';
  // We'll render into a custom container: replace resultsTable element with rows
  const tbody = $('resultsTable');
  // Instead of table rows, we'll render event-row divs inside the same tbody container
  if(!tbody) return;
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No events</td></tr>'; return; }

  // Build event->positions map
  const evMap = {};
  CACHE.results.forEach(r => { if(!evMap[r.eventId]) evMap[r.eventId] = {}; evMap[r.eventId][r.position] = r; });

  // Build html
  let html = '';
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  CACHE.events.forEach(ev => {
    const pos = evMap[ev.id] || {};
    const first = pos[1] || null;
    const second = pos[2] || null;
    const third = pos[3] || null;
    const anyUploaded = !!first || !!second || !!third;
    const published = (first && first.published) || (second && second.published) || (third && third.published);
    const badge = published ? `<span class="badge badge-pub">Published</span>` : anyUploaded ? `<span class="badge badge-draft">Draft</span>` : '';
    // helper to present participant
    const present = (r) => {
      if(!r) return `<div class="small-muted">-</div>`;
      const student = CACHE.students.find(s=>String(s.id)===String(r.studentId)) || {name:r.studentId};
      const team = CACHE.teams.find(t=>String(t.id)===String(student.teamId)) || {name:''};
      return `<div style="font-weight:700">${escapeHtml(student.name)} <span class="small-muted">(${escapeHtml(student.id)})</span></div><div class="small-muted">${escapeHtml(team.name)} — ${Number(r.points)||0} pts</div>`;
    };
    html += `<tr class="${anyUploaded?'participated-row':''}" data-ev="${escapeHtml(ev.id)}">
      <td style="width:32%"><div style="font-weight:800">${escapeHtml(ev.name)}</div><div class="small-muted">${escapeHtml(ev.type)} • ${escapeHtml(ev.level)}</div></td>
      <td style="width:22%">${present(first)}</td>
      <td style="width:22%">${present(second)}</td>
      <td style="width:22%">${present(third)}</td>
      <td style="width:8%">${badge}</td>
      <td class="text-end">
         <div class="d-inline-block">
           <button class="btn btn-sm btn-outline-primary btn-edit-event-results" data-ev="${ev.id}"><i class="bi bi-pencil"></i> Edit</button>
           <button class="btn btn-sm btn-outline-danger btn-delete-event-results" data-ev="${ev.id}"><i class="bi bi-trash"></i> Delete</button>
           <button class="btn btn-sm btn-accent btn-publish-event-results" data-ev="${ev.id}">${published? 'Unpublish' : 'Publish'}</button>
         </div>
      </td>
    </tr>`;
  });

  tbody.innerHTML = html;
}

/* click handlers: edit / delete / publish */
document.addEventListener('click', async (e) => {
  const editBtn = e.target.closest('.btn-edit-event-results');
  const delBtn = e.target.closest('.btn-delete-event-results');
  const pubBtn = e.target.closest('.btn-publish-event-results');
  if(editBtn){
    const evId = editBtn.dataset.ev;
    await openEditResultsModal(evId);
  } else if(delBtn){
    const evId = delBtn.dataset.ev;
    if(!confirm('Delete all results for this event?')) return;
    // delete all results where eventId == evId
    const toRemove = CACHE.results.filter(r => String(r.eventId) === String(evId));
    for(const r of toRemove){ const dbKey = KEYMAP.results[r.id] || r.id; await remove(ref(db, `results/${dbKey}`)); }
    toast('All results removed for event');
  } else if(pubBtn){
    const evId = pubBtn.dataset.ev;
    await togglePublishEvent(evId);
  }
});

/* open modal to edit results for event: populate selects with approved participants for the event */
async function openEditResultsModal(evId){
  const ev = CACHE.events.find(e=>String(e.id)===String(evId));
  if(!ev) return toast('Event not found','danger');
  $('editResultEventTitle').textContent = ev.name;
  // get existing positions
  const posMap = {};
  CACHE.results.filter(r=>String(r.eventId)===String(evId)).forEach(r=> posMap[r.position] = r);
  // participants: use approved participations for that event
  const participants = CACHE.participations.filter(p => String(p.eventId) === String(evId) && String(p.status||'').toLowerCase()==='approved');
  const map = {};
  CACHE.students.forEach(s=> map[s.id] = s.name);
  // clear selects
  ['editResFirst','editResSecond','editResThird'].forEach(id=> $(id).innerHTML = `<option value="">Select</option>`);
  participants.forEach(p => {
    const label = `${escapeHtml(map[p.studentId]||p.studentId)} (${escapeHtml(p.studentId)})`;
    ['editResFirst','editResSecond','editResThird'].forEach(id => $(id).innerHTML += `<option value="${escapeHtml(p.studentId)}">${label}</option>`);
  });
  // set existing values if present
  if(posMap[1]) { $('editResFirst').value = posMap[1].studentId; $('editPtsFirst').value = posMap[1].points || DEFAULT_POINTS[1]; }
  else { $('editPtsFirst').value = DEFAULT_POINTS[1]; }
  if(posMap[2]) { $('editResSecond').value = posMap[2].studentId; $('editPtsSecond').value = posMap[2].points || DEFAULT_POINTS[2]; }
  else { $('editPtsSecond').value = DEFAULT_POINTS[2]; }
  if(posMap[3]) { $('editResThird').value = posMap[3].studentId; $('editPtsThird').value = posMap[3].points || DEFAULT_POINTS[3]; }
  else { $('editPtsThird').value = DEFAULT_POINTS[3]; }

  document.getElementById('editResultForm').dataset.eventId = evId;
  new bootstrap.Modal(document.getElementById('editResultModal')).show();
}

/* save edits to results (upsert three positions) */
$('editResultForm').addEventListener('submit', async (ev)=>{ ev.preventDefault();
  const eventId = ev.currentTarget.dataset.eventId;
  if(!eventId) return toast('Missing event','danger');
  const firstId = $('editResFirst').value || null; const fPts = Number($('editPtsFirst').value) || DEFAULT_POINTS[1];
  const secondId = $('editResSecond').value || null; const sPts = Number($('editPtsSecond').value) || DEFAULT_POINTS[2];
  const thirdId = $('editResThird').value || null; const tPts = Number($('editPtsThird').value) || DEFAULT_POINTS[3];

  // helper to upsert result position
  async function upsertPosition(position, studentId, points){
    // if studentId empty => remove existing position result
    const existing = CACHE.results.find(r => String(r.eventId) === String(eventId) && Number(r.position) === Number(position));
    if(!studentId){
      if(existing){ const dbKey = KEYMAP.results[existing.id] || existing.id; await remove(ref(db, `results/${dbKey}`)); }
      return;
    }
    if(existing){
      const dbKey = KEYMAP.results[existing.id] || existing.id;
      await update(ref(db, `results/${dbKey}`), { studentId, points, published: existing.published || false, updatedAt: Date.now() });
    } else {
      const p = push(ref(db, 'results')); const id = Date.now().toString() + Math.floor(Math.random()*9999);
      await set(p, { id, eventId, position, studentId, points, published:false, createdAt: Date.now() });
    }
  }

  await upsertPosition(1, firstId, fPts);
  await upsertPosition(2, secondId, sPts);
  await upsertPosition(3, thirdId, tPts);
  toast('Results saved as draft');
  bootstrap.Modal.getInstance(document.getElementById('editResultModal')).hide();
});

/* delete all results for event from modal */
$('deleteResultBtn').addEventListener('click', async ()=>{
  const evId = document.getElementById('editResultForm').dataset.eventId;
  if(!evId) return toast('No event'); if(!confirm('Delete all results for this event?')) return;
  const toRemove = CACHE.results.filter(r => String(r.eventId) === String(evId));
  for(const r of toRemove){ const dbKey = KEYMAP.results[r.id] || r.id; await remove(ref(db, `results/${dbKey}`)); }
  toast('Deleted');
  bootstrap.Modal.getInstance(document.getElementById('editResultModal')).hide();
});

/* publish/unpublish event results (award or remove points accordingly) */
async function togglePublishEvent(evId){
  // find results for event
  const eventResults = CACHE.results.filter(r => String(r.eventId) === String(evId));
  if(!eventResults.length) return toast('No results to publish','warning');
  // determine target state: if any unpublished -> publish all; else unpublish all
  const anyUnpublished = eventResults.some(r => !r.published);
  if(anyUnpublished){
    // publish all not-yet-published, and award points to team
    for(const r of eventResults){
      if(r.published) continue;
      const dbKey = KEYMAP.results[r.id] || r.id;
      await update(ref(db, `results/${dbKey}`), { published:true, publishedAt: Date.now() });
      // award team points (find student's team)
      const stud = CACHE.students.find(s => String(s.id) === String(r.studentId));
      if(stud && stud.teamId){
        const team = CACHE.teams.find(t => String(t.id) === String(stud.teamId));
        if(team){
          const dbTeamKey = KEYMAP.teams[team.id];
          const newScore = (Number(team.score)||0) + (Number(r.points)||0);
          await update(ref(db, `teams/${dbTeamKey}`), { score: newScore });
        }
      }
    }
    toast('Published results for event');
  } else {
    // Unpublish all — subtract points (best-effort)
    for(const r of eventResults){
      const dbKey = KEYMAP.results[r.id] || r.id;
      await update(ref(db, `results/${dbKey}`), { published:false, publishedAt: null });
      const stud = CACHE.students.find(s => String(s.id) === String(r.studentId));
      if(stud && stud.teamId){
        const team = CACHE.teams.find(t => String(t.id) === String(stud.teamId));
        if(team){
          const dbTeamKey = KEYMAP.teams[team.id];
          const newScore = Math.max(0, (Number(team.score)||0) - (Number(r.points)||0));
          await update(ref(db, `teams/${dbTeamKey}`), { score: newScore });
        }
      }
    }
    toast('Unpublished results for event (points removed)');
  }
}

/* ---------- REPORTS + LIVE SCORE computation ---------- */
function computeLiveScores(){
  // ensures team.score field exists and is shown in Teams table; if you prefer compute from results, override team scores here
  // We'll keep admin's team.score authoritative and also show computed summary
  renderTeams();
  renderResultsList();
}

/* renderReports (simple) */
function renderReports(){
  const tbody = $('reportsTable'); if(!tbody) return;
  if(!CACHE.teams.length){ tbody.innerHTML = '<tr><td colspan="4" class="text-center muted">No teams</td></tr>'; return; }
  let html=''; CACHE.teams.forEach(t => {
    const members = CACHE.students.filter(s => String(s.teamId) === String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const score = Number(t.score)||0;
    html += `<tr><td>${escapeHtml(t.name)}</td><td>${members}</td><td>${pct}%</td><td>${score}</td><td class="text-end"><button class="btn btn-sm btn-outline-secondary btn-export-team" data-id="${t.id}">Export</button></td></tr>`;
  });
  tbody.innerHTML = html;
}

/* export team PDF when clicking export button in reports */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.btn-export-team');
  if(!b) return;
  const id = b.dataset.id;
  const team = CACHE.teams.find(t=>String(t.id)===String(id));
  if(!team) return toast('Team not found','danger');
  const members = CACHE.students.filter(s=>String(s.teamId)===String(id));
  let html = `<h3>Team ${escapeHtml(team.name)}</h3><table><thead><tr><th>Chess</th><th>Name</th><th>Level</th></tr></thead><tbody>`;
  members.forEach(m => html += `<tr><td>${escapeHtml(m.id)}</td><td>${escapeHtml(m.name)}</td><td>${escapeHtml(m.level||'')}</td></tr>`);
  html += '</tbody></table>';
  html2pdf().from(html).set({margin:10,filename:`team_${escapeHtml(team.name)}.pdf`}).save();
});

/* computeTeamAttendancePct (team-only) */
function computeTeamAttendancePct(teamId){
  const members = CACHE.students.filter(s => String(s.teamId) === String(teamId)).map(s=>String(s.id));
  if(!members.length) return 0;
  const att = CACHE.attendance || {};
  let present=0, total=0;
  Object.values(att).forEach(sess => {
    if(!sess || !sess.students) return;
    members.forEach(m => {
      if(sess.students[m] !== undefined){ total++; if(String(sess.students[m]).toLowerCase() === 'present') present++; }
    });
  });
  if(total===0) return 0;
  return Math.round((present/total)*100);
}

/* ---------- DROPDOWNS & POPULATE ---------- */
function populateDropdowns(){
  const manualTeam = $('manualTeam'); if(manualTeam){ manualTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t => manualTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const teamLeader = $('teamLeader'); if(teamLeader){ teamLeader.innerHTML = '<option value="">Choose leader (Chess #)</option>'; CACHE.students.forEach(s => teamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const attTeam = $('attTeam'); if(attTeam){ attTeam.innerHTML = '<option value="">Select team</option>'; CACHE.teams.forEach(t=> attTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeam = $('editTeam'); if(editTeam){ editTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> editTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const resEv = $('resultEvent'); if(resEv){ resEv.innerHTML = '<option value="">Select event</option>'; CACHE.events.forEach(e => resEv.innerHTML += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`); }
}

/* ---------- SEARCH handlers ---------- */
$('searchStudents')?.addEventListener('input', ()=> renderStudents());
$('globalSearchBtn')?.addEventListener('click', ()=> {
  const q = ($('globalSearch').value||'').trim().toLowerCase(); if(!q){ toast('Enter search terms','warning'); return; }
  document.querySelector('[data-target="#panel-students"]').click();
  setTimeout(()=> { $('searchStudents').value = q; renderStudents(); }, 50);
});

/* ---------- PDF exports (results) ---------- */

/* Published-only PDF */
$('downloadEventsPdf').addEventListener('click', ()=> {
  // Export all events (both published/draft) — this button is generic
  let html = `<h3>Events</h3><table><thead><tr><th>Name</th><th>Type</th><th>Level</th><th>Description</th></tr></thead><tbody>`;
  CACHE.events.forEach(e => html += `<tr><td>${escapeHtml(e.name)}</td><td>${escapeHtml(e.type)}</td><td>${escapeHtml(e.level||'')}</td><td>${escapeHtml(e.description||'')}</td></tr>`);
  html += '</tbody></table>'; downloadHtmlAsPdf(html, `events_${new Date().toISOString().slice(0,10)}.pdf`);
});

/* Results PDF: Published only */
function exportPublishedResultsPdf(){
  let html = `<h3>Published Results</h3>`;
  CACHE.events.forEach(ev=>{
    const evResults = CACHE.results.filter(r => String(r.eventId) === String(ev.id) && r.published);
    if(!evResults.length) return;
    html += `<h4>${escapeHtml(ev.name)}</h4><ol>`;
    [1,2,3].forEach(pos=>{
      const r = evResults.find(x=>Number(x.position)===pos);
      if(r){
        const s = CACHE.students.find(st=>String(st.id)===String(r.studentId)) || {name:r.studentId};
        const team = CACHE.teams.find(t=>String(t.id)===String((CACHE.students.find(st=>String(st.id)===String(r.studentId))||{}).teamId)) || {};
        html += `<li>${escapeHtml(r.position)} - ${escapeHtml(s.name)} (${escapeHtml(s.id)}) - ${escapeHtml(team.name||'')} - ${Number(r.points)||0} pts</li>`;
      }
    });
    html += `</ol>`;
  });
  if(html === `<h3>Published Results</h3>`) return toast('No published results','warning');
  downloadHtmlAsPdf(html, `published_results_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* All (draft+published) results PDF */
function exportAllResultsPdf(){
  let html = `<h3>All Results</h3>`;
  CACHE.events.forEach(ev=>{
    const evResults = CACHE.results.filter(r => String(r.eventId) === String(ev.id));
    if(!evResults.length) return;
    html += `<h4>${escapeHtml(ev.name)} ${evResults.some(r=>r.published) ? '<small style="color:green"> (Some published)</small>' : ''}</h4><ol>`;
    [1,2,3].forEach(pos=>{
      const r = evResults.find(x=>Number(x.position)===pos);
      if(r){
        const s = CACHE.students.find(st=>String(st.id)===String(r.studentId)) || {name:r.studentId};
        const team = CACHE.teams.find(t=>String(t.id)===String((CACHE.students.find(st=>String(st.id)===String(r.studentId))||{}).teamId)) || {};
        html += `<li>${escapeHtml(r.position)} - ${escapeHtml(s.name)} (${escapeHtml(s.id)}) - ${escapeHtml(team.name||'')} - ${Number(r.points)||0} pts ${r.published? '(Published)':''}</li>`;
      }
    });
    html += `</ol>`;
  });
  if(html === `<h3>All Results</h3>`) return toast('No results','warning');
  downloadHtmlAsPdf(html, `all_results_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* helper to download HTML as PDF */
function downloadHtmlAsPdf(html, filename='export.pdf'){ const el = document.createElement('div'); el.innerHTML = html; html2pdf().from(el).set({margin:10,filename}).save(); }

/* ---------- small utilities ---------- */
function computeQuickStatsForTeam(teamId){
  const parts = CACHE.participations.filter(p => String(p.teamId) === String(teamId));
  const addedEvents = new Set(parts.map(p => p.eventId));
  const pending = parts.filter(p => String(p.status||'').toLowerCase() === 'pending').length;
  const approved = parts.filter(p => String(p.status||'').toLowerCase() === 'approved').length;
  return { added: addedEvents.size, pending, approved };
}

/* ---------- initial bootstrap ---------- */
setTimeout(()=> {
  document.querySelector('[data-target="#panel-students"]').click();
  try{ document.getElementById('current-year').textContent = new Date().getFullYear(); }catch(e){}
  renderAll();
}, 600);

console.log('Admin updated script loaded');
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>