<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Art Fest — Admin</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container-small { max-width: 1200px; margin: 2rem auto; }
    .table-actions button { margin-left: .25rem; }
    .toast-container { z-index: 1080; }
    .badge-status { padding:.45em .6em; border-radius: .5rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary" href="index.html">Art Fest — Admin</a>
      <div class="ms-auto">
        <button class="btn btn-outline-danger" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Logout</button>
      </div>
    </div>
  </nav>

  <div class="container container-small">

    <div class="d-flex justify-content-between align-items-center my-4">
      <h2>Administrator Dashboard</h2>
      <div>
        <button id="addStudentBtn" class="btn btn-sm btn-primary"><i class="bi bi-person-plus"></i> Add Student</button>
        <button id="addTeamBtn" class="btn btn-sm btn-success"><i class="bi bi-people"></i> Add Team</button>
        <button id="addEventBtn" class="btn btn-sm btn-warning"><i class="bi bi-calendar-event"></i> Add Event</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card p-3">
          <div class="small text-muted">Students</div>
          <div class="h4" id="stat-total-students">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="small text-muted">Teams</div>
          <div class="h4" id="stat-total-teams">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="small text-muted">Events</div>
          <div class="h4" id="stat-total-events">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <div class="small text-muted">Pending Approvals</div>
          <div class="h4" id="stat-pending-events">0</div>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-students">Students</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-teams">Teams</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events">Events</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-approvals">Approvals</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-results">Results</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-notifications">Notifications</button></li>
    </ul>

    <div class="tab-content">

      <!-- STUDENTS -->
      <div class="tab-pane fade show active" id="tab-students">
        <div class="card mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr><th>Chess #</th><th>Name</th><th>Team</th><th>Attendance</th><th class="text-end">Actions</th></tr>
                </thead>
                <tbody id="studentTableBody">
                  <!-- populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- TEAMS -->
      <div class="tab-pane fade" id="tab-teams">
        <div class="card mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Score</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="teamTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="tab-pane fade" id="tab-events">
        <div class="card mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light"><tr><th>Event</th><th>Type</th><th>Points</th><th>Status</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="eventTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- APPROVALS -->
      <div class="tab-pane fade" id="tab-approvals">
        <div class="card mb-4">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light"><tr><th>Event</th><th>Team</th><th>Participant</th><th>Submitted At</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="pendingEventsTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULTS -->
      <div class="tab-pane fade" id="tab-results">
        <div class="card mb-4 p-3">
          <form id="publishResultForm" class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Event</label>
              <select id="resultEvent" class="form-select"></select>
            </div>
            <div class="col-md-2">
              <label class="form-label">1st (Chess #)</label>
              <input id="firstPlace" class="form-control" />
            </div>
            <div class="col-md-2">
              <label class="form-label">2nd (Chess #)</label>
              <input id="secondPlace" class="form-control" />
            </div>
            <div class="col-md-2">
              <label class="form-label">3rd (Chess #)</label>
              <input id="thirdPlace" class="form-control" />
            </div>
            <div class="col-md-2">
              <button class="btn btn-success w-100" type="submit"><i class="bi bi-upload"></i> Publish</button>
            </div>
          </form>
          <hr/>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light"><tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th></tr></thead>
              <tbody id="publishedResultsTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- NOTIFICATIONS -->
      <div class="tab-pane fade" id="tab-notifications">
        <div class="card mb-4 p-3">
          <form id="notificationForm" class="row g-2 align-items-end">
            <div class="col-md-5"><label class="form-label">Title</label><input id="notificationTitle" class="form-control" required/></div>
            <div class="col-md-5"><label class="form-label">Message</label><input id="notificationMessage" class="form-control" required/></div>
            <div class="col-md-2"><button class="btn btn-primary w-100" type="submit"><i class="bi bi-bell-fill"></i> Send</button></div>
          </form>
          <hr/>
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light"><tr><th>Title</th><th>Message</th><th>To</th><th>Date</th></tr></thead>
              <tbody id="notificationHistoryTable"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div> <!-- tab-content -->

  </div> <!-- container -->

  <!-- Modals -->
  <!-- Student Modal -->
  <div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="studentForm" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Add Student</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="student-id" />
          <div class="mb-3"><label class="form-label">Chess Number</label><input id="studentChess" class="form-control" required/></div>
          <div class="mb-3"><label class="form-label">Name</label><input id="studentName" class="form-control" required/></div>
          <div class="mb-3"><label class="form-label">Team</label>
            <select id="studentTeam" class="form-select"><option value="">Unassigned</option></select>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-primary" type="submit">Save</button></div>
      </form>
    </div>
  </div>

  <!-- Team Modal -->
  <div class="modal fade" id="teamModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="teamForm" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Add Team</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="team-id" />
          <div class="mb-3"><label class="form-label">Team Name</label><input id="teamName" class="form-control" required/></div>
          <div class="mb-3"><label class="form-label">Leader (Chess #)</label>
            <select id="teamLeader" class="form-select"><option value="">Choose leader</option></select>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-success" type="submit">Save Team</button></div>
      </form>
    </div>
  </div>

  <!-- Event Modal -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="eventForm" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Add Event</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="event-id" />
          <div class="mb-3"><label class="form-label">Event Name</label><input id="eventName" class="form-control" required/></div>
          <div class="mb-3"><label class="form-label">Type</label>
            <select id="eventType" class="form-select"><option>Stage</option><option>Non-Stage</option></select>
          </div>
          <div class="mb-3"><label class="form-label">Points (1/2/3)</label>
            <div class="input-group">
              <input id="eventPt1" class="form-control" type="number" value="5" />
              <input id="eventPt2" class="form-control" type="number" value="3" />
              <input id="eventPt3" class="form-control" type="number" value="1" />
            </div>
          </div>
        </div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button class="btn btn-warning" type="submit">Save Event</button></div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body" id="confirmDeleteModalBody">Are you sure?</div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button id="confirmDeleteBtn" class="btn btn-danger">Delete</button></div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div id="toastRoot" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase and Admin Script (module) -->
  <script type="module">
    // ---------------------------
    // FIREBASE
    // ---------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, get, child, set, update, remove, push
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const rootRef = ref(database);

    // ---------------------------
    // AUTH: ensure admin
    // ---------------------------
    const userJson = sessionStorage.getItem('user');
    let currentUser = userJson ? JSON.parse(userJson) : null;
    if (!currentUser || currentUser.role !== 'Admin') {
      // redirect to index if not admin
      location.href = 'index.html';
      throw new Error('Not authorized');
    }

    // ---------------------------
    // DOM elements
    // ---------------------------
    const studentTableBody = document.getElementById('studentTableBody');
    const teamTableBody = document.getElementById('teamTableBody');
    const eventTableBody = document.getElementById('eventTableBody');
    const pendingEventsTableBody = document.getElementById('pendingEventsTableBody');
    const publishedResultsTableBody = document.getElementById('publishedResultsTableBody');
    const notificationHistoryTable = document.getElementById('notificationHistoryTable');

    const statStudents = document.getElementById('stat-total-students');
    const statTeams = document.getElementById('stat-total-teams');
    const statEvents = document.getElementById('stat-total-events');
    const statPending = document.getElementById('stat-pending-events');

    const addStudentBtn = document.getElementById('addStudentBtn');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const addEventBtn = document.getElementById('addEventBtn');

    // Modals and forms
    const studentModalEl = new bootstrap.Modal(document.getElementById('studentModal'));
    const teamModalEl = new bootstrap.Modal(document.getElementById('teamModal'));
    const eventModalEl = new bootstrap.Modal(document.getElementById('eventModal'));
    const confirmDeleteModalEl = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));

    const studentForm = document.getElementById('studentForm');
    const teamForm = document.getElementById('teamForm');
    const eventForm = document.getElementById('eventForm');

    const studentChess = document.getElementById('studentChess');
    const studentName = document.getElementById('studentName');
    const studentTeam = document.getElementById('studentTeam');
    const studentIdHidden = document.getElementById('student-id');

    const teamName = document.getElementById('teamName');
    const teamLeader = document.getElementById('teamLeader');
    const teamIdHidden = document.getElementById('team-id');

    const eventIdHidden = document.getElementById('event-id');
    const eventName = document.getElementById('eventName');
    const eventType = document.getElementById('eventType');
    const eventPt1 = document.getElementById('eventPt1');
    const eventPt2 = document.getElementById('eventPt2');
    const eventPt3 = document.getElementById('eventPt3');

    const resultEvent = document.getElementById('resultEvent');
    const firstPlace = document.getElementById('firstPlace');
    const secondPlace = document.getElementById('secondPlace');
    const thirdPlace = document.getElementById('thirdPlace');
    const publishResultForm = document.getElementById('publishResultForm');

    const notificationForm = document.getElementById('notificationForm');
    const notificationTitle = document.getElementById('notificationTitle');
    const notificationMessage = document.getElementById('notificationMessage');

    // Toast helper
    const toastRoot = document.getElementById('toastRoot');
    function showToast(message, type='success') {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${type} border-0`;
      toast.role = 'alert'; toast.ariaLive = 'assertive'; toast.ariaAtomic = 'true';
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      toastRoot.appendChild(toast);
      const btoast = new bootstrap.Toast(toast, { delay: 3000 });
      btoast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    // Generic delete callback holder
    let deleteCallback = null;
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
      if (deleteCallback) deleteCallback();
      confirmDeleteModalEl.hide();
    });

    // ---------------------------
    // MODELS (in-memory snapshot)
    // ---------------------------
    let db = {
      students: [], // arrays
      teams: [],
      events: [],
      participations: [],
      results: [],
      notifications: []
    };

    // ---------------------------
    // REALTIME LISTENERS (sync db -> UI)
    // ---------------------------
    // We listen to the whole root and map objects to arrays for easier UI handling.
    onValue(rootRef, (snapshot) => {
      const data = snapshot.val() || {};
      db.students = data.students ? Object.values(data.students) : [];
      db.teams = data.teams ? Object.values(data.teams) : [];
      db.events = data.events ? Object.values(data.events) : [];
      db.participations = data.participations ? Object.values(data.participations) : [];
      db.results = data.results ? Object.values(data.results) : [];
      db.notifications = data.notifications ? Object.values(data.notifications) : [];

      // Ensure numeric ids where appropriate
      db.students.forEach(s => { s.id = s.id !== undefined ? (typeof s.id === 'string' ? (isFinite(s.id) ? parseInt(s.id,10) : s.id) : s.id) : s.id; });
      db.teams.forEach(t => { t.id = t.id !== undefined ? (typeof t.id === 'string' && isFinite(t.id) ? parseInt(t.id,10) : t.id) : t.id; });

      renderAll();
    });

    // ---------------------------
    // RENDER
    // ---------------------------
    function renderAll() {
      renderStudents();
      renderTeams();
      renderEvents();
      renderParticipations();
      renderResults();
      renderNotifications();
      renderStats();
      populateDropdowns();
    }

    function renderStudents() {
      studentTableBody.innerHTML = '';
      if (db.students.length === 0) {
        studentTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No students</td></tr>`;
        return;
      }
      // sort by id
      db.students.sort((a,b) => {
        const ai = Number(a.id)||0, bi = Number(b.id)||0; return ai-bi;
      }).forEach(s => {
        const team = db.teams.find(t => t.id === s.teamId);
        const teamNameText = team ? team.name : '<em class="text-muted">Unassigned</em>';
        const status = s.attendance?.status || 'Absent';
        const timestamp = s.attendance?.timestamp ? new Date(s.attendance.timestamp).toLocaleString() : 'N/A';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td>${team ? team.name : 'Unassigned'}</td>
          <td><span class="badge ${status === 'Present' ? 'bg-success' : 'bg-danger'}">${status}</span><div class="small text-muted">${timestamp}</div></td>
          <td class="text-end table-actions">
            <button class="btn btn-sm btn-outline-primary btn-edit-student"><i class="bi bi-pencil-fill"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-delete-student"><i class="bi bi-trash-fill"></i></button>
          </td>`;
        tr.dataset.id = s.id;
        studentTableBody.appendChild(tr);
      });
    }

    function renderTeams() {
      teamTableBody.innerHTML = '';
      if (db.teams.length === 0) {
        teamTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No teams</td></tr>`;
        return;
      }
      db.teams.forEach(t => {
        const leader = db.students.find(s => s.id === t.leaderId);
        const members = db.students.filter(s => s.teamId === t.id).length;
        const score = t.score || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${t.name}</strong></td>
          <td>${leader ? leader.name + ' ('+leader.id+')' : '<em class="text-muted">No leader</em>'}</td>
          <td>${members}</td>
          <td>${score}</td>
          <td class="text-end table-actions">
            <button class="btn btn-sm btn-outline-primary btn-edit-team"><i class="bi bi-pencil-fill"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-delete-team"><i class="bi bi-trash-fill"></i></button>
          </td>`;
        tr.dataset.id = t.id;
        teamTableBody.appendChild(tr);
      });
    }

    function renderEvents() {
      eventTableBody.innerHTML = '';
      resultEvent.innerHTML = `<option value="">Select event...</option>`;
      if (db.events.length === 0) {
        eventTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No events</td></tr>`;
        return;
      }
      db.events.forEach(ev => {
        const pts = Array.isArray(ev.points) ? ev.points.join('/') : `${ev.points?.[0]||0}/${ev.points?.[1]||0}/${ev.points?.[2]||0}`;
        const status = ev.status || 'Open';
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${ev.name}</td>
          <td>${ev.type}</td>
          <td>${pts}</td>
          <td><span class="badge bg-secondary">${status}</span></td>
          <td class="text-end table-actions">
            <button class="btn btn-sm btn-outline-primary btn-edit-event"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-delete-event"><i class="bi bi-trash-fill"></i></button>
          </td>`;
        row.dataset.id = ev.id;
        eventTableBody.appendChild(row);

        // add to result dropdown
        if ((ev.status || 'Open') !== 'Completed') resultEvent.innerHTML += `<option value="${ev.id}">${ev.name}</option>`;
      });
    }

    function renderParticipations() {
      pendingEventsTableBody.innerHTML = '';
      const pending = db.participations.filter(p => p.status === 'Pending');
      if (pending.length === 0) {
        pendingEventsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No pending approvals</td></tr>`;
        return;
      }
      pending.forEach(p => {
        const eventObj = db.events.find(e => e.id === p.eventId);
        const student = db.students.find(s => s.id === p.studentId);
        const team = db.teams.find(t => t.id === p.teamId);
        if (!eventObj || !student || !team) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${eventObj.name}</td>
          <td>${team.name}</td>
          <td>${student.name} (${student.id})</td>
          <td>${new Date(p.submittedAt).toLocaleString()}</td>
          <td class="text-end table-actions">
            <button class="btn btn-sm btn-success btn-approve-event"><i class="bi bi-check-lg"></i></button>
            <button class="btn btn-sm btn-danger btn-reject-event"><i class="bi bi-x-lg"></i></button>
          </td>`;
        tr.dataset.id = p.id;
        pendingEventsTableBody.appendChild(tr);
      });
    }

    function renderResults() {
      publishedResultsTableBody.innerHTML = '';
      if (db.results.length === 0) {
        publishedResultsTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No results published</td></tr>`;
        return;
      }
      db.results.forEach(r => {
        const ev = db.events.find(e => e.id === r.eventId);
        const getName = (id) => {
          if (!id || id === 'none') return '<em class="text-muted">N/A</em>';
          const s = db.students.find(st => st.id === id);
          return s ? s.name + ' ('+s.id+')' : id;
        };
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${ev ? ev.name : 'Unknown'}</td><td>${getName(r.first)}</td><td>${getName(r.second)}</td><td>${getName(r.third)}</td>`;
        publishedResultsTableBody.appendChild(tr);
      });
    }

    function renderNotifications() {
      notificationHistoryTable.innerHTML = '';
      if (db.notifications.length === 0) {
        notificationHistoryTable.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No notifications yet</td></tr>`;
        return;
      }
      [...db.notifications].reverse().forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.title}</td><td>${n.message}</td><td>${n.to || 'All'}</td><td>${new Date(n.date).toLocaleString()}</td>`;
        notificationHistoryTable.appendChild(tr);
      });
    }

    function renderStats() {
      statStudents.textContent = db.students.length;
      statTeams.textContent = db.teams.length;
      statEvents.textContent = db.events.length;
      const pendingCount = db.participations.filter(p => p.status === 'Pending').length;
      statPending.textContent = pendingCount;
    }

    function populateDropdowns() {
      // studentTeam select for studentModal
      studentTeam.innerHTML = `<option value="">Unassigned</option>`;
      db.teams.forEach(t => studentTeam.innerHTML += `<option value="${t.id}">${t.name}</option>`);
      // teamLeader select for teamModal
      teamLeader.innerHTML = `<option value="">Choose leader</option>`;
      db.students.forEach(s => teamLeader.innerHTML += `<option value="${s.id}">${s.name} (${s.id})</option>`);
    }

    // ---------------------------
    // ADD / EDIT / DELETE actions
    // ---------------------------

    // -- STUDENTS --
    addStudentBtn.addEventListener('click', () => {
      studentForm.reset();
      studentIdHidden.value = '';
      studentChess.readOnly = false;
      studentModalEl.show();
    });

    studentForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const idVal = studentIdHidden.value;
      const chess = studentChess.value.trim();
      const name = studentName.value.trim();
      const teamIdStr = studentTeam.value;
      const teamId = teamIdStr === '' ? null : (isFinite(teamIdStr) ? parseInt(teamIdStr,10) : teamIdStr);

      if (!chess || !name) { showToast('Provide chess number and name', 'danger'); return; }
      const chessNum = Number(chess);
      if (Number.isNaN(chessNum)) { showToast('Chess number must be numeric', 'danger'); return; }

      if (idVal) {
        // update existing
        const studentRef = ref(database, `students/${idVal}`);
        await update(studentRef, { name, teamId });
        showToast('Student updated');
        studentModalEl.hide();
      } else {
        // add new — store under students/{chessNum}
        const targetRef = ref(database, `students/${chessNum}`);
        // ensure we don't overwrite existing unintentionally
        const snap = await get(targetRef);
        if (snap.exists()) { showToast('Chess number already exists', 'danger'); return; }
        await set(targetRef, {
          id: chessNum,
          name,
          teamId: teamId,
          attendance: { status: 'Absent', timestamp: null }
        });
        showToast('Student added');
        studentModalEl.hide();
      }
    });

    // student table click (delegate)
    studentTableBody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      if (btn.classList.contains('btn-edit-student')) {
        const s = db.students.find(x => String(x.id) === String(id));
        if (!s) return;
        studentIdHidden.value = s.id;
        studentChess.value = s.id;
        studentChess.readOnly = true;
        studentName.value = s.name;
        studentTeam.value = s.teamId || '';
        studentModalEl.show();
      } else if (btn.classList.contains('btn-delete-student')) {
        const s = db.students.find(x => String(x.id) === String(id));
        if (!s) return;
        document.getElementById('confirmDeleteModalBody').textContent = `Delete student "${s.name}" (${s.id})? This cannot be undone.`;
        deleteCallback = async () => {
          await remove(ref(database, `students/${s.id}`));
          // remove any participations for that student
          const updates = {};
          db.participations.filter(p => p.studentId === s.id).forEach(p => updates[`participations/${p.id}`] = null);
          // update teams to remove leader references if needed
          db.teams.forEach(t => { if (t.leaderId === s.id) updates[`teams/${t.id}/leaderId`] = null; });
          if (Object.keys(updates).length) await update(rootRef, updates);
          showToast('Student deleted');
        };
        confirmDeleteModalEl.show();
      }
    });

    // -- TEAMS --
    addTeamBtn.addEventListener('click', () => {
      teamForm.reset();
      teamIdHidden.value = '';
      populateDropdowns();
      teamModalEl.show();
    });

    teamForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const idVal = teamIdHidden.value;
      const name = teamName.value.trim();
      const leaderIdVal = teamLeader.value || null;
      const leaderId = leaderIdVal ? (isFinite(leaderIdVal) ? parseInt(leaderIdVal,10) : leaderIdVal) : null;

      if (!name) { showToast('Provide team name', 'danger'); return; }

      if (idVal) {
        // update team
        await update(ref(database, `teams/${idVal}`), { name, leaderId });
        showToast('Team updated');
        teamModalEl.hide();
      } else {
        // create new team using push (unique key) and set id property to numeric timestamp
        const newTeamRef = push(ref(database, 'teams'));
        const autoKey = newTeamRef.key;
        const numericId = Date.now(); // friendly id
        await set(newTeamRef, { id: numericId, name, leaderId, score: 0 });
        showToast('Team created');
        teamModalEl.hide();
      }
    });

    teamTableBody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      const team = db.teams.find(x => String(x.id) === String(id));
      if (!team) return;

      if (btn.classList.contains('btn-edit-team')) {
        teamIdHidden.value = team.id;
        teamName.value = team.name;
        teamLeader.value = team.leaderId || '';
        populateDropdowns();
        teamModalEl.show();
      } else if (btn.classList.contains('btn-delete-team')) {
        document.getElementById('confirmDeleteModalBody').textContent = `Delete team "${team.name}"? This will not delete students but will unassign them.`;
        deleteCallback = async () => {
          // find DB key for team (teams are stored as an object; we must remove by known key)
          // Approach: find team in DB as object by searching root snapshot (we have only arrays). We'll delete by matching id for all team keys.
          // To be safe, fetch root object and remove the matching team key.
          const rootSnap = await get(rootRef);
          const rootData = rootSnap.val() || {};
          const teamsObj = rootData.teams || {};
          let foundKey = null;
          for (const k in teamsObj) {
            if (String(teamsObj[k].id) === String(team.id)) { foundKey = k; break; }
          }
          if (foundKey) {
            await remove(ref(database, `teams/${foundKey}`));
            // unassign teamId from students
            const updates = {};
            db.students.filter(s => s.teamId === team.id).forEach(s => updates[`students/${s.id}/teamId`] = null);
            if (Object.keys(updates).length) await update(rootRef, updates);
            showToast('Team deleted');
          } else {
            showToast('Could not find team key to delete', 'danger');
          }
        };
        confirmDeleteModalEl.show();
      }
    });

    // -- EVENTS --
    addEventBtn.addEventListener('click', () => {
      eventForm.reset();
      eventIdHidden.value = '';
      eventModalEl.show();
    });

    eventForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const idVal = eventIdHidden.value;
      const name = eventName.value.trim();
      const type = eventType.value;
      const pts = [Number(eventPt1.value)||0, Number(eventPt2.value)||0, Number(eventPt3.value)||0];

      if (!name) { showToast('Provide event name', 'danger'); return; }

      if (idVal) {
        // update by searching event key
        const rootSnap = await get(rootRef);
        const rootData = rootSnap.val() || {};
        const eventsObj = rootData.events || {};
        let foundKey = null;
        for (const k in eventsObj) {
          if (String(eventsObj[k].id) === String(idVal)) { foundKey = k; break; }
        }
        if (foundKey) {
          await update(ref(database, `events/${foundKey}`), { name, type, points: pts });
          showToast('Event updated');
          eventModalEl.hide();
        } else showToast('Could not find event to update', 'danger');
      } else {
        const newRef = push(ref(database, 'events'));
        const numericId = Date.now();
        await set(newRef, { id: numericId, name, type, points: pts, status: 'Open' });
        showToast('Event created');
        eventModalEl.hide();
      }
    });

    eventTableBody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      const evobj = db.events.find(x => String(x.id) === String(id));
      if (!evobj) return;

      if (btn.classList.contains('btn-edit-event')) {
        eventIdHidden.value = evobj.id;
        eventName.value = evobj.name;
        eventType.value = evobj.type;
        eventPt1.value = evobj.points?.[0] ?? 0;
        eventPt2.value = evobj.points?.[1] ?? 0;
        eventPt3.value = evobj.points?.[2] ?? 0;
        eventModalEl.show();
      } else if (btn.classList.contains('btn-delete-event')) {
        document.getElementById('confirmDeleteModalBody').textContent = `Delete event "${evobj.name}"?`;
        deleteCallback = async () => {
          // find event key in DB
          const rootSnap = await get(rootRef);
          const rootData = rootSnap.val() || {};
          const eventsObj = rootData.events || {};
          let foundKey = null;
          for (const k in eventsObj) {
            if (String(eventsObj[k].id) === String(evobj.id)) { foundKey = k; break; }
          }
          if (foundKey) {
            await remove(ref(database, `events/${foundKey}`));
            // remove related participations
            const updates = {};
            db.participations.filter(p => p.eventId === evobj.id).forEach(p => updates[`participations/${p.id}`] = null);
            if (Object.keys(updates).length) await update(rootRef, updates);
            showToast('Event deleted');
          } else showToast('Could not find event to delete', 'danger');
        };
        confirmDeleteModalEl.show();
      }
    });

    // -- APPROVALS (Approve / Reject)
    pendingEventsTableBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      const part = db.participations.find(p => p.id === id);
      if (!part) return;

      // find participation's DB key
      const rootSnap = await get(rootRef);
      const rootData = rootSnap.val() || {};
      const partsObj = rootData.participations || {};
      let foundKey = null;
      for (const k in partsObj) {
        if (String(partsObj[k].id) === String(part.id)) { foundKey = k; break; }
      }
      if (!foundKey) { showToast('Participation not found', 'danger'); return; }

      if (btn.classList.contains('btn-approve-event')) {
        // mark approved
        await update(ref(database, `participations/${foundKey}`), { status: 'Approved', approvedAt: Date.now() });
        showToast('Participation approved');
      } else if (btn.classList.contains('btn-reject-event')) {
        await update(ref(database, `participations/${foundKey}`), { status: 'Rejected', rejectedAt: Date.now() });
        showToast('Participation rejected');
      }
    });

    // -- PUBLISH RESULTS --
    publishResultForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const evId = resultEvent.value;
      if (!evId) { showToast('Select event', 'danger'); return; }
      const rFirst = firstPlace.value.trim() || 'none';
      const rSecond = secondPlace.value.trim() || 'none';
      const rThird = thirdPlace.value.trim() || 'none';

      // push result to results collection
      const rRef = push(ref(database, 'results'));
      await set(rRef, {
        id: Date.now(),
        eventId: Number(evId),
        first: isFinite(rFirst) ? Number(rFirst) : rFirst,
        second: isFinite(rSecond) ? Number(rSecond) : rSecond,
        third: isFinite(rThird) ? Number(rThird) : rThird,
        publishedAt: Date.now()
      });

      // Optionally: update team scores (add points)
      // We attempt to give points based on event definition
      const evObj = db.events.find(e => Number(e.id) === Number(evId));
      if (evObj) {
        const pts = evObj.points || [0,0,0];
        const updates = {};
        // for each place, find student's team and add score
        const addToTeamByStudent = (studentId, points) => {
          if (!studentId || studentId === 'none') return;
          const stu = db.students.find(s => Number(s.id) === Number(studentId));
          if (!stu) return;
          const teamId = stu.teamId;
          if (!teamId) return;
          // find team key
          // We'll prepare updates as teams/{key}/score = (existing + pts)
          const rootSnapAll = null; // placeholder
          // We'll apply by searching teams when updating below synchronously
          const team = db.teams.find(t => t.id === teamId);
          if (team) {
            const teamKey = Object.keys(rootDataOrPlaceholder()).find(k => {
              const t = rootTeamsObj()[k];
              return t && String(t.id) === String(team.id);
            });
            // instead of complicated key logic here, simply update by scanning teams and using update(rootRef, {...})
            if (teamKey) {
              updates[`teams/${teamKey}/score`] = (team.score || 0) + points;
            } else {
              // fallback: update by numeric id path (if teams stored by numeric id)
              // We'll handle via scanning keys above below.
            }
          }
        };
        // For simplicity: compute in-memory then write by searching keys
        // Find DB snapshot root to get team keys
        const rootSnap = await get(rootRef);
        const rootData = rootSnap.val() || {};
        const teamsObj = rootData.teams || {};
        const findTeamKeyById = (tid) => {
          for (const k in teamsObj) {
            if (String(teamsObj[k].id) === String(tid)) return k;
          }
          return null;
        };
        // apply points
        const winners = [{id:rFirst, pts: pts[0]||0}, {id:rSecond, pts: pts[1]||0}, {id:rThird, pts: pts[2]||0}];
        const teamScoreUpdates = {};
        winners.forEach(w => {
          if (!w.id || w.id === 'none') return;
          const s = db.students.find(st => String(st.id) === String(w.id));
          if (!s || !s.teamId) return;
          const tKey = findTeamKeyById(s.teamId);
          if (!tKey) return;
          const currentScore = teamsObj[tKey].score || 0;
          teamScoreUpdates[`teams/${tKey}/score`] = currentScore + (w.pts || 0);
        });
        if (Object.keys(teamScoreUpdates).length) await update(rootRef, teamScoreUpdates);
      }

      showToast('Result published', 'success');
      // mark event completed
      // find event key
      const rootSnap2 = await get(rootRef);
      const rootData2 = rootSnap2.val() || {};
      const eventsObj2 = rootData2.events || {};
      for (const k in eventsObj2) {
        if (String(eventsObj2[k].id) === String(evId)) {
          await update(ref(database, `events/${k}`), { status: 'Completed' });
          break;
        }
      }
      // clear form
      firstPlace.value = secondPlace.value = thirdPlace.value = '';
      resultEvent.value = '';
    });

    // -- NOTIFICATIONS --
    notificationForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const title = notificationTitle.value.trim();
      const message = notificationMessage.value.trim();
      if (!title || !message) { showToast('Provide title and message', 'danger'); return; }

      const nRef = push(ref(database, 'notifications'));
      await set(nRef, {
        id: Date.now(),
        title,
        message,
        to: 'All',
        date: Date.now()
      });
      showToast('Notification sent');
      notificationForm.reset();
    });

    // ---------------------------
    // Utility to find root snapshot structures (used in a few places)
    // ---------------------------
    async function rootDataOrPlaceholder() {
      const snap = await get(rootRef);
      return snap.val() || {};
    }
    function rootTeamsObj() {
      // we can't synchronously read root snapshot here without awaiting; used only inside awaited flows
      return {}; // placeholder - don't rely on this outside awaited context
    }

    // ---------------------------
    // LOGOUT
    // ---------------------------
    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('user');
      location.href = 'index.html';
    });

    // initial population attempt (if needed)
    populateDropdowns();

  </script>
</body>
</html>
