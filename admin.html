<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Art Fest — Admin Dashboard</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- SheetJS for Excel import -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --accent:#4f46e5;
      --muted:#6b7280;
      --success:#10b981;
      --danger:#ef4444;
    }
    body { background: var(--bg); font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color:#222; }
    .navbar { background: linear-gradient(90deg,#ffffff 0%, rgba(255,255,255,0.9) 100%); box-shadow:0 6px 18px rgba(16,24,40,0.06); }
    .container-wide { max-width: 1200px; margin: 30px auto; }
    .card-neo { background:var(--card); border-radius:12px; box-shadow:0 6px 20px rgba(16,24,40,0.05); border:0; }
    .section-title { font-weight:700; color: #0f172a; }
    .muted { color: var(--muted); }
    .btn-accent { background: linear-gradient(90deg,var(--accent),#7c3aed); color:#fff; border:0; }
    .form-label { font-weight:600; font-size:0.92rem; }
    .small-muted { color:var(--muted); font-size:0.875rem; }
    .table thead { background: #fbfbff; }
    .modal-header { border-bottom:0; }
    .toast-container { z-index: 11000; }
    .badge-status { padding: .4rem .6rem; border-radius: 999px; font-weight:600; }
    .file-input-label { cursor: pointer; }
    hr.sep { border-top: 1px dashed #eef2ff; margin: 1rem 0 1.25rem; }
    /* Responsive adjustments */
    @media (max-width: 768px) { .container-wide { margin: 12px; } }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container container-wide d-flex align-items-center">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <span class="badge text-bg-primary rounded-pill"><i class="bi bi-palette-fill"></i></span>
        <div>
          <div style="font-weight:700">Art Fest Management</div>
          <div style="font-size:.82rem; color:var(--muted)">Administrator Dashboard</div>
        </div>
      </a>

      <div class="ms-auto d-flex gap-2 align-items-center">
        <button id="btnImportExcel" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-arrow-up"></i> Import Students (Excel)</button>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" />
        <button id="logoutBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
      </div>
    </div>
  </nav>

  <main class="container container-wide">

    <!-- TOP STATS -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card-neo p-3">
          <div class="small-muted">Students</div>
          <div class="h4" id="stat-total-students">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-neo p-3">
          <div class="small-muted">Teams</div>
          <div class="h4" id="stat-total-teams">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-neo p-3">
          <div class="small-muted">Events</div>
          <div class="h4" id="stat-total-events">0</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card-neo p-3">
          <div class="small-muted">Pending</div>
          <div class="h4" id="stat-pending-events">0</div>
        </div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="card-neo p-3 mb-4 d-flex gap-2 flex-wrap align-items-center">
      <div class="d-flex gap-2">
        <button id="addStudentBtn" class="btn btn-accent"><i class="bi bi-person-plus"></i> Add Student</button>
        <button id="addTeamBtn" class="btn btn-success"><i class="bi bi-people"></i> Add Team</button>
        <button id="addEventBtn" class="btn btn-warning"><i class="bi bi-calendar-event"></i> Add Event</button>
      </div>
      <div class="ms-auto small-muted">Upload Excel: columns allowed — <strong>Chess Number, Name, Class, Team</strong>. Team must match existing team name or left blank.</div>
    </div>

    <!-- TABS -->
    <div class="card-neo p-3 mb-4">
      <ul class="nav nav-pills mb-3" id="tabs">
        <li class="nav-item"><button class="nav-link active" data-bs-target="#tab-students">Students</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-teams">Teams</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-events">Events</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-approvals">Approvals</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-results">Results</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-attendance">Attendance</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-target="#tab-notifications">Notifications</button></li>
      </ul>

      <div id="tabContents">

        <!-- STUDENTS TAB -->
        <section id="tab-students" class="tab-section">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Chess #</th>
                  <th>Name</th>
                  <th>Class</th>
                  <th>Team</th>
                  <th>Attendance</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="studentTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- TEAMS TAB -->
        <section id="tab-teams" class="tab-section" style="display:none">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Team</th>
                  <th>Leader (Chess #)</th>
                  <th>Members</th>
                  <th>Score</th>
                  <th>Password</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="teamTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- EVENTS TAB -->
        <section id="tab-events" class="tab-section" style="display:none">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>Type</th>
                  <th>Description / Rules</th>
                  <th>Status</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="eventTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- APPROVALS TAB -->
        <section id="tab-approvals" class="tab-section" style="display:none">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>Team</th>
                  <th>Participant</th>
                  <th>Submitted At</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="pendingEventsTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- RESULTS TAB -->
        <section id="tab-results" class="tab-section" style="display:none">
          <div class="mb-3">
            <form id="resultForm" class="row gx-2 gy-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label">Select Event</label>
                <select id="resultEvent" class="form-select"></select>
              </div>
              <div class="col-md-2">
                <label class="form-label">1st Place (Chess #)</label>
                <input id="rFirst" class="form-control" type="number" min="0" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Points for 1st (0-100)</label>
                <input id="pFirst" class="form-control" type="number" min="0" max="100" value="100"/>
              </div>
              <div class="col-md-2">
                <label class="form-label">2nd (Chess #)</label>
                <input id="rSecond" class="form-control" type="number" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Points for 2nd (0-100)</label>
                <input id="pSecond" class="form-control" type="number" min="0" max="100" value="50"/>
              </div>

              <div class="col-md-2">
                <label class="form-label">3rd (Chess #)</label>
                <input id="rThird" class="form-control" type="number" />
              </div>
              <div class="col-md-2">
                <label class="form-label">Points for 3rd (0-100)</label>
                <input id="pThird" class="form-control" type="number" min="0" max="100" value="25"/>
              </div>

              <div class="col-md-2 d-flex align-items-center">
                <div class="form-check mt-1">
                  <input class="form-check-input" type="checkbox" value="" id="publishNow">
                  <label class="form-check-label small-muted" for="publishNow">Publish now</label>
                </div>
              </div>

              <div class="col-md-2">
                <button class="btn btn-success w-100" type="submit"><i class="bi bi-upload"></i> Add Result</button>
              </div>
            </form>
          </div>

          <hr class="sep"/>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th><th>Published</th></tr>
              </thead>
              <tbody id="publishedResultsTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- ATTENDANCE TAB -->
        <section id="tab-attendance" class="tab-section" style="display:none">
          <div class="mb-3 d-flex gap-2 align-items-center">
            <div>
              <label class="form-label small-muted">Select Date</label>
              <input type="date" id="attendanceDate" class="form-control" />
            </div>
            <div>
              <label class="form-label small-muted">&nbsp;</label>
              <button id="btnMarkAllPresent" class="btn btn-outline-success">Mark All Present</button>
            </div>
            <div class="ms-auto small-muted">Attendance stored under students/{id}/attendance as {status, timestamp, date}</div>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Chess #</th><th>Name</th><th>Team</th><th>Attendance</th><th class="text-end">Action</th></tr></thead>
              <tbody id="attendanceTableBody"></tbody>
            </table>
          </div>
        </section>

        <!-- NOTIFICATIONS TAB -->
        <section id="tab-notifications" class="tab-section" style="display:none">
          <form id="notificationForm" class="row g-2 mb-3">
            <div class="col-md-4"><label class="form-label">Title</label><input id="notificationTitle" class="form-control" required/></div>
            <div class="col-md-6"><label class="form-label">Message</label><input id="notificationMessage" class="form-control" required/></div>
            <div class="col-md-2 d-flex align-items-end"><button class="btn btn-primary w-100" type="submit"><i class="bi bi-bell-fill"></i> Send</button></div>
          </form>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Title</th><th>Message</th><th>To</th><th>Date</th></tr></thead>
              <tbody id="notificationHistoryTable"></tbody>
            </table>
          </div>
        </section>

      </div>
    </div>
  </main>

  <!-- MODALS -->
  <!-- STUDENT MODAL -->
  <div class="modal fade" id="studentModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="studentForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Student</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="student-id">
          <div class="mb-3">
            <label class="form-label">Chess Number</label>
            <input id="studentChess" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input id="studentName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Class</label>
            <input id="studentClass" class="form-control" />
          </div>
          <div class="mb-3">
            <label class="form-label">Team</label>
            <select id="studentTeam" class="form-select"><option value="">Unassigned</option></select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-accent" type="submit">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TEAM MODAL -->
  <div class="modal fade" id="teamModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="teamForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Team</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="team-id">
          <div class="mb-3">
            <label class="form-label">Team Name</label>
            <input id="teamNameInput" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Leader (Chess #)</label>
            <select id="teamLeader" class="form-select"><option value="">None</option></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Password (auto-generated or edit)</label>
            <div class="input-group">
              <input id="teamPassword" class="form-control" />
              <button id="btnGenPassword" class="btn btn-outline-secondary" type="button">Generate</button>
              <button id="btnCopyPassword" class="btn btn-outline-primary" type="button">Copy</button>
            </div>
            <div class="small-muted mt-1">Leaders will use this password to login with their chess number.</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-success" type="submit">Save Team</button>
        </div>
      </form>
    </div>
  </div>

  <!-- EVENT MODAL -->
  <div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
      <form id="eventForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Event</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="event-id">
          <div class="mb-3">
            <label class="form-label">Event Name</label>
            <input id="eventName" class="form-control" required />
          </div>
          <div class="mb-3">
            <label class="form-label">Type</label>
            <select id="eventType" class="form-select"><option>Stage</option><option>Non-Stage</option></select>
          </div>
          <div class="mb-3">
            <label class="form-label">Description / Rules</label>
            <textarea id="eventDescription" class="form-control" rows="4" placeholder="Describe rules or instructions for this event..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-warning" type="submit">Save Event</button>
        </div>
      </form>
    </div>
  </div>

  <!-- CONFIRM DELETE -->
  <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-body" id="confirmDeleteModalBody">Are you sure?</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button id="confirmDeleteBtn" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toastRoot" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, get, set, update, remove, push
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const rootRef = ref(database);

    // Session check (must be admin)
    const userJson = sessionStorage.getItem('user');
    if (!userJson) { location.href = 'index.html'; throw new Error('Not logged in'); }
    const currentUser = JSON.parse(userJson);
    if (!currentUser || currentUser.role !== 'Admin') { location.href = 'index.html'; throw new Error('Not admin'); }

    // DOM references
    const studentTableBody = document.getElementById('studentTableBody');
    const teamTableBody = document.getElementById('teamTableBody');
    const eventTableBody = document.getElementById('eventTableBody');
    const pendingEventsTableBody = document.getElementById('pendingEventsTableBody');
    const publishedResultsTableBody = document.getElementById('publishedResultsTableBody');
    const notificationHistoryTable = document.getElementById('notificationHistoryTable');
    const attendanceTableBody = document.getElementById('attendanceTableBody');

    const statStudents = document.getElementById('stat-total-students');
    const statTeams = document.getElementById('stat-total-teams');
    const statEvents = document.getElementById('stat-total-events');
    const statPending = document.getElementById('stat-pending-events');

    // Buttons / inputs
    const addStudentBtn = document.getElementById('addStudentBtn');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const addEventBtn = document.getElementById('addEventBtn');
    const btnImportExcel = document.getElementById('btnImportExcel');
    const excelFileInput = document.getElementById('excelFile');

    // Forms & modals
    const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
    const teamModal = new bootstrap.Modal(document.getElementById('teamModal'));
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
    const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));

    const studentForm = document.getElementById('studentForm');
    const teamForm = document.getElementById('teamForm');
    const eventForm = document.getElementById('eventForm');
    const resultForm = document.getElementById('resultForm');
    const notificationForm = document.getElementById('notificationForm');

    const studentIdHidden = document.getElementById('student-id');
    const studentChess = document.getElementById('studentChess');
    const studentName = document.getElementById('studentName');
    const studentClass = document.getElementById('studentClass');
    const studentTeam = document.getElementById('studentTeam');

    const teamIdHidden = document.getElementById('team-id');
    const teamNameInput = document.getElementById('teamNameInput');
    const teamLeader = document.getElementById('teamLeader');
    const teamPassword = document.getElementById('teamPassword');
    const btnGenPassword = document.getElementById('btnGenPassword');
    const btnCopyPassword = document.getElementById('btnCopyPassword');

    const eventIdHidden = document.getElementById('event-id');
    const eventName = document.getElementById('eventName');
    const eventType = document.getElementById('eventType');
    const eventDescription = document.getElementById('eventDescription');

    const resultEvent = document.getElementById('resultEvent');
    const rFirst = document.getElementById('rFirst'), pFirst = document.getElementById('pFirst');
    const rSecond = document.getElementById('rSecond'), pSecond = document.getElementById('pSecond');
    const rThird = document.getElementById('rThird'), pThird = document.getElementById('pThird');
    const publishNow = document.getElementById('publishNow');

    const attendanceDate = document.getElementById('attendanceDate');
    const btnMarkAllPresent = document.getElementById('btnMarkAllPresent');

    const notificationTitle = document.getElementById('notificationTitle');
    const notificationMessage = document.getElementById('notificationMessage');

    let db = { students: [], teams: [], events: [], participations: [], results: [], notifications: [] };
    let deleteCallback = null;

    // Toast helper
    const toastRoot = document.getElementById('toastRoot');
    function showToast(message, type='success') {
      const t = document.createElement('div');
      t.className = `toast align-items-center text-bg-${type} border-0`;
      t.setAttribute('role','alert'); t.setAttribute('aria-live','assertive'); t.setAttribute('aria-atomic','true');
      t.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      toastRoot.appendChild(t);
      const bt = new bootstrap.Toast(t, { delay: 3000 }); bt.show();
      t.addEventListener('hidden.bs.toast', () => t.remove());
    }

    // Generic delete button
    document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
      if (deleteCallback) deleteCallback();
      deleteCallback = null;
      confirmDeleteModal.hide();
    });

    // Tab switching
    document.querySelectorAll('#tabs [data-bs-target]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-section').forEach(s => s.style.display = 'none');
        const t = document.querySelector(btn.dataset.bsTarget || btn.getAttribute('data-bs-target'));
        if (t) t.style.display = 'block';
        document.querySelectorAll('#tabs .nav-link').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // Listen DB
    onValue(rootRef, (snap) => {
      const data = snap.val() || {};
      db.students = data.students ? Object.values(data.students) : [];
      db.teams = data.teams ? Object.values(data.teams) : [];
      db.events = data.events ? Object.values(data.events) : [];
      db.participations = data.participations ? Object.values(data.participations) : [];
      db.results = data.results ? Object.values(data.results) : [];
      db.notifications = data.notifications ? Object.values(data.notifications) : [];

      // normalize ids
      db.students.forEach(s => { if (s && s.id !== undefined) s.id = Number(s.id); });
      db.teams.forEach(t => { if (t && t.id !== undefined && isFinite(t.id)) t.id = Number(t.id); });
      db.events.forEach(e => { if (e && e.id !== undefined && isFinite(e.id)) e.id = Number(e.id); });

      renderAll();
    });

    // RENDER
    function renderAll() {
      renderStudents();
      renderTeams();
      renderEvents();
      renderParticipations();
      renderResults();
      renderNotifications();
      renderStats();
      populateDropdowns();
      renderAttendanceTable();
    }

    function renderStudents() {
      studentTableBody.innerHTML = '';
      if (db.students.length === 0) {
        studentTableBody.innerHTML = `<tr><td colspan="6" class="text-center muted">No students added</td></tr>`;
        return;
      }
      db.students.sort((a,b)=> (a.id||0)-(b.id||0)).forEach(s => {
        const team = db.teams.find(t => t.id === s.teamId);
        const att = s.attendance?.status || 'Absent';
        const ts = s.attendance?.timestamp ? new Date(s.attendance.timestamp).toLocaleString() : 'N/A';
        const tr = document.createElement('tr');
        tr.dataset.id = s.id;
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name || ''}</td>
          <td>${s.class || ''}</td>
          <td>${team ? team.name : '<em class="muted">Unassigned</em>'}</td>
          <td><div><span class="badge-status text-bg-${att==='Present'?'success':'danger'}">${att}</span><div class="small-muted">${ts}</div></div></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary btn-edit-student"><i class="bi bi-pencil-fill"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-delete-student"><i class="bi bi-trash-fill"></i></button>
          </td>`;
        studentTableBody.appendChild(tr);
      });
    }

    function renderTeams() {
      teamTableBody.innerHTML = '';
      if (db.teams.length === 0) { teamTableBody.innerHTML = `<tr><td colspan="6" class="text-center muted">No teams</td></tr>`; return; }
      db.teams.forEach(t => {
        const leader = db.students.find(s => s.id === t.leaderId);
        const members = db.students.filter(s => s.teamId === t.id).length;
        const pwd = t.password ? '•'.repeat(4) : '<em class="muted">n/a</em>';
        const tr = document.createElement('tr');
        tr.dataset.key = t.__key || ''; // optional
        tr.dataset.id = t.id;
        tr.innerHTML = `
          <td><strong>${t.name}</strong></td>
          <td>${leader ? leader.name + ' ('+leader.id+')' : '<em class="muted">No leader</em>'}</td>
          <td>${members}</td>
          <td>${t.score||0}</td>
          <td><div class="d-flex gap-2 align-items-center"><div>${pwd}</div><button class="btn btn-sm btn-outline-secondary btn-show-pass"><i class="bi bi-eye"></i></button></div></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary btn-edit-team"><i class="bi bi-pencil-fill"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-delete-team"><i class="bi bi-trash-fill"></i></button>
          </td>`;
        teamTableBody.appendChild(tr);
      });
    }

    function renderEvents() {
      eventTableBody.innerHTML = '';
      if (db.events.length === 0) { eventTableBody.innerHTML = `<tr><td colspan="5" class="text-center muted">No events</td></tr>`; return; }
      db.events.forEach(ev => {
        const status = ev.status || 'Open';
        const desc = ev.description ? (ev.description.length>120?ev.description.slice(0,120)+'...':ev.description) : '';
        const tr = document.createElement('tr');
        tr.dataset.id = ev.id;
        tr.innerHTML = `
          <td>${ev.name}</td>
          <td>${ev.type}</td>
          <td>${desc}</td>
          <td><span class="badge ${status==='Completed'?'bg-secondary':'bg-info'}">${status}</span></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-primary btn-edit-event"><i class="bi bi-pencil"></i></button>
            <button class="btn btn-sm btn-outline-danger btn-delete-event"><i class="bi bi-trash-fill"></i></button>
          </td>`;
        eventTableBody.appendChild(tr);
      });
    }

    function renderParticipations() {
      pendingEventsTableBody.innerHTML = '';
      const pending = db.participations.filter(p => p.status === 'Pending');
      if (!pending.length) { pendingEventsTableBody.innerHTML = `<tr><td colspan="5" class="text-center muted">No pending approvals</td></tr>`; return; }
      pending.forEach(p => {
        const ev = db.events.find(e => e.id === p.eventId);
        const stu = db.students.find(s => s.id === p.studentId);
        const team = db.teams.find(t => t.id === p.teamId);
        const tr = document.createElement('tr');
        tr.dataset.id = p.id;
        tr.innerHTML = `
          <td>${ev ? ev.name : '—'}</td>
          <td>${team ? team.name : '—'}</td>
          <td>${stu ? stu.name + ' ('+stu.id+')' : '—'}</td>
          <td>${new Date(p.submittedAt).toLocaleString()}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-success btn-approve-event"><i class="bi bi-check-lg"></i></button>
            <button class="btn btn-sm btn-danger btn-reject-event"><i class="bi bi-x-lg"></i></button>
          </td>`;
        pendingEventsTableBody.appendChild(tr);
      });
    }

    function renderResults() {
      publishedResultsTableBody.innerHTML = '';
      if (!db.results.length) { publishedResultsTableBody.innerHTML = `<tr><td colspan="5" class="text-center muted">No results</td></tr>`; return; }
      db.results.forEach(r => {
        const ev = db.events.find(e => e.id === r.eventId);
        const getName = id => {
          if (!id || id === 'none') return '<em class="muted">N/A</em>';
          const s = db.students.find(x => String(x.id) === String(id));
          return s ? `${s.name} (${s.id})` : id;
        };
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${ev?ev.name:'Unknown'}</td><td>${getName(r.first)} (${r.pFirst||0})</td><td>${getName(r.second)} (${r.pSecond||0})</td><td>${getName(r.third)} (${r.pThird||0})</td><td>${r.published?new Date(r.publishedAt).toLocaleString():'No'}</td>`;
        publishedResultsTableBody.appendChild(tr);
      });
    }

    function renderNotifications() {
      notificationHistoryTable.innerHTML = '';
      if (!db.notifications.length) { notificationHistoryTable.innerHTML = `<tr><td colspan="4" class="text-center muted">No notifications</td></tr>`; return; }
      [...db.notifications].reverse().forEach(n => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.title}</td><td>${n.message}</td><td>${n.to||'All'}</td><td>${new Date(n.date).toLocaleString()}</td>`;
        notificationHistoryTable.appendChild(tr);
      });
    }

    function renderStats() {
      statStudents.textContent = db.students.length;
      statTeams.textContent = db.teams.length;
      statEvents.textContent = db.events.length;
      const pendingCount = db.participations.filter(p => p.status === 'Pending').length;
      statPending.textContent = pendingCount;
    }

    function populateDropdowns() {
      // students -> teamLeader select & studentTeam select
      teamLeader.innerHTML = `<option value="">None</option>`;
      studentTeam.innerHTML = `<option value="">Unassigned</option>`;
      db.students.forEach(s => {
        const opt = `<option value="${s.id}">${s.name || s.id} (${s.id})</option>`;
        teamLeader.innerHTML += opt;
      });
      db.teams.forEach(t => {
        studentTeam.innerHTML += `<option value="${t.id}">${t.name}</option>`;
      });

      // resultEvent dropdown
      resultEvent.innerHTML = `<option value="">Select event...</option>`;
      db.events.forEach(e => {
        resultEvent.innerHTML += `<option value="${e.id}">${e.name}</option>`;
      });
    }

    // ATTENDANCE
    function renderAttendanceTable() {
      attendanceTableBody.innerHTML = '';
      if (!db.students.length) { attendanceTableBody.innerHTML = `<tr><td colspan="5" class="text-center muted">No students</td></tr>`; return; }
      db.students.sort((a,b)=>(a.id||0)-(b.id||0)).forEach(s => {
        const team = db.teams.find(t => t.id === s.teamId);
        const att = s.attendance?.status || 'Absent';
        const tr = document.createElement('tr');
        tr.dataset.id = s.id;
        tr.innerHTML = `
          <td>${s.id}</td>
          <td>${s.name||''}</td>
          <td>${team?team.name:'Unassigned'}</td>
          <td><span class="badge ${att==='Present'?'bg-success':'bg-danger'}">${att}</span></td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-success btn-mark-present">Present</button>
            <button class="btn btn-sm btn-outline-danger btn-mark-absent">Absent</button>
          </td>`;
        attendanceTableBody.appendChild(tr);
      });
    }

    // ---------- CRUD & Event handlers ----------

    // Add Student
    addStudentBtn.addEventListener('click', () => {
      studentForm.reset();
      studentIdHidden.value = '';
      studentChess.readOnly = false;
      studentModal.show();
      populateDropdowns();
    });

    studentForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const idVal = studentIdHidden.value;
      const chess = studentChess.value.trim();
      const name = studentName.value.trim();
      const cls = studentClass.value.trim();
      const teamIdVal = studentTeam.value || null;
      if (!chess || !name) { showToast('Provide chess number and name', 'danger'); return; }
      const chessNum = Number(chess);
      if (isNaN(chessNum)) { showToast('Chess number must be numeric', 'danger'); return; }

      if (idVal) {
        // update existing student path — students stored under students/{chess}
        await update(ref(database, `students/${idVal}`), { name, class: cls, teamId: teamIdVal ? Number(teamIdVal) : null });
        showToast('Student updated');
        studentModal.hide();
      } else {
        const studRef = ref(database, `students/${chessNum}`);
        const snap = await get(studRef);
        if (snap.exists()) { showToast('Chess number exists', 'danger'); return; }
        await set(studRef, { id: chessNum, name, class: cls, teamId: teamIdVal?Number(teamIdVal):null, attendance: { status:'Absent', timestamp:null } });
        showToast('Student added');
        studentModal.hide();
      }
    });

    // Student table actions (delegate)
    studentTableBody.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      if (btn.classList.contains('btn-edit-student')) {
        const s = db.students.find(x => String(x.id) === String(id));
        if (!s) return;
        studentIdHidden.value = s.id;
        studentChess.value = s.id;
        studentChess.readOnly = true;
        studentName.value = s.name || '';
        studentClass.value = s.class || '';
        studentTeam.value = s.teamId || '';
        populateDropdowns();
        studentModal.show();
      } else if (btn.classList.contains('btn-delete-student')) {
        const s = db.students.find(x => String(x.id) === String(id));
        document.getElementById('confirmDeleteModalBody').textContent = `Delete student "${s.name}" (${s.id})? This cannot be undone.`;
        deleteCallback = async () => {
          await remove(ref(database, `students/${s.id}`));
          // remove participations
          const snap = await get(rootRef);
          const rootObj = snap.val() || {};
          const partsObj = rootObj.participations || {};
          const updates = {};
          for (const k in partsObj) {
            if (partsObj[k].studentId === s.id) updates[`participations/${k}`] = null;
          }
          if (Object.keys(updates).length) await update(rootRef, updates);
          showToast('Student deleted');
        };
        confirmDeleteModal.show();
      }
    });

    // Add Team
    addTeamBtn.addEventListener('click', () => {
      teamForm.reset();
      teamIdHidden.value = '';
      teamPassword.value = generateTeamPassword();
      populateDropdowns();
      teamModal.show();
    });

    // Generate password
    btnGenPassword.addEventListener('click', () => { teamPassword.value = generateTeamPassword(); });

    btnCopyPassword.addEventListener('click', () => {
      if (!teamPassword.value) return showToast('No password to copy', 'danger');
      navigator.clipboard.writeText(teamPassword.value).then(()=> showToast('Password copied'));
    });

    teamForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const idVal = teamIdHidden.value;
      const tName = teamNameInput.value.trim();
      const leaderIdVal = teamLeader.value || null;
      const pwd = teamPassword.value || generateTeamPassword();

      if (!tName) { showToast('Provide team name', 'danger'); return; }

      if (idVal) {
        // find team key and update
        const snap = await get(rootRef);
        const root = snap.val() || {};
        const teamsObj = root.teams || {};
        let foundKey = null;
        for (const k in teamsObj) { if (String(teamsObj[k].id) === String(idVal)) { foundKey = k; break; } }
        if (!foundKey) { showToast('Team key not found', 'danger'); return; }
        await update(ref(database, `teams/${foundKey}`), { name: tName, leaderId: leaderIdVal?Number(leaderIdVal):null, password: pwd });
        showToast('Team updated');
        teamModal.hide();
      } else {
        const nref = push(ref(database,'teams'));
        const numericId = Date.now();
        await set(nref, { id: numericId, name: tName, leaderId: leaderIdVal?Number(leaderIdVal):null, score:0, password: pwd });
        showToast('Team created');
        teamModal.hide();
      }
    });

    // Team table actions
    teamTableBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const teamId = tr?.dataset?.id;
      if (!teamId) return;
      const teamObj = db.teams.find(t => String(t.id) === String(teamId));
      if (!teamObj) return;

      if (btn.classList.contains('btn-edit-team')) {
        teamIdHidden.value = teamObj.id;
        teamNameInput.value = teamObj.name || '';
        teamLeader.value = teamObj.leaderId || '';
        teamPassword.value = teamObj.password || generateTeamPassword();
        populateDropdowns();
        teamModal.show();
      } else if (btn.classList.contains('btn-delete-team')) {
        document.getElementById('confirmDeleteModalBody').textContent = `Delete team "${teamObj.name}"? Students will be unassigned.`;
        deleteCallback = async () => {
          // find key
          const snap = await get(rootRef);
          const root = snap.val() || {};
          const teamsObj = root.teams || {};
          let foundKey = null;
          for (const k in teamsObj) { if (String(teamsObj[k].id) === String(teamObj.id)) { foundKey = k; break; } }
          if (!foundKey) return showToast('Team key not found', 'danger');
          await remove(ref(database, `teams/${foundKey}`));
          // unassign students
          const updates = {};
          db.students.filter(s => s.teamId === teamObj.id).forEach(s => updates[`students/${s.id}/teamId`] = null);
          if (Object.keys(updates).length) await update(rootRef, updates);
          showToast('Team deleted');
        };
        confirmDeleteModal.show();
      } else if (btn.classList.contains('btn-show-pass')) {
        // reveal password in modal
        const snap = await get(rootRef);
        const root = snap.val() || {};
        const teamsObj = root.teams || {};
        let foundKey = null, foundTeam = null;
        for (const k in teamsObj) { if (String(teamsObj[k].id) === String(teamObj.id)) { foundKey = k; foundTeam = teamsObj[k]; break; } }
        if (foundTeam) {
          alert(`Password for team "${foundTeam.name}": ${foundTeam.password || '(none)'}`);
        } else showToast('Team password not found', 'danger');
      }
    });

    // Add Event
    addEventBtn.addEventListener('click', () => {
      eventForm.reset();
      eventIdHidden.value = '';
      eventModal.show();
    });

    eventForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const idVal = eventIdHidden.value;
      const name = eventName.value.trim();
      const type = eventType.value;
      const desc = eventDescription.value.trim();
      if (!name) { showToast('Provide event name', 'danger'); return; }

      if (idVal) {
        const snap = await get(rootRef);
        const root = snap.val() || {};
        const eventsObj = root.events || {};
        let foundKey = null;
        for (const k in eventsObj) { if (String(eventsObj[k].id) === String(idVal)) { foundKey = k; break; } }
        if (!foundKey) { showToast('Event key not found', 'danger'); return; }
        await update(ref(database, `events/${foundKey}`), { name, type, description: desc });
        showToast('Event updated');
        eventModal.hide();
      } else {
        const nref = push(ref(database, 'events'));
        await set(nref, { id: Date.now(), name, type, description: desc, status: 'Open' });
        showToast('Event created');
        eventModal.hide();
      }
    });

    // Event table actions
    eventTableBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      const evObj = db.events.find(e => String(e.id) === String(id));
      if (!evObj) return;

      if (btn.classList.contains('btn-edit-event')) {
        eventIdHidden.value = evObj.id;
        eventName.value = evObj.name;
        eventType.value = evObj.type;
        eventDescription.value = evObj.description || '';
        eventModal.show();
      } else if (btn.classList.contains('btn-delete-event')) {
        document.getElementById('confirmDeleteModalBody').textContent = `Delete event "${evObj.name}"? This will remove related participations.`;
        deleteCallback = async () => {
          const snap = await get(rootRef);
          const root = snap.val() || {};
          const eventsObj = root.events || {};
          let foundKey = null;
          for (const k in eventsObj) { if (String(eventsObj[k].id) === String(evObj.id)) { foundKey = k; break; } }
          if (!foundKey) { showToast('Event key not found', 'danger'); return; }
          await remove(ref(database, `events/${foundKey}`));
          // remove participations
          const partsObj = root.participations || {};
          const updates = {};
          for (const k in partsObj) { if (partsObj[k].eventId === evObj.id) updates[`participations/${k}`] = null; }
          if (Object.keys(updates).length) await update(rootRef, updates);
          showToast('Event deleted');
        };
        confirmDeleteModal.show();
      }
    });

    // Approvals: approve / reject
    pendingEventsTableBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      // find participation key
      const rootSnap = await get(rootRef);
      const root = rootSnap.val() || {};
      const partsObj = root.participations || {};
      let foundKey = null, partObj = null;
      for (const k in partsObj) { if (String(partsObj[k].id) === String(id)) { foundKey = k; partObj = partsObj[k]; break; } }
      if (!foundKey) { showToast('Participation not found', 'danger'); return; }

      if (btn.classList.contains('btn-approve-event')) {
        await update(ref(database, `participations/${foundKey}`), { status: 'Approved', approvedAt: Date.now() });
        showToast('Approved');
      } else if (btn.classList.contains('btn-reject-event')) {
        await update(ref(database, `participations/${foundKey}`), { status: 'Rejected', rejectedAt: Date.now() });
        showToast('Rejected');
      }
    });

    // Result Form
    resultForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const evId = resultEvent.value;
      if (!evId) { showToast('Select event', 'danger'); return; }
      const first = rFirst.value.trim() || 'none';
      const second = rSecond.value.trim() || 'none';
      const third = rThird.value.trim() || 'none';
      const pf = Number(pFirst.value) || 0;
      const ps = Number(pSecond.value) || 0;
      const pt = Number(pThird.value) || 0;
      const publish = publishNow.checked;

      // push result object
      const rRef = push(ref(database,'results'));
      const resultObj = { id: Date.now(), eventId: Number(evId), first: first, second: second, third: third, pFirst: pf, pSecond: ps, pThird: pt, published: publish ? true : false, publishedAt: publish?Date.now():null };
      await set(rRef, resultObj);

      // if publish now, update team scores
      if (publish) {
        const rootSnap = await get(rootRef);
        const root = rootSnap.val() || {};
        const teamsObj = root.teams || {};
        // helper to add points to team by student id
        const addPointsToTeamByStudent = (studentId, points) => {
          if (!studentId || studentId === 'none') return null;
          const stud = db.students.find(s => String(s.id) === String(studentId));
          if (!stud || !stud.teamId) return null;
          const tid = stud.teamId;
          // find team key
          for (const k in teamsObj) {
            if (String(teamsObj[k].id) === String(tid)) {
              const newScore = (teamsObj[k].score || 0) + Number(points||0);
              teamsObj[k].score = newScore;
              return { key: k, score: newScore };
            }
          }
          return null;
        };

        const updates = {};
        const r1 = addPointsToTeamByStudent(first, pf);
        const r2 = addPointsToTeamByStudent(second, ps);
        const r3 = addPointsToTeamByStudent(third, pt);
        if (r1) updates[`teams/${r1.key}/score`] = r1.score;
        if (r2) updates[`teams/${r2.key}/score`] = r2.score;
        if (r3) updates[`teams/${r3.key}/score`] = r3.score;
        if (Object.keys(updates).length) await update(rootRef, updates);
        showToast('Result published and team scores updated');
        // mark event completed
        for (const k in root.events || {}) {
          if (String(root.events[k].id) === String(evId)) {
            await update(ref(database, `events/${k}`), { status: 'Completed' });
            break;
          }
        }
      } else {
        showToast('Result added (not published)');
      }

      // clear form fields
      resultEvent.value = '';
      rFirst.value=''; rSecond.value=''; rThird.value=''; pFirst.value='100'; pSecond.value='50'; pThird.value='25'; publishNow.checked=false;
    });

    // Notifications
    notificationForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const title = notificationTitle.value.trim();
      const message = notificationMessage.value.trim();
      if (!title || !message) { showToast('Provide title & message', 'danger'); return; }
      const nref = push(ref(database,'notifications'));
      await set(nref, { id: Date.now(), title, message, to: 'All', date: Date.now() });
      showToast('Notification sent');
      notificationForm.reset();
    });

    // Attendance actions
    attendanceTableBody.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const tr = ev.target.closest('tr');
      const id = tr?.dataset?.id;
      if (!id) return;
      const date = attendanceDate.value || new Date().toISOString().slice(0,10);
      if (btn.classList.contains('btn-mark-present')) {
        await update(ref(database, `students/${id}/attendance`), { status:'Present', timestamp: Date.now(), date });
        showToast('Marked present');
      } else if (btn.classList.contains('btn-mark-absent')) {
        await update(ref(database, `students/${id}/attendance`), { status:'Absent', timestamp: Date.now(), date });
        showToast('Marked absent');
      }
    });

    btnMarkAllPresent.addEventListener('click', async () => {
      const date = attendanceDate.value || new Date().toISOString().slice(0,10);
      const updates = {};
      db.students.forEach(s => updates[`students/${s.id}/attendance`] = { status:'Present', timestamp: Date.now(), date });
      if (Object.keys(updates).length) {
        await update(rootRef, updates);
        showToast('All students marked present');
      }
    });

    // Excel import (sheetjs)
    btnImportExcel.addEventListener('click', () => excelFileInput.click());

    excelFileInput.addEventListener('change', async (ev) => {
      const f = ev.target.files[0];
      if (!f) return;
      const data = await f.arrayBuffer();
      const wb = XLSX.read(data);
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
      // expected columns: Chess Number, Name, Class, Team
      if (!json.length) return showToast('Excel empty', 'danger');

      // Map and insert/update
      const updates = {};
      // ensure we have team name -> id mapping
      const teamNameToId = {};
      db.teams.forEach(t => { if (t.name) teamNameToId[String(t.name).trim().toLowerCase()] = t.id; });

      for (const row of json) {
        // tolerant keys
        const chess = row['Chess Number'] || row['Chess'] || row['chess'] || row['chess number'] || row['ChessNumber'] || row['ID'] || row['id'];
        const name = row['Name'] || row['Full Name'] || row['Student Name'] || row['name'];
        const cls = row['Class'] || row['class'] || row['Standard'] || row['std'];
        const teamName = row['Team'] || row['team'] || row['Group'] || '';

        if (!chess || !name) continue;
        const chessNum = Number(chess);
        const teamId = teamName ? teamNameToId[String(teamName).trim().toLowerCase()] : null;
        updates[`students/${chessNum}`] = { id: chessNum, name: String(name).trim(), class: cls ? String(cls).trim() : '', teamId: teamId || null, attendance: { status:'Absent', timestamp:null } };
      }

      if (Object.keys(updates).length) {
        await update(rootRef, updates);
        showToast(`Imported ${Object.keys(updates).length} students`);
      } else {
        showToast('No valid rows found', 'danger');
      }
      excelFileInput.value = '';
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('user');
      location.href = 'index.html';
    });

    // Utilities
    function generateTeamPassword() {
      const n = Math.floor(1000 + Math.random()*9000);
      return `TL-${n}`;
    }

    // Results: render / helper done via renderResults()

    // Initial population
    populateDropdowns();

  </script>
</body>
</html>
