<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin â€” Fidak Fest Management System</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
        --bg: #f8fafc;
        --card: #ffffff;
        --text: #1e293b;
        --muted: #64748b;
        --border: #e2e8f0;
        --surface: #f1f5f9;
        --accent-main: #3b82f6;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
    }

    .dark-mode {
        --bg: #0f1529;
        --card: #1a2238;
        --text: #e2e8f0;
        --muted: #94a3b8;
        --border: #2d3748;
        --surface: #252e44;
        --accent-main: #ff6b6b;
        --success: #69ff97;
        --danger: #ff6b6b;
        --warning: #ffd166;
    }

    body {
        font-family: system-ui, sans-serif;
        background: var(--bg);
        color: var(--text);
        min-height: 100vh;
    }

    .app-wrap {
        display: flex;
        min-height: 100vh;
    }

    .sidebar {
        width: 70px;
        background: var(--card);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 0;
        position: fixed;
        height: 100vh;
    }

    .sidebar .brand {
        margin-bottom: 30px;
        font-size: 24px;
        color: var(--accent-main);
    }

    .sidebar .icon-btn {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 8px 0;
        color: var(--muted);
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        background: transparent;
    }

    .sidebar .icon-btn:hover:not(.active) {
        background: var(--surface);
        color: var(--accent-main);
    }

    .sidebar .icon-btn.active {
        background: var(--accent-main);
        color: white;
    }

    .main-area {
        flex: 1;
        padding: 20px;
        margin-left: 70px;
    }

    .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
    }

    .card-neo {
        background: var(--card);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid var(--border);
        margin-bottom: 20px;
    }

    .section-title {
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text);
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-control, .form-select {
        background: var(--surface);
        border: 2px solid var(--border);
        color: var(--text);
        border-radius: 10px;
        padding: 10px 15px;
    }

    .btn {
        border-radius: 10px;
        font-weight: 600;
        padding: 10px 20px;
        border: none;
        cursor: pointer;
    }

    .btn-primary {
        background: var(--accent-main);
        color: white;
    }

    .btn-success {
        background: var(--success);
        color: white;
    }

    .btn-warning {
        background: var(--warning);
        color: white;
    }

    .btn-danger {
        background: var(--danger);
        color: white;
    }

    .table {
        --bs-table-bg: transparent;
        --bs-table-color: var(--text);
    }

    .table th {
        background: var(--surface);
        font-weight: 600;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .search-container {
        position: relative;
    }

    .search-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--muted);
    }

    .search-input {
        padding-left: 45px;
        border-radius: 10px;
        width: 100%;
    }

    .score-card {
        text-align: center;
        padding: 20px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--border);
    }

    .score-value {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 10px 0;
    }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .modal-content {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 15px;
    }

    @media (max-width: 768px) {
        .sidebar {
            width: 60px;
        }
        .main-area {
            margin-left: 60px;
            padding: 15px;
        }
    }
  </style>
</head>
<body class="light-mode">
<div class="app-wrap">
  <aside class="sidebar">
    <div class="brand"><i class="bi bi-trophy-fill"></i></div>
    <div class="icon-btn active" data-target="#panel-overview"><i class="bi bi-speedometer2"></i></div>
    <div class="icon-btn" data-target="#panel-students"><i class="bi bi-people-fill"></i></div>
    <div class="icon-btn" data-target="#panel-teams"><i class="bi bi-people"></i></div>
    <div class="icon-btn" data-target="#panel-events"><i class="bi bi-calendar-event"></i></div>
    <div class="icon-btn" data-target="#panel-attendance"><i class="bi bi-list-check"></i></div>
    <div class="icon-btn" data-target="#panel-approvals"><i class="bi bi-check2-square"></i></div>
    <div class="icon-btn" data-target="#panel-results"><i class="bi bi-trophy"></i></div>
    <div style="flex:1"></div>
    <div class="icon-btn" id="toggleThemeBtn" title="Toggle Theme"><i class="bi bi-moon"></i></div>
    <div class="icon-btn" id="logoutBtn" title="Logout"><i class="bi bi-box-arrow-right"></i></div>
  </aside>

  <main class="main-area">
    <div class="topbar">
      <div>
        <h3>Admin Dashboard</h3>
        <div class="muted">Fidak Fest Management System</div>
      </div>
    </div>

    <div id="panels">
      <!-- Overview Panel -->
      <section id="panel-overview" class="card-neo">
        <div class="section-title"><i class="bi bi-speedometer2"></i> Overview</div>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="score-card">
                    <div class="muted">Total Teams</div>
                    <div id="totalTeamsCount" class="score-value">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="score-card">
                    <div class="muted">Total Students</div>
                    <div id="totalStudentsCount" class="score-value">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="score-card">
                    <div class="muted">Pending Approvals</div>
                    <div id="pendingApprovalsCount" class="score-value">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="score-card">
                    <div class="muted">Draft Results</div>
                    <div id="draftResultsCount" class="score-value">0</div>
                </div>
            </div>
        </div>
      </section>

      <!-- Students Panel -->
      <section id="panel-students" class="card-neo d-none">
        <div class="section-title"><i class="bi bi-people-fill"></i> Students Management</div>
        
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card-neo">
              <h6>Add Student</h6>
              <input id="studentId" class="form-control mb-2" placeholder="Student ID">
              <input id="studentName" class="form-control mb-2" placeholder="Full Name">
              <select id="studentLevel" class="form-select mb-2">
                <option>Senior</option>
                <option>Junior</option>
              </select>
              <select id="studentTeam" class="form-select mb-3">
                <option value="">Unassigned</option>
              </select>
              <button id="addStudentBtn" class="btn btn-primary w-100">Add Student</button>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">All Students</h6>
                <div class="search-container" style="width: 200px;">
                  <i class="bi bi-search search-icon"></i>
                  <input id="searchStudents" class="form-control search-input" placeholder="Search...">
                </div>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Level</th>
                      <th>Team</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="studentsTable">
                    <tr><td colspan="5" class="text-center">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Teams Panel -->
      <section id="panel-teams" class="card-neo d-none">
        <div class="section-title"><i class="bi bi-people"></i> Teams Management</div>
        
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card-neo">
              <h6>Create Team</h6>
              <input id="teamName" class="form-control mb-2" placeholder="Team Name">
              <select id="teamLeader" class="form-select mb-3">
                <option value="">Select Leader</option>
              </select>
              <button id="createTeamBtn" class="btn btn-primary w-100">Create Team</button>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="card-neo">
              <h6>Teams List</h6>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Team</th>
                      <th>Leader</th>
                      <th>Members</th>
                      <th>Score</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="teamsTable">
                    <tr><td colspan="5" class="text-center">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Events Panel -->
      <section id="panel-events" class="card-neo d-none">
        <div class="section-title"><i class="bi bi-calendar-event"></i> Events Management</div>
        
        <div class="row g-4">
          <div class="col-md-4">
            <div class="card-neo">
              <h6>Add Event</h6>
              <input id="eventName" class="form-control mb-2" placeholder="Event Name">
              <select id="eventType" class="form-select mb-2">
                <option>Stage</option>
                <option>Non-Stage</option>
                <option>Group</option>
              </select>
              <select id="eventLevel" class="form-select mb-3">
                <option>General</option>
                <option>Junior</option>
                <option>Senior</option>
              </select>
              <button id="addEventBtn" class="btn btn-primary w-100">Add Event</button>
            </div>
          </div>
          
          <div class="col-md-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">Events List</h6>
                <div class="search-container" style="width: 200px;">
                  <i class="bi bi-search search-icon"></i>
                  <input id="searchEvents" class="form-control search-input" placeholder="Search...">
                </div>
              </div>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Event</th>
                      <th>Type</th>
                      <th>Level</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="eventsTable">
                    <tr><td colspan="4" class="text-center">Loading...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Attendance Panel -->
      <section id="panel-attendance" class="card-neo d-none">
        <div class="section-title"><i class="bi bi-list-check"></i> Attendance Management</div>
        
        <div class="card-neo mb-4">
          <h6>Create Attendance Session</h6>
          <div class="row g-3">
            <div class="col-md-4">
              <input id="attDate" type="date" class="form-control">
            </div>
            <div class="col-md-6">
              <input id="attDescription" class="form-control" placeholder="Description">
            </div>
            <div class="col-md-2">
              <button id="createAttSessionBtn" class="btn btn-primary w-100">Create</button>
            </div>
          </div>
        </div>
        
        <div class="card-neo">
          <h6>Attendance Sessions</h6>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Description</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="attendanceSessions">
                <tr><td colspan="3" class="text-center">No sessions</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Approvals Panel -->
      <section id="panel-approvals" class="card-neo d-none">
        <div class="section-title"><i class="bi bi-check2-square"></i> Approvals Management</div>
        
        <div class="card-neo">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Event Approvals</h6>
            <div class="search-container" style="width: 200px;">
              <i class="bi bi-search search-icon"></i>
              <input id="searchApprovals" class="form-control search-input" placeholder="Search events...">
            </div>
          </div>
          
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>Type</th>
                  <th>Pending</th>
                  <th>Approved</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="approvalsTable">
                <tr><td colspan="5" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Results Panel -->
      <section id="panel-results" class="card-neo d-none">
        <div class="section-title"><i class="bi bi-trophy"></i> Results Management</div>
        
        <div class="card-neo mb-4">
          <h6>Enter Results</h6>
          <div class="row g-3">
            <div class="col-md-4">
              <select id="resultEvent" class="form-select">
                <option value="">Select Event</option>
              </select>
            </div>
            <div class="col-md-8">
              <div class="row g-2">
                <div class="col-4">
                  <input id="resultFirst" class="form-control" placeholder="1st Place">
                </div>
                <div class="col-4">
                  <input id="resultSecond" class="form-control" placeholder="2nd Place">
                </div>
                <div class="col-4">
                  <input id="resultThird" class="form-control" placeholder="3rd Place">
                </div>
              </div>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button id="saveResultBtn" class="btn btn-warning">Save Draft</button>
            <button id="publishResultBtn" class="btn btn-success">Publish</button>
          </div>
        </div>
        
        <div class="card-neo">
          <h6>Results List</h6>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>Event</th>
                  <th>1st Place</th>
                  <th>2nd Place</th>
                  <th>3rd Place</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="resultsTable">
                <tr><td colspan="6" class="text-center">Loading...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Student</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editStudentKey">
        <input id="editStudentId" class="form-control mb-2" readonly>
        <input id="editStudentName" class="form-control mb-2" placeholder="Name">
        <select id="editStudentLevel" class="form-select mb-2">
          <option>Senior</option>
          <option>Junior</option>
        </select>
        <select id="editStudentTeam" class="form-select mb-3">
          <option value="">Unassigned</option>
        </select>
      </div>
      <div class="modal-footer">
        <button id="deleteStudentBtn" class="btn btn-danger">Delete</button>
        <button id="updateStudentBtn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Manage Approvals Modal -->
<div class="modal fade" id="manageApprovalsModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manage Approvals</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <h6>Pending Approvals</h6>
            <div id="pendingList" class="list-group"></div>
          </div>
          <div class="col-md-6">
            <h6>Approved</h6>
            <div id="approvedList" class="list-group"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Manage Results Modal -->
<div class="modal fade" id="manageResultsModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manage Results</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="manageResultEventId">
        <div class="mb-3">
          <input id="manageResultFirst" class="form-control mb-2" placeholder="1st Place">
          <input id="manageResultSecond" class="form-control mb-2" placeholder="2nd Place">
          <input id="manageResultThird" class="form-control mb-2" placeholder="3rd Place">
        </div>
      </div>
      <div class="modal-footer">
        <button id="deleteResultBtn" class="btn btn-danger">Delete</button>
        <button id="updateResultBtn" class="btn btn-primary">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, set, push, update, remove, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Data cache
let data = {
  students: [],
  teams: [],
  events: [],
  approvals: [],
  results: [],
  attendance: []
};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  setupEventListeners();
  
  // Set today's date for attendance
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('attDate').value = today;
});

// Load all data from Firebase
function loadData() {
  const paths = ['students', 'teams', 'events', 'approvals', 'results', 'attendance'];
  
  paths.forEach(path => {
    onValue(ref(db, path), (snapshot) => {
      const val = snapshot.val();
      data[path] = val ? Object.values(val) : [];
      updateUI();
    });
  });
}

// Update UI after data changes
function updateUI() {
  updateCounts();
  renderStudents();
  renderTeams();
  renderEvents();
  renderApprovals();
  renderResults();
  renderAttendance();
  populateDropdowns();
}

// Update dashboard counts
function updateCounts() {
  document.getElementById('totalTeamsCount').textContent = data.teams.length;
  document.getElementById('totalStudentsCount').textContent = data.students.length;
  document.getElementById('pendingApprovalsCount').textContent = data.approvals.filter(a => a.status === 'pending').length;
  document.getElementById('draftResultsCount').textContent = data.results.filter(r => r.status === 'draft').length;
}

// Populate dropdowns
function populateDropdowns() {
  // Student team dropdown
  const teamSelect = document.getElementById('studentTeam');
  const editTeamSelect = document.getElementById('editStudentTeam');
  teamSelect.innerHTML = '<option value="">Unassigned</option>';
  editTeamSelect.innerHTML = '<option value="">Unassigned</option>';
  data.teams.forEach(team => {
    teamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
    editTeamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
  });
  
  // Team leader dropdown
  const leaderSelect = document.getElementById('teamLeader');
  leaderSelect.innerHTML = '<option value="">Select Leader</option>';
  data.students.forEach(student => {
    leaderSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.id})</option>`;
  });
  
  // Event dropdown for results
  const eventSelect = document.getElementById('resultEvent');
  eventSelect.innerHTML = '<option value="">Select Event</option>';
  data.events.forEach(event => {
    eventSelect.innerHTML += `<option value="${event.id}">${event.name}</option>`;
  });
}

// Setup event listeners
function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.sidebar .icon-btn').forEach(btn => {
    if (btn.id === 'logoutBtn') {
      btn.addEventListener('click', () => window.location.href = 'index.html');
    } else if (btn.id === 'toggleThemeBtn') {
      btn.addEventListener('click', toggleTheme);
    } else {
      btn.addEventListener('click', (e) => {
        document.querySelectorAll('.sidebar .icon-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
        document.querySelector(btn.dataset.target).classList.remove('d-none');
      });
    }
  });
  
  // Add student
  document.getElementById('addStudentBtn').addEventListener('click', addStudent);
  document.getElementById('addStudentBtn').addEventListener('click', addStudent);
  
  // Create team
  document.getElementById('createTeamBtn').addEventListener('click', createTeam);
  
  // Add event
  document.getElementById('addEventBtn').addEventListener('click', addEvent);
  
  // Create attendance session
  document.getElementById('createAttSessionBtn').addEventListener('click', createAttendanceSession);
  
  // Results
  document.getElementById('saveResultBtn').addEventListener('click', saveResult);
  document.getElementById('publishResultBtn').addEventListener('click', publishResult);
  
  // Search functionality
  document.getElementById('searchStudents').addEventListener('input', renderStudents);
  document.getElementById('searchEvents').addEventListener('input', renderEvents);
  document.getElementById('searchApprovals').addEventListener('input', renderApprovals);
}

// Theme toggle
function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  const icon = document.querySelector('#toggleThemeBtn i');
  icon.className = document.body.classList.contains('dark-mode') ? 'bi bi-sun' : 'bi bi-moon';
}

// Toast notification
function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `position-fixed bottom-0 end-0 p-3`;
  toast.innerHTML = `
    <div class="toast align-items-center text-bg-${type} border-0 show" role="alert">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ========== STUDENTS ==========
function renderStudents() {
  const searchTerm = document.getElementById('searchStudents').value.toLowerCase();
  const filtered = data.students.filter(s => 
    s.id.toLowerCase().includes(searchTerm) || 
    s.name.toLowerCase().includes(searchTerm)
  );
  
  const tbody = document.getElementById('studentsTable');
  tbody.innerHTML = filtered.map(student => {
    const team = data.teams.find(t => t.id === student.teamId);
    return `
      <tr>
        <td>${student.id}</td>
        <td>${student.name}</td>
        <td><span class="badge ${student.level === 'Senior' ? 'bg-primary' : 'bg-info'}">${student.level}</span></td>
        <td>${team ? team.name : 'Unassigned'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editStudent('${student.id}')">Edit</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="5" class="text-center">No students found</td></tr>';
}

async function addStudent() {
  const id = document.getElementById('studentId').value.trim();
  const name = document.getElementById('studentName').value.trim();
  const level = document.getElementById('studentLevel').value;
  const teamId = document.getElementById('studentTeam').value;
  
  if (!id || !name) {
    showToast('Please enter student ID and name', 'warning');
    return;
  }
  
  if (data.students.some(s => s.id === id)) {
    showToast('Student ID already exists', 'warning');
    return;
  }
  
  const studentRef = push(ref(db, 'students'));
  await set(studentRef, {
    id,
    name,
    level,
    teamId: teamId || null
  });
  
  document.getElementById('studentId').value = '';
  document.getElementById('studentName').value = '';
  showToast('Student added successfully');
}

window.editStudent = function(studentId) {
  const student = data.students.find(s => s.id === studentId);
  if (!student) return;
  
  document.getElementById('editStudentKey').value = studentId;
  document.getElementById('editStudentId').value = student.id;
  document.getElementById('editStudentName').value = student.name;
  document.getElementById('editStudentLevel').value = student.level;
  document.getElementById('editStudentTeam').value = student.teamId || '';
  
  const modal = new bootstrap.Modal(document.getElementById('editStudentModal'));
  modal.show();
  
  // Update button
  document.getElementById('updateStudentBtn').onclick = async () => {
    const updates = {
      name: document.getElementById('editStudentName').value,
      level: document.getElementById('editStudentLevel').value,
      teamId: document.getElementById('editStudentTeam').value || null
    };
    
    // Find the student key
    const studentRef = ref(db, `students`);
    const snapshot = await get(studentRef);
    const students = snapshot.val();
    let studentKey = null;
    
    for (const key in students) {
      if (students[key].id === studentId) {
        studentKey = key;
        break;
      }
    }
    
    if (studentKey) {
      await update(ref(db, `students/${studentKey}`), updates);
      showToast('Student updated');
      modal.hide();
    }
  };
  
  // Delete button
  document.getElementById('deleteStudentBtn').onclick = async () => {
    if (!confirm('Delete this student?')) return;
    
    // Find the student key
    const studentRef = ref(db, `students`);
    const snapshot = await get(studentRef);
    const students = snapshot.val();
    let studentKey = null;
    
    for (const key in students) {
      if (students[key].id === studentId) {
        studentKey = key;
        break;
      }
    }
    
    if (studentKey) {
      await remove(ref(db, `students/${studentKey}`));
      showToast('Student deleted');
      modal.hide();
    }
  };
};

// ========== TEAMS ==========
function renderTeams() {
  const tbody = document.getElementById('teamsTable');
  tbody.innerHTML = data.teams.map(team => {
    const leader = data.students.find(s => s.id === team.leaderId);
    const members = data.students.filter(s => s.teamId === team.id).length;
    
    return `
      <tr>
        <td><strong>${team.name}</strong></td>
        <td>${leader ? leader.name : 'None'}</td>
        <td>${members}</td>
        <td>${team.score || 0}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editTeam('${team.id}')">Edit</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="5" class="text-center">No teams found</td></tr>';
}

async function createTeam() {
  const name = document.getElementById('teamName').value.trim();
  const leaderId = document.getElementById('teamLeader').value;
  
  if (!name) {
    showToast('Please enter team name', 'warning');
    return;
  }
  
  const teamRef = push(ref(db, 'teams'));
  await set(teamRef, {
    id: Date.now().toString(),
    name,
    leaderId: leaderId || null,
    score: 0
  });
  
  document.getElementById('teamName').value = '';
  showToast('Team created successfully');
}

window.editTeam = function(teamId) {
  const team = data.teams.find(t => t.id === teamId);
  if (!team) return;
  
  // Simple edit - just update name for now
  const newName = prompt('Enter new team name:', team.name);
  if (newName && newName !== team.name) {
    // Find team key and update
    const teamRef = ref(db, 'teams');
    get(teamRef).then(snapshot => {
      const teams = snapshot.val();
      for (const key in teams) {
        if (teams[key].id === teamId) {
          update(ref(db, `teams/${key}`), { name: newName });
          showToast('Team updated');
          break;
        }
      }
    });
  }
};

// ========== EVENTS ==========
function renderEvents() {
  const searchTerm = document.getElementById('searchEvents').value.toLowerCase();
  const filtered = data.events.filter(e => 
    e.name.toLowerCase().includes(searchTerm) || 
    e.type.toLowerCase().includes(searchTerm)
  );
  
  const tbody = document.getElementById('eventsTable');
  tbody.innerHTML = filtered.map(event => {
    return `
      <tr>
        <td><strong>${event.name}</strong></td>
        <td><span class="badge ${event.type === 'Stage' ? 'bg-primary' : 'bg-info'}">${event.type}</span></td>
        <td><span class="badge ${event.level === 'Senior' ? 'bg-warning' : 'bg-success'}">${event.level}</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="editEvent('${event.id}')">Edit</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="4" class="text-center">No events found</td></tr>';
}

async function addEvent() {
  const name = document.getElementById('eventName').value.trim();
  const type = document.getElementById('eventType').value;
  const level = document.getElementById('eventLevel').value;
  
  if (!name) {
    showToast('Please enter event name', 'warning');
    return;
  }
  
  const eventRef = push(ref(db, 'events'));
  await set(eventRef, {
    id: Date.now().toString(),
    name,
    type,
    level
  });
  
  document.getElementById('eventName').value = '';
  showToast('Event added successfully');
}

window.editEvent = function(eventId) {
  const event = data.events.find(e => e.id === eventId);
  if (!event) return;
  
  // Simple edit
  const newName = prompt('Enter new event name:', event.name);
  if (newName && newName !== event.name) {
    const eventRef = ref(db, 'events');
    get(eventRef).then(snapshot => {
      const events = snapshot.val();
      for (const key in events) {
        if (events[key].id === eventId) {
          update(ref(db, `events/${key}`), { name: newName });
          showToast('Event updated');
          break;
        }
      }
    });
  }
};

// ========== ATTENDANCE ==========
function renderAttendance() {
  const tbody = document.getElementById('attendanceSessions');
  tbody.innerHTML = data.attendance.map(session => {
    return `
      <tr>
        <td>${session.date}</td>
        <td>${session.description || 'No description'}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="viewAttendance('${session.id}')">View</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="3" class="text-center">No sessions found</td></tr>';
}

async function createAttendanceSession() {
  const date = document.getElementById('attDate').value;
  const description = document.getElementById('attDescription').value.trim();
  
  if (!date) {
    showToast('Please select a date', 'warning');
    return;
  }
  
  const sessionRef = push(ref(db, 'attendance'));
  await set(sessionRef, {
    id: Date.now().toString(),
    date,
    description,
    timestamp: Date.now()
  });
  
  document.getElementById('attDescription').value = '';
  showToast('Attendance session created');
}

window.viewAttendance = function(sessionId) {
  const session = data.attendance.find(s => s.id === sessionId);
  if (session) {
    alert(`Attendance Session\nDate: ${session.date}\nDescription: ${session.description || 'None'}`);
  }
};

// ========== APPROVALS ==========
function renderApprovals() {
  const searchTerm = document.getElementById('searchApprovals').value.toLowerCase();
  
  // Group approvals by event
  const eventMap = {};
  data.approvals.forEach(approval => {
    if (!eventMap[approval.eventId]) {
      const event = data.events.find(e => e.id === approval.eventId);
      eventMap[approval.eventId] = {
        event: event || { name: 'Unknown Event', type: 'Unknown' },
        pending: 0,
        approved: 0
      };
    }
    
    if (approval.status === 'pending') {
      eventMap[approval.eventId].pending++;
    } else if (approval.status === 'approved') {
      eventMap[approval.eventId].approved++;
    }
  });
  
  const events = Object.values(eventMap);
  const filtered = events.filter(item => 
    item.event.name.toLowerCase().includes(searchTerm)
  );
  
  const tbody = document.getElementById('approvalsTable');
  tbody.innerHTML = filtered.map(item => {
    return `
      <tr>
        <td><strong>${item.event.name}</strong></td>
        <td><span class="badge bg-info">${item.event.type}</span></td>
        <td><span class="badge bg-warning">${item.pending}</span></td>
        <td><span class="badge bg-success">${item.approved}</span></td>
        <td>
          <button class="btn btn-sm btn-primary" onclick="manageApprovals('${item.event.id}')">Manage</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="5" class="text-center">No approvals found</td></tr>';
}

window.manageApprovals = function(eventId) {
  const event = data.events.find(e => e.id === eventId);
  if (!event) return;
  
  const pending = data.approvals.filter(a => a.eventId === eventId && a.status === 'pending');
  const approved = data.approvals.filter(a => a.eventId === eventId && a.status === 'approved');
  
  // Render pending list
  const pendingList = document.getElementById('pendingList');
  pendingList.innerHTML = pending.map(approval => {
    const student = data.students.find(s => s.id === approval.studentId);
    return `
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <span>${student ? student.name : 'Unknown'} (${approval.studentId})</span>
        <button class="btn btn-sm btn-success" onclick="approveStudent('${approval.id}')">Approve</button>
      </div>
    `;
  }).join('') || '<div class="list-group-item text-center">No pending approvals</div>';
  
  // Render approved list
  const approvedList = document.getElementById('approvedList');
  approvedList.innerHTML = approved.map(approval => {
    const student = data.students.find(s => s.id === approval.studentId);
    return `
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <span>${student ? student.name : 'Unknown'} (${approval.studentId})</span>
        <button class="btn btn-sm btn-warning" onclick="unapproveStudent('${approval.id}')">Unapprove</button>
      </div>
    `;
  }).join('') || '<div class="list-group-item text-center">No approved students</div>';
  
  const modal = new bootstrap.Modal(document.getElementById('manageApprovalsModal'));
  modal.show();
};

window.approveStudent = async function(approvalId) {
  // Find approval key and update
  const approvalRef = ref(db, 'approvals');
  const snapshot = await get(approvalRef);
  const approvals = snapshot.val();
  
  for (const key in approvals) {
    if (approvals[key].id === approvalId) {
      await update(ref(db, `approvals/${key}`), { status: 'approved' });
      showToast('Student approved');
      break;
    }
  }
};

window.unapproveStudent = async function(approvalId) {
  // Find approval key and update
  const approvalRef = ref(db, 'approvals');
  const snapshot = await get(approvalRef);
  const approvals = snapshot.val();
  
  for (const key in approvals) {
    if (approvals[key].id === approvalId) {
      await update(ref(db, `approvals/${key}`), { status: 'pending' });
      showToast('Student unapproved');
      break;
    }
  }
};

// ========== RESULTS ==========
function renderResults() {
  const tbody = document.getElementById('resultsTable');
  tbody.innerHTML = data.results.map(result => {
    const event = data.events.find(e => e.id === result.eventId);
    return `
      <tr>
        <td><strong>${event ? event.name : 'Unknown Event'}</strong></td>
        <td>${result.first || '-'}</td>
        <td>${result.second || '-'}</td>
        <td>${result.third || '-'}</td>
        <td><span class="badge ${result.status === 'published' ? 'bg-success' : 'bg-warning'}">${result.status}</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="manageResult('${result.id}')">Manage</button>
        </td>
      </tr>
    `;
  }).join('') || '<tr><td colspan="6" class="text-center">No results found</td></tr>';
}

async function saveResult() {
  const eventId = document.getElementById('resultEvent').value;
  const first = document.getElementById('resultFirst').value.trim();
  const second = document.getElementById('resultSecond').value.trim();
  const third = document.getElementById('resultThird').value.trim();
  
  if (!eventId) {
    showToast('Please select an event', 'warning');
    return;
  }
  
  const resultRef = push(ref(db, 'results'));
  await set(resultRef, {
    id: Date.now().toString(),
    eventId,
    first: first || null,
    second: second || null,
    third: third || null,
    status: 'draft',
    timestamp: Date.now()
  });
  
  // Clear form
  document.getElementById('resultFirst').value = '';
  document.getElementById('resultSecond').value = '';
  document.getElementById('resultThird').value = '';
  
  showToast('Result saved as draft');
}

async function publishResult() {
  const eventId = document.getElementById('resultEvent').value;
  const first = document.getElementById('resultFirst').value.trim();
  const second = document.getElementById('resultSecond').value.trim();
  const third = document.getElementById('resultThird').value.trim();
  
  if (!eventId) {
    showToast('Please select an event', 'warning');
    return;
  }
  
  const resultRef = push(ref(db, 'results'));
  await set(resultRef, {
    id: Date.now().toString(),
    eventId,
    first: first || null,
    second: second || null,
    third: third || null,
    status: 'published',
    timestamp: Date.now()
  });
  
  // Clear form
  document.getElementById('resultFirst').value = '';
  document.getElementById('resultSecond').value = '';
  document.getElementById('resultThird').value = '';
  
  showToast('Result published');
}

window.manageResult = function(resultId) {
  const result = data.results.find(r => r.id === resultId);
  if (!result) return;
  
  document.getElementById('manageResultEventId').value = result.eventId;
  document.getElementById('manageResultFirst').value = result.first || '';
  document.getElementById('manageResultSecond').value = result.second || '';
  document.getElementById('manageResultThird').value = result.third || '';
  
  const modal = new bootstrap.Modal(document.getElementById('manageResultsModal'));
  modal.show();
  
  // Update button
  document.getElementById('updateResultBtn').onclick = async () => {
    const first = document.getElementById('manageResultFirst').value.trim();
    const second = document.getElementById('manageResultSecond').value.trim();
    const third = document.getElementById('manageResultThird').value.trim();
    
    // Find result key and update
    const resultRef = ref(db, 'results');
    const snapshot = await get(resultRef);
    const results = snapshot.val();
    
    for (const key in results) {
      if (results[key].id === resultId) {
        await update(ref(db, `results/${key}`), {
          first: first || null,
          second: second || null,
          third: third || null
        });
        showToast('Result updated');
        modal.hide();
        break;
      }
    }
  };
  
  // Delete button
  document.getElementById('deleteResultBtn').onclick = async () => {
    if (!confirm('Delete this result?')) return;
    
    // Find result key and delete
    const resultRef = ref(db, 'results');
    const snapshot = await get(resultRef);
    const results = snapshot.val();
    
    for (const key in results) {
      if (results[key].id === resultId) {
        await remove(ref(db, `results/${key}`));
        showToast('Result deleted');
        modal.hide();
        break;
      }
    }
  };
};

// Helper function to get data from Firebase
async function get(ref) {
  return new Promise((resolve) => {
    onValue(ref, (snapshot) => {
      resolve(snapshot);
    }, { onlyOnce: true });
  });
}
</script>
</body>
</html>