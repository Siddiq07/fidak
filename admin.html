<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Art Fest</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <!-- Embedded Custom Styles -->
    <style>
        :root {
            --sidebar-width: 280px;
            --color-brown: #8B4513;
        }

        body {
            background-color: #f8f9fa;
        }

        /* --- Sidebar Layout --- */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 1.5rem 0;
            transition: all 0.3s ease;
            z-index: 1030;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 1.5rem 1rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid #34495e;
        }
        .sidebar-header a {
            color: #1abc9c;
            text-decoration: none;
        }

        .sidebar-nav {
            flex-grow: 1;
            overflow-y: auto;
            padding-top: 1rem;
        }

        .sidebar .nav-link {
            color: #ecf0f1;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            font-size: 1.05rem;
            transition: all 0.2s ease;
        }
        .sidebar .nav-link i {
            font-size: 1.25rem;
            margin-right: 0.75rem;
        }
        .sidebar .nav-link:hover {
            background-color: #34495e;
        }
        .sidebar .nav-link.active {
            background-color: #1abc9c;
            color: #ffffff;
            font-weight: 600;
        }

        .sidebar-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #34495e;
        }
        .sidebar-footer .btn {
            width: 100%;
        }

        /* --- Main Content --- */
        .main-content {
            padding-left: var(--sidebar-width);
            transition: all 0.3s ease;
        }

        .main-header {
            background-color: #ffffff;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 1020;
        }
        
        .main-header h1 {
            margin: 0;
            font-size: 1.75rem;
        }

        .content-section {
            display: none; /* Hidden by default */
            padding: 2rem;
        }
        .content-section.active-section {
            display: block; /* Shown by JS */
        }
        
        /* --- Mobile Toggle --- */
        .sidebar-toggle {
            font-size: 1.75rem;
            background: none;
            border: none;
            color: #2c3e50;
            display: none; /* Hidden on desktop */
        }

        /* --- Responsive Styles --- */
        @media (max-width: 991.98px) {
            .sidebar {
                transform: translateX(calc(var(--sidebar-width) * -1));
            }
            .sidebar.show {
                transform: translateX(0);
            }
            .main-content {
                padding-left: 0;
            }
            .sidebar-toggle {
                display: block;
            }
        }

        /* --- Custom Components --- */
        .stat-card {
            border: 0;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
        }
        .stat-card .display-4 {
            font-size: 2.5rem;
        }

        /* Event Status Colors */
        .status-Upcoming {
            background-color: var(--bs-danger) !important;
            color: white;
        }
        .status-Result\.Uploaded { /* Fixed selector for dot */
            background-color: var(--color-brown) !important;
            color: white;
        }
        .status-Completed {
            background-color: var(--bs-secondary) !important;
            color: white;
        }

        /* Attendance Toggles */
        .attendance-toggle {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        /* Footer */
        .footer {
            background-color: #343a40;
            color: #adb5bd;
            padding: 1.5rem 0;
            text-align: center;
            font-size: 0.9rem;
        }

        /* Ensure table actions don't wrap */
        .table-actions {
            white-space: nowrap;
        }

        /* Style for lock toggle */
        .form-switch .form-check-input {
            width: 3.5em;
            height: 1.75em;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- 1. Sidebar -->
    <div class="sidebar" id="adminSidebar">
        <!-- Header -->
        <div class="sidebar-header">
            <a href="index.html" title="Back to Home"><i class="bi bi-palette-fill"></i> Art Fest</a>
        </div>
        
        <!-- Navigation -->
        <div class="sidebar-nav">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-target="dashboard">
                        <i class="bi bi-grid-fill"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="students">
                        <i class="bi bi-person-fill"></i> Students
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="teams">
                        <i class="bi bi-people-fill"></i> Teams
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="events">
                        <i class="bi bi-calendar-event-fill"></i> Events
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="schedule">
                        <i class="bi bi-clock-fill"></i> Schedule
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="attendance">
                        <i class="bi bi-clipboard-check-fill"></i> Attendance
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="results">
                        <i class="bi bi-trophy-fill"></i> Results
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-target="notifications">
                        <i class="bi bi-bell-fill"></i> Notifications
                    </a>
                </li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="sidebar-footer">
            <a href="index.html" class="btn btn-outline-danger" id="logoutBtn">
                <i class="bi bi-box-arrow-left"></i> Logout
            </a>
        </div>
    </div>

    <!-- 2. Main Content Area -->
    <div class="main-content">
        
        <!-- Header Bar -->
        <header class="main-header shadow-sm">
            <div>
                <button class="sidebar-toggle" id="sidebarToggle" title="Toggle Menu">
                    <i class="bi bi-list"></i>
                </button>
                <h1 id="page-title" class="d-inline-block ms-3">Dashboard</h1>
            </div>
            <a href="index.html" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-house-door-fill me-1"></i> Back to Home Page
            </a>
        </header>

        <!-- Page Content -->
        <main>

            <!-- =======================
            Section 1: Dashboard
            ======================== -->
            <div id="dashboard" class="content-section active-section">
                
                <!-- Stat Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-bg-primary h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Students</h5>
                                    <span class="display-4 fw-bold" id="stat-total-students">0</span>
                                </div>
                                <i class="bi bi-people-fill display-3 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-bg-success h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Teams</h5>
                                    <span class="display-4 fw-bold" id="stat-total-teams">0</span>
                                </div>
                                <i class="bi bi-flag-fill display-3 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-bg-warning h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Pending Events</h5>
                                    <span class="display-4 fw-bold" id="stat-pending-events">0</span>
                                </div>
                                <i class="bi bi-exclamation-triangle-fill display-3 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card stat-card text-bg-info h-100">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title">Total Events</h5>
                                    <span class="display-4 fw-bold" id="stat-total-events">0</span>
                                </div>
                                <i class="bi bi-check-all display-3 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Team Scores -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h4 class="mb-0">Live Team Scores</h4>
                    </div>
                    <div class="card-body" id="dashboard-team-scores">
                        <!-- Scores will be dynamically inserted here -->
                        <p class="text-muted">No teams created yet.</p>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 2: Students
            ======================== -->
            <div id="students" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Students Management</h2>
                    <button class="btn btn-primary" id="addStudentBtn">
                        <i class="bi bi-plus-circle-fill me-1"></i> Add / Upload Students
                    </button>
                </div>
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Student List</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Chess Number</th>
                                        <th>Name</th>
                                        <th>Team</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentTableBody">
                                    <!-- Students will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 3: Teams
            ======================== -->
            <div id="teams" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Teams Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#teamModal" id="addTeamBtn">
                        <i class="bi bi-plus-circle-fill me-1"></i> Create Team
                    </button>
                </div>
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Team List</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Team Name</th>
                                        <th>Team Leader</th>
                                        <th>Members</th>
                                        <th>Password</th>
                                        <th>Leader Page</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="teamTableBody">
                                    <!-- Teams will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 4: Events
            ======================== -->
            <div id="events" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Events Management</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#eventModal" id="addEventBtn">
                        <i class="bi bi-plus-circle-fill me-1"></i> Create Event
                    </button>
                </div>
                
                <!-- Pending Approvals -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">Pending Approvals</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                        <th>Team</th>
                                        <th>Participant</th>
                                        <th>Submitted On</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="pendingEventsTableBody">
                                    <!-- Pending events will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Approved Participants -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Approved Participants</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                        <th>Participant</th>
                                        <th>Team</th>
                                        <th>Approved On</th>
                                    </tr>
                                </thead>
                                <tbody id="approvedEventsTableBody">
                                    <!-- Approved participants will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- All Events -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">All Events</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Event Name</th>
                                        <th>Type</th>
                                        <th>Points (1st/2nd/3rd)</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="eventTableBody">
                                    <!-- Events will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 5: Schedule
            ======================== -->
            <div id="schedule" class="content-section">
                <h2>Program Schedule</h2>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered text-center">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Stage 1 (Main)</th>
                                        <th>Stage 2 (Hall A)</th>
                                        <th>Non-Stage (Lobby)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>09:00 - 10:00</td>
                                        <td>Inauguration</td>
                                        <td>-</td>
                                        <td>Painting Begins</td>
                                    </tr>
                                    <tr>
                                        <td>10:00 - 11:00</td>
                                        <td id="schedule-10-main">Solo Dance</td>
                                        <td id="schedule-10-hallA">Group Play</td>
                                        <td id="schedule-10-lobby">Painting</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 6: Attendance
            ======================== -->
            <div id="attendance" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Mark Attendance</h2>
                    <div class="w-50">
                        <label for="team-filter" class="form-label">Filter by Team</label>
                        <select class="form-select" id="team-filter">
                            <option value="all" selected>All Students</option>
                            <!-- Teams will be dynamically inserted here -->
                        </select>
                    </div>
                </div>
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Chess No</th>
                                        <th>Name</th>
                                        <th>Team</th>
                                        <th>Status</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Attendance will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn btn-success float-end" id="saveAttendanceBtn"><i class="bi bi-save-fill me-1"></i> Save Attendance</button>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 7: Results
            ======================== -->
            <div id="results" class="content-section">
                <h2>Results Management</h2>
                <div class="card shadow-sm mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Upload Results</h5>
                    </div>
                    <div class="card-body">
                        <form id="resultsForm">
                            <div class="mb-3">
                                <label for="resultEvent" class="form-label">Select Event</label>
                                <select class="form-select" id="resultEvent" required>
                                    <option value="">Select event to score...</option>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="firstPlace" class="form-label">1st Place</label>
                                    <select class="form-select" id="firstPlace">
                                        <option value="none">No Participant</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="secondPlace" class="form-label">2nd Place</label>
                                    <select class="form-select" id="secondPlace">
                                        <option value="none">No Participant</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="thirdPlace" class="form-label">3rd Place</label>
                                    <select class="form-select" id="thirdPlace">
                                        <option value="none">No Participant</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Upload & Mark Completed</button>
                        </form>
                    </div>
                </div>

                <!-- Published Results Table -->
                <div class="card shadow-sm">
                    <div class="card-header">
                        <h5 class="mb-0">Published Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Event</th>
                                        <th>1st Place</th>
                                        <th>2nd Place</th>
                                        <th>3rd Place</th>
                                    </tr>
                                </thead>
                                <tbody id="publishedResultsTableBody">
                                    <!-- Results will be dynamically inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- =======================
            Section 8: Notifications
            ======================== -->
            <div id="notifications" class="content-section">
                <h2>Notifications</h2>
                <div class="row g-4">
                    <div class="col-lg-5">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Send Notification</h5>
                            </div>
                            <div class="card-body">
                                <form id="notificationForm">
                                    <div class="mb-3">
                                        <label for="notifyTo" class="form-label">To</label>
                                        <select class="form-select" id="notifyTo" required>
                                            <option value="all">All Users</option>
                                            <option value="leaders">Team Leaders Only</option>
                                            <option value="participants">Participants Only</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="notifyTitle" class="form-label">Title</label>
                                        <input type="text" class="form-control" id="notifyTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="notifyMessage" class="form-label">Message</label>
                                        <textarea class="form-control" id="notifyMessage" rows="5" required></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Send Notification</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="card shadow-sm">
                            <div class="card-header">
                                <h5 class="mb-0">Sent History</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>To</th>
                                                <th>Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="notificationHistoryTable">
                                            <!-- History will be dynamically inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Footer -->
        <footer class="footer mt-auto">
            &copy; <span id="current-year"></span> Art Fest Management System | Admin Portal
        </footer>

    </div>
    
    <!-- =======================
    MODALS
    ======================== -->

    <!-- Add/Edit Student Modal -->
    <div class="modal fade" id="studentModal" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="studentForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="studentModalLabel">Add Student</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Nav Tabs -->
                        <ul class="nav nav-tabs" id="studentAddTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-add" type="button" role="tab" aria-controls="manual-add" aria-selected="true">Add Manually</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="excel-tab" data-bs-toggle="tab" data-bs-target="#excel-upload" type="button" role="tab" aria-controls="excel-upload" aria-selected="false">Upload Excel</button>
                            </li>
                        </ul>
                        <!-- Tab Content -->
                        <div class="tab-content pt-3" id="studentAddTabsContent">
                            <div class="tab-pane fade show active" id="manual-add" role="tabpanel" aria-labelledby="manual-tab">
                                <input type="hidden" id="student-id">
                                <div class="mb-3">
                                    <label for="studentName" class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="studentName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="studentChess" class="form-label">Chess Number</label>
                                    <input type="text" class="form-control" id="studentChess" required>
                                </div>
                                <div class="mb-3">
                                    <label for="studentTeam" class="form-label">Assign to Team</label>
                                    <select class="form-select" id="studentTeam">
                                        <option value="null">Unassigned</option>
                                        <!-- Teams will be dynamically inserted here -->
                                    </select>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="excel-upload" role="tabpanel" aria-labelledby="excel-tab">
                                <p>Upload a .csv or .xlsx file with columns: <strong>Name, ChessNumber</strong></p>
                                <input type="file" class="form-control" id="excelFile" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                                <button type="button" class="btn btn-primary mt-3" id="uploadExcelBtn">Upload File</button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="saveStudentBtn">Save Student</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit Team Modal -->
    <div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="teamForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="teamModalLabel">Create New Team</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="team-id">
                        <div class="mb-3">
                            <label for="teamName" class="form-label">Team Name</label>
                            <input type="text" class="form-control" id="teamName" required>
                        </div>
                        <div class="mb-3">
                            <label for="teamLeader" class="form-label">Assign Team Leader</label>
                            <select class="form-select" id="teamLeader" required>
                                <option value="">Choose a student...</option>
                                <!-- Student options will be dynamically inserted here -->
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="saveTeamBtn">Save Team</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Event Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="eventForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">Create New Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="event-id">
                        <div class="mb-3">
                            <label for="eventName" class="form-label">Event Name</label>
                            <input type="text" class="form-control" id="eventName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="eventDuration" class="form-label">Duration (e.g., "30 mins")</label>
                                <input type="text" class="form-control" id="eventDuration" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="eventMembers" class="form-label">Members Allowed (per team)</label>
                                <input type="number" class="form-control" id="eventMembers" value="1" min="1" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-block">Type</label>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="eventType" id="typeStage" value="Stage" checked>
                                <label class="form-check-label" for="typeStage">Stage</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="eventType" id="typeNonStage" value="Non-Stage">
                                <label class="form-check-label" for="typeNonStage">Non-Stage</label>
                            </div>
                        </div>
                        <hr>
                        <label class="form-label d-block fw-bold">Event Points</label>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="eventPoints1" class="form-label">1st Place Points</label>
                                <input type="number" class="form-control" id="eventPoints1" value="10" min="0" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="eventPoints2" class="form-label">2nd Place Points</label>
                                <input type="number" class="form-control" id="eventPoints2" value="5" min="0" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="eventPoints3" class="form-label">3rd Place Points</label>
                                <input type="number" class="form-control" id="eventPoints3" value="3" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary" id="saveEventBtn">Save Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Set Password Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="passwordForm">
                    <div class="modal-header">
                        <h5 class="modal-title" id="passwordModalLabel">Set Password for [Team]</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="password-team-id">
                        <div class="mb-3">
                            <label for="teamPassword" class="form-label">New Password</label>
                            <input type="text" class="form-control" id="teamPassword" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Set Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Deletion</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmDeleteModalBody">
                    Are you sure you want to delete this item?
                    <p class="text-danger small mt-2">This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap 5 JS Bundle (FIXED integrity attribute) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- Custom Page-Switching & Dynamic Logic Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // --- Real-Time Channel ---
            // This channel sends a "db-updated" message to all other tabs
            const channel = new BroadcastChannel('artFestChannel');
            
            // --- Toast (Notification Pop-up) ---
            // We create a toast container and add it to the body
            const toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
            
            function showToast(message, type = 'success') {
                const toastEl = document.createElement('div');
                toastEl.className = `toast align-items-center text-bg-${type} border-0`;
                toastEl.setAttribute('role', 'alert');
                toastEl.setAttribute('aria-live', 'assertive');
                toastEl.setAttribute('aria-atomic', 'true');
                
                toastEl.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                `;
                toastContainer.appendChild(toastEl);
                
                const toast = new bootstrap.Toast(toastEl);
                toast.show();
                
                toastEl.addEventListener('hidden.bs.toast', () => {
                    toastEl.remove();
                });
            }

            // --- Database ---
            let db = {};
            const defaultDB = {
                students: [],
                teams: [],
                events: [],
                participations: [], // {id, studentId, eventId, teamId, status: 'Pending'/'Approved'/'Rejected', submittedAt}
                results: [], // {eventId, 1st, 2nd, 3rd}
                notifications: [] // {id, to, title, message, date}
            };

            function loadDB() {
                let data = JSON.parse(localStorage.getItem('artFestDB'));
                if (!data) {
                    data = defaultDB;
                }
                // Ensure all keys exist
                db = { ...defaultDB, ...data };
            }

            function saveDB() {
                localStorage.setItem('artFestDB', JSON.stringify(db));
                // Send a broadcast to all other open tabs
                channel.postMessage('db-updated');
                // Re-render the current page
                renderAll();
                showToast('Changes saved successfully!');
            }

            // --- Modals ---
            const studentModal = new bootstrap.Modal(document.getElementById('studentModal'));
            const studentForm = document.getElementById('studentForm');
            const teamModal = new bootstrap.Modal(document.getElementById('teamModal'));
            const teamForm = document.getElementById('teamForm');
            const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
            const eventForm = document.getElementById('eventForm');
            const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
            const passwordForm = document.getElementById('passwordForm');
            const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            
            // --- Table Bodies ---
            const studentTableBody = document.getElementById('studentTableBody');
            const teamTableBody = document.getElementById('teamTableBody');
            const eventTableBody = document.getElementById('eventTableBody');
            const attendanceTableBody = document.getElementById('attendanceTableBody');
            const pendingEventsTableBody = document.getElementById('pendingEventsTableBody');
            const approvedEventsTableBody = document.getElementById('approvedEventsTableBody');
            const publishedResultsTableBody = document.getElementById('publishedResultsTableBody');
            const notificationHistoryTable = document.getElementById('notificationHistoryTable');

            // --- Dropdowns ---
            const teamLeaderSelect = document.getElementById('teamLeader');
            const studentTeamSelect = document.getElementById('studentTeam');
            const resultEventSelect = document.getElementById('resultEvent');
            const teamFilterSelect = document.getElementById('team-filter');
            
            // --- Result Form Dropdowns ---
            const firstPlaceSelect = document.getElementById('firstPlace');
            const secondPlaceSelect = document.getElementById('secondPlace');
            const thirdPlaceSelect = document.getElementById('thirdPlace');

            // --- Stats ---
            const statStudents = document.getElementById('stat-total-students');
            const statTeams = document.getElementById('stat-total-teams');
            const statEvents = document.getElementById('stat-total-events');
            const statPending = document.getElementById('stat-pending-events');
            const dashboardTeamScores = document.getElementById('dashboard-team-scores');

            // =================================================================
            // RENDER FUNCTIONS (To draw data into tables)
            // =================================================================

            function renderAll() {
                renderStudents();
                renderTeams();
                renderEvents();
                renderAttendance();
                renderParticipations();
                renderResults();
                renderNotifications();
                renderStats();
            }

            function renderStudents() {
                studentTableBody.innerHTML = '';
                let hasStudents = db.students.length > 0;
                
                if (!hasStudents) {
                    studentTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No students added yet.</td></tr>';
                }

                db.students.forEach(student => {
                    const team = db.teams.find(t => t.id === student.teamId);
                    const teamName = team ? team.name : '<span class="text-muted">Unassigned</span>';
                    
                    const studentRow = document.createElement('tr');
                    studentRow.dataset.id = student.id;
                    studentRow.innerHTML = `
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${teamName}</td>
                        <td class="text-end table-actions">
                            <button class="btn btn-sm btn-outline-primary btn-edit-student" title="Edit">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-student" title="Delete">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </td>`;
                    studentTableBody.appendChild(studentRow);
                });
            }

            function renderTeams() {
                teamTableBody.innerHTML = '';
                teamLeaderSelect.innerHTML = '<option value="">Choose a student...</option>';
                studentTeamSelect.innerHTML = '<option value="null">Unassigned</option>';
                teamFilterSelect.innerHTML = '<option value="all" selected>All Students</option>';

                if (db.teams.length === 0) {
                    teamTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No teams created yet.</td></tr>';
                }

                // Populate student dropdowns
                db.students.forEach(student => {
                    const leaderOption = `<option value="${student.id}">${student.name} (${student.id})</option>`;
                    teamLeaderSelect.innerHTML += leaderOption;
                });

                db.teams.forEach(team => {
                    const leader = db.students.find(s => s.id === team.leaderId);
                    const leaderName = leader ? leader.name : '<span class="text-danger">No Leader</span>';
                    const memberCount = db.students.filter(s => s.teamId === team.id).length;
                    const isLocked = team.isLocked ? "checked" : "";

                    const teamRow = document.createElement('tr');
                    teamRow.dataset.id = team.id;
                    teamRow.innerHTML = `
                        <td><strong>${team.name}</strong></td>
                        <td>${leaderName}</td>
                        <td>${memberCount}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary btn-set-password">
                                <i class="bi bi-key-fill me-1"></i> Set
                            </button>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input btn-lock-team" type="checkbox" role="switch" ${isLocked}>
                            </div>
                        </td>
                        <td class="text-end table-actions">
                            <button class="btn btn-sm btn-outline-primary btn-edit-team" title="Edit">
                                <i class="bi bi-pencil-fill"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-team" title="Delete">
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </td>`;
                    teamTableBody.appendChild(teamRow);
                    
                    // Add to student team assignment dropdown
                    const teamOption = `<option value="${team.id}">${team.name}</option>`;
                    studentTeamSelect.innerHTML += teamOption;
                    teamFilterSelect.innerHTML += teamOption;
                });
            }

            function renderEvents() {
                eventTableBody.innerHTML = '';
                resultEventSelect.innerHTML = '<option value="">Select event to score...</option>';
                
                if (db.events.length === 0) {
                    eventTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No events created yet.</td></tr>';
                }

                db.events.forEach(event => {
                    const statusClass = event.status.replace(" ", ".");
                    const eventRow = document.createElement('tr');
                    eventRow.dataset.id = event.id;
                    eventRow.innerHTML = `
                        <td>${event.name}</td>
                        <td>${event.type}</td>
                        <td>${event.points[0]}/${event.points[1]}/${event.points[2]}</td>
                        <td><span class="badge status-${statusClass}">${event.status}</span></td>
                        <td class="text-end table-actions">
                            <button class="btn btn-sm btn-outline-primary btn-edit-event" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-delete-event" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary btn-lock-event" title="Lock Submissions">
                                <i class="bi bi-lock-fill"></i>
                            </button>
                        </td>`;
                    eventTableBody.appendChild(eventRow);

                    // Add to Results Dropdown if not already completed
                    if (event.status !== 'Completed') {
                        const resultOption = `<option value="${event.id}">${event.name}</option>`;
                        resultEventSelect.innerHTML += resultOption;
                    }
                });
            }

            function renderAttendance() {
                attendanceTableBody.innerHTML = '';
                const selectedTeamId = teamFilterSelect.value;
                
                const studentsToRender = (selectedTeamId === 'all') 
                    ? db.students 
                    : db.students.filter(s => s.teamId === parseInt(selectedTeamId));

                if (studentsToRender.length === 0) {
                    attendanceTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No students in this view.</td></tr>';
                }

                studentsToRender.forEach(student => {
                    const team = db.teams.find(t => t.id === student.teamId);
                    const teamName = team ? team.name : '<span class="text-muted">Unassigned</span>';
                    const status = student.attendance?.status || 'Absent';
                    const timestamp = student.attendance?.timestamp ? new Date(student.attendance.timestamp).toLocaleString() : 'N/A';
                    
                    const row = document.createElement('tr');
                    row.dataset.id = student.id;
                    row.innerHTML = `
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${teamName}</td>
                        <td>
                            <span class="badge fs-6 attendance-toggle text-bg-${status === 'Present' ? 'success' : 'danger'}" data-status="${status}">
                                ${status}
                            </span>
                        </td>
                        <td>${timestamp}</td>
                    `;
                    attendanceTableBody.appendChild(row);
                });
            }
            
            function renderParticipations() {
                pendingEventsTableBody.innerHTML = '';
                approvedEventsTableBody.innerHTML = '';
                let pendingCount = 0;

                const pending = db.participations.filter(p => p.status === 'Pending');
                const approved = db.participations.filter(p => p.status === 'Approved');

                if (pending.length === 0) {
                    pendingEventsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No pending approvals.</td></tr>';
                } else {
                    pending.forEach(p => {
                        const event = db.events.find(e => e.id === p.eventId);
                        const student = db.students.find(s => s.id === p.studentId);
                        const team = db.teams.find(t => t.id === p.teamId);
                        if (!event || !student || !team) return;
                        
                        pendingCount++;
                        const row = document.createElement('tr');
                        row.dataset.id = p.id;
                        row.innerHTML = `
                            <td>${event.name}</td>
                            <td>${team.name}</td>
                            <td>${student.name} (${student.id})</td>
                            <td>${new Date(p.submittedAt).toLocaleString()}</td>
                            <td class="text-end table-actions">
                                <button class="btn btn-sm btn-success btn-approve-event"><i class="bi bi-check-lg"></i> Approve</button>
                                <button class="btn btn-sm btn-danger btn-reject-event"><i class="bi bi-x-lg"></i> Reject</button>
                            </td>
                        `;
                        pendingEventsTableBody.appendChild(row);
                    });
                }
                
                if (approved.length === 0) {
                    approvedEventsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No approved participants yet.</td></tr>';
                } else {
                    approved.forEach(p => {
                        const event = db.events.find(e => e.id === p.eventId);
                        const student = db.students.find(s => s.id === p.studentId);
                        const team = db.teams.find(t => t.id === p.teamId);
                        if (!event || !student || !team) return;

                        const row = document.createElement('tr');
                        row.dataset.id = p.id;
                        row.innerHTML = `
                            <td>${event.name}</td>
                            <td>${student.name} (${student.id})</td>
                            <td>${team.name}</td>
                            <td>${new Date(p.approvedAt).toLocaleString()}</td>
                        `;
                        approvedEventsTableBody.appendChild(row);
                    });
                }
                statPending.textContent = pendingCount;
            }
            
            function renderResults() {
                publishedResultsTableBody.innerHTML = '';
                if (db.results.length === 0) {
                    publishedResultsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No results published yet.</td></tr>';
                }

                db.results.forEach(r => {
                    const event = db.events.find(e => e.id === r.eventId);
                    
                    const getWinnerName = (studentId) => {
                        if (studentId === 'none') return '<em class="text-muted">N/A</em>';
                        const student = db.students.find(s => s.id === studentId);
                        const team = db.teams.find(t => t.id === student?.teamId);
                        return `${student.name} (${team?.name || 'N/A'})`;
                    };

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${event?.name || 'Unknown Event'}</strong></td>
                        <td>${getWinnerName(r.first)}</td>
                        <td>${getWinnerName(r.second)}</td>
                        <td>${getWinnerName(r.third)}</td>
                    `;
                    publishedResultsTableBody.appendChild(row);
                });
            }
            
            function renderNotifications() {
                notificationHistoryTable.innerHTML = '';
                if (db.notifications.length === 0) {
                    notificationHistoryTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No notifications sent yet.</td></tr>';
                }
                
                // Show newest first
                [...db.notifications].reverse().forEach(n => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${n.title}</td>
                        <td><span class="text-capitalize">${n.to}</span></td>
                        <td>${new Date(n.date).toLocaleString()}</td>
                    `;
                    notificationHistoryTable.appendChild(row);
                });
            }

            function renderStats() {
                statStudents.textContent = db.students.length;
                statTeams.textContent = db.teams.length;
                statEvents.textContent = db.events.length;
                
                // Render dashboard team scores
                dashboardTeamScores.innerHTML = '';
                if (db.teams.length === 0) {
                    dashboardTeamScores.innerHTML = '<p class="text-muted">No teams created yet.</p>';
                    return;
                }
                
                const maxScore = Math.max(...db.teams.map(t => t.score), 10); // Avoid division by zero
                db.teams.forEach(team => {
                    const percent = (team.score / maxScore) * 100;
                    const scoreBar = `
                        <div class="mb-3">
                            <label class="form-label">${team.name} (${team.score} pts)</label>
                            <div class="progress" style="height: 25px;">
                                <div class="progress-bar" role="progressbar" style="width: ${percent}%" aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100">${team.score} pts</div>
                            </div>
                        </div>`;
                    dashboardTeamScores.innerHTML += scoreBar;
                });
            }

            // =================================================================
            // STUDENT: Add / Edit / Delete Logic
            // =================================================================

            // Open "Add Student" Modal
            document.getElementById('addStudentBtn').addEventListener('click', () => {
                studentForm.reset();
                document.getElementById('student-id').value = '';
                document.getElementById('studentModalLabel').textContent = 'Add Student';
                document.getElementById('studentChess').readOnly = false;
                document.getElementById('studentTeam').value = 'null';
                new bootstrap.Tab(document.getElementById('manual-tab')).show();
                studentModal.show();
            });

            // "Save" button in Student modal (handles both Add and Edit)
            studentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                // We only handle the manual tab for now
                const id = document.getElementById('student-id').value;
                const name = document.getElementById('studentName').value;
                const chessNum = document.getElementById('studentChess').value; 
                const teamId = document.getElementById('studentTeam').value;

                if (id) { // This is an Edit
                    const student = db.students.find(s => s.id === parseInt(id));
                    student.name = name;
                    student.teamId = (teamId === 'null' ? null : parseInt(teamId));
                } else { // This is an Add
                    // Check if chess number already exists
                    if (db.students.some(s => s.id === parseInt(chessNum))) {
                        showToast('Error: Chess Number already exists.', 'danger');
                        return;
                    }
                    db.students.push({
                        id: parseInt(chessNum), // Use chess number as ID
                        name: name,
                        teamId: (teamId === 'null' ? null : parseInt(teamId)),
                        attendance: { status: 'Absent', timestamp: null } // Default attendance
                    });
                }
                
                saveDB();
                studentModal.hide();
            });

            // "Edit" or "Delete" button click in Student table
            studentTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const row = e.target.closest('tr');
                const id = parseInt(row.dataset.id);

                if (button.classList.contains('btn-edit-student')) {
                    // Edit
                    const student = db.students.find(s => s.id === id);
                    document.getElementById('student-id').value = student.id;
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('studentChess').value = student.id;
                    document.getElementById('studentChess').readOnly = true; // Don't allow editing ID
                    document.getElementById('studentTeam').value = student.teamId || 'null';
                    document.getElementById('studentModalLabel').textContent = 'Edit Student';
                    
                    new bootstrap.Tab(document.getElementById('manual-tab')).show();
                    studentModal.show();

                } else if (button.classList.contains('btn-delete-student')) {
                    // Delete
                    const student = db.students.find(s => s.id === id);
                    showDeleteModal(`student "${student.name}"`, () => {
                        db.students = db.students.filter(s => s.id !== id);
                        
                        // Also remove from team leader if they were one
                        db.teams.forEach(team => {
                            if (team.leaderId === id) {
                                team.leaderId = null;
                            }
                        });
                        
                        // Remove any participations
                        db.participations = db.participations.filter(p => p.studentId !== id);
                        
                        saveDB();
                    });
                }
            });

            // =================================================================
            // TEAM: Add / Edit / Delete Logic
            // =================================================================

            // Open "Add Team" Modal
            document.getElementById('addTeamBtn').addEventListener('click', () => {
                teamForm.reset();
                document.getElementById('team-id').value = '';
                document.getElementById('teamModalLabel').textContent = 'Create New Team';
                renderTeams(); // Re-render dropdowns
            });

            // "Save" button in Team modal (handles both Add and Edit)
            teamForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('team-id').value;
                const name = document.getElementById('teamName').value;
                const leaderId = parseInt(document.getElementById('teamLeader').value);

                // Check if team name already exists
                if (db.teams.some(t => t.name === name && t.id !== parseInt(id))) {
                    showToast('Error: Team name already exists.', 'danger');
                    return;
                }
                
                // Check if leader is already leading another team
                if (db.teams.some(t => t.leaderId === leaderId && t.id !== parseInt(id))) {
                    showToast('Error: This student is already leading another team.', 'danger');
                    return;
                }

                // Unassign old leader's teamId if it's an edit and leader changed
                if (id) {
                    const oldTeam = db.teams.find(t => t.id === parseInt(id));
                    if (oldTeam.leaderId && oldTeam.leaderId !== leaderId) {
                        const oldLeader = db.students.find(s => s.id === oldTeam.leaderId);
                        if (oldLeader) oldLeader.teamId = null;
                    }
                }

                let newTeamId;
                if (id) { // Edit
                    const team = db.teams.find(t => t.id === parseInt(id));
                    team.name = name;
                    team.leaderId = leaderId;
                    newTeamId = team.id;
                } else { // Add
                    newTeamId = db.teams.length > 0 ? Math.max(...db.teams.map(t => t.id)) + 1 : 1;
                    db.teams.push({
                        id: newTeamId,
                        name: name,
                        leaderId: leaderId,
                        password: 'pass' + newTeamId, // Default password
                        isLocked: false,
                        score: 0 // Default score
                    });
                }

                // Assign new student to team
                const student = db.students.find(s => s.id === leaderId);
                if (student) student.teamId = newTeamId;

                saveDB();
                teamModal.hide();
            });

            // Clicks within the Team table
            teamTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button, .btn-lock-team');
                if (!button) return;

                const row = e.target.closest('tr');
                const id = parseInt(row.dataset.id);
                const team = db.teams.find(t => t.id === id);
                if (!team) return;

                if (button.classList.contains('btn-edit-team')) {
                    // Edit
                    document.getElementById('team-id').value = team.id;
                    document.getElementById('teamName').value = team.name;
                    // Re-render dropdown to include all students, then select the current leader
                    renderTeams(); 
                    document.getElementById('teamLeader').value = team.leaderId;
                    document.getElementById('teamModalLabel').textContent = 'Edit Team';
                    teamModal.show();
                } 
                else if (button.classList.contains('btn-delete-team')) {
                    // Delete
                    showDeleteModal(`team "${team.name}"`, () => {
                        db.teams = db.teams.filter(t => t.id !== id);
                        // Unassign students from this team
                        db.students.forEach(s => {
                            if (s.teamId === id) s.teamId = null;
                        });
                        saveDB();
                    });
                }
                else if (button.classList.contains('btn-set-password')) {
                    // Set Password
                    document.getElementById('password-team-id').value = team.id;
                    document.getElementById('passwordModalLabel').textContent = `Set Password for ${team.name}`;
                    document.getElementById('teamPassword').value = team.password;
                    passwordModal.show();
                }
                else if (button.classList.contains('btn-lock-team')) {
                    // Lock Team (it's a checkbox)
                    team.isLocked = button.checked;
                    saveDB(); // Save the lock state
                }
            });

            // Save new password
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const teamId = parseInt(document.getElementById('password-team-id').value);
                const newPassword = document.getElementById('teamPassword').value;
                
                const team = db.teams.find(t => t.id === teamId);
                team.password = newPassword;
                
                saveDB();
                passwordModal.hide();
            });


            // =================================================================
            // EVENT: Add / Edit / Delete Logic
            // =================================================================

            // Open "Add Event" Modal
            document.getElementById('addEventBtn').addEventListener('click', () => {
                eventForm.reset();
                document.getElementById('event-id').value = '';
                document.getElementById('eventModalLabel').textContent = 'Create New Event';
                // Set default points
                document.getElementById('eventPoints1').value = 10;
                document.getElementById('eventPoints2').value = 5;
                document.getElementById('eventPoints3').value = 3;
            });

            // "Save" button in Event modal
            eventForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const id = document.getElementById('event-id').value;
                const name = document.getElementById('eventName').value;
                const duration = document.getElementById('eventDuration').value;
                const type = document.querySelector('input[name="eventType"]:checked').value;
                const members = parseInt(document.getElementById('eventMembers').value);
                const points = [
                    parseInt(document.getElementById('eventPoints1').value),
                    parseInt(document.getElementById('eventPoints2').value),
                    parseInt(document.getElementById('eventPoints3').value)
                ];

                if (id) { // Edit
                    const event = db.events.find(e => e.id === parseInt(id));
                    event.name = name;
                    event.duration = duration;
                    event.type = type;
                    event.members = members;
                    event.points = points;
                } else { // Add
                    const newId = db.events.length > 0 ? Math.max(...db.events.map(e => e.id)) + 1 : 1;
                    db.events.push({
                        id: newId,
                        name: name,
                        duration: duration,
                        type: type,
                        members: members,
                        points: points,
                        status: "Upcoming" // Default status
                    });
                }
                saveDB();
                eventModal.hide();
            });

            // "Edit" or "Delete" button click in Event table
            eventTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const row = e.target.closest('tr');
                const id = parseInt(row.dataset.id);

                if (button.classList.contains('btn-edit-event')) {
                    // Edit
                    const event = db.events.find(e => e.id === id);
                    document.getElementById('event-id').value = event.id;
                    document.getElementById('eventName').value = event.name;
                    document.getElementById('eventDuration').value = event.duration;
                    document.getElementById('eventMembers').value = event.members;
                    document.getElementById(event.type === 'Stage' ? 'typeStage' : 'typeNonStage').checked = true;
                    document.getElementById('eventPoints1').value = event.points[0];
                    document.getElementById('eventPoints2').value = event.points[1];
                    document.getElementById('eventPoints3').value = event.points[2];
                    document.getElementById('eventModalLabel').textContent = 'Edit Event';
                    eventModal.show();

                } else if (button.classList.contains('btn-delete-event')) {
                    // Delete
                    const event = db.events.find(e => e.id === id);
                    showDeleteModal(`event "${event.name}"`, () => {
                        db.events = db.events.filter(e => e.id !== id);
                        // Also delete participations and results
                        db.participations = db.participations.filter(p => p.eventId !== id);
                        db.results = db.results.filter(r => r.eventId !== id);
                        saveDB();
                    });
                }
            });

            // =================================================================
            // PARTICIPATION: Approve / Reject Logic
            // =================================================================
            
            pendingEventsTableBody.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                const row = e.target.closest('tr');
                const id = parseInt(row.dataset.id);
                const participation = db.participations.find(p => p.id === id);
                if (!participation) return;

                if (button.classList.contains('btn-approve-event')) {
                    participation.status = 'Approved';
                    participation.approvedAt = new Date().toISOString();
                } else if (button.classList.contains('btn-reject-event')) {
                    participation.status = 'Rejected';
                }
                saveDB();
            });
            
            // =================================================================
            // ATTENDANCE: Toggle & Save Logic
            // =================================================================
            
            // Toggle status on click
            attendanceTableBody.addEventListener('click', (e) => {
                const badge = e.target.closest('.attendance-toggle');
                if (!badge) return;
                
                const currentStatus = badge.dataset.status;
                const newStatus = currentStatus === 'Present' ? 'Absent' : 'Present';
                
                badge.dataset.status = newStatus;
                badge.textContent = newStatus;
                badge.classList.toggle('text-bg-success');
                badge.classList.toggle('text-bg-danger');
            });

            // Save all attendance
            document.getElementById('saveAttendanceBtn').addEventListener('click', () => {
                const rows = attendanceTableBody.querySelectorAll('tr');
                rows.forEach(row => {
                    const id = parseInt(row.dataset.id);
                    const student = db.students.find(s => s.id === id);
                    if (student) {
                        const status = row.querySelector('.attendance-toggle').dataset.status;
                        student.attendance = {
                            status: status,
                            timestamp: new Date().toISOString()
                        };
                    }
                });
                saveDB(); // Save all changes
            });
            
            // Filter attendance by team
            teamFilterSelect.addEventListener('change', renderAttendance);

            // =================================================================
            // RESULTS: Form Logic
            // =================================================================
            
            // When event is selected, populate participant dropdowns
            resultEventSelect.addEventListener('change', (e) => {
                const eventId = parseInt(e.target.value);
                firstPlaceSelect.innerHTML = '<option value="none">No Participant</option>';
                secondPlaceSelect.innerHTML = '<option value="none">No Participant</option>';
                thirdPlaceSelect.innerHTML = '<option value="none">No Participant</option>';
                
                if (!eventId) return;

                const approvedParticipants = db.participations.filter(p => p.eventId === eventId && p.status === 'Approved');
                
                approvedParticipants.forEach(p => {
                    const student = db.students.find(s => s.id === p.studentId);
                    const option = `<option value="${student.id}">${student.name} (${student.id})</option>`;
                    firstPlaceSelect.innerHTML += option;
                    secondPlaceSelect.innerHTML += option;
                    thirdPlaceSelect.innerHTML += option;
                });
            });

            // Handle results form submission
            document.getElementById('resultsForm').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const eventId = parseInt(document.getElementById('resultEvent').value);
                const first = parseInt(document.getElementById('firstPlace').value) || 'none';
                const second = parseInt(document.getElementById('secondPlace').value) || 'none';
                const third = parseInt(document.getElementById('thirdPlace').value) || 'none';

                if (!eventId) {
                    showToast('Please select an event.', 'danger');
                    return;
                }
                
                const event = db.events.find(ev => ev.id === eventId);
                
                // Remove old result if it exists
                db.results = db.results.filter(r => r.eventId !== eventId);
                // Add new result
                db.results.push({ eventId, first, second, third });
                
                // Mark event as Completed
                event.status = 'Completed';
                
                // --- Recalculate ALL team scores ---
                // 1. Reset all scores to 0
                db.teams.forEach(t => t.score = 0);
                
                // 2. Loop through all results and add points
                db.results.forEach(r => {
                    const resultEvent = db.events.find(ev => ev.id === r.eventId);
                    if (!resultEvent) return;
                    
                    const [points1, points2, points3] = resultEvent.points;
                    
                    const winners = [r.first, r.second, r.third];
                    const points = [points1, points2, points3];
                    
                    for (let i = 0; i < winners.length; i++) {
                        const studentId = winners[i];
                        if (studentId !== 'none') {
                            const student = db.students.find(s => s.id === studentId);
                            if (student && student.teamId) {
                                const team = db.teams.find(t => t.id === student.teamId);
                                if (team) {
                                    team.score += points[i];
                                }
                            }
                        }
                    }
                });
                
                saveDB();
                e.target.reset();
            });

            // =================================================================
            // NOTIFICATIONS: Form Logic
            // =================================================================
            
            document.getElementById('notificationForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const to = document.getElementById('notifyTo').value;
                const title = document.getElementById('notifyTitle').value;
                const message = document.getElementById('notifyMessage').value;
                
                const newNotification = {
                    id: db.notifications.length > 0 ? Math.max(...db.notifications.map(n => n.id)) + 1 : 1,
                    to: to,
                    title: title,
                    message: message,
                    date: new Date().toISOString()
                };
                
                db.notifications.push(newNotification);
                saveDB();
                e.target.reset();
            });

            // =================================================================
            // UTILITY FUNCTIONS
            // =================================================================

            // Generic Delete Modal
            let deleteCallback = null;
            function showDeleteModal(itemName, callback) {
                document.getElementById('confirmDeleteModalBody').innerHTML = `
                    Are you sure you want to delete ${itemName}?
                    <p class="text-danger small mt-2">This action cannot be undone.</p>
                `;
                deleteCallback = callback;
                deleteModal.show();
            }

            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                if (deleteCallback) {
                    deleteCallback();
                }
                deleteModal.hide();
            });


            // --- Page Navigation Logic ---
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            const contentSections = document.querySelectorAll('.content-section');
            const pageTitle = document.getElementById('page-title');
            const sidebar = document.getElementById('adminSidebar');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    const targetId = this.dataset.target;
                    
                    // Update Content
                    contentSections.forEach(section => {
                        section.classList.remove('active-section');
                    });
                    document.getElementById(targetId).classList.add('active-section');
                    
                    // Update Title
                    pageTitle.textContent = this.textContent.trim();
                    
                    // Update Nav
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');

                    // Close sidebar on mobile after click
                    if (window.innerWidth < 992) {
                        sidebar.classList.remove('show');
                    }
                });
            });

            // --- Sidebar Toggle Logic ---
            const sidebarToggle = document.getElementById('sidebarToggle');
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
            });
            
            // --- Logout Logic ---
            document.getElementById('logoutBtn').addEventListener('click', (e) => {
                e.preventDefault();
                sessionStorage.removeItem('artFestUserRole');
                sessionStorage.removeItem('artFestUserId');
                window.location.href = './index.html';
            });

            // --- Set Current Year in Footer ---
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // --- Security Check ---
            // On page load, check if user is admin. If not, redirect to index.
            const userRole = sessionStorage.getItem('artFestUserRole');
            if (userRole !== 'Admin') {
                showToast('Access Denied. Please log in.', 'danger');
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 1500);
                return; // Stop further execution
            }

            // --- Initial Load ---
            loadDB();
            renderAll();

        });
    </script>
</body>
</html>