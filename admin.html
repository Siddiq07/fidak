<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Art Fest Dashboard</title>

<!-- Bootstrap + Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<!-- Excel + PDF -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>

/* ============================
   ROOT + RESET
============================ */
:root{
  --bg: #f5f8ff;
  --card: #ffffff;
  --muted: #6b7280;
  --accent: #2563eb;
  --success: #10b981;
  --danger: #ef4444;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  width: 100%;
  height: 100%;
  background: var(--bg);
  overflow-x: hidden;
  font-family: Inter, system-ui, sans-serif;
  color: #0f172a;
}

body {
  display: flex;
}

/* ============================
   SIDEBAR (NO EXTRA SPACE)
============================ */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 250px;         /* perfect width */
  height: 100vh;
  background: #ffffff;
  padding: 16px 14px;
  border-right: 1px solid #e4e9f3;
  display: flex;
  flex-direction: column;
  z-index: 1000;
}

.sidebar .logo-area {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 18px;
}

.sidebar .logo-area i {
  font-size: 26px;
  color: var(--accent);
}

.sidebar .logo-title {
  font-size: 17px;
  font-weight: 700;
  margin: 0;
}

.sidebar .logo-sub {
  font-size: 11px;
  color: var(--muted);
  margin-top: -4px;
}

.nav-item {
  margin-bottom: 6px;
}

.nav-item button {
  width: 100%;
  background: #f3f6ff;
  border: none;
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 15px;
  text-align: left;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: 0.2s;
  color: #333;
}

.nav-item button.active {
  background: linear-gradient(90deg, var(--accent), #7c3aed);
  color: #fff;
}

.nav-item button i {
  font-size: 18px;
}

/* Logout button */
.logout-box {
  margin-top: auto;
}

.logout-box button {
  width: 100%;
  border-radius: 8px;
  border: 2px solid var(--danger);
  background: #fff;
  color: var(--danger);
  padding: 10px;
  font-size: 15px;
}

/* ============================
   CONTENT (NO WHITE SPACE)
============================ */
.content {
  margin-left: 250px !important;   /* matches sidebar width */
  width: calc(100% - 250px) !important;
  padding: 20px;
  padding-top: 26px;
}

/* remove accidental margins */
main, .content, .container, .wrapper, .page-area {
  margin: 0 !important;
  padding-left: 0 !important;
  padding-right: 0 !important;
}

/* ============================
   TOPBAR
============================ */
.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 18px;
}

.topbar h3 {
  margin: 0;
  font-weight: 700;
}

.topbar .muted {
  margin-top: -4px;
  font-size: 13px;
}

/* ============================
   CARDS
============================ */
.card-neo {
  background: #fff;
  border-radius: 12px;
  padding: 14px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.06);
  margin-bottom: 16px;
}

.section-title {
  font-size: 17px;
  font-weight: 700;
  margin-bottom: 6px;
}

/* ============================
   TABLES / HIGHLIGHTING
============================ */
.table thead {
  background: #eef2ff;
}

.participated-row {
  background: #e9ffe9 !important;   /* light green uploaded indicator */
}

/* Small attendance box */
.small-box {
  width: 58px;
  height: 42px;
  border-radius: 6px;
  background: #eef2ff;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin: 6px;
  font-size: 13px;
  flex-direction: column;
  cursor: pointer;
  transition: 0.2s;
}

.small-box.present {
  background: var(--success);
  color: #fff;
}

.small-box.absent {
  background: var(--danger);
  color: #fff;
}

/* ============================
   RESPONSIVE
============================ */
@media (max-width: 900px){
  .sidebar {
    width: 70px;
  }
  .content {
    margin-left: 70px !important;
    width: calc(100% - 70px) !important;
  }
  .text-label {
    display: none;
  }
}

</style>
</head>

<body>
<div class="app">

<!-- SIDEBAR -->
<aside class="sidebar">

  <div class="logo-area">
    <i class="bi bi-palette-fill"></i>
    <div>
      <div class="logo-title">Art Fest</div>
      <div class="logo-sub">Admin Panel</div>
    </div>
  </div>

  <!-- Nav Buttons -->
  <nav class="mt-2">
    <div class="nav-item"><button id="btnStudents" data-target="#panel-students"><i class="bi bi-people-fill"></i><span class="text-label">Students</span></button></div>
    <div class="nav-item"><button id="btnTeams" data-target="#panel-teams"><i class="bi bi-people"></i><span class="text-label">Teams</span></button></div>
    <div class="nav-item"><button id="btnEvents" data-target="#panel-events"><i class="bi bi-calendar-event"></i><span class="text-label">Events</span></button></div>
    <div class="nav-item"><button id="btnAttendance" data-target="#panel-attendance"><i class="bi bi-check2-all"></i><span class="text-label">Attendance</span></button></div>
    <div class="nav-item"><button id="btnApprovals" data-target="#panel-approvals"><i class="bi bi-card-checklist"></i><span class="text-label">Approvals</span></button></div>
    <div class="nav-item"><button id="btnResults" data-target="#panel-results"><i class="bi bi-list-ol"></i><span class="text-label">Results</span></button></div>
    <div class="nav-item"><button id="btnReports" data-target="#panel-reports"><i class="bi bi-bar-chart-line"></i><span class="text-label">Reports</span></button></div>
  </nav>

  <div class="logout-box">
    <button id="logoutBtn"><i class="bi bi-box-arrow-right"></i> <span class="text-label">Logout</span></button>
  </div>

</aside>

<!-- MAIN CONTENT -->
<main class="content">

  <div class="topbar">
    <div>
      <h3>Admin Dashboard</h3>
      <div class="muted">Manage Students · Teams · Events · Attendance · Results</div>
    </div>

    <div class="d-flex align-items-center gap-2">
      <button id="btnExportStudents" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-pdf"></i> Export</button>
      <span class="muted">Year <span id="current-year"></span></span>
    </div>
  </div>

  <!-- PANELS WRAPPER -->
  <div id="panels-wrapper"></div>
  <!-- ===============================
     PANELS (STUDENTS / TEAMS / EVENTS)
==================================== -->

<div id="panel-students" class="panel card-neo d-none">
  <div class="section-title">Students Management</div>

  <div class="row g-3">

    <!-- IMPORT STUDENTS -->
    <div class="col-md-5">
      <div class="card-neo mb-2">
        <div class="section-title">Import Students (Excel)</div>
        <p class="muted small">Allowed duplicates: SAME name but different level/type/event</p>

        <input type="file" id="studentExcel" class="form-control mb-2" accept=".xlsx,.xls">

        <div class="d-flex gap-2">
          <button id="previewStudentExcel" class="btn btn-outline-primary">Preview</button>
          <button id="importStudentExcel" class="btn btn-accent">Import</button>
        </div>

        <hr>
        <div class="section-title">Preview</div>
        <div id="studentPreviewBox" style="max-height:240px; overflow-y:auto;"></div>
      </div>

      <!-- MANUAL STUDENT ADD -->
      <div class="card-neo">
        <div class="section-title">Add Student (Manual)</div>

        <input id="stChess" class="form-control mb-2" placeholder="Chess Number (Alphanumeric)">
        <input id="stName" class="form-control mb-2" placeholder="Full Name">

        <select id="stLevel" class="form-select mb-2">
          <option value="Senior">Senior</option>
          <option value="Junior">Junior</option>
        </select>

        <select id="stTeam" class="form-select mb-3">
          <option value="">Unassigned</option>
        </select>

        <button id="addManualStudent" class="btn btn-success w-100">Add Student</button>
      </div>
    </div>

    <!-- ALL STUDENTS TABLE -->
    <div class="col-md-7">
      <div class="card-neo">
        <div class="d-flex justify-content-between mb-2">
          <div class="section-title mb-0">All Students</div>
          <input id="searchStudents" class="form-control w-50" placeholder="Search by name, chess">
        </div>

        <div class="table-responsive" style="max-height:480px; overflow-y:auto;">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Chess #</th>
                <th>Name</th>
                <th>Level</th>
                <th>Team</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="studentsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ===============================
          TEAMS PANEL
==================================== -->

<div id="panel-teams" class="panel card-neo d-none">
  <div class="section-title">Teams Management</div>

  <div class="row g-3">

    <!-- TEAM ADD / EDIT -->
    <div class="col-md-5">
      <div class="card-neo">
        <div class="section-title">Add / Edit Team</div>

        <input id="teamName" class="form-control mb-2" placeholder="Team Name">
        <select id="teamLeader" class="form-select mb-2">
          <option value="">Leader (Chess #)</option>
        </select>
        <input id="teamPassword" class="form-control mb-2" placeholder="Team Login Password">

        <button id="saveTeam" class="btn btn-success w-100">Save Team</button>
      </div>
    </div>

    <!-- TEAM TABLE -->
    <div class="col-md-7">
      <div class="card-neo">
        <div class="section-title">Teams List</div>

        <div class="table-responsive" style="max-height:480px; overflow-y:auto;">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Team</th>
                <th>Leader</th>
                <th>Members</th>
                <th>Status</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="teamsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ===============================
          EVENTS PANEL
==================================== -->

<div id="panel-events" class="panel card-neo d-none">
  <div class="section-title">Events Management</div>

  <div class="row g-3">

    <!-- ADD EVENT -->
    <div class="col-md-5">
      <div class="card-neo mb-2">
        <div class="section-title">Add Event</div>

        <input id="eventName" class="form-control mb-2" placeholder="Event Name">

        <select id="eventType" class="form-select mb-2">
          <option>Stage</option>
          <option>Non-Stage</option>
        </select>

        <select id="eventCategory" class="form-select mb-2">
          <option>General</option>
          <option>Junior</option>
          <option>Senior</option>
          <option>Special</option>
        </select>

        <textarea id="eventDesc" rows="4" class="form-control mb-2" placeholder="Event Rules / Description"></textarea>

        <button id="saveEvent" class="btn btn-warning w-100">Save Event</button>
      </div>

      <!-- IMPORT EVENTS -->
      <div class="card-neo">
        <div class="section-title">Import Events (Excel)</div>
        <input type="file" id="eventExcel" class="form-control mb-2" accept=".xlsx,.xls">

        <div class="d-flex gap-2">
          <button id="previewEventExcel" class="btn btn-outline-primary">Preview</button>
          <button id="importEventExcel" class="btn btn-accent">Import</button>
        </div>

        <div id="eventPreviewBox" style="max-height:240px; overflow-y:auto;" class="mt-2"></div>
      </div>
    </div>

    <!-- EVENTS LIST -->
    <div class="col-md-7">
      <div class="card-neo">

        <div class="d-flex justify-content-between mb-2">
          <div class="section-title mb-0">Events List</div>
          <input id="searchEvents" class="form-control w-50" placeholder="Search event, type, category">
        </div>

        <div class="table-responsive" style="max-height:480px; overflow-y:auto;">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Category</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody id="eventsTable"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>
</div>
<!-- ============================================
                ATTENDANCE PANEL
=============================================== -->
<div id="panel-attendance" class="panel card-neo d-none">

  <div class="section-title">Attendance Marking</div>

  <div class="card-neo mb-3">
    <div class="row g-2">
      <div class="col-md-3">
        <label class="muted small">Date</label>
        <input type="date" id="attDate" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="muted small">Time</label>
        <input type="time" id="attTime" class="form-control">
      </div>

      <div class="col-md-4">
        <label class="muted small">Description</label>
        <input id="attDesc" class="form-control" placeholder="Morning Session, Evening, Practice…">
      </div>

      <div class="col-md-2">
        <label class="muted small">Method</label>
        <select id="attMethod" class="form-select">
          <option value="all">All Students</option>
          <option value="team">By Team</option>
        </select>
      </div>
    </div>

    <div class="mt-2 d-none" id="attTeamWrap">
      <select id="attTeam" class="form-select"></select>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button id="loadAttendance" class="btn btn-info">Load Students</button>
      <button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button>
      <button id="saveAttendance" class="btn btn-success">Save Session</button>
    </div>
  </div>

  <!-- Attendance Mark Box -->
  <div id="attendanceMarkCard" class="card-neo" style="display:none">
    <div class="section-title">Mark Attendance</div>
    <p class="muted small">Tap box: <strong>Green = Present</strong>, Red = Absent</p>

    <div id="attendanceBoxes" 
         style="display:flex; flex-wrap:wrap; gap:6px; padding:12px">
    </div>
  </div>

  <!-- Saved Attendance Sessions -->
  <div class="card-neo mt-3">
    <div class="section-title">Saved Attendance Sessions</div>

    <div class="table-responsive" style="max-height:420px; overflow-y:auto;">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Description</th>
            <th>Count</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="attendanceSessions"></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ============================================
                APPROVALS PANEL
=============================================== -->
<div id="panel-approvals" class="panel card-neo d-none">
  <div class="section-title">Pending Approvals</div>

  <div class="d-flex justify-content-between mb-2">
    <input id="searchApprovals" class="form-control w-50" placeholder="Search event, student, team…">
    <button class="btn btn-outline-secondary" id="downloadApprovalsPdf">
      <i class="bi bi-file-earmark-pdf"></i>
    </button>
  </div>

  <div class="table-responsive" style="max-height:450px; overflow-y:auto;">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>Event</th>
          <th>Student</th>
          <th>Team</th>
          <th>Submitted</th>
          <th class="text-end">Actions</th>
        </tr>
      </thead>
      <tbody id="approvalsTable"></tbody>
    </table>
  </div>
</div>

<!-- ============================================
                RESULTS PANEL
=============================================== -->
<div id="panel-results" class="panel card-neo d-none">

  <div class="section-title">Add Results</div>

  <div class="card-neo mb-3">
    <div class="row g-2 align-items-center">

      <div class="col-md-4">
        <select id="resultEvent" class="form-select">
          <option value="">Select Event</option>
        </select>
      </div>

      <div class="col-md-4">
        <select id="resultSelectParticipant" class="form-select">
          <option value="">Select Participant</option>
        </select>
      </div>

      <div class="col-md-2">
        <select id="resultPosition" class="form-select">
          <option value="">Position</option>
          <option value="1">1st</option>
          <option value="2">2nd</option>
          <option value="3">3rd</option>
        </select>
      </div>

      <div class="col-md-2">
        <input id="resultPoints" type="number" class="form-control" placeholder="Points">
      </div>

    </div>

    <button id="saveResult" class="btn btn-success mt-2 w-100">Add Result</button>
  </div>

  <!-- RESULTS LIST -->
  <div class="card-neo">
    <div class="section-title">Results List</div>
    <p class="muted small">Light green row = Result already uploaded for this event</p>

    <div class="table-responsive" style="max-height:480px; overflow-y:auto;">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Event</th>
            <th>1st</th>
            <th>2nd</th>
            <th>3rd</th>
            <th>Status</th>
            <th class="text-end">Action</th>
          </tr>
        </thead>

        <tbody id="resultsTable"></tbody>
      </table>
    </div>
  </div>
</div>
<script type="module">

/* ==============================
       FIREBASE SETUP
============================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from 
"https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ==============================
        UTILITIES
============================== */
const $ = id => document.getElementById(id);

function toast(msg, type = "success") {
  const div = document.createElement("div");
  div.className = `toast align-items-center text-bg-${type} border-0`;
  div.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${msg}</div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;
  $("toastRoot").appendChild(div);
  const t = new bootstrap.Toast(div);
  t.show();
  div.addEventListener("hidden.bs.toast", () => div.remove());
}

function escape(s){ return (s || "").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

/* ==============================
      GLOBAL CACHE + KEYS
============================== */
let CACHE = {
  students: [],
  teams: [],
  events: [],
  participations: [],
  results: [],
  attendance: {}
};

let KEYMAP = {
  students:{}, teams:{}, events:{},
  participations:{}, results:{}
};

/* ==============================
        REALTIME LISTENERS
============================== */
onValue(ref(db, "students"), snap => updateCache("students", snap));
onValue(ref(db, "teams"), snap => updateCache("teams", snap));
onValue(ref(db, "events"), snap => updateCache("events", snap));
onValue(ref(db, "participations"), snap => updateCache("participations", snap));
onValue(ref(db, "results"), snap => updateCache("results", snap));
onValue(ref(db, "attendance"), snap => {
  CACHE.attendance = snap.val() || {};
  renderAll();
});

function updateCache(type, snap) {
  const v = snap.val() || {};
  CACHE[type] = Object.values(v);
  KEYMAP[type] = {};
  Object.entries(v).forEach(([k,val]) => KEYMAP[type][val.id] = k);
  renderAll();
}

/* ==============================
        SIDEBAR TABS
============================== */
document.querySelectorAll(".sidebar [data-target]").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll("#panels section").forEach(s => s.classList.add("d-none"));
    const panel = document.querySelector(btn.dataset.target);
    if (panel) panel.classList.remove("d-none");
    document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});
$("btnStudents").click();

/* ==============================
      MAIN RENDER FUNCTION
============================== */
function renderAll(){
  populateDropdowns();
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceSessions();
  renderApprovals();
  renderResults();
}

/* ==============================
          STUDENTS
============================== */
function renderStudents() {
  const tbody = $("studentsTable");
  let q = ($("searchStudents").value || "").toLowerCase();

  const teamMap = {};
  CACHE.teams.forEach(t => teamMap[t.id] = t.name);

  let html = "";
  CACHE.students
    .sort((a,b)=> String(a.id).localeCompare(String(b.id)))
    .forEach(s => {
      const text = `${s.id} ${s.name} ${teamMap[s.teamId] || ""}`.toLowerCase();
      if (q && !text.includes(q)) return;

      html += `
      <tr data-id="${s.id}">
        <td>${escape(s.id)}</td>
        <td>${escape(s.name)}</td>
        <td>${escape(s.level)}</td>
        <td>${escape(teamMap[s.teamId] || "Unassigned")}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary editStudent">Edit</button>
          <button class="btn btn-sm btn-outline-danger deleteStudent">Delete</button>
        </td>
      </tr>`;
    });

  tbody.innerHTML = html || `<tr><td colspan="5" class="text-center muted">No students</td></tr>`;
}

/* ==============================
          TEAMS
============================== */
function renderTeams(){
  const tbody = $("teamsTable");

  let html = "";
  CACHE.teams.forEach(t => {
    const leader = CACHE.students.find(s => s.id == t.leaderId);
    const members = CACHE.students.filter(s => s.teamId == t.id).length;

    html += `
    <tr data-id="${t.id}">
      <td>${escape(t.name)}</td>
      <td>${leader ? leader.name + " ("+leader.id+")" : "-"}</td>
      <td>${members}</td>
      <td>${(t.score || 0)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary editTeam">Edit</button>
        <button class="btn btn-sm btn-outline-danger deleteTeam">Delete</button>
      </td>
    </tr>`;
  });

  tbody.innerHTML = html || `<tr><td colspan="5" class="text-center muted">No teams</td></tr>`;
}

/* ==============================
            EVENTS
============================== */
function renderEvents() {
  const tbody = $("eventsTable");

  let html = "";
  CACHE.events.forEach(ev => {

    const participated = CACHE.participations.some(p => p.eventId == ev.id && p.status == "approved");

    const rowClass = participated ? "style='background:#e9ffe9'" : "";

    html += `
      <tr ${rowClass}>
        <td>${escape(ev.name)}</td>
        <td>${escape(ev.type)}</td>
        <td>${escape(ev.level)}</td>
        <td>${escape(ev.description.slice(0,120))}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary editEvent" data-id="${ev.id}">Edit</button>
          <button class="btn btn-sm btn-outline-danger deleteEvent" data-id="${ev.id}">Delete</button>
        </td>
      </tr>`;
  });

  tbody.innerHTML = html || `<tr><td colspan="5" class="text-center muted">No events</td></tr>`;
}

/* ==============================
      ATTENDANCE DISPLAY
============================== */
function renderAttendanceSessions() {
  const tbody = $("attendanceSessions");
  const sessions = Object.entries(CACHE.attendance);

  let html = "";
  sessions.forEach(([key, s]) => {
    html += `
      <tr>
        <td>${s.date}</td>
        <td>${s.time}</td>
        <td>${escape(s.description)}</td>
        <td>${Object.keys(s.students).length}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary viewAtt" data-id="${key}">View</button>
          <button class="btn btn-sm btn-outline-secondary editAtt" data-id="${key}">Edit</button>
          <button class="btn btn-sm btn-outline-danger deleteAtt" data-id="${key}">Delete</button>
        </td>
      </tr>`;
  });

  tbody.innerHTML = html || `<tr><td colspan="5" class="text-center muted">No attendance sessions</td></tr>`;
}

/* Attendance Grid With Names Shown */
function createAttendanceBox(stu, status){
  const div = document.createElement("div");
  div.className = status === "Present" ? "small-box present" : "small-box absent";
  div.dataset.id = stu.id;

  div.innerHTML = `
    <div style="font-size:14px; font-weight:600">${stu.id}</div>
    <div style="font-size:11px; opacity:0.8">${stu.name}</div>`;

  div.onclick = () => {
    if(div.classList.contains("present")){
      div.classList.remove("present"); div.classList.add("absent");
    } else {
      div.classList.remove("absent"); div.classList.add("present");
    }
  };

  return div;
}

/* ==============================
        APPROVALS
============================== */
function renderApprovals(){
  const tbody = $("approvalsTable");
  let q = $("searchApprovals").value.toLowerCase();

  let html = "";

  CACHE.participations
    .filter(p => p.status === "pending")
    .forEach(p => {
      const ev = CACHE.events.find(e => e.id == p.eventId);
      const stu = CACHE.students.find(s => s.id == p.studentId);
      const team = CACHE.teams.find(t => t.id == p.teamId);

      const text = `${ev?.name} ${stu?.name} ${team?.name}`.toLowerCase();
      if(q && !text.includes(q)) return;

      html += `
      <tr>
        <td>${escape(ev?.name)}</td>
        <td>${escape(stu?.name)}</td>
        <td>${escape(team?.name)}</td>
        <td>${new Date(p.submittedAt).toLocaleString()}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-success approve" data-id="${p.id}">Approve</button>
          <button class="btn btn-sm btn-danger reject" data-id="${p.id}">Reject</button>
        </td>
      </tr>`;
    });

  tbody.innerHTML = html || `<tr><td colspan="5" class="text-center muted">No pending approvals</td></tr>`;
}

/* ==============================
              RESULTS
============================== */
function renderResults(){
  const tbody = $("resultsTable");

  let eventMap = {};

  CACHE.results.forEach(r => {
    if(!eventMap[r.eventId]) eventMap[r.eventId] = {};
    eventMap[r.eventId][r.position] = r;
  });

  let html = "";

  Object.keys(eventMap).forEach(eventId => {
    const ev = CACHE.events.find(e => e.id == eventId);

    const first = eventMap[eventId][1];
    const second = eventMap[eventId][2];
    const third = eventMap[eventId][3];

    const uploaded = first || second || third;
    const rowColor = uploaded ? `style="background:#f0fff0"` : "";

    html += `
      <tr ${rowColor}>
        <td>${escape(ev?.name)}</td>
        <td>${escape(studentName(first?.studentId))}</td>
        <td>${escape(studentName(second?.studentId))}</td>
        <td>${escape(studentName(third?.studentId))}</td>
        <td>${uploaded ? "Draft" : "-"}</td>
        <td class="text-end">
          ${makeResultButtons(first)}
          ${makeResultButtons(second)}
          ${makeResultButtons(third)}
        </td>
      </tr>`;
  });

  tbody.innerHTML = html || `<tr><td colspan="6" class="text-center muted">No results yet</td></tr>`;
}

function studentName(id){
  const s = CACHE.students.find(st => st.id == id);
  return s ? `${s.name} (${s.id})` : "";
}

function makeResultButtons(r){
  if(!r) return "";
  return `
    <button class="btn btn-sm btn-outline-primary editResult" data-id="${r.id}">Edit</button>
    <button class="btn btn-sm btn-outline-danger deleteResult" data-id="${r.id}">Delete</button>
  `;
}

/* ==============================
          DROPDOWNS
============================== */
function populateDropdowns(){
  $("resultEvent").innerHTML = `<option value="">Select Event</option>`;
  CACHE.events.forEach(ev => $("resultEvent").innerHTML += 
    `<option value="${ev.id}">${escape(ev.name)}</option>`
  );
}

/* Auto-load participants by event */
$("resultEvent").addEventListener("change", () => {
  let evId = $("resultEvent").value;
  let sel = $("resultSelectParticipant");
  sel.innerHTML = `<option value="">Select Participant</option>`;

  CACHE.participations
    .filter(p => p.eventId == evId && p.status === "approved")
    .forEach(p => {
      const s = CACHE.students.find(st => st.id == p.studentId);
      sel.innerHTML += `<option value="${s.id}">${escape(s.name)} (${s.id})</option>`;
    });
});

/* Add Result */
$("saveResult").onclick = async () => {
  const ev = $("resultEvent").value;
  const stu = $("resultSelectParticipant").value;
  const pos = Number($("resultPosition").value);
  const pts = Number($("resultPoints").value) || 0;

  if(!ev || !stu || !pos) return toast("Missing fields", "danger");

  const id = Date.now().toString();
  await set(push(ref(db,"results")), {
    id, eventId:ev, studentId:stu, position:pos, points:pts, published:false
  });

  toast("Result added");
};

/* ==============================
              FINAL
============================== */
console.log("Admin Panel Script Loaded");

</script>
</body>
</html>