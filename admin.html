<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel — Art Fest (Fixed)</title>

  <!-- Bootstrap & icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Excel / PDF helpers -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --muted:#6b7280; --accent:#4f46e5; --success:#10b981; --danger:#ef4444;
    }
    html,body{height:100%}
    body{
      background:var(--bg); font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; color:#0f172a;
      margin:0;
    }
    .container-wide{max-width:1200px; margin:18px auto; padding:0 12px;}
    .card-neo{background:var(--card); border-radius:12px; padding:14px; box-shadow:0 8px 22px rgba(8,15,30,0.06);}
    .section-title{font-weight:700; margin-bottom:8px;}
    .small-muted{color:var(--muted); font-size:0.92rem;}
    .nav-pills .nav-link{border-radius:999px; padding:8px 14px; margin-right:6px;}
    .small-box{width:48px; height:32px; background:#eef2ff; display:inline-flex; align-items:center; justify-content:center; border-radius:8px; margin:4px; cursor:pointer; font-size:12px; user-select:none;}
    .small-box.present{background:var(--success); color:#fff;}
    .small-box.absent{background:var(--danger); color:#fff;}
    .participated-row{background:#e8fff0;}
    .muted{color:var(--muted);}
    /* responsive */
    @media (max-width: 768px){
      .col-lg-7, .col-lg-5 { flex: 0 0 100%; max-width:100% !important; }
      .small-box{ width:40px; height:28px; font-size:11px; }
      .nav-pills{ overflow:auto; -webkit-overflow-scrolling:touch; }
    }
    /* remove duplicate top row area (we keep only inner tabs) */
    .top-nav-hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- NAVBAR (kept minimal; top quick actions removed to avoid duplicates) -->
  <nav class="navbar bg-white shadow-sm mb-3">
    <div class="container container-wide d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <span class="badge text-bg-primary rounded-pill"><i class="bi bi-award"></i></span>
        <div>
          <div style="font-weight:700">Admin Panel</div>
          <div class="small-muted">Students · Teams · Events · Attendance · Approvals · Results · Reports</div>
        </div>
      </div>

      <!-- Keep only small logout / helper on top -->
      <div class="d-flex gap-2 align-items-center">
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right"></i></button>
      </div>
    </div>
  </nav>

  <main class="container container-wide">
    <div class="card-neo mb-3">
      <!-- INSIDE TAB ROW (THIS IS THE ONLY TAB ROW — user chose Option B) -->
      <div class="py-2">
        <ul class="nav nav-pills" id="tabs" role="tablist">
          <li class="nav-item" role="presentation"><button class="nav-link active" data-target="panel-students" type="button">Students</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-target="panel-teams" type="button">Teams</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-target="panel-events" type="button">Events</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-target="panel-attendance" type="button">Attendance</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-target="panel-approvals" type="button">Approvals</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-target="panel-results" type="button">Results</button></li>
          <li class="nav-item" role="presentation"><button class="nav-link" data-target="panel-reports" type="button">Reports</button></li>
        </ul>
      </div>

      <!-- PANELS: the parts 2 / 3 / 4 will insert section contents here in order -->
      <div id="panels" class="mt-3">
        <!-- PART 2 WILL INSERT STUDENTS + TEAMS -->
        <!-- INSERT PART 2 HERE -->

        <!-- PART 3 WILL INSERT EVENTS + ATTENDANCE -->
        <!-- INSERT PART 3 HERE -->

        <!-- PART 4 WILL INSERT APPROVALS + RESULTS + REPORTS + SCRIPTS -->
        <!-- INSERT PART 4 HERE -->
      </div>
    </div>
  </main>

  <!-- small toast root -->
  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>

  <!-- Bootstrap JS (loaded at end) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- ========================= -->
<!-- ===== STUDENTS TAB ====== -->
<!-- ========================= -->

<section id="panel-students" class="panel">
  <div class="row">
    
    <!-- LEFT CARD (IMPORT + ADD) -->
    <div class="col-lg-5">
      <div class="card-neo mb-3">
        <div class="section-title">Import Students (Excel)</div>
        <div class="small-muted mb-2">Required Columns: Chess, Name, Level, Team</div>

        <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">

        <div class="d-flex gap-2 mb-2">
          <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
          <button id="importStudents" class="btn btn-accent">Import</button>
        </div>

        <hr>

        <div class="section-title">Add Student Manually</div>
        <input id="manualChess" class="form-control mb-2" placeholder="Chess ID (alphanumeric)">
        <input id="manualName" class="form-control mb-2" placeholder="Name">

        <select id="manualLevel" class="form-select mb-2">
          <option value="Senior">Senior</option>
          <option value="Junior">Junior</option>
        </select>

        <select id="manualTeam" class="form-select mb-3">
          <option value="">Unassigned</option>
        </select>

        <button id="addManualStudent" class="btn btn-success w-100">Add Student</button>

        <hr>

        <div class="section-title">Preview</div>
        <div id="studentsPreview" style="max-height:250px; overflow:auto"></div>
      </div>
    </div>


    <!-- RIGHT CARD (TABLE) -->
    <div class="col-lg-7">
      <div class="card-neo">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="m-0">All Students</h5>
          <input id="searchStudents" class="form-control w-50" placeholder="Search by name or chess ID">
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Chess #</th>
                <th>Name</th>
                <th>Level</th>
                <th>Team</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTable"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>
</section>


<!-- ========================= -->
<!-- ====== TEAMS TAB ======== -->
<!-- ========================= -->

<section id="panel-teams" class="panel d-none">

  <div class="row">

    <!-- LEFT ADD PANEL -->
    <div class="col-lg-5">
      <div class="card-neo mb-3">
        <div class="section-title">Add / Edit Team</div>

        <input id="teamName" class="form-control mb-2" placeholder="Team Name">

        <select id="teamLeader" class="form-select mb-2">
          <option value="">Select Leader (Chess#)</option>
        </select>

        <input id="teamPassword" class="form-control mb-3" placeholder="Login Password">

        <button id="saveTeam" class="btn btn-success w-100">Save Team</button>
      </div>
    </div>


    <!-- RIGHT TABLE -->
    <div class="col-lg-7">
      <div class="card-neo">
        <h5 class="section-title">Teams List</h5>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Team</th>
                <th>Leader</th>
                <th>Members</th>
                <th>Attendance %</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="teamsTable"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

</section>
<!-- ========================= -->
<!-- ======== EVENTS ========= -->
<!-- ========================= -->

<section id="panel-events" class="panel d-none">

  <div class="row">

    <!-- LEFT EVENT ADD PANEL -->
    <div class="col-lg-5">
      
      <div class="card-neo mb-3">
        <div class="section-title">Add Event</div>

        <input id="eventName" class="form-control mb-2" placeholder="Event Name">

        <select id="eventType" class="form-select mb-2">
          <option>Stage</option>
          <option>Non-Stage</option>
        </select>

        <textarea id="eventDescription" class="form-control mb-3" rows="4" placeholder="Description / Rules"></textarea>

        <button id="saveEvent" class="btn btn-warning w-100">Save Event</button>
      </div>


      <!-- IMPORT EVENT EXCEL -->
      <div class="card-neo">
        <div class="section-title">Import Events (Excel)</div>

        <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">

        <div class="d-flex gap-2 mb-2">
          <button id="previewEvents" class="btn btn-outline-primary">Preview</button>
          <button id="importEvents" class="btn btn-accent">Import</button>
        </div>

        <div id="eventsPreview" style="max-height:260px; overflow:auto;"></div>
      </div>

    </div>


    <!-- RIGHT EVENT TABLE -->
    <div class="col-lg-7">
      <div class="card-neo">

        <div class="section-title">Events List</div>
        <div class="small-muted mb-2">
          Rows highlighted in <span style="color:green;font-weight:600">light green</span> indicate team participation.
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Description</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="eventsTable"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

</section>



<!-- ========================= -->
<!-- ======== ATTENDANCE ===== -->
<!-- ========================= -->

<section id="panel-attendance" class="panel d-none">

  <!-- CREATE NEW SESSION -->
  <div class="card-neo mb-3">

    <div class="row g-2">
      
      <div class="col-md-3">
        <label class="small-muted">Date</label>
        <input id="attDate" type="date" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="small-muted">Time</label>
        <input id="attTime" type="time" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="small-muted">Description</label>
        <input id="attDesc" class="form-control" placeholder="Eg: Morning Session">
      </div>

      <div class="col-md-3">
        <label class="small-muted">Mode</label>
        <select id="attMethod" class="form-select">
          <option value="all">All Students</option>
          <option value="team">By Team</option>
        </select>
      </div>

      <div class="col-md-3 d-none" id="attTeamWrap">
        <label class="small-muted">Select Team</label>
        <select id="attTeam" class="form-select"></select>
      </div>

    </div>

    <div class="mt-3 d-flex gap-2">
      <button id="loadAttendance" class="btn btn-info">Load Students</button>
      <button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button>
      <button id="saveAttendance" class="btn btn-success">Save Session</button>
    </div>

  </div>


  <!-- MARK ATTENDANCE -->
  <div class="card-neo mb-3" id="attendanceMarkCard" style="display:none">

    <div class="section-title">Mark Attendance</div>
    <div class="small-muted mb-2">Tap chess number → toggles (Green = Present / Red = Absent)</div>

    <div id="attendanceBoxes" style="min-height:80px;"></div>

  </div>


  <!-- SAVED SESSIONS -->
  <div class="card-neo">
    <div class="section-title">Saved Attendance Sessions</div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Description</th>
            <th>Count</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="attendanceSessions"></tbody>
      </table>
    </div>

  </div>

</section>
<!-- ============================= -->
<!-- ========= APPROVALS ========= -->
<!-- ============================= -->

<section id="panel-approvals" class="panel d-none">

  <div class="card-neo">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div>
        <h5 class="m-0">Pending Participations</h5>
        <div class="small-muted">Approve events submitted by Team Leaders</div>
      </div>

      <input id="searchApprovals" class="form-control w-25" placeholder="Search...">
    </div>

    <div class="table-responsive" style="max-height:420px; overflow:auto;">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Event</th>
            <th>Student</th>
            <th>Team</th>
            <th>Submitted</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="approvalsTable"></tbody>
      </table>
    </div>

  </div>

</section>




<!-- ============================= -->
<!-- ========= RESULTS =========== -->
<!-- ============================= -->

<section id="panel-results" class="panel d-none">

  <div class="card-neo">
    <h5 class="section-title">Event Results</h5>

    <div class="row mb-3">
      <div class="col-md-4">
        <select id="resultEvent" class="form-select">
          <option value="">Select Event</option>
        </select>
      </div>

      <div class="col-md-3">
        <input id="resultPoints" type="number" class="form-control" placeholder="Points (0–100)">
      </div>

      <div class="col-md-3">
        <button id="saveResult" class="btn btn-success w-100">Save Result</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Event</th>
            <th>Student</th>
            <th>Team</th>
            <th>Points</th>
            <th>Published</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="resultsTable"></tbody>
      </table>
    </div>

  </div>

</section>




<!-- ============================= -->
<!-- ========= REPORTS =========== -->
<!-- ============================= -->

<section id="panel-reports" class="panel d-none">

  <div class="card-neo">
    <h5 class="section-title">Reports</h5>
    <div class="small-muted mb-2">Team-wise attendance percentage</div>

    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Team</th>
            <th>Members</th>
            <th>Attendance %</th>
          </tr>
        </thead>
        <tbody id="reportsTable"></tbody>
      </table>
    </div>

  </div>

</section>
<script type="module">

/* --------------------------------------
   FIREBASE INIT
--------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getDatabase, ref, push, set, update, onValue, get, remove
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const $ = id => document.getElementById(id);

/* --------------------------------------
   GLOBAL CACHE
--------------------------------------- */
let CACHE = {
  students: [],
  teams: [],
  events: [],
  participations: [],
  results: [],
  attendance: {}
};

let KEYMAP = {
  students:{}, teams:{}, events:{}, participations:{}, results:{}
};

/* --------------------------------------
   READ ALL LIVE DATA
--------------------------------------- */
onValue(ref(db,'students'), s=>{
  const v=s.val()||{};
  CACHE.students = Object.values(v);
  KEYMAP.students = {};
  Object.entries(v).forEach(([dbKey, obj])=> KEYMAP.students[obj.id]=dbKey);
  renderStudents(); populateTeamDropdowns();
});

onValue(ref(db,'teams'), s=>{
  const v=s.val()||{};
  CACHE.teams = Object.values(v);
  KEYMAP.teams = {};
  Object.entries(v).forEach(([dbKey, obj])=> KEYMAP.teams[obj.id]=dbKey);
  renderTeams(); populateTeamDropdowns();
});

onValue(ref(db,'events'), s=>{
  const v=s.val()||{};
  CACHE.events = Object.values(v);
  KEYMAP.events = {};
  Object.entries(v).forEach(([dbKey, obj])=> KEYMAP.events[obj.id]=dbKey);
  renderEvents(); renderResultEventDropdown();
});

onValue(ref(db,'participations'), s=>{
  const v=s.val()||{};
  CACHE.participations = Object.values(v);
  KEYMAP.participations = {};
  Object.entries(v).forEach(([dbKey, obj])=> KEYMAP.participations[obj.id]=dbKey);
  renderApprovals();
});

onValue(ref(db,'results'), s=>{
  const v=s.val()||{};
  CACHE.results = Object.values(v);
  KEYMAP.results = {};
  Object.entries(v).forEach(([dbKey, obj])=> KEYMAP.results[obj.id]=dbKey);
  renderResults();
});

onValue(ref(db,'attendance'), s=>{
  CACHE.attendance = s.val()||{};
  renderAttendanceSessions(); renderReports(); renderTeams();
});

/* --------------------------------------
   TOAST
--------------------------------------- */
function toast(msg,type="success"){
  const div = document.createElement("div");
  div.className = `toast text-bg-${type} border-0`;
  div.innerHTML =
    `<div class="d-flex">
       <div class="toast-body">${msg}</div>
       <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
     </div>`;
  $("toastRoot").appendChild(div);
  new bootstrap.Toast(div,{delay:2500}).show();
}

/* ---------------------------------------------------------- */
/* ===============   TAB SWITCH HANDLER   ==================== */
/* ---------------------------------------------------------- */
document.querySelectorAll('#tabs [data-target]').forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll('.panel').forEach(p=> p.classList.add('d-none'));
    $(btn.dataset.target).classList.remove('d-none');
    document.querySelectorAll('#tabs .nav-link').forEach(n=> n.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* ---------------------------------------------------------- */
/* ===============    STUDENTS RENDERING     ================= */
/* ---------------------------------------------------------- */

function renderStudents(){
  const tbody = $("studentsTable");
  tbody.innerHTML = "";

  CACHE.students
    .sort((a,b)=> String(a.id).localeCompare(String(b.id)))
    .forEach(s=>{
      const team = CACHE.teams.find(t=> String(t.id)===String(s.teamId));
      tbody.innerHTML += `
        <tr>
          <td>${s.id}</td>
          <td>${s.name}</td>
          <td>${s.level}</td>
          <td>${team ? team.name : "—"}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent('${s.id}')">Delete</button>
          </td>
        </tr>`;
    });
}

/* DELETE STUDENT */
window.deleteStudent = async function(id){
  if(!confirm("Delete student?")) return;
  const dbKey = KEYMAP.students[id];
  await remove(ref(db, `students/${dbKey}`));
  toast("Student deleted");
};

/* -----------------------------------------------
   POPULATE TEAM DROPDOWNS
----------------------------------------------- */
function populateTeamDropdowns(){
  const doms = ["manualTeam", "teamLeader", "attTeam"];
  doms.forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.innerHTML = id==="manualTeam" ? "<option value=''>Unassigned</option>" : "<option value=''>Select</option>";
    CACHE.teams.forEach(t=>{
      el.innerHTML += `<option value="${t.id}">${t.name}</option>`;
    });
  });
}

/* ---------------------------------------------------------- */
/* ===============       TEAMS RENDERING     ================= */
/* ---------------------------------------------------------- */

function teamAttendancePct(teamId){
  const sessions = CACHE.attendance;
  const members = CACHE.students.filter(s=> s.teamId==teamId).map(s=> String(s.id));
  if(!members.length) return 0;

  let total = 0, present = 0;

  Object.values(sessions).forEach(sess=>{
    if(sess.students){
      members.forEach(id=>{
        const st = sess.students[id];
        if(st !== undefined){
          total++;
          if(st === "Present") present++;
        }
      });
    }
  });

  return total ? Math.round((present/total)*100) : 0;
}

function renderTeams(){
  const tbody = $("teamsTable");
  tbody.innerHTML="";

  CACHE.teams.forEach(t=>{
    const leader = CACHE.students.find(s=> s.id==t.leaderId);
    const members = CACHE.students.filter(s=> s.teamId==t.id).length;
    const pct = teamAttendancePct(t.id);

    tbody.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${leader ? leader.name+" ("+leader.id+")" : "—"}</td>
        <td>${members}</td>
        <td>${pct}%</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteTeam('${t.id}')">Delete</button>
        </td>
      </tr>`;
  });
}

window.deleteTeam = async function(id){
  if(!confirm("Delete this team?")) return;

  const dbKey = KEYMAP.teams[id];
  await remove(ref(db, `teams/${dbKey}`));

  // remove students' team reference
  const updates = {};
  CACHE.students.filter(s=> s.teamId==id)
    .forEach(s=> updates[`students/${KEYMAP.students[s.id]}/teamId`] = null);

  if(Object.keys(updates).length) await update(ref(db), updates);

  toast("Team removed");
};

/* ---------------------------------------------------------- */
/* ===============        EVENTS RENDERING     =============== */
/* ---------------------------------------------------------- */

function renderEvents(){
  const tbody = $("eventsTable");
  tbody.innerHTML="";

  CACHE.events.forEach(ev=>{
    const participated = CACHE.participations.some(p=> p.eventId==ev.id);
    tbody.innerHTML += `
      <tr class="${participated?'participated-row':''}">
        <td>${ev.name}</td>
        <td>${ev.type}</td>
        <td>${(ev.description||"").slice(0,80)}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteEvent('${ev.id}')">Delete</button>
        </td>
      </tr>`;
  });
}

window.deleteEvent = async function(id){
  if(!confirm("Delete event?")) return;
  await remove(ref(db, `events/${KEYMAP.events[id]}`));
  toast("Event deleted");
};

/* ---------------------------------------------------------- */
/* ===============     APPROVALS RENDERING   ================= */
/* ---------------------------------------------------------- */

function renderApprovals(){
  const tbody = $("approvalsTable");
  const q = ($("searchApprovals").value || "").toLowerCase();

  let rows = CACHE.participations.filter(p=> p.status==="pending");

  rows = rows.filter(p=>{
    const ev = CACHE.events.find(e=> e.id==p.eventId);
    const st = CACHE.students.find(s=> s.id==p.studentId);
    const team = CACHE.teams.find(t=> t.id==p.teamId);

    const text = `${ev?.name||""} ${st?.name||""} ${team?.name||""}`.toLowerCase();
    return text.includes(q);
  });

  tbody.innerHTML = rows.map(p=>{
    const ev = CACHE.events.find(e=> e.id==p.eventId);
    const st = CACHE.students.find(s=> s.id==p.studentId);
    const team = CACHE.teams.find(t=> t.id==p.teamId);

    return `
      <tr>
        <td>${ev?.name || "-"}</td>
        <td>${st?.name || "-"}</td>
        <td>${team?.name || "-"}</td>
        <td>${new Date(p.submittedAt).toLocaleString()}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-success" onclick="approveParticipation('${p.id}')">Approve</button>
          <button class="btn btn-sm btn-danger" onclick="rejectParticipation('${p.id}')">Reject</button>
        </td>
      </tr>`;
  }).join("") || 
  `<tr><td colspan="5" class="text-center small-muted">No pending requests</td></tr>`;
}

window.approveParticipation = async id=>{
  await update(ref(db, `participations/${KEYMAP.participations[id]}`), {
    status:"approved", approvedAt: Date.now()
  });
  toast("Approved");
};

window.rejectParticipation = async id=>{
  await update(ref(db, `participations/${KEYMAP.participations[id]}`), {
    status:"rejected", rejectedAt: Date.now()
  });
  toast("Rejected");
};

/* ---------------------------------------------------------- */
/* ==================   RESULTS MODULE   ===================== */
/* ---------------------------------------------------------- */

function renderResultEventDropdown(){
  $("resultEvent").innerHTML = `<option value="">Select Event</option>`;
  CACHE.events.forEach(ev=>{
    $("resultEvent").innerHTML += `<option value="${ev.id}">${ev.name}</option>`;
  });
}

$("saveResult").addEventListener("click", async ()=>{

  const eventId = $("resultEvent").value;
  const points = Number($("resultPoints").value);

  if(!eventId) return toast("Select event","danger");
  if(points<0 || points>100) return toast("Points must be 0–100","danger");

  const id = Date.now().toString();
  await set(push(ref(db,'results')), {
    id, eventId, points, published:false
  });
  toast("Result saved");
  $("resultPoints").value="";
});

function renderResults(){
  const tbody = $("resultsTable");
  tbody.innerHTML="";

  CACHE.results.forEach(r=>{

    const ev = CACHE.events.find(e=> e.id==r.eventId);
    const part = CACHE.participations.find(p=> p.eventId==r.eventId && p.status=="approved");
    const student = part ? CACHE.students.find(s=> s.id==part.studentId) : null;
    const team = part ? CACHE.teams.find(t=> t.id==part.teamId) : null;

    tbody.innerHTML += `
      <tr>
        <td>${ev?.name || "-"}</td>
        <td>${student?.name || "-"}</td>
        <td>${team?.name || "-"}</td>
        <td>${r.points}</td>
        <td>
          <input type="checkbox" ${r.published?"checked":""}
            onchange="togglePublish('${r.id}', this.checked)">
        </td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-danger" onclick="deleteResult('${r.id}')">Delete</button>
        </td>
      </tr>`;
  });
}

window.togglePublish = async (id,val)=>{
  await update(ref(db, `results/${KEYMAP.results[id]}`), { published:val });
  toast("Updated");
};

window.deleteResult = async id=>{
  if(!confirm("Delete result?")) return;
  await remove(ref(db, `results/${KEYMAP.results[id]}`));
  toast("Deleted");
};

/* ---------------------------------------------------------- */
/* ===============      ATTENDANCE MODULE     ================ */
/* ---------------------------------------------------------- */

function renderAttendanceSessions(){
  const tbody = $("attendanceSessions");
  tbody.innerHTML="";

  const sessions = Object.entries(CACHE.attendance);

  sessions.sort((a,b)=> b[1].savedAt - a[1].savedAt);

  sessions.forEach(([key, s])=>{
    tbody.innerHTML += `
      <tr>
        <td>${s.date}</td>
        <td>${s.time}</td>
        <td>${s.description}</td>
        <td>${Object.keys(s.students).length}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-secondary" onclick="viewSession('${key}')">View</button>
        </td>
      </tr>`;
  });

  if(!sessions.length){
    tbody.innerHTML = `<tr><td colspan="5" class="text-center small-muted">No sessions</td></tr>`;
  }
}

window.viewSession = key=>{
  const s = CACHE.attendance[key];
  let text = `Date: ${s.date}\nTime: ${s.time}\n${s.description}\n\n`;

  Object.entries(s.students).forEach(([id,st])=>{
    text += `${id}: ${st}\n`;
  });
  alert(text);
};

/* ---------------------------------------------------------- */
/* ===============         REPORTS MODULE     ================ */
/* ---------------------------------------------------------- */

function renderReports(){
  const tbody = $("reportsTable");
  tbody.innerHTML="";

  CACHE.teams.forEach(t=>{
    const members = CACHE.students.filter(s=> s.teamId==t.id).length;
    const pct = teamAttendancePct(t.id);

    tbody.innerHTML += `
      <tr>
        <td>${t.name}</td>
        <td>${members}</td>
        <td>${pct}%</td>
      </tr>`;
  });

  if(!CACHE.teams.length){
    tbody.innerHTML = `<tr><td colspan="3" class="text-center small-muted">No teams</td></tr>`;
  }
}

/* ---------------------------------------------------------- */
/* ===============          LOGOUT         =================== */
/* ---------------------------------------------------------- */

$("logoutBtn").addEventListener("click",()=>{
  sessionStorage.clear();
  location.href="index.html";
});

</script>
</body>
</html>