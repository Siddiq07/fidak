<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Fidak Fest (Final)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* -------------------------------------- */
    /* ROOT THEME VARIABLES */
    /* -------------------------------------- */
    :root {
      /* Dark Mode (Default) */
      --bg: #0d121c; /* Deep Dark Blue */
      --card: #1c2738; /* Card Background */
      --text: #e2e8f0; /* Off-White Text */
      --muted: #94a3b8; /* Slate Grey Muted */
      --border: #334155;
      --input-bg: #334155;
      
      /* Accents */
      --accent-main: #f97316; /* Vibrant Orange */
      --accent-secondary: #3b82f6; /* Bright Blue */
      
      /* Status Colors */
      --success: #10b981;
      --danger: #ef4444;
      --warning: #facc15;
    }

    /* Light Mode Toggle */
    .light-mode {
      --bg: #f8f9fa; /* Light Grey/White */
      --card: #ffffff; /* White Card */
      --text: #212529; /* Dark Text */
      --muted: #6c757d; /* Grey Muted */
      --border: #dee2e6;
      --input-bg: #e9ecef;
      --accent-main: #dc3545; /* Red (Example, could be anything) */
      --accent-secondary: #0d6efd; /* Bootstrap Blue */
      --bs-table-bg: var(--card); /* Ensure table background is correct in light mode */
    }

    /* -------------------------------------- */
    /* BASE STYLES */
    /* -------------------------------------- */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background:var(--bg); transition: background 0.3s, color 0.3s;}
    
    /* Layout */
    .app-wrap{display:flex;min-height:100vh;align-items:stretch}
    
    /* Sidebar */
    .sidebar{
      width:68px; background:var(--card); border-right:1px solid var(--border); display:flex;flex-direction:column;align-items:center;padding:12px 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000;
    }
    .sidebar .icon-btn{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:8px 0;color:var(--muted);cursor:pointer; transition: background 0.2s;}
    .sidebar .icon-btn:hover:not(.active) { background: var(--border); color: var(--text); }
    .sidebar .icon-btn.active{background:var(--accent-secondary);color:#fff}
    .sidebar .brand{margin-bottom:6px;font-weight:800;color:var(--accent-main)}
    
    /* Main Content */
    .main-area{flex:1;padding:16px 20px;overflow:auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;}
    .topbar h3{color:var(--accent-main);}
    
    /* Card Styles */
    .card-neo{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 2px 5px rgba(0,0,0,0.2);margin-bottom:14px;border:1px solid var(--border); transition: all 0.3s;}
    .section-title{font-weight:700;margin-bottom:12px;color:var(--text);font-size:1.1rem;}
    .muted{color:var(--muted)}
    
    /* Form Elements */
    .form-control, .form-select{
        background:var(--input-bg);
        color:var(--text);
        border:1px solid var(--border);
         transition: all 0.3s;
    }
    .form-control::placeholder{color:var(--muted);}
    .form-select{
        /* Use standard Bootstrap arrow color/styling */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        padding-right: 2.25rem;
    }
    .light-mode .form-select{
         background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%236c757d' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }

    /* Buttons */
    .btn-accent{background:var(--accent-main);color:#fff;border:0}
    .btn-accent:hover{background:var(--accent-main);filter: brightness(0.9);}
    .btn-success{background:var(--success);border-color:var(--success);}
    .btn-danger{background:var(--danger);border-color:var(--danger);}
    .btn-outline-primary{color:var(--accent-secondary);border-color:var(--accent-secondary);}
    .btn-outline-secondary{color:var(--muted);border-color:var(--muted);}

    /* Tables */
    .table{
        --bs-table-bg: var(--card);
        --bs-table-color: var(--text);
    }
    table.table td, table.table th{vertical-align:middle; border-color: var(--border);}
    .table-light{background-color:var(--input-bg) !important;}
    .participated-row{background:rgba(59, 130, 246, 0.1) !important;}

    /* small boxes used in attendance / members */
    .small-box{width:72px;height:44px;border-radius:8px;background:var(--input-bg);color:var(--text);display:inline-flex;flex-direction:column;align-items:center;justify-content:center;margin:6px;cursor:pointer;font-weight:700;padding:2px;}
    .small-box.present{background:var(--success);color:#fff}
    .small-box.absent{background:var(--danger);color:#fff}
    .small-box-id{font-size:10px;font-weight:400;color:var(--muted);}
    .small-box.present .small-box-id{color:rgba(255,255,255,0.7);}

    /* Modals */
    .modal-content{background:var(--card);color:var(--text);}
    .modal-header{border-bottom-color: var(--border);}
    .modal-footer{border-top-color: var(--border);}
    .btn-close{filter: invert(1) grayscale(100%) brightness(200%);}
    .light-mode .btn-close{filter: none;}
    
    /* Dashboard Overview Styles */
    .score-card {
        text-align: center;
        padding: 20px;
    }
    .score-value {
        font-size: 2.5rem;
        font-weight: 800;
        margin-top: 5px;
        color: var(--accent-secondary);
    }
    .light-mode .score-value {
        color: var(--accent-main);
    }
  </style>
</head>
<body>
<div class="app-wrap">
  <aside class="sidebar" role="navigation" aria-label="Admin navigation">
    <div class="brand"><i class="bi bi-palette-fill" style="font-size:20px"></i></div>
    <div class="icon-btn active" data-target="#panel-overview" title="Dashboard"><i class="bi bi-columns-gap" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-students" title="Students"><i class="bi bi-people-fill" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-teams" title="Teams"><i class="bi bi-people" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-events" title="Events"><i class="bi bi-calendar-event" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-attendance" title="Attendance"><i class="bi bi-list-check" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-approvals" title="Approvals"><i class="bi bi-check2-square" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-results" title="Results"><i class="bi bi-trophy" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-programs" title="Programs"><i class="bi bi-journal-check" style="font-size:18px"></i></div>
    <div style="flex:1"></div>
    <div class="icon-btn" id="logoutBtnSidebar" title="Logout"><i class="bi bi-box-arrow-right" style="font-size:18px"></i></div>
  </aside>

  <main class="main-area">
    <div class="topbar">
      <div>
        <h3 style="margin:0">Admin Dashboard</h3>
        <div class="muted">Fidak Fest Management Panel</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <div class="muted">Year <span id="current-year"></span></div>
        <button id="toggleDarkModeTop" class="btn btn-outline-secondary" title="Toggle Mode"><i class="bi bi-moon-stars"></i></button>
        <button id="logoutBtnTop" class="btn btn-danger">Logout</button>
      </div>
    </div>

    <div id="panels">
      <section id="panel-overview" class="card-neo">
        <div class="section-title">Live Overview</div>
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card-neo">
                    <div class="section-title">Team Score Leaderboard</div>
                    <div class="table-responsive" style="max-height: 250px; overflow: auto;">
                        <table class="table align-middle">
                            <thead class="table-light"><tr><th>Rank</th><th>Team</th><th>Score</th></tr></thead>
                            <tbody id="leaderboardTable">
                                <tr><td colspan="3" class="text-center muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Total Teams</div>
                            <div id="totalTeamsCount" class="score-value">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Total Students</div>
                            <div id="totalStudentsCount" class="score-value">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Pending Approvals</div>
                            <div id="pendingApprovalsCount" class="score-value" style="color:var(--danger)">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Draft Results</div>
                            <div id="draftResultsCount" class="score-value" style="color:var(--warning)">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>
      <section id="panel-students" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title">Import Students (Excel)</div>
              <div class="muted mb-2">Columns: Chess, Name, Level (Senior/Junior), Team (optional)</div>
              <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2 mb-2">
                <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
                <button id="importStudents" class="btn btn-accent">Import</button>
              </div>
              <hr style="border-top: 1px solid var(--border);">
              <div class="section-title">Add Student Manually</div>
              <input id="manualChess" class="form-control mb-2" placeholder="Chess ID (alphanumeric)">
              <input id="manualName" class="form-control mb-2" placeholder="Full Name">
              <select id="manualLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
              <select id="manualTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
              <button id="addManualStudent" class="btn btn-success w-100">Add Student</button>
              <hr style="border-top: 1px solid var(--border);">
              <div class="section-title">Preview</div>
              <div id="studentsPreview" style="max-height:260px;overflow:auto"></div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="section-title">All Students</div>
                <div class="d-flex gap-2">
                  <input id="searchStudents" class="form-control" placeholder="Search name or chess #">
                  <button id="downloadStudentsPdf" class="btn btn-outline-secondary" title="Export Student List"><i class="bi bi-file-earmark-pdf"></i></button>
                </div>
              </div>
              <div class="table-responsive" style="max-height:520px;overflow:auto">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Chess #</th><th>Name</th><th>Level</th><th>Team</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="studentsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="panel-teams" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title">Create Team</div>
              <input id="teamName" class="form-control mb-2" placeholder="Team Name">
              <select id="teamLeader" class="form-select mb-2"><option value="">Choose leader (Chess #)</option></select>
              <input id="teamPassword" class="form-control mb-2" placeholder="Password (optional)">
              <div class="d-flex gap-2">
                <button id="saveTeam" class="btn btn-success">Save Team</button>
                <button id="clearTeam" class="btn btn-outline-secondary">Clear</button>
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card-neo">
              <div class="section-title">Teams & Attendance</div>
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Attendance %</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="teamsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-events" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo mb-3">
              <div class="section-title">Add Event</div>
              <input id="eventName" class="form-control mb-2" placeholder="Event Name">
              <select id="eventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option><option>Group</option><option>Open</option><option>Special</option></select>
              <select id="eventLevel" class="form-select mb-2"><option>Junior</option><option>Senior</option><option>General</option><option>Special</option></select>
              <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Description / rules"></textarea>
              <div class="d-flex gap-2"><button id="saveEvent" class="btn btn-accent">Save Event</button><button id="downloadEventsPdf" class="btn btn-outline-secondary" title="Export Event List"><i class="bi bi-file-earmark-pdf"></i></button></div>
            </div>

            <div class="card-neo">
              <div class="section-title">Import Events (Excel)</div>
              <div class="muted mb-2">If same name but different Type/Level, it will be saved as distinct event</div>
              <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2"><button id="previewEvents" class="btn btn-outline-primary">Preview</button><button id="importEvents" class="btn btn-accent">Import</button></div>
              <div id="eventsPreview" style="max-height:220px;overflow:auto" class="mt-2"></div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="section-title">Events List</div>
                <div class="d-flex gap-2">
                  <input id="filterEventSearch" class="form-control" placeholder="Search events by name/type/level">
                  <button id="filterEventsBtn" class="btn btn-outline-secondary">Search</button>
                </div>
              </div>
              <div class="table-responsive" style="max-height:520px;overflow:auto">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Level</th><th>Description</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="eventsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-attendance" class="card-neo d-none">
        <div class="card-neo mb-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-2"><input id="attDate" type="date" class="form-control"></div>
            <div class="col-md-2"><input id="attTime" type="time" class="form-control"></div>
            <div class="col-md-4"><input id="attDesc" class="form-control" placeholder="Description"></div>
            <div class="col-md-2"><select id="attMethod" class="form-select"><option value="all">All</option><option value="team">By Team</option></select></div>
            <div class="col-md-2 d-none" id="attTeamWrap"><select id="attTeam" class="form-select"></select></div>
          </div>
          <div class="mt-3 d-flex gap-2"><button id="loadAttendance" class="btn btn-info" style="background:#3b82f6;border-color:#3b82f6;">Load Students</button><button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button><button id="saveAttendance" class="btn btn-success">Save Session</button></div>
        </div>

        <div id="attendanceMarkCard" class="card-neo" style="display:none">
          <div class="section-title">Mark Attendance</div>
          <div class="muted mb-2">Click a box to toggle Present/Absent. Hover to see name (small text).</div>
          <div id="attendanceBoxes" style="padding:12px;display:flex;flex-direction:column;gap:8px"></div>
        </div>

        <div class="card-neo">
          <div class="section-title">Saved Sessions</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Date</th><th>Time</th><th>Description</th><th>Count</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="attendanceSessions"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="panel-approvals" class="card-neo d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div>
            <div class="section-title">Event Participation Summary</div>
            <div class="muted">Review pending submissions and view approved members by event</div>
          </div>
          <div class="d-flex gap-2">
            <input id="searchApprovals" class="form-control" placeholder="Search event name, type, or level...">
            <button id="downloadApprovalsPdf" class="btn btn-outline-secondary" title="Export Approved Roster"><i class="bi bi-file-earmark-pdf"></i> Export Roster</button>
          </div>
        </div>

        <div class="table-responsive" style="max-height:420px;overflow:auto">
          <table class="table table-hover">
            <thead><tr><th>Event</th><th>Type/Level</th><th>Pending</th><th>Approved</th><th class="text-end">Actions</th></tr></thead>
            <tbody id="approvalsTable"></tbody>
          </table>
        </div>
      </section>
      
      <section id="panel-results" class="card-neo d-none">
        <div class="card-neo">
          <div class="section-title">Add / Manage Results</div>
          <div class="row g-2 align-items-center">
            <div class="col-md-4">
              <select id="resultEvent" class="form-select"><option value="">Select event</option></select>
            </div>
            <div class="col-md-3">
              <select id="resultSelectFirst" class="form-select"><option value="">1st — select</option></select>
            </div>
            <div class="col-md-2"><input id="resultPointsFirst" type="number" class="form-control" placeholder="Points"></div>

            <div class="col-md-3"></div>

            <div class="col-md-3">
              <select id="resultSelectSecond" class="form-select"><option value="">2nd — select</option></select>
            </div>
            <div class="col-md-2"><input id="resultPointsSecond" type="number" class="form-control" placeholder="Points"></div>

            <div class="col-md-3"></div>

            <div class="col-md-3">
              <select id="resultSelectThird" class="form-select"><option value="">3rd — select</option></select>
            </div>
            <div class="col-md-2"><input id="resultPointsThird" type="number" class="form-control" placeholder="Points"></div>

            <div class="col-md-2 d-flex gap-2">
              <button id="saveResult" class="btn btn-success">Save Draft</button>
              <button id="publishAllResults" class="btn btn-accent">Publish</button>
            </div>
          </div>
        </div>

        <div class="card-neo mt-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="section-title">Results List (All Events with Points)</div>
            <input id="searchResults" class="form-control w-50" placeholder="Search event name, type, or level...">
          </div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Event</th><th>Type/Level</th><th>1st</th><th>2nd</th><th>3rd</th><th>Points Total</th><th>Published</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="resultsTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="panel-programs" class="card-neo d-none">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="section-title">Event Programs Management</div>
          <input id="searchPrograms" class="form-control w-50" placeholder="Search event name, type, or level...">
        </div>
        <div class="muted mb-3">View approved participants and manage event attendance/coding.</div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Event Name</th><th>Type</th><th>Level</th><th>Approved Members</th><th class="text-end">Actions</th></tr></thead>
            <tbody id="programsTable"></tbody>
          </table>
        </div>
      </section>
      </div> </main>
</div>

<input type="hidden" id="editStudentDbKey">
<input type="hidden" id="editEventDbKey">
<input type="hidden" id="editResultDbKey">

<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Student</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">Chess #</label><input id="editChess" class="form-control mb-2" readonly>
        <label class="form-label">Name</label><input id="editName" class="form-control mb-2" required>
        <label class="form-label">Level</label><select id="editLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
        <label class="form-label">Team</label><select id="editTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
      </div>
      <div class="modal-footer"><button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>

<div class="modal fade" id="editEventModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editEventForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Event</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">Event Name</label><input id="editEventName" class="form-control mb-2" required>
        <label class="form-label">Type</label><select id="editEventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option><option>Group</option><option>Open</option><option>Special</option></select>
        <label class="form-label">Level</label><select id="editEventLevel" class="form-select mb-2"><option>Junior</option><option>Senior</option><option>General</option><option>Special</option></select>
        <label class="form-label">Description</label><textarea id="editEventDesc" class="form-control mb-2" rows="4"></textarea>
      </div>
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Save Event</button></div>
    </form>
  </div>
</div>

<div class="modal fade" id="editResultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editResultForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Result</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">Event</label><input id="editResultEventName" class="form-control mb-2" readonly>
        <label class="form-label">1st</label><select id="editResFirst" class="form-select mb-2"></select><input id="editPtsFirst" type="number" class="form-control mb-2" placeholder="Points">
        <label class="form-label">2nd</label><select id="editResSecond" class="form-select mb-2"></select><input id="editPtsSecond" type="number" class="form-control mb-2" placeholder="Points">
        <label class="form-label">3rd</label><select id="editResThird" class="form-select mb-2"></select><input id="editPtsThird" type="number" class="form-control mb-2" placeholder="Points">
      </div>
      <div class="modal-footer"><button type="button" id="deleteResultBtn" class="btn btn-danger">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>

<div class="modal fade" id="approvalsDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="approvalModalTitle">Event Participants</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="section-title" id="pendingSectionTitle">Pending Submissions</div>
        <div class="table-responsive mb-4">
          <table class="table table-sm">
            <thead><tr><th>Student</th><th>Team</th><th class="text-end">Actions</th></tr></thead>
            <tbody id="pendingParticipantsTable"></tbody>
          </table>
        </div>

        <div class="section-title" id="approvedSectionTitle">Approved Participants</div>
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>Student</th><th>Team</th><th>Approved At</th><th class="text-end">Actions</th></tr></thead>
            <tbody id="approvedParticipantsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="programDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="programModalTitle">Event Participants: </h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div id="programAttendanceStatus" class="section-title" style="margin-bottom:0;">Approved Members Attendance</div>
          <div class="d-flex gap-2">
            <button id="toggleProgramAttendance" class="btn btn-outline-secondary">Toggle All Present</button>
            <button id="saveProgramAttendance" class="btn btn-success">Save Attendance</button>
            <button id="assignRandomLetters" class="btn btn-warning"><i class="bi bi-shuffle"></i> Assign Letters (A, B, C...)</button>
          </div>
        </div>
        
        <div class="muted mb-3">Click box to toggle Present/Absent. Letter code is displayed on top if assigned.</div>
        
        <div id="programAttendanceBoxes" style="padding:12px;display:flex;flex-wrap:wrap;gap:8px;">
          </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
/* Final admin.js embedded - FULL CODE */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

/* Firebase config - use your keys */
const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* helpers */
const $ = id => document.getElementById(id);
function toast(msg,type='success'){ const el=document.createElement('div'); el.className=`toast align-items-center text-bg-${type} border-0`; el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`; $('panels').appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast', ()=>el.remove()); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function encodeKey(k){ return encodeURIComponent(String(k)); }
function decodeKey(k){ return decodeURIComponent(String(k)); }

/* caches & keymaps */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {}, programAttendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, participations: {}, results: {} };

/* db refs */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');
const programAttendanceRef = ref(db, 'programAttendance'); 

/* realtime listeners */
onValue(studentsRef, snap => { const obj = snap.val() || {}; CACHE.students = Object.values(obj); KEYMAP.students = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.students[String(v.id)] = k)); renderAll(); });
onValue(teamsRef, snap => { const obj = snap.val() || {}; CACHE.teams = Object.values(obj); KEYMAP.teams = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.teams[String(v.id)] = k)); renderAll(); });
onValue(eventsRef, snap => { const obj = snap.val() || {}; CACHE.events = Object.values(obj); KEYMAP.events = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.events[String(v.id)] = k)); renderAll(); });
onValue(partsRef, snap => { const obj = snap.val() || {}; CACHE.participations = Object.values(obj); KEYMAP.participations = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.participations[String(v.id)] = k)); renderAll(); });
onValue(resultsRef, snap => { const obj = snap.val() || {}; CACHE.results = Object.values(obj); KEYMAP.results = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.results[String(v.id)] = k)); renderAll(); });
onValue(attendanceRef, snap => { CACHE.attendance = snap.val() || {}; renderAll(); });
onValue(programAttendanceRef, snap => { CACHE.programAttendance = snap.val() || {}; renderAll(); });

/* NAV wiring */
document.querySelectorAll('.sidebar .icon-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
    const panel = document.querySelector(btn.dataset.target);
    if(panel) panel.classList.remove('d-none');
    document.querySelectorAll('.sidebar .icon-btn').forEach(i=> i.classList.remove('active'));
    btn.classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

/* top actions */
function handleLogout() {
    sessionStorage.clear(); 
    window.location.href = 'index.html'; 
}
$('logoutBtnSidebar').addEventListener('click', handleLogout); 
$('logoutBtnTop').addEventListener('click', handleLogout); 

// Dark/Light Mode Toggle
$('toggleDarkModeTop').addEventListener('click', () => {
    document.body.classList.toggle('light-mode');
});


$('current-year').textContent = new Date().getFullYear();

/* RENDER ALL */
function renderAll(){
  populateDropdowns();
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceSessions();
  renderApprovals();
  renderResults();
  renderPrograms();
  renderOverview(); 
}

/* ---------- NEW DASHBOARD OVERVIEW ---------- */
function renderOverview() {
    const totalTeams = CACHE.teams.length;
    const totalStudents = CACHE.students.length;
    const pendingApprovals = CACHE.participations.filter(p => String(p.status).toLowerCase() === 'pending').length;
    
    // Calculate Draft Results count (Event has results but is not fully published)
    let draftResultsCount = 0;
    const evMap = {};
    CACHE.results.forEach(r => { 
        if(!evMap[r.eventId]) evMap[r.eventId] = { isPublished: true, hasResult: false }; 
        evMap[r.eventId].isPublished = evMap[r.eventId].isPublished && (r.published === true);
        evMap[r.eventId].hasResult = true;
    });

    Object.values(evMap).forEach(data => {
        if (data.hasResult && !data.isPublished) {
            draftResultsCount++;
        }
    });

    $('totalTeamsCount').textContent = totalTeams;
    $('totalStudentsCount').textContent = totalStudents;
    $('pendingApprovalsCount').textContent = pendingApprovals;
    $('draftResultsCount').textContent = draftResultsCount;

    // Leaderboard
    const leaderboard = CACHE.teams.slice().sort((a, b) => (b.score || 0) - (a.score || 0));
    const tbody = $('leaderboardTable');
    let html = '';
    if (leaderboard.length === 0) {
        html = '<tr><td colspan="3" class="text-center muted">No teams found.</td></tr>';
    } else {
        leaderboard.forEach((t, index) => {
            html += `<tr><td>${index + 1}</td><td>${escapeHtml(t.name)}</td><td>${t.score || 0}</td></tr>`;
        });
    }
    tbody.innerHTML = html;
}
/* ---------- END NEW DASHBOARD OVERVIEW ---------- */


/* ---------- STUDENT FUNCTIONS ---------- */
function studentIdExists(id){ return CACHE.students.some(s => String(s.id) === String(id)); }
function studentNameExists(name){ if(!name) return false; const n = String(name).trim().toLowerCase(); return CACHE.students.some(s => String(s.name||'').trim().toLowerCase() === n); }

/* preview import */
let studentsPreviewRows = [];
$('previewStudents').addEventListener('click', ()=> {
  const f = $('studentFile').files[0]; if(!f) return toast('Select Excel file','danger');
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' });
    studentsPreviewRows = json.slice(0,500);
    renderStudentsPreview();
  };
  r.readAsBinaryString(f);
});
function renderStudentsPreview(){
  const wrap = $('studentsPreview'); if(!studentsPreviewRows.length){ wrap.innerHTML = '<div class="muted">No preview</div>'; return;}
  let html = `<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>`;
  studentsPreviewRows.forEach(r => {
    const chess = (r['Chess']||r['Chess Number']||r['ID']||'').toString();
    const name = (r['Name']||r['name']||'').toString();
    const level = (r['Level']||r['level']||'Senior').toString();
    const team = (r['Team']||r['team']||'').toString();
    html += `<tr><td>${escapeHtml(chess)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(level)}</td><td>${escapeHtml(team)}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}
$('importStudents').addEventListener('click', async ()=>{
  if(!studentsPreviewRows.length) return toast('No preview','danger');
  const teamNameToId = {}; CACHE.teams.forEach(t => { if(t.name) teamNameToId[String(t.name).trim().toLowerCase()] = t.id; });
  const updates = {}; let imported=0, skipped=0;
  studentsPreviewRows.forEach(r => {
    const chessRaw = (r['Chess']||r['Chess Number']||r['ID']||'').toString().trim();
    const nameRaw = (r['Name']||r['name']||'').toString().trim();
    const levelRaw = (r['Level']||r['level']||'Senior').toString().trim();
    if(!chessRaw || !nameRaw){ skipped++; return; }
    const chess = chessRaw; const name = nameRaw;
    if(studentIdExists(chess) || studentNameExists(name)){ skipped++; return; }
    const teamName = (r['Team']||r['team']||'').toString().trim();
    const teamId = teamName ? (teamNameToId[teamName.toLowerCase()] || null) : null;
    updates[`students/${encodeKey(chess)}`] = { id: chess, name, level: levelRaw||'Senior', teamId: teamId ? String(teamId) : null };
    imported++;
  });
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  studentsPreviewRows = []; $('studentsPreview').innerHTML=''; $('studentFile').value='';
  toast(`Imported ${imported}, skipped ${skipped}`);
});

/* manual add */
$('addManualStudent').addEventListener('click', async ()=>{
  const chess = $('manualChess').value.trim(); const name = $('manualName').value.trim(); const level = $('manualLevel').value||'Senior'; const teamId = $('manualTeam').value || null;
  if(!chess || !name) return toast('Enter chess & name','danger');
  if(studentIdExists(chess)) return toast('Chess already exists','danger');
  if(studentNameExists(name)) return toast('Name already exists','danger');
  await set(ref(db, `students/${encodeKey(chess)}`), { id: chess, name, level, teamId: teamId ? String(teamId) : null });
  $('manualChess').value=''; $('manualName').value=''; $('manualTeam').value='';
  toast('Student saved');
});

/* render students */
$('searchStudents')?.addEventListener('input', ()=> renderStudents());
function renderStudents(){
  const tbody = $('studentsTable'); const q = ($('searchStudents')?.value||'').trim().toLowerCase();
  if(!CACHE.students.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No students</td></tr>'; return; }
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
  let html='';
  CACHE.students.forEach(s => {
    const team = s.teamId ? (teamMap[s.teamId] || 'Unknown') : 'Unassigned';
    const text = `${s.id} ${s.name} ${team}`.toLowerCase();
    if(q && !text.includes(q)) return;
    html += `<tr data-key="${encodeKey(s.id)}"><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'Senior')}</td><td>${escapeHtml(team)}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-student">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-student">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="5" class="text-center muted">No students</td></tr>';
}

/* student actions */
$('studentsTable').addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr'); if(!tr) return; const dbKey = tr.dataset.key;
  if(e.target.classList.contains('btn-delete-student')){ if(!confirm('Delete student?')) return; await remove(ref(db, `students/${dbKey}`)); toast('Student deleted'); }
  else if(e.target.classList.contains('btn-edit-student')){
    const snap = await get(ref(db, `students/${dbKey}`)); const s = snap.val(); if(!s) return toast('Not found','danger');
    $('editStudentDbKey').value = dbKey; $('editChess').value = s.id; $('editName').value = s.name||''; $('editLevel').value = s.level||'Senior';
    populateDropdowns(); setTimeout(()=> $('editTeam').value = s.teamId || '', 50);
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
  }
});

/* edit student save/delete */
$('editStudentForm').addEventListener('submit', async (ev)=>{ ev.preventDefault();
  const dbKey = $('editStudentDbKey').value; if(!dbKey) return toast('Missing key','danger');
  const newName = $('editName').value.trim(); const newLevel = $('editLevel').value||'Senior'; const newTeam = $('editTeam').value || null;
  if(!newName) return toast('Name required','danger');
  const curSnap = await get(ref(db, `students/${dbKey}`)); const cur = curSnap.val(); if(!cur) return toast('Not found','danger');
  if(String(newName).trim().toLowerCase() !== String(cur.name||'').trim().toLowerCase()){ if(studentNameExists(newName)) return toast('Name exists','danger'); }
  await update(ref(db, `students/${dbKey}`), { name: newName, level: newLevel, teamId: newTeam ? String(newTeam) : null });
  toast('Student updated'); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});
$('deleteStudentBtn').addEventListener('click', async ()=>{ if(!confirm('Delete?')) return; const dbKey = $('editStudentDbKey').value; await remove(ref(db, `students/${dbKey}`)); toast('Deleted'); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide(); });


/* ---------- TEAMS ---------- */
$('saveTeam').addEventListener('click', async ()=> {
  const name = $('teamName').value.trim(); const leader = $('teamLeader').value || null; const pwd = $('teamPassword').value.trim() || '';
  if(!name) return toast('Team name required','danger');
  const id = Date.now().toString(); const p = push(ref(db, 'teams'));
  await set(p, { id, name, leaderId: leader ? String(leader) : null, password: pwd, locked:false, score:0 });
  $('teamName').value=''; $('teamLeader').value=''; $('teamPassword').value=''; toast('Team saved');
});

/* compute attendance % */
function computeTeamAttendancePct(teamId){
  const attend = CACHE.attendance || {}; const members = CACHE.students.filter(s => String(s.teamId) === String(teamId)).map(s=>String(s.id));
  if(!members.length) return 0; let total=0, present=0;
  for(const k in attend){ const s = attend[k]; if(!s || !s.students) continue; members.forEach(m=>{ if(s.students && s.students[m] !== undefined){ total++; if(String(s.students[m]).toLowerCase() === 'present') present++; } }); }
  return total? Math.round((present/total)*100):0;
}

/* render teams */
function renderTeams(){
  const tbody = $('teamsTable');
  if(!CACHE.teams.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No teams</td></tr>'; return; }
  CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.teams.forEach(t => {
    const leader = CACHE.students.find(s => String(s.id) === String(t.leaderId));
    const members = CACHE.students.filter(s => String(s.teamId) === String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id); const lockBadge = t.locked ? ' <span class="badge bg-danger">Locked</span>' : '';
    html += `<tr data-key="${t.id}"><td>${escapeHtml(t.name)}${lockBadge}</td><td>${leader?escapeHtml(leader.name+' ('+leader.id+')'):'-'}</td><td>${members}</td><td>${pct}%</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-team" data-key="${t.id}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-team" data-key="${t.id}">Delete</button> <button class="btn btn-sm btn-outline-secondary btn-team-pdf" data-team="${escapeHtml(t.id)}">PDF</button></td></tr>`;
  });
  tbody.innerHTML = html;
}

/* team pdf handler (fixed) */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.btn-team-pdf');
  if(!b) return;
  const tid = b.dataset.team;
  const members = CACHE.students.filter(s => String(s.teamId) === String(tid));
  let html = `<h3>Team ${(CACHE.teams.find(tt=>String(tt.id)===String(tid))||{}).name || tid}</h3><table border="1" style="border-collapse:collapse;width:100%"><thead><tr><th>Chess</th><th>Name</th></tr></thead><tbody>`;
  members.forEach(m=> html += `<tr><td>${escapeHtml(m.id)}</td><td>${escapeHtml(m.name)}</td></tr>`);
  html += '</tbody></table>';
  html2pdf().from(html).set({margin:10,filename:`team_${tid}.pdf`}).save();
});

/* team actions: edit/delete */
$('teamsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-team')){ if(!confirm('Delete team?')) return; const dbKey = KEYMAP.teams[id] || id; if(dbKey) await remove(ref(db, `teams/${dbKey}`)); const updates = {}; CACHE.students.filter(s => String(s.teamId) === String(id)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null); if(Object.keys(updates).length) await update(ref(db,'/'), updates); toast('Team deleted'); }
  else if(btn.classList.contains('btn-edit-team')){
    const dbKey = KEYMAP.teams[id] || id; const snap = await get(ref(db, `teams/${dbKey}`)); const t = snap.val(); if(!t) return toast('Team not found','danger');
    // open a simple prompt for edit (keeps file shorter)
    const newName = prompt('Team Name', t.name||''); if(newName===null) return;
    const newPwd = prompt('Password (leave empty to keep current)', t.password||'');
    const locked = confirm('Lock team? OK for locked, Cancel for unlocked');
    await update(ref(db, `teams/${dbKey}`), { name: newName, password: newPwd!==null? newPwd : t.password, locked });
    toast('Team updated');
  }
});


/* ---------- EVENTS ---------- */
function eventKey(name,type,level){ return `${String(name||'').trim().toLowerCase()}||${String(type||'').trim().toLowerCase()}||${String(level||'').trim().toLowerCase()}`; }
$('saveEvent').addEventListener('click', async ()=>{
  const name = $('eventName').value.trim(); const type = $('eventType').value; const level = $('eventLevel').value; const desc = $('eventDescription').value.trim();
  if(!name) return toast('Event name required','danger');
  if(CACHE.events.some(e => eventKey(e.name,e.type,e.level) === eventKey(name,type,level))) return toast('Event (same name+type+level) already exists','danger');
  const p = push(ref(db, 'events')); const id = Date.now().toString();
  await set(p, { id, name, type, level, description: desc, status:'Open', createdAt: Date.now() });
  $('eventName').value=''; $('eventDescription').value=''; toast('Event added');
});

/* preview/import events */
let eventsPreviewRows = [];
$('previewEvents').addEventListener('click', ()=> {
  const f = $('eventFile').files[0]; if(!f) return toast('Choose file','danger');
  const r = new FileReader(); r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' }); const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    eventsPreviewRows = json;
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Level</th><th>Description</th></tr></thead><tbody>';
    json.forEach(rw => html += `<tr><td>${escapeHtml(rw['Name']||rw['Event']||'')}</td><td>${escapeHtml(rw['Type']||'')}</td><td>${escapeHtml(rw['Level']||'')}</td><td>${escapeHtml(rw['Description']||'')}</td></tr>`);
    html += '</tbody></table>'; $('eventsPreview').innerHTML = html;
  }; r.readAsBinaryString(f);
});
$('importEvents').addEventListener('click', async ()=> {
  if(!eventsPreviewRows.length) return toast('No preview','danger');
  const updates = {}; let imported=0, skipped=0;
  eventsPreviewRows.forEach(rw => {
    const name = (rw['Name']||rw['Event']||rw['name']||'').toString().trim(); if(!name){ skipped++; return; }
    const type = (rw['Type']||rw['type']||'Non-Stage').toString().trim(); const level = (rw['Level']||rw['level']||'General').toString().trim();
    if(CACHE.events.some(ev => eventKey(ev.name,ev.type,ev.level) === eventKey(name,type,level))){ skipped++; return; }
    const desc = (rw['Description']||rw['description']||'').toString();
    const id = Date.now().toString() + Math.floor(Math.random()*9999);
    updates[`events/${id}`] = { id, name, type, level, description: desc, status:'Open', createdAt: Date.now() };
    imported++;
  });
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  eventsPreviewRows = []; $('eventFile').value=''; $('eventsPreview').innerHTML='';
  toast(`Imported ${imported}, skipped ${skipped}`);
});

/* event search/filter */
$('filterEventsBtn').addEventListener('click', ()=> renderEvents());
function renderEvents(){
  const tbody = $('eventsTable'); const q = ($('filterEventSearch')?.value||'').trim().toLowerCase();
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No events</td></tr>'; return; }
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html='';
  CACHE.events.forEach(ev => {
    if(q){
      const hay = `${ev.name} ${ev.type} ${ev.level}`.toLowerCase();
      if(!hay.includes(q)) return;
    }
    const participated = CACHE.participations.some(p => String(p.eventId) === String(ev.id) && String(p.status||'').toLowerCase()==='approved');
    const rowClass = participated ? 'participated-row' : '';
    html += `<tr class="${rowClass}" data-key="${ev.id}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.type)}</td><td>${escapeHtml(ev.level||'')}</td><td>${escapeHtml((ev.description||'').slice(0,120))}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-event" data-key="${ev.id}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-event" data-key="${ev.id}">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="5" class="text-center muted">No events match</td></tr>';
}

/* event actions */
$('eventsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.key;
  if(btn.classList.contains('btn-delete-event')){ if(!confirm('Delete event?')) return; const dbKey = KEYMAP.events[id] || id; if(dbKey) await remove(ref(db, `events/${dbKey}`)); toast('Event removed'); }
  else if(btn.classList.contains('btn-edit-event')){ const dbKey = KEYMAP.events[id] || id; const snap = await get(ref(db, `events/${dbKey}`)); const ev = snap.val(); if(!ev) return toast('Not found','danger'); $('editEventDbKey').value = dbKey; $('editEventName').value = ev.name||''; $('editEventType').value = ev.type||'Non-Stage'; $('editEventLevel').value = ev.level||'General'; $('editEventDesc').value = ev.description||''; new bootstrap.Modal(document.getElementById('editEventModal')).show(); }
});
$('editEventForm').addEventListener('submit', async (ev)=>{ ev.preventDefault(); const dbKey = $('editEventDbKey').value; if(!dbKey) return toast('Missing key','danger'); const name = $('editEventName').value.trim(); const type = $('editEventType').value; const level = $('editEventLevel').value; const desc = $('editEventDesc').value.trim(); if(!name) return toast('Name required','danger');
  const other = CACHE.events.find(e => eventKey(e.name,e.type,e.level) === eventKey(name,type,level) && KEYMAP.events[e.id] !== dbKey);
  if(other) return toast('Event with same name+type+level exists','danger');
  await update(ref(db, `events/${dbKey}`), { name, type, level, description: desc });
  toast('Event updated'); bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
});


/* ---------- ATTENDANCE ---------- */
let attendanceToggleState = 'none';
let editingAttendanceDbKey = null;

$('attMethod').addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));
$('loadAttendance').addEventListener('click', ()=> {
  const method = $('attMethod').value; const teamId = $('attTeam').value;
  let list = method === 'all' ? CACHE.students.slice() : CACHE.students.filter(s => String(s.teamId) === String(teamId));
  const wrap = $('attendanceBoxes'); wrap.innerHTML = '';

  if(method === 'all'){
    const teamsMap = {}; CACHE.teams.forEach(t => teamsMap[t.id] = t.name);
    const byTeam = {};
    list.forEach(s => { const tid = s.teamId || '__unassigned'; if(!byTeam[tid]) byTeam[tid] = []; byTeam[tid].push(s); });
    Object.keys(byTeam).forEach(tid => {
      const groupTitle = document.createElement('div'); groupTitle.innerHTML = `<div style="font-weight:700;margin:8px 0">${escapeHtml(teamsMap[tid]||'Unassigned')}</div>`; wrap.appendChild(groupTitle);
      const groupBox = document.createElement('div'); groupBox.style.display='flex'; groupBox.style.flexWrap='wrap';
      byTeam[tid].forEach(s => {
        const div = document.createElement('div'); div.className = 'small-box absent'; div.dataset.key = encodeKey(s.id); div.dataset.name = s.name || ''; div.title = s.name || ''; div.textContent = s.id;
        div.addEventListener('click', ()=> toggleAttendanceBox(div));
        groupBox.appendChild(div);
      });
      wrap.appendChild(groupBox);
    });
  } else {
    list.forEach(s => {
      const div = document.createElement('div'); div.className = 'small-box absent'; div.dataset.key = encodeKey(s.id); div.dataset.name = s.name || ''; div.title = s.name || ''; div.textContent = s.id;
      div.addEventListener('click', ()=> toggleAttendanceBox(div));
      wrap.appendChild(div);
    });
  }

  $('attendanceMarkCard').style.display = list.length ? 'block' : 'none';
  attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Set All Present';
  editingAttendanceDbKey = null;
});

function toggleAttendanceBox(el){
  if(el.classList.contains('present')){ el.classList.remove('present'); el.classList.add('absent'); }
  else if(el.classList.contains('absent')){ el.classList.remove('absent'); el.classList.add('present'); }
  else el.classList.add('present');
}
$('toggleAll').addEventListener('click', ()=> {
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box')); if(!boxes.length) return;
  if(attendanceToggleState === 'none' || attendanceToggleState === 'absent'){ boxes.forEach(b => { b.classList.remove('absent'); b.classList.add('present'); }); attendanceToggleState = 'present'; $('toggleAll').textContent = 'Set All Absent'; }
  else { boxes.forEach(b => { b.classList.remove('present'); b.classList.add('absent'); }); attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Set All Present'; }
});

$('saveAttendance').addEventListener('click', async ()=> {
  const date = $('attDate').value; const time = $('attTime').value || ''; if(!date) return toast('Select date','danger');
  const desc = $('attDesc').value || ''; const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return toast('Load students first','danger');
  const studentsObj = {}; boxes.forEach(b => { const id = decodeKey(b.dataset.key); studentsObj[id] = b.classList.contains('present') ? 'Present' : 'Absent'; });
  const payload = { date, time, description: desc, students: studentsObj, savedAt: Date.now() };
  if(editingAttendanceDbKey){ await set(ref(db, `attendance/${editingAttendanceDbKey}`), payload); toast('Attendance updated'); editingAttendanceDbKey = null; } else { const p = push(ref(db, 'attendance')); await set(p, payload); toast('Attendance saved'); }
  $('attendanceMarkCard').style.display = 'none';
});

/* attendance sessions render + view/edit/delete */
function renderAttendanceSessions(){
  const tbody = $('attendanceSessions'); const att = CACHE.attendance || {}; const rows = Object.entries(att);
  if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No sessions</td></tr>'; return; }
  rows.sort((a,b)=> (b[1].savedAt||0) - (a[1].savedAt||0));
  let html=''; rows.forEach(([k,v]) => { const count = v.students ? Object.keys(v.students).length : 0; html += `<tr data-db="${k}"><td>${escapeHtml(v.date||'')}</td><td>${escapeHtml(v.time||'')}</td><td>${escapeHtml(v.description||'')}</td><td>${count}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-view-att" data-db="${k}">View</button> <button class="btn btn-sm btn-outline-secondary btn-edit-att" data-db="${k}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-att" data-db="${k}">Delete</button></td></tr>`; });
  tbody.innerHTML = html;
}
$('attendanceSessions').addEventListener('click', async (e)=> {
  const btn = e.target.closest('button'); if(!btn) return; const dbKey = btn.dataset.db;
  const snap = await get(ref(db, `attendance/${dbKey}`)); const s = snap.val(); if(!s) return toast('Session not found','danger');
  if(btn.classList.contains('btn-view-att')){
    const abs = []; if(s.students) for(const id in s.students) if(String(s.students[id]).toLowerCase() !== 'present') abs.push({ id, status: s.students[id] });
    const container = document.createElement('div');
    container.innerHTML = `<div style="font-weight:700">Date: ${escapeHtml(s.date)} ${escapeHtml(s.time||'')}</div><div class="muted mb-2">${escapeHtml(s.description||'')}</div>`;
    if(!abs.length) container.innerHTML += '<div class="muted">No absentees — all present</div>';
    else {
      container.innerHTML += '<div style="max-height:360px;overflow:auto">';
      abs.forEach(a => {
        const st = CACHE.students.find(st => String(st.id) === String(a.id));
        container.innerHTML += `<div style="padding:6px 4px;border-bottom:1px solid #f1f5ff;font-size:14px">${escapeHtml(st?st.name:a.id)} <span class="muted" style="font-size:13px">(${escapeHtml(a.id)})</span></div>`;
      });
      container.innerHTML += '</div>';
    }
    html2pdf().from(container).set({margin:10,filename:`absentees_${s.date}.pdf`}).save();
    return;
  } else if(btn.classList.contains('btn-edit-att')){
    editingAttendanceDbKey = dbKey; $('attDate').value = s.date||''; $('attTime').value = s.time||''; $('attDesc').value = s.description||'';
    const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
    const teamsMap = {}; CACHE.teams.forEach(t => teamsMap[t.id] = t.name); const byTeam = {};
    CACHE.students.forEach(st => { const tid = st.teamId || '__unassigned'; if(!byTeam[tid]) byTeam[tid] = []; byTeam[tid].push(st); });
    Object.keys(byTeam).forEach(tid => {
      const groupTitle = document.createElement('div'); groupTitle.innerHTML = `<div style="font-weight:700;margin:8px 0">${escapeHtml(teamsMap[tid]||'Unassigned')}</div>`; wrap.appendChild(groupTitle);
      const groupBox = document.createElement('div'); groupBox.style.display='flex'; groupBox.style.flexWrap='wrap';
      byTeam[tid].forEach(st => {
        const status = (s.students && s.students[st.id]) ? s.students[st.id] : 'Absent';
        const div = document.createElement('div'); div.className = 'small-box ' + (status==='Present' ? 'present' : 'absent'); div.dataset.key = encodeKey(st.id); div.dataset.name = st.name || ''; div.textContent = st.id;
        div.addEventListener('click', ()=> toggleAttendanceBox(div)); groupBox.appendChild(div);
      });
      wrap.appendChild(groupBox);
    });
    $('attendanceMarkCard').style.display = 'block'; toast('Loaded session for edit');
  } else if(btn.classList.contains('btn-delete-att')){
    if(!confirm('Delete session?')) return; await remove(ref(db, `attendance/${dbKey}`)); toast('Deleted');
  }
});


/* ---------- APPROVALS ---------- */
$('searchApprovals')?.addEventListener('input', ()=> renderApprovals());
function renderApprovals(){
  const tbody = $('approvalsTable'); 
  const q = ($('searchApprovals')?.value||'').trim().toLowerCase(); 
  const parts = CACHE.participations || [];
  const partSummary = {};

  CACHE.events.forEach(ev => {
    partSummary[ev.id] = { event: ev, pending: 0, approved: 0 };
  });
  
  parts.forEach(p => {
    const status = String(p.status||'').toLowerCase();
    const evId = String(p.eventId);
    if(partSummary[evId]){
      if(status === 'pending') partSummary[evId].pending++;
      else if(status === 'approved') partSummary[evId].approved++;
    }
  });

  let rows = [];
  Object.values(partSummary).sort((a,b) => (a.event.name||'').localeCompare(b.event.name||'')).forEach(item => {
    const ev = item.event;
    if(q && !`${ev.name||''} ${ev.type||''} ${ev.level||''}`.toLowerCase().includes(q)) return;
    
    rows.push(`<tr data-event-id="${ev.id}">
      <td>${escapeHtml(ev.name)}</td>
      <td>${escapeHtml(ev.type)}/${escapeHtml(ev.level)}</td>
      <td><span class="badge bg-danger">${item.pending} Pending</span></td>
      <td><span class="badge bg-success">${item.approved} Approved</span></td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary btn-view-parts" data-event-id="${ev.id}">Details</button>
        <button class="btn btn-sm btn-outline-secondary btn-event-pdf-summary" data-event-id="${ev.id}" title="Export Roster PDF"><i class="bi bi-file-earmark-pdf"></i></button>
      </td>
    </tr>`);
  });

  tbody.innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No events found or no participations submitted.</td></tr>';
}

// Handler for the new 'Details' button (View participants for an event)
$('approvalsTable').addEventListener('click', (e)=>{
  const btn = e.target.closest('.btn-view-parts'); if(!btn) return;
  const evId = btn.dataset.eventId;
  const ev = CACHE.events.find(e => String(e.id) === String(evId));
  if(!ev) return toast('Event not found','danger');

  const pending = CACHE.participations.filter(p => String(p.eventId) === String(evId) && String(p.status).toLowerCase() === 'pending');
  const approved = CACHE.participations.filter(p => String(p.eventId) === String(evId) && String(p.status).toLowerCase() === 'approved');
  
  const studentMap = {}; CACHE.students.forEach(s => studentMap[s.id] = s.name);
  const teamMap = {}; CACHE.teams.forEach(t => teamMap[t.id] = t.name);

  // Render Pending Table
  let pendingHtml = '';
  pending.forEach(p => {
    const studentName = studentMap[p.studentId] || p.studentId;
    const teamName = teamMap[p.teamId] || 'Unassigned';
    pendingHtml += `<tr data-key="${p.id}">
      <td>${escapeHtml(studentName)} (${escapeHtml(p.studentId)})</td>
      <td>${escapeHtml(teamName)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-success btn-approve-inline" data-key="${p.id}">Approve</button> 
        <button class="btn btn-sm btn-danger btn-reject-inline" data-key="${p.id}">Reject</button>
      </td>
    </tr>`;
  });
  $('pendingParticipantsTable').innerHTML = pendingHtml || '<tr><td colspan="3" class="muted">No pending submissions.</td></tr>';
  $('pendingSectionTitle').textContent = `Pending Submissions (${pending.length})`;


  // Render Approved Table
  let approvedHtml = '';
  approved.forEach(p => {
    const studentName = studentMap[p.studentId] || p.studentId;
    const teamName = teamMap[p.teamId] || 'Unassigned';
    approvedHtml += `<tr>
      <td>${escapeHtml(studentName)} (${escapeHtml(p.studentId)})</td>
      <td>${escapeHtml(teamName)}</td>
      <td>${new Date(p.approvedAt||0).toLocaleString()}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-danger btn-unapprove-inline" data-key="${p.id}">Unapprove</button>
      </td>
    </tr>`;
  });
  $('approvedParticipantsTable').innerHTML = approvedHtml || '<tr><td colspan="4" class="muted">No approved participants.</td></tr>';
  $('approvedSectionTitle').textContent = `Approved Participants (${approved.length})`;

  $('approvalModalTitle').textContent = `Participants for: ${ev.name}`;
  new bootstrap.Modal(document.getElementById('approvalsDetailModal')).show();
});

// Inline Action Handlers (must be outside the table click listener)
document.addEventListener('click', async (e)=>{
  const key = e.target.dataset.key; if(!key) return;
  const dbKey = KEYMAP.participations[key] || key;

  if(e.target.classList.contains('btn-approve-inline')){ 
    await update(ref(db, `participations/${dbKey}`), { status:'approved', approvedAt: Date.now(), rejectedAt: null }); 
    toast('Approved'); 
    renderAll(); 
  }
  else if(e.target.classList.contains('btn-reject-inline')){ 
    await update(ref(db, `participations/${dbKey}`), { status:'rejected', rejectedAt: Date.now(), approvedAt: null }); 
    toast('Rejected'); 
    renderAll();
  }
  else if(e.target.classList.contains('btn-unapprove-inline')){ 
    await update(ref(db, `participations/${dbKey}`), { status:'pending', approvedAt: null, rejectedAt: null }); 
    toast('Unapproved (Set back to Pending)'); 
    renderAll();
  }
});

/* New PDF Export for Event Participation Summary (Applies to individual event PDF from Approvals Summary) */
function exportRosterPdf(evId, allEvents = false) {
    const approvedParts = CACHE.participations.filter(p => String(p.status||'').toLowerCase()==='approved' && (allEvents || String(p.eventId) === String(evId)));
    
    if (approvedParts.length === 0) return toast('No approved participations to export.','warning');

    const teamMap = {}; CACHE.teams.forEach(t => teamMap[t.id] = t);
    const studentMap = {}; CACHE.students.forEach(s => studentMap[s.id] = s);
    const eventsMap = {}; CACHE.events.forEach(e => eventsMap[e.id] = e);

    // Grouping logic
    const rosterData = {};
    approvedParts.forEach(p => {
        const ev = eventsMap[p.eventId];
        const student = studentMap[p.studentId];
        const team = student ? teamMap[student.teamId] : { name: 'N/A' };
        
        if (!rosterData[p.eventId]) {
            rosterData[p.eventId] = { event: ev, members: [] };
        }
        if (student) {
            rosterData[p.eventId].members.push({
                name: student.name,
                id: student.id,
                teamName: team.name
            });
        }
    });

    const date = new Date().toISOString().slice(0,10);
    const title = allEvents ? "All Approved Participation Rosters" : `Roster for ${rosterData[evId].event.name}`;
    const filename = allEvents ? `approved_roster_all_${date}.pdf` : `approved_roster_${rosterData[evId].event.name.replace(/[^a-z0-9]/gi, '_')}.pdf`;

    let eventsHtml = '';
    Object.values(rosterData).forEach(item => {
        const ev = item.event;
        eventsHtml += `
            <div style="text-align: center; margin-top: 30px; page-break-before: auto;">
                <h4 style="margin: 0;">${escapeHtml(ev.name)}</h4>
                <p style="margin: 0; font-size: 14px;">${escapeHtml(ev.level)} / ${escapeHtml(ev.type)}</p>
            </div>
            <div style="margin: 10px 0; border: 1px solid #000; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #ccc;">
                            <th style="text-align: left; padding: 5px;">Member Name</th>
                            <th style="text-align: left; padding: 5px;">Chess #</th>
                            <th style="text-align: left; padding: 5px;">Team Name</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        item.members.forEach(member => {
            eventsHtml += `
                <tr>
                    <td style="padding: 5px; font-size: 13px;">${escapeHtml(member.name)}</td>
                    <td style="padding: 5px; font-size: 13px;">${escapeHtml(member.id)}</td>
                    <td style="padding: 5px; font-size: 13px;">${escapeHtml(member.teamName)}</td>
                </tr>
            `;
        });
        eventsHtml += `
                    </tbody>
                </table>
            </div>
        `;
    });

    const htmlContent = `
        <div style="font-family: Arial, sans-serif; position: relative; color: #000;">
            <div style="
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                opacity: 0.1; z-index: -1000; text-align: center; 
                display: flex; justify-content: center; align-items: center;
                pointer-events: none;
            ">
                <h1 style="font-size: 100px;">FIDAK FEST</h1> 
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>${title}</h2>
                <p>Date Generated: ${date}</p>
            </div>
            ${eventsHtml}
        </div>
    `;

    html2pdf().from(htmlContent).set({
        margin: [10, 10, 10, 10],
        filename: filename,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();
}

// Handler for Export Roster PDF button (in Approvals Summary)
$('downloadApprovalsPdf').addEventListener('click', () => exportRosterPdf(null, true));

// Handler for individual event PDF button (in Approvals Summary table row)
$('approvalsTable').addEventListener('click', (e) => {
    const btn = e.target.closest('.btn-event-pdf-summary');
    if (btn) {
        const evId = btn.dataset.eventId;
        exportRosterPdf(evId, false);
    }
});

/* Student List PDF (Updated format) */
$('downloadStudentsPdf').addEventListener('click', ()=> {
    const date = new Date().toISOString().slice(0,10);
    const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
    let tableRows = '';
    CACHE.students.forEach(s => {
        tableRows += `
            <tr>
                <td style="padding: 5px; font-size: 13px;">${escapeHtml(s.name)}</td>
                <td style="padding: 5px; font-size: 13px;">${escapeHtml(s.id)}</td>
                <td style="padding: 5px; font-size: 13px;">${escapeHtml(teamMap[s.teamId]||'Unassigned')}</td>
            </tr>
        `;
    });

    const htmlContent = `
        <div style="font-family: Arial, sans-serif; position: relative; color: #000;">
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; z-index: -1000; text-align: center; display: flex; justify-content: center; align-items: center; pointer-events: none;">
                <h1 style="font-size: 100px;">FIDAK FEST</h1> 
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Student List</h2>
                <p>Date Generated: ${date}</p>
            </div>
            <div style="margin: 10px 0; border: 1px solid #000; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #ccc;">
                            <th style="text-align: left; padding: 5px;">Name</th>
                            <th style="text-align: left; padding: 5px;">Chess #</th>
                            <th style="text-align: left; padding: 5px;">Team Name</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        </div>
    `;
    html2pdf().from(htmlContent).set({
        margin: [10, 10, 10, 10], filename: `students_${date}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();
});

/* Event List PDF (Updated format) */
$('downloadEventsPdf').addEventListener('click', ()=> {
    const date = new Date().toISOString().slice(0,10);
    let tableRows = '';
    CACHE.events.forEach(e => {
        tableRows += `
            <tr>
                <td style="padding: 5px; font-size: 13px;">${escapeHtml(e.name)}</td>
                <td style="padding: 5px; font-size: 13px;">${escapeHtml(e.type)}</td>
                <td style="padding: 5px; font-size: 13px;">${escapeHtml(e.level||'')}</td>
            </tr>
        `;
    });

    const htmlContent = `
        <div style="font-family: Arial, sans-serif; position: relative; color: #000;">
            <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.1; z-index: -1000; text-align: center; display: flex; justify-content: center; align-items: center; pointer-events: none;">
                <h1 style="font-size: 100px;">FIDAK FEST</h1> 
            </div>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <h2>Event List</h2>
                <p>Date Generated: ${date}</p>
            </div>
            <div style="margin: 10px 0; border: 1px solid #000; padding: 10px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #ccc;">
                            <th style="text-align: left; padding: 5px;">Name</th>
                            <th style="text-align: left; padding: 5px;">Type</th>
                            <th style="text-align: left; padding: 5px;">Level</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        </div>
    `;
    html2pdf().from(htmlContent).set({
        margin: [10, 10, 10, 10], filename: `events_${date}.pdf`, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).save();
});


/* ---------- RESULTS ---------- */
$('searchResults')?.addEventListener('input', ()=> renderResults());


/* ---------- PROGRAMS (NEW) ---------- */
let currentProgramEventId = null;

$('searchPrograms')?.addEventListener('input', ()=> renderPrograms());
function renderPrograms(){
  const tbody = $('programsTable');
  const q = ($('searchPrograms')?.value||'').trim().toLowerCase(); 

  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No events</td></tr>'; return; }
  
  let html='';
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  
  CACHE.events.forEach(ev => {
    if(q && !`${ev.name} ${ev.type} ${ev.level}`.toLowerCase().includes(q)) return;
    
    const approvedCount = CACHE.participations.filter(p => String(p.eventId) === String(ev.id) && String(p.status||'').toLowerCase()==='approved').length;
    
    html += `<tr data-event-id="${ev.id}">
      <td>${escapeHtml(ev.name)}</td>
      <td>${escapeHtml(ev.type)}</td>
      <td>${escapeHtml(ev.level)}</td>
      <td>${approvedCount} Approved</td>
      <td class="text-end">
        <button class="btn btn-sm btn-accent btn-program-details" data-ev="${ev.id}">Details</button>
      </td>
    </tr>`;
  });
  
  tbody.innerHTML = html || '<tr><td colspan="5" class="text-center muted">No events match search criteria.</td></tr>';
}

// Handler for the "Details" button in Programs panel
$('programsTable').addEventListener('click', (e) => {
  const btn = e.target.closest('.btn-program-details');
  if (!btn) return;

  const evId = btn.dataset.ev;
  const ev = CACHE.events.find(e => String(e.id) === String(evId));
  if (!ev) return toast('Event not found', 'danger');

  currentProgramEventId = evId;
  $('programModalTitle').textContent = `Event Participants: ${ev.name}`;
  
  loadProgramDetails(evId);
  new bootstrap.Modal(document.getElementById('programDetailModal')).show();
});

// Load the small boxes for a specific event
function loadProgramDetails(evId) {
  const participants = CACHE.participations.filter(p => String(p.eventId) === String(evId) && String(p.status||'').toLowerCase()==='approved');
  const studentMap = {}; CACHE.students.forEach(s => studentMap[s.id] = s);
  const boxesWrap = $('programAttendanceBoxes');
  boxesWrap.innerHTML = '';
  
  const eventData = CACHE.programAttendance[evId] || {};

  participants.forEach(p => {
    const student = studentMap[p.studentId];
    if (!student) return;

    const attStatus = eventData[p.studentId]?.status || 'Absent';
    const code = eventData[p.studentId]?.code || '';

    const div = document.createElement('div');
    div.className = `small-box ${attStatus === 'Present' ? 'present' : 'absent'}`;
    div.dataset.id = p.studentId;
    div.dataset.name = student.name;
    div.title = `${student.name} (${student.id})`;
    
    const codeSpan = `<span style="font-size:12px;font-weight:bold;color:var(--warning);">${escapeHtml(code || '-')}</span>`;
    const idSpan = `<span class="small-box-id">${escapeHtml(student.id)}</span>`;

    div.innerHTML = `${codeSpan}${idSpan}`;
    
    div.addEventListener('click', () => toggleProgramAttendanceBox(div, evId));
    boxesWrap.appendChild(div);
  });
  
  $('toggleProgramAttendance').textContent = 'Toggle All Present';
}

// Toggle logic for small boxes in Program Details
function toggleProgramAttendanceBox(el, evId) {
  const isPresent = el.classList.toggle('present');
  el.classList.toggle('absent', !isPresent);
}

// Toggle all attendance
$('toggleProgramAttendance').addEventListener('click', () => {
  const boxes = Array.from(document.querySelectorAll('#programAttendanceBoxes .small-box'));
  if (boxes.length === 0) return;
  
  const allPresent = boxes.every(b => b.classList.contains('present'));
  const newState = allPresent ? 'absent' : 'present';
  
  boxes.forEach(b => {
    b.classList.remove('present', 'absent');
    b.classList.add(newState);
  });

  $('toggleProgramAttendance').textContent = allPresent ? 'Toggle All Present' : 'Toggle All Absent';
});

// Save Program Attendance
$('saveProgramAttendance').addEventListener('click', async () => {
  if (!currentProgramEventId) return toast('No event selected', 'danger');

  const boxes = Array.from(document.querySelectorAll('#programAttendanceBoxes .small-box'));
  const eventData = CACHE.programAttendance[currentProgramEventId] || {};
  const updates = {};
  
  boxes.forEach(b => {
    const studentId = b.dataset.id;
    const status = b.classList.contains('present') ? 'Present' : 'Absent';
    const code = b.querySelector('span:first-child')?.textContent || eventData[studentId]?.code || '';
    
    updates[studentId] = { status, code };
  });

  await set(ref(db, `programAttendance/${currentProgramEventId}`), updates);
  toast('Program attendance and codes saved!', 'success');
  CACHE.programAttendance[currentProgramEventId] = updates;
  loadProgramDetails(currentProgramEventId);
});

// Assign Random Letters
$('assignRandomLetters').addEventListener('click', async () => {
  if (!currentProgramEventId) return toast('No event selected', 'danger');
  
  const boxes = Array.from(document.querySelectorAll('#programAttendanceBoxes .small-box'));
  if (boxes.length === 0) return toast('No participants to assign codes.', 'danger');

  const eventData = CACHE.programAttendance[currentProgramEventId] || {};
  
  const codes = boxes.map((_, i) => String.fromCharCode(65 + i));
  const shuffledCodes = codes.sort(() => Math.random() - 0.5);

  const updates = {};
  boxes.forEach((b, index) => {
    const studentId = b.dataset.id;
    const currentCodeSpan = b.querySelector('span:first-child');
    const newCode = shuffledCodes[index];
    
    if (currentCodeSpan) {
      currentCodeSpan.textContent = newCode;
    }
    
    const status = b.classList.contains('present') ? 'Present' : (eventData[studentId]?.status || 'Absent');
    updates[studentId] = { status, code: newCode };
  });

  await set(ref(db, `programAttendance/${currentProgramEventId}`), updates);
  toast('Random letters assigned and saved!', 'success');
  CACHE.programAttendance[currentProgramEventId] = updates;
  loadProgramDetails(currentProgramEventId);
});


/* ---------- DROPDOWNS & POPULATE ---------- */
function populateDropdowns(){
  const manualTeam = $('manualTeam'); if(manualTeam){ manualTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t => manualTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const teamLeader = $('teamLeader'); if(teamLeader){ teamLeader.innerHTML = '<option value="">Choose leader (Chess #)</option>'; CACHE.students.forEach(s => teamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const attTeam = $('attTeam'); if(attTeam){ attTeam.innerHTML = '<option value="">Select team</option>'; CACHE.teams.forEach(t=> attTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeam = $('editTeam'); if(editTeam){ editTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> editTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const resEv = $('resultEvent'); if(resEv){ resEv.innerHTML = '<option value="">Select event</option>'; CACHE.events.forEach(e => resEv.innerHTML += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`); }
}


/* ---------- bootstrapping ---------- */
setTimeout(()=> {
  document.querySelector('.sidebar .icon-btn[data-target="#panel-overview"]').click();
  renderAll();
}, 600);

console.log('Admin: final script loaded');
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
