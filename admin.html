<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Fidak Fest (Ultimate v6 - Combined)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* -------------------------------------- */
    /* ROOT THEME VARIABLES */
    /* -------------------------------------- */
    :root{
      /* Light Mode (Default) */
      --bg: #f8f9fa; /* Light Grey/White */
      --card: #ffffff; /* White Card */
      --text: #212529; /* Dark Text */
      --muted: #6c757d; /* Grey Muted */
      --border: #dee2e6;
      --input-bg: #e9ecef;
      --accent-main: #0d6efd; /* Bootstrap Blue */
      --accent-secondary: #198754; /* Bootstrap Green */
      --success: #198754; --danger: #dc3545; --warning: #ffc107;
      --sidebar-bg: #ffffff;
      --sidebar-text: #495057;
      --sidebar-active: #0d6efd;
      --sidebar-hover: #f8f9fa;
    }
    /* Dark Mode Toggle */
    .dark-mode {
      --bg: #0d121c; 
      --card: #1c2738; 
      --text: #e2e8f0; 
      --muted: #94a3b8;
      --border: #334155; 
      --input-bg: #334155;
      --accent-main: #3b82f6; 
      --accent-secondary: #10b981;
      --success: #10b981; --danger: #ef4444; --warning: #facc15;
      --sidebar-bg: #1c2738;
      --sidebar-text: #cbd5e1;
      --sidebar-active: #3b82f6;
      --sidebar-hover: #334155;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;color:var(--text);background:var(--bg); transition: background 0.3s, color 0.3s;}
    
    /* UI FIX: FIX SIDEBAR */
    .app-wrap{display:flex;min-height:100vh;align-items:stretch}
    
    .sidebar{
        width:70px; 
        background:var(--sidebar-bg); 
        border-right:1px solid var(--border); 
        display:flex;
        flex-direction:column;
        align-items:center;
        padding:12px 6px; 
        z-index: 1000;
        /* UI FIX: Fixed positioning */
        position: fixed; 
        top: 0; 
        bottom: 0;
        height: 100vh;
        box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    }
    .sidebar .icon-btn{
        width:52px;
        height:52px;
        border-radius:12px;
        display:flex;
        align-items:center;
        justify-content:center;
        margin:6px 0;
        color:var(--sidebar-text);
        cursor:pointer; 
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    .sidebar .icon-btn:hover:not(.active) { 
        background: var(--sidebar-hover); 
        color: var(--accent-main);
        border-color: var(--border);
        transform: translateY(-2px);
    }
    .sidebar .icon-btn.active{
        background:var(--sidebar-active);
        color:#fff;
        border-color: var(--sidebar-active);
        box-shadow: 0 4px 12px rgba(13, 110, 253, 0.2);
    }
    .sidebar .brand{
        margin-bottom:10px;
        font-weight:800;
        color:var(--accent-main);
        font-size: 20px;
        padding: 8px;
    }
    
    /* UI FIX: Main content needs margin for fixed sidebar */
    .main-area{
        flex:1;
        padding:16px 20px;
        overflow:auto; 
        margin-left: 70px;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .sidebar {
            width: 60px;
            padding: 8px 4px;
        }
        .sidebar .icon-btn {
            width: 46px;
            height: 46px;
            margin: 4px 0;
        }
        .main-area {
            margin-left: 60px;
            padding: 12px 15px;
        }
        .topbar h3 {
            font-size: 1.2rem;
        }
    }
    
    .topbar{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:16px; 
        border-bottom: 1px solid var(--border); 
        padding-bottom: 12px;
        flex-wrap: wrap;
        gap: 10px;
    }
    .topbar h3{
        color:var(--accent-main);
        margin: 0;
        font-weight: 700;
    }
    
    /* Components */
    .card-neo{
        background:var(--card);
        border-radius:12px;
        padding:20px;
        box-shadow:0 4px 15px rgba(0,0,0,0.05);
        margin-bottom:16px;
        border:1px solid var(--border); 
        transition: background 0.3s, border-color 0.3s;
    }
    .section-title{
        font-weight:700;
        margin-bottom:16px;
        color:var(--text);
        font-size:1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .muted{color:var(--muted)}
    .form-control, .form-select{
        background:var(--input-bg);
        color:var(--text);
        border:1px solid var(--border);
        border-radius: 8px;
        transition: all 0.3s;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--accent-main);
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
    }
    .form-control::placeholder{color:var(--muted);}
    
    /* Tables */
    .table{
        --bs-table-bg: var(--card); 
        --bs-table-color: var(--text); 
        --bs-table-border-color: var(--border);
        transition: background 0.3s, color 0.3s;
        border-radius: 8px;
        overflow: hidden;
    }
    table.table td, table.table th{
        vertical-align:middle; 
        border-color: var(--border);
        padding: 12px 16px;
    }
    .table-light{
        background-color:var(--input-bg) !important;
    }
    .participated-row{background:rgba(13, 110, 253, 0.05) !important;} 
    
    /* Dashboard Scores */
    .score-card {
        text-align: center; 
        padding: 20px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--card) 0%, rgba(13, 110, 253, 0.05) 100%);
    }
    .score-value {
        font-size: 2.5rem; 
        font-weight: 800; 
        margin-top: 5px; 
        color: var(--accent-main);
    }

    /* Small Boxes (Program Management) */
    .small-box{
        width:80px;
        height:50px;
        border-radius:8px;
        background:var(--input-bg);
        color:var(--text);
        display:inline-flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        margin:6px;
        cursor:pointer;
        font-weight:700;
        padding:2px;
        position:relative;
        border:1px solid var(--border);
        transition: all 0.2s;
    }
    .small-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .small-box.present{
        background:var(--success);
        color:#fff;
        border-color:var(--success);
    }
    .small-box.absent{
        background:var(--danger);
        color:#fff;
        border-color:var(--danger);
    }
    .small-box-id{
        font-size:10px;
        font-weight:400;
        color:rgba(255,255,255,0.8);
    }
    .small-box-code{
        position:absolute;
        top:-8px;
        right:-8px;
        background:var(--warning);
        color:#000;
        font-size:11px;
        padding:2px 6px;
        border-radius:10px;
        font-weight:bold;
        box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }

    /* Modals */
    .modal-content{
        background:var(--card);
        color:var(--text);
        border: 1px solid var(--border);
        border-radius: 12px;
        transition: background 0.3s, color 0.3s;
    }
    .modal-header{
        border-bottom-color: var(--border);
        padding: 16px 20px;
    }
    .modal-footer{
        border-top-color: var(--border);
        padding: 16px 20px;
    }
    .btn-close{
        filter: invert(0.5);
    }
    .dark-mode .btn-close{
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    .btn-accent{
        background:var(--accent-main);
        color:#fff;
        border:0;
        border-radius: 8px;
        padding: 8px 16px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn-accent:hover{
        background:#0b5ed7;
        color:#fff;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    }
    
    /* Button Styles */
    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn:hover {
        transform: translateY(-1px);
    }
    .btn-sm {
        padding: 4px 12px;
        font-size: 0.875rem;
    }
    
    /* Approval buttons */
    .btn-approve {
        background: var(--success);
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
    }
    .btn-approve:hover {
        background: #157347;
        color: white;
    }
    .btn-reject {
        background: var(--danger);
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
    }
    .btn-reject:hover {
        background: #bb2d3b;
        color: white;
    }
    .btn-undo {
        background: var(--warning);
        color: #000;
        border: none;
        padding: 4px 12px;
        border-radius: 6px;
        font-size: 0.85rem;
    }
    .btn-undo:hover {
        background: #ffca2c;
        color: #000;
    }
    
    /* Action buttons in tables */
    .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    /* Badges */
    .badge {
        padding: 4px 8px;
        border-radius: 6px;
        font-weight: 500;
    }
    
    /* Mobile optimizations */
    @media (max-width: 576px) {
        .action-buttons {
            flex-direction: column;
        }
        .action-buttons .btn {
            width: 100%;
        }
        .table-responsive {
            font-size: 0.9rem;
        }
        .card-neo {
            padding: 16px;
        }
    }
    
    /* Reset button styling */
    .btn-reset {
        background: var(--danger);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s;
    }
    .btn-reset:hover {
        background: #bb2d3b;
        color: white;
        transform: translateY(-1px);
    }
    
    /* Clear button styling for result modal */
    .btn-clear-first, .btn-clear-second, .btn-clear-third {
        padding: 2px 8px;
        font-size: 0.75rem;
    }
    
    .modal-body .d-flex.gap-2 {
        align-items: center;
    }
    
    .modal-body .form-select {
        flex: 1;
    }
    
    .modal-body .form-control[style*="width: 80px"] {
        min-width: 80px;
    }
    
    /* Result modal specific styling */
    .result-position-group {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        background: var(--input-bg);
    }
    
    .result-position-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .result-position-header h6 {
        margin: 0;
        font-weight: 600;
    }
    
    .result-fields {
        display: flex;
        gap: 10px;
        align-items: center;
    }
  </style>
</head>
<body>
<div class="app-wrap">
  <aside class="sidebar">
    <div class="brand"><i class="bi bi-trophy-fill"></i></div>
    <div class="icon-btn active" data-target="#panel-overview" title="Dashboard"><i class="bi bi-columns-gap"></i></div>
    <div class="icon-btn" data-target="#panel-student-details" title="Search Details"><i class="bi bi-search"></i></div>
    <div class="icon-btn" data-target="#panel-students" title="Students"><i class="bi bi-people-fill"></i></div>
    <div class="icon-btn" data-target="#panel-teams" title="Teams"><i class="bi bi-people"></i></div>
    <div class="icon-btn" data-target="#panel-events" title="Events"><i class="bi bi-calendar-event"></i></div>
    <div class="icon-btn" data-target="#panel-attendance" title="Gen Attendance"><i class="bi bi-list-check"></i></div>
    <div class="icon-btn" data-target="#panel-approvals" title="Approvals"><i class="bi bi-check2-square"></i></div>
    <div class="icon-btn" data-target="#panel-results" title="Results"><i class="bi bi-trophy"></i></div>
    <div style="flex:1"></div>
    <div class="icon-btn" id="systemResetBtn" title="System Reset"><i class="bi bi-arrow-clockwise"></i></div>
    <div class="icon-btn" id="logoutBtn" title="Logout"><i class="bi bi-box-arrow-right"></i></div>
  </aside>

  <main class="main-area">
    <div class="topbar">
      <div>
        <h3>Admin Dashboard</h3>
        <div class="muted">Fidak Fest Management System</div>
      </div>
      <div>
        <button id="toggleThemeBtn" class="btn btn-outline-secondary btn-sm"><i class="bi bi-moon-stars"></i> Theme</button>
      </div>
    </div>

    <div id="panels">
      <section id="panel-overview" class="card-neo">
        <div class="section-title"><i class="bi bi-speedometer2"></i> Live Overview</div>
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card-neo">
                    <div class="section-title"><i class="bi bi-trophy"></i> Team Score Leaderboard</div>
                    <div class="table-responsive" style="max-height: 250px; overflow: auto;">
                        <table class="table align-middle">
                            <thead class="table-light"><tr><th>Rank</th><th>Team</th><th>Score</th></tr></thead>
                            <tbody id="leaderboardTable">
                                <tr><td colspan="3" class="text-center muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Total Teams</div>
                            <div id="totalTeamsCount" class="score-value">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Total Students</div>
                            <div id="totalStudentsCount" class="score-value">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Pending Approvals</div>
                            <div id="pendingApprovalsCount" class="score-value" style="color:var(--danger)">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Draft Results</div>
                            <div id="draftResultsCount" class="score-value" style="color:var(--warning)">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>
      
      <section id="panel-student-details" class="card-neo d-none">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="section-title"><i class="bi bi-search"></i> Search Details Lookup (Student/Event)</div>
            <button id="searchPdfBtn" class="btn btn-outline-secondary btn-sm d-none"><i class="bi bi-file-earmark-pdf"></i> PDF Roster</button>
        </div>
        <input id="studentLookupSearch" class="form-control mb-3" placeholder="Search Student Name/ID (e.g., S101 or Ali) or Event Name (e.g., Quiz)">
        <div id="studentLookupDetails">
          <div class="card-neo">
            <div class="row">
                <div class="col-md-5">
                    <h5 id="lookupTitle" class="text-info">Search to begin...</h5>
                    <p class="mb-1"><strong>ID/Category:</strong> <span id="studentLookupID">-</span></p>
                    <p class="mb-1"><strong>Level:</strong> <span id="studentLookupLevel">-</span></p>
                    <p class="mb-1"><strong>Team:</strong> <span id="studentLookupTeam">-</span></p>
                </div>
                <div class="col-md-7">
                    <h5 id="listHeader" class="text-secondary">Participation/Roster List</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light"><tr id="listTableHeaders"><th>Event/Student</th><th>Status/Team</th></tr></thead>
                            <tbody id="studentParticipationTable"><tr><td colspan="2" class="muted">Search above to load details.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-students" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title"><i class="bi bi-person-plus"></i> Import / Add Student</div>
              <div class="muted small mb-1">Columns: Chess, Name, Level, Team</div>
              <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2 mb-3">
                <button id="previewStudents" class="btn btn-outline-primary btn-sm">Preview</button>
                <button id="importStudents" class="btn btn-accent btn-sm">Import</button>
              </div>
              <hr style="border-top:1px solid var(--border)">
              <input id="manualChess" class="form-control mb-2" placeholder="Chess ID">
              <input id="manualName" class="form-control mb-2" placeholder="Full Name">
              <select id="manualLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
              <select id="manualTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
              <button id="addManualStudent" class="btn btn-success w-100 btn-sm">Add Student</button>
              <div id="studentsPreview" class="mt-2" style="max-height:150px;overflow:auto"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between mb-2 align-items-center">
                <div class="section-title"><i class="bi bi-people-fill"></i> All Students</div>
                <input id="searchStudents" class="form-control form-control-sm" style="width: 200px;" placeholder="Search...">
              </div>
              <div class="table-responsive" style="max-height:600px;overflow:auto">
                <table class="table table-sm align-middle">
                  <thead class="table-light"><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th><th>Actions</th></tr></thead>
                  <tbody id="studentsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-teams" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title"><i class="bi bi-plus-circle"></i> Create Team</div>
              <input id="teamName" class="form-control mb-2" placeholder="Team Name">
              <select id="teamLeader" class="form-select mb-2"><option value="">Select Leader</option></select>
              <input id="teamPassword" class="form-control mb-2" placeholder="Password">
              <button id="saveTeam" class="btn btn-success w-100">Save Team</button>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card-neo">
              <div class="section-title"><i class="bi bi-people"></i> Teams List</div>
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Score</th><th>Actions</th></tr></thead>
                  <tbody id="teamsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-events" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title"><i class="bi bi-calendar-plus"></i> Add / Import Events</div>
              <input id="eventName" class="form-control mb-2" placeholder="Event Name">
              <select id="eventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option><option>Group</option><option>Open</option></select>
              <select id="eventLevel" class="form-select mb-2"><option>Junior</option><option>Senior</option><option>General</option></select>
              <button id="saveEvent" class="btn btn-accent w-100 mb-3">Add Event</button>
              <hr style="border-top:1px solid var(--border)">
              <div class="muted small mb-1">Columns: Name, Type, Level</div>
              <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2"><button id="previewEvents" class="btn btn-outline-primary btn-sm">Preview</button><button id="importEvents" class="btn btn-accent btn-sm">Import</button></div>
              <div id="eventsPreview" class="mt-2" style="max-height:150px;overflow:auto"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between mb-2 align-items-center">
                <div class="section-title"><i class="bi bi-calendar-event"></i> Events List</div>
                <input id="filterEventSearch" class="form-control form-control-sm" style="width: 200px;" placeholder="Search events...">
              </div>
              <div class="table-responsive" style="max-height:600px;overflow:auto">
                <table class="table table-sm align-middle">
                  <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Level</th><th>Actions</th></tr></thead>
                  <tbody id="eventsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-attendance" class="card-neo d-none">
        <div class="card-neo mb-3">
          <div class="section-title"><i class="bi bi-list-check"></i> Generate Attendance</div>
          <div class="row g-2 align-items-center">
            <div class="col-md-3"><input id="attDate" type="date" class="form-control"></div>
            <div class="col-md-3"><select id="attMethod" class="form-select"><option value="all">All Students</option><option value="team">By Team</option></select></div>
            <div class="col-md-3 d-none" id="attTeamWrap"><select id="attTeam" class="form-select"></select></div>
            <div class="col-md-3"><button id="loadAttendance" class="btn btn-primary w-100">Load</button></div>
          </div>
          <input id="attDescription" class="form-control form-control-sm mt-2" placeholder="Add a description/comment for this session (e.g., Morning Session, Day 1)">
        </div>
        <div id="attendanceMarkCard" class="card-neo" style="display:none">
          <div class="d-flex justify-content-between mb-2 align-items-center">
             <div class="section-title"><i class="bi bi-check2-circle"></i> Mark Attendance</div>
             <div class="d-flex gap-2"><button id="toggleAll" class="btn btn-outline-secondary btn-sm">Toggle All</button><button id="saveAttendance" class="btn btn-success btn-sm">Save Session</button></div>
          </div>
          <div id="attendanceBoxes" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="card-neo mt-3">
          <div class="section-title"><i class="bi bi-clock-history"></i> History</div>
          <div class="table-responsive">
            <table class="table table-sm"><thead class="table-light"><tr><th>Date</th><th>Description</th><th>Count</th><th>Saved At</th><th>Actions</th></tr></thead><tbody id="attendanceSessions"></tbody></table>
          </div>
        </div>
      </section>

      <section id="panel-approvals" class="card-neo d-none">
        <div class="d-flex justify-content-between mb-2 align-items-center flex-wrap gap-2">
          <div class="section-title"><i class="bi bi-check2-square"></i> Participation Approvals & Program Management</div>
          <div class="d-flex gap-2">
            <input id="searchApprovals" class="form-control form-control-sm" placeholder="Search..." style="min-width: 150px;">
            <button id="downloadApprovalsPdf" class="btn btn-outline-secondary btn-sm"><i class="bi bi-file-earmark-pdf"></i> Approved Roster</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Event</th><th>Category</th><th>Pending</th><th>Approved</th><th>Actions</th></tr></thead>
            <tbody id="approvalsTable"></tbody>
          </table>
        </div>
      </section>

      <!-- RESULTS SECTION REPLACED -->
      <section id="panel-results" class="card-neo d-none">
        <div class="card-neo">
          <div class="section-title">Add / Manage Results</div>
          <div class="row g-2 align-items-center">
            <div class="col-md-4">
              <select id="resultEvent" class="form-select"><option value="">Select event</option></select>
            </div>
            <div class="col-md-3">
              <select id="resultSelectFirst" class="form-select"><option value="">1st — select</option></select>
            </div>
            <div class="col-md-2"><input id="resultPointsFirst" type="number" class="form-control" placeholder="Points"></div>

            <div class="col-md-3"></div>

            <div class="col-md-3">
              <select id="resultSelectSecond" class="form-select"><option value="">2nd — select</option></select>
            </div>
            <div class="col-md-2"><input id="resultPointsSecond" type="number" class="form-control" placeholder="Points"></div>

            <div class="col-md-3"></div>

            <div class="col-md-3">
              <select id="resultSelectThird" class="form-select"><option value="">3rd — select</option></select>
            </div>
            <div class="col-md-2"><input id="resultPointsThird" type="number" class="form-control" placeholder="Points"></div>

            <div class="col-md-2 d-flex gap-2">
              <button id="saveResult" class="btn btn-success">Save (Draft)</button>
              <button id="publishAllResults" class="btn btn-outline-secondary">Publish</button>
            </div>
          </div>
        </div>

        <div class="card-neo mt-3">
          <div class="section-title">Results List</div>
          <div class="muted mb-2">Light rows indicate at least one result is uploaded for that event</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>1st</th>
                  <th>2nd</th>
                  <th>3rd</th>
                  <th>Published</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="resultsTable"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div> 
  </main>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-person-gear"></i> Edit Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editStudentDbKey">
        <input id="editChess" class="form-control mb-2" readonly>
        <input id="editName" class="form-control mb-2" placeholder="Full Name">
        <select id="editLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
        <select id="editTeam" class="form-select mb-2"></select>
      </div>
      <div class="modal-footer">
        <button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Event Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editEventForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-calendar-event"></i> Edit Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editEventDbKey">
        <input id="editEventId" class="form-control mb-2" readonly>
        <input id="editEventName" class="form-control mb-2" placeholder="Event Name">
        <select id="editEventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option><option>Group</option><option>Open</option></select>
        <select id="editEventLevel" class="form-select mb-2"><option>Junior</option><option>Senior</option><option>General</option></select>
      </div>
      <div class="modal-footer">
        <button type="button" id="deleteEventBtn" class="btn btn-danger">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Team Modal -->
<div class="modal fade" id="editTeamModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="editTeamForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-people"></i> Edit Team</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editTeamDbKey">
        <input id="editTeamId" class="form-control mb-2" readonly>
        <input id="editTeamName" class="form-control mb-2" placeholder="Team Name">
        <select id="editTeamLeader" class="form-select mb-2"><option value="">Select Leader</option></select>
        <input id="editTeamPassword" class="form-control mb-2" placeholder="Password (leave blank to keep old)">
      </div>
      <div class="modal-footer">
        <button type="button" id="deleteTeamBtn" class="btn btn-danger">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Approvals Detail Modal -->
<div class="modal fade" id="approvalsDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approvalModalTitle"><i class="bi bi-people"></i> Participants</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 class="text-warning"><i class="bi bi-clock"></i> Pending</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <tbody id="pendingParticipantsTable"></tbody>
          </table>
        </div>
        <h6 class="text-success mt-3"><i class="bi bi-check-circle"></i> Approved</h6>
        <div class="table-responsive">
          <table class="table table-sm">
            <tbody id="approvedParticipantsTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Result Manage Modal - FIXED STRUCTURE -->
<div class="modal fade" id="resultManageModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="resultManageForm" class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resultManageTitle"><i class="bi bi-trophy"></i> Manage Results</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="manageEventId">
                <div class="alert alert-info py-2 small mb-3">
                    <i class="bi bi-info-circle"></i> This form allows you to edit the saved results for <strong id="resultEventNameDisplay"></strong>.
                </div>
                
                <!-- 1st Place Section -->
                <div class="mb-3 result-position-group">
                    <div class="result-position-header">
                        <h6>1st Place</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm btn-clear-first">Clear</button>
                    </div>
                    <div class="result-fields">
                        <select id="manageResultSelectFirst" class="form-select">
                            <option value="">Select Student</option>
                        </select>
                        <input id="manageResultPointsFirst" type="number" class="form-control" style="width: 80px;" placeholder="Points" value="60">
                    </div>
                </div>
                
                <!-- 2nd Place Section -->
                <div class="mb-3 result-position-group">
                    <div class="result-position-header">
                        <h6>2nd Place</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm btn-clear-second">Clear</button>
                    </div>
                    <div class="result-fields">
                        <select id="manageResultSelectSecond" class="form-select">
                            <option value="">Select Student</option>
                        </select>
                        <input id="manageResultPointsSecond" type="number" class="form-control" style="width: 80px;" placeholder="Points" value="30">
                    </div>
                </div>
                
                <!-- 3rd Place Section -->
                <div class="mb-3 result-position-group">
                    <div class="result-position-header">
                        <h6>3rd Place</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm btn-clear-third">Clear</button>
                    </div>
                    <div class="result-fields">
                        <select id="manageResultSelectThird" class="form-select">
                            <option value="">Select Student</option>
                        </select>
                        <input id="manageResultPointsThird" type="number" class="form-control" style="width: 80px;" placeholder="Points">
                    </div>
                </div>
                
                <hr>
                
                <!-- Action Buttons for Entire Form -->
                <div class="d-flex flex-wrap gap-2 mt-3">
                    <button type="button" id="deleteEventResultsBtn" class="btn btn-danger btn-sm">Delete All Results</button>
                    <div class="ms-auto d-flex gap-2">
                        <button type="button" id="managePublishBtn" class="btn btn-success btn-sm">Publish & Update Scores</button>
                        <button type="submit" class="btn btn-warning btn-sm">Save Draft</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Program Detail Modal -->
<div class="modal fade" id="programDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="programModalTitle"><i class="bi bi-card-checklist"></i> Manage Program</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info py-2 small">
          <i class="bi bi-info-circle"></i> <strong>Scratch Card Codes:</strong> Use the "Assign Codes" button to generate a unique code letter for each participant (for use with scratch cards). Click a box to toggle attendance.
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <div class="section-title mb-0">Participants</div>
          <div class="d-flex gap-2">
            <button id="assignRandomLetters" class="btn btn-warning"><i class="bi bi-shuffle"></i> Assign Codes</button>
            <button id="saveProgramData" class="btn btn-success"><i class="bi bi-save"></i> Save Data</button>
          </div>
        </div>
        <div id="programParticipantsGrid" class="d-flex flex-wrap gap-2 p-2" style="background:var(--input-bg); border-radius:8px; min-height:100px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- System Reset Modal -->
<div class="modal fade" id="systemResetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger"><i class="bi bi-exclamation-triangle"></i> System Reset</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <h6 class="alert-heading">⚠️ WARNING: DANGEROUS OPERATION</h6>
                    <p class="mb-2">This will reset the ENTIRE system. All data will be permanently deleted except:</p>
                    <ul class="mb-2">
                        <li>Students (will be kept)</li>
                        <li>Teams (will be kept but scores reset to 0)</li>
                        <li>Events (will be kept)</li>
                    </ul>
                    <p class="mb-0"><strong>The following will be DELETED:</strong></p>
                    <ul class="mb-0">
                        <li>All Results (published and drafts)</li>
                        <li>All Participations/Approvals</li>
                        <li>All Attendance Records</li>
                        <li>All Program Data</li>
                    </ul>
                </div>
                <p>This action <strong>CANNOT BE UNDONE</strong>. Are you absolutely sure?</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmReset">
                    <label class="form-check-label" for="confirmReset">
                        I understand this will delete all data and cannot be undone
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="executeSystemReset" class="btn btn-danger" disabled>RESET ENTIRE SYSTEM</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Helpers */
const $ = id => document.getElementById(id);
function toast(msg,type='success'){ 
    if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
        const el=document.createElement('div'); 
        el.className=`toast align-items-center text-bg-${type} border-0 positioned-toast`; 
        el.style.position='fixed'; el.style.bottom='20px'; el.style.right='20px'; el.style.zIndex='9999'; 
        el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`; 
        document.body.appendChild(el); 
        const t=new bootstrap.Toast(el,{delay:3000}); 
        t.show(); 
        el.addEventListener('hidden.bs.toast', ()=>el.remove()); 
    } else {
        alert(msg);
    }
}
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function encodeKey(k){ return encodeURIComponent(String(k)); }

/* Cache */
let CACHE = { students:[], teams:[], events:[], participations:[], results:[], attendance:{}, programData:{} };
let KEYMAP = { students:{}, teams:{}, events:{}, participations:{}, results:{}, attendance:{} };

/* Listeners */
const refs = { students:'students', teams:'teams', events:'events', participations:'participations', results:'results', attendance:'attendance', programData:'program_data' };
Object.entries(refs).forEach(([key, path]) => {
  onValue(ref(db, path), snap => {
    const val = snap.val() || {};
    
    // FIX: Update KEYMAP for attendance as well
    if(key === 'attendance' || key === 'programData') {
        CACHE[key] = val;
        if(key === 'attendance') {
             KEYMAP[key] = {};
             Object.entries(val).forEach(([k,v]) => { KEYMAP[key][v.timestamp] = k; });
        }
    }
    else {
      CACHE[key] = Object.values(val);
      KEYMAP[key] = {};
      Object.entries(val).forEach(([k,v]) => { if(v && v.id) KEYMAP[key][String(v.id)] = k; });
    }
    renderAll();
  });
});

/* Nav */
document.querySelectorAll('.sidebar .icon-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    if(btn.id === 'logoutBtn') { window.location.href='index.html'; return; }
    if(btn.id === 'systemResetBtn') { 
        new bootstrap.Modal($('systemResetModal')).show();
        return;
    }
    document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
    const target = document.querySelector(btn.dataset.target);
    if(target) target.classList.remove('d-none');
    document.querySelectorAll('.sidebar .icon-btn').forEach(i=> i.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* UI FIX: Theme Toggle - Now default is light, toggle to dark */
$('toggleThemeBtn').addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const icon = $('toggleThemeBtn').querySelector('i');
    if(document.body.classList.contains('dark-mode')) {
        icon.className = 'bi bi-sun';
        $('toggleThemeBtn').innerHTML = '<i class="bi bi-sun"></i> Light';
    } else {
        icon.className = 'bi bi-moon-stars';
        $('toggleThemeBtn').innerHTML = '<i class="bi bi-moon-stars"></i> Dark';
    }
});

function renderAll(){
  populateDropdowns();
  renderOverview();
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceHistory();
  renderApprovals();
  renderResults();
}

function populateDropdowns(){
  // FIX: Added team dropdown population for editTeamModal
  const tSelect = $('manualTeam'); const eTeam = $('editTeam'); const eTeamLeader = $('editTeamLeader'); const aTeam = $('attTeam');
  const teams = CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html = '<option value="">Unassigned</option>';
  teams.forEach(t => html += `<option value="${t.id}">${escapeHtml(t.name)}</option>`);
  tSelect.innerHTML = html; eTeam.innerHTML = html; 
  aTeam.innerHTML = `<option value="">Select Team</option>` + html;

  const rEv = $('resultEvent');
  let evHtml = '<option value="">Select Event</option>';
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(e => evHtml += `<option value="${e.id}">${escapeHtml(e.name)} (${e.type})</option>`);
  if(rEv.innerHTML !== evHtml) rEv.innerHTML = evHtml;
  
  const lSelect = $('teamLeader');
  let lHtml = '<option value="">Select Leader</option>';
  const studentLeadersHtml = CACHE.students.sort((a,b)=> (a.name||'').localeCompare(b.name||'')).map(s => `<option value="${s.id}">${escapeHtml(s.name)} (${s.id})</option>`).join('');
  lHtml += studentLeadersHtml;
  
  // FIX: Populate team leader dropdowns
  if(document.activeElement !== lSelect) lSelect.innerHTML = lHtml;
  if(document.activeElement !== eTeamLeader) eTeamLeader.innerHTML = lHtml; 
}

/* ---------------- OVERVIEW ---------------- */
function renderOverview() {
    const totalTeams = CACHE.teams.length;
    const totalStudents = CACHE.students.length;
    const pendingApprovals = CACHE.participations.filter(p => p.status === 'pending').length;
    
    let draftResultsCount = 0;
    const evMap = {};
    CACHE.results.forEach(r => { 
        if(!evMap[r.eventId]) evMap[r.eventId] = { isPublished: true, hasResult: false }; 
        evMap[r.eventId].isPublished = evMap[r.eventId].isPublished && (r.published === true);
        evMap[r.eventId].hasResult = true;
    });

    Object.values(evMap).forEach(data => {
        if (data.hasResult && !data.isPublished) {
            draftResultsCount++;
        }
    });

    $('totalTeamsCount').textContent = totalTeams;
    $('totalStudentsCount').textContent = totalStudents;
    $('pendingApprovalsCount').textContent = pendingApprovals;
    $('draftResultsCount').textContent = draftResultsCount;

    // Leaderboard
    const leaderboard = CACHE.teams.slice().sort((a, b) => (b.score || 0) - (a.score || 0));
    const tbody = $('leaderboardTable');
    let html = '';
    if (leaderboard.length === 0) {
        html = '<tr><td colspan="3" class="text-center muted">No teams found.</td></tr>';
    } else {
        leaderboard.forEach((t, index) => {
            html += `<tr><td>${index + 1}</td><td>${escapeHtml(t.name)}</td><td>${t.score || 0}</td></tr>`;
        });
    }
    tbody.innerHTML = html;
}

/* ---------------- STUDENT/EVENT DETAILS LOOKUP ---------------- */
let currentSearchType = 'none';
let currentSearchTarget = null;

$('studentLookupSearch').addEventListener('input', () => {
    const q = $('studentLookupSearch').value.trim().toLowerCase();
    if (q.length < 3) return resetSearchDetails();

    const student = CACHE.students.find(s => 
        String(s.id).toLowerCase() === q || String(s.name).toLowerCase().includes(q)
    );
    const event = CACHE.events.find(e => 
        String(e.name).toLowerCase().includes(q)
    );

    if (student) {
        displayStudentDetails(student);
    } else if (event) {
        displayEventRoster(event);
    } else {
        resetSearchDetails(true);
    }
});

function resetSearchDetails(notFound = false) {
    currentSearchType = 'none';
    currentSearchTarget = null;
    $('searchPdfBtn').classList.add('d-none');
    
    $('lookupTitle').textContent = notFound ? 'Not Found' : 'Search to begin...';
    $('studentLookupID').textContent = '-';
    $('studentLookupLevel').textContent = '-';
    $('studentLookupTeam').textContent = '-';
    $('listHeader').textContent = 'Participation/Roster List';
    $('listTableHeaders').innerHTML = '<th>Event/Student</th><th>Status/Team</th>';
    $('studentParticipationTable').innerHTML = `<tr><td colspan="2" class="muted">${notFound ? 'No match found for your query.' : 'Search above to load details.'}</td></tr>`;
}

function displayStudentDetails(student) {
    currentSearchType = 'student';
    currentSearchTarget = student.id;
    $('searchPdfBtn').classList.remove('d-none');
    
    const team = CACHE.teams.find(t => t.id === student.teamId);

    $('lookupTitle').textContent = student.name;
    $('studentLookupID').textContent = student.id;
    $('studentLookupLevel').textContent = student.level;
    $('studentLookupTeam').textContent = team ? team.name : 'Unassigned';
    $('listHeader').textContent = 'Participation History';
    $('listTableHeaders').innerHTML = '<th>Event</th><th>Status & Result</th>';

    const participationHtml = renderStudentParticipation(student.id);
    $('studentParticipationTable').innerHTML = participationHtml;
}

function renderStudentParticipation(studentId) {
    const sParts = CACHE.participations.filter(p => p.studentId === studentId);
    const sResults = CACHE.results.filter(r => r.studentId === studentId);
    const eventMap = {}; CACHE.events.forEach(e => eventMap[e.id] = e.name);
    
    let html = '';
    if (sParts.length === 0) return '<tr><td colspan="2" class="muted">No participation history found.</td></tr>';
    
    sParts.forEach(p => {
        const eventName = eventMap[p.eventId] || 'Unknown Event';
        const statusBadge = p.status === 'approved' ? `<span class="badge bg-success">${p.status}</span>` : `<span class="badge bg-warning text-dark">${p.status}</span>`;
        
        const result = sResults.find(r => r.eventId === p.eventId);
        let resultText = '';
        if (result) {
            const isPub = CACHE.results.some(r => r.eventId === p.eventId && r.published);
            const status = isPub ? 'Published' : 'Draft';
            resultText = ` (${result.position}${result.position === 1 ? 'st' : result.position === 2 ? 'nd' : 'rd'} - ${result.points} pts - ${status})`;
        }
        
        html += `<tr class="${p.status === 'approved' ? 'participated-row' : ''}"><td>${escapeHtml(eventName)}</td><td>${statusBadge}${resultText}</td></tr>`;
    });
    return html;
}


function displayEventRoster(event) {
    currentSearchType = 'event';
    currentSearchTarget = event.id;
    $('searchPdfBtn').classList.remove('d-none');
    
    const teamMap = {}; CACHE.teams.forEach(t => teamMap[t.id] = t.name);
    const studentMap = {}; CACHE.students.forEach(s => studentMap[s.id] = s);

    $('lookupTitle').textContent = event.name;
    $('studentLookupID').textContent = event.id;
    $('studentLookupLevel').textContent = event.level;
    $('studentLookupTeam').textContent = event.type;
    $('listHeader').textContent = 'Approved Participants Roster';
    $('listTableHeaders').innerHTML = '<th>Student Name</th><th>Chess ID & Team</th>';

    const approvedParts = CACHE.participations.filter(p => p.eventId === event.id && p.status === 'approved');
    let html = '';

    if (approvedParts.length === 0) {
        html = '<tr><td colspan="2" class="muted">No approved participants for this event.</td></tr>';
    } else {
        approvedParts.forEach(p => {
            const student = studentMap[p.studentId];
            const teamName = student ? teamMap[student.teamId] || 'Unassigned' : 'N/A';
            const studentName = student ? student.name : p.studentId;

            html += `<tr><td>${escapeHtml(studentName)}</td><td>${p.studentId} (${teamName})</td></tr>`;
        });
    }

    $('studentParticipationTable').innerHTML = html;
}

$('searchPdfBtn').addEventListener('click', () => {
    if (currentSearchType === 'student' && currentSearchTarget) {
        // PDF Export for Student History
        const s = CACHE.students.find(x => x.id === currentSearchTarget);
        if (!s) return;
        const historyHtml = $('studentParticipationTable').outerHTML;
        
        let headerHtml = `
            <h2>Participation History: ${s.name} (${s.id})</h2>
            <p>Level: ${s.level}, Team: ${$('studentLookupTeam').textContent}</p>
        `;
        
        html2pdf().from(headerHtml + historyHtml).set({ margin: 10, filename: `history_${s.id}.pdf` }).save();

    } else if (currentSearchType === 'event' && currentSearchTarget) {
        // PDF Export for Event Roster (Similar to Approvals PDF, but without watermark for simplicity)
        const ev = CACHE.events.find(x => x.id === currentSearchTarget);
        if (!ev) return;
        
        let headerHtml = `
            <h2>Approved Roster: ${ev.name}</h2>
            <p>Category: ${ev.type} / ${ev.level}</p>
        `;
        
        html2pdf().from(headerHtml + $('studentParticipationTable').outerHTML).set({ margin: 10, filename: `roster_${ev.id}.pdf` }).save();
    }
});


/* --- EXCEL IMPORT HELPERS --- */
let tempImportData = [];
function readExcel(file, callback){
  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(e.target.result, {type:'binary'});
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
    callback(json);
  };
  reader.readAsBinaryString(file);
}


/* ---------------- STUDENTS ---------------- */
$('addManualStudent').addEventListener('click', async ()=>{
  const chess = $('manualChess').value.trim(); const name = $('manualName').value.trim();
  if(!chess || !name) return toast('Chess ID & Name required','danger');
  if(KEYMAP.students[chess]) return toast('ID exists','danger');
  // FIX: Using push to get a unique key, but setting ID as value
  const newRef = push(ref(db, 'students'));
  await set(newRef, { id:chess, name, level:$('manualLevel').value, teamId:$('manualTeam').value||null });
  $('manualChess').value=''; $('manualName').value=''; toast('Student added');
});

// Student Import Logic
$('previewStudents').addEventListener('click', () => {
  const f = $('studentFile').files[0]; if(!f) return toast('Select File','warning');
  readExcel(f, (json) => {
    tempImportData = json;
    let html = '<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th><th>Level</th><th>Team</th></tr></thead><tbody>';
    json.slice(0,5).forEach(r => {
      const chess = r['Chess']||r['ID']||'';
      const name = r['Name']||r['Student']||'';
      html += `<tr><td>${chess}</td><td>${name}</td><td>${r['Level']||'Senior'}</td><td>${r['Team']||''}</td></tr>`;
    });
    html += '</tbody></table><div class="small text-muted">Showing first 5 rows...</div>';
    $('studentsPreview').innerHTML = html;
  });
});

$('importStudents').addEventListener('click', async () => {
  if(!tempImportData.length) return toast('Preview first','warning');
  const teamMap = {}; CACHE.teams.forEach(t => teamMap[t.name.toLowerCase()] = t.id);
  const updates = {};
  tempImportData.forEach(r => {
    const chess = String(r['Chess']||r['ID']||'').trim();
    const name = String(r['Name']||r['Student']||'').trim();
    if(chess && name && !KEYMAP.students[chess]){
       const tName = String(r['Team']||'').toLowerCase();
       // FIX: Using push to ensure unique key for each student
       const newKey = push(ref(db, 'students')).key;
       updates[`students/${newKey}`] = {
         id: chess, name: name,
         level: r['Level']||'Senior',
         teamId: teamMap[tName] || null
       };
    }
  });
  if(Object.keys(updates).length){ await update(ref(db), updates); toast('Imported successfully!'); }
  else toast('No new data to import','warning');
  tempImportData = []; $('studentsPreview').innerHTML = ''; $('studentFile').value = '';
});

function renderStudents(){
  const q = ($('searchStudents').value||'').trim().toLowerCase();
  const tm = {}; CACHE.teams.forEach(t=> tm[t.id]=t.name);
  let html = '';
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id))).forEach(s => {
    const dbKey = KEYMAP.students[s.id]; // FIX: Get the unique DB key
    if(q && !`${s.id} ${s.name}`.toLowerCase().includes(q)) return;
    // FIX: Changed button to 'Edit' and added logic below
    html += `<tr data-id="${s.id}"><td>${s.id}</td><td>${escapeHtml(s.name)}</td><td>${s.level}</td><td>${escapeHtml(tm[s.teamId]||'-')}</td><td><div class="action-buttons"><button class="btn btn-sm btn-outline-primary btn-edit-stu" data-dbkey="${dbKey}">Edit</button></div></td></tr>`;
  });
  $('studentsTable').innerHTML = html;
}

// FIX: Edit/Delete Student Logic
$('studentsTable').addEventListener('click', e => {
  if(e.target.classList.contains('btn-edit-stu')){
    const dbKey = e.target.dataset.dbkey;
    const s = CACHE.students.find(x => KEYMAP.students[x.id] === dbKey);
    if(s){
      $('editStudentDbKey').value = dbKey;
      $('editChess').value = s.id; $('editName').value = s.name; $('editLevel').value = s.level; $('editTeam').value = s.teamId||'';
      new bootstrap.Modal($('editStudentModal')).show();

    }
  }
});
$('editStudentForm').addEventListener('submit', async e => {
  e.preventDefault();
  const k = $('editStudentDbKey').value;
  await update(ref(db, `students/${k}`), { name:$('editName').value, level:$('editLevel').value, teamId:$('editTeam').value||null });
  try { bootstrap.Modal.getInstance($('editStudentModal')).hide(); } catch(e){}
  toast('Updated');
});
$('deleteStudentBtn').addEventListener('click', async ()=>{
  const k = $('editStudentDbKey').value;
  if(confirm('Delete student? This action cannot be undone and will not remove their participations.')) { 
      await remove(ref(db, `students/${k}`)); 
      try { bootstrap.Modal.getInstance($('editStudentModal')).hide(); } catch(e){}
      toast('Deleted'); 
  }
});

/* ---------------- TEAMS ---------------- */
$('saveTeam').addEventListener('click', async ()=>{
  const n = $('teamName').value.trim();
  if(!n) return toast('Name required','danger');
  const id = Date.now().toString();
  // FIX: Using push to get a unique key
  await set(push(ref(db, 'teams')), { id, name:n, leaderId:$('teamLeader').value||null, password:$('teamPassword').value||'', score:0 });
  $('teamName').value=''; $('teamPassword').value=''; toast('Team created');
});

function renderTeams(){
  const tbody = $('teamsTable');
  let html='';
  CACHE.teams.forEach(t => {
    const l = CACHE.students.find(s=>s.id==t.leaderId);
    const cnt = CACHE.students.filter(s=>s.teamId==t.id).length;
    const dbKey = KEYMAP.teams[t.id]; // FIX: Get the unique DB key
    // FIX: Changed button to 'Edit' and added 'Delete' logic
    html += `<tr data-id="${t.id}"><td>${escapeHtml(t.name)}</td><td>${l?l.name:'-'}</td><td>${cnt}</td><td>${t.score||0}</td><td><div class="action-buttons"><button class="btn btn-sm btn-outline-primary btn-edit-team me-1" data-dbkey="${dbKey}">Edit</button><button class="btn btn-sm btn-outline-danger btn-del-team" data-dbkey="${dbKey}">Del</button></div></td></tr>`;
  });
  tbody.innerHTML = html;
}

// FIX: Edit/Delete Team Logic (Also for Team Leader)
$('teamsTable').addEventListener('click', async e=>{
    const btn = e.target.closest('button');
    if (!btn) return;
    const dbKey = btn.dataset.dbkey;
    const t = CACHE.teams.find(x => KEYMAP.teams[x.id] === dbKey);

    if (btn.classList.contains('btn-edit-team')) {
        if (!t) return;
        $('editTeamDbKey').value = dbKey;
        $('editTeamId').value = t.id; 
        $('editTeamName').value = t.name; 
        $('editTeamLeader').value = t.leaderId || ''; 
        $('editTeamPassword').value = ''; // Leave blank to not show/update
        new bootstrap.Modal($('editTeamModal')).show();

    } else if (btn.classList.contains('btn-del-team')) { 
        if(confirm('Delete team? This action cannot be undone. All students in this team will become "Unassigned".')) {
            // Unassign students first
            const updates = {};
            CACHE.students.filter(s => s.teamId === t.id).forEach(s => {
                const sKey = KEYMAP.students[s.id];
                updates[`students/${sKey}/teamId`] = null;
            });
            await update(ref(db), updates);
            // Delete team
            await remove(ref(db, `teams/${dbKey}`));
            toast('Team and student assignments deleted/updated.');
        }
    }
});

$('editTeamForm').addEventListener('submit', async e => {
    e.preventDefault();
    const k = $('editTeamDbKey').value;
    const updates = { 
        name:$('editTeamName').value, 
        leaderId:$('editTeamLeader').value||null 
    };
    if ($('editTeamPassword').value.trim()) {
        updates.password = $('editTeamPassword').value.trim();
    }
    
    await update(ref(db, `teams/${k}`), updates);
    try { bootstrap.Modal.getInstance($('editTeamModal')).hide(); } catch(e){}
    toast('Team updated');
});

$('deleteTeamBtn').addEventListener('click', async ()=>{
  const k = $('editTeamDbKey').value;
  const t = CACHE.teams.find(x => KEYMAP.teams[x.id] === k);
  if(confirm('Delete team? This action cannot be undone. All students in this team will become "Unassigned".')) { 
      // Unassign students first (copied logic from above)
      const updates = {};
      CACHE.students.filter(s => s.teamId === t.id).forEach(s => {
          const sKey = KEYMAP.students[s.id];
          updates[`students/${sKey}/teamId`] = null;
      });
      await update(ref(db), updates);
      // Delete team
      await remove(ref(db, `teams/${k}`)); 
      try { bootstrap.Modal.getInstance($('editTeamModal')).hide(); } catch(e){}
      toast('Team and student assignments deleted/updated.');
  }
});


/* ---------------- EVENTS ---------------- */
$('saveEvent').addEventListener('click', async ()=>{
  const n = $('eventName').value.trim();
  if(!n) return toast('Name required','danger');
  const id = Date.now().toString();
  // FIX: Using push to get a unique key
  await set(push(ref(db, 'events')), { id, name:n, type:$('eventType').value, level:$('eventLevel').value });
  $('eventName').value=''; toast('Event added');
});

// Event Import
let tempEventData = [];
$('previewEvents').addEventListener('click', () => {
  const f = $('eventFile').files[0]; if(!f) return toast('Select File','warning');
  readExcel(f, (json) => {
    tempEventData = json;
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Level</th></tr></thead><tbody>';
    json.slice(0,5).forEach(r => {
      html += `<tr><td>${r['Name']||r['Event']||''}</td><td>${r['Type']||''}</td><td>${r['Level']||''}</td></tr>`;
    });
    html += '</tbody></table>';
    $('eventsPreview').innerHTML = html;
  });
});
$('importEvents').addEventListener('click', async () => {
  if(!tempEventData.length) return toast('Preview first','warning');
  const updates = {};
  tempEventData.forEach(r => {
    const name = String(r['Name']||r['Event']||'').trim();
    if(name){
       // FIX: Use push to ensure unique key
       const newKey = push(ref(db, 'events')).key;
       const id = Date.now() + Math.floor(Math.random()*1000).toString();
       updates[`events/${newKey}`] = { id:id, name:name, type:r['Type']||'Stage', level:r['Level']||'General' };
    }
  });
  if(Object.keys(updates).length){ await update(ref(db), updates); toast('Events Imported'); }
  tempEventData = []; $('eventsPreview').innerHTML = ''; $('eventFile').value = '';
});

function renderEvents(){
  const q = ($('filterEventSearch').value||'').trim().toLowerCase();
  let html='';
  CACHE.events.forEach(e => {
    const dbKey = KEYMAP.events[e.id]; // FIX: Get the unique DB key
    if(q && !e.name.toLowerCase().includes(q)) return;
    // FIX: Added 'Edit' button
    html += `<tr data-id="${e.id}"><td>${e.name}</td><td>${e.type}</td><td>${e.level}</td><td><div class="action-buttons"><button class="btn btn-sm btn-outline-primary btn-edit-ev me-1" data-dbkey="${dbKey}">Edit</button><button class="btn btn-sm btn-outline-danger btn-del-ev" data-dbkey="${dbKey}">Del</button></div></td></tr>`;
  });
  $('eventsTable').innerHTML = html;
}

// FIX: Edit/Delete Event Logic
$('eventsTable').addEventListener('click', async e=>{
    const btn = e.target.closest('button');
    if (!btn) return;
    const dbKey = btn.dataset.dbkey;
    const ev = CACHE.events.find(x => KEYMAP.events[x.id] === dbKey);

    if (btn.classList.contains('btn-edit-ev')) {
        if (!ev) return;
        $('editEventDbKey').value = dbKey;
        $('editEventId').value = ev.id; 
        $('editEventName').value = ev.name; 
        $('editEventType').value = ev.type; 
        $('editEventLevel').value = ev.level; 
        new bootstrap.Modal($('editEventModal')).show();

    } else if (btn.classList.contains('btn-del-ev')) {
        if(confirm('Delete event? This action cannot be undone and will not remove participations/results.')) { 
            await remove(ref(db, `events/${dbKey}`)); 
            toast('Event deleted'); 
        }
    }
});

$('editEventForm').addEventListener('submit', async e => {
    e.preventDefault();
    const k = $('editEventDbKey').value;
    await update(ref(db, `events/${k}`), { 
        name:$('editEventName').value, 
        type:$('editEventType').value, 
        level:$('editEventLevel').value 
    });
    try { bootstrap.Modal.getInstance($('editEventModal')).hide(); } catch(e){}
    toast('Event updated');
});

$('deleteEventBtn').addEventListener('click', async ()=>{
  const k = $('editEventDbKey').value;
  if(confirm('Delete event? This action cannot be undone and will not remove participations/results.')) { 
      await remove(ref(db, `events/${k}`)); 
      try { bootstrap.Modal.getInstance($('editEventModal')).hide(); } catch(e){}
      toast('Event deleted'); 
  }
});


/* ---------------- ATTENDANCE ---------------- */
$('attMethod').addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));
$('loadAttendance').addEventListener('click', ()=>{
  const m = $('attMethod').value;
  const list = m==='all' ? CACHE.students : CACHE.students.filter(s => s.teamId == $('attTeam').value);
  const box = $('attendanceBoxes'); box.innerHTML = '';
  list.sort((a,b)=>a.id.localeCompare(b.id)).forEach(s => {
    box.innerHTML += `<div class="small-box absent" data-id="${s.id}" onclick="this.classList.toggle('present');this.classList.toggle('absent')"><div>${s.id}</div><div class="small-box-id">${escapeHtml(s.name.split(' ')[0])}</div></div>`;
  });
  $('attendanceMarkCard').style.display = 'block';
  // FIX: Clear description on new load
  $('attDescription').value = '';
  $('saveAttendance').removeAttribute('data-edit-key'); // Ensure new session starts clean
});

$('toggleAll').addEventListener('click', ()=>{
  const all = document.querySelectorAll('#attendanceBoxes .small-box');
  const isAllPres = Array.from(all).every(b=>b.classList.contains('present'));
  all.forEach(b => { b.className = isAllPres ? 'small-box absent' : 'small-box present'; });
});

// FIX: Update Save Attendance to handle Edits and Description
$('saveAttendance').addEventListener('click', async ()=>{
    const d = $('attDate').value; if(!d) return toast('Date required','danger');
    const desc = $('attDescription').value.trim(); // FIX: Get description
    const sts = {};
    document.querySelectorAll('#attendanceBoxes .small-box').forEach(b => { sts[b.dataset.id] = b.classList.contains('present')?'Present':'Absent'; });
    
    const editKey = $('saveAttendance').dataset.editKey;
    // FIX: Add description to payload
    const payload = { date:d, students:sts, timestamp:Date.now(), description: desc };

    if (editKey) {
        // FIX: Overwrite existing key (same file)
        await set(ref(db, `attendance/${editKey}`), payload);
        $('saveAttendance').removeAttribute('data-edit-key');
        toast('Attendance updated successfully!');
    } else {
        await push(ref(db, 'attendance'), payload);
        toast('Attendance saved successfully!');
    }
    
    $('attendanceMarkCard').style.display='none';
    $('attDescription').value = ''; // Clear after save/update
});

function renderAttendanceHistory(){
  let html='';
  // FIX: Added 'Description' column
  Object.entries(CACHE.attendance).sort((a,b)=>b[1].timestamp-a[1].timestamp).forEach(([k,v])=>{
    const c = v.students ? Object.values(v.students).filter(x=>x=='Present').length : 0;
    const dateStr = v.timestamp ? new Date(v.timestamp).toLocaleTimeString() : '';
    html += `<tr data-key="${k}"><td>${v.date}</td><td>${escapeHtml(v.description||'-')}</td><td>${c}</td><td><small>${dateStr}</small></td><td><div class="action-buttons"><button class="btn btn-sm btn-outline-info btn-view-absent me-1" data-key="${k}">View Absent</button><button class="btn btn-sm btn-outline-primary btn-edit-att-session me-1" data-key="${k}">Edit</button><button class="btn btn-sm btn-outline-danger btn-del-att" data-key="${k}">Del</button></div></td></tr>`;
  });
  $('attendanceSessions').innerHTML = html;
}

// FIX: View Absent and Edit Attendance Logic
$('attendanceSessions').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const key = btn.dataset.key;

    if (btn.classList.contains('btn-view-absent')) {
        const session = CACHE.attendance[key];
        if (!session || !session.students) return toast('Session data missing', 'danger');

        const absentIds = Object.entries(session.students).filter(([id, status]) => status !== 'Present').map(([id]) => id);
        const absentStudents = absentIds.map(id => CACHE.students.find(s => s.id === id) || {id: id, name: 'Unknown'});

        let absentListHtml = `
            <h3>Absent Students (${session.date})</h3>
            <p>Description: ${escapeHtml(session.description||'-')}</p>
            <p>Total Absent: ${absentStudents.length}</p>
            <table border="1" style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead><tr><th>Chess ID</th><th>Name</th></tr></thead>
                <tbody>
        `;
        absentStudents.forEach(s => {
            absentListHtml += `<tr><td style="padding:4px;">${s.id}</td><td style="padding:4px;">${escapeHtml(s.name)}</td></tr>`;
        });
        html2pdf().from(absentListHtml).set({ margin: 10, filename: `absent_${session.date}.pdf` }).save();
    
    // FIX: Edit Attendance Session Logic
    } else if (btn.classList.contains('btn-edit-att-session')) {
        const session = CACHE.attendance[key];
        if (!session || !session.students) return toast('Session data missing', 'danger');
        
        $('attDate').value = session.date || '';
        $('attDescription').value = session.description || ''; // FIX: Load description
        $('attMethod').value = 'all'; 
        $('attTeamWrap').classList.add('d-none');
        
        const box = $('attendanceBoxes'); box.innerHTML = '';
        CACHE.students.sort((a,b)=>a.id.localeCompare(b.id)).forEach(s => {
            const status = session.students[s.id] === 'Present' ? 'present' : 'absent';
            box.innerHTML += `<div class="small-box ${status}" data-id="${s.id}" onclick="this.classList.toggle('present');this.classList.toggle('absent')"><div>${s.id}</div><div class="small-box-id">${escapeHtml(s.name.split(' ')[0])}</div></div>`;
        });
        $('attendanceMarkCard').style.display = 'block';
        
        // Temporarily store key to overwrite on save
        $('saveAttendance').dataset.editKey = key;
        toast('Session loaded for editing. Click Save Session to overwrite.');

    } else if (btn.classList.contains('btn-del-att')) {
        if(confirm('Delete?')) remove(ref(db, `attendance/${key}`));
    }
});


/* ---------------- APPROVALS & PROGRAM MANAGEMENT (COMBINED) ---------------- */
function renderApprovals(){
  const q = ($('searchApprovals').value||'').trim().toLowerCase();
  const summary = {};
  CACHE.events.forEach(e => summary[e.id] = {ev:e, p:0, a:0});
  CACHE.participations.forEach(p => {
    if(summary[p.eventId]) { if(p.status=='approved') summary[p.eventId].a++; else if(p.status=='pending') summary[p.eventId].p++; }
  });
  let html='';
  Object.values(summary).forEach(x => {
    if(q && !x.ev.name.toLowerCase().includes(q)) return;
    html += `<tr><td>${escapeHtml(x.ev.name)}</td><td>${x.ev.type}</td><td><span class="badge bg-warning text-dark">${x.p}</span></td><td><span class="badge bg-success">${x.a}</span></td><td><div class="action-buttons"><button class="btn btn-sm btn-primary btn-view-app me-1" data-eid="${x.ev.id}">View</button> <button class="btn btn-sm btn-outline-info btn-manage-prog" data-eid="${x.ev.id}">Manage Program</button></div></td></tr>`;
  });
  $('approvalsTable').innerHTML = html;
}

// APPROVAL VIEW - FIXED APPROVE/REJECT BUTTONS
$('approvalsTable').addEventListener('click', e => {
  if(e.target.classList.contains('btn-view-app')){
    const eid = e.target.dataset.eid;
    const parts = CACHE.participations.filter(p => p.eventId == eid);
    const pending = parts.filter(p=>p.status=='pending');
    const approved = parts.filter(p=>p.status=='approved');
    const tm = {}; CACHE.teams.forEach(t=>tm[t.id]=t.name);
    
    let pHtml = ''; 
    pending.forEach(p => { 
        const s = CACHE.students.find(x=>x.id==p.studentId); 
        const studentName = s ? s.name : p.studentId;
        pHtml += `<tr>
            <td>${escapeHtml(studentName)} (${p.studentId}) - ${tm[p.teamId]||''}</td>
            <td class="text-end">
                <div class="action-buttons justify-content-end">
                    <button class="btn-approve" onclick="setStatus('${p.id}','approved')">Approve</button>
                    <button class="btn-reject" onclick="setStatus('${p.id}','rejected')">Reject</button>
                </div>
            </td>
        </tr>`; 
    });
    $('pendingParticipantsTable').innerHTML = pHtml || '<tr><td colspan="2" class="text-center muted">No pending approvals</td></tr>';

    let aHtml = ''; 
    approved.forEach(p => { 
        const s = CACHE.students.find(x=>x.id==p.studentId); 
        const studentName = s ? s.name : p.studentId;
        aHtml += `<tr>
            <td>${escapeHtml(studentName)} (${p.studentId})</td>
            <td class="text-end">
                <div class="action-buttons justify-content-end">
                    <button class="btn-undo" onclick="setStatus('${p.id}','pending')">Undo</button>
                </div>
            </td>
        </tr>`; 
    });
    $('approvedParticipantsTable').innerHTML = aHtml || '<tr><td colspan="2" class="text-center muted">No approved participants</td></tr>';

    const ev = CACHE.events.find(x=>x.id==eid);
    $('approvalModalTitle').textContent = ev ? ev.name : 'Participants';
    new bootstrap.Modal($('approvalsDetailModal')).show();
  } else if(e.target.classList.contains('btn-manage-prog')){
    const eid = e.target.dataset.eid;
    currentProgramEventId = eid;
    const ev = CACHE.events.find(x=>x.id==eid);
    $('programModalTitle').textContent = `Manage Program: ${ev.name}`;
    loadProgramDetails(eid);
    new bootstrap.Modal($('programDetailModal')).show();
  }
});

window.setStatus = async (id, st) => {
  const k = KEYMAP.participations[id];
  if(k) {
    await update(ref(db, `participations/${k}`), { status:st });
    toast(`Status updated to ${st}`, 'success');
    // Close modal after successful update
    try { bootstrap.Modal.getInstance($('approvalsDetailModal')).hide(); } catch(e){}
  } else {
    toast('Error: Participation not found', 'danger');
  }
};


// PROGRAM MANAGEMENT (LOAD)
let currentProgramEventId = null; // FIX: Ensure this is defined for use
function loadProgramDetails(eid) {
    const approvedParts = CACHE.participations.filter(p => p.eventId == eid && p.status == 'approved');
    const progData = CACHE.programData && CACHE.programData[eid] ? CACHE.programData[eid] : {};
    
    const grid = $('programParticipantsGrid'); grid.innerHTML = '';
    
    if(!approvedParts.length) { 
        grid.innerHTML = '<div class="text-muted w-100 text-center py-4">No approved participants.</div>'; 
    } else {
      approvedParts.forEach(p => {
        const s = CACHE.students.find(x => x.id == p.studentId);
        const name = s ? s.name : p.studentId;
        const pData = progData[p.studentId] || {};
        const isPresent = pData.present === true;
        const code = pData.code || '';
        
        const box = document.createElement('div');
        box.className = `small-box ${isPresent ? 'present' : 'absent'}`;
        box.dataset.sid = p.studentId;
        box.innerHTML = `${code ? `<div class="small-box-code">${code}</div>` : ''}<div>${p.studentId}</div><div class="small-box-id">${name.split(' ')[0]}</div>`;
        box.addEventListener('click', () => {
          if(box.classList.contains('absent')) { 
              box.classList.remove('absent'); 
              box.classList.add('present'); 
          } else { 
              box.classList.remove('present'); 
              box.classList.add('absent'); 
          }
        });
        grid.appendChild(box);
      });
    }
}

// PROGRAM MANAGEMENT (ASSIGN CODES)
$('assignRandomLetters').addEventListener('click', () => {
  if(!currentProgramEventId) return;
  const boxes = Array.from(document.querySelectorAll('#programParticipantsGrid .small-box'));
  if(!boxes.length) return toast('No participants','warning');
  if(!confirm('This will reshuffle and overwrite existing scratch card codes. Continue?')) return;
  
  const generateCodes = (n) => {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let codes = [];
    for(let i=0; i<n; i++) codes.push(i<26 ? chars[i] : chars[Math.floor(i/26)-1] + chars[i%26]);
    for (let i = codes.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [codes[i], codes[j]] = [codes[j], codes[i]]; }
    return codes;
  };
  
  const codes = generateCodes(boxes.length);
  boxes.forEach((box, idx) => {
    let codeBadge = box.querySelector('.small-box-code');
    if(!codeBadge) { codeBadge = document.createElement('div'); codeBadge.className = 'small-box-code'; box.appendChild(codeBadge); }
    codeBadge.textContent = codes[idx];
  });
  toast('Codes assigned! Click Save Data to finalize.');
});

// PROGRAM MANAGEMENT (SAVE)
$('saveProgramData').addEventListener('click', async () => {
  if(!currentProgramEventId) return;
  const updates = {};
  document.querySelectorAll('#programParticipantsGrid .small-box').forEach(box => {
    const codeEl = box.querySelector('.small-box-code');
    updates[box.dataset.sid] = { present: box.classList.contains('present'), code: codeEl ? codeEl.textContent : null };
  });
  await set(ref(db, `program_data/${currentProgramEventId}`), updates);
  try { bootstrap.Modal.getInstance($('programDetailModal')).hide(); } catch(e){}
  toast('Program data saved successfully'); 
});


/* ROBUST PDF WATERMARK LOGIC (APPROVED ROSTER) */
$('downloadApprovalsPdf').addEventListener('click', () => {
    const approvedParts = CACHE.participations.filter(p => String(p.status||'').toLowerCase()==='approved');
    if(!approvedParts.length) return toast('No approved data','warning');

    const eventsMap = {}; CACHE.events.forEach(e => eventsMap[e.id] = {...e, list:[]});
    const tm = {}; CACHE.teams.forEach(t=>tm[t.id]=t.name);
    const st = {}; CACHE.students.forEach(s=>st[s.id]=s);

    approvedParts.forEach(p => {
        if(eventsMap[p.eventId]){
            const s = st[p.studentId] || {name:p.studentId, id:p.studentId, teamId:null};
            eventsMap[p.eventId].list.push({ ...s, teamName: tm[s.teamId]||'-' });
        }
    });

    let htmlContent = `<div style="padding:20px; font-family:Arial, sans-serif;">
       <h1 style="text-align:center; margin-bottom:10px; color:#212529;">Fidak Fest Approved Participation Roster</h1>
       <p style="text-align:center; color:#6c757d; font-size:12px;">Generated: ${new Date().toLocaleDateString()}</p>`;

    Object.values(eventsMap).sort((a,b)=>a.name.localeCompare(b.name)).forEach(ev => {
        if(ev.list.length){
            htmlContent += `<div style="margin-bottom:25px; border:1px solid #dee2e6; padding:15px; border-radius: 4px;">
              <h3 style="margin:0 0 5px 0; font-size:16px; color:#0d6efd;">${escapeHtml(ev.name)}</h3>
              <p style="margin:0 0 10px 0; font-size:11px; color:#6c757d;">Category: ${ev.type} / ${ev.level}</p>
              <table style="width:100%; border-collapse:collapse; font-size:11px; color:#212529;">
                <tr style="background:#f8f9fa; text-align:left;">
                  <th style="padding:6px; border-bottom:1px solid #dee2e6; width:25%;">Chess ID</th>
                  <th style="padding:6px; border-bottom:1px solid #dee2e6; width:45%;">Student Name</th>
                  <th style="padding:6px; border-bottom:1px solid #dee2e6; width:30%;">Team Name</th>
                </tr>`;
            ev.list.sort((a,b)=>a.name.localeCompare(b.name)).forEach(m => {
                htmlContent += `<tr>
                    <td style="padding:6px; border-bottom:1px solid #f1f1f1;">${m.id}</td>
                    <td style="padding:6px; border-bottom:1px solid #f1f1f1;">${escapeHtml(m.name)}</td>
                    <td style="padding:6px; border-bottom:1px solid #f1f1f1;">${escapeHtml(m.teamName)}</td>
                </tr>`;
            });
            htmlContent += `</table></div>`;
        }
    });
    htmlContent += `</div>`;

    html2pdf().from(htmlContent).set({
        margin: 10, filename: `fidak_fest_roster_${new Date().toISOString().slice(0, 10)}.pdf`,
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4' }
    }).toPdf().get('pdf').then(function(pdf) {
        const totalPages = pdf.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            pdf.setPage(i);
            pdf.setFontSize(60);
            pdf.setTextColor(200, 200, 200); // Light Grey
            pdf.text('FIDAK FEST', 50, 150, { angle: 45 }); // Diagonal Watermark
        }
    }).save();
});


/* ---------------- RESULTS (REPLACED WITH SECOND CODE VERSION) ---------------- */
// When event selected, auto load approved participants
$('resultEvent').addEventListener('change', ()=> {
  const ev = $('resultEvent').value; if(!ev){ ['resultSelectFirst','resultSelectSecond','resultSelectThird'].forEach(id=> $(id).innerHTML = '<option value="">Select</option>'); return; }
  const participants = CACHE.participations.filter(p => String(p.eventId) === String(ev) && String(p.status||'').toLowerCase()==='approved');
  const map = {}; CACHE.students.forEach(s => map[s.id] = s.name);
  ['resultSelectFirst','resultSelectSecond','resultSelectThird'].forEach(id => {
    const sel = $(id); sel.innerHTML = `<option value="">Select</option>`;
    participants.forEach(p => sel.innerHTML += `<option value="${escapeHtml(p.studentId)}">${escapeHtml(map[p.studentId]||p.studentId)} (${escapeHtml(p.studentId)})</option>`);
  });
});

// Save individual results (draft)
$('saveResult').addEventListener('click', async ()=>{
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  const firstId = $('resultSelectFirst').value; const fPts = Number($('resultPointsFirst').value)||0;
  const secondId = $('resultSelectSecond').value; const sPts = Number($('resultPointsSecond').value)||0;
  const thirdId = $('resultSelectThird').value; const tPts = Number($('resultPointsThird').value)||0;
  async function upsertPosition(position, studentId, points){
    if(!studentId) return;
    const existing = CACHE.results.find(r => String(r.eventId) === String(ev) && Number(r.position) === Number(position));
    if(existing){
      const dbKey = KEYMAP.results[existing.id] || existing.id;
      await update(ref(db, `results/${dbKey}`), { studentId, points, published:false, updatedAt: Date.now() });
    } else {
      const p = push(ref(db, 'results')); const id = Date.now().toString() + Math.floor(Math.random()*9999);
      await set(p, { id, eventId: ev, position, studentId, points, published:false, createdAt: Date.now() });
    }
  }
  await upsertPosition(1, firstId, fPts);
  await upsertPosition(2, secondId, sPts);
  await upsertPosition(3, thirdId, tPts);
  toast('Results saved as draft');
  renderResults();
});

// Publish all results for selected event
$('publishAllResults').addEventListener('click', async ()=>{
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  const eventResults = CACHE.results.filter(r => String(r.eventId) === String(ev));
  if(!eventResults.length) return toast('No results to publish','danger');
  for(const r of eventResults){
    const dbKey = KEYMAP.results[r.id] || r.id;
    if(r.published) continue;
    await update(ref(db, `results/${dbKey}`), { published:true, publishedAt: Date.now() });
    const stud = CACHE.students.find(s => String(s.id) === String(r.studentId));
    if(stud && stud.teamId){
      const team = CACHE.teams.find(t => String(t.id) === String(stud.teamId));
      if(team){
        const dbTeamKey = KEYMAP.teams[team.id];
        const newScore = (Number(team.score)||0) + (Number(r.points)||0);
        await update(ref(db, `teams/${dbTeamKey}`), { score: newScore });
      }
    }
  }
  toast('Published results for event');
  renderResults();
});

// Render results
function renderResults(){
  const tbody = $('resultsTable');
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No events</td></tr>'; return; }
  const evMap = {};
  CACHE.results.forEach(r => { if(!evMap[r.eventId]) evMap[r.eventId] = {}; evMap[r.eventId][r.position] = r; });
  let rows = [];
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  CACHE.events.forEach(ev => {
    const pos = evMap[ev.id] || {};
    const first = pos[1] ? (CACHE.students.find(s=>String(s.id)===String(pos[1].studentId))||{name:pos[1].studentId,id:pos[1].studentId}) : {name:'', id:''};
    const second = pos[2] ? (CACHE.students.find(s=>String(s.id)===String(pos[2].studentId))||{name:pos[2].studentId,id:pos[2].studentId}) : {name:'', id:''};
    const third = pos[3] ? (CACHE.students.find(s=>String(s.id)===String(pos[3].studentId))||{name:pos[3].studentId,id:pos[3].studentId}) : {name:'', id:''};
    const anyUploaded = !!pos[1] || !!pos[2] || !!pos[3];
    const pub = (pos[1] && pos[1].published) || (pos[2] && pos[2].published) || (pos[3] && pos[3].published);
    const pubBadge = pub ? '<span class="badge bg-success">Published</span>' : '<span class="badge bg-secondary">Draft</span>';
    const rowClass = anyUploaded ? 'participated-row' : '';
    // single edit/delete/publish actions for event (as requested)
    rows.push(`<tr class="${rowClass}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(first.name)} ${first.id?`(${escapeHtml(first.id)})`:''}</td><td>${escapeHtml(second.name)} ${second.id?`(${escapeHtml(second.id)})`:''}</td><td>${escapeHtml(third.name)} ${third.id?`(${escapeHtml(third.id)})`:''}</td><td>${pubBadge}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-event-results" data-ev="${escapeHtml(ev.id)}">Edit</button> <button class="btn btn-sm btn-outline-secondary btn-toggle-publish-event" data-ev="${escapeHtml(ev.id)}">${pub? 'Unpublish' : 'Publish'}</button> <button class="btn btn-sm btn-outline-danger btn-delete-event-results" data-ev="${escapeHtml(ev.id)}">Delete</button></td></tr>`);
  });
  tbody.innerHTML = rows.join('') || '<tr><td colspan="6" class="text-center muted">No results</td></tr>';
}

// Result event-level actions
document.addEventListener('click', async (e)=>{
  if(e.target.classList.contains('btn-toggle-publish-event')){
    const ev = e.target.dataset.ev;
    const eventResults = CACHE.results.filter(r => String(r.eventId) === String(ev));
    if(!eventResults.length) return toast('No results for this event','danger');
    // toggle: if any published -> unpublish all; else publish all
    const anyPublished = eventResults.some(r=> r.published);
    for(const r of eventResults){
      const dbKey = KEYMAP.results[r.id] || r.id;
      await update(ref(db, `results/${dbKey}`), { published: !anyPublished, publishedAt: !anyPublished?Date.now():null });
      // update team score add/subtract
      const stud = CACHE.students.find(s => String(s.id) === String(r.studentId));
      if(stud && stud.teamId){
        const team = CACHE.teams.find(t => String(t.id) === String(stud.teamId));
        if(team){
          const dbTeamKey = KEYMAP.teams[team.id];
          const delta = Number(r.points)||0;
          const newScore = Math.max(0, (Number(team.score)||0) + (!anyPublished ? delta : -delta));
          await update(ref(db, `teams/${dbTeamKey}`), { score: newScore });
        }
      }
    }
    toast(anyPublished ? 'Unpublished event results' : 'Published event results');
    renderResults();
  } else if(e.target.classList.contains('btn-edit-event-results')){
    const evId = e.target.dataset.ev;
    // open the resultEvent select + pre-fill positions using admin UI controls
    $('resultEvent').value = evId;
    $('resultEvent').dispatchEvent(new Event('change'));
    // prefill fields if existing
    const positions = [1,2,3];
    positions.forEach(pn=>{
      const rr = CACHE.results.find(r => String(r.eventId) === String(evId) && Number(r.position) === pn);
      if(rr){
        if(pn===1){ $('resultSelectFirst').value = rr.studentId; $('resultPointsFirst').value = rr.points||0; }
        if(pn===2){ $('resultSelectSecond').value = rr.studentId; $('resultPointsSecond').value = rr.points||0; }
        if(pn===3){ $('resultSelectThird').value = rr.studentId; $('resultPointsThird').value = rr.points||0; }
      }
    });
    toast('Loaded results into the editor (save to update).');
    document.querySelector('[data-target="#panel-results"]').click();
  } else if(e.target.classList.contains('btn-delete-event-results')){
    if(!confirm('Delete all results for this event?')) return;
    const evId = e.target.dataset.ev;
    const toDelete = CACHE.results.filter(r=> String(r.eventId)===String(evId));
    for(const r of toDelete){
      const dbKey = KEYMAP.results[r.id] || r.id;
      await remove(ref(db, `results/${dbKey}`));
    }
    toast('Deleted results for event');
    renderResults();
  }
});

/* ---------------- SYSTEM RESET FUNCTIONALITY ---------------- */
// Enable/disable reset button based on checkbox
$('confirmReset').addEventListener('change', () => {
    $('executeSystemReset').disabled = !$('confirmReset').checked;
});

// System Reset Function
$('executeSystemReset').addEventListener('click', async () => {
    if (!$('confirmReset').checked) {
        toast('Please confirm by checking the box', 'warning');
        return;
    }
    
    try {
        // 1. Reset all team scores to 0
        const teamUpdates = {};
        CACHE.teams.forEach(team => {
            const teamKey = KEYMAP.teams[team.id];
            if (teamKey) {
                teamUpdates[`teams/${teamKey}/score`] = 0;
            }
        });
        
        // 2. Delete all results
        const resultKeys = Object.keys(KEYMAP.results);
        for (const key of resultKeys) {
            await remove(ref(db, `results/${key}`));
        }
        
        // 3. Delete all participations
        const participationKeys = Object.keys(KEYMAP.participations);
        for (const key of participationKeys) {
            await remove(ref(db, `participations/${key}`));
        }
        
        // 4. Delete all attendance
        const attendanceKeys = Object.keys(KEYMAP.attendance);
        for (const key of attendanceKeys) {
            await remove(ref(db, `attendance/${key}`));
        }
        
        // 5. Delete all program data
        const programKeys = Object.keys(CACHE.programData);
        for (const key of programKeys) {
            await remove(ref(db, `program_data/${key}`));
        }
        
        // Apply team score updates
        if (Object.keys(teamUpdates).length > 0) {
            await update(ref(db), teamUpdates);
        }
        
        // Close modal
        try { bootstrap.Modal.getInstance($('systemResetModal')).hide(); } catch(e){}
        
        toast('✅ System reset complete! All results, participations, attendance, and program data deleted. Team scores reset to zero.', 'success');
        
        // Reset checkbox
        $('confirmReset').checked = false;
        $('executeSystemReset').disabled = true;
        
    } catch (error) {
        console.error('Error during system reset:', error);
        toast('❌ Error during system reset', 'danger');
    }
});

/* ---------------- FINAL BOOTSTRAPPING ---------------- */

document.addEventListener('DOMContentLoaded', () => {
    // Manually trigger the first menu item (Dashboard/Overview) to show content
    setTimeout(() => {
        const initialBtn = document.querySelector('.sidebar .icon-btn[data-target="#panel-overview"]');
        if (initialBtn) {
            initialBtn.click();
        }
    }, 100); 
    // Data loading (renderAll) is handled by Firebase onValue listeners
});

console.log('Admin v6 Combined Loaded - Results Replaced with Second Code Version');
</script>
</body>
</html>