<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Full</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{--bg:#f4f7fb;--card:#fff;--muted:#6b7280;--accent:#4f46e5;--success:#10b981;--danger:#ef4444}
body{background:var(--bg);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#0f172a}
.container-wide{max-width:1200px;margin:20px auto}
.card-neo{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.section-title{font-weight:700;margin-bottom:8px}
.small-box{width:64px;height:40px;background:#eef2ff;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;margin:6px;cursor:pointer;user-select:none;font-weight:700}
.small-box.present{background:var(--success);color:#fff}
.small-box.absent{background:var(--danger);color:#fff}
.btn-accent{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;border:0}
.table thead{background:#fbfbff}
.muted{color:var(--muted)}
</style>
</head>
<body>

<nav class="navbar shadow-sm mb-3">
  <div class="container container-wide d-flex justify-content-between align-items-center">
    <div class="d-flex align-items-center gap-3">
      <span class="badge text-bg-primary rounded-pill"><i class="bi bi-palette-fill"></i></span>
      <div>
        <div style="font-weight:700">Admin Panel</div>
        <div class="small-muted">Students / Events / Attendance</div>
      </div>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <button id="openStudents" class="btn btn-outline-secondary">Students</button>
      <button id="openTeams" class="btn btn-outline-secondary">Teams</button>
      <button id="openEvents" class="btn btn-outline-secondary">Events</button>
      <button id="openAttendance" class="btn btn-outline-secondary">Attendance</button>
      <button id="openResults" class="btn btn-outline-secondary">Results</button>
      <button id="logoutBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </div>
</nav>

<main class="container container-wide">

  <div class="card-neo mb-3">
    <ul class="nav nav-pills" id="tabs">
      <li class="nav-item"><button class="nav-link active" data-target="panel-students">Students</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-teams">Teams</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-events">Events</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-attendance">Attendance</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-results">Results</button></li>
    </ul>

    <div id="panels" class="mt-3">
      <!-- STUDENTS -->
      <section id="panel-students" class="panel">
        <div class="row">
          <div class="col-lg-5">
            <div class="card-neo mb-3">
              <div class="section-title">Import Students (Excel)</div>
              <div class="small-muted mb-2">Columns: Chess Number, Name, Team (Team optional)</div>
              <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2 mb-2">
                <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
                <button id="importStudents" class="btn btn-accent">Import</button>
              </div>

              <hr>
              <div class="section-title">Add Student Manually</div>
              <input id="manualChess" class="form-control mb-2" placeholder="Chess ID (alphanumeric) e.g. A12 or S-01">
              <input id="manualName" class="form-control mb-2" placeholder="Name">
              <select id="manualTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
              <div><button id="addManualStudent" class="btn btn-success">Add Student</button></div>

              <hr>
              <div class="section-title">Preview</div>
              <div id="studentsPreview" style="max-height:260px; overflow:auto"></div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card-neo">
              <div class="section-title">All Students</div>
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Chess #</th><th>Name</th><th>Team</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="studentsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TEAMS -->
      <section id="panel-teams" class="panel d-none">
        <div class="row">
          <div class="col-lg-5">
            <div class="card-neo mb-3">
              <div class="section-title">Add Team</div>
              <input id="teamName" class="form-control mb-2" placeholder="Team name">
              <select id="teamLeader" class="form-select mb-2"><option value="">Leader (Chess#)</option></select>
              <input id="teamPassword" class="form-control mb-2" placeholder="Password (optional)">
              <div class="d-flex gap-2"><button id="saveTeam" class="btn btn-success">Save</button></div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card-neo">
              <div class="section-title">Teams</div>
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="teamsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EVENTS -->
      <section id="panel-events" class="panel d-none">
        <div class="row">
          <div class="col-lg-5">
            <div class="card-neo mb-3">
              <div class="section-title">Add Event</div>
              <input id="eventName" class="form-control mb-2" placeholder="Event name">
              <select id="eventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option></select>
              <textarea id="eventDescription" class="form-control mb-2" rows="4" placeholder="Description / rules"></textarea>
              <div><button id="saveEvent" class="btn btn-warning">Save Event</button></div>
            </div>
            <div class="card-neo">
              <div class="section-title">Import Events (Excel)</div>
              <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2"><button id="previewEvents" class="btn btn-outline-primary">Preview</button><button id="importEvents" class="btn btn-accent">Import</button></div>
              <div id="eventsPreview" style="max-height:220px; overflow:auto" class="mt-2"></div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card-neo">
              <div class="section-title">Events</div>
              <div class="table-responsive">
                <table class="table align-middle">
                  <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Description</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="eventsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ATTENDANCE -->
      <section id="panel-attendance" class="panel d-none">
        <div class="card-neo mb-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-2"><input id="attDate" type="date" class="form-control"></div>
            <div class="col-md-2"><input id="attTime" type="time" class="form-control"></div>
            <div class="col-md-4"><input id="attDesc" class="form-control" placeholder="Description"></div>
            <div class="col-md-2"><select id="attMethod" class="form-select"><option value="all">All</option><option value="team">By Team</option></select></div>
            <div class="col-md-2 d-none" id="attTeamWrap"><select id="attTeam" class="form-select"></select></div>
          </div>

          <div class="mt-3">
            <button id="loadAttendance" class="btn btn-info">Load Students</button>
            <button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button>
            <button id="saveAttendance" class="btn btn-success">Save Session</button>
          </div>
        </div>

        <div class="card-neo mb-3" id="attendanceMarkCard" style="display:none">
          <div class="section-title">Mark Attendance</div>
          <div class="small-muted mb-2">Hover over chess number to see the name. Click to toggle present/absent.</div>
          <div id="attendanceBoxes" style="padding:12px"></div>
        </div>

        <div class="card-neo">
          <div class="section-title">Saved Sessions</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Date</th><th>Time</th><th>Description</th><th>Count</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="attendanceSessions"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RESULTS -->
      <section id="panel-results" class="panel d-none">
        <div class="card-neo">
          <div class="section-title">Results (quick)</div>
          <div class="row g-2">
            <div class="col-md-4"><select id="resultEvent" class="form-select"><option value="">Select event</option></select></div>
            <div class="col-md-2"><button id="refreshParticipants" class="btn btn-outline-secondary">Load</button></div>
            <div class="col-md-6"></div>
          </div>
          <div class="mt-2">
            <div class="row g-2">
              <div class="col-md-4"><select id="resFirst" class="form-select"><option value="">1st</option></select></div>
              <div class="col-md-2"><input id="ptsFirst" type="number" class="form-control" value="100"></div>
              <div class="col-md-4"><select id="resSecond" class="form-select"><option value="">2nd</option></select></div>
              <div class="col-md-2"><input id="ptsSecond" type="number" class="form-control" value="50"></div>
            </div>
            <div class="row g-2 mt-2">
              <div class="col-md-4"><select id="resThird" class="form-select"><option value="">3rd</option></select></div>
              <div class="col-md-2"><input id="ptsThird" type="number" class="form-control" value="25"></div>
              <div class="col-md-6 text-end"><button id="addResult" class="btn btn-primary">Add Result</button></div>
            </div>
          </div>
        </div>

        <div class="card-neo mt-3">
          <div class="section-title">Results List</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="resultsTable"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </div>

</main>

<!-- Edit student modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Student</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label class="form-label">Chess Number (read-only)</label>
        <input id="editChess" class="form-control mb-2" readonly>
        <label class="form-label">Name</label>
        <input id="editName" class="form-control mb-2" required>
        <label class="form-label">Team</label>
        <select id="editTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
      </div>
      <div class="modal-footer">
        <button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>
</div>

<div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
/* ----------------- Firebase init ----------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ----------------- utilities ----------------- */
const $ = id => document.getElementById(id);
function toast(msg, type='success'){
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0`;
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  $('toastRoot').appendChild(el);
  const b = new bootstrap.Toast(el, { delay: 3000 }); b.show();
  el.addEventListener('hidden.bs.toast', ()=> el.remove());
}
function encodeKey(k){ return encodeURIComponent(String(k)); }
function decodeKey(k){ return decodeURIComponent(String(k)); }

/* ----------------- cached arrays & maps ----------------- */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, results: {} };

/* ----------------- DB listeners (separate) ----------------- */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');

onValue(studentsRef, snap => {
  const obj = snap.val() || {};
  CACHE.students = Object.values(obj);
  KEYMAP.students = {};
  Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.students[v.id] = k; });
  renderAll();
});
onValue(teamsRef, snap => { const obj = snap.val() || {}; CACHE.teams = Object.values(obj); KEYMAP.teams = {}; Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.teams[v.id] = k; }); renderAll(); });
onValue(eventsRef, snap => { const obj = snap.val() || {}; CACHE.events = Object.values(obj); KEYMAP.events = {}; Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.events[v.id] = k; }); renderAll(); });
onValue(partsRef, snap => { CACHE.participations = Object.values(snap.val() || {}); renderAll(); });
onValue(resultsRef, snap => { CACHE.results = Object.values(snap.val() || {}); renderAll(); });
onValue(attendanceRef, snap => { CACHE.attendance = snap.val() || {}; renderAll(); });

/* ----------------- UI tab handlers ----------------- */
document.querySelectorAll('#tabs [data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
    const id = btn.getAttribute('data-target');
    $(id).classList.remove('d-none');
    document.querySelectorAll('#tabs .nav-link').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
  });
});
$('openStudents').addEventListener('click', ()=> document.querySelector('[data-target="panel-students"]').click());
$('openTeams').addEventListener('click', ()=> document.querySelector('[data-target="panel-teams"]').click());
$('openEvents').addEventListener('click', ()=> document.querySelector('[data-target="panel-events"]').click());
$('openAttendance').addEventListener('click', ()=> document.querySelector('[data-target="panel-attendance"]').click());
$('openResults').addEventListener('click', ()=> document.querySelector('[data-target="panel-results"]').click());
$('logoutBtn').addEventListener('click', ()=> { sessionStorage.clear(); location.href='index.html'; });

/* ----------------- renderers ----------------- */
function renderAll(){
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceSessions();
  populateDropdowns();
  renderResults();
}

/* Students uniqueness helpers */
function studentIdExists(id){ return CACHE.students.some(s => String(s.id) === String(id)); }
function studentNameExists(name){ if(!name) return false; const n=name.trim().toLowerCase(); return CACHE.students.some(s => String(s.name||'').trim().toLowerCase() === n); }

/* Students preview/import */
let studentsPreviewRows = [];
$('previewStudents').addEventListener('click', ()=> {
  const f = $('studentFile').files[0];
  if(!f) return toast('Select Excel file','danger');
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' });
    studentsPreviewRows = json.slice(0,1000);
    renderStudentsPreview();
  };
  r.readAsBinaryString(f);
});
function renderStudentsPreview(){
  const wrap = $('studentsPreview');
  if(!studentsPreviewRows.length){ wrap.innerHTML = '<div class="muted">No preview</div>'; return; }
  let html = `<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Team</th></tr></thead><tbody>`;
  studentsPreviewRows.forEach(r=>{
    const chess = (r['Chess Number']||r['Chess']||r['ID']||r['id']||'').toString();
    const name = (r['Name']||r['name']||'').toString();
    const team = (r['Team']||r['team']||'').toString();
    html += `<tr><td>${escapeHtml(chess)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(team)}</td></tr>`;
  });
  html += '</tbody></table>';
  wrap.innerHTML = html;
}
$('importStudents').addEventListener('click', async ()=>{
  if(!studentsPreviewRows.length) return toast('No preview','danger');
  // team name -> id map
  const teamNameToId = {}; CACHE.teams.forEach(t => { if(t.name) teamNameToId[String(t.name).trim().toLowerCase()] = t.id; });
  const updates = {}; let imported=0, skipped=0;
  studentsPreviewRows.forEach(r=>{
    const chessRaw = (r['Chess Number']||r['Chess']||r['ID']||r['id']||'').toString().trim();
    const nameRaw = (r['Name']||r['name']||'').toString().trim();
    if(!chessRaw || !nameRaw){ skipped++; return; }
    const chess = chessRaw;
    const name = nameRaw;
    if(studentIdExists(chess) || studentNameExists(name)){ skipped++; return; }
    const teamName = (r['Team']||r['team']||'').toString().trim();
    const teamId = teamName ? (teamNameToId[teamName.toLowerCase()] || null) : null;
    updates[`students/${encodeKey(chess)}`] = { id: chess, name, teamId: teamId ? String(teamId) : null };
    imported++;
  });
  if(!Object.keys(updates).length) return toast(`Imported ${imported}, skipped ${skipped}`,'warning');
  await update(ref(db,'/'), updates);
  studentsPreviewRows = [];
  $('studentsPreview').innerHTML = '';
  $('studentFile').value = '';
  toast(`Imported ${imported}, skipped ${skipped}`);
});

/* Manual add student */
$('addManualStudent').addEventListener('click', async ()=>{
  const chessRaw = $('manualChess').value.trim();
  const name = $('manualName').value.trim();
  const teamId = $('manualTeam').value || null;
  if(!chessRaw || !name) return toast('Enter chess ID and name','danger');
  if(studentIdExists(chessRaw)) return toast('Chess ID already exists','danger');
  if(studentNameExists(name)) return toast('Name already exists','danger');
  await set(ref(db, `students/${encodeKey(chessRaw)}`), { id: chessRaw, name, teamId: teamId ? String(teamId) : null });
  $('manualChess').value=''; $('manualName').value=''; $('manualTeam').value='';
  toast('Student saved');
});

/* render students table */
function renderStudents(){
  const tbody = $('studentsTable');
  if(!CACHE.students.length){ tbody.innerHTML = '<tr><td colspan="4" class="text-center muted">No students</td></tr>'; return; }
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id)));
  const teamMap = {}; CACHE.teams.forEach(t=> teamMap[t.id]=t.name);
  let html = '';
  CACHE.students.forEach(s=>{
    const team = s.teamId ? (teamMap[s.teamId]||'Unknown') : 'Unassigned';
    html += `<tr data-key="${encodeKey(s.id)}"><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(team)}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-student">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-student">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html;
}

/* students table actions (delegation) */
$('studentsTable').addEventListener('click', async (e)=>{
  const tr = e.target.closest('tr'); if(!tr) return;
  const dbKey = tr.dataset.key;
  if(e.target.classList.contains('btn-delete-student')){
    if(!confirm('Delete student?')) return;
    await remove(ref(db, `students/${dbKey}`));
    toast('Student deleted');
    return;
  } else if(e.target.classList.contains('btn-edit-student')){
    const snap = await get(ref(db, `students/${dbKey}`));
    const s = snap.val();
    if(!s) return toast('Student not found','danger');
    $('editChess').value = s.id;
    $('editName').value = s.name || '';
    // populate team select then set
    populateDropdowns();
    setTimeout(()=> { $('editTeam').value = s.teamId || ''; }, 60);
    document.getElementById('editStudentModal').dataset.dbKey = dbKey;
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
  }
});

/* edit student modal submit & delete */
document.getElementById('editStudentForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = document.getElementById('editStudentModal').dataset.dbKey;
  if(!dbKey) return toast('Missing key','danger');
  const newName = $('editName').value.trim();
  const newTeam = $('editTeam').value || null;
  if(!newName) return toast('Name required','danger');
  const curSnap = await get(ref(db, `students/${dbKey}`));
  const cur = curSnap.val();
  if(!cur) return toast('Student not found','danger');
  if(String(newName).trim().toLowerCase() !== String(cur.name||'').trim().toLowerCase()){
    if(studentNameExists(newName)) return toast('Name already exists','danger');
  }
  await update(ref(db, `students/${dbKey}`), { name: newName, teamId: newTeam ? String(newTeam) : null });
  toast('Student updated');
  bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});
$('deleteStudentBtn').addEventListener('click', async ()=>{
  if(!confirm('Delete this student?')) return;
  const dbKey = document.getElementById('editStudentModal').dataset.dbKey;
  if(!dbKey) return toast('Missing key','danger');
  await remove(ref(db, `students/${dbKey}`));
  toast('Student deleted');
  bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});

/* ----------------- TEAMS ----------------- */
$('saveTeam').addEventListener('click', async ()=>{
  const name = $('teamName').value.trim();
  const leader = $('teamLeader').value || null;
  const pwd = $('teamPassword').value.trim() || '';
  if(!name) return toast('Team name required','danger');
  const p = push(ref(db, 'teams'));
  const id = Date.now().toString();
  await set(p, { id, name, leaderId: leader ? String(leader) : null, password: pwd, score: 0 });
  $('teamName').value=''; $('teamLeader').value=''; $('teamPassword').value='';
  toast('Team saved');
});
function renderTeams(){
  const tbody = $('teamsTable');
  if(!CACHE.teams.length){ tbody.innerHTML = '<tr><td colspan="4" class="text-center muted">No teams</td></tr>'; return; }
  CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html = '';
  CACHE.teams.forEach(t=>{
    const leader = CACHE.students.find(s => String(s.id) === String(t.leaderId));
    const members = CACHE.students.filter(s => String(s.teamId) === String(t.id)).length;
    html += `<tr data-key="${t.id}"><td>${escapeHtml(t.name)}</td><td>${leader?escapeHtml(leader.name+' ('+leader.id+')'):'-'}</td><td>${members}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-team" data-key="${t.id}">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-team" data-key="${t.id}">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html;
}
$('teamsTable').addEventListener('click', async (e)=>{
  if(e.target.classList.contains('btn-delete-team')){
    const tid = e.target.dataset.key;
    if(!confirm('Delete team?')) return;
    // remove team and unassign members
    const dbKey = KEYMAP.teams[tid];
    if(dbKey) await remove(ref(db, `teams/${dbKey}`));
    const updates = {};
    CACHE.students.filter(s => String(s.teamId) === String(tid)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null);
    if(Object.keys(updates).length) await update(ref(db,'/'), updates);
    toast('Team deleted');
  }
});

/* ----------------- EVENTS ----------------- */
$('saveEvent').addEventListener('click', async ()=>{
  const name = $('eventName').value.trim();
  const type = $('eventType').value;
  const desc = $('eventDescription').value.trim();
  if(!name) return toast('Event name required','danger');
  // uniqueness
  if(CACHE.events.some(e => String(e.name||'').trim().toLowerCase() === name.toLowerCase())) return toast('Event name already exists','danger');
  const p = push(ref(db, 'events'));
  const id = Date.now().toString();
  await set(p, { id, name, type, description: desc, status: 'Open' });
  $('eventName').value=''; $('eventDescription').value='';
  toast('Event added');
});
$('previewEvents').addEventListener('click', ()=> {
  const f = $('eventFile').files[0];
  if(!f) return toast('Choose event Excel','danger');
  const r = new FileReader();
  r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>';
    json.forEach(rw => html += `<tr><td>${escapeHtml(rw['Name']||rw['Event']||rw['name']||'')}</td><td>${escapeHtml(rw['Type']||rw['type']||'')}</td><td>${escapeHtml(rw['Description']||rw['description']||'')}</td></tr>`);
    html += '</tbody></table>';
    $('eventsPreview').innerHTML = html;
  };
  r.readAsBinaryString(f);
});
$('importEvents').addEventListener('click', async ()=>{
  const f = $('eventFile').files[0];
  if(!f) return toast('Choose event Excel','danger');
  const r = new FileReader();
  r.onload = async e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    const updates = {}; let imported=0, skipped=0;
    rows.forEach(rw=>{
      const name = (rw['Name']||rw['Event']||rw['name']||'').toString().trim();
      if(!name){ skipped++; return; }
      if(CACHE.events.some(ev => String(ev.name||'').trim().toLowerCase()===name.toLowerCase())){ skipped++; return; }
      const type = (rw['Type']||rw['type']||'Non-Stage').toString();
      const desc = (rw['Description']||rw['description']||'').toString();
      const id = Date.now().toString() + Math.floor(Math.random()*1000);
      updates[`events/${id}`] = { id, name, type, description: desc, status:'Open' };
      imported++;
    });
    if(Object.keys(updates).length) await update(ref(db,'/'), updates);
    toast(`Imported ${imported}, skipped ${skipped}`);
    $('eventFile').value='';
    $('eventsPreview').innerHTML='';
  };
  r.readAsBinaryString(f);
});
function renderEvents(){
  const tbody = $('eventsTable');
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="4" class="text-center muted">No events</td></tr>'; return; }
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html = '';
  CACHE.events.forEach(ev => {
    html += `<tr data-key="${ev.id}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.type)}</td><td>${escapeHtml((ev.description||'').slice(0,120))}</td><td class="text-end"><button class="btn btn-sm btn-outline-danger btn-delete-event" data-key="${ev.id}">Delete</button></td></tr>`;
  });
  tbody.innerHTML = html;
}
$('eventsTable').addEventListener('click', async (e)=>{
  if(e.target.classList.contains('btn-delete-event')){
    const id = e.target.dataset.key;
    if(!confirm('Delete event?')) return;
    const dbKey = KEYMAP.events[id] || id;
    if(dbKey) await remove(ref(db, `events/${dbKey}`));
    toast('Event removed');
  }
});

/* ----------------- ATTENDANCE ----------------- */
let attendanceToggleState = 'none';
let editingAttendanceDbKey = null;

$('attMethod').addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));

$('loadAttendance').addEventListener('click', ()=> {
  const method = $('attMethod').value;
  const teamId = $('attTeam').value;
  let list = [];
  if(method === 'all') list = CACHE.students.slice();
  else list = CACHE.students.filter(s => String(s.teamId) === String(teamId));
  const wrap = $('attendanceBoxes');
  wrap.innerHTML = '';
  list.forEach(s => {
    // create small box with name in data attribute and using Bootstrap tooltip/popover
    const div = document.createElement('div');
    div.className = 'small-box';
    div.dataset.key = encodeKey(s.id);
    div.dataset.name = s.name || '';
    div.textContent = s.id;
    // tooltip: we'll use popover for hover name
    div.setAttribute('data-bs-toggle','popover');
    div.setAttribute('data-bs-trigger','hover focus');
    div.setAttribute('title', s.id);
    div.setAttribute('data-bs-content', s.name || '');
    div.addEventListener('click', ()=> toggleAttendanceBox(div));
    wrap.appendChild(div);
  });
  // initialize popovers on these boxes
  initPopovers();
  $('attendanceMarkCard').style.display = list.length ? 'block' : 'none';
  attendanceToggleState = 'none'; $('toggleAll').textContent = 'Toggle All';
  editingAttendanceDbKey = null;
});

function initPopovers(){
  // dispose old popovers first
  document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el=>{
    // if already has popover instance, dispose
    const inst = bootstrap.Popover.getInstance(el);
    if(inst) inst.dispose();
  });
  // create new popovers
  document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el=>{
    new bootstrap.Popover(el, { container: 'body', placement: 'top', trigger: 'hover focus' });
  });
}
function toggleAttendanceBox(el){
  if(el.classList.contains('present')){ el.classList.remove('present'); el.classList.add('absent'); }
  else if(el.classList.contains('absent')){ el.classList.remove('absent'); }
  else el.classList.add('present');
}
$('toggleAll').addEventListener('click', ()=>{
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return;
  if(attendanceToggleState === 'none' || attendanceToggleState === 'absent'){
    boxes.forEach(b => { b.classList.remove('absent'); b.classList.add('present'); });
    attendanceToggleState = 'present'; $('toggleAll').textContent = 'Set All Absent';
  } else {
    boxes.forEach(b => { b.classList.remove('present'); b.classList.add('absent'); });
    attendanceToggleState = 'absent'; $('toggleAll').textContent = 'Reset/None';
  }
});
$('saveAttendance').addEventListener('click', async ()=>{
  const date = $('attDate').value;
  const time = $('attTime').value || '';
  if(!date) return toast('Select date','danger');
  const desc = $('attDesc').value || '';
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
  if(!boxes.length) return toast('Load students first','danger');
  const studentsObj = {};
  boxes.forEach(b=>{
    const id = decodeKey(b.dataset.key);
    if(b.classList.contains('present')) studentsObj[id] = 'Present';
    else if(b.classList.contains('absent')) studentsObj[id] = 'Absent';
    else studentsObj[id] = 'Absent';
  });
  const payload = { date, time, description: desc, students: studentsObj, savedAt: Date.now() };
  if(editingAttendanceDbKey){
    await set(ref(db, `attendance/${editingAttendanceDbKey}`), payload);
    toast('Attendance updated');
    editingAttendanceDbKey = null;
  } else {
    const p = push(ref(db, 'attendance'));
    await set(p, payload);
    toast('Attendance saved');
  }
  $('attendanceMarkCard').style.display = 'none';
});

/* attendance sessions render + view/edit */
function renderAttendanceSessions(){
  const tbody = $('attendanceSessions');
  const att = CACHE.attendance || {};
  const rows = Object.entries(att);
  if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No sessions</td></tr>'; return; }
  // sort newest first by savedAt or key
  rows.sort((a,b)=> (b[1].savedAt||0) - (a[1].savedAt||0));
  let html = '';
  rows.forEach(([k,v])=>{
    const count = v.students ? Object.keys(v.students).length : 0;
    html += `<tr data-db="${k}"><td>${escapeHtml(v.date||'')}</td><td>${escapeHtml(v.time||'')}</td><td>${escapeHtml(v.description||'')}</td><td>${count}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-view-att" data-db="${k}">View</button> <button class="btn btn-sm btn-outline-secondary btn-edit-att" data-db="${k}">Edit</button></td></tr>`;
  });
  tbody.innerHTML = html;
}
$('attendanceSessions').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const dbKey = btn.dataset.db;
  const snap = await get(ref(db, `attendance/${dbKey}`));
  const s = snap.val();
  if(!s) return toast('Session not found','danger');
  if(btn.classList.contains('btn-view-att')){
    let txt = `Date: ${s.date} ${s.time || ''}\n${s.description || ''}\n\n`;
    if(s.students) for(const id in s.students) txt += `${id}: ${s.students[id]}\n`;
    alert(txt);
  } else if(btn.classList.contains('btn-edit-att')){
    // load session in attendance boxes
    editingAttendanceDbKey = dbKey;
    $('attDate').value = s.date || '';
    $('attTime').value = s.time || '';
    $('attDesc').value = s.description || '';
    const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
    // show all students but mark those in session
    CACHE.students.forEach(st => {
      const status = (s.students && s.students[st.id]) ? s.students[st.id] : 'Absent';
      const div = document.createElement('div');
      div.className = 'small-box ' + (status==='Present' ? 'present' : 'absent');
      div.dataset.key = encodeKey(st.id);
      div.dataset.name = st.name || '';
      div.textContent = st.id;
      div.setAttribute('data-bs-toggle','popover');
      div.setAttribute('data-bs-trigger','hover focus');
      div.setAttribute('title', st.id);
      div.setAttribute('data-bs-content', st.name || '');
      div.addEventListener('click', ()=> toggleAttendanceBox(div));
      wrap.appendChild(div);
    });
    initPopovers();
    $('attendanceMarkCard').style.display = 'block';
    toast('Loaded session for edit — change and Save');
  }
});

/* ----------------- RESULTS (simple) ----------------- */
$('refreshParticipants').addEventListener('click', async ()=>{
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  // participants simulated from participations (approved)
  const participants = CACHE.participations.filter(p => String(p.eventId) === String(ev) && String(p.status||'').toLowerCase()==='approved');
  const map = {}; CACHE.students.forEach(s => map[s.id] = s.name);
  const choices = participants.map(p => ({ id: p.studentId, name: map[p.studentId] || p.studentId }));
  ['resFirst','resSecond','resThird'].forEach(id => {
    const sel = $(id);
    sel.innerHTML = '<option value="">Select</option>';
    choices.forEach(c=> sel.innerHTML += `<option value="${escapeHtml(c.id)}">${escapeHtml(c.name)} (${escapeHtml(c.id)})</option>`);
  });
});
$('addResult').addEventListener('click', async ()=>{
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  const first = $('resFirst').value || 'none', second = $('resSecond').value || 'none', third = $('resThird').value || 'none';
  const p1 = Number($('ptsFirst').value)||0, p2 = Number($('ptsSecond').value)||0, p3 = Number($('ptsThird').value)||0;
  const p = push(ref(db, 'results'));
  const id = Date.now().toString();
  await set(p, { id, eventId: ev, first, second, third, pFirst: p1, pSecond: p2, pThird: p3, published:false });
  toast('Result added');
});
function renderResults(){
  const tbody = $('resultsTable');
  if(!CACHE.results.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No results</td></tr>'; return; }
  let html = '';
  CACHE.results.forEach(r=>{
    const ev = CACHE.events.find(e => String(e.id)===String(r.eventId));
    html += `<tr data-key="${r.id}"><td>${escapeHtml(ev?ev.name:'Unknown')}</td><td>${escapeHtml(r.first||'')}</td><td>${escapeHtml(r.second||'')}</td><td>${escapeHtml(r.third||'')}</td><td class="text-end"></td></tr>`;
  });
  tbody.innerHTML = html;
}

/* ----------------- misc helpers ----------------- */
function populateDropdowns(){
  // manualTeam
  const manualTeam = $('manualTeam'); manualTeam.innerHTML = '<option value="">Unassigned</option>';
  CACHE.teams.forEach(t => manualTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`);
  const teamLeader = $('teamLeader'); if(teamLeader){ teamLeader.innerHTML = '<option value="">Leader (Chess#)</option>'; CACHE.students.forEach(s => teamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const attTeam = $('attTeam'); if(attTeam){ attTeam.innerHTML = '<option value="">Select team</option>'; CACHE.teams.forEach(t=> attTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeam = $('editTeam'); if(editTeam){ editTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> editTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  // resultEvent
  const resEv = $('resultEvent'); if(resEv){ resEv.innerHTML = '<option value="">Select event</option>'; CACHE.events.forEach(e => resEv.innerHTML += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`); }
}

/* escape HTML for safety */
function escapeHtml(str){ if(str===null||str===undefined) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* initial render */
setTimeout(()=> renderAll(), 300);
</script>
</body>
</html>
