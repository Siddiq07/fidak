<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Panel — Art Fest (Updated)</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- XLSX + html2pdf -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg:#f4f7fb; --card:#fff; --muted:#6b7280; --accent:#4f46e5; --success:#10b981; --danger:#ef4444;
    }
    body{background:var(--bg);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:#0f172a;margin:0 0 40px}
    .container-wide{max-width:1200px;margin:18px auto;padding:0 12px}
    .card-neo{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(8,15,30,0.06)}
    .section-title{font-weight:700;margin-bottom:8px}
    .small-muted{color:var(--muted);font-size:.92rem}
    .small-box{width:44px;height:36px;display:inline-flex;align-items:center;justify-content:center;border-radius:8px;margin:6px;cursor:pointer;color:#fff;font-weight:700;font-size:13px}
    .small-box.present{background:var(--success)}
    .small-box.absent{background:var(--danger)}
    .participated-row{background:#e8fff0}
    .btn-accent{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;border:0}
    .table thead{background:#fbfbff}
    .muted{color:var(--muted)}
    @media (max-width:768px){
      .col-lg-5,.col-lg-7{flex:0 0 100%;max-width:100%!important}
      .small-box{width:36px;height:30px;font-size:11px}
      .nav-pills{overflow:auto;padding-bottom:6px}
    }
    .teams-group { margin-bottom:10px; padding:8px; border-radius:8px; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.03) }
    .teams-group h6{margin:0 0 8px 0}
    /* Floating tooltip for attendance */
    .attendance-tooltip {
      position: absolute;
      transform: translate(-50%, -100%);
      background: #111827;
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.2);
      z-index: 99999;
      pointer-events: none;
      opacity: 0;
      transition: opacity .12s ease, transform .12s ease;
    }
    .attendance-tooltip.show { opacity: 1; transform: translate(-50%, -110%); }
  </style>
</head>
<body>

<nav class="navbar bg-white shadow-sm mb-3">
  <div class="container container-wide d-flex justify-content-between align-items-center">
    <div class="d-flex gap-3 align-items-center">
      <span class="badge text-bg-primary rounded-pill"><i class="bi bi-award"></i></span>
      <div>
        <div style="font-weight:700">Admin Panel</div>
        <div class="small-muted">(Students · Teams · Events · Attendance · Approvals · Results · Reports)</div>
      </div>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <!-- Removed duplicate header text and removed the top Students PDF button as requested -->
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm"><i class="bi bi-box-arrow-right"></i></button>
    </div>
  </div>
</nav>

<main class="container container-wide">
  <div class="card-neo mb-3">
    <ul class="nav nav-pills mb-2" id="tabs">
      <li class="nav-item"><button class="nav-link active" data-target="panel-students">Students</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-teams">Teams</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-events">Events</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-attendance">Attendance</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-approvals">Approvals</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-results">Results</button></li>
      <li class="nav-item"><button class="nav-link" data-target="panel-reports">Reports</button></li>
    </ul>

    <div id="panels" class="mt-3">

      <!-- STUDENTS -->
      <section id="panel-students" class="panel">
        <div class="row">
          <div class="col-lg-5">
            <div class="card-neo mb-3">
              <div class="section-title">Import Students (Excel)</div>
              <div class="small-muted mb-2">Columns: Chess Number, Name, Level (Senior/Junior), Team (optional)</div>
              <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2 mb-2">
                <button id="previewStudents" class="btn btn-outline-primary">Preview</button>
                <button id="importStudents" class="btn btn-accent">Import</button>
              </div>

              <hr>
              <div class="section-title">Add Student Manually</div>
              <input id="manualChess" class="form-control mb-2" placeholder="Chess ID (alphanumeric)">
              <input id="manualName" class="form-control mb-2" placeholder="Name">
              <select id="manualLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
              <select id="manualTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
              <div><button id="addManualStudent" class="btn btn-success w-100">Add Student</button></div>

              <hr>
              <div class="section-title">Preview</div>
              <div id="studentsPreview" style="max-height:260px; overflow:auto"></div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="section-title">All Students</div>
                <div class="d-flex gap-2 w-50">
                  <input id="searchStudents" class="form-control form-control-sm" placeholder="Search name or chess">
                  <button id="studentsPdfBtn" class="btn btn-sm btn-outline-secondary" title="Export students as PDF"><i class="bi bi-file-earmark-pdf"></i></button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light"><tr><th>Chess #</th><th>Name</th><th>Level</th><th>Team</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="studentsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>
            <!-- TEAMS -->
      <section id="panel-teams" class="panel d-none">
        <div class="row">
          <div class="col-lg-5">
            <div class="card-neo mb-3">
              <div class="section-title">Add Team</div>
              <input id="teamName" class="form-control mb-2" placeholder="Team name">
              <select id="teamLeader" class="form-select mb-2"><option value="">Leader (Chess#)</option></select>
              <input id="teamPassword" class="form-control mb-2" placeholder="Password (optional)">
              <div class="d-flex gap-2">
                <button id="saveTeam" class="btn btn-success w-100">Save Team</button>
              </div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="section-title">Teams & Attendance %</div>
                <div class="small-muted">Lock toggles prevent team login</div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Attendance %</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="teamsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- EVENTS -->
      <section id="panel-events" class="panel d-none">
        <div class="row">
          <div class="col-lg-5">
            <div class="card-neo mb-3">
              <div class="section-title">Add Event</div>
              <input id="eventName" class="form-control mb-2" placeholder="Event name">
              <select id="eventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option><option>General</option><option>Special</option></select>
              <textarea id="eventDescription" class="form-control mb-2" rows="4" placeholder="Description / rules"></textarea>
              <div><button id="saveEvent" class="btn btn-warning w-100">Save Event</button></div>
            </div>

            <div class="card-neo">
              <div class="section-title">Import Events (Excel)</div>
              <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2"><button id="previewEvents" class="btn btn-outline-primary">Preview</button><button id="importEvents" class="btn btn-accent">Import</button></div>
              <div id="eventsPreview" style="max-height:220px; overflow:auto" class="mt-2"></div>
            </div>
          </div>

          <div class="col-lg-7">
            <div class="card-neo">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="section-title">Events (participated rows highlighted)</div>
                <div class="d-flex gap-2 w-50">
                  <input id="searchEvents" class="form-control form-control-sm" placeholder="Search events">
                  <button id="eventsPdfBtn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-pdf"></i></button>
                </div>
              </div>

              <div class="table-responsive">
                <table class="table table-hover align-middle">
                  <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Description</th><th class="text-end">Actions</th></tr></thead>
                  <tbody id="eventsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      

      </section>
      


      <!-- ATTENDANCE -->
      <section id="panel-attendance" class="panel d-none">
        <div class="card-neo mb-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-2"><input id="attDate" type="date" class="form-control"></div>
            <div class="col-md-2"><input id="attTime" type="time" class="form-control"></div>
            <div class="col-md-4"><input id="attDesc" class="form-control" placeholder="Description"></div>
            <div class="col-md-2"><select id="attMethod" class="form-select"><option value="all">All</option><option value="team">By Team</option></select></div>
            <div class="col-md-2 d-none" id="attTeamWrap"><select id="attTeam" class="form-select"></select></div>
          </div>

          <div class="mt-3">
            <button id="loadAttendance" class="btn btn-info">Load Students</button>
            <button id="toggleAll" class="btn btn-outline-secondary">Toggle All</button>
            <button id="saveAttendance" class="btn btn-success">Save Session</button>
          </div>
        </div>

        <div class="card-neo mb-3" id="attendanceMarkCard" style="display:none">
          <div class="section-title">Mark Attendance</div>
          <div class="small-muted mb-2">Click chess number to toggle present/absent. Tooltip will show name near clicked box.</div>
          <div id="attendanceBoxes" style="padding:12px; position:relative"></div>
        </div>

        <div class="card-neo">
          <div class="section-title">Saved Sessions</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Date</th><th>Time</th><th>Description</th><th>Count</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="attendanceSessions"></tbody>
            </table>
          </div>
        </div>
      </section>
            <!-- APPROVALS -->
      <section id="panel-approvals" class="panel d-none">
        <div class="card-neo mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <h5 class="m-0">Pending Participations</h5>
              <div class="small-muted">Approve submissions from leaders</div>
            </div>
            <div class="d-flex gap-2">
              <input id="searchApprovals" placeholder="Search..." class="form-control form-control-sm">
              <button id="approvalsPdfBtn" class="btn btn-sm btn-outline-secondary"><i class="bi bi-file-earmark-pdf"></i> All</button>
            </div>
          </div>

          <div class="table-responsive" style="max-height:320px; overflow:auto">
            <table class="table table-hover align-middle">
              <thead><tr><th>Event</th><th>Student</th><th>Team</th><th>Submitted At</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="approvalsTable"></tbody>
            </table>
          </div>
        </div>

        <div class="card-neo">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div><h5 class="m-0">Approved Participations (grouped by event)</h5></div>
            <div class="small-muted">Use PDF button per event</div>
          </div>

          <div id="approvedGroups" style="max-height:360px; overflow:auto"></div>
        </div>
      </section>

      <!-- RESULTS -->
      <section id="panel-results" class="panel d-none">
        <div class="card-neo mb-3">
          <div class="section-title">Add Result (1st / 2nd / 3rd)</div>
          <div class="row g-2 align-items-center">
            <div class="col-md-4"><select id="resultEvent" class="form-select"><option value="">Select event</option></select></div>
            <div class="col-md-8 d-flex gap-2">
              <div style="flex:1"><select id="resFirst" class="form-select"><option value="">1st (participant)</option></select></div>
              <div style="width:80px"><input id="ptsFirst" type="number" class="form-control" value="100" min="0" max="100" placeholder="Pts"></div>
              <div style="flex:1"><select id="resSecond" class="form-select"><option value="">2nd</option></select></div>
              <div style="width:80px"><input id="ptsSecond" type="number" class="form-control" value="50" min="0" max="100"></div>
              <div style="flex:1"><select id="resThird" class="form-select"><option value="">3rd</option></select></div>
              <div style="width:80px"><input id="ptsThird" type="number" class="form-control" value="25" min="0" max="100"></div>
              <div><button id="addResult" class="btn btn-primary">Add</button></div>
            </div>
          </div>
        </div>

        <div class="card-neo">
          <div class="section-title">Results List</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th><th>Points</th><th>Published</th><th class="text-end">Actions</th></tr></thead>
              <tbody id="resultsTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS -->
      <section id="panel-reports" class="panel d-none">
        <div class="card-neo">
          <h5 class="section-title">Reports</h5>
          <div class="small-muted mb-3">Attendance percentages & team scores</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Team</th><th>Members</th><th>Attendance %</th><th>Score</th></tr></thead>
              <tbody id="reportsTable"></tbody>
            </table>
          </div>
        </div>
      </section>

    </div>
  </div>
</main>

<!-- Full Edit Team Modal (Option 2) -->
<div class="modal fade" id="fullEditTeamModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="fullEditTeamForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Team</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row">
        <div class="col-md-6">
          <label class="form-label">Team Name</label>
          <input id="editTeamName" class="form-control mb-2" required>
          <label class="form-label">Leader (Chess#)</label>
          <select id="editTeamLeader" class="form-select mb-2"></select>
          <label class="form-label">Password</label>
          <input id="editTeamPassword" class="form-control mb-2" placeholder="Password (optional)">
          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="editTeamLock">
            <label class="form-check-label" for="editTeamLock">Lock team (prevent login)</label>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Members (read only)</label>
          <div id="editTeamMembers" style="max-height:260px; overflow:auto; padding:8px; border:1px solid #eee; border-radius:8px; background:#fafafa"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="deleteTeamBtnModal" class="btn btn-danger">Delete Team</button>
        <button type="submit" class="btn btn-primary">Save Team</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editStudentForm" class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Edit Student</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <label class="form-label">Chess Number (read-only)</label>
        <input id="editChess" class="form-control mb-2" readonly>
        <label class="form-label">Name</label>
        <input id="editName" class="form-control mb-2" required>
        <label class="form-label">Level</label>
        <select id="editLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
        <label class="form-label">Team</label>
        <select id="editTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
      </div>
      <div class="modal-footer"><button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>


<div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>
<!-- Bootstrap JS -->
<!-- PART 4: Full JS (paste before </body>) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
/* ===========================
   Admin: Part 4 - Full JS
   ===========================
   Paste this block at the end of admin.html (before </body>).
   It replaces previous script code and wires all UI.
*/

/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
function toast(msg, type='success'){
  const root = $('toastRoot');
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0`;
  el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  root.appendChild(el);
  const t = new bootstrap.Toast(el, { delay: 3000 });
  t.show();
  el.addEventListener('hidden.bs.toast', ()=> el.remove());
}
function escapeHtml(s){ if(s===undefined||s===null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function encodeKey(k){ return encodeURIComponent(String(k)); }
function debounce(fn, wait=180){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

/* ---------- caches & maps ---------- */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, participations: {}, results: {} };

/* ---------- db refs & listeners ---------- */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');

function scheduleRender(){ if(window._renderPending) return; window._renderPending = true; setTimeout(()=>{ window._renderPending=false; renderAll(); }, 120); }

onValue(studentsRef, snap => {
  const obj = snap.val() || {};
  CACHE.students = Object.values(obj);
  KEYMAP.students = {}; Object.entries(obj).forEach(([k,v])=> { if(v && v.id !== undefined) KEYMAP.students[v.id] = k; });
  scheduleRender();
});
onValue(teamsRef, snap => {
  const obj = snap.val() || {};
  CACHE.teams = Object.values(obj);
  KEYMAP.teams = {}; Object.entries(obj).forEach(([k,v])=> { if(v && v.id !== undefined) KEYMAP.teams[v.id] = k; });
  scheduleRender();
});
onValue(eventsRef, snap => {
  const obj = snap.val() || {};
  CACHE.events = Object.values(obj);
  KEYMAP.events = {}; Object.entries(obj).forEach(([k,v])=> { if(v && v.id !== undefined) KEYMAP.events[v.id] = k; });
  scheduleRender();
});
onValue(partsRef, snap => {
  const obj = snap.val() || {};
  CACHE.participations = Object.values(obj);
  KEYMAP.participations = {}; Object.entries(obj).forEach(([k,v])=> { if(v && v.id !== undefined) KEYMAP.participations[v.id] = k; });
  scheduleRender();
});
onValue(resultsRef, snap => {
  const obj = snap.val() || {};
  CACHE.results = Object.values(obj);
  KEYMAP.results = {}; Object.entries(obj).forEach(([k,v])=> { if(v && v.id !== undefined) KEYMAP.results[v.id] = k; });
  scheduleRender();
});
onValue(attendanceRef, snap => {
  CACHE.attendance = snap.val() || {};
  scheduleRender();
});

/* ---------- UI: tabs ---------- */
document.querySelectorAll('#tabs [data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('.panel').forEach(p => p.classList.add('d-none'));
    const id = btn.getAttribute('data-target');
    $(id).classList.remove('d-none');
    document.querySelectorAll('#tabs .nav-link').forEach(n => n.classList.remove('active'));
    btn.classList.add('active');
  });
});

/* shortcut nav */
$('logoutBtn')?.addEventListener('click', ()=> { sessionStorage.clear(); location.href='index.html'; });

/* ---------- Renderers ---------- */

function renderAll(){
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceSessions();
  renderApprovals();
  renderApprovedGroups();
  renderResults();
  renderReports();
  populateDropdowns();
}

/* Students */
function renderStudents(){
  const q = ($('searchStudents')?.value||'').trim().toLowerCase();
  const teamMap = {}; CACHE.teams.forEach(t => teamMap[t.id] = t.name);
  const rows = [];
  CACHE.students.slice().sort((a,b)=> String(a.id).localeCompare(String(b.id))).forEach(s=>{
    const team = s.teamId ? (teamMap[s.teamId]||'Unknown') : 'Unassigned';
    const txt = `${s.id} ${s.name} ${team}`.toLowerCase();
    if(q && !txt.includes(q)) return;
    rows.push(`<tr data-id="${escapeHtml(s.id)}"><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'Senior')}</td><td>${escapeHtml(team)}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-student" data-id="${escapeHtml(s.id)}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-student" data-id="${escapeHtml(s.id)}">Delete</button>
    </td></tr>`);
  });
  $('studentsTable').innerHTML = rows.length ? rows.join('') : '<tr><td colspan="5" class="text-center muted">No students</td></tr>';
}

/* Teams */
function computeTeamAttendancePct(teamId){
  const members = CACHE.students.filter(s=> String(s.teamId)===String(teamId)).map(s=> s.id);
  if(!members.length) return 0;
  let total=0, present=0;
  for(const k in (CACHE.attendance || {})){
    const sess = CACHE.attendance[k];
    if(!sess || !sess.students) continue;
    members.forEach(m=>{
      if(sess.students[m] !== undefined){ total++; if(String(sess.students[m]).toLowerCase()==='present') present++; }
    });
  }
  return total ? Math.round((present/total)*100) : 0;
}
function renderTeams(){
  const rows = [];
  const studentsById = {}; CACHE.students.forEach(s => studentsById[s.id] = s);
  CACHE.teams.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(t=>{
    const leader = t.leaderId ? studentsById[t.leaderId] : null;
    const members = CACHE.students.filter(s=> String(s.teamId)===String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const locked = t.locked ? 'checked' : '';
    rows.push(`<tr data-id="${escapeHtml(t.id)}"><td>${escapeHtml(t.name)}</td><td>${leader?escapeHtml(leader.name+' ('+leader.id+')'):'-'}</td><td>${members}</td><td>${pct}%</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-team" data-id="${escapeHtml(t.id)}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-team" data-id="${escapeHtml(t.id)}">Delete</button>
      <label class="ms-2 mb-0"><input class="form-check-input lock-team" type="checkbox" data-id="${escapeHtml(t.id)}" ${locked}> Lock</label>
    </td></tr>`);
  });
  $('teamsTable').innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No teams</td></tr>';
}

/* Events */
function renderEvents(){
  const q = ($('searchEvents')?.value||'').trim().toLowerCase();
  const rows = [];
  CACHE.events.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(ev=>{
    const participated = CACHE.participations && CACHE.participations.some(p => String(p.eventId) === String(ev.id) && p.status === 'approved');
    const cls = participated ? 'participated-row' : '';
    if(q && !(`${ev.name} ${ev.type} ${ev.description||''}`.toLowerCase().includes(q))) return;
    rows.push(`<tr class="${cls}" data-id="${escapeHtml(ev.id)}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.type)}</td><td>${escapeHtml((ev.description||'').slice(0,120))}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-event" data-id="${escapeHtml(ev.id)}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-event" data-id="${escapeHtml(ev.id)}">Delete</button>
    </td></tr>`);
  });
  $('eventsTable').innerHTML = rows.join('') || '<tr><td colspan="4" class="text-center muted">No events</td></tr>';
}

/* Attendance sessions list */
function renderAttendanceSessions(){
  const rows = []; const att = CACHE.attendance || {};
  const items = Object.entries(att).sort((a,b)=> (b[1].savedAt||0)-(a[1].savedAt||0));
  for(const [k,v] of items){
    const count = v.students ? Object.keys(v.students).length : 0;
    rows.push(`<tr data-key="${escapeHtml(k)}"><td>${escapeHtml(v.date||'')}</td><td>${escapeHtml(v.time||'')}</td><td>${escapeHtml(v.description||'')}</td><td>${count}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-view-att" data-key="${escapeHtml(k)}">View Absents</button>
      <button class="btn btn-sm btn-outline-secondary btn-edit-att" data-key="${escapeHtml(k)}">Edit</button>
    </td></tr>`);
  }
  $('attendanceSessions').innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No sessions</td></tr>';
}

/* Approvals (pending) */
function renderApprovals(){
  const q = ($('searchApprovals')?.value||'').trim().toLowerCase();
  const rows = [];
  const parts = (CACHE.participations || []).filter(p => p.status === 'pending');
  for(const p of parts){
    const ev = CACHE.events.find(e => e.id == p.eventId) || {};
    const st = CACHE.students.find(s => s.id == p.studentId) || { name: p.studentId };
    const team = CACHE.teams.find(t => t.id == p.teamId) || {};
    const text = `${ev.name||''} ${st.name||''} ${team.name||''}`.toLowerCase();
    if(q && !text.includes(q)) continue;
    rows.push(`<tr data-id="${escapeHtml(p.id)}"><td>${escapeHtml(ev.name||p.eventId)}</td><td>${escapeHtml(st.name||p.studentId)}</td><td>${escapeHtml(team.name||p.teamId)}</td><td>${new Date(p.submittedAt||0).toLocaleString()}</td><td class="text-end">
      <button class="btn btn-sm btn-success btn-approve" data-id="${escapeHtml(p.id)}">Approve</button>
      <button class="btn btn-sm btn-danger btn-reject" data-id="${escapeHtml(p.id)}">Reject</button>
    </td></tr>`);
  }
  $('approvalsTable').innerHTML = rows.join('') || '<tr><td colspan="5" class="text-center muted">No pending participations</td></tr>';
}

/* Approved groups for PDF */
function renderApprovedGroups(){
  const approved = (CACHE.participations || []).filter(p => p.status === 'approved');
  const groups = {};
  for(const p of approved){ (groups[p.eventId] = groups[p.eventId] || []).push(p); }
  const wrap = $('approvedGroups');
  if(!Object.keys(groups).length){ wrap.innerHTML = '<div class="muted p-3">No approved participants yet.</div>'; return; }
  let html = '';
  for(const evId of Object.keys(groups)){
    const ev = CACHE.events.find(e=> e.id==evId) || { name: evId };
    html += `<div class="teams-group"><div class="d-flex justify-content-between align-items-center"><h6>${escapeHtml(ev.name)}</h6><div><button class="btn btn-sm btn-outline-secondary btn-download-approved" data-event="${escapeHtml(evId)}">PDF</button></div></div><ol>`;
    groups[evId].forEach(p => {
      const st = CACHE.students.find(s=> s.id==p.studentId) || {};
      const tname = (CACHE.teams.find(t=> t.id==p.teamId)||{}).name||'';
      html += `<li>${escapeHtml(st.name || p.studentId)} (${escapeHtml(p.studentId)}) — ${escapeHtml(tname)}</li>`;
    });
    html += `</ol></div>`;
  }
  wrap.innerHTML = html;
}

/* Results & Reports */
function renderResults(){
  const rows = []; const results = (CACHE.results || []).slice().sort((a,b)=> (b.createdAt||0)-(a.createdAt||0));
  const findParticipation = id => (CACHE.participations||[]).find(p=> p.id==id) || {};
  const findStudent = id => (CACHE.students||[]).find(s=> s.id==id) || {};
  for(const r of results){
    const ev = CACHE.events.find(e=> e.id==r.eventId) || {};
    const p1 = findParticipation(r.first); const p2 = findParticipation(r.second); const p3 = findParticipation(r.third);
    const s1 = findStudent(p1.studentId); const s2 = findStudent(p2.studentId); const s3 = findStudent(p3.studentId);
    const pts = `${r.pFirst||0}/${r.pSecond||0}/${r.pThird||0}`;
    const pub = r.published ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>';
    rows.push(`<tr data-id="${escapeHtml(r.id)}"><td>${escapeHtml(ev.name||'')}</td><td>${escapeHtml(s1.name||'')}</td><td>${escapeHtml(s2.name||'')}</td><td>${escapeHtml(s3.name||'')}</td><td>${escapeHtml(pts)}</td><td>${pub}</td><td class="text-end">
      <button class="btn btn-sm btn-outline-primary btn-edit-result" data-id="${escapeHtml(r.id)}">Edit</button>
      <button class="btn btn-sm btn-outline-danger btn-delete-result" data-id="${escapeHtml(r.id)}">Delete</button>
      <button class="btn btn-sm btn-outline-success btn-publish-result" data-id="${escapeHtml(r.id)}">${r.published ? 'Unpublish' : 'Publish'}</button>
    </td></tr>`);
  }
  $('resultsTable').innerHTML = rows.join('') || '<tr><td colspan="7" class="text-center muted">No results</td></tr>';
}

function computeTeamScore(teamId){
  let sum = 0;
  for(const r of CACHE.results || []){
    if(!r.published) continue;
    const arr = [
      { pid: r.first, pts: Number(r.pFirst)||0 },
      { pid: r.second, pts: Number(r.pSecond)||0 },
      { pid: r.third, pts: Number(r.pThird)||0 }
    ];
    arr.forEach(a => {
      const p = (CACHE.participations||[]).find(x=> x.id==a.pid);
      if(p && String(p.teamId) === String(teamId)) sum += a.pts;
    });
  }
  return sum;
}
function renderReports(){
  const rows = [];
  CACHE.teams.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(t=>{
    const members = CACHE.students.filter(s=> String(s.teamId)===String(t.id)).length;
    const pct = computeTeamAttendancePct(t.id);
    const score = computeTeamScore(t.id);
    rows.push(`<tr><td>${escapeHtml(t.name)}</td><td>${members}</td><td>${pct}%</td><td>${score}</td></tr>`);
  });
  $('reportsTable').innerHTML = rows.join('') || '<tr><td colspan="4" class="text-center muted">No teams</td></tr>';
}

/* populate dropdowns */
function populateDropdowns(){
  const manualTeam = $('manualTeam'); if(manualTeam){ manualTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> manualTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const teamLeader = $('teamLeader'); if(teamLeader){ teamLeader.innerHTML = '<option value="">Leader (Chess#)</option>'; CACHE.students.forEach(s=> teamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const attTeam = $('attTeam'); if(attTeam){ attTeam.innerHTML = '<option value="">Select team</option>'; CACHE.teams.forEach(t=> attTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeam = $('editTeam'); if(editTeam){ editTeam.innerHTML = '<option value="">Unassigned</option>'; CACHE.teams.forEach(t=> editTeam.innerHTML += `<option value="${escapeHtml(t.id)}">${escapeHtml(t.name)}</option>`); }
  const editTeamLeader = $('editTeamLeader'); if(editTeamLeader){ editTeamLeader.innerHTML = '<option value="">Select leader</option>'; CACHE.students.forEach(s=> editTeamLeader.innerHTML += `<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)} (${escapeHtml(s.id)})</option>`); }
  const resEv = $('resultEvent'); if(resEv){ resEv.innerHTML = '<option value="">Select event</option>'; CACHE.events.forEach(e => resEv.innerHTML += `<option value="${escapeHtml(e.id)}">${escapeHtml(e.name)}</option>`); }
}

/* ---------- wiring: Students ---------- */
let studentsPreviewRows = [];
$('previewStudents')?.addEventListener('click', ()=>{
  const f = $('studentFile').files[0]; if(!f) return toast('Select Excel file','danger');
  const r = new FileReader(); r.onload = e => {
    const wb = XLSX.read(e.target.result, { type:'binary' });
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' });
    studentsPreviewRows = json.slice(0,1000);
    let html = '<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>';
    studentsPreviewRows.forEach(rw => {
      const chess = (rw['Chess']||rw['Chess Number']||rw['ID']||'').toString();
      const name = (rw['Name']||rw['name']||'').toString();
      const level = (rw['Level']||rw['level']||'Senior').toString();
      const team = (rw['Team']||rw['team']||'').toString();
      html += `<tr><td>${escapeHtml(chess)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(level)}</td><td>${escapeHtml(team)}</td></tr>`;
    });
    html += '</tbody></table>';
    $('studentsPreview').innerHTML = html;
  }; r.readAsBinaryString(f);
});
$('importStudents')?.addEventListener('click', async ()=>{
  if(!studentsPreviewRows.length) return toast('No preview','danger');
  const teamNameMap = {}; CACHE.teams.forEach(t=> teamNameMap[String(t.name).trim().toLowerCase()]=t.id);
  const updates = {}; let imported=0, skipped=0;
  studentsPreviewRows.forEach(rw=>{
    const chess = (rw['Chess']||rw['Chess Number']||rw['ID']||'').toString().trim();
    const name = (rw['Name']||rw['name']||'').toString().trim();
    const level = (rw['Level']||rw['level']||'Senior').toString().trim();
    if(!chess || !name){ skipped++; return; }
    if(CACHE.students.some(s=> String(s.id)===String(chess) || String(s.name||'').trim().toLowerCase()===String(name).trim().toLowerCase())) { skipped++; return; }
    const teamName = (rw['Team']||rw['team']||'').toString().trim();
    const teamId = teamName ? teamNameMap[teamName.toLowerCase()] || null : null;
    updates[`students/${encodeKey(chess)}`] = { id: chess, name, level, teamId: teamId?String(teamId):null };
    imported++;
  });
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  studentsPreviewRows=[]; $('studentsPreview').innerHTML=''; $('studentFile').value='';
  toast(`Imported ${imported}, skipped ${skipped}`);
});
$('addManualStudent')?.addEventListener('click', async ()=>{
  const chess = $('manualChess').value.trim(); const name = $('manualName').value.trim(); const level = $('manualLevel').value||'Senior'; const teamId = $('manualTeam').value || null;
  if(!chess || !name) return toast('Enter chess & name','danger');
  if(CACHE.students.some(s=> String(s.id)===String(chess))) return toast('Chess ID exists','danger');
  if(CACHE.students.some(s=> String(s.name||'').trim().toLowerCase()===String(name).trim().toLowerCase())) return toast('Name exists','danger');
  await set(ref(db, `students/${encodeKey(chess)}`), { id: chess, name, level, teamId: teamId?String(teamId):null });
  $('manualChess').value=''; $('manualName').value=''; $('manualTeam').value='';
  toast('Student added');
});
$('studentsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id;
  if(btn.classList.contains('btn-delete-student')){ if(!confirm('Delete student?')) return; await remove(ref(db, `students/${encodeKey(id)}`)); toast('Deleted'); }
  else if(btn.classList.contains('btn-edit-student')){
    const dbKey = KEYMAP.students[id]; const snap = await get(ref(db, `students/${dbKey}`)); const s = snap.val(); if(!s) return toast('Not found','danger');
    $('editChess').value = s.id; $('editName').value = s.name||''; $('editLevel').value = s.level||'Senior';
    populateDropdowns();
    setTimeout(()=> { $('editTeam').value = s.teamId||''; }, 80);
    document.getElementById('editStudentModal').dataset.dbKey = dbKey;
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
  }
});
document.getElementById('editStudentForm')?.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = document.getElementById('editStudentModal').dataset.dbKey; if(!dbKey) return toast('Missing key','danger');
  const newName = $('editName').value.trim(); const newTeam = $('editTeam').value || null; const newLevel = $('editLevel').value || 'Senior';
  if(!newName) return toast('Name required','danger');
  const curSnap = await get(ref(db, `students/${dbKey}`)); const cur = curSnap.val(); if(!cur) return toast('Student not found','danger');
  if(String(newName).trim().toLowerCase() !== String(cur.name||'').trim().toLowerCase()){
    if(CACHE.students.some(s=> String(s.name||'').trim().toLowerCase()===String(newName).trim().toLowerCase())) return toast('Name already exists','danger');
  }
  await update(ref(db, `students/${dbKey}`), { name: newName, teamId: newTeam ? String(newTeam) : null, level: newLevel });
  toast('Student updated'); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});
$('deleteStudentBtn')?.addEventListener('click', async ()=>{
  if(!confirm('Delete this student?')) return;
  const dbKey = document.getElementById('editStudentModal').dataset.dbKey; if(!dbKey) return toast('Missing key','danger');
  await remove(ref(db, `students/${dbKey}`)); toast('Student deleted'); bootstrap.Modal.getInstance(document.getElementById('editStudentModal')).hide();
});

/* ---------- Teams ---------- */
$('saveTeam')?.addEventListener('click', async ()=>{
  const name = $('teamName').value.trim(); const leader = $('teamLeader').value || null; const pwd = $('teamPassword').value.trim()||'';
  if(!name) return toast('Team name required','danger');
  if(CACHE.teams.some(t=> String(t.name||'').trim().toLowerCase()===name.toLowerCase())) return toast('Team exists','danger');
  const p = push(ref(db, 'teams')); const id = Date.now().toString();
  await set(p, { id, name, leaderId: leader?String(leader):null, password: pwd, score: 0, locked: false });
  $('teamName').value=''; $('teamLeader').value=''; $('teamPassword').value='';
  toast('Team saved');
});
$('teamsTable').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id;
  if(btn.classList.contains('btn-delete-team')){
    if(!confirm('Delete team?')) return;
    const dbKey = KEYMAP.teams[id]; if(dbKey) await remove(ref(db, `teams/${dbKey}`));
    const updates = {}; CACHE.students.filter(s=> String(s.teamId)===String(id)).forEach(s => updates[`students/${encodeKey(s.id)}/teamId`] = null);
    if(Object.keys(updates).length) await update(ref(db,'/'), updates);
    toast('Team deleted');
  } else if(btn.classList.contains('btn-edit-team')){
    const dbKey = KEYMAP.teams[id]; const snap = await get(ref(db, `teams/${dbKey}`)); const t = snap.val(); if(!t) return toast('Not found','danger');
    $('editTeamName').value = t.name||''; $('editTeamPassword').value = t.password||''; $('editTeamLock').checked = !!t.locked;
    populateDropdowns();
    setTimeout(()=> { $('editTeamLeader').value = t.leaderId || ''; }, 80);
    const members = CACHE.students.filter(s=> String(s.teamId)===String(t.id)).sort((a,b)=> String(a.id).localeCompare(String(b.id)));
    $('editTeamMembers').innerHTML = members.length ? members.map(m=>`<div>${escapeHtml(m.name)} (${escapeHtml(m.id)})</div>`).join('') : '<div class="muted">No members</div>';
    document.getElementById('fullEditTeamModal').dataset.dbKey = dbKey;
    document.getElementById('fullEditTeamModal').dataset.teamId = t.id;
    new bootstrap.Modal(document.getElementById('fullEditTeamModal')).show();
  }
});
$('teamsTable').addEventListener('change', async (e)=>{
  const cb = e.target.closest('input.lock-team'); if(!cb) return;
  const id = cb.dataset.id; const dbKey = KEYMAP.teams[id]; if(!dbKey) return toast('Team key missing','danger');
  await update(ref(db, `teams/${dbKey}`), { locked: !!cb.checked });
  toast(cb.checked ? 'Team locked' : 'Team unlocked');
});
document.getElementById('fullEditTeamForm')?.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = document.getElementById('fullEditTeamModal').dataset.dbKey; const teamId = document.getElementById('fullEditTeamModal').dataset.teamId;
  if(!dbKey) return toast('Missing team key','danger');
  const name = $('editTeamName').value.trim(); const leader = $('editTeamLeader').value || null; const pwd = $('editTeamPassword').value||''; const locked = !!$('editTeamLock').checked;
  if(!name) return toast('Name required','danger');
  await update(ref(db, `teams/${dbKey}`), { name, leaderId: leader ? String(leader) : null, password: pwd, locked });
  toast('Team updated'); bootstrap.Modal.getInstance(document.getElementById('fullEditTeamModal')).hide();
});
$('deleteTeamBtnModal')?.addEventListener('click', async ()=>{
  if(!confirm('Delete this team?')) return;
  const dbKey = document.getElementById('fullEditTeamModal').dataset.dbKey; const teamId = document.getElementById('fullEditTeamModal').dataset.teamId;
  if(!dbKey) return toast('Missing team key','danger');
  await remove(ref(db, `teams/${dbKey}`));
  const updates = {}; CACHE.students.filter(s=> String(s.teamId)===String(teamId)).forEach(s=> updates[`students/${encodeKey(s.id)}/teamId`] = null);
  if(Object.keys(updates).length) await update(ref(db,'/'), updates);
  toast('Team deleted'); bootstrap.Modal.getInstance(document.getElementById('fullEditTeamModal')).hide();
});

/* ---------- Events ---------- */
$('saveEvent')?.addEventListener('click', async ()=>{
  const name = $('eventName').value.trim(); const type = $('eventType').value; const desc = $('eventDescription').value.trim();
  if(!name) return toast('Event name required','danger');
  if(CACHE.events.some(e=> String(e.name||'').trim().toLowerCase()===name.toLowerCase())) return toast('Event exists','danger');
  const p = push(ref(db,'events')); const id = Date.now().toString();
  await set(p, { id, name, type, description: desc, status: 'Open' });
  $('eventName').value=''; $('eventDescription').value=''; toast('Event added');
});

/* Events import/preview (XLSX) */
$('previewEvents')?.addEventListener('click', ()=>{
  const f = $('eventFile').files[0]; if(!f) return toast('Choose file','danger');
  const r = new FileReader(); r.onload = e => {
    const wb = XLSX.read(e.target.result,{type:'binary'});
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>';
    json.forEach(rw => html += `<tr><td>${escapeHtml(rw['Name']||rw['Event']||'')}</td><td>${escapeHtml(rw['Type']||'')}</td><td>${escapeHtml(rw['Description']||'')}</td></tr>`);
    html += '</tbody></table>';
    $('eventsPreview').innerHTML = html;
  }; r.readAsBinaryString(f);
});
$('importEvents')?.addEventListener('click', ()=>{
  const f = $('eventFile').files[0]; if(!f) return toast('Choose file','danger');
  const r = new FileReader(); r.onload = async e=>{
    const wb = XLSX.read(e.target.result,{type:'binary'});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval:'' }).slice(0,500);
    const updates = {}; let imported=0, skipped=0;
    for(const rw of rows){
      const name = (rw['Name']||rw['Event']||rw['name']||'').toString().trim(); if(!name){ skipped++; continue; }
      if(CACHE.events.some(ev=> String(ev.name||'').trim().toLowerCase()===name.toLowerCase())){ skipped++; continue; }
      const type = (rw['Type']||'Non-Stage').toString(); const desc = (rw['Description']||'').toString();
      const id = Date.now().toString() + Math.floor(Math.random()*9999);
      updates[`events/${id}`] = { id, name, type, description: desc, status: 'Open' };
      imported++;
    }
    if(Object.keys(updates).length) await update(ref(db,'/'), updates);
    $('eventFile').value=''; $('eventsPreview').innerHTML=''; toast(`Imported ${imported}, skipped ${skipped}`);
  }; r.readAsBinaryString(f);
});

/* Events table buttons: edit uses modal, delete uses remove */
document.getElementById('eventsTable')?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const id = btn.dataset.id;
  if(btn.classList.contains('btn-delete-event')){
    if(!confirm('Delete event?')) return;
    const dbKey = KEYMAP.events[id]; if(dbKey) await remove(ref(db, `events/${dbKey}`));
    toast('Event removed');
  } else if(btn.classList.contains('btn-edit-event')){
    const dbKey = KEYMAP.events[id];
    const snap = await get(ref(db, `events/${dbKey}`)); const ev = snap.val();
    if(!ev) return toast('Event not found','danger');
    // Fill and open editEventModal (modal HTML must exist in Part-3)
    if($('editEventId')){ // if modal exists
      $('editEventId').value = dbKey;
      $('editEventName').value = ev.name || '';
      $('editEventType').value = ev.type || 'Non-Stage';
      $('editEventDesc').value = ev.description || '';
      new bootstrap.Modal(document.getElementById('editEventModal')).show();
    } else {
      toast('Edit Event modal not found. Please paste the modal HTML (see instructions).','danger');
    }
  }
});

/* Edit event modal save & delete */
document.getElementById('editEventForm')?.addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const dbKey = $('editEventId').value; const name = $('editEventName').value.trim(); const type = $('editEventType').value; const desc = $('editEventDesc').value.trim();
  if(!dbKey) return toast('Missing event key','danger');
  if(!name) return toast('Event name required','danger');
  // ensure unique name (allow same if same dbKey)
  if(CACHE.events.some(e => String(e.name||'').trim().toLowerCase() === name.toLowerCase() && KEYMAP.events[e.id] !== dbKey)) return toast('Event name already exists','danger');
  await update(ref(db, `events/${dbKey}`), { name, type, description: desc });
  toast('Event updated'); bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
});
$('deleteEventBtn')?.addEventListener('click', async ()=>{
  if(!confirm('Delete this event?')) return;
  const dbKey = $('editEventId').value; if(!dbKey) return toast('Missing event key','danger');
  await remove(ref(db, `events/${dbKey}`));
  toast('Event deleted'); bootstrap.Modal.getInstance(document.getElementById('editEventModal')).hide();
});

/* ---------- Approvals (approve/reject + PDFs) ---------- */
$('approvalsTable')?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id;
  if(btn.classList.contains('btn-approve')){
    const dbKey = KEYMAP.participations[id];
    await update(ref(db, `participations/${dbKey}`), { status: 'approved', approvedAt: Date.now() });
    toast('Approved');
  } else if(btn.classList.contains('btn-reject')){
    const dbKey = KEYMAP.participations[id];
    await update(ref(db, `participations/${dbKey}`), { status: 'rejected', rejectedAt: Date.now() });
    toast('Rejected');
  }
});

/* download approved per event (HTML->pdf) */
$('approvedGroups')?.addEventListener('click', (e)=>{
  const btn = e.target.closest('button.btn-download-approved'); if(!btn) return; const evId = btn.dataset.event;
  const evObj = CACHE.events.find(x=> x.id==evId) || {};
  const approved = (CACHE.participations||[]).filter(p=> p.eventId==evId && p.status==='approved');
  if(!approved.length) return toast('No approved participants','warning');
  let html = `<h3>${escapeHtml(evObj.name||evId)}</h3><ol>`;
  approved.forEach(p => { const st = CACHE.students.find(s=> s.id==p.studentId) || {}; html += `<li>${escapeHtml(st.name || p.studentId)} (${escapeHtml(p.studentId)})</li>`; });
  html += '</ol>';
  const container = document.createElement('div'); container.style.padding='12px'; container.innerHTML = html; document.body.appendChild(container);
  /* html2pdf is loaded in Part-1; ensure you have it referenced. */
  html2pdf().from(container).set({margin:0.3, filename:`approved-${(evObj.name||evId).replace(/\s+/g,'_')}.pdf`}).save().then(()=> container.remove());
});
$('approvalsPdfBtn')?.addEventListener('click', ()=>{
  const rows = (CACHE.participations||[]).filter(p=> p.status==='pending').map(p=>{
    const ev = CACHE.events.find(e=> e.id==p.eventId) || {}; const st = CACHE.students.find(s=> s.id==p.studentId) || {};
    const tname = (CACHE.teams.find(t=> t.id==p.teamId)||{}).name||'';
    return `<tr><td>${escapeHtml(ev.name||p.eventId)}</td><td>${escapeHtml(st.name||p.studentId)}</td><td>${escapeHtml(tname)}</td><td>${new Date(p.submittedAt||0).toLocaleString()}</td></tr>`;
  }).join('');
  if(!rows) return toast('No pending participations','warning');
  const html = `<table class="table table-sm"><thead><tr><th>Event</th><th>Student</th><th>Team</th><th>Submitted</th></tr></thead><tbody>${rows}</tbody></table>`;
  const d = document.createElement('div'); d.style.padding='12px'; d.innerHTML = `<h3>Pending Participations</h3>${html}`; document.body.appendChild(d);
  html2pdf().from(d).set({margin:0.3, filename:'pending_participations.pdf'}).save().then(()=> d.remove());
});

/* ---------- Results: add/edit/publish/delete ---------- */
$('resultEvent')?.addEventListener('change', ()=>{
  const ev = $('resultEvent').value;
  const participants = (CACHE.participations||[]).filter(p=> String(p.eventId)===String(ev) && p.status==='approved');
  const map = {}; CACHE.students.forEach(s=> map[s.id] = s.name);
  ['resFirst','resSecond','resThird'].forEach(id=>{
    const sel = $(id); if(!sel) return; sel.innerHTML = '<option value="">Select</option>';
    participants.forEach(p => sel.innerHTML += `<option value="${escapeHtml(p.id)}">${escapeHtml(map[p.studentId]||p.studentId)} (${escapeHtml(p.studentId)})</option>`);
  });
});
$('addResult')?.addEventListener('click', async ()=>{
  const ev = $('resultEvent').value; if(!ev) return toast('Select event','danger');
  const first = $('resFirst').value || ''; const second = $('resSecond').value || ''; const third = $('resThird').value || '';
  const p1 = Number($('ptsFirst').value)||0, p2 = Number($('ptsSecond').value)||0, p3 = Number($('ptsThird').value)||0;
  const p = push(ref(db,'results')); const id = Date.now().toString();
  await set(p, { id, eventId: ev, first, second, third, pFirst: p1, pSecond: p2, pThird: p3, published:false, createdAt: Date.now() });
  toast('Result added');
});

/* Results table actions */
$('resultsTable')?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return; const id = btn.dataset.id;
  if(btn.classList.contains('btn-delete-result')){ if(!confirm('Delete result?')) return; const dbKey = KEYMAP.results[id]; if(dbKey) await remove(ref(db, `results/${dbKey}`)); toast('Deleted'); }
  else if(btn.classList.contains('btn-edit-result')){
    const dbKey = KEYMAP.results[id]; const snap = await get(ref(db, `results/${dbKey}`)); const r = snap.val(); if(!r) return toast('Not found','danger');
    // build and show modal to edit result (dynamic modal)
    openEditResultModal(r, dbKey);
  }
  else if(btn.classList.contains('btn-publish-result')){
    const dbKey = KEYMAP.results[id]; const snap = await get(ref(db, `results/${dbKey}`)); const r = snap.val(); if(!r) return toast('Not found','danger');
    const newv = !r.published; await update(ref(db, `results/${dbKey}`), { published: newv, publishedAt: newv?Date.now():null });
    toast(newv ? 'Published' : 'Unpublished');
  }
});

/* dynamic result edit modal creation and handler */
function openEditResultModal(resultObj, dbKey){
  // remove existing dynamic modal if present
  const existing = document.getElementById('dynamicEditResultModal'); if(existing) existing.remove();
  // create modal DOM
  const modalHtml = `
  <div class="modal fade" id="dynamicEditResultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form id="dynamicEditResultForm" class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Edit Result</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="dynResDbKey" value="${escapeHtml(dbKey)}">
          <div class="mb-2">
            <label class="form-label">Event</label>
            <input class="form-control" id="dynResEventName" readonly value="${escapeHtml((CACHE.events.find(e=> e.id==resultObj.eventId)||{}).name || '')}">
          </div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">1st (participation id)</label>
              <select id="dynResFirst" class="form-select"></select>
            </div>
            <div class="col-md-2"><label class="form-label">Points</label><input id="dynPtsFirst" type="number" class="form-control" value="${escapeHtml(resultObj.pFirst||0)}"></div>

            <div class="col-md-4">
              <label class="form-label">2nd</label>
              <select id="dynResSecond" class="form-select"></select>
            </div>
            <div class="col-md-2"><label class="form-label">Points</label><input id="dynPtsSecond" type="number" class="form-control" value="${escapeHtml(resultObj.pSecond||0)}"></div>

            <div class="col-md-4">
              <label class="form-label">3rd</label>
              <select id="dynResThird" class="form-select"></select>
            </div>
            <div class="col-md-2"><label class="form-label">Points</label><input id="dynPtsThird" type="number" class="form-control" value="${escapeHtml(resultObj.pThird||0)}"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="dynDeleteResultBtn" class="btn btn-danger">Delete</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>`;
  const div = document.createElement('div'); div.innerHTML = modalHtml; document.body.appendChild(div.firstElementChild);
  // populate selects with approved participants for that event
  const participants = (CACHE.participations||[]).filter(p=> String(p.eventId) === String(resultObj.eventId) && p.status === 'approved');
  const map = {}; CACHE.students.forEach(s => map[s.id] = s.name);
  ['dynResFirst','dynResSecond','dynResThird'].forEach(id => {
    const sel = document.getElementById(id); if(!sel) return;
    sel.innerHTML = '<option value="">Select</option>';
    participants.forEach(p => sel.innerHTML += `<option value="${escapeHtml(p.id)}">${escapeHtml(map[p.studentId]||p.studentId)} (${escapeHtml(p.studentId)})</option>`);
  });
  // set current values
  setTimeout(()=> {
    document.getElementById('dynResFirst').value = resultObj.first || '';
    document.getElementById('dynResSecond').value = resultObj.second || '';
    document.getElementById('dynResThird').value = resultObj.third || '';
  }, 60);

  // show modal
  const bsModal = new bootstrap.Modal(document.getElementById('dynamicEditResultModal'));
  bsModal.show();

  // submit handler
  document.getElementById('dynamicEditResultForm').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const dbk = document.getElementById('dynResDbKey').value;
    const nf = document.getElementById('dynResFirst').value || '';
    const ns = document.getElementById('dynResSecond').value || '';
    const nt = document.getElementById('dynResThird').value || '';
    const p1 = Number(document.getElementById('dynPtsFirst').value)||0;
    const p2 = Number(document.getElementById('dynPtsSecond').value)||0;
    const p3 = Number(document.getElementById('dynPtsThird').value)||0;
    await update(ref(db, `results/${dbk}`), { first: nf, second: ns, third: nt, pFirst: p1, pSecond: p2, pThird: p3 });
    toast('Result updated');
    bsModal.hide();
  }, { once: true });

  document.getElementById('dynDeleteResultBtn').addEventListener('click', async ()=>{
    if(!confirm('Delete this result?')) return;
    const dbk = document.getElementById('dynResDbKey').value;
    await remove(ref(db, `results/${dbk}`));
    toast('Result deleted');
    bsModal.hide();
  }, { once: true });
}

/* ---------- Attendance: tooltip + load + save + edit ---------- */
/* floating tooltip */
const attTooltip = document.createElement('div'); attTooltip.className = 'attendance-tooltip'; document.body.appendChild(attTooltip);
let attTooltipTimer = null;
function showAttendanceTooltip(el, text){
  clearTimeout(attTooltipTimer);
  attTooltip.textContent = text;
  const rect = el.getBoundingClientRect();
  const x = rect.left + rect.width/2 + window.scrollX;
  const y = rect.top + window.scrollY;
  attTooltip.style.left = x + 'px';
  attTooltip.style.top = (y - 6) + 'px';
  attTooltip.classList.add('show');
  attTooltipTimer = setTimeout(()=> attTooltip.classList.remove('show'), 1500);
}

let attendanceEditKey = null;
$('attMethod')?.addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));

$('loadAttendance')?.addEventListener('click', ()=>{
  const mode = $('attMethod').value; const teamId = $('attTeam').value;
  const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
  if(mode === 'team'){
    const members = CACHE.students.filter(s=> String(s.teamId)===String(teamId)).sort((a,b)=> String(a.id).localeCompare(String(b.id)));
    members.forEach(s=>{
      const div = document.createElement('div'); div.className = 'small-box absent'; div.dataset.key = s.id; div.dataset.name = s.name||''; div.textContent = s.id;
      div.addEventListener('click', ()=> { div.classList.toggle('present'); div.classList.toggle('absent'); showAttendanceTooltip(div, `${s.name} (${s.id})`); });
      wrap.appendChild(div);
    });
  } else {
    // group by team
    const teams = CACHE.teams.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    teams.forEach(team=>{
      const group = document.createElement('div'); group.className = 'teams-group';
      const h = document.createElement('h6'); h.textContent = team.name; group.appendChild(h);
      const inner = document.createElement('div');
      const members = CACHE.students.filter(s=> String(s.teamId)===String(team.id)).sort((a,b)=> String(a.id).localeCompare(String(b.id)));
      members.forEach(s=>{
        const div = document.createElement('div'); div.className = 'small-box absent'; div.dataset.key = s.id; div.dataset.name = s.name||''; div.textContent = s.id;
        div.addEventListener('click', ()=> { div.classList.toggle('present'); div.classList.toggle('absent'); showAttendanceTooltip(div, `${s.name} (${s.id})`); });
        inner.appendChild(div);
      });
      group.appendChild(inner); wrap.appendChild(group);
    });
  }
  $('attendanceMarkCard').style.display = wrap.children.length ? 'block' : 'none';
});

$('toggleAll')?.addEventListener('click', ()=>{
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box')); if(!boxes.length) return;
  const allPresent = boxes.every(b=> b.classList.contains('present'));
  boxes.forEach(b=> { b.classList.toggle('present', !allPresent); b.classList.toggle('absent', allPresent); });
});

$('saveAttendance')?.addEventListener('click', async ()=>{
  const date = $('attDate').value; const time = $('attTime').value||''; const desc = $('attDesc').value||'';
  if(!date) return toast('Select date','danger');
  const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box')); if(!boxes.length) return toast('Load students first','danger');
  const studObj = {}; boxes.forEach(b=> studObj[b.dataset.key] = b.classList.contains('present') ? 'Present' : 'Absent');
  const payload = { date, time, description: desc, students: studObj, savedAt: Date.now() };
  if(attendanceEditKey){
    await set(ref(db, `attendance/${attendanceEditKey}`), payload);
    attendanceEditKey = null; toast('Attendance updated');
  } else {
    const p = push(ref(db,'attendance')); await set(p, payload); toast('Attendance saved');
  }
  $('attendanceMarkCard').style.display = 'none';
});

/* view/edit saved attendance */
$('attendanceSessions')?.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button'); if(!btn) return;
  const key = btn.dataset.key; const snap = await get(ref(db, `attendance/${key}`)); const s = snap.val(); if(!s) return toast('Not found','danger');
  if(btn.classList.contains('btn-view-att')){
    const abs = []; for(const id in s.students){ if(String(s.students[id]).toLowerCase() !== 'present') abs.push(`${id} — ${((CACHE.students.find(st=> st.id==id)||{}).name||'')}`); }
    if(!abs.length) return alert('No absentees — all present'); alert('Absentees:\n\n' + abs.join('\n'));
  } else if(btn.classList.contains('btn-edit-att')){
    attendanceEditKey = key; $('attDate').value = s.date||''; $('attTime').value = s.time||''; $('attDesc').value = s.description||'';
    const wrap = $('attendanceBoxes'); wrap.innerHTML = '';
    for(const id in s.students){
      const st = CACHE.students.find(x=> x.id==id) || {}; const div = document.createElement('div');
      div.className = s.students[id] === 'Present' ? 'small-box present' : 'small-box absent';
      div.dataset.key = id; div.dataset.name = st.name||''; div.textContent = id;
      div.addEventListener('click', ()=> { div.classList.toggle('present'); div.classList.toggle('absent'); showAttendanceTooltip(div, `${st.name} (${id})`); });
      wrap.appendChild(div);
    }
    $('attendanceMarkCard').style.display = 'block'; toast('Session loaded for edit');
  }
});

/* ---------- PDF exports ---------- */
$('studentsPdfBtn')?.addEventListener('click', ()=>{
  const rows = CACHE.students.map(s=> `<tr><td>${escapeHtml(s.id)}</td><td>${escapeHtml(s.name)}</td><td>${escapeHtml(s.level||'')}</td><td>${escapeHtml((CACHE.teams.find(t=> t.id==s.teamId)||{}).name||'')}</td></tr>`).join('');
  if(!rows) return toast('No students','warning');
  const html = `<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>${rows}</tbody></table>`;
  const d=document.createElement('div'); d.style.padding='12px'; d.innerHTML=`<h3>Students</h3>${html}`; document.body.appendChild(d);
  html2pdf().from(d).set({margin:0.3, filename:'students.pdf'}).save().then(()=> d.remove());
});
$('eventsPdfBtn')?.addEventListener('click', ()=>{
  const rows = CACHE.events.map(e=> `<tr><td>${escapeHtml(e.name)}</td><td>${escapeHtml(e.type)}</td><td>${escapeHtml(e.description||'')}</td></tr>`).join('');
  if(!rows) return toast('No events','warning');
  const html = `<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>${rows}</tbody></table>`; const d=document.createElement('div'); d.style.padding='12px'; d.innerHTML=`<h3>Events</h3>${html}`; document.body.appendChild(d); html2pdf().from(d).set({margin:0.3, filename:'events.pdf'}).save().then(()=> d.remove());
});

/* ---------- search debounces ---------- */
$('searchStudents')?.addEventListener('input', debounce(()=> renderStudents()));
$('searchEvents')?.addEventListener('input', debounce(()=> renderEvents()));
$('searchApprovals')?.addEventListener('input', debounce(()=> renderApprovals()));

/* ---------- initial render ---------- */
setTimeout(()=> scheduleRender(), 250);

</script>
</body>
</html>
