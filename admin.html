<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Art Fest</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#fff;
      --accent:#4f46e5;
      --muted:#6b7280;
      --success:#10b981;
      --danger:#ef4444;
    }
    body{background:var(--bg);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;}
    .container-wide{max-width:1200px;margin:28px auto;}
    .card-neo{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(16,24,40,0.06);border:0;}
    .small-muted{color:var(--muted)}
    .section-title{font-weight:700;margin-bottom:8px}
    .small-box{width:54px;height:36px;background:#eef2ff;display:inline-flex;align-items:center;justify-content:center;border-radius:6px;margin:4px;cursor:pointer;font-weight:600}
    .small-box.present{background:var(--success);color:#fff}
    .small-box.absent{background:var(--danger);color:#fff}
    .btn-accent{background:linear-gradient(90deg,var(--accent),#7c3aed);color:#fff;border:0}
    .table thead{background:#fbfbff}
    .muted{color:var(--muted)}
    @media (max-width:768px){ .container-wide{margin:12px} }
  </style>
</head>
<body>

  <nav class="navbar shadow-sm">
    <div class="container container-wide d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <span class="badge text-bg-primary rounded-pill"><i class="bi bi-palette-fill"></i></span>
        <div>
          <div style="font-weight:700">Art Fest Admin</div>
          <div class="small-muted">Realtime Dashboard</div>
        </div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <button id="openStudents" class="btn btn-outline-secondary">Students</button>
        <button id="openTeams" class="btn btn-outline-secondary">Teams</button>
        <button id="openEvents" class="btn btn-outline-secondary">Events</button>
        <button id="openAttendance" class="btn btn-outline-secondary">Attendance</button>
        <button id="openResults" class="btn btn-outline-secondary">Results</button>
        <button id="logoutBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
      </div>
    </div>
  </nav>

  <main class="container-wide">

    <!-- Top stats -->
    <div class="row g-3 my-4">
      <div class="col-md-3"><div class="card-neo text-center"><div class="small-muted">Students</div><div class="h4" id="statStudents">0</div></div></div>
      <div class="col-md-3"><div class="card-neo text-center"><div class="small-muted">Teams</div><div class="h4" id="statTeams">0</div></div></div>
      <div class="col-md-3"><div class="card-neo text-center"><div class="small-muted">Events</div><div class="h4" id="statEvents">0</div></div></div>
      <div class="col-md-3"><div class="card-neo text-center"><div class="small-muted">Pending</div><div class="h4" id="statPending">0</div></div></div>
    </div>

    <!-- Tabs container -->
    <div class="card-neo p-3 mb-4">
      <ul class="nav nav-pills mb-3" id="tabs">
        <li class="nav-item"><button class="nav-link active" data-target="panel-students">Students</button></li>
        <li class="nav-item"><button class="nav-link" data-target="panel-teams">Teams</button></li>
        <li class="nav-item"><button class="nav-link" data-target="panel-events">Events</button></li>
        <li class="nav-item"><button class="nav-link" data-target="panel-attendance">Attendance</button></li>
        <li class="nav-item"><button class="nav-link" data-target="panel-results">Results</button></li>
        <li class="nav-item"><button class="nav-link" data-target="panel-approvals">Approvals</button></li>
        <li class="nav-item"><button class="nav-link" data-target="panel-notifications">Notifications</button></li>
      </ul>

      <div id="panels">

        <!-- STUDENTS PANEL -->
        <section id="panel-students" class="panel">
          <div class="row g-3">
            <div class="col-lg-5">
              <div class="card-neo">
                <div class="section-title">Add / Import Students</div>
                <div class="small-muted mb-2">Excel file (columns accepted): Chess Number, Name, Class, Team</div>

                <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
                <div class="d-flex gap-2">
                  <button id="btnPreviewStudents" class="btn btn-outline-primary">Preview</button>
                  <button id="btnImportStudents" class="btn btn-accent">Import to Database</button>
                </div>

                <hr/>
                <div class="small-muted">Preview (first 300 rows)</div>
                <div id="studentsPreview" style="max-height:300px; overflow:auto"></div>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="card-neo">
                <div class="section-title">All Students</div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead class="table-light"><tr><th>Chess #</th><th>Name</th><th>Class</th><th>Team</th><th>Attendance</th><th class="text-end">Actions</th></tr></thead>
                    <tbody id="studentsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- TEAMS PANEL -->
        <section id="panel-teams" class="panel d-none">
          <div class="row g-3">
            <div class="col-lg-5">
              <div class="card-neo">
                <div class="section-title">Add / Edit Team</div>
                <div class="small-muted mb-2">Team password used by leader to login.</div>

                <input type="hidden" id="teamKeyHidden">
                <div class="mb-2"><label class="form-label">Team Name</label><input id="teamName" class="form-control"></div>
                <div class="mb-2"><label class="form-label">Leader (Chess #)</label><select id="teamLeader" class="form-select"><option value="">None</option></select></div>
                <div class="mb-2">
                  <label class="form-label">Password</label>
                  <div class="input-group">
                    <input id="teamPassword" class="form-control" />
                    <button id="genTeamPass" class="btn btn-outline-secondary">Generate</button>
                    <button id="copyTeamPass" class="btn btn-outline-primary">Copy</button>
                  </div>
                </div>

                <div class="d-flex gap-2">
                  <button id="saveTeam" class="btn btn-success">Save Team</button>
                  <button id="newTeam" class="btn btn-outline-secondary">New</button>
                </div>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="card-neo">
                <div class="section-title">All Teams</div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Score</th><th>Password</th><th class="text-end">Actions</th></tr></thead>
                    <tbody id="teamsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- EVENTS PANEL -->
        <section id="panel-events" class="panel d-none">
          <div class="row g-3">
            <div class="col-lg-5">
              <div class="card-neo">
                <div class="section-title">Add / Import Events</div>
                <div class="small-muted mb-2">Excel columns accepted: Name, Type, Description</div>

                <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
                <div class="d-flex gap-2">
                  <button id="btnPreviewEvents" class="btn btn-outline-primary">Preview</button>
                  <button id="btnImportEvents" class="btn btn-accent">Import Events</button>
                </div>

                <hr/>
                <div class="mb-2"><label class="form-label">Event Name</label><input id="eventName" class="form-control"></div>
                <div class="mb-2"><label class="form-label">Type</label><select id="eventType" class="form-select"><option>Stage</option><option>Non-Stage</option></select></div>
                <div class="mb-2"><label class="form-label">Description / Rules</label><textarea id="eventDescription" class="form-control" rows="4"></textarea></div>
                <div class="d-flex gap-2"><button id="saveEvent" class="btn btn-warning">Save Event</button></div>

                <div class="mt-3 small-muted">Preview (first 300 rows)</div>
                <div id="eventsPreview" style="max-height:260px; overflow:auto"></div>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="card-neo">
                <div class="section-title">All Events</div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Description</th><th>Status</th><th class="text-end">Actions</th></tr></thead>
                    <tbody id="eventsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ATTENDANCE PANEL -->
        <section id="panel-attendance" class="panel d-none">
          <div class="card-neo mb-3">
            <div class="section-title">Create Attendance Session</div>
            <div class="row g-2">
              <div class="col-md-3"><label class="form-label">Date</label><input id="attDate" type="date" class="form-control"></div>
              <div class="col-md-5"><label class="form-label">Description</label><input id="attDesc" class="form-control" placeholder="Session notes..."></div>
              <div class="col-md-2"><label class="form-label">Method</label><select id="attMethod" class="form-select"><option value="all">All Students</option><option value="team">By Team</option></select></div>
              <div class="col-md-2 d-none" id="attTeamWrap"><label class="form-label">Team</label><select id="attTeam" class="form-select"></select></div>
            </div>
            <div class="mt-3">
              <button id="btnLoadAttendance" class="btn btn-info">Load Students</button>
              <button id="btnSaveAttendance" class="btn btn-success ms-2">Save Session</button>
            </div>
          </div>

          <div class="card-neo mb-3" id="attendanceMarkCard" style="display:none;">
            <div class="section-title">Mark Attendance</div>
            <div class="small-muted mb-2">Click chess numbers to toggle: Present → Absent → None</div>
            <div id="attendanceBoxes" style="padding:10px"></div>
          </div>

          <div class="card-neo">
            <div class="section-title">Attendance Sessions</div>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead class="table-light"><tr><th>Date</th><th>Description</th><th>Student Count</th><th class="text-end">Action</th></tr></thead>
                <tbody id="attendanceSessions"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- RESULTS PANEL -->
        <section id="panel-results" class="panel d-none">
          <div class="row g-3">
            <div class="col-lg-5">
              <div class="card-neo">
                <div class="section-title">Add Result</div>
                <div class="mb-2"><label class="form-label">Event</label><select id="resultEvent" class="form-select"></select></div>
                <div class="mb-2"><label class="form-label">1st Place (Chess #)</label><input id="resFirst" class="form-control"></div>
                <div class="mb-2"><label class="form-label">Points (1st) max 100</label><input id="ptsFirst" type="number" min="0" max="100" value="100" class="form-control"></div>
                <div class="mb-2"><label class="form-label">2nd Place (Chess #)</label><input id="resSecond" class="form-control"></div>
                <div class="mb-2"><label class="form-label">Points (2nd)</label><input id="ptsSecond" type="number" min="0" max="100" value="50" class="form-control"></div>
                <div class="mb-2"><label class="form-label">3rd Place (Chess #)</label><input id="resThird" class="form-control"></div>
                <div class="mb-2"><label class="form-label">Points (3rd)</label><input id="ptsThird" type="number" min="0" max="100" value="25" class="form-control"></div>
                <div class="form-check"><input id="resPublish" class="form-check-input" type="checkbox"><label class="form-check-label">Publish now (apply team scores)</label></div>
                <div class="mt-3"><button id="btnAddResult" class="btn btn-primary">Add Result</button></div>
              </div>
            </div>

            <div class="col-lg-7">
              <div class="card-neo">
                <div class="section-title">Results</div>
                <div class="table-responsive">
                  <table class="table align-middle">
                    <thead class="table-light"><tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th><th>Published</th></tr></thead>
                    <tbody id="resultsTable"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- APPROVALS PANEL -->
        <section id="panel-approvals" class="panel d-none">
          <div class="card-neo">
            <div class="section-title">Pending Participations</div>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead class="table-light"><tr><th>Event</th><th>Team</th><th>Participant</th><th>Submitted</th><th class="text-end">Actions</th></tr></thead>
                <tbody id="pendingTable"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- NOTIFICATIONS PANEL -->
        <section id="panel-notifications" class="panel d-none">
          <div class="card-neo mb-3">
            <div class="section-title">Send Notification</div>
            <div class="row g-2">
              <div class="col-md-4"><input id="notifTitle" class="form-control" placeholder="Title"></div>
              <div class="col-md-6"><input id="notifMessage" class="form-control" placeholder="Message"></div>
              <div class="col-md-2"><button id="btnSendNotif" class="btn btn-primary w-100">Send</button></div>
            </div>
          </div>

          <div class="card-neo">
            <div class="section-title">History</div>
            <div class="table-responsive">
              <table class="table align-middle">
                <thead class="table-light"><tr><th>Title</th><th>Message</th><th>Date</th></tr></thead>
                <tbody id="notifHistory"></tbody>
              </table>
            </div>
          </div>
        </section>

      </div>
    </div>

  </main>

  <!-- Toast container -->
  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:11000"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase app script (module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // ---------- CONFIG ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const rootRef = ref(db);

    // ---------- small utilities ----------
    function showToast(msg, type='success'){
      const t = document.createElement('div');
      t.className = `toast align-items-center text-bg-${type} border-0`;
      t.setAttribute('role','alert');
      t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.getElementById('toastRoot').appendChild(t);
      const b = new bootstrap.Toast(t, { delay: 3000 });
      b.show();
      t.addEventListener('hidden.bs.toast', ()=> t.remove());
    }

    function generatePassword(){
      return 'TL-' + Math.floor(1000 + Math.random()*9000);
    }

    // ---------- UI: tab switching ----------
    document.querySelectorAll('#tabs [data-target]').forEach(btn=>{
      btn.addEventListener('click', () => {
        document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
        const id = btn.getAttribute('data-target');
        document.getElementById(id).classList.remove('d-none');
        document.querySelectorAll('#tabs .nav-link').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
      });
    });

    // top nav quick open
    document.getElementById('openStudents').addEventListener('click', ()=> document.querySelector('[data-target="panel-students"]').click());
    document.getElementById('openTeams').addEventListener('click', ()=> document.querySelector('[data-target="panel-teams"]').click());
    document.getElementById('openEvents').addEventListener('click', ()=> document.querySelector('[data-target="panel-events"]').click());
    document.getElementById('openAttendance').addEventListener('click', ()=> document.querySelector('[data-target="panel-attendance"]').click());
    document.getElementById('openResults').addEventListener('click', ()=> document.querySelector('[data-target="panel-results"]').click());
    document.getElementById('logoutBtn').addEventListener('click', ()=> { sessionStorage.removeItem('user'); location.href='index.html'; });

    // ---------- Global snapshot ----------
    let SNAP = { students:[], teams:[], events:[], participations:[], results:[], notifications:[], attendance:{} };

    onValue(rootRef, snapshot => {
      const data = snapshot.val() || {};
      SNAP.students = data.students ? Object.values(data.students) : [];
      SNAP.teams = data.teams ? Object.values(data.teams) : [];
      SNAP.events = data.events ? Object.values(data.events) : [];
      SNAP.participations = data.participations ? Object.values(data.participations) : [];
      SNAP.results = data.results ? Object.values(data.results) : [];
      SNAP.notifications = data.notifications ? Object.values(data.notifications) : [];
      SNAP.attendance = data.attendance || {};

      renderAll();
    });

    // ---------- RENDER ALL ----------
    function renderAll(){
      renderStats();
      renderStudents();
      renderTeams();
      renderEvents();
      renderAttendanceSessions();
      renderResults();
      renderPending();
      renderNotifications();
      populateDropdowns();
    }

    function renderStats(){
      document.getElementById('statStudents').textContent = SNAP.students.length;
      document.getElementById('statTeams').textContent = SNAP.teams.length;
      document.getElementById('statEvents').textContent = SNAP.events.length;
      document.getElementById('statPending').textContent = SNAP.participations.filter(p=>p.status==='Pending').length;
    }

    // ========== STUDENTS ==========
    let studentsPreview = [];
    document.getElementById('btnPreviewStudents').addEventListener('click', previewStudents);
    document.getElementById('btnImportStudents').addEventListener('click', importStudents);

    function previewStudents(){
      const f = document.getElementById('studentFile').files[0];
      if(!f) return showToast('Select Excel file','danger');
      const reader = new FileReader();
      reader.onload = (e)=>{
        const wb = XLSX.read(e.target.result, {type:'binary'});
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
        studentsPreview = json.slice(0,500);
        renderStudentsPreview();
      };
      reader.readAsBinaryString(f);
    }

    function renderStudentsPreview(){
      const wrap = document.getElementById('studentsPreview');
      if(!studentsPreview.length){ wrap.innerHTML = '<div class="muted">No preview</div>'; return; }
      let html = '<table class="table table-sm"><thead><tr><th>Chess</th><th>Name</th><th>Class</th><th>Team</th></tr></thead><tbody>';
      studentsPreview.forEach(r=>{
        const chess = r['Chess Number'] || r['Chess'] || r['chess'] || r['ID'] || r['id'] || '';
        const name = r['Name'] || r['Full Name'] || r['name'] || '';
        const cls = r['Class'] || r['class'] || '';
        const team = r['Team'] || r['team'] || '';
        html += `<tr><td>${chess}</td><td>${name}</td><td>${cls}</td><td>${team}</td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    async function importStudents(){
      if(!studentsPreview.length) return showToast('No preview to import','danger');
      const teamMap = {};
      SNAP.teams.forEach(t => { if(t.name) teamMap[t.name.trim().toLowerCase()] = t.id; });
      const updates = {};
      studentsPreview.forEach(r=>{
        const chess = r['Chess Number'] || r['Chess'] || r['chess'] || r['ID'] || r['id'];
        const name = r['Name'] || r['Full Name'] || r['name'] || '';
        const cls = r['Class'] || r['class'] || '';
        const teamName = r['Team'] || r['team'] || '';
        if(!chess || !name) return;
        const id = Number(chess);
        const teamId = teamName ? teamMap[String(teamName).trim().toLowerCase()] || null : null;
        updates[`students/${id}`] = { id, name: String(name).trim(), class: String(cls).trim(), teamId: teamId, attendance: { status:'Absent', timestamp:null } };
      });
      if(Object.keys(updates).length){
        await update(rootRef, updates);
        showToast('Students imported');
        studentsPreview = [];
        document.getElementById('studentsPreview').innerHTML = '';
        document.getElementById('studentFile').value = '';
      } else showToast('No valid rows','danger');
    }

    function renderStudents(){
      const tbody = document.getElementById('studentsTable');
      if(!SNAP.students.length){ tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No students</td></tr>'; return; }
      SNAP.students.sort((a,b)=>(a.id||0)-(b.id||0));
      let html = '';
      SNAP.students.forEach(s=>{
        const team = SNAP.teams.find(t => String(t.id) === String(s.teamId));
        const att = s.attendance?.status || 'Absent';
        const ts = s.attendance?.timestamp ? new Date(s.attendance.timestamp).toLocaleString() : '';
        html += `<tr data-id="${s.id}"><td>${s.id}</td><td>${s.name||''}</td><td>${s.class||''}</td><td>${team?team.name:'Unassigned'}</td><td><div class="small-muted">${att}</div><div class="small-muted">${ts}</div></td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete">Delete</button></td></tr>`;
      });
      tbody.innerHTML = html;
    }

    // student actions
    document.getElementById('studentsTable').addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return; const id = tr.dataset.id;
      if(e.target.classList.contains('btn-delete')){
        if(!confirm('Delete student?')) return;
        await remove(ref(db, `students/${id}`));
        showToast('Student deleted');
      } else if(e.target.classList.contains('btn-edit')){
        const snap = await get(ref(db, `students/${id}`)); const s = snap.val();
        if(!s) return showToast('Not found','danger');
        // quick inline edit: change name
        const newName = prompt('Edit name', s.name) || s.name;
        await update(ref(db, `students/${id}`), { name: newName });
        showToast('Student updated');
      }
    });

    // ========== TEAMS ==========
    document.getElementById('genTeamPass').addEventListener('click', ()=> document.getElementById('teamPassword').value = generatePassword());
    document.getElementById('copyTeamPass').addEventListener('click', ()=> {
      const v = document.getElementById('teamPassword').value || '';
      if(!v) return showToast('No password','danger');
      navigator.clipboard.writeText(v).then(()=> showToast('Password copied'));
    });
    document.getElementById('saveTeam').addEventListener('click', saveTeam);
    document.getElementById('newTeam').addEventListener('click', ()=> {
      document.getElementById('teamKeyHidden').value = '';
      document.getElementById('teamName').value = '';
      document.getElementById('teamLeader').value = '';
      document.getElementById('teamPassword').value = generatePassword();
    });

    async function saveTeam(){
      const key = document.getElementById('teamKeyHidden').value;
      const name = document.getElementById('teamName').value.trim();
      const leaderId = document.getElementById('teamLeader').value || null;
      let pwd = document.getElementById('teamPassword').value || generatePassword();
      if(!name) return showToast('Provide team name','danger');
      if(key){
        // find DB key by id
        const rootSnap = await get(rootRef);
        const rootObj = rootSnap.val() || {};
        const teamsObj = rootObj.teams || {};
        let found = null;
        for(const k in teamsObj){ if(String(teamsObj[k].id) === String(key)){ found = k; break; } }
        if(!found) return showToast('Team key not found','danger');
        await update(ref(db, `teams/${found}`), { name, leaderId: leaderId?Number(leaderId):null, password: pwd });
        showToast('Team updated');
      } else {
        const nref = push(ref(db, 'teams'));
        const numericId = Date.now();
        await set(nref, { id: numericId, name, leaderId: leaderId?Number(leaderId):null, score: 0, password: pwd });
        showToast('Team created');
      }
      // clear form
      document.getElementById('teamKeyHidden').value=''; document.getElementById('teamName').value=''; document.getElementById('teamLeader').value=''; document.getElementById('teamPassword').value='';
    }

    function renderTeams(){
      const tbody = document.getElementById('teamsTable');
      if(!SNAP.teams.length){ tbody.innerHTML = '<tr><td colspan="6" class="text-center muted">No teams</td></tr>'; return; }
      SNAP.teams.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      let html = '';
      SNAP.teams.forEach(t=>{
        const leader = SNAP.students.find(s=>String(s.id)===String(t.leaderId));
        const members = SNAP.students.filter(s=>String(s.teamId)===String(t.id)).length;
        const pwd = t.password || '';
        html += `<tr data-id="${t.id}"><td><strong>${t.name}</strong></td><td>${leader?leader.name+' ('+leader.id+')':'-'}</td><td>${members}</td><td>${t.score||0}</td><td><input class="form-control form-control-sm team-pwd" data-id="${t.id}" value="${pwd}"></td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-team">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-team">Delete</button></td></tr>`;
      });
      tbody.innerHTML = html;

      // attach change handler for password inputs
      document.querySelectorAll('.team-pwd').forEach(inp=>{
        inp.addEventListener('change', async (e)=>{
          const tid = e.target.dataset.id; const val = e.target.value;
          // find key for team
          const rootSnap = await get(rootRef); const rootObj = rootSnap.val() || {}; const teamsObj = rootObj.teams || {};
          let found = null;
          for(const k in teamsObj){ if(String(teamsObj[k].id) === String(tid)){ found = k; break; } }
          if(found) { await update(ref(db, `teams/${found}`), { password: val }); showToast('Password updated'); }
        });
      });
    }

    document.getElementById('teamsTable').addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return; const tid = tr.dataset.id;
      if(e.target.classList.contains('btn-delete-team')){
        if(!confirm('Delete team? Students will be unassigned.')) return;
        // find key
        const rootSnap = await get(rootRef); const rootObj = rootSnap.val() || {}; const teamsObj = rootObj.teams || {};
        let found = null;
        for(const k in teamsObj){ if(String(teamsObj[k].id) === String(tid)){ found = k; break; } }
        if(!found) return showToast('Team key not found','danger');
        await remove(ref(db, `teams/${found}`));
        // unassign students
        const updates = {};
        SNAP.students.filter(s=>String(s.teamId)===String(tid)).forEach(s => updates[`students/${s.id}/teamId`] = null);
        if(Object.keys(updates).length) await update(rootRef, updates);
        showToast('Team deleted');
      } else if(e.target.classList.contains('btn-edit-team')){
        const t = SNAP.teams.find(x=>String(x.id)===String(tid));
        if(!t) return showToast('Team not found','danger');
        // populate form
        document.getElementById('teamKeyHidden').value = t.id;
        document.getElementById('teamName').value = t.name || '';
        document.getElementById('teamLeader').value = t.leaderId || '';
        document.getElementById('teamPassword').value = t.password || '';
        document.querySelector('[data-target="panel-teams"]').click();
      }
    });

    // ========== EVENTS ==========
    let eventsPreview = [];
    document.getElementById('btnPreviewEvents').addEventListener('click', previewEvents);
    document.getElementById('btnImportEvents').addEventListener('click', importEvents);
    document.getElementById('saveEvent').addEventListener('click', saveEvent);

    function previewEvents(){
      const f = document.getElementById('eventFile').files[0]; if(!f) return showToast('Select file','danger');
      const reader = new FileReader();
      reader.onload = e => {
        const wb = XLSX.read(e.target.result,{type:'binary'});
        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
        eventsPreview = json.slice(0,500);
        renderEventsPreview();
      };
      reader.readAsBinaryString(f);
    }

    function renderEventsPreview(){
      const wrap = document.getElementById('eventsPreview');
      if(!eventsPreview.length){ wrap.innerHTML = '<div class="muted">No preview</div>'; return; }
      let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>';
      eventsPreview.forEach(r=>{
        const name = r['Name'] || r['Event'] || r['name'] || '';
        const type = r['Type'] || r['type'] || '';
        const desc = r['Description'] || r['Desc'] || r['description'] || '';
        html += `<tr><td>${name}</td><td>${type}</td><td>${desc}</td></tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    async function importEvents(){
      if(!eventsPreview.length) return showToast('No preview','danger');
      const updates = {};
      for(const r of eventsPreview){
        const name = r['Name'] || r['Event'] || r['name'] || ''; if(!name) continue;
        const type = r['Type'] || r['type'] || 'Non-Stage';
        const desc = r['Description'] || r['description'] || '';
        const id = Date.now() + Math.floor(Math.random()*9999);
        updates[`events/${id}`] = { id, name: String(name).trim(), type: String(type).trim(), description: String(desc).trim(), status: 'Open' };
      }
      if(Object.keys(updates).length){ await update(rootRef, updates); showToast('Events imported'); eventsPreview = []; document.getElementById('eventsPreview').innerHTML=''; document.getElementById('eventFile').value=''; }
      else showToast('No valid rows','danger');
    }

    async function saveEvent(){
      const name = document.getElementById('eventName').value.trim();
      const type = document.getElementById('eventType').value;
      const desc = document.getElementById('eventDescription').value.trim();
      if(!name) return showToast('Provide event name','danger');
      const id = Date.now();
      await set(ref(db, `events/${id}`), { id, name, type, description: desc, status: 'Open' });
      document.getElementById('eventName').value=''; document.getElementById('eventDescription').value='';
      showToast('Event saved');
    }

    function renderEvents(){
      const body = document.getElementById('eventsTable');
      if(!SNAP.events.length){ body.innerHTML = '<tr><td colspan="5" class="text-center muted">No events</td></tr>'; return; }
      SNAP.events.sort((a,b)=>(a.name||'').localeCompare(b.name||''));
      let html = '';
      SNAP.events.forEach(e=>{
        const desc = e.description ? (e.description.length>120? e.description.slice(0,120)+'...' : e.description) : '';
        html += `<tr data-id="${e.id}"><td>${e.name}</td><td>${e.type}</td><td>${desc}</td><td><span class="small-muted">${e.status||'Open'}</span></td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-edit-event">Edit</button> <button class="btn btn-sm btn-outline-danger btn-delete-event">Delete</button></td></tr>`;
      });
      body.innerHTML = html;
    }

    document.getElementById('eventsTable').addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return; const id = tr.dataset.id;
      if(e.target.classList.contains('btn-delete-event')){
        if(!confirm('Delete event?')) return;
        await remove(ref(db, `events/${id}`));
        // remove participations for that event
        const rootSnap = await get(rootRef); const rootObj = rootSnap.val() || {}; const parts = rootObj.participations || {};
        const updates = {}; for(const k in parts) if(parts[k].eventId === Number(id)) updates[`participations/${k}`] = null;
        if(Object.keys(updates).length) await update(rootRef, updates);
        showToast('Event deleted');
      } else if(e.target.classList.contains('btn-edit-event')){
        const evSnap = await get(ref(rootRef, `events/${id}`)); const ev = evSnap.val();
        if(!ev) return showToast('Event not found','danger');
        document.querySelector('[data-target="panel-events"]').click();
        document.getElementById('eventName').value = ev.name || '';
        document.getElementById('eventType').value = ev.type || 'Non-Stage';
        document.getElementById('eventDescription').value = ev.description || '';
      }
    });

    // ========== ATTENDANCE ==========
    document.getElementById('attMethod').addEventListener('change', ()=>{
      document.getElementById('attTeamWrap').classList.toggle('d-none', document.getElementById('attMethod').value !== 'team');
    });
    document.getElementById('btnLoadAttendance').addEventListener('click', loadAttendance);
    document.getElementById('btnSaveAttendance').addEventListener('click', saveAttendance);

    function loadAttendance(){
      const method = document.getElementById('attMethod').value;
      const teamId = document.getElementById('attTeam').value;
      let list = [];
      if(method === 'all') list = SNAP.students.slice();
      else list = SNAP.students.filter(s => String(s.teamId) === String(teamId));
      const wrap = document.getElementById('attendanceBoxes');
      let html = '';
      list.forEach(s => {
        html += `<div class="small-box" data-id="${s.id}" onclick="toggleBox(this)">${s.id}</div>`;
      });
      wrap.innerHTML = html;
      document.getElementById('attendanceMarkCard').style.display = list.length ? 'block' : 'none';
    }

    window.toggleBox = function(el){
      if(el.classList.contains('present')){ el.classList.remove('present'); el.classList.add('absent'); }
      else if(el.classList.contains('absent')){ el.classList.remove('absent'); }
      else el.classList.add('present');
    };

    async function saveAttendance(){
      const date = document.getElementById('attDate').value;
      if(!date) return showToast('Select date','danger');
      const desc = document.getElementById('attDesc').value || '';
      const boxes = Array.from(document.querySelectorAll('#attendanceBoxes .small-box'));
      const record = { description: desc, date, students: {} };
      boxes.forEach(b => {
        const id = b.dataset.id;
        if(b.classList.contains('present')) record.students[String(id)] = 'Present';
        else if(b.classList.contains('absent')) record.students[String(id)] = 'Absent';
        else record.students[String(id)] = 'Absent';
      });
      // write session
      await set(ref(db, `attendance/${date}`), record);
      // update student attendance meta
      const updates = {};
      for(const sid in record.students) updates[`students/${sid}/attendance`] = { status: record.students[sid], timestamp: Date.now(), date };
      if(Object.keys(updates).length) await update(rootRef, updates);
      showToast('Attendance saved');
      document.getElementById('attendanceMarkCard').style.display = 'none';
    }

    function renderAttendanceSessions(){
      const wrap = document.getElementById('attendanceSessions');
      const att = SNAP.attendance || {};
      const keys = Object.keys(att).sort((a,b)=> b.localeCompare(a));
      if(!keys.length){ wrap.innerHTML = '<tr><td colspan="4" class="text-center muted">No sessions</td></tr>'; return; }
      let html = '';
      keys.forEach(k => {
        const r = att[k];
        const count = r.students ? Object.keys(r.students).length : 0;
        html += `<tr><td>${k}</td><td>${r.description || ''}</td><td>${count}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary" onclick="viewAttendance('${k}')">View</button></td></tr>`;
      });
      wrap.innerHTML = html;
    }

    window.viewAttendance = async function(date){
      const snap = await get(ref(db, `attendance/${date}`)); const r = snap.val();
      if(!r) return showToast('Not found','danger');
      let txt = `Attendance - ${date}\n${r.description || ''}\n\n`;
      if(r.students) for(const s in r.students) txt += `${s}: ${r.students[s]}\n`;
      alert(txt);
    };

    // ========== RESULTS ==========
    document.getElementById('btnAddResult').addEventListener('click', addResult);

    async function addResult(){
      const evId = document.getElementById('resultEvent').value;
      if(!evId) return showToast('Select event','danger');
      const r1 = document.getElementById('resFirst').value.trim() || 'none';
      const r2 = document.getElementById('resSecond').value.trim() || 'none';
      const r3 = document.getElementById('resThird').value.trim() || 'none';
      const p1 = Number(document.getElementById('ptsFirst').value) || 0;
      const p2 = Number(document.getElementById('ptsSecond').value) || 0;
      const p3 = Number(document.getElementById('ptsThird').value) || 0;
      const publish = document.getElementById('resPublish').checked;

      const rref = push(ref(db, 'results'));
      const obj = { id: Date.now(), eventId: Number(evId), first: r1, second: r2, third: r3, pFirst: p1, pSecond: p2, pThird: p3, published: publish, publishedAt: publish?Date.now():null };
      await set(rref, obj);

      if(publish){
        // update team scores
        const rootSnap = await get(rootRef); const rootObj = rootSnap.val() || {};
        const teamsObj = rootObj.teams || {}; const studentsObj = rootObj.students || {};
        const updates = {};
        const addPoints = (studentId, pts) => {
          if(!studentId || studentId === 'none') return;
          const s = studentsObj[String(studentId)];
          if(!s || !s.teamId) return;
          for(const k in teamsObj){ if(String(teamsObj[k].id) === String(s.teamId)){ updates[`teams/${k}/score`] = (teamsObj[k].score||0) + Number(pts||0); break; } }
        };
        addPoints(r1, p1); addPoints(r2, p2); addPoints(r3, p3);
        if(Object.keys(updates).length) await update(rootRef, updates);
        // mark event completed
        const eventsObj = rootObj.events || {};
        for(const k in eventsObj) if(String(eventsObj[k].id) === String(evId)){ await update(ref(db, `events/${k}`), { status: 'Completed' }); break; }
        showToast('Result published and scores updated');
      } else showToast('Result saved (draft)');

      // clear inputs
      document.getElementById('resFirst').value=''; document.getElementById('resSecond').value=''; document.getElementById('resThird').value='';
    }

    function renderResults(){
      const tbody = document.getElementById('resultsTable');
      if(!SNAP.results.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No results</td></tr>'; return; }
      let html = '';
      SNAP.results.forEach(r => {
        const ev = SNAP.events.find(e => String(e.id) === String(r.eventId));
        html += `<tr><td>${ev?ev.name:'Unknown'}</td><td>${r.first} (${r.pFirst||0})</td><td>${r.second} (${r.pSecond||0})</td><td>${r.third} (${r.pThird||0})</td><td>${r.published?new Date(r.publishedAt).toLocaleString():'No'}</td></tr>`;
      });
      tbody.innerHTML = html;
    }

    // ========== PARTICIPATIONS (approvals) ==========
    function renderPending(){
      const tbody = document.getElementById('pendingTable');
      const pending = SNAP.participations.filter(p => p.status === 'Pending');
      if(!pending.length){ tbody.innerHTML = '<tr><td colspan="5" class="text-center muted">No pending</td></tr>'; return; }
      let html = '';
      pending.forEach(p => {
        const ev = SNAP.events.find(e => String(e.id) === String(p.eventId));
        const team = SNAP.teams.find(t => String(t.id) === String(p.teamId));
        const stu = SNAP.students.find(s => String(s.id) === String(p.studentId));
        html += `<tr data-id="${p.id}"><td>${ev?ev.name:'-'}</td><td>${team?team.name:'-'}</td><td>${stu?stu.name+' ('+stu.id+')':'-'}</td><td>${new Date(p.submittedAt).toLocaleString()}</td><td class="text-end"><button class="btn btn-sm btn-success btn-approve">Approve</button> <button class="btn btn-sm btn-danger btn-reject">Reject</button></td></tr>`;
      });
      tbody.innerHTML = html;
    }

    document.getElementById('pendingTable').addEventListener('click', async (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return; const pid = tr.dataset.id;
      const rootSnap = await get(rootRef); const rootObj = rootSnap.val() || {}; const parts = rootObj.participations || {};
      let foundKey = null;
      for(const k in parts) if(String(parts[k].id) === String(pid)){ foundKey = k; break; }
      if(!foundKey) return showToast('Not found','danger');

      if(e.target.classList.contains('btn-approve')){
        await update(ref(db, `participations/${foundKey}`), { status: 'Approved', approvedAt: Date.now() });
        showToast('Approved');
      } else if(e.target.classList.contains('btn-reject')){
        await update(ref(db, `participations/${foundKey}`), { status: 'Rejected', rejectedAt: Date.now() });
        showToast('Rejected');
      }
    });

    // ========== NOTIFICATIONS ==========
    document.getElementById('btnSendNotif').addEventListener('click', async ()=>{
      const title = document.getElementById('notifTitle').value.trim();
      const msg = document.getElementById('notifMessage').value.trim();
      if(!title || !msg) return showToast('Provide title & message','danger');
      const nref = push(ref(db, 'notifications'));
      await set(nref, { id: Date.now(), title, message: msg, to: 'All', date: Date.now() });
      document.getElementById('notifTitle').value=''; document.getElementById('notifMessage').value='';
      showToast('Notification sent');
    });

    function renderNotifications(){
      const tbody = document.getElementById('notifHistory');
      if(!SNAP.notifications.length){ tbody.innerHTML = '<tr><td colspan="3" class="text-center muted">No notifications</td></tr>'; return; }
      let html = '';
      [...SNAP.notifications].reverse().forEach(n => html += `<tr><td>${n.title}</td><td>${n.message}</td><td>${new Date(n.date).toLocaleString()}</td></tr>`);
      tbody.innerHTML = html;
    }

    // ========== POPULATE DROPDOWNS ==========
    function populateDropdowns(){
      // team dropdown for attendance
      const tsel = document.getElementById('attTeam'); tsel.innerHTML = '<option value="">Select team</option>';
      SNAP.teams.forEach(t => tsel.innerHTML += `<option value="${t.id}">${t.name}</option>`);

      // result event dropdown
      const re = document.getElementById('resultEvent'); re.innerHTML = '<option value="">Select event</option>';
      SNAP.events.forEach(e => re.innerHTML += `<option value="${e.id}">${e.name}</option>`);

      // team leader select
      const tl = document.getElementById('teamLeader'); tl.innerHTML = '<option value="">None</option>';
      SNAP.students.forEach(s => tl.innerHTML += `<option value="${s.id}">${s.name} (${s.id})</option>`);
    }

    // central render wrappers
    function renderTeamsTable(){ renderTeams(); } // backward-compatible call
    function renderEventsTable(){ renderEvents(); }
    function renderResultsTable(){ renderResults(); }
    function renderNotificationsTable(){ renderNotifications(); }

    // call first render (onValue will call again)
    setTimeout(()=> renderAll(), 400);

  </script>
</body>
</html>
