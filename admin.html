<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin â€” Fidak Fest (Final v4)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* -------------------------------------- */
    /* ADMIN PANEL DARK THEME */
    /* -------------------------------------- */
    :root{
      --bg: #0d121c; --card: #1c2738; --text: #e2e8f0; --muted: #94a3b8;
      --border: #334155; /* New: Define border color */
      --input-bg: #334155; /* New: Define input background */
      --accent-main: #f97316; --accent-secondary: #3b82f6;
      --success: #10b981; --danger: #ef4444; --warning: #facc15;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;color:var(--text);background:var(--bg)}
    
    /* UI FIX: FIX SIDEBAR */
    .app-wrap{display:flex;min-height:100vh;align-items:stretch}
    
    .sidebar{
        width:68px; 
        background:var(--card); 
        border-right:1px solid var(--border); 
        display:flex;
        flex-direction:column;
        align-items:center;
        padding:12px 6px; 
        z-index: 1000;
        /* UI FIX: Fixed positioning */
        position: fixed; 
        top: 0; 
        bottom: 0;
        height: 100vh;
    }
    .sidebar .icon-btn{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;margin:8px 0;color:var(--muted);cursor:pointer; transition: background 0.2s;}
    .sidebar .icon-btn:hover:not(.active) { background: var(--border); color: var(--text); }
    .sidebar .icon-btn.active{background:var(--accent-secondary);color:#fff}
    .sidebar .brand{margin-bottom:6px;font-weight:800;color:var(--accent-main)}
    
    /* UI FIX: Main content needs margin for fixed sidebar */
    .main-area{flex:1;padding:16px 20px;overflow:auto; margin-left: 68px;}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;}
    .topbar h3{color:var(--accent-main);}
    
    /* Components */
    .card-neo{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,0.3);margin-bottom:14px;border:1px solid var(--border);}
    .section-title{font-weight:700;margin-bottom:12px;color:var(--text);font-size:1.1rem;}
    .muted{color:var(--muted)}
    .form-control, .form-select{background:var(--input-bg);color:var(--text);border:1px solid #475569;}
    .form-control::placeholder{color:var(--muted);}
    
    /* Tables */
    .table{--bs-table-bg: var(--card); --bs-table-color: var(--text);}
    table.table td, table.table th{vertical-align:middle; border-color: var(--border);}
    .table-light{background-color:var(--input-bg) !important;}
    .participated-row{background:rgba(59, 130, 246, 0.1) !important;} 
    
    /* Dashboard Scores */
    .score-card {text-align: center; padding: 20px;}
    .score-value {font-size: 2.5rem; font-weight: 800; margin-top: 5px; color: var(--accent-secondary);}

    /* Small Boxes (Program Management) */
    .small-box{width:80px;height:50px;border-radius:8px;background:var(--input-bg);color:var(--text);display:inline-flex;flex-direction:column;align-items:center;justify-content:center;margin:6px;cursor:pointer;font-weight:700;padding:2px;position:relative;border:1px solid #475569;}
    .small-box.present{background:var(--success);color:#fff;border-color:var(--success);}
    .small-box.absent{background:var(--danger);color:#fff;border-color:var(--danger);}
    .small-box-id{font-size:10px;font-weight:400;color:rgba(255,255,255,0.8);}
    .small-box-code{position:absolute;top:-8px;right:-8px;background:var(--warning);color:#000;font-size:11px;padding:2px 6px;border-radius:10px;font-weight:bold;box-shadow:0 2px 4px rgba(0,0,0,0.5);}

    /* Modals */
    .modal-content{background:var(--card);color:var(--text);}
    .modal-header{border-bottom-color: var(--border);}
    .modal-footer{border-top-color: var(--border);}
    .btn-close{filter: invert(1) grayscale(100%) brightness(200%);}
    .btn-accent{background:var(--accent-main);color:#fff;border:0}
    .btn-accent:hover{background:#ea580c;color:#fff}
  </style>
</head>
<body>
<div class="app-wrap">
  <aside class="sidebar">
    <div class="brand"><i class="bi bi-palette-fill" style="font-size:20px"></i></div>
    <div class="icon-btn active" data-target="#panel-overview" title="Dashboard"><i class="bi bi-columns-gap" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-student-details" title="Student Search"><i class="bi bi-search" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-students" title="Students"><i class="bi bi-people-fill" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-teams" title="Teams"><i class="bi bi-people" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-events" title="Events"><i class="bi bi-calendar-event" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-attendance" title="Gen Attendance"><i class="bi bi-list-check" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-approvals" title="Approvals"><i class="bi bi-check2-square" style="font-size:18px"></i></div>
    <div class="icon-btn" data-target="#panel-results" title="Results"><i class="bi bi-trophy" style="font-size:18px"></i></div>
    <div style="flex:1"></div>
    <div class="icon-btn" id="logoutBtn" title="Logout"><i class="bi bi-box-arrow-right" style="font-size:18px"></i></div>
  </aside>

  <main class="main-area">
    <div class="topbar">
      <div>
        <h3 style="margin:0">Admin Dashboard</h3>
        <div class="muted">Fidak Fest Management System</div>
      </div>
      <div>
        <span class="badge bg-secondary">Admin</span>
      </div>
    </div>

    <div id="panels">
      <section id="panel-overview" class="card-neo">
        <div class="section-title">Live Overview</div>
        <div class="row g-3">
            <div class="col-lg-6">
                <div class="card-neo">
                    <div class="section-title">Team Score Leaderboard</div>
                    <div class="table-responsive" style="max-height: 250px; overflow: auto;">
                        <table class="table align-middle">
                            <thead class="table-light"><tr><th>Rank</th><th>Team</th><th>Score</th></tr></thead>
                            <tbody id="leaderboardTable">
                                <tr><td colspan="3" class="text-center muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Total Teams</div>
                            <div id="totalTeamsCount" class="score-value">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Total Students</div>
                            <div id="totalStudentsCount" class="score-value">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Pending Approvals</div>
                            <div id="pendingApprovalsCount" class="score-value" style="color:var(--danger)">0</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-neo score-card">
                            <div class="muted">Draft Results</div>
                            <div id="draftResultsCount" class="score-value" style="color:var(--warning)">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
      </section>
      
      <section id="panel-student-details" class="card-neo d-none">
        <div class="section-title">Student Details Lookup</div>
        <input id="studentLookupSearch" class="form-control mb-3" placeholder="Search Student Name or Chess ID (e.g., S101 or Ali)">
        <div id="studentLookupDetails">
          <div class="card-neo">
            <div class="row">
                <div class="col-md-6">
                    <h5 id="studentLookupName" class="text-info">No Student Selected</h5>
                    <p class="mb-1"><strong>ID:</strong> <span id="studentLookupID">-</span></p>
                    <p class="mb-1"><strong>Level:</strong> <span id="studentLookupLevel">-</span></p>
                    <p class="mb-1"><strong>Team:</strong> <span id="studentLookupTeam">-</span></p>
                </div>
                <div class="col-md-6">
                    <h5 class="text-secondary">Participation History</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light"><tr><th>Event</th><th>Status</th></tr></thead>
                            <tbody id="studentParticipationTable"><tr><td colspan="2" class="muted">Search above to load details.</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-students" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title">Import / Add Student</div>
              <div class="muted small mb-1">Columns: Chess, Name, Level, Team</div>
              <input id="studentFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2 mb-3">
                <button id="previewStudents" class="btn btn-outline-primary btn-sm">Preview</button>
                <button id="importStudents" class="btn btn-accent btn-sm">Import</button>
              </div>
              <hr style="border-top:1px solid var(--border)">
              <input id="manualChess" class="form-control mb-2" placeholder="Chess ID">
              <input id="manualName" class="form-control mb-2" placeholder="Full Name">
              <select id="manualLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select>
              <select id="manualTeam" class="form-select mb-2"><option value="">Unassigned</option></select>
              <button id="addManualStudent" class="btn btn-success w-100 btn-sm">Add Student</button>
              <div id="studentsPreview" class="mt-2" style="max-height:150px;overflow:auto"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between mb-2">
                <div class="section-title">All Students</div>
                <input id="searchStudents" class="form-control form-control-sm w-50" placeholder="Search...">
              </div>
              <div class="table-responsive" style="max-height:600px;overflow:auto">
                <table class="table table-sm align-middle">
                  <thead class="table-light"><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th><th>Act</th></tr></thead>
                  <tbody id="studentsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-teams" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title">Create Team</div>
              <input id="teamName" class="form-control mb-2" placeholder="Team Name">
              <select id="teamLeader" class="form-select mb-2"><option value="">Leader</option></select>
              <input id="teamPassword" class="form-control mb-2" placeholder="Password">
              <button id="saveTeam" class="btn btn-success w-100">Save Team</button>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card-neo">
              <div class="section-title">Teams List</div>
              <table class="table align-middle">
                <thead class="table-light"><tr><th>Team</th><th>Leader</th><th>Members</th><th>Score</th><th>Act</th></tr></thead>
                <tbody id="teamsTable"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-events" class="card-neo d-none">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="card-neo">
              <div class="section-title">Add / Import Events</div>
              <input id="eventName" class="form-control mb-2" placeholder="Event Name">
              <select id="eventType" class="form-select mb-2"><option>Stage</option><option>Non-Stage</option><option>Group</option><option>Open</option></select>
              <select id="eventLevel" class="form-select mb-2"><option>Junior</option><option>Senior</option><option>General</option></select>
              <button id="saveEvent" class="btn btn-accent w-100 mb-3">Add Event</button>
              <hr style="border-top:1px solid var(--border)">
              <div class="muted small mb-1">Columns: Name, Type, Level</div>
              <input id="eventFile" type="file" accept=".xlsx,.xls" class="form-control mb-2">
              <div class="d-flex gap-2"><button id="previewEvents" class="btn btn-outline-primary btn-sm">Preview</button><button id="importEvents" class="btn btn-accent btn-sm">Import</button></div>
              <div id="eventsPreview" class="mt-2" style="max-height:150px;overflow:auto"></div>
            </div>
          </div>
          <div class="col-lg-8">
            <div class="card-neo">
              <div class="d-flex justify-content-between mb-2">
                <div class="section-title">Events List</div>
                <input id="filterEventSearch" class="form-control form-control-sm w-50" placeholder="Search events...">
              </div>
              <div class="table-responsive" style="max-height:600px;overflow:auto">
                <table class="table table-sm align-middle">
                  <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Level</th><th>Act</th></tr></thead>
                  <tbody id="eventsTable"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel-attendance" class="card-neo d-none">
        <div class="card-neo mb-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-3"><input id="attDate" type="date" class="form-control"></div>
            <div class="col-md-3"><select id="attMethod" class="form-select"><option value="all">All Students</option><option value="team">By Team</option></select></div>
            <div class="col-md-3 d-none" id="attTeamWrap"><select id="attTeam" class="form-select"></select></div>
            <div class="col-md-3"><button id="loadAttendance" class="btn btn-primary w-100">Load</button></div>
          </div>
        </div>
        <div id="attendanceMarkCard" class="card-neo" style="display:none">
          <div class="d-flex justify-content-between mb-2">
             <div class="section-title">Mark Attendance</div>
             <div class="d-flex gap-2"><button id="toggleAll" class="btn btn-outline-secondary btn-sm">Toggle All</button><button id="saveAttendance" class="btn btn-success btn-sm">Save Session</button></div>
          </div>
          <div id="attendanceBoxes" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="card-neo mt-3">
          <div class="section-title">History</div>
          <table class="table table-sm"><thead class="table-light"><tr><th>Date</th><th>Count</th><th>Saved At</th><th>Act</th></tr></thead><tbody id="attendanceSessions"></tbody></table>
        </div>
      </section>

      <section id="panel-approvals" class="card-neo d-none">
        <div class="d-flex justify-content-between mb-2">
          <div class="section-title">Participation Approvals & Program Management</div>
          <div class="d-flex gap-2">
            <input id="searchApprovals" class="form-control form-control-sm" placeholder="Search...">
            <button id="downloadApprovalsPdf" class="btn btn-outline-secondary btn-sm"><i class="bi bi-file-earmark-pdf"></i> Approved Roster</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead><tr><th>Event</th><th>Category</th><th>Pending</th><th>Approved</th><th>Act</th></tr></thead>
            <tbody id="approvalsTable"></tbody>
          </table>
        </div>
      </section>

      <section id="panel-results" class="card-neo d-none">
        <div class="card-neo mb-3">
          <div class="section-title">Enter Results</div>
          <div class="row g-2">
            <div class="col-md-3"><select id="resultEvent" class="form-select"><option value="">Select Event</option></select></div>
            <div class="col-md-3">
              <label class="form-label mb-1 small text-info">1st Place</label>
              <select id="resultSelectFirst" class="form-select mb-1"></select>
              <input id="resultPointsFirst" type="number" class="form-control form-control-sm" placeholder="Points">
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1 small text-info">2nd Place</label>
              <select id="resultSelectSecond" class="form-select mb-1"></select>
              <input id="resultPointsSecond" type="number" class="form-control form-control-sm" placeholder="Points">
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1 small text-info">3rd Place</label>
              <select id="resultSelectThird" class="form-select mb-1"></select>
              <input id="resultPointsThird" type="number" class="form-control form-control-sm" placeholder="Points">
            </div>
          </div>
          <div class="mt-3 text-end">
            <button id="saveResult" class="btn btn-warning">Save Draft</button>
            <button id="publishAllResults" class="btn btn-success">Publish & Add Points</button>
          </div>
        </div>
        <div class="card-neo">
          <div class="section-title">All Events & Results</div>
          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light"><tr><th>Event</th><th>Type</th><th>1st (Pts)</th><th>2nd (Pts)</th><th>3rd (Pts)</th><th>Total Pts</th><th>Status</th></tr></thead>
              <tbody id="resultsTable"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="panel-programs" class="card-neo d-none"></section>

    </div> 
  </main>
</div>

<div class="modal fade" id="editStudentModal" tabindex="-1"><div class="modal-dialog"><form id="editStudentForm" class="modal-content"><div class="modal-header"><h5>Edit Student</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="editStudentDbKey"><input id="editChess" class="form-control mb-2" readonly><input id="editName" class="form-control mb-2"><select id="editLevel" class="form-select mb-2"><option>Senior</option><option>Junior</option></select><select id="editTeam" class="form-select mb-2"></select></div><div class="modal-footer"><button type="button" id="deleteStudentBtn" class="btn btn-danger">Delete</button><button type="submit" class="btn btn-primary">Save</button></div></form></div></div>

<div class="modal fade" id="approvalsDetailModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 id="approvalModalTitle">Participants</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><h6 class="text-warning">Pending</h6><table class="table table-sm"><tbody id="pendingParticipantsTable"></tbody></table><h6 class="text-success mt-3">Approved</h6><table class="table table-sm"><tbody id="approvedParticipantsTable"></tbody></table></div></div></div></div>

<div class="modal fade" id="programDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="programModalTitle">Manage Program</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="alert alert-info py-2" style="background:#1c2738; border:1px solid #3b82f6; color:#e2e8f0; font-size:0.9rem;">
          <i class="bi bi-info-circle"></i> <strong>Scratch Card Codes:</strong> Use the "Assign Codes" button to generate a unique code letter for each participant (for use with scratch cards). Click a box to toggle attendance.
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="section-title mb-0">Participants</div>
          <div class="d-flex gap-2">
            <button id="assignRandomLetters" class="btn btn-warning"><i class="bi bi-shuffle"></i> Assign Codes</button>
            <button id="saveProgramData" class="btn btn-success"><i class="bi bi-save"></i> Save Data</button>
          </div>
        </div>
        <div id="programParticipantsGrid" class="d-flex flex-wrap gap-2 p-2" style="background:#0d121c; border-radius:8px; min-height:100px;"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Helpers */
const $ = id => document.getElementById(id);
function toast(msg,type='success'){ const el=document.createElement('div'); el.className=`toast align-items-center text-bg-${type} border-0 positioned-toast`; el.style.position='fixed'; el.style.bottom='20px'; el.style.right='20px'; el.style.zIndex='9999'; el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`; document.body.appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast', ()=>el.remove()); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function encodeKey(k){ return encodeURIComponent(String(k)); }

/* Cache */
let CACHE = { students:[], teams:[], events:[], participations:[], results:[], attendance:{}, programData:{} };
let KEYMAP = { students:{}, teams:{}, events:{}, participations:{}, results:{} };

/* Listeners */
const refs = { students:'students', teams:'teams', events:'events', participations:'participations', results:'results', attendance:'attendance', programData:'program_data' };
Object.entries(refs).forEach(([key, path]) => {
  onValue(ref(db, path), snap => {
    const val = snap.val() || {};
    if(key === 'attendance' || key === 'programData') CACHE[key] = val;
    else {
      CACHE[key] = Object.values(val);
      KEYMAP[key] = {};
      Object.entries(val).forEach(([k,v]) => { if(v && v.id) KEYMAP[key][String(v.id)] = k; });
    }
    renderAll();
  });
});

/* Nav */
document.querySelectorAll('.sidebar .icon-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    if(btn.id === 'logoutBtn') { window.location.href='index.html'; return; }
    document.querySelectorAll('#panels > section').forEach(s => s.classList.add('d-none'));
    const target = document.querySelector(btn.dataset.target);
    if(target) target.classList.remove('d-none');
    document.querySelectorAll('.sidebar .icon-btn').forEach(i=> i.classList.remove('active'));
    btn.classList.add('active');
  });
});

function renderAll(){
  populateDropdowns();
  renderOverview(); // NEW
  renderStudents();
  renderTeams();
  renderEvents();
  renderAttendanceHistory();
  renderApprovals();
  renderResults();
  // renderPrograms(); REMOVED
}

function populateDropdowns(){
  const tSelect = $('manualTeam'); const eTeam = $('editTeam'); const aTeam = $('attTeam');
  const teams = CACHE.teams.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html = '<option value="">Unassigned</option>';
  teams.forEach(t => html += `<option value="${t.id}">${escapeHtml(t.name)}</option>`);
  tSelect.innerHTML = html; eTeam.innerHTML = html; 
  aTeam.innerHTML = `<option value="">Select Team</option>` + html;

  const rEv = $('resultEvent');
  let evHtml = '<option value="">Select Event</option>';
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(e => evHtml += `<option value="${e.id}">${escapeHtml(e.name)} (${e.type})</option>`);
  if(rEv.innerHTML !== evHtml) rEv.innerHTML = evHtml;
  
  const lSelect = $('teamLeader');
  let lHtml = '<option value="">Select Leader</option>';
  CACHE.students.sort((a,b)=> (a.name||'').localeCompare(b.name||'')).forEach(s => lHtml += `<option value="${s.id}">${escapeHtml(s.name)} (${s.id})</option>`);
  if(document.activeElement !== lSelect) lSelect.innerHTML = lHtml;
}

/* ---------------- OVERVIEW (NEW) ---------------- */
function renderOverview() {
    const totalTeams = CACHE.teams.length;
    const totalStudents = CACHE.students.length;
    const pendingApprovals = CACHE.participations.filter(p => p.status === 'pending').length;
    
    // Calculate Draft Results count (Event has results but is not fully published)
    let draftResultsCount = 0;
    const evMap = {};
    CACHE.results.forEach(r => { 
        if(!evMap[r.eventId]) evMap[r.eventId] = { isPublished: true, hasResult: false }; 
        evMap[r.eventId].isPublished = evMap[r.eventId].isPublished && (r.published === true);
        evMap[r.eventId].hasResult = true;
    });

    Object.values(evMap).forEach(data => {
        if (data.hasResult && !data.isPublished) {
            draftResultsCount++;
        }
    });

    $('totalTeamsCount').textContent = totalTeams;
    $('totalStudentsCount').textContent = totalStudents;
    $('pendingApprovalsCount').textContent = pendingApprovals;
    $('draftResultsCount').textContent = draftResultsCount;

    // Leaderboard
    const leaderboard = CACHE.teams.slice().sort((a, b) => (b.score || 0) - (a.score || 0));
    const tbody = $('leaderboardTable');
    let html = '';
    if (leaderboard.length === 0) {
        html = '<tr><td colspan="3" class="text-center muted">No teams found.</td></tr>';
    } else {
        leaderboard.forEach((t, index) => {
            html += `<tr><td>${index + 1}</td><td>${escapeHtml(t.name)}</td><td>${t.score || 0}</td></tr>`;
        });
    }
    tbody.innerHTML = html;
}

/* ---------------- STUDENT DETAILS LOOKUP (NEW PAGE) ---------------- */
$('studentLookupSearch').addEventListener('input', () => {
    const q = $('studentLookupSearch').value.trim().toLowerCase();
    if (q.length < 3) return;

    const student = CACHE.students.find(s => 
        String(s.id).toLowerCase() === q || String(s.name).toLowerCase().includes(q)
    );

    if (student) {
        const team = CACHE.teams.find(t => t.id === student.teamId);
        const teamName = team ? team.name : 'Unassigned';

        $('studentLookupName').textContent = student.name;
        $('studentLookupID').textContent = student.id;
        $('studentLookupLevel').textContent = student.level;
        $('studentLookupTeam').textContent = teamName;

        const participationHtml = renderStudentParticipation(student.id);
        $('studentParticipationTable').innerHTML = participationHtml;
    } else {
        $('studentLookupName').textContent = 'Student Not Found';
        $('studentLookupID').textContent = '-';
        $('studentLookupLevel').textContent = '-';
        $('studentLookupTeam').textContent = '-';
        $('studentParticipationTable').innerHTML = '<tr><td colspan="2" class="text-danger">No student matching your query.</td></tr>';
    }
});

function renderStudentParticipation(studentId) {
    const eventsMap = {}; CACHE.events.forEach(e => eventsMap[e.id] = e);
    
    let html = '';
    CACHE.participations.filter(p => p.studentId === studentId)
        .sort((a,b) => eventsMap[a.eventId]?.name.localeCompare(eventsMap[b.eventId]?.name))
        .forEach(p => {
        const event = eventsMap[p.eventId];
        const status = p.status;
        let statusBadge = '';
        if (status === 'approved') statusBadge = '<span class="badge bg-success">Approved</span>';
        else if (status === 'pending') statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
        else statusBadge = '<span class="badge bg-danger">Rejected</span>';

        html += `<tr><td>${event ? event.name : 'Unknown Event'}</td><td>${statusBadge}</td></tr>`;
    });
    
    if (html === '') {
        return '<tr><td colspan="2" class="muted">No participation history found.</td></tr>';
    }
    return html;
}

/* --- EXCEL IMPORT HELPERS --- */
let tempImportData = [];
function readExcel(file, callback){
  const reader = new FileReader();
  reader.onload = (e) => {
    const wb = XLSX.read(e.target.result, {type:'binary'});
    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {defval:''});
    callback(json);
  };
  reader.readAsBinaryString(file);
}

/* ---------------- STUDENTS ---------------- */
$('addManualStudent').addEventListener('click', async ()=>{
  const chess = $('manualChess').value.trim(); const name = $('manualName').value.trim();
  if(!chess || !name) return toast('Chess ID & Name required','danger');
  if(KEYMAP.students[chess]) return toast('ID exists','danger');
  await set(ref(db, `students/${encodeKey(chess)}`), { id:chess, name, level:$('manualLevel').value, teamId:$('manualTeam').value||null });
  $('manualChess').value=''; $('manualName').value=''; toast('Student added');
});

// Student Import Logic
$('previewStudents').addEventListener('click', () => {
  const f = $('studentFile').files[0]; if(!f) return toast('Select File','warning');
  readExcel(f, (json) => {
    tempImportData = json;
    let html = '<table class="table table-sm table-dark"><thead><tr><th>Chess</th><th>Name</th><th>Level</th><th>Team</th></tr></thead><tbody>';
    json.slice(0,5).forEach(r => {
      const chess = r['Chess']||r['ID']||'';
      const name = r['Name']||r['Student']||'';
      html += `<tr><td>${chess}</td><td>${name}</td><td>${r['Level']||'Senior'}</td><td>${r['Team']||''}</td></tr>`;
    });
    html += '</tbody></table><div class="small text-muted">Showing first 5 rows...</div>';
    $('studentsPreview').innerHTML = html;
  });
});

$('importStudents').addEventListener('click', async () => {
  if(!tempImportData.length) return toast('Preview first','warning');
  const teamMap = {}; CACHE.teams.forEach(t => teamMap[t.name.toLowerCase()] = t.id);
  const updates = {};
  tempImportData.forEach(r => {
    const chess = String(r['Chess']||r['ID']||'').trim();
    const name = String(r['Name']||r['Student']||'').trim();
    if(chess && name && !KEYMAP.students[chess]){
       const tName = String(r['Team']||'').toLowerCase();
       updates[`students/${encodeKey(chess)}`] = {
         id: chess, name: name,
         level: r['Level']||'Senior',
         teamId: teamMap[tName] || null
       };
    }
  });
  if(Object.keys(updates).length){ await update(ref(db), updates); toast('Imported successfully!'); }
  else toast('No new data to import','warning');
  tempImportData = []; $('studentsPreview').innerHTML = ''; $('studentFile').value = '';
});

function renderStudents(){
  const q = ($('searchStudents').value||'').trim().toLowerCase();
  const tm = {}; CACHE.teams.forEach(t=> tm[t.id]=t.name);
  let html = '';
  CACHE.students.sort((a,b)=> String(a.id).localeCompare(String(b.id))).forEach(s => {
    if(q && !`${s.id} ${s.name}`.toLowerCase().includes(q)) return;
    html += `<tr data-id="${s.id}"><td>${s.id}</td><td>${escapeHtml(s.name)}</td><td>${s.level}</td><td>${escapeHtml(tm[s.teamId]||'-')}</td><td><button class="btn btn-sm btn-outline-primary btn-edit-stu">Edit</button></td></tr>`;
  });
  $('studentsTable').innerHTML = html;
}
$('studentsTable').addEventListener('click', e => {
  if(e.target.classList.contains('btn-edit-stu')){
    const id = e.target.closest('tr').dataset.id;
    const s = CACHE.students.find(x => String(x.id) === String(id));
    if(s){
      $('editStudentDbKey').value = KEYMAP.students[s.id];
      $('editChess').value = s.id; $('editName').value = s.name; $('editLevel').value = s.level; $('editTeam').value = s.teamId||'';
      new bootstrap.Modal($('editStudentModal')).show();
    }
  }
});
$('editStudentForm').addEventListener('submit', async e => {
  e.preventDefault();
  const k = $('editStudentDbKey').value;
  await update(ref(db, `students/${k}`), { name:$('editName').value, level:$('editLevel').value, teamId:$('editTeam').value||null });
  bootstrap.Modal.getInstance($('editStudentModal')).hide(); toast('Updated');
});
$('deleteStudentBtn').addEventListener('click', async ()=>{
  if(confirm('Delete student?')) { await remove(ref(db, `students/${$('editStudentDbKey').value}`)); bootstrap.Modal.getInstance($('editStudentModal')).hide(); toast('Deleted'); }
});

/* ---------------- TEAMS ---------------- */
$('saveTeam').addEventListener('click', async ()=>{
  const n = $('teamName').value.trim();
  if(!n) return toast('Name required','danger');
  const id = Date.now().toString();
  await set(push(ref(db, 'teams')), { id, name:n, leaderId:$('teamLeader').value||null, password:$('teamPassword').value||'', score:0 });
  $('teamName').value=''; toast('Team created');
});
function renderTeams(){
  const tbody = $('teamsTable');
  let html='';
  CACHE.teams.forEach(t => {
    const l = CACHE.students.find(s=>s.id==t.leaderId);
    const cnt = CACHE.students.filter(s=>s.teamId==t.id).length;
    html += `<tr><td>${escapeHtml(t.name)}</td><td>${l?l.name:'-'}</td><td>${cnt}</td><td>${t.score||0}</td><td><button class="btn btn-sm btn-outline-danger btn-del-team" data-key="${KEYMAP.teams[t.id]}">Del</button></td></tr>`;
  });
  tbody.innerHTML = html;
}
$('teamsTable').addEventListener('click', async e=>{
  if(e.target.classList.contains('btn-del-team')){ if(confirm('Delete team?')) await remove(ref(db, `teams/${e.target.dataset.key}`)); }
});

/* ---------------- EVENTS ---------------- */
$('saveEvent').addEventListener('click', async ()=>{
  const n = $('eventName').value.trim();
  if(!n) return toast('Name required','danger');
  const id = Date.now().toString();
  await set(push(ref(db, 'events')), { id, name:n, type:$('eventType').value, level:$('eventLevel').value });
  $('eventName').value=''; toast('Event added');
});

// Event Import
let tempEventData = [];
$('previewEvents').addEventListener('click', () => {
  const f = $('eventFile').files[0]; if(!f) return toast('Select File','warning');
  readExcel(f, (json) => {
    tempEventData = json;
    let html = '<table class="table table-sm table-dark"><thead><tr><th>Name</th><th>Type</th><th>Level</th></tr></thead><tbody>';
    json.slice(0,5).forEach(r => {
      html += `<tr><td>${r['Name']||r['Event']||''}</td><td>${r['Type']||''}</td><td>${r['Level']||''}</td></tr>`;
    });
    html += '</tbody></table>';
    $('eventsPreview').innerHTML = html;
  });
});
$('importEvents').addEventListener('click', async () => {
  if(!tempEventData.length) return toast('Preview first','warning');
  const updates = {};
  tempEventData.forEach(r => {
    const name = String(r['Name']||r['Event']||'').trim();
    if(name){
       const id = Date.now() + Math.floor(Math.random()*1000).toString();
       updates[`events/${id}`] = { id:id, name:name, type:r['Type']||'Stage', level:r['Level']||'General' };
    }
  });
  if(Object.keys(updates).length){ await update(ref(db), updates); toast('Events Imported'); }
  tempEventData = []; $('eventsPreview').innerHTML = ''; $('eventFile').value = '';
});

function renderEvents(){
  const q = ($('filterEventSearch').value||'').trim().toLowerCase();
  let html='';
  CACHE.events.forEach(e => {
    if(q && !e.name.toLowerCase().includes(q)) return;
    html += `<tr><td>${escapeHtml(e.name)}</td><td>${e.type}</td><td>${e.level}</td><td><button class="btn btn-sm btn-outline-danger btn-del-ev" data-key="${KEYMAP.events[e.id]}">Del</button></td></tr>`;
  });
  $('eventsTable').innerHTML = html;
}
$('eventsTable').addEventListener('click', async e=>{
  if(e.target.classList.contains('btn-del-ev')){ if(confirm('Delete event?')) await remove(ref(db, `events/${e.target.dataset.key}`)); }
});

/* ---------------- ATTENDANCE ---------------- */
$('attMethod').addEventListener('change', ()=> $('attTeamWrap').classList.toggle('d-none', $('attMethod').value!=='team'));
$('loadAttendance').addEventListener('click', ()=>{
  const m = $('attMethod').value;
  const list = m==='all' ? CACHE.students : CACHE.students.filter(s => s.teamId == $('attTeam').value);
  const box = $('attendanceBoxes'); box.innerHTML = '';
  list.sort((a,b)=>a.id.localeCompare(b.id)).forEach(s => {
    box.innerHTML += `<div class="small-box absent" data-id="${s.id}" onclick="this.classList.toggle('present');this.classList.toggle('absent')"><div>${s.id}</div><div class="small-box-id">${escapeHtml(s.name.split(' ')[0])}</div></div>`;
  });
  $('attendanceMarkCard').style.display = 'block';
});
$('toggleAll').addEventListener('click', ()=>{
  const all = document.querySelectorAll('#attendanceBoxes .small-box');
  const isAllPres = Array.from(all).every(b=>b.classList.contains('present'));
  all.forEach(b => { b.className = isAllPres ? 'small-box absent' : 'small-box present'; });
});
$('saveAttendance').addEventListener('click', async ()=>{
  const d = $('attDate').value; if(!d) return toast('Date required','danger');
  const sts = {};
  document.querySelectorAll('#attendanceBoxes .small-box').forEach(b => { sts[b.dataset.id] = b.classList.contains('present')?'Present':'Absent'; });
  await push(ref(db, 'attendance'), { date:d, students:sts, timestamp:Date.now() });
  $('attendanceMarkCard').style.display='none'; toast('Attendance saved');
});
function renderAttendanceHistory(){
  let html='';
  Object.entries(CACHE.attendance).sort((a,b)=>b[1].timestamp-a[1].timestamp).forEach(([k,v])=>{
    const c = v.students ? Object.values(v.students).filter(x=>x=='Present').length : 0;
    const dateStr = v.timestamp ? new Date(v.timestamp).toLocaleTimeString() : '';
    html += `<tr><td>${v.date}</td><td>${c}</td><td><small>${dateStr}</small></td><td><button class="btn btn-sm btn-outline-danger" onclick="delAtt('${k}')">Del</button></td></tr>`;
  });
  $('attendanceSessions').innerHTML = html;
}
window.delAtt = async k => { if(confirm('Delete?')) await remove(ref(db, `attendance/${k}`)); };

/* ---------------- APPROVALS & PROGRAM MANAGEMENT (COMBINED) ---------------- */
function renderApprovals(){
  const q = ($('searchApprovals').value||'').trim().toLowerCase();
  const summary = {};
  CACHE.events.forEach(e => summary[e.id] = {ev:e, p:0, a:0});
  CACHE.participations.forEach(p => {
    if(summary[p.eventId]) { if(p.status=='approved') summary[p.eventId].a++; else if(p.status=='pending') summary[p.eventId].p++; }
  });
  let html='';
  Object.values(summary).forEach(x => {
    if(q && !x.ev.name.toLowerCase().includes(q)) return;
    html += `<tr><td>${escapeHtml(x.ev.name)}</td><td>${x.ev.type}</td><td><span class="badge bg-warning text-dark">${x.p}</span></td><td><span class="badge bg-success">${x.a}</span></td><td><button class="btn btn-sm btn-primary btn-view-app" data-eid="${x.ev.id}">View</button> <button class="btn btn-sm btn-outline-info btn-manage-prog" data-eid="${x.ev.id}">Manage Program</button></td></tr>`;
  });
  $('approvalsTable').innerHTML = html;
}

// APPROVAL VIEW
$('approvalsTable').addEventListener('click', e => {
  if(e.target.classList.contains('btn-view-app')){
    const eid = e.target.dataset.eid;
    const parts = CACHE.participations.filter(p => p.eventId == eid);
    const pending = parts.filter(p=>p.status=='pending');
    const approved = parts.filter(p=>p.status=='approved');
    const tm = {}; CACHE.teams.forEach(t=>tm[t.id]=t.name);
    
    let pHtml = ''; pending.forEach(p => { const s = CACHE.students.find(x=>x.id==p.studentId); pHtml += `<tr><td>${s?s.name:p.studentId} (${p.studentId}) - ${tm[p.teamId]||''}</td><td class="text-end"><button onclick="setStatus('${p.id}','approved')" class="btn btn-sm btn-success">Approve</button> <button onclick="setStatus('${p.id}','rejected')" class="btn btn-sm btn-danger">Reject</button></td></tr>`; });
    $('pendingParticipantsTable').innerHTML = pHtml || '<tr><td colspan="2" class="muted">No pending</td></tr>';

    let aHtml = ''; approved.forEach(p => { const s = CACHE.students.find(x=>x.id==p.studentId); aHtml += `<tr><td>${s?s.name:p.studentId} (${p.studentId})</td><td class="text-end"><button onclick="setStatus('${p.id}','pending')" class="btn btn-sm btn-warning">Undo</button></td></tr>`; });
    $('approvedParticipantsTable').innerHTML = aHtml || '<tr><td colspan="2" class="muted">No approved</td></tr>';

    const ev = CACHE.events.find(x=>x.id==eid);
    $('approvalModalTitle').textContent = ev ? ev.name : 'Participants';
    new bootstrap.Modal($('approvalsDetailModal')).show();
  } else if(e.target.classList.contains('btn-manage-prog')){
    const eid = e.target.dataset.eid;
    currentProgramEventId = eid;
    const ev = CACHE.events.find(x=>x.id==eid);
    $('programModalTitle').textContent = `Manage Program: ${ev.name}`;
    loadProgramDetails(eid);
    new bootstrap.Modal($('programDetailModal')).show();
  }
});

// PROGRAM MANAGEMENT (LOAD)
function loadProgramDetails(eid) {
    const approvedParts = CACHE.participations.filter(p => p.eventId == eid && p.status == 'approved');
    const progData = CACHE.programData && CACHE.programData[eid] ? CACHE.programData[eid] : {};
    
    const grid = $('programParticipantsGrid'); grid.innerHTML = '';
    
    if(!approvedParts.length) { grid.innerHTML = '<div class="text-muted w-100 text-center py-4">No approved participants.</div>'; } 
    else {
      approvedParts.forEach(p => {
        const s = CACHE.students.find(x => x.id == p.studentId);
        const name = s ? s.name : p.studentId;
        const pData = progData[p.studentId] || {};
        const isPresent = pData.present === true;
        const code = pData.code || '';
        
        const box = document.createElement('div');
        box.className = `small-box ${isPresent ? 'present' : 'absent'}`;
        box.dataset.sid = p.studentId;
        box.innerHTML = `${code ? `<div class="small-box-code">${code}</div>` : ''}<div>${p.studentId}</div><div class="small-box-id">${name.split(' ')[0]}</div>`;
        box.addEventListener('click', () => {
          if(box.classList.contains('absent')) { box.classList.remove('absent'); box.classList.add('present'); }
          else { box.classList.remove('present'); box.classList.add('absent'); }
        });
        grid.appendChild(box);
      });
    }
}

// PROGRAM MANAGEMENT (ASSIGN CODES)
$('assignRandomLetters').addEventListener('click', () => {
  if(!currentProgramEventId) return;
  const boxes = Array.from(document.querySelectorAll('#programParticipantsGrid .small-box'));
  if(!boxes.length) return toast('No participants','warning');
  if(!confirm('This will reshuffle and overwrite existing codes/scratch card letters. Continue?')) return;
  
  const generateCodes = (n) => {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let codes = [];
    for(let i=0; i<n; i++) codes.push(i<26 ? chars[i] : chars[Math.floor(i/26)-1] + chars[i%26]);
    for (let i = codes.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [codes[i], codes[j]] = [codes[j], codes[i]]; }
    return codes;
  };
  
  const codes = generateCodes(boxes.length);
  boxes.forEach((box, idx) => {
    let codeBadge = box.querySelector('.small-box-code');
    if(!codeBadge) { codeBadge = document.createElement('div'); codeBadge.className = 'small-box-code'; box.appendChild(codeBadge); }
    codeBadge.textContent = codes[idx];
  });
  toast('Codes assigned! Click Save Data to finalize.');
});

// PROGRAM MANAGEMENT (SAVE)
$('saveProgramData').addEventListener('click', async () => {
  if(!currentProgramEventId) return;
  const updates = {};
  document.querySelectorAll('#programParticipantsGrid .small-box').forEach(box => {
    const codeEl = box.querySelector('.small-box-code');
    updates[box.dataset.sid] = { present: box.classList.contains('present'), code: codeEl ? codeEl.textContent : null };
  });
  await set(ref(db, `program_data/${currentProgramEventId}`), updates);
  toast('Program data saved successfully'); bootstrap.Modal.getInstance($('programDetailModal')).hide();
});

/* ---------------- RESULTS (FIXED LOGIC) ---------------- */
// Result Validation
function validateResults(inputs) {
    const selectedIds = inputs.filter(i => i.sid).map(i => i.sid);
    const uniqueIds = new Set(selectedIds);
    if (selectedIds.length !== uniqueIds.size) {
        return { valid: false, message: "1st, 2nd, and 3rd places must be unique students." };
    }
    return { valid: true };
}

$('saveResult').addEventListener('click', async () => saveRes(false));
$('publishAllResults').addEventListener('click', async () => saveRes(true));

async function saveRes(publish){
  const eid = $('resultEvent').value; if(!eid) return toast('Select event','danger');
  
  const inputs = [
    { pos:1, sid:$('resultSelectFirst').value, pts:Number($('resultPointsFirst').value)||0 },
    { pos:2, sid:$('resultSelectSecond').value, pts:Number($('resultPointsSecond').value)||0 },
    { pos:3, sid:$('resultSelectThird').value, pts:Number($('resultPointsThird').value)||0 }
  ];
  
  const validation = validateResults(inputs);
  if (!validation.valid) return toast(validation.message, 'danger');
  
  // 1. Unpublish and reset scores for this event first (Clean slate for publishing)
  if(publish) {
      const oldResults = CACHE.results.filter(r => r.eventId === eid && r.published);
      for(const oldR of oldResults) {
          const oldStu = CACHE.students.find(s=>s.id === oldR.studentId);
          if(oldStu && oldStu.teamId){
             const tm = CACHE.teams.find(t=>t.id === oldStu.teamId);
             const tmKey = KEYMAP.teams[tm.id];
             await update(ref(db, `teams/${tmKey}`), { score: (tm.score||0) - oldR.points });
          }
          await update(ref(db, `results/${KEYMAP.results[oldR.id]}`), { published: false });
      }
  }

  // 2. Publish/Save new results
  for(const i of inputs){
    if(i.sid){
      const ex = CACHE.results.find(r => r.eventId === eid && r.position === i.pos);
      const data = { eventId:eid, position:i.pos, studentId:i.sid, points:i.pts, published:publish };
      
      // Save Result
      if(ex) await update(ref(db, `results/${KEYMAP.results[ex.id]}`), data);
      else await set(push(ref(db, 'results')), { ...data, id:Date.now()+Math.random().toString() });
      
      // Update Team Score (Only if publishing)
      if(publish){
         const stu = CACHE.students.find(s=>s.id === i.sid);
         if(stu && stu.teamId){
            const tm = CACHE.teams.find(t=>t.id === stu.teamId);
            const tmKey = KEYMAP.teams[tm.id];
            await update(ref(db, `teams/${tmKey}`), { score: (tm.score||0) + i.pts });
         }
      }
    }
  }
  toast(publish ? 'Published & Scores Updated!' : 'Draft saved');
  $('resultEvent').value = ''; 
}

function renderResults(){
  const tbody = $('resultsTable');
  let html = '';
  const studentMap = {}; CACHE.students.forEach(s => studentMap[s.id] = s);

  CACHE.events.forEach(ev => {
    const res = CACHE.results.filter(r => r.eventId == ev.id);
    const p1 = res.find(r=>r.position==1);
    const p2 = res.find(r=>r.position==2);
    const p3 = res.find(r=>r.position==3);
    const total = (p1?Number(p1.points):0) + (p2?Number(p2.points):0) + (p3?Number(p3.points):0);
    const isPub = res.some(r=>r.published);
    const status = isPub ? '<span class="badge bg-success">Published</span>' : (res.length ? '<span class="badge bg-warning text-dark">Draft</span>' : '<span class="badge bg-secondary">No Results</span>');
    
    // FIX: Show points next to name
    const getName = (r) => { 
        if(!r) return '-'; 
        const s = studentMap[r.studentId]; 
        return s ? `${s.name} (${r.points})` : `${r.studentId} (${r.points})`; 
    };

    html += `<tr><td>${escapeHtml(ev.name)}</td><td><small>${ev.type}</small></td><td>${getName(p1)}</td><td>${getName(p2)}</td><td>${getName(p3)}</td><td class="fw-bold text-info">${total}</td><td>${status}</td></tr>`;
  });
  tbody.innerHTML = html;
}

/* ---------------- FINAL BOOTSTRAPPING ---------------- */
setTimeout(()=> {
  // Start on the new Overview panel
  document.querySelector('.sidebar .icon-btn[data-target="#panel-overview"]').click();
  renderAll();
}, 600);

console.log('Admin v4 Loaded');
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
