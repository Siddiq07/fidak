<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Participant Panel | Fidak Fest</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<style>
:root {
  --primary: #0b2440;
  --accent: #ffb703;
  --card: #ffffff;
  --muted: #64748b;
  --bg: #f4f7fb;
  --success: #22c55e;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
}

body {
  margin: 0;
  background: var(--bg);
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
  color: #1e293b;
}

/* HEADER */
.topbar {
  background: var(--primary);
  color: #fff;
  padding: 15px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.brand {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: 0.5px;
}
.brand span { color: var(--accent); }
.logout-btn {
  background: #ef4444;
  border: 0;
  color: #fff;
  padding: 8px 16px;
  border-radius: 8px;
  font-weight: 600;
  transition: 0.2s;
}
.logout-btn:hover { 
  background: #dc2626; 
  transform: translateY(-1px);
}

/* PROFILE */
.profile {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
  margin: 20px;
  border-radius: 16px;
  padding: 24px;
  box-shadow: 0 8px 24px rgba(37, 99, 235, 0.2);
  color: white;
  position: relative;
  overflow: hidden;
}
.profile::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -20%;
  width: 150px;
  height: 150px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 50%;
}
.profile h4 {
  margin: 0 0 10px 0;
  font-weight: 800;
  font-size: 1.8rem;
}
.profile small {
  opacity: 0.9;
  font-size: 1rem;
  display: block;
  margin-top: 8px;
}
.profile-icon {
  font-size: 20px;
  margin-right: 8px;
  opacity: 0.8;
}

/* STATS */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 15px;
  margin: 20px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  text-align: center;
  transition: transform 0.2s;
  border-top: 4px solid var(--info);
}
.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}
.stat-card.orange { border-top-color: var(--warning); }
.stat-card.green { border-top-color: var(--success); }
.stat-card.red { border-top-color: var(--danger); }
.stat-card h2 {
  margin: 5px 0 0 0;
  font-weight: 900;
  font-size: 2.5rem;
  color: var(--primary);
}
.stat-card span {
  font-size: 0.9rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  font-weight: 600;
}
.stat-icon {
  font-size: 24px;
  margin-bottom: 10px;
  color: var(--info);
}
.stat-card.orange .stat-icon { color: var(--warning); }
.stat-card.green .stat-icon { color: var(--success); }
.stat-card.red .stat-icon { color: var(--danger); }

/* SECTIONS */
.section {
  margin: 20px;
}
.section-title {
  font-size: 20px;
  font-weight: 800;
  margin-bottom: 20px;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
  padding-bottom: 10px;
  border-bottom: 2px solid #e2e8f0;
}
.section-title i { 
  color: var(--accent); 
  font-size: 22px;
}

/* EVENT CARD */
.event-card {
  background: white;
  border-radius: 12px;
  padding: 18px;
  margin-bottom: 15px;
  border: 1px solid #e2e8f0;
  transition: all 0.2s;
  position: relative;
}
.event-card:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
  border-color: var(--accent);
}
.event-card h5 {
  margin: 0;
  font-weight: 700;
  color: var(--primary);
  font-size: 1.1rem;
}
.event-meta {
  font-size: 14px;
  color: var(--muted);
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.event-badge {
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}
.badge-approved { background: #dcfce7; color: #166534; }
.badge-pending { background: #fef3c7; color: #92400e; }
.badge-rejected { background: #fee2e2; color: #991b1b; }

/* RESULTS CONTAINER - LIKE LEADER PAGE */
.res-container {
  padding: 0;
  background: transparent;
}
.res-card {
  background: #ffffff !important;
  color: #0f172a !important;
  border-radius: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  overflow: hidden;
  border: none;
}
.res-header {
  padding: 16px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  background: linear-gradient(135deg, #3b82f6, #1e40af);
  color: white;
}
.res-cat {
  font-weight: 700;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.9);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.res-name {
  font-weight: 800;
  font-size: 1.1rem;
  color: white;
  margin-top: 4px;
}
.btn-view-res {
  background: white;
  color: #3b82f6;
  border: none;
  padding: 6px 18px;
  border-radius: 6px;
  font-weight: 600;
  font-size: 13px;
  transition: 0.2s;
}
.btn-view-res:hover {
  background: #f8fafc;
  transform: translateY(-1px);
}
.res-body {
  padding: 0 20px 20px;
  background: #fff;
  border-top: 1px solid #f1f5f9;
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.5s ease;
}
.res-body.expanded {
  max-height: 1000px;
  padding: 20px;
}
.winner-row {
  display: flex;
  align-items: center;
  padding: 12px;
  background: #f8fafc;
  border-radius: 8px;
  margin-top: 10px;
  color: #1e293b;
}
.rank-num {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #3b82f6;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  margin-right: 12px;
  flex-shrink: 0;
}
.winner-info {
  flex-grow: 1;
}
.winner-name {
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 4px;
}
.winner-meta {
  font-size: 12px;
  color: #64748b;
}
.winner-points {
  background: #3b82f6;
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

/* MY RESULT INDICATOR */
.my-result {
  background: linear-gradient(135deg, #dcfce7, #bbf7d0) !important;
  border: 2px solid #22c55e !important;
}
.my-badge {
  background: linear-gradient(135deg, #22c55e, #16a34a);
  color: white;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-left: 10px;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

/* EMPTY STATES */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  background: white;
  border-radius: 16px;
  border: 2px dashed #e2e8f0;
}
.empty-state i {
  font-size: 48px;
  color: #cbd5e1;
  margin-bottom: 16px;
}
.empty-state h5 {
  color: var(--muted);
  margin-bottom: 8px;
}
.empty-state p {
  color: #94a3b8;
  margin: 0;
}

/* MOBILE */
@media (max-width: 768px) {
  .topbar { flex-direction: row; }
  .stats { grid-template-columns: repeat(2, 1fr); }
  .res-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .btn-view-res {
    align-self: flex-end;
  }
}

@media (max-width: 480px) {
  .stats { grid-template-columns: 1fr; }
  .section { margin: 15px; }
  .profile { margin: 15px; padding: 20px; }
}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand">Fida<span>Fest</span></div>
  <button class="logout-btn" id="logoutBtn">
    <i class="bi bi-box-arrow-right"></i> Logout
  </button>
</div>

<div class="profile">
  <h4 id="studentName">Loading Profile...</h4>
  <small>
    <i class="bi bi-person-badge profile-icon"></i> ID: <b id="studentId">...</b> &nbsp;|&nbsp; 
    <i class="bi bi-people profile-icon"></i> Team: <b id="teamName">...</b> &nbsp;|&nbsp; 
    <i class="bi bi-stars profile-icon"></i> Level: <b id="studentLevel">...</b>
  </small>
</div>

<div class="stats">
  <div class="stat-card">
    <i class="bi bi-calendar-event stat-icon"></i>
    <span>Events</span>
    <h2 id="statEvents">0</h2>
  </div>
  <div class="stat-card orange">
    <i class="bi bi-check-circle stat-icon"></i>
    <span>Approved</span>
    <h2 id="statApproved">0</h2>
  </div>
  <div class="stat-card green">
    <i class="bi bi-trophy stat-icon"></i>
    <span>Wins</span>
    <h2 id="statWins">0</h2>
  </div>
  <div class="stat-card red">
    <i class="bi bi-award stat-icon"></i>
    <span>Points</span>
    <h2 id="statPoints">0</h2>
  </div>
</div>

<div class="section">
  <div class="section-title"><i class="bi bi-calendar-check"></i> My Registrations</div>
  <div id="eventList">
    <div class="empty-state">
      <i class="bi bi-calendar-x"></i>
      <h5>No Registrations</h5>
      <p>You haven't registered for any events yet</p>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title"><i class="bi bi-trophy"></i> All Event Results</div>
  <div id="resultsContainer" class="res-container">
    <div class="empty-state">
      <i class="bi bi-trophy"></i>
      <h5>No Results Published</h5>
      <p>Event results will appear here once published</p>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  authDomain: "gen7-3e139.firebaseapp.com",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Check if participant is logged in
const participantId = sessionStorage.getItem("participantId");
if (!participantId) {
  window.location.href = "index.html";
}

// Data containers
let studentData = null;
let teamMap = {};
let eventMap = {};
let CACHE = {
  students: [],
  teams: [],
  events: [],
  participations: [],
  results: []
};

// Load all data
onValue(ref(db, '/'), (snap) => {
  const data = snap.val() || {};
  
  CACHE.students = Object.values(data.students || {});
  CACHE.teams = Object.values(data.teams || {});
  CACHE.events = Object.values(data.events || {});
  CACHE.results = Object.values(data.results || {});
  CACHE.participations = Object.values(data.participations || {});
  
  // Build maps
  CACHE.teams.forEach(t => teamMap[t.id] = t);
  CACHE.events.forEach(e => eventMap[e.id] = e);
  
  initProfile();
  renderRegistrations();
  renderAllResults();
  updateStats();
});

// Initialize Profile
function initProfile() {
  // Find student by ID
  let student = CACHE.students.find(s => 
    String(s.id) === String(participantId) || 
    String(s.chestNo) === String(participantId)
  );

  if (!student) {
    alert('Student profile not found!');
    logout();
    return;
  }

  studentData = student;
  
  // Update UI
  document.getElementById('studentName').textContent = student.name;
  document.getElementById('studentId').textContent = student.id || student.chestNo;
  document.getElementById('studentLevel').textContent = student.level || student.category || 'General';
  
  // Find team
  const team = teamMap[student.teamId];
  if (team) {
    document.getElementById('teamName').textContent = team.name;
  }
}

// Render Registrations
function renderRegistrations() {
  const container = document.getElementById('eventList');
  const myRegistrations = CACHE.participations.filter(p => 
    String(p.studentId) === String(participantId)
  );

  if (myRegistrations.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-calendar-x"></i>
        <h5>No Registrations</h5>
        <p>You haven't registered for any events yet</p>
      </div>
    `;
    return;
  }

  container.innerHTML = myRegistrations.map(part => {
    const event = eventMap[part.eventId];
    if (!event) return '';
    
    let badgeClass = 'badge-pending';
    let badgeText = 'Pending';
    
    if (part.status === 'approved') {
      badgeClass = 'badge-approved';
      badgeText = 'Approved';
    } else if (part.status === 'rejected') {
      badgeClass = 'badge-rejected';
      badgeText = 'Rejected';
    }
    
    // Check if this event has results
    const hasResults = CACHE.results.some(r => 
      r.eventId === part.eventId && r.published === true
    );
    
    return `
      <div class="event-card">
        <h5>${event.name}</h5>
        <div class="event-meta">
          <span class="${badgeClass} event-badge">${badgeText}</span>
          <span><i class="bi bi-tag me-1"></i>${event.type}</span>
          <span><i class="bi bi-flag me-1"></i>${event.level}</span>
          ${hasResults ? '<span class="badge-approved event-badge"><i class="bi bi-trophy me-1"></i>Results Out</span>' : ''}
        </div>
      </div>
    `;
  }).join('');
}

// Render All Results - EXACTLY LIKE LEADER PAGE
function renderAllResults() {
  const container = document.getElementById('resultsContainer');
  
  // Get all published results
  const publishedIds = [...new Set(
    CACHE.results
      .filter(r => r.published === true)
      .map(r => String(r.eventId))
  )];
  
  if (publishedIds.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <i class="bi bi-trophy"></i>
        <h5>No Results Published</h5>
        <p>Event results will appear here once published</p>
      </div>
    `;
    return;
  }

  container.innerHTML = CACHE.events
    .filter(e => publishedIds.includes(String(e.id)))
    .map(ev => {
      // Get all winners for this event
      const winners = CACHE.results
        .filter(r => String(r.eventId) === String(ev.id) && r.published === true)
        .sort((a, b) => a.position - b.position);
      
      // Check if participant is a winner in this event
      const myWin = winners.find(w => String(w.studentId) === String(participantId));
      
      return `
        <div class="res-card">
          <div class="res-header" onclick="toggleResult(this)">
            <div>
              <div class="res-cat">${ev.level}</div>
              <div class="res-name">${ev.name}</div>
            </div>
            ${myWin ? '<span class="my-badge">You Won!</span>' : ''}
            <button class="btn-view-res">View</button>
          </div>
          <div class="res-body">
            ${winners.map(w => {
              const student = CACHE.students.find(s => String(s.id) === String(w.studentId));
              const isMe = String(w.studentId) === String(participantId);
              
              return `
                <div class="winner-row ${isMe ? 'my-result' : ''}">
                  <div class="rank-num">${w.position}</div>
                  <div class="winner-info">
                    <div class="winner-name">
                      ${student?.name || w.studentId}
                      ${isMe ? ' <span style="color: #22c55e;">(You)</span>' : ''}
                    </div>
                    <div class="winner-meta">
                      <i class="bi bi-person-circle me-1"></i>ID: ${w.studentId}
                    </div>
                  </div>
                  <div class="winner-points">${w.points || 0} Points</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');
}

// Update Stats
function updateStats() {
  const myRegistrations = CACHE.participations.filter(p => 
    String(p.studentId) === String(participantId)
  );
  
  const myApproved = myRegistrations.filter(p => p.status === 'approved');
  const myResults = CACHE.results.filter(r => 
    String(r.studentId) === String(participantId) && 
    r.published === true
  );
  
  // Calculate total points
  const totalPoints = myResults.reduce((sum, result) => sum + (result.points || 0), 0);

  document.getElementById('statEvents').textContent = myRegistrations.length;
  document.getElementById('statApproved').textContent = myApproved.length;
  document.getElementById('statWins').textContent = myResults.length;
  document.getElementById('statPoints').textContent = totalPoints;
}

// Toggle result expansion - EXACTLY LIKE LEADER PAGE
window.toggleResult = (header) => {
  const body = header.nextElementSibling;
  const btn = header.querySelector('.btn-view-res');
  
  body.classList.toggle('expanded');
  
  if (body.classList.contains('expanded')) {
    btn.innerHTML = '<i class="bi bi-chevron-up me-1"></i> Close';
  } else {
    btn.innerHTML = 'View';
  }
};

// Logout
window.logout = () => {
  sessionStorage.clear();
  window.location.href = "index.html";
};

document.getElementById('logoutBtn').onclick = logout;

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>