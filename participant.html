<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Participant Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 12px; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold text-info">Participant Portal</a>
      <button id="logoutBtn" class="btn btn-outline-danger ms-auto">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </nav>

  <div class="container my-4">

    <h3 class="fw-bold mb-3">Welcome Participant</h3>

    <!-- STUDENT SUMMARY -->
    <div class="row g-3 mb-4">

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Your Name</div>
          <div class="h5" id="studentName">—</div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Chess Number</div>
          <div class="h5" id="studentId">—</div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Attendance</div>
          <div class="h5" id="attendanceStatus">—</div>
        </div>
      </div>

    </div>

    <!-- TEAM SUMMARY -->
    <div class="row g-3 mb-4">

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Team Name</div>
          <div class="h5" id="teamName">—</div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Team Score</div>
          <div class="h5" id="teamScore">0</div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Team Leader</div>
          <div class="h5" id="teamLeader">—</div>
        </div>
      </div>

    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-events">Events</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-participations">My Participations</button></li>
    </ul>

    <div class="tab-content">

      <!-- EVENTS -->
      <div class="tab-pane fade show active" id="tab-events">
        <div class="card p-3">
          <h5 class="mb-3">All Events</h5>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>Type</th>
                  <th>Points</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="eventsTable"></tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- PARTICIPATIONS -->
      <div class="tab-pane fade" id="tab-participations">
        <div class="card p-3">
          <h5 class="mb-3">Your Participations</h5>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>Points</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="participationTable"></tbody>
            </table>
          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, get
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --------------------------
    // AUTH CHECK
    // --------------------------
    const session = sessionStorage.getItem("user");
    if (!session) location.href = "index.html";

    const user = JSON.parse(session);
    if (user.role !== "Participant") location.href = "index.html";

    const studentId = user.studentId;

    // DOM
    const studentNameEl = document.getElementById("studentName");
    const studentIdEl = document.getElementById("studentId");
    const attendanceStatusEl = document.getElementById("attendanceStatus");

    const teamNameEl = document.getElementById("teamName");
    const teamScoreEl = document.getElementById("teamScore");
    const teamLeaderEl = document.getElementById("teamLeader");

    const eventsTable = document.getElementById("eventsTable");
    const participationTable = document.getElementById("participationTable");

    // --------------------------
    // REALTIME LOAD
    // --------------------------
    onValue(ref(db), snapshot => {
      const data = snapshot.val() || {};

      const students = Object.values(data.students || {});
      const teams = Object.values(data.teams || {});
      const events = Object.values(data.events || {});
      const parts = Object.values(data.participations || {});

      // Student Details
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      studentNameEl.textContent = student.name;
      studentIdEl.textContent = student.id;
      attendanceStatusEl.innerHTML =
        student.attendance?.status === "Present"
          ? `<span class="badge bg-success">Present</span>`
          : `<span class="badge bg-danger">Absent</span>`;

      // Team Details
      const team = teams.find(t => t.id === student.teamId);
      if (team) {
        teamNameEl.textContent = team.name;
        teamScoreEl.textContent = team.score || 0;

        const leader = students.find(s => s.id === team.leaderId);
        teamLeaderEl.textContent = leader ? leader.name : "-";
      }

      // EVENTS TABLE
      eventsTable.innerHTML = "";
      events.forEach(e => {
        const pts = e.points ? e.points.join("/") : "0/0/0";
        eventsTable.innerHTML += `
          <tr>
            <td>${e.name}</td>
            <td>${e.type}</td>
            <td>${pts}</td>
            <td><span class="badge bg-secondary">${e.status}</span></td>
          </tr>
        `;
      });

      // PARTICIPATIONS
      participationTable.innerHTML = "";
      const myParts = parts.filter(p => p.studentId === studentId);

      myParts.forEach(p => {
        const event = events.find(e => e.id === p.eventId);
        const pts = event?.points ? event.points.join("/") : "-";

        participationTable.innerHTML += `
          <tr>
            <td>${event ? event.name : "-"}</td>
            <td>${pts}</td>
            <td><span class="badge bg-info">${p.status}</span></td>
          </tr>
        `;
      });

    });

    // --------------------------
    // LOGOUT
    // --------------------------
    document.getElementById("logoutBtn").onclick = () => {
      sessionStorage.clear();
      location.href = "index.html";
    };

  </script>

</body>
</html>
