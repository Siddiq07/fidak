<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Participant Panel | Art Fest</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{
  --primary:#0b2440;
  --accent:#ffb703;
  --card:#ffffff;
  --muted:#64748b;
}

body{
  margin:0;
  background:#f4f7fb;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

.hidden{display:none}

/* HEADER */
.topbar{
  background:var(--primary);
  color:#fff;
  padding:14px 18px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.brand{
  font-size:20px;
  font-weight:800;
}
.brand span{color:var(--accent)}
.logout-btn{
  background:#ef4444;
  border:0;
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
}

/* PROFILE */
.profile{
  background:#fff;
  margin:16px;
  border-radius:16px;
  padding:16px;
}
.profile h4{margin:0;font-weight:800}
.profile small{color:var(--muted)}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:12px;
  margin:16px;
}
.stat-card{
  background:linear-gradient(135deg,#2563eb,#1e40af);
  color:#fff;
  padding:14px;
  border-radius:14px;
}
.stat-card.orange{background:linear-gradient(135deg,#fb923c,#f97316)}
.stat-card.green{background:linear-gradient(135deg,#22c55e,#16a34a)}
.stat-card h2{margin:0;font-weight:800}

/* SECTIONS */
.section{
  margin:16px;
}
.section-title{
  font-size:18px;
  font-weight:800;
  margin-bottom:10px;
}

/* EVENT CARD */
.event-card{
  background:#fff;
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  border-left:6px solid var(--accent);
}
.event-card h5{margin:0;font-weight:800}
.event-meta{
  font-size:13px;
  color:var(--muted);
}

/* RESULT */
.result-row{
  display:flex;
  align-items:center;
  gap:12px;
  margin-top:6px;
}
.rank{
  width:34px;
  height:34px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
}
.rank.gold{background:#fde68a}
.rank.silver{background:#e5e7eb}
.rank.bronze{background:#fbcfe8}

/* MOBILE */
@media(max-width:768px){
  .topbar{flex-direction:column;gap:8px}
}
</style>
</head>

<body>

<!-- ================= HEADER ================= -->
<div class="topbar">
  <div class="brand">Art<span>Fest</span> Participant</div>
  <button class="logout-btn" id="logoutBtn">Logout</button>
</div>

<!-- ================= PROFILE ================= -->
<div class="profile">
  <h4 id="studentName">Student</h4>
  <small>
    Chess No: <b id="studentId"></b> |
    Team: <b id="teamName"></b> |
    Level: <b id="studentLevel"></b>
  </small>
</div>

<!-- ================= STATS ================= -->
<div class="stats">
  <div class="stat-card">
    <span>Events</span>
    <h2 id="statEvents">0</h2>
  </div>
  <div class="stat-card orange">
    <span>Participations</span>
    <h2 id="statParts">0</h2>
  </div>
  <div class="stat-card green">
    <span>Prizes</span>
    <h2 id="statPrizes">0</h2>
  </div>
</div>

<!-- ================= EVENTS ================= -->
<div class="section">
  <div class="section-title">My Events</div>
  <div id="eventList"></div>
</div>

<!-- ================= RESULTS ================= -->
<div class="section">
  <div class="section-title">My Results</div>
  <div id="resultList"></div>
</div>

<!-- ================= FIREBASE ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
 databaseURL:"https://gen7-3e139-default-rtdb.firebaseio.com",
 projectId:"gen7-3e139"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const studentId=sessionStorage.getItem("studentId");
if(!studentId){
 alert("Unauthorized access");
 location.href="index.html";
}

/* PROFILE */
let studentData=null;
let teamMap={};

onValue(ref(db,"teams"),snap=>{
 Object.values(snap.val()||{}).forEach(t=>teamMap[t.id]=t.name);
});

onValue(ref(db,"students"),snap=>{
 Object.values(snap.val()||{}).forEach(s=>{
  if(String(s.id)===String(studentId)){
   studentData=s;
   document.getElementById("studentName").innerText=s.name;
   document.getElementById("studentId").innerText=s.id;
   document.getElementById("studentLevel").innerText=s.level||"-";
   document.getElementById("teamName").innerText=teamMap[s.teamId]||"-";
  }
 });
});

/* EVENTS */
onValue(ref(db,"participations"),snap=>{
 let count=0;
 let parts=0;
 const list=document.getElementById("eventList");
 list.innerHTML="";
 Object.values(snap.val()||{}).forEach(p=>{
  if(String(p.studentId)===String(studentId)){
   count++;
   parts++;
   list.innerHTML+=`
   <div class="event-card">
    <h5>${p.eventName||"Event"}</h5>
    <div class="event-meta">Status: ${p.status}</div>
    <button class="btn btn-sm btn-outline-primary mt-2" onclick="downloadParticipationPdf('${p.eventName}')">
      Download PDF
    </button>
   </div>`;
  }
 });
 document.getElementById("statEvents").innerText=count;
 document.getElementById("statParts").innerText=parts;
});

/* RESULTS */
onValue(ref(db,"results"),snap=>{
 let prizes=0;
 const list=document.getElementById("resultList");
 list.innerHTML="";
 Object.values(snap.val()||{}).forEach(r=>{
  let rank=null;
  if(r.firstId==studentId) rank=1;
  if(r.secondId==studentId) rank=2;
  if(r.thirdId==studentId) rank=3;

  if(rank){
   prizes++;
   list.innerHTML+=`
   <div class="event-card">
    <h5>${r.eventName}</h5>
    <div class="result-row">
     <div class="rank ${rank==1?"gold":rank==2?"silver":"bronze"}">${rank}</div>
     <div>You secured ${rank}${rank==1?"st":rank==2?"nd":"rd"} position</div>
    </div>
   </div>`;
  }
 });
 document.getElementById("statPrizes").innerText=prizes;
});

/* PDF */
window.downloadParticipationPdf=(event)=>{
 const html=`
 <h3>Participation Certificate</h3>
 <p>Name: ${studentData.name}</p>
 <p>Chess No: ${studentData.id}</p>
 <p>Event: ${event}</p>
 `;
 html2pdf().from(html).set({filename:`${event}_participation.pdf`}).save();
};

/* LOGOUT */
document.getElementById("logoutBtn").onclick=()=>{
 sessionStorage.clear();
 location.href="index.html";
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>