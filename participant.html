<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Participant Dashboard — Art Fest</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
:root{
  --bg:#f1f5ff;
  --card:#ffffff;
  --muted:#6b7280;
  --accent:#2563eb;
  --accent-2:#7c3aed;
}
body{
  background:linear-gradient(180deg,#eaf2ff,#f7faff);
  font-family:Inter,system-ui,-apple-system;
}
.container-wide{max-width:1100px;margin:20px auto;padding:0 16px;}

.navbar{
  background:#fff;border-bottom:1px solid #e5e9f5;
  box-shadow:0 4px 18px rgba(0,0,0,0.05);
}

.card-neo{
  background:var(--card);
  border-radius:12px;
  padding:16px;
  margin-bottom:18px;
  box-shadow:0 8px 22px rgba(0,0,0,0.06);
}

.section-title{
  font-weight:800;
  margin-bottom:6px;
}

.info-box{
  padding:10px;border-radius:10px;
  background:#f0f4ff;
  margin-bottom:10px;
}

.big-number{
  font-size:32px;font-weight:900;color:var(--accent);
}

.event-row{
  padding:10px;border-bottom:1px solid #eef2ff;
}
.result-badge{
  padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700;
}
</style>
</head>


<body>
<nav class="navbar px-3">
  <div class="container-fluid">
    <div class="navbar-brand fw-bold text-primary"><i class="bi bi-palette-fill"></i> Art Fest — Participant</div>
    <button onclick="logout()" class="btn btn-outline-danger btn-sm">Logout</button>
  </div>
</nav>

<main class="container-wide">

  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:10000"></div>

  <!-- PARTICIPANT HEADER -->
  <div class="card-neo">
    <div class="d-flex justify-content-between">
      <div>
        <div class="section-title">Welcome, <span id="pName">Participant</span></div>
        <div class="text-muted">Chess #: <span id="pChess"></span></div>
        <div class="text-muted">Team: <span id="pTeam"></span></div>
        <div class="text-muted">Level: <span id="pLevel"></span></div>
      </div>

      <div class="text-end">
        <div class="text-muted">Team Score:</div>
        <div id="teamScore" class="big-number">0</div>
      </div>
    </div>
  </div>

  <!-- ATTENDANCE -->
  <div class="card-neo">
    <div class="section-title">Attendance</div>
    <div class="info-box">
      <div class="d-flex justify-content-between">
        <div class="fw-bold">Attendance %</div>
        <div id="attPercent" class="big-number">0%</div>
      </div>
    </div>
    <canvas id="attChart" height="120"></canvas>
  </div>

  <!-- PARTICIPATION -->
  <div class="card-neo">
    <div class="section-title">Your Events</div>
    <div id="eventList"></div>
  </div>

  <!-- RESULTS -->
  <div class="card-neo">
    <div class="section-title">Results</div>
    <div id="resultsList"></div>
  </div>

</main>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">

/* ----------------------- FIREBASE INIT ------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
};
const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

const $ = id => document.getElementById(id);

/* ------------------- AUTO-DETECT PARTICIPANT ------------------ */
function getChess() {
  const q = new URL(location.href).searchParams.get("chess");
  if (q) return q;
  try {
    const user = JSON.parse(sessionStorage.getItem("user") || "{}");
    if (user.role === "Participant") return user.studentId;
  } catch {}
  return null;
}

let CHESS = getChess();
if (!CHESS) {
  alert("Login required!");
  location.href = "index.html";
}

$("pChess").textContent = CHESS;

/* ------------------- LOAD ALL NECESSARY DATA ------------------ */
let STUDENT = null;
let TEAM = null;
let EVENTS = [];
let PARTS = [];
let RESULTS = [];
let ATT = {};

onValue(ref(db, "students"), snap=>{
  const obj = snap.val() || {};
  STUDENT = Object.values(obj).find(s => String(s.id) === String(CHESS));
  if (!STUDENT) {
    alert("Participant not found"); location.href="index.html";
  }

  $("pName").textContent = STUDENT.name || CHESS;
  $("pLevel").textContent = STUDENT.level || "-";

  loadTeam();
  renderParticipation();
  renderResults();
  computeAttendance();
});

function loadTeam(){
  onValue(ref(db,"teams"), snap=>{
    const obj = snap.val() || {};
    TEAM = Object.values(obj).find(t => String(t.id) === String(STUDENT.teamId));
    $("pTeam").textContent = TEAM ? TEAM.name : "-";
    $("teamScore").textContent = TEAM ? (TEAM.score || 0) : 0;
  });
}

onValue(ref(db,"events"), snap=>{ EVENTS = Object.values(snap.val() || {}); renderParticipation(); renderResults(); });
onValue(ref(db,"participations"), snap=>{ PARTS = Object.values(snap.val() || {}); renderParticipation(); });
onValue(ref(db,"results"), snap=>{ RESULTS = Object.values(snap.val() || {}); renderResults(); });
onValue(ref(db,"attendance"), snap=>{ ATT = snap.val() || {}; computeAttendance(); });

/* ----------------------- PARTICIPATION ------------------------ */
function renderParticipation(){
  const wrap = $("eventList");
  wrap.innerHTML = "";

  const myParts = PARTS.filter(p => String(p.studentId) === String(CHESS));

  if (!myParts.length) {
    wrap.innerHTML = '<div class="text-muted">No events registered.</div>';
    return;
  }

  myParts.forEach(p=>{
    const ev = EVENTS.find(e=> String(e.id)===String(p.eventId)) || {};
    wrap.innerHTML += `
      <div class="event-row">
        <div class="fw-bold">${ev.name || p.eventId}</div>
        <div class="text-muted">${ev.type || ''} • ${ev.level || ''}</div>
        <div>Status: <span class="badge ${p.status==='approved'?'bg-success':'bg-warning'}">${p.status}</span></div>
      </div>`;
  });
}

/* --------------------------- RESULTS -------------------------- */
function renderResults(){
  const wrap = $("resultsList");
  wrap.innerHTML = "";

  const myRes = RESULTS.filter(r => String(r.studentId) === String(CHESS));

  if (!myRes.length){
    wrap.innerHTML = '<div class="text-muted">No results yet.</div>';
    return;
  }

  myRes.forEach(r=>{
    const ev = EVENTS.find(e=>String(e.id)===String(r.eventId)) || {};
    wrap.innerHTML += `
      <div class="event-row">
        <div class="fw-bold">${ev.name || r.eventId}</div>
        <div class="result-badge bg-primary text-white">Position: ${r.position}</div>
      </div>`;
  });
}

/* ------------------------ ATTENDANCE % ------------------------ */
function computeAttendance(){
  if (!STUDENT) return;
  let total = 0, present = 0;

  Object.values(ATT).forEach(sess=>{
    if (sess.students && sess.students[CHESS] !== undefined) {
      total++;
      if (String(sess.students[CHESS]).toLowerCase()==="present") present++;
    }
  });

  const pct = total === 0 ? 0 : Math.round((present/total)*100);
  $("attPercent").textContent = pct+"%";

  drawAttendanceChart(pct);
}

/* --------------------- CHART FOR ATTENDANCE ------------------- */
let attChart;
function drawAttendanceChart(pct){
  if (attChart) attChart.destroy();
  attChart = new Chart($("attChart"), {
    type:"doughnut",
    data:{
      labels:["Present","Absent"],
      datasets:[{
        data:[pct, 100-pct],
        backgroundColor:["#2563eb","#cbd5e1"],
        borderWidth:0
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      cutout:"70%"
    }
  });
}

/* ----------------------------- LOGOUT -------------------------- */
window.logout = function(){
  sessionStorage.removeItem("user");
  location.href="index.html";
}

/* ---------------------------- TOAST ---------------------------- */
function toast(msg){
  const box = document.createElement("div");
  box.className="toast align-items-center text-bg-primary border-0";
  box.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div>
  <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
  $("toastRoot").appendChild(box);
  const bs = new bootstrap.Toast(box, {delay:3000}); bs.show();
}

</script>
</body>
</html>