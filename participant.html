<!-- participant.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Participant — Art Fest (Live Scores)</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <!-- Chart.js for live chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Firebase -->
  <script type="module" defer>
    // Firebase will be imported later inside the page script (module)
  </script>

  <style>
    :root{
      --bg: #0f172a;
      --card: linear-gradient(180deg,#0b1220 0%, #07102a 100%);
      --muted: #94a3b8;
      --accent: #5eead4;
      --accent-2: #60a5fa;
      --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02);
    }
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;color:#e6eef8;background:linear-gradient(180deg,#07102a 0%, #041025 100%);}
    .container-wide{max-width:1150px;margin:18px auto;padding:0 14px}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    .brand{font-weight:800;color:var(--accent-2);display:flex;align-items:center;gap:10px}
    .card-neo{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:14px;box-shadow:0 10px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .muted{color:var(--muted)}
    .profile-avatar{width:72px;height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#053048}
    .stat {background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    .big-num{font-weight:900;font-size:28px;color:var(--accent)}
    .small-muted{color:var(--muted);font-size:13px}
    .pill {padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:700}
    .event-box{border-radius:10px;padding:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px}
    .selected { box-shadow:0 6px 24px rgba(96,165,250,0.12); transform: translateY(-3px); }
    .small-box { width:56px;height:44px;border-radius:8px;background:var(--glass);display:flex;align-items:center;justify-content:center;margin:6px;cursor:pointer;border:1px solid rgba(255,255,255,0.02);font-weight:700;color:#dff8ff}
    .small-box:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .badge-pos { font-weight:800;padding:4px 8px;border-radius:8px;background:rgba(255,255,255,0.03); color:var(--accent); }
    /* animated progress circle */
    .radial { width:95px;height:95px;border-radius:50%;display:grid;place-items:center;background:conic-gradient(var(--accent) var(--pct), rgba(255,255,255,0.03) 0);border:6px solid rgba(255,255,255,0.03) }
    .radial-inner { width:70px;height:70px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));font-weight:800}
    /* responsive */
    @media (max-width:900px){ .grid-3 { flex-direction:column } .small-box{width:46px;height:40px} .profile-avatar{width:56px;height:56px;font-size:18px} }
    /* subtle glow for chart panel */
    .chart-panel{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03)}
  </style>
</head>
<body>
  <div class="container container-wide">
    <div class="topbar mb-3">
      <div class="brand"><span class="badge bg-white text-dark rounded-pill"><i class="bi bi-palette-fill"></i></span>&nbsp;<div style="display:inline-block">Art Fest — Participant</div></div>
      <div class="d-flex gap-2 align-items-center">
        <div class="small-muted">Live Scoreboard</div>
        <button id="btnLogout" class="btn btn-outline-light btn-sm">Logout</button>
      </div>
    </div>

    <div class="row g-3">
      <!-- left column: profile + stats -->
      <div class="col-lg-4">
        <div class="card-neo mb-3">
          <div class="d-flex gap-3 align-items-center">
            <div id="avatar" class="profile-avatar">P</div>
            <div style="flex:1">
              <div id="pName" style="font-weight:800;font-size:18px">Guest Participant</div>
              <div id="pChess" class="muted">Chess #: —</div>
              <div class="mt-2 small-muted" id="pTeam">Team: —</div>
            </div>
          </div>

          <hr style="border-color:rgba(255,255,255,0.03)">

          <div class="d-flex gap-2 grid-3">
            <div class="stat" style="flex:1">
              <div class="small-muted">Team Score</div>
              <div id="scoreNumber" class="big-num">0</div>
              <div class="small-muted">Live & updated</div>
            </div>
            <div class="stat" style="flex:1;text-align:center">
              <div class="small-muted">Attendance</div>
              <div id="attRadial" class="radial" style="--pct:0deg">
                <div class="radial-inner"><div id="attPct" style="font-size:18px">0%</div></div>
              </div>
              <div class="small-muted">Team presence</div>
            </div>
          </div>

          <hr style="border-color:rgba(255,255,255,0.03)">

          <div>
            <div class="small-muted">Quick actions</div>
            <div class="d-flex gap-2 mt-2">
              <button id="btnViewSubs" class="btn btn-sm btn-outline-light">My Submissions</button>
              <button id="btnRefresh" class="btn btn-sm btn-accent">Refresh</button>
            </div>
          </div>
        </div>

        <div class="card-neo">
          <div class="small-muted">My Events & Results</div>
          <div id="eventsList" style="max-height:360px;overflow:auto;margin-top:10px"></div>
        </div>
      </div>

      <!-- right column: chart + full leaderboard -->
      <div class="col-lg-8">
        <div class="card-neo mb-3 chart-panel">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div style="font-weight:800">Live Leaderboard</div>
              <div class="small-muted">Top teams — updates when admin publishes results</div>
            </div>
            <div class="small-muted" id="lastUpdated">—</div>
          </div>
          <canvas id="teamsChart" style="height:260px; width:100%"></canvas>
        </div>

        <div class="card-neo">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Team Members</div>
            <div class="small-muted">Click chess # to see name</div>
          </div>
          <div id="membersWrap" style="padding-top:12px;display:flex;flex-wrap:wrap"></div>
        </div>
      </div>
    </div>

    <div id="toastRoot" style="position:fixed;right:18px;bottom:18px;z-index:12000"></div>
  </div>

  <!-- Bootstrap + Firebase (module) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, onValue, get } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
    authDomain: "gen7-3e139.firebaseapp.com",
    databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
    projectId: "gen7-3e139",
    storageBucket: "gen7-3e139.firebasestorage.app",
    messagingSenderId: "578412378966",
    appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
    measurementId: "G-QLW5J1HK94"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------- HELPERS ----------
  const $ = id => document.getElementById(id);
  function toast(msg, type='light') {
    const t = document.createElement('div');
    t.className = 'toast align-items-center text-bg-' + (type==='light'?'dark':type) + ' border-0';
    t.style.minWidth = '220px';
    t.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    $('toastRoot').appendChild(t);
    const bs = new bootstrap.Toast(t,{delay:3500}); bs.show();
    t.addEventListener('hidden.bs.toast', ()=> t.remove());
  }
  function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function encodeKey(k){ return encodeURIComponent(String(k)); }
  function decodeKey(k){ return decodeURIComponent(String(k)); }

  // ---------- STATE ----------
  let CACHE = { teams: [], students: [], events: [], participations: [], results: [], attendance: {} };
  let KEYMAP = {}; // dbkey mapping optional
  let ME = { id:null, name:null, teamId:null, teamDbKey:null };

  // ---------- ELEMENTS ----------
  const avatar = $('avatar'), pName = $('pName'), pChess = $('pChess'), pTeam = $('pTeam');
  const scoreNumber = $('scoreNumber'), attPctEl = $('attPct'), attRadial = $('attRadial');
  const eventsList = $('eventsList'), membersWrap = $('membersWrap');
  const lastUpdated = $('lastUpdated');

  // chart setup
  const ctx = $('teamsChart').getContext('2d');
  let teamsChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: [], datasets: [{ label:'Score', data:[], backgroundColor: [], borderRadius:8, maxBarThickness:40 }] },
    options: {
      indexAxis: 'y',
      animation: { duration: 700 },
      plugins: { legend: { display:false }, tooltip: { callbacks: { label: ctx => ` ${ctx.formattedValue} pts` } } },
      scales: { x: { grid: { color:'rgba(255,255,255,0.03)' }, ticks:{color:'#cfe9ff'} }, y: { ticks:{color:'#cfe9ff'} } }
    }
  );

  // ---------- DB LISTENERS ----------
  const teamsRef = ref(db, 'teams');
  const studentsRef = ref(db, 'students');
  const eventsRef = ref(db, 'events');
  const partsRef = ref(db, 'participations');
  const resultsRef = ref(db, 'results');
  const attendanceRef = ref(db, 'attendance');

  onValue(teamsRef, snap => {
    const obj = snap.val() || {};
    CACHE.teams = Object.values(obj);
    // store db keys mapping (for updates etc)
    KEYMAP.teams = {};
    Object.entries(obj).forEach(([k,v]) => { if(v && v.id!==undefined) KEYMAP.teams[String(v.id)] = k; });
    renderLeaderboard();
    renderMembers();
  });

  onValue(studentsRef, snap => { CACHE.students = Object.values(snap.val() || {}); renderProfileIfReady(); renderMembers(); renderEventsForMe(); });

  onValue(eventsRef, snap => { CACHE.events = Object.values(snap.val() || {}); renderEventsForMe(); });

  onValue(partsRef, snap => { CACHE.participations = Object.values(snap.val() || {}); renderEventsForMe(); computeQuickStats(); });

  onValue(resultsRef, snap => { CACHE.results = Object.values(snap.val() || {}); renderEventsForMe(); renderLeaderboard(); computeQuickStats(); });

  onValue(attendanceRef, snap => { CACHE.attendance = snap.val() || {}; updateAttendanceUI(); });

  // ---------- IDENTITY (query param OR session) ----------
  function detectParticipant() {
    // 1) URL param ?chess=
    const url = new URL(location.href);
    const q = url.searchParams.get('chess') || url.searchParams.get('leader') || null;
    if(q) {
      setMeByChess(q);
      return;
    }
    // 2) sessionStorage.user
    try {
      const u = sessionStorage.getItem('user');
      if(u) {
        const parsed = JSON.parse(u);
        if(parsed.role === 'Participant' && parsed.studentId) { setMeByChess(parsed.studentId); return; }
        if(parsed.role === 'Leader' && parsed.teamId) {
          // optional: show leader-as-participant behaviour (not used here)
        }
      }
    } catch(e){}
    // 3) not found -> redirect to index (you may change behavior)
    // Keep user on page but show guest message
    renderGuest();
  }

  function setMeByChess(chess) {
    const normalized = String(chess).trim();
    const student = CACHE.students.find(s => String(s.id) === normalized || String(s.chess) === normalized) || null;
    if(student) {
      ME.id = String(student.id || normalized);
      ME.name = student.name || 'Participant';
      ME.teamId = student.teamId || null;
      // attempt to find team dbKey
      ME.teamDbKey = ME.teamId && KEYMAP.teams ? KEYMAP.teams[ME.teamId] : null;
      renderProfileIfReady();
      renderMembers();
      renderEventsForMe();
      computeQuickStats();
    } else {
      // student not yet loaded? Wait a bit — try after caches update.
      // Show guest until data arrives
      ME.id = normalized;
      ME.name = 'Unknown';
      renderProfileIfReady();
      // if student doesn't appear in 3s, show toast
      setTimeout(()=> {
        const found = CACHE.students.find(s => String(s.id) === normalized);
        if(!found) toast('Participant not found in database (check chess number)', 'danger');
      }, 2500);
    }
  }

  function renderGuest(){
    ME = { id:null, name:'Guest', teamId:null, teamDbKey:null };
    renderProfileIfReady();
    renderMembers();
    renderEventsForMe();
  }

  // ---------- RENDER PROFILE ----------
  function renderProfileIfReady(){
    avatar.textContent = (ME.name || 'G').slice(0,1).toUpperCase();
    pName.textContent = ME.name || 'Guest';
    pChess.textContent = ME.id ? `Chess #: ${ME.id}` : 'Chess #: —';
    if(ME.teamId) pTeam.innerHTML = `Team: <span class="pill">${escapeHtml(getTeamName(ME.teamId) || ME.teamId)}</span>`;
    else pTeam.textContent = 'Team: —';
    // update score if team known
    updateTeamScoreUI();
  }

  function getTeamName(tid){
    const t = CACHE.teams.find(x => String(x.id) === String(tid));
    return t ? t.name : null;
  }

  // ---------- RENDER MEMBERS (team) ----------
  function renderMembers(){
    membersWrap.innerHTML = '';
    if(!ME.teamId) { membersWrap.innerHTML = '<div class="small-muted">No team selected (open from login)</div>'; return; }
    const members = CACHE.students.filter(s => String(s.teamId) === String(ME.teamId));
    if(!members.length) { membersWrap.innerHTML = '<div class="small-muted">No members found</div>'; return; }
    members.forEach(m => {
      const b = document.createElement('div');
      b.className = 'small-box';
      b.dataset.id = m.id;
      b.title = m.name || m.id;
      b.innerHTML = `<div>${escapeHtml(m.id)}</div>`;
      b.addEventListener('click', ()=> showMemberName(m));
      membersWrap.appendChild(b);
    });
  }
  function showMemberName(m) { toast(`${m.name} — ${m.id}`, 'light'); }

  // ---------- EVENTS for this participant (and their results) ----------
  function renderEventsForMe(){
    eventsList.innerHTML = '';
    if(!ME.id) { eventsList.innerHTML = '<div class="small-muted">No participant selected</div>'; return; }
    // find participations with studentId
    const parts = CACHE.participations.filter(p => String(p.studentId) === String(ME.id));
    if(!parts.length) { eventsList.innerHTML = '<div class="small-muted">No event submissions</div>'; return; }
    // Show per participation: event name, status, if result exists show 1/2/3
    parts.sort((a,b)=> (b.submittedAt||0) - (a.submittedAt||0));
    parts.forEach(p => {
      const ev = CACHE.events.find(e => String(e.id) === String(p.eventId)) || { name: p.eventId };
      const container = document.createElement('div');
      container.className = 'event-box';
      // find if student has a result in this event
      const r = CACHE.results.find(rr => String(rr.eventId) === String(p.eventId) && String(rr.studentId) === String(ME.id) );
      const positionLabel = r ? (r.position===1? '1st' : r.position===2? '2nd' : r.position===3? '3rd' : `Pos ${r.position}`) : '-';
      const pointsLabel = r ? `${Number(r.points||0)} pts` : '';
      const status = p.status || 'pending';
      container.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800">${escapeHtml(ev.name)}</div>
            <div class="small-muted">${escapeHtml(ev.type||'')} · ${escapeHtml(ev.level||'')}</div>
          </div>
          <div style="text-align:right">
            <div class="small-muted">Status</div>
            <div style="font-weight:800">${escapeHtml(status)}</div>
            <div style="margin-top:6px">${ r ? `<span class="badge-pos">${positionLabel}</span> <div class="small-muted">${pointsLabel}</div>` : '' }</div>
          </div>
        </div>
      `;
      eventsList.appendChild(container);
    });
  }

  // ---------- LEADERBOARD (chart) ----------
  function renderLeaderboard(){
    // build array of teams sorted by score desc
    const arr = (CACHE.teams || []).slice().sort((a,b)=> Number(b.score||0) - Number(a.score||0));
    // limit top 8
    const top = arr.slice(0,8);
    const labels = top.map(t => t.name || t.id);
    const data = top.map(t => Number(t.score||0));
    const colors = top.map((t,i) => i===0 ? 'rgba(94,234,212,0.95)' : `rgba(96,165,250,${0.18 + (0.06*i)})`);
    teamsChart.data.labels = labels;
    teamsChart.data.datasets[0].data = data;
    teamsChart.data.datasets[0].backgroundColor = colors;
    teamsChart.update();
    $('lastUpdated').textContent = new Date().toLocaleTimeString();
    renderProfileIfReady();
  }

  // ---------- TEAM SCORE UI ----------
  let lastScore = null;
  function updateTeamScoreUI(){
    if(!ME.teamId) { scoreNumber.textContent = '0'; return; }
    const team = CACHE.teams.find(t => String(t.id) === String(ME.teamId));
    const val = team ? Number(team.score || 0) : 0;
    // animated numeric change
    animateNumber(scoreNumber, lastScore || 0, val, 700);
    lastScore = val;
  }
  function animateNumber(el, from, to, duration=600){
    from = Number(from)||0; to = Number(to)||0;
    if(from === to){ el.textContent = String(to); return; }
    const start = performance.now();
    function step(now){
      const t = Math.min(1, (now - start)/duration);
      const ease = t < .5 ? 2*t*t : -1 + (4 - 2*t)*t;
      const v = Math.round(from + (to - from) * ease);
      el.textContent = v;
      if(t < 1) requestAnimationFrame(step);
      else el.textContent = String(to);
    }
    requestAnimationFrame(step);
  }

  // ---------- ATTENDANCE: compute team attendance percentage ----------
  function updateAttendanceUI(){
    const pct = computeTeamAttendancePercent();
    // set radial CSS variable via degrees (360 * pct/100)
    const deg = Math.round((pct/100) * 360);
    attRadial.style.setProperty('--pct', deg + 'deg');
    attPctEl.textContent = pct + '%';
  }
  function computeTeamAttendancePercent(){
    if(!ME.teamId) return 0;
    const members = CACHE.students.filter(s => String(s.teamId) === String(ME.teamId)).map(s => String(s.id));
    if(!members.length) return 0;
    const att = CACHE.attendance || {};
    let present = 0, total = 0;
    Object.values(att).forEach(sess => {
      if(!sess || !sess.students) return;
      members.forEach(mid => {
        if(sess.students[mid] !== undefined){
          total++;
          if(String(sess.students[mid]).toLowerCase() === 'present') present++;
        }
      });
    });
    if(total === 0) return 0;
    return Math.round((present/total) * 100);
  }

  // ---------- QUICK STATS recompute on changes ----------
  function computeQuickStats(){
    // refresh attendance and numbers
    updateAttendanceUI();
    renderEventsForMe();
    updateTeamScoreUI();
  }

  // ---------- Utilities ----------
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

  // ---------- Button wiring ----------
  $('btnRefresh').addEventListener('click', ()=> { computeQuickStats(); toast('Refreshed'); });
  $('btnViewSubs').addEventListener('click', ()=> {
    // open a small modal-like listing via toast area (quick)
    const subs = CACHE.participations.filter(p => String(p.teamId) === String(ME.teamId));
    if(!subs.length) { toast('No submissions for your team', 'warning'); return; }
    const html = subs.map(s => {
      const ev = CACHE.events.find(e => String(e.id) === String(s.eventId)) || {};
      return `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${escapeHtml(ev.name||s.eventId)}</strong><div class="small-muted">${escapeHtml(s.studentId)} — ${escapeHtml(s.status||'')}</div></div>`;
    }).join('');
    // Use html2pdf not needed; simple popup window:
    const w = window.open('', '_blank', 'width=520,height=640');
    w.document.body.style.background = '#07102a';
    w.document.body.style.color = '#e6eef8';
    w.document.body.innerHTML = `<div style="padding:16px"><h3>Your Team Submissions</h3>${html}</div>`;
  });

  $('btnLogout').addEventListener('click', ()=> {
    sessionStorage.removeItem('user');
    // return to index
    window.location.href = 'index.html';
  });

  // ---------- START ----------
  // detect participant after small delay so listeners may populate caches
  setTimeout(()=> detectParticipant(), 600);

  // also re-evaluate when caches update
  // for safety compute quick stats periodically
  setInterval(()=> computeQuickStats(), 5000);

  // expose internals for debug
  window._PARTICIPANT = { CACHE, ME };

  </script>
</body>
</html>