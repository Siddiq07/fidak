<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team Leader Portal</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    body { background: #f8f9fa; }
    .card { border-radius: 12px; }
    .member-row { cursor: pointer; }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-white shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold text-primary">Team Leader Portal</a>
      <button id="logoutBtn" class="btn btn-outline-danger ms-auto">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>
  </nav>

  <div class="container my-4">

    <h3 class="fw-bold mb-3">Welcome, Team Leader</h3>

    <!-- TEAM SUMMARY -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Team Name</div>
          <div class="h5" id="teamName">—</div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Leader</div>
          <div class="h5" id="leaderName">—</div>
        </div>
      </div>

      <div class="col-md-4">
        <div class="card p-3">
          <div class="text-muted small">Team Score</div>
          <div class="h5" id="teamScore">0</div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-members">Team Members</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-events">Events</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-participations">Participations</button></li>
    </ul>

    <div class="tab-content">

      <!-- MEMBERS -->
      <div class="tab-pane fade show active" id="tab-members">
        <div class="card p-3">
          <h5 class="mb-3">Team Members</h5>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Chess #</th>
                  <th>Name</th>
                  <th>Attendance</th>
                </tr>
              </thead>
              <tbody id="membersTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="tab-pane fade" id="tab-events">
        <div class="card p-3">
          <h5 class="mb-3">Events List</h5>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>Type</th>
                  <th>Points</th>
                </tr>
              </thead>
              <tbody id="eventsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PARTICIPATIONS -->
      <div class="tab-pane fade" id="tab-participations">
        <div class="card p-3">
          <h5 class="mb-3">Submit Participation</h5>

          <form id="submitParticipationForm" class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Select Member</label>
              <select id="selectMember" class="form-select"></select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Select Event</label>
              <select id="selectEvent" class="form-select"></select>
            </div>

            <div class="col-md-4">
              <button class="btn btn-primary w-100 mt-4" type="submit">
                <i class="bi bi-plus-circle"></i> Submit
              </button>
            </div>
          </form>

          <hr>

          <h5 class="mb-3">Your Team Participations</h5>

          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>Event</th>
                  <th>Student</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="participationTable"></tbody>
            </table>
          </div>

        </div>
      </div>

    </div>

  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, set, get
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
      measurementId: "G-QLW5J1HK94"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --------------------------
    // AUTH CHECK
    // --------------------------
    const session = sessionStorage.getItem("user");
    if (!session) location.href = "index.html";

    const user = JSON.parse(session);
    if (user.role !== "Leader") location.href = "index.html";

    const leaderId = user.leaderId;
    const teamId = user.teamId;

    // DOM
    const teamNameEl = document.getElementById("teamName");
    const leaderNameEl = document.getElementById("leaderName");
    const teamScoreEl = document.getElementById("teamScore");

    const membersTable = document.getElementById("membersTable");
    const eventsTable = document.getElementById("eventsTable");
    const participationTable = document.getElementById("participationTable");

    const selectMember = document.getElementById("selectMember");
    const selectEvent = document.getElementById("selectEvent");

    // --------------------------
    // REALTIME LOAD
    // --------------------------
    onValue(ref(db), snapshot => {
      const data = snapshot.val() || {};

      const students = Object.values(data.students || {});
      const teams = Object.values(data.teams || {});
      const events = Object.values(data.events || {});
      const parts = Object.values(data.participations || {});

      const team = teams.find(t => t.id === teamId);
      if (!team) return;

      // TEAM HEADER
      teamNameEl.textContent = team.name;
      teamScoreEl.textContent = team.score || 0;

      const leader = students.find(s => s.id === leaderId);
      leaderNameEl.textContent = leader ? leader.name : "-";

      // TEAM MEMBERS
      const members = students.filter(s => s.teamId === teamId);

      membersTable.innerHTML = "";
      selectMember.innerHTML = `<option value="">Select member</option>`;
      members.forEach(s => {
        const status = s.attendance?.status || "Absent";
        const row = `
          <tr>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td><span class="badge ${status === "Present" ? "bg-success" : "bg-danger"}">${status}</span></td>
          </tr>`;
        membersTable.innerHTML += row;

        selectMember.innerHTML += `<option value="${s.id}">${s.name} (${s.id})</option>`;
      });

      // EVENTS
      eventsTable.innerHTML = "";
      selectEvent.innerHTML = `<option value="">Select event</option>`;
      events.forEach(e => {
        const pts = e.points ? e.points.join("/") : "0/0/0";
        eventsTable.innerHTML += `
          <tr>
            <td>${e.name}</td><td>${e.type}</td><td>${pts}</td>
          </tr>`;
        if (e.status !== "Completed")
          selectEvent.innerHTML += `<option value="${e.id}">${e.name}</option>`;
      });

      // PARTICIPATIONS
      participationTable.innerHTML = "";
      const myParts = parts.filter(p => p.teamId === teamId);

      myParts.forEach(p => {
        const event = events.find(e => e.id === p.eventId);
        const student = students.find(s => s.id === p.studentId);
        participationTable.innerHTML += `
          <tr>
            <td>${event ? event.name : "-"}</td>
            <td>${student ? student.name : "-"}</td>
            <td><span class="badge bg-secondary">${p.status}</span></td>
          </tr>
        `;
      });

    });

    // --------------------------
    // SUBMIT PARTICIPATION
 
    document.getElementById("submitParticipationForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const studentId = selectMember.value;
      const eventId = selectEvent.value;

      if (!studentId || !eventId) {
        alert("Select member and event!");
        return;
      }

      // Push participation
      const partRef = push(ref(db, "participations"));
      await set(partRef, {
        id: Date.now(),
        teamId,
        leaderId,
        studentId: Number(studentId),
        eventId: Number(eventId),
        status: "Pending",
        submittedAt: Date.now()
      });

      alert("Participation submitted!");
      selectMember.value = "";
      selectEvent.value = "";
    });

    // --------------------------
    // LOGOUT
    
    document.getElementById("logoutBtn").onclick = () => {
      sessionStorage.clear();
      location.href = "index.html";
    };
  </script>

</body>
</html>
