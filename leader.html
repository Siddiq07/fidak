<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader â€” Art Fest</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f8ff; --card:#ffffff; --muted:#6b7280;
      --accent:#2563eb; --accent-2:#7c3aed;
      --success:#10b981; --danger:#ef4444;
    }
    html,body{margin:0;background:var(--bg);font-family:Inter,system-ui;color:#0f172a;}

    .top-nav{background:#fff;border-bottom:1px solid #e8eefb;
             box-shadow:0 4px 12px rgba(12,20,60,0.03);}
    .brand{font-weight:800;color:var(--accent);font-size:18px;}

    .nav-btn.active{
      background:#e9efff;font-weight:700;
      border-bottom:3px solid var(--accent);
    }

    .card-neo{background:#fff;padding:14px;border-radius:12px;
              box-shadow:0 6px 16px rgba(0,0,0,0.05);margin-bottom:14px;}
    .muted-small{color:var(--muted);font-size:13px;}

    .leader-avatar{width:48px;height:48px;border-radius:10px;
                   background:#eef2ff;display:flex;align-items:center;
                   justify-content:center;color:var(--accent);font-weight:800;}

    .error-box{
      background:#fff4f4;border-left:4px solid #ff4343;
      padding:12px;border-radius:8px;
      margin-bottom:14px;
    }
  </style>
</head>
<body>

<!-- â–‘â–‘ TOP NAVBAR â–‘â–‘ -->
<nav class="top-nav">
  <div class="container d-flex justify-content-between align-items-center py-2">

    <div class="d-flex align-items-center gap-3">
      <div class="brand d-flex align-items-center gap-2">
        <i class="bi bi-palette-fill fs-4"></i> Art Fest
      </div>
      <div class="muted-small d-none d-md-block">Leader Panel</div>
    </div>

    <!-- LOGOUT BUTTON (updated) -->
    <button id="leaderLogout" class="btn btn-outline-danger">
      <i class="bi bi-box-arrow-right"></i> Logout
    </button>

  </div>

  <!-- NAV BUTTONS -->
  <div class="container d-flex gap-2 py-2">
    <button class="btn btn-light nav-btn active" data-target="#panel-dashboard">Dashboard</button>
    <button class="btn btn-light nav-btn" data-target="#panel-events">Events</button>
    <button class="btn btn-light nav-btn" data-target="#panel-results">Results</button>
    <button class="btn btn-light nav-btn" data-target="#panel-team">Team</button>
  </div>
</nav>

<main class="container mt-3">

  <!-- LEADER NOT DETECTED MESSAGE -->
  <div id="notLeaderMsg" class="error-box d-none">
    <div style="font-weight:700;font-size:17px;">Leader Not Detected</div>
    <div class="muted-small mt-1">
      Please open the Leader Page through the Home Login.<br>
      Login using your <b>Chess Number</b> and <b>Team Password</b>.<br><br>
      After login, you will be redirected as:  
      <code>leader.html?leader=CHESS</code>
    </div>
  </div>

  <div id="leaderPanels">
  <!-- PART 2 -->
<!-- DASHBOARD -->
<section id="panel-dashboard" class="card-neo d-none">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <div class="leader-info">
        <div id="leaderAvatar" class="leader-avatar">L</div>
        <div>
          <div id="leaderName" style="font-weight:800">â€“</div>
          <div id="leaderTeamName" class="muted-small">Team: â€“</div>
        </div>
      </div>
      <div id="lockedBanner" class="locked-banner d-none mt-3">
        Your team is locked by admin. Please contact admin.
      </div>
    </div>

    <div style="min-width:220px">
      <div class="stats-grid">
        <div class="stat">
          <div class="muted-small">Team Score</div>
          <div id="statScore" class="big">0</div>
        </div>
        <div class="stat">
          <div class="muted-small">Attendance %</div>
          <div id="statAttendance" class="big">0%</div>
        </div>
        <div class="stat">
          <div class="muted-small">Members</div>
          <div id="statMembers" class="big">0</div>
        </div>
      </div>

      <div class="mt-2 text-end">
        <button id="btnDownloadTeamPdf" class="btn btn-outline-secondary">
          Export Team PDF
        </button>
      </div>
    </div>
  </div>

  <hr>
  <div class="row g-3">
    <div class="col-md-6">
      <div class="card-neo">
        <div class="section-title">Team Members</div>
        <div id="teamMembersList" style="max-height:320px;overflow:auto"></div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card-neo">
        <div class="section-title">Quick Info</div>

        <div id="quickInfoList" class="muted-small">
          <div>Added Events: <span id="quickAdded">0</span></div>
          <div>Pending Submissions: <span id="quickPending">0</span></div>
          <div>Approved Submissions: <span id="quickApproved">0</span></div>
        </div>

        <div class="mt-3">
          <div class="section-title">All Students (Reference)</div>
          <div id="allStudentsBox" style="max-height:160px;overflow:auto"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- EVENTS -->
<section id="panel-events" class="card-neo d-none">
  <div class="section-title">Events â€” Choose and Add Participants</div>

  <div class="row g-3">
    <div class="col-lg-5">
      <div class="card-neo">
        <label class="form-label muted-small">Search / Filter</label>

        <div class="d-flex gap-2 mb-2">
          <input id="eventSearch" class="form-control" placeholder="Search event">
          <select id="filterType" class="form-select">
            <option value="">All Types</option>
            <option>Stage</option>
            <option>Off-Stage</option>
          </select>
          <select id="filterLevel" class="form-select">
            <option value="">All Levels</option>
            <option>Junior</option>
            <option>Senior</option>
            <option>General</option>
            <option>Special</option>
          </select>
        </div>

        <div class="section-title">Available Events</div>
        <div class="table-responsive" style="max-height:360px;overflow:auto">
          <table class="table table-sm">
            <thead class="table-light">
              <tr><th>Name</th><th>Type</th><th>Level</th><th></th></tr>
            </thead>
            <tbody id="eventsList"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right section -->
    <div class="col-lg-7">
      <div class="card-neo">


        <div class="section-title">Selected Event</div>
        <div id="selectedEventWrap" class="muted-small mb-2">
          Select an event to load team members.
        </div>

        <div id="selectedEventName" style="font-weight:800"></div>
        <div id="selectedEventMeta" class="muted-small mb-3"></div>

        <div class="section-title">Team Members (max 2)</div>

        <div id="membersSelection"
             style="min-height:180px;max-height:360px;
                    overflow:auto;padding:6px;
                    display:flex;flex-wrap:wrap">
        </div>

        <div class="mt-3 d-flex gap-2">
          <button id="btnSubmitParticipation" class="btn btn-accent">Add Members</button>
          <button id="btnClearSelection" class="btn btn-outline-secondary">Clear</button>
          <div class="ms-auto muted-small align-self-center" id="selectionInfo">0 selected</div>
        </div>

      </div>
    </div>
  </div>
</section>
<!-- PART 3: Hidden state + Modals -->
<!-- Hidden state -->
<input type="hidden" id="leaderTeamDbKey">
<input type="hidden" id="leaderTeamId">
<input type="hidden" id="leaderStudentId">

<!-- Confirm modal (reusable) -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="confirmBody">Are you sure?</div>
      <div class="modal-footer">
        <button id="confirmNo" class="btn btn-outline-secondary" data-bs-dismiss="modal">No</button>
        <button id="confirmYes" class="btn btn-accent">Yes</button>
      </div>
    </div>
  </div>
</div>

<!-- Student info popup (shows full name when clicking chess# box) -->
<div class="modal fade" id="studentInfoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Student</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="studentInfoBody">
        <div style="font-weight:700" id="studentInfoName">Name</div>
        <div class="muted-small" id="studentInfoChess">Chess #: -</div>
        <div class="muted-small" id="studentInfoLevel">Level: -</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Participation status modal (team submissions list) -->
<div class="modal fade" id="participationStatusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Team Submissions</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="yourSubmissionsList" style="max-height:420px;overflow:auto"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<script type="module">
/* =====================================================
      ðŸ”¥ FIREBASE INIT
===================================================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import {
  getDatabase, ref, push, set, update, onValue, get
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =====================================================
      ðŸ”¥ HELPERS
===================================================== */

const $ = id => document.getElementById(id);

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast align-items-center text-bg-${type} border-0`;
  el.innerHTML = `
  <div class="d-flex">
    <div class="toast-body">${msg}</div>
    <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
  </div>`;
  $('toastRoot').appendChild(el);
  new bootstrap.Toast(el, { delay: 2500 }).show();
  el.addEventListener('hidden.bs.toast', () => el.remove());
}

const escapeHtml = s => String(s || "").replace(/</g, "&lt;");

/* =====================================================
      ðŸ”¥ CACHES
===================================================== */

let CACHE = {
  students: [],
  teams: [],
  events: [],
  participations: [],
  results: [],
  attendance: {}
};

let KEYMAP = {
  teams: {},
  students: {},
  events: {},
  participations: {},
  results: {}
};

/* =====================================================
      ðŸ”¥ REALTIME LISTENERS
===================================================== */

onValue(ref(db, "students"), snap => {
  const obj = snap.val() || {};
  CACHE.students = Object.values(obj);
  KEYMAP.students = {};
  Object.entries(obj).forEach(([k, v]) => KEYMAP.students[v.id] = k);
  renderAll();
});

onValue(ref(db, "teams"), snap => {
  const obj = snap.val() || {};
  CACHE.teams = Object.values(obj);
  KEYMAP.teams = {};
  Object.entries(obj).forEach(([k, v]) => KEYMAP.teams[v.id] = k);
  renderAll();
});

onValue(ref(db, "events"), snap => {
  const obj = snap.val() || {};
  CACHE.events = Object.values(obj);
  KEYMAP.events = {};
  Object.entries(obj).forEach(([k, v]) => KEYMAP.events[v.id] = k);
  renderAll();
});

onValue(ref(db, "participations"), snap => {
  const obj = snap.val() || {};
  CACHE.participations = Object.values(obj);
  renderAll();
});

onValue(ref(db, "results"), snap => {
  const obj = snap.val() || {};
  CACHE.results = Object.values(obj);
  renderAll();
});

onValue(ref(db, "attendance"), snap => {
  CACHE.attendance = snap.val() || {};
  renderAll();
});

/* =====================================================
      ðŸ”¥ LEADER DETECTION (NO LOGIN PAGE)
===================================================== */

let LEADER = { active: false, leaderId: null, teamId: null };

function detectLeader() {
  const params = new URL(location.href).searchParams;
  const chess = params.get("leader"); // from login redirect

  if (!chess) {
    $('leaderName').textContent = "Leader not detected";
    $('leaderTeamName').textContent = "Team: -";
    return;
  }

  const stud = CACHE.students.find(s => s.id == chess);
  const team = CACHE.teams.find(t => t.leaderId == chess);

  if (!stud || !team) {
    $('leaderName').textContent = "Leader not detected";
    $('leaderTeamName').textContent = "Team: -";
    return;
  }

  LEADER = { active: true, leaderId: chess, teamId: team.id };

  $('leaderName').textContent = stud.name;
  $('leaderAvatar').textContent = stud.name[0].toUpperCase();
  $('leaderTeamName').textContent = "Team: " + team.name;

  renderAll();
}

/* =====================================================
      ðŸ”¥ DASHBOARD RENDER
===================================================== */

function renderDashboard() {
  if (!LEADER.active) return;

  const teamMembers = CACHE.students.filter(s => s.teamId == LEADER.teamId);

  // Members count
  $('statMembers').textContent = teamMembers.length;

  // Score
  const team = CACHE.teams.find(t => t.id == LEADER.teamId);
  $('statScore').textContent = team?.score || 0;

  // Attendance %
  let present = 0, total = 0;
  Object.values(CACHE.attendance).forEach(session => {
    if (!session.students) return;
    teamMembers.forEach(m => {
      if (session.students[m.id] !== undefined) {
        total++;
        if (session.students[m.id] === "present") present++;
      }
    });
  });

  $('statAttendance').textContent = (total ? Math.round((present / total) * 100) : 0) + "%";

  // team member list
  $('teamMembersList').innerHTML = teamMembers
    .map(m =>
      `<div style="padding:6px;border-bottom:1px solid #eee">
        <b>${escapeHtml(m.name)}</b> <span class="muted-small">(${m.id})</span>
        <div class="muted-small">Level: ${m.level}</div>
      </div>`
    ).join("");
}

/* =====================================================
      ðŸ”¥ EVENTS LIST
===================================================== */

function populateEventsList() {
  const q = ($('eventSearch').value || "").toLowerCase();
  const type = $('filterType').value;
  const level = $('filterLevel').value;

  let out = "";

  CACHE.events
    .sort((a, b) => a.name.localeCompare(b.name))
    .forEach(ev => {
      if (type && ev.type !== type) return;
      if (level && ev.level !== level) return;

      if (q && !(`${ev.name} ${ev.type} ${ev.level}`.toLowerCase().includes(q))) return;

      out += `
      <tr>
        <td>${escapeHtml(ev.name)}</td>
        <td>${ev.type}</td>
        <td>${ev.level}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary btn-select-event" data-id="${ev.id}">Select</button>
        </td>
      </tr>`;
    });

  $('eventsList').innerHTML = out || `<tr><td colspan="4" class="muted-small">No events found</td></tr>`;
}

/* =====================================================
      ðŸ”¥ MEMBER SELECTION FOR EVENT
===================================================== */

document.addEventListener("click", e => {
  const btn = e.target.closest(".btn-select-event");
  if (btn) loadEventMembers(btn.dataset.id);
});

function loadEventMembers(evId) {
  const ev = CACHE.events.find(x => x.id == evId);
  if (!ev) return;

  $('selectedEventName').textContent = ev.name;
  $('selectedEventMeta').textContent = `${ev.type} â€” ${ev.level}`;
  $('membersSelection').dataset.evId = evId;

  let members = CACHE.students.filter(s => s.teamId == LEADER.teamId);

  if (ev.level === "Junior") members = members.filter(s => s.level === "Junior");
  if (ev.level === "Senior") members = members.filter(s => s.level === "Senior");

  let html = "";
  members.forEach(m => {
    html += `
      <div class="small-box member-box" data-id="${m.id}">
        ${m.id}
      </div>
    `;
  });

  $('membersSelection').innerHTML = html;

  // Add click listener (show popup + select)
  document.querySelectorAll(".member-box").forEach(box => {
    box.addEventListener("click", () => selectMember(box, ev));
    box.addEventListener("dblclick", () => showStudentInfo(box.dataset.id));
  });
}

/* Show name on click */
function showStudentInfo(id) {
  const s = CACHE.students.find(x => x.id == id);
  if (!s) return;

  $('studentInfoName').textContent = s.name;
  $('studentInfoChess').textContent = "Chess #: " + s.id;
  $('studentInfoLevel').textContent = "Level: " + s.level;

  new bootstrap.Modal($('#studentInfoModal')).show();
}

/* =====================================================
      ðŸ”¥ RULE ENFORCEMENT: max 2 per event + per-student limits
===================================================== */

function selectMember(box, ev) {
  const stud = CACHE.students.find(x => x.id == box.dataset.id);

  const selected = [...document.querySelectorAll(".member-box.selected")];

  // EVENT MAX: 2
  if (!box.classList.contains("selected") && selected.length >= 2)
    return toast("Max 2 members allowed for this event", "danger");

  // PER-STUDENT LIMITS
  const isStage = ev.type === "Stage";
  const limit = stud.level === "Senior"
    ? (isStage ? 3 : 4)
    : (isStage ? 2 : 3);

  const participated = CACHE.participations.filter(
    p => p.studentId == stud.id
  ).length;

  if (!box.classList.contains("selected") && participated >= limit)
    return toast(`${stud.name} already reached limit (${limit})`, "danger");

  box.classList.toggle("selected");

  $('selectionInfo').textContent =
    document.querySelectorAll(".member-box.selected").length + " selected";
}

/* =====================================================
      ðŸ”¥ SUBMIT PARTICIPATION
===================================================== */

$('btnSubmitParticipation').addEventListener("click", async () => {
  const evId = $('membersSelection').dataset.evId;
  if (!evId) return toast("Select event", "danger");

  const selected = [...document.querySelectorAll(".member-box.selected")];

  if (selected.length === 0)
    return toast("Select members", "danger");

  for (const box of selected) {
    const sid = box.dataset.id;

    await push(ref(db, "participations"), {
      id: Date.now() + "" + sid,
      studentId: sid,
      teamId: LEADER.teamId,
      eventId: evId,
      status: "pending"
    });
  }

  toast("Participation submitted");
  selected.forEach(b => b.classList.remove("selected"));
  $('selectionInfo').textContent = "0 selected";
});

/* =====================================================
      ðŸ”¥ RESULTS TABLE
===================================================== */

function renderResultsTable() {
  let out = "";

  CACHE.events.forEach(ev => {
    const r = CACHE.results.filter(x => x.eventId == ev.id);

    const first = r.find(x => x.position == 1);
    const second = r.find(x => x.position == 2);
    const third = r.find(x => x.position == 3);

    const getName = (rec) => {
      if (!rec) return "";
      const st = CACHE.students.find(s => s.id == rec.studentId);
      return st ? `${st.name} (${st.id})` : rec.studentId;
    };

    out += `
    <tr>
      <td>${ev.name}</td>
      <td>${getName(first)}</td>
      <td>${getName(second)}</td>
      <td>${getName(third)}</td>
      <td>${r.some(x => x.published) ? "Published" : "Draft"}</td>
    </tr>`;
  });

  $('leaderResultsTable').innerHTML = out;
}

/* =====================================================
      ðŸ”¥ MAIN RENDER
===================================================== */

function renderAll() {
  detectLeader();
  populateEventsList();
  renderDashboard();
  renderResultsTable();
}

/* Init */
setTimeout(renderAll, 300);
</script>
</body>
</html>