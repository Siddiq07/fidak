<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader Pro â€” Markaz Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --muted: #94a3b8;
      --accent: #3b82f6; --success: #10b981; --border: #334155;
    }
    [data-theme="light"] {
      --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b;
      --border: #e2e8f0;
    }
    body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; transition: 0.3s; }
    .container-wide { max-width: 1100px; margin: auto; padding: 20px; }
    
    /* UI Components */
    .card-neo { background: var(--card); border-radius: 12px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .nav-btn { color: var(--muted); border: 1px solid var(--border); background: var(--card); margin-right: 8px; font-weight: 600; }
    .nav-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
    
    /* Results - White Card Theme (As per video) */
    .res-card { background: #ffffff; color: #0f172a; border-radius: 12px; margin-bottom: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .res-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .res-title { font-weight: 800; font-size: 1.1rem; }
    .res-cat { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; }
    .btn-view-res { background: #0f172a; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; }
    .res-body { padding: 0 20px 20px; border-top: 1px solid #f1f5f9; }
    .winner-row { display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; margin-top: 10px; }
    .rank-badge { width: 28px; height: 28px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-right: 12px; }

    /* Selection Boxes */
    .small-box { width: 75px; height: 75px; background: var(--border); border-radius: 10px; margin: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .small-box.selected { background: var(--accent); color: white; transform: scale(1.05); }
    .small-box span { font-size: 10px; text-align: center; margin-top: 4px; overflow: hidden; }

    /* Theme Toggle */
    .theme-toggle { cursor: pointer; font-size: 1.4rem; color: var(--accent); }
  </style>
</head>
<body>

<nav class="border-bottom border-secondary py-3">
  <div class="container-wide d-flex justify-content-between align-items-center">
    <div class="fw-bold fs-4 text-primary">MARKAZ FEST <span class="text-muted fs-6">LEADER</span></div>
    <div class="d-flex align-items-center gap-3">
      <i class="bi bi-sun-fill theme-toggle" id="themeBtn"></i>
      <button id="btnLogout" class="btn btn-sm btn-outline-danger">Logout</button>
    </div>
  </div>
  <div class="container-wide overflow-x-auto d-flex pt-3">
    <button class="btn nav-btn active" data-target="dashboard">Dashboard</button>
    <button class="btn nav-btn" data-target="events">Nominations</button>
    <button class="btn nav-btn" data-target="approved">Approved</button>
    <button class="btn nav-btn" data-target="results">Results</button>
  </div>
</nav>

<main class="container-wide">
  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index: 10000"></div>

  <section id="dashboard">
    <div class="card-neo d-flex align-items-center gap-3">
      <div id="u-avatar" style="width:60px; height:60px; background:var(--accent); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; color:white;">L</div>
      <div>
        <h3 id="u-name" class="m-0">Welcome</h3>
        <p id="u-team" class="text-muted m-0">Team Loading...</p>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-md-4"><div class="card-neo text-center"><small>Score</small><h2 id="s-score">0</h2></div></div>
      <div class="col-md-4"><div class="card-neo text-center"><small>Attendance</small><h2 id="s-att">0%</h2></div></div>
      <div class="col-md-4"><div class="card-neo text-center"><small>Members</small><h2 id="s-members">0</h2></div></div>
    </div>
  </section>

  <section id="events" class="d-none">
    <div class="row">
      <div class="col-md-5">
        <div class="card-neo">
          <input type="text" id="evSearch" class="form-control mb-3" placeholder="Search events...">
          <div id="evList" style="max-height: 500px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="col-md-7">
        <div class="card-neo">
          <h4 id="sel-ev-name">Select an Event</h4>
          <p id="sel-ev-meta" class="text-muted small"></p>
          <div id="member-grid" class="d-flex flex-wrap mt-3"></div>
          <button id="btnSubmitNom" class="btn btn-primary w-100 mt-4 py-2 fw-bold">Save Nomination</button>
        </div>
      </div>
    </div>
  </section>

  <section id="approved" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4>Approved Participations</h4>
      <button id="btnPdfAll" class="btn btn-success"><i class="bi bi-file-earmark-pdf"></i> Download All PDF</button>
    </div>
    <div id="approved-container"></div>
  </section>

  <section id="results" class="d-none">
    <h4 class="mb-3">Official Results</h4>
    <div id="results-container"></div>
  </section>
</main>

<div class="modal fade" id="viewModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 card-neo" style="background: var(--card); color: var(--text);"><div class="modal-header border-0"><h5>Event Members</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="viewModalBody"></div></div></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
    authDomain: "gen7-3e139.firebaseapp.com",
    databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
    projectId: "gen7-3e139",
    storageBucket: "gen7-3e139.firebasestorage.app",
    messagingSenderId: "578412378966",
    appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let CACHE = { students: [], teams: [], events: [], parts: [], results: [], attendance: {} };
  let currentEvent = null;
  let LEADER = { id: null, teamId: null };

  // Theme Logic
  const themeBtn = document.getElementById('themeBtn');
  themeBtn.onclick = () => {
    const isDark = document.body.getAttribute('data-theme') !== 'light';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    themeBtn.className = isDark ? 'bi bi-moon-stars-fill theme-toggle' : 'bi bi-sun-fill theme-toggle';
  };

  // Data Fetching
  onValue(ref(db, '/'), (snap) => {
    const d = snap.val() || {};
    CACHE.students = Object.values(d.students || {});
    CACHE.teams = Object.values(d.teams || {});
    CACHE.events = Object.values(d.events || {});
    CACHE.parts = Object.entries(d.participations || {}).map(([key, val]) => ({...val, dbKey: key}));
    CACHE.results = Object.values(d.results || {});
    CACHE.attendance = d.attendance || {};
    initApp();
  });

  function initApp() {
    const lid = sessionStorage.getItem('leaderId') || new URLSearchParams(location.search).get('leader');
    if (!lid) return; sessionStorage.setItem('leaderId', lid);
    
    const user = CACHE.students.find(s => String(s.id) === lid);
    const team = CACHE.teams.find(t => t.id === user?.teamId);
    if (!team) return;

    LEADER = { id: lid, teamId: team.id };
    document.getElementById('u-name').innerText = user.name;
    document.getElementById('u-team').innerText = `Team: ${team.name} (#${team.id})`;
    document.getElementById('s-score').innerText = team.score || 0;
    document.getElementById('s-members').innerText = CACHE.students.filter(s => s.teamId === team.id).length;
    
    renderEvents();
    renderResults();
    renderApproved();
  }

  // Event Nomination Logic
  function renderEvents() {
    const list = document.getElementById('evList');
    const q = document.getElementById('evSearch').value.toLowerCase();
    list.innerHTML = CACHE.events
      .filter(e => e.name.toLowerCase().includes(q))
      .map(e => `
        <div class="p-3 border-bottom d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="window.selectEvent('${e.id}')">
          <div><b>${e.name}</b><br><small class="text-muted">${e.level} | ${e.type}</small></div>
          <i class="bi bi-chevron-right"></i>
        </div>
      `).join('');
  }

  window.selectEvent = (id) => {
    currentEvent = CACHE.events.find(e => String(e.id) === String(id));
    document.getElementById('sel-ev-name').innerText = currentEvent.name;
    document.getElementById('sel-ev-meta').innerText = `${currentEvent.level} Category Selection`;
    
    const grid = document.getElementById('member-grid');
    const cat = currentEvent.level.toLowerCase();
    
    // Filtering Students based on Prompt Logic
    let filtered = CACHE.students.filter(s => s.teamId === LEADER.teamId);
    if (cat === 'senior') filtered = filtered.filter(s => s.level?.toLowerCase() === 'senior');
    else if (cat === 'junior') filtered = filtered.filter(s => s.level?.toLowerCase() === 'junior');
    // Group/Special/General shows all team members

    const eventParts = CACHE.parts.filter(p => p.eventId == id && p.teamId == LEADER.teamId).map(p => String(p.studentId));

    grid.innerHTML = filtered.map(m => `
      <div class="small-box ${eventParts.includes(String(m.id)) ? 'selected' : ''}" data-id="${m.id}" onclick="this.classList.toggle('selected')">
        <b>${m.id}</b>
        <span>${m.name.split(' ')[0]}</span>
      </div>
    `).join('');
  };

  document.getElementById('btnSubmitNom').onclick = async () => {
    if (!currentEvent) return;
    const selected = Array.from(document.querySelectorAll('.small-box.selected')).map(el => el.dataset.id);
    
    // Limits check
    const limit = currentEvent.type.toLowerCase().includes('group') ? 10 : 2;
    if (selected.length > limit) return alert(`Limit for ${currentEvent.type} is ${limit} members.`);

    // Remove old pending entries
    const oldEntries = CACHE.parts.filter(p => p.eventId == currentEvent.id && p.teamId == LEADER.teamId && p.status === 'pending');
    for (let entry of oldEntries) await remove(ref(db, `participations/${entry.dbKey}`));

    // Add new
    for (let sid of selected) {
      await push(ref(db, 'participations'), {
        eventId: currentEvent.id,
        studentId: sid,
        teamId: LEADER.teamId,
        status: 'pending',
        timestamp: Date.now()
      });
    }
    alert('Nominations Saved!');
  };

  // Approved Panel Logic
  function renderApproved() {
    const container = document.getElementById('approved-container');
    const approvedParts = CACHE.parts.filter(p => p.teamId === LEADER.teamId && p.status === 'approved');
    
    const grouped = approvedParts.reduce((acc, curr) => {
      acc[curr.eventId] = acc[curr.eventId] || [];
      acc[curr.eventId].push(curr.studentId);
      return acc;
    }, {});

    container.innerHTML = Object.entries(grouped).map(([evId, sids]) => {
      const ev = CACHE.events.find(e => String(e.id) === evId);
      return `
        <div class="card-neo d-flex justify-content-between align-items-center">
          <div><b>${ev?.name}</b><br><small class="text-muted">${sids.length} Approved Members</small></div>
          <button class="btn btn-sm btn-outline-primary" onclick="window.viewApprovedMembers('${evId}')">View Members</button>
        </div>
      `;
    }).join('');
  }

  window.viewApprovedMembers = (evId) => {
    const sids = CACHE.parts.filter(p => p.eventId == evId && p.teamId == LEADER.teamId && p.status === 'approved').map(p => p.studentId);
    const body = document.getElementById('viewModalBody');
    body.innerHTML = sids.map(id => {
      const s = CACHE.students.find(x => String(x.id) === String(id));
      return `<div class="p-2 border-bottom"><b>${id}</b> - ${s?.name}</div>`;
    }).join('');
    new bootstrap.Modal(document.getElementById('viewModal')).show();
  };

  // Results Panel (White Card as per video)
  function renderResults() {
    const container = document.getElementById('results-container');
    const published = CACHE.results.filter(r => r.published);
    const publishedEvIds = [...new Set(published.map(r => String(r.eventId)))];

    container.innerHTML = CACHE.events
      .filter(ev => publishedEvIds.includes(String(ev.id)))
      .map(ev => {
        const wins = published.filter(r => String(r.eventId) === String(ev.id)).sort((a,b)=>a.position-b.position);
        return `
          <div class="res-card">
            <div class="res-header" onclick="const b=this.nextElementSibling; b.classList.toggle('d-none')">
              <div>
                <div class="res-cat">${ev.level}</div>
                <div class="res-title">${ev.name}</div>
              </div>
              <button class="btn-view-res">View</button>
            </div>
            <div class="res-body d-none">
              ${wins.map(w => {
                const s = CACHE.students.find(st => String(st.id) === String(w.studentId));
                return `
                  <div class="winner-row">
                    <div class="rank-badge">${w.position}</div>
                    <div><b>${s?.name || 'Unknown'}</b><br><small>${w.alias || ''}</small></div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
  }

  // PDF Download Logic
  document.getElementById('btnPdfAll').onclick = () => {
    const approved = CACHE.parts.filter(p => p.teamId === LEADER.teamId && p.status === 'approved');
    let html = `<h2>Approved Participation List</h2><table border="1" style="width:100%; border-collapse: collapse;"><tr><th>Event</th><th>Category</th><th>Members</th></tr>`;
    
    const grouped = approved.reduce((acc, curr) => {
      acc[curr.eventId] = acc[curr.eventId] || [];
      acc[curr.eventId].push(curr.studentId);
      return acc;
    }, {});

    Object.entries(grouped).forEach(([evId, sids]) => {
      const ev = CACHE.events.find(e => String(e.id) === evId);
      html += `<tr><td>${ev.name}</td><td>${ev.level}</td><td>${sids.join(', ')}</td></tr>`;
    });
    html += `</table>`;
    
    html2pdf().from(html).save(`Approved_Events_Team_${LEADER.teamId}.pdf`);
  };

  // Nav Logic
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('section').forEach(s => s.classList.add('d-none'));
      document.getElementById(btn.dataset.target).classList.remove('d-none');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
  });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
