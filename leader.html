<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Leader Panel — Art Fest</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body { background: #f5f8ff; font-family: Inter, sans-serif; }
.topbar {
  padding: 16px;
  background: white;
  box-shadow: 0 3px 12px rgba(0,0,0,0.05);
  display: flex; justify-content: space-between; align-items: center;
}
.card-neo {
  background: #fff; padding: 14px; border-radius: 10px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.05); margin-bottom: 14px;
}
.section-title { font-weight: 700; margin-bottom: 10px; }
.muted { color:#6b7280; }
.btn-accent { background: linear-gradient(90deg,#2563eb,#7c3aed); color:white; border:0; }
.participated-row { background:#e8fff0; }
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div>
    <h4 style="margin:0">Leader Panel</h4>
    <div class="muted" id="leaderName"></div>
  </div>
  <div class="d-flex gap-2">
    <div class="badge bg-primary p-2" id="teamScoreView">Score: 0</div>
    <button id="logoutBtn" class="btn btn-outline-danger"><i class="bi bi-box-arrow-right"></i> Logout</button>
  </div>
</div>

<div class="container mt-3">

<!-- ============================
     SELECT EVENT & PARTICIPATE
     ============================ -->
<div class="card-neo">
  <div class="section-title">Submit Participation</div>

  <div class="row g-2 mb-2">
    <div class="col-md-4">
      <select id="eventSelect" class="form-select">
        <option value="">Select Event</option>
      </select>
    </div>

    <div class="col-md-4">
      <select id="memberSelect" class="form-select" multiple style="height:120px">
        <option value="">Select Members</option>
      </select>
    </div>

    <div class="col-md-4 d-flex align-items-start">
      <button id="submitParticipation" class="btn btn-accent w-100">
        Submit Participation
      </button>
    </div>
  </div>

  <div class="muted" id="eventRuleDisplay"></div>
</div>

<!-- ============================
     PARTICIPATION STATUS
     ============================ -->
<div class="card-neo">
  <div class="section-title">Your Team's Participation</div>

  <div class="table-responsive">
    <table class="table align-middle">
      <thead class="table-light">
        <tr>
          <th>Event</th>
          <th>Members</th>
          <th>Status</th>
          <th>Submitted</th>
        </tr>
      </thead>
      <tbody id="teamParticipationTable"></tbody>
    </table>
  </div>

  <button class="btn btn-outline-secondary" id="downloadParticipationPDF">
    <i class="bi bi-file-earmark-pdf"></i> Download PDF
  </button>
</div>

<!-- ============================
           RESULTS
     ============================ -->
<div class="card-neo">
  <div class="section-title">Results for Your Team</div>

  <div class="table-responsive">
    <table class="table align-middle">
      <thead class="table-light">
        <tr>
          <th>Event</th>
          <th>Position</th>
          <th>Student</th>
          <th>Points</th>
        </tr>
      </thead>
      <tbody id="teamResultsTable"></tbody>
    </table>
  </div>
</div>

<!-- ============================
         ATTENDANCE SUMMARY
     ============================ -->
<div class="card-neo">
  <div class="section-title">Attendance Summary</div>
  <div class="muted">Team Attendance %</div>
  <div id="attendancePercentView" class="fs-3 fw-bold"></div>
</div>

</div> <!-- container -->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, get, onValue, push, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ===========================
        LOGIN DATA
   =========================== */
const leaderId = sessionStorage.getItem("leaderId");
const teamId = sessionStorage.getItem("teamId");

if (!leaderId || !teamId) location.href = "index.html";

/* SMALL HELPERS */
const $ = id => document.getElementById(id);
const escapeHTML = txt => txt.replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));

/* ===========================
     LOAD LEADER & TEAM INFO
   =========================== */
async function loadLeaderInfo() {
  const snap = await get(ref(db, "students/" + leaderId));
  const s = snap.val();
  $("leaderName").innerText = s ? (s.name + " (" + s.id + ")") : "Leader";

  const teamSnap = await get(ref(db, "teams/" + teamId));
  const t = teamSnap.val();

  if (t?.locked) {
    alert("Your team is locked by admin.");
    sessionStorage.clear();
    location.href = "index.html";
  }

  $("teamScoreView").innerText = "Score: " + (t?.score || 0);
}

loadLeaderInfo();

/* ===========================
     LOAD EVENTS
   =========================== */
onValue(ref(db, "events"), snap => {
  const obj = snap.val() || {};
  const arr = Object.values(obj);
  $("eventSelect").innerHTML = `<option value="">Select Event</option>`;

  arr.sort((a,b)=>a.name.localeCompare(b.name));

  arr.forEach(ev => {
    $("eventSelect").innerHTML += `
      <option value="${ev.id}" data-level="${ev.level}" data-type="${ev.type}">
        ${escapeHTML(ev.name)} (${ev.level})
      </option>
    `;
  });
});

/* ===========================
     WHEN EVENT SELECTED
   =========================== */
$("eventSelect").addEventListener("change", async () => {
  const evId = $("eventSelect").value;
  if (!evId) return;

  const opt = $("eventSelect").selectedOptions[0];
  const evLevel = opt.dataset.level;
  const evType = opt.dataset.type;

  /* Determine limit: */
  let limit = evType === "Stage" ? 3 : 4;
  $("eventRuleDisplay").innerText = `Rule: ${limit} participants allowed`;

  /* Load team members */
  const snap = await get(ref(db, "students"));
  const allStudents = snap.val() || {};
  const arr = Object.values(allStudents).filter(s => s.teamId == teamId);

  /* Filter based on event level */
  let filtered = arr;
  if (evLevel === "Junior") filtered = arr.filter(s => s.level === "Junior");
  if (evLevel === "Senior") filtered = arr.filter(s => s.level === "Senior");
  /* General and Special → no filter */

  $("memberSelect").innerHTML = "";
  filtered.forEach(s => {
    $("memberSelect").innerHTML += `
      <option value="${s.id}">${escapeHTML(s.name)} (${s.id})</option>
    `;
  });
});

/* ===========================
     SUBMIT PARTICIPATION
   =========================== */
$("submitParticipation").addEventListener("click", async () => {
  const evId = $("eventSelect").value;
  const members = Array.from($("memberSelect").selectedOptions).map(o => o.value);

  if (!evId) return alert("Select event.");
  if (members.length === 0) return alert("Select members.");

  /* find limit */
  const opt = $("eventSelect").selectedOptions[0];
  const evType = opt.dataset.type;
  const limit = evType === "Stage" ? 3 : 4;

  if (members.length > limit) {
    alert(`Only ${limit} members allowed.`);
    return;
  }

  const p = push(ref(db, "participations"));
  const id = p.key;

  await set(p, {
    id,
    teamId,
    eventId: evId,
    members,
    status: "pending",
    submittedAt: Date.now()
  });

  alert("Participation submitted.");
});

/* ===========================
     LOAD TEAM PARTICIPATIONS
   =========================== */
onValue(ref(db, "participations"), snap => {
  const obj = snap.val() || {};
  const arr = Object.values(obj).filter(p => p.teamId == teamId);

  arr.sort((a,b)=>b.submittedAt - a.submittedAt);

  $("teamParticipationTable").innerHTML = "";

  arr.forEach(p => {
    $("teamParticipationTable").innerHTML += `
      <tr>
        <td>${p.eventId}</td>
        <td>${p.members.join(", ")}</td>
        <td>${p.status}</td>
        <td>${new Date(p.submittedAt).toLocaleString()}</td>
      </tr>
    `;
  });
});

/* PDF */
$("downloadParticipationPDF").addEventListener("click", () => {
  const element = document.querySelector("#teamParticipationTable").parentElement;
  html2pdf().from(element).save("participation.pdf");
});

/* ===========================
     LOAD TEAM RESULTS
   =========================== */
onValue(ref(db, "results"), snap => {
  const obj = snap.val() || {};
  const arr = Object.values(obj);

  $("teamResultsTable").innerHTML = "";

  arr.forEach(r => {
    const studentBelongs =
      r.studentId &&
      sessionStorage.getItem("teamId") &&
      true;

    const row = `
      <tr>
        <td>${r.eventId}</td>
        <td>${r.position}</td>
        <td>${r.studentId}</td>
        <td>${r.points}</td>
      </tr>
    `;
    $("teamResultsTable").innerHTML += row;
  });
});

/* ===========================
     ATTENDANCE SUMMARY
   =========================== */
onValue(ref(db, "attendance"), snap => {
  const obj = snap.val() || {};
  const sessions = Object.values(obj);

  let total = 0, present = 0;

  sessions.forEach(s => {
    if (!s.students) return;
    Object.entries(s.students).forEach(([id, status]) => {
      const stSnap = id;
      const inTeam = true;
      if (inTeam) {
        total++;
        if (status === "Present") present++;
      }
    });
  });

  const pct = total ? Math.round((present / total) * 100) : 0;
  $("attendancePercentView").innerText = pct + "%";
});

/* ===========================
     LOGOUT
   =========================== */
$("logoutBtn").addEventListener("click", () => {
  sessionStorage.clear();
  location.href = "index.html";
});
</script>

</body>
</html>