<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader Dashboard — Fidak Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #334155;
      --text-primary: #f8fafc; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
      --accent-primary: #3b82f6; --accent-secondary: #10b981;
      --accent-warning: #f59e0b; --accent-danger: #ef4444;
      --border-color: #475569;
    }
    
    [data-theme="light"] {
      --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-card: #ffffff;
      --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #64748b;
      --accent-primary: #2563eb; --border-color: #e2e8f0;
    }

    body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; transition: 0.3s; }
    
    .main-header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
    .logo { font-weight: 900; font-size: 24px; color: var(--accent-primary); letter-spacing: -1px; }

    .nav-tabs-modern { display: flex; gap: 10px; padding: 15px 0; overflow-x: auto; border-bottom: 1px solid var(--border-color); }
    .nav-tab { padding: 8px 18px; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-secondary); background: transparent; cursor: pointer; white-space: nowrap; font-weight: 600; }
    .nav-tab.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }

    .simple-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    
    .nominations-container { display: grid; grid-template-columns: 320px 1fr; gap: 20px; margin-top: 20px; }
    .event-list { max-height: 500px; overflow-y: auto; }
    .event-item { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: var(--bg-secondary); }
    .event-item:hover { border-color: var(--accent-primary); }
    .event-item.selected { border-left: 5px solid var(--accent-primary); background: rgba(59, 130, 246, 0.1); }

    .members-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; }
    .member-box { background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 10px; padding: 12px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; }
    .member-box.selected { border-color: var(--accent-primary); background: rgba(59, 130, 246, 0.1); }
    .member-box.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }

    .toast-box { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 10px; background: var(--bg-secondary); border-left: 5px solid var(--accent-primary); box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 10000; animation: slideIn 0.3s ease; }
    
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @media (max-width: 992px) { .nominations-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body data-theme="dark">

  <header class="main-header">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="logo"><i class="bi bi-fire me-2"></i>FIDAK FEST</div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light btn-sm" onclick="toggleTheme()"><i class="bi bi-sun"></i></button>
        <button class="btn btn-danger btn-sm" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <main class="container py-4">
    <div class="nav-tabs-modern mb-4">
      <button class="nav-tab active" data-target="dashboard">Dashboard</button>
      <button class="nav-tab" data-target="nominations">Nomination Desk</button>
      <button class="nav-tab" data-target="status">Submission Status</button>
      <button class="nav-tab" data-target="results">Results</button>
    </div>

    <section id="dashboard" class="content-section">
      <div class="row">
        <div class="col-md-4">
          <div class="simple-card text-center">
            <h1 class="display-4 fw-bold text-primary" id="teamScore">0</h1>
            <p class="text-muted">Total Team Points</p>
          </div>
        </div>
        <div class="col-md-8">
          <div class="simple-card h-100">
            <h4 id="welcomeMsg">Welcome, Leader</h4>
            <p id="teamNameDisp" class="text-accent-secondary">Team Loading...</p>
            <div class="d-flex gap-3 mt-3">
               <div class="p-2 px-3 bg-success bg-opacity-10 rounded border border-success">
                  <small class="d-block text-muted">Approved</small>
                  <strong id="countApproved">0</strong>
               </div>
               <div class="p-2 px-3 bg-warning bg-opacity-10 rounded border border-warning">
                  <small class="d-block text-muted">Pending</small>
                  <strong id="countPending">0</strong>
               </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="nominations" class="content-section d-none">
      <div class="nominations-container">
        <div class="simple-card">
          <h5><i class="bi bi-search me-2"></i>Search Event</h5>
          <input type="text" class="form-control mb-3" placeholder="Type event name..." id="eventSearch" oninput="renderEvents()">
          <div class="event-list" id="eventList"></div>
        </div>
        <div class="simple-card">
          <div id="selectionHeader">
            <h5>Select Members</h5>
            <p class="text-muted small">Please choose an event from the left panel to begin.</p>
          </div>
          <div class="members-grid mt-4" id="memberGrid"></div>
          <div class="mt-4 pt-3 border-top">
            <button class="btn btn-primary w-100 py-2 fw-bold" id="btnSave" onclick="saveNominations()" disabled>
              <i class="bi bi-cloud-arrow-up me-2"></i>SAVE NOMINATIONS
            </button>
          </div>
        </div>
      </div>
    </section>

    <section id="status" class="content-section d-none">
      <div class="simple-card">
        <div class="d-flex justify-content-between mb-3">
          <h4>Team Nominations Status</h4>
          <div>
            <button class="btn btn-sm btn-outline-success" onclick="exportData('excel')">Excel</button>
            <button class="btn btn-sm btn-outline-danger" onclick="exportData('pdf')">PDF</button>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped align-middle">
            <thead><tr><th>ID</th><th>Student Name</th><th>Event</th><th>Category</th><th>Status</th></tr></thead>
            <tbody id="statusTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="results" class="content-section d-none">
      <div class="row" id="resultsGrid"></div>
    </section>
  </main>

  <div id="toast" class="toast-box d-none"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let DB_STATE = { students: [], teams: [], events: [], parts: [], results: [] };
    let LEAD_INFO = null;
    let currentEventId = null;
    let activeSelection = new Set();

    // --- Core Logic ---
    onValue(ref(db, '/'), (snap) => {
      const data = snap.val() || {};
      DB_STATE.students = Object.values(data.students || {});
      DB_STATE.teams = Object.values(data.teams || {});
      DB_STATE.events = Object.values(data.events || {});
      DB_STATE.results = Object.values(data.results || {});
      DB_STATE.parts = Object.entries(data.participations || {}).map(([k, v]) => ({ ...v, fbKey: k }));

      if (!LEAD_INFO) initSession();
      refreshUI();
    });

    function initSession() {
      const id = sessionStorage.getItem('leaderId') || new URLSearchParams(window.location.search).get('leader');
      if (!id) { window.location.href = 'index.html'; return; }
      
      const user = DB_STATE.students.find(s => String(s.id) === String(id));
      const team = DB_STATE.teams.find(t => t.id === user?.teamId);
      
      if (user && team) {
        LEAD_INFO = { ...user, teamName: team.name, teamScore: team.score };
        sessionStorage.setItem('leaderId', id);
        document.getElementById('welcomeMsg').textContent = `Welcome, ${user.name}`;
        document.getElementById('teamNameDisp').textContent = `Leading: ${team.name}`;
      }
    }

    function refreshUI() {
      renderDashboard();
      renderEvents();
      renderStatus();
      renderResults();
      if (currentEventId) renderMembers(); 
    }

    function renderDashboard() {
      const myTeamParts = DB_STATE.parts.filter(p => p.teamId === LEAD_INFO?.teamId);
      document.getElementById('teamScore').textContent = DB_STATE.teams.find(t => t.id === LEAD_INFO?.teamId)?.score || 0;
      document.getElementById('countApproved').textContent = myTeamParts.filter(p => p.status === 'approved').length;
      document.getElementById('countPending').textContent = myTeamParts.filter(p => p.status === 'pending').length;
    }

    window.renderEvents = () => {
      const filter = document.getElementById('eventSearch').value.toLowerCase();
      const list = document.getElementById('eventList');
      list.innerHTML = DB_STATE.events
        .filter(e => e.name.toLowerCase().includes(filter))
        .map(e => `
          <div class="event-item ${currentEventId === e.id ? 'selected' : ''}" onclick="selectEvent('${e.id}')">
            <small class="text-primary fw-bold">${e.level} • ${e.type}</small>
            <div class="fw-bold">${e.name}</div>
          </div>
        `).join('');
    };

    window.selectEvent = (id) => {
      currentEventId = id;
      activeSelection.clear();
      
      const event = DB_STATE.events.find(e => e.id === id);
      document.getElementById('selectionHeader').innerHTML = `
        <h5 class="text-primary">${event.name}</h5>
        <div class="d-flex gap-2">
            <span class="badge bg-dark border border-secondary">${event.type}</span>
            <span class="badge bg-dark border border-secondary">${event.level} Only</span>
        </div>
      `;

      // Load existing pending choices
      DB_STATE.parts
        .filter(p => p.eventId === id && p.teamId === LEAD_INFO.teamId && p.status === 'pending')
        .forEach(p => activeSelection.add(String(p.studentId)));

      renderMembers();
      renderEvents();
      document.getElementById('btnSave').disabled = false;
    };

    function renderMembers() {
      const grid = document.getElementById('memberGrid');
      const event = DB_STATE.events.find(e => e.id === currentEventId);
      const teamMates = DB_STATE.students.filter(s => s.teamId === LEAD_INFO.teamId);

      grid.innerHTML = teamMates.map(m => {
        const { eligible, reason } = checkRules(m, event);
        const isPicked = activeSelection.has(String(m.id));
        
        return `
          <div class="member-box ${isPicked ? 'selected' : ''} ${!eligible && !isPicked ? 'disabled' : ''}" 
               onclick="${eligible || isPicked ? `toggleUser('${m.id}')` : ''}" title="${reason}">
            <div class="fw-bold">${m.id}</div>
            <div class="small text-truncate">${m.name}</div>
            <span class="badge bg-secondary" style="font-size:9px">${m.level}</span>
          </div>
        `;
      }).join('');
    }

    window.toggleUser = (id) => {
      const sid = String(id);
      if (activeSelection.has(sid)) activeSelection.delete(sid);
      else activeSelection.add(sid);
      renderMembers();
    };

    function checkRules(student, event) {
      // 1. Level Check
      if (event.level !== 'General' && event.level !== student.level) return { eligible: false, reason: "Incompatible Level" };

      // 2. Personal Participation Limits (Approved Only)
      const approved = DB_STATE.parts.filter(p => String(p.studentId) === String(student.id) && p.status === 'approved');
      const stages = approved.filter(p => DB_STATE.events.find(e => e.id === p.eventId)?.type === 'Stage').length;
      const nonStages = approved.filter(p => DB_STATE.events.find(e => e.id === p.eventId)?.type === 'Non-Stage').length;

      if (event.type === 'Stage' && stages >= (student.level === 'Senior' ? 3 : 2)) return { eligible: false, reason: "Stage Limit Reached" };
      if (event.type === 'Non-Stage' && nonStages >= (student.level === 'Senior' ? 4 : 3)) return { eligible: false, reason: "Non-Stage Limit Reached" };

      // 3. Team Capacity
      const teamCount = DB_STATE.parts.filter(p => p.eventId === event.id && p.teamId === LEAD_INFO.teamId).length;
      const max = (event.type === 'Group') ? 5 : 2;
      if (teamCount >= max && !activeSelection.has(String(student.id))) return { eligible: false, reason: "Team Slot Full" };

      return { eligible: true, reason: "" };
    }

    window.saveNominations = async () => {
      const btn = document.getElementById('btnSave');
      btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Syncing...`;
      
      try {
        const oldPending = DB_STATE.parts.filter(p => p.eventId === currentEventId && p.teamId === LEAD_INFO.teamId && p.status === 'pending');
        for (let p of oldPending) await remove(ref(db, `participations/${p.fbKey}`));

        for (let sId of activeSelection) {
          await push(ref(db, 'participations'), {
            eventId: currentEventId, studentId: sId, teamId: LEAD_INFO.teamId, status: 'pending', ts: Date.now()
          });
        }
        showToast("Success: Database Updated!");
      } catch (err) { showToast("Error: Save Failed"); }
      finally { btn.innerHTML = `<i class="bi bi-cloud-arrow-up me-2"></i>SAVE NOMINATIONS`; }
    };

    function renderStatus() {
      const body = document.getElementById('statusTableBody');
      const myParts = DB_STATE.parts.filter(p => p.teamId === LEAD_INFO?.teamId);
      
      body.innerHTML = myParts.map(p => {
        const s = DB_STATE.students.find(st => String(st.id) === String(p.studentId));
        const e = DB_STATE.events.find(ev => ev.id === p.eventId);
        return `<tr>
          <td>${p.studentId}</td>
          <td>${s?.name || 'Unknown'}</td>
          <td>${e?.name || 'Unknown'}</td>
          <td>${e?.type || '-'}</td>
          <td><span class="badge ${p.status === 'approved' ? 'bg-success' : 'bg-warning'}">${p.status}</span></td>
        </tr>`;
      }).join('');
    }

    function renderResults() {
      const grid = document.getElementById('resultsGrid');
      const published = DB_STATE.results.filter(r => r.published);
      
      grid.innerHTML = published.length ? published.map(r => {
        const e = DB_STATE.events.find(ev => ev.id === r.eventId);
        const s = DB_STATE.students.find(st => String(st.id) === String(r.studentId));
        return `<div class="col-md-6 mb-3">
          <div class="simple-card d-flex justify-content-between align-items-center">
            <div><small class="text-primary d-block">${e?.name}</small><strong>${s?.name}</strong></div>
            <div class="badge bg-primary">Rank ${r.position}</div>
          </div>
        </div>`;
      }).join('') : `<div class="col-12 text-center text-muted">Results are currently hidden by admin.</div>`;
    }

    // --- Utils ---
    window.showToast = (msg) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.remove('d-none');
      setTimeout(() => t.classList.add('d-none'), 3000);
    };

    window.toggleTheme = () => {
      const b = document.body;
      b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    };

    window.logout = () => { sessionStorage.clear(); window.location.href = 'index.html'; };

    document.querySelectorAll('.nav-tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(sec => sec.classList.add('d-none'));
        t.classList.add('active');
        document.getElementById(t.dataset.target).classList.remove('d-none');
      });
    });

  </script>
</body>
</html>
