<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Leader Panel â€” Art Fest</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
body{background:#f5f8ff;font-family:system-ui}
.card{border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.stat{padding:14px;border-radius:12px;background:#fff}
.stat .v{font-size:22px;font-weight:800}
.small-box{width:64px;height:48px;border-radius:10px;background:#eef2ff;
display:flex;flex-direction:column;align-items:center;justify-content:center;
cursor:pointer;margin:4px;font-weight:700}
.small-box.selected{background:#2563eb;color:#fff}
</style>
</head>

<body>

<!-- ðŸ” SECURITY CHECK -->
<script>
const SESSION = JSON.parse(sessionStorage.getItem("user")||"{}");
if(SESSION.role!=="Leader" || !SESSION.teamId){
  alert("Unauthorized access");
  location.href="index.html";
}
</script>

<nav class="navbar bg-white border-bottom">
  <div class="container">
    <strong class="text-primary">ðŸŽ¨ Art Fest</strong>
    <div class="d-flex gap-2 align-items-center">
      <span id="teamName" class="text-muted"></span>
      <button id="logout" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>
  </div>
</nav>

<main class="container my-4">

<!-- DASHBOARD -->
<div class="row g-3">
  <div class="col-md-4">
    <div class="stat">
      <div class="text-muted">Team Score</div>
      <div id="teamScore" class="v">0</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat">
      <div class="text-muted">Attendance</div>
      <div id="teamAttendance" class="v">0%</div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat">
      <div class="text-muted">Members</div>
      <div id="memberCount" class="v">0</div>
    </div>
  </div>
</div>

<hr>

<!-- EVENTS -->
<div class="card p-3 mb-4">
  <h5>Events</h5>
  <div class="row">
    <div class="col-md-5">
      <input id="searchEvent" class="form-control mb-2" placeholder="Search event">
      <table class="table table-sm">
        <thead>
          <tr><th>Event</th><th></th></tr>
        </thead>
        <tbody id="eventsTable"></tbody>
      </table>
    </div>

    <div class="col-md-7">
      <h6 id="selectedEvent">Select event</h6>
      <div id="memberSelect" class="d-flex flex-wrap"></div>
      <div class="mt-2">
        <button id="submitEvent" class="btn btn-primary">Submit</button>
        <span id="selCount" class="ms-2 text-muted">0 selected</span>
      </div>
    </div>
  </div>
</div>

<!-- RESULTS -->
<div class="card p-3">
  <h5>Published Results</h5>
  <table class="table table-sm">
    <thead>
      <tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th></tr>
    </thead>
    <tbody id="resultsTable"></tbody>
  </table>
</div>

</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const TEAM_ID = SESSION.teamId;

const $ = id=>document.getElementById(id);

let STUDENTS=[], EVENTS=[], RESULTS=[], TEAM={};

onValue(ref(db,"teams"),s=>{
  TEAM=Object.values(s.val()||{}).find(t=>String(t.id)===String(TEAM_ID));
  $("teamName").textContent=TEAM?.name||"";
  $("teamScore").textContent=TEAM?.score||0;
});

onValue(ref(db,"students"),s=>{
  STUDENTS=Object.values(s.val()||{}).filter(x=>String(x.teamId)===String(TEAM_ID));
  $("memberCount").textContent=STUDENTS.length;
});

onValue(ref(db,"events"),s=>{
  EVENTS=Object.values(s.val()||{});
  renderEvents();
});

onValue(ref(db,"results"),s=>{
  RESULTS=Object.values(s.val()||{});
  renderResults();
});

let ACTIVE_EVENT=null;
let SELECTED=[];

function renderEvents(){
  $("eventsTable").innerHTML="";
  EVENTS.forEach(e=>{
    $("eventsTable").innerHTML+=`
      <tr>
        <td>${e.name}</td>
        <td><button class="btn btn-sm btn-outline-primary" onclick="selectEvent('${e.id}')">Select</button></td>
      </tr>`;
  });
}

window.selectEvent=id=>{
  ACTIVE_EVENT=EVENTS.find(e=>e.id==id);
  SELECTED=[];
  $("selectedEvent").textContent=ACTIVE_EVENT.name;
  renderMembers();
};

function renderMembers(){
  $("memberSelect").innerHTML="";
  STUDENTS.forEach(s=>{
    const d=document.createElement("div");
    d.className="small-box";
    d.innerHTML=`<div>${s.id}</div><small>${s.name}</small>`;
    d.onclick=()=>toggle(s.id,d);
    $("memberSelect").appendChild(d);
  });
}

function toggle(id,el){
  if(SELECTED.includes(id)){
    SELECTED=SELECTED.filter(x=>x!==id);
    el.classList.remove("selected");
  }else{
    if(SELECTED.length>=2) return alert("Only 2 allowed");
    SELECTED.push(id);
    el.classList.add("selected");
  }
  $("selCount").textContent=SELECTED.length+" selected";
}

$("submitEvent").onclick=async()=>{
  if(!ACTIVE_EVENT||!SELECTED.length) return;
  for(const sid of SELECTED){
    const r=push(ref(db,"participations"));
    await set(r,{eventId:ACTIVE_EVENT.id,studentId:sid,teamId:TEAM_ID,status:"pending"});
  }
  alert("Submitted");
  SELECTED=[];
  renderMembers();
};

function renderResults(){
  $("resultsTable").innerHTML="";
  RESULTS.forEach(r=>{
    const e=EVENTS.find(x=>x.id==r.eventId)||{};
    $("resultsTable").innerHTML+=`
      <tr>
        <td>${e.name||""}</td>
        <td>${r.position==1?r.studentId:""}</td>
        <td>${r.position==2?r.studentId:""}</td>
        <td>${r.position==3?r.studentId:""}</td>
      </tr>`;
  });
}

$("logout").onclick=()=>{
  sessionStorage.clear();
  location.href="index.html";
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>