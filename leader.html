<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader â€” Markaz Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #0d121c; --card: #1c2738; --text: #e2e8f0; --muted: #94a3b8;
      --accent-main: #f97316; --accent-secondary: #3b82f6;
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
    .container-wide { max-width: 1100px; margin: auto; padding: 15px; }
    
    /* Navigation */
    .top-nav { background: var(--bg); border-bottom: 1px solid #334155; padding: 10px 0; }
    .nav-btn { color: var(--muted); border: 1px solid #334155; background: var(--card); margin-right: 5px; }
    .nav-btn.active { background: var(--accent-secondary); color: #fff; }

    /* Dashboard Cards */
    .card-neo { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #334155; }
    .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .stat-box { padding: 20px; border-radius: 10px; color: #fff; }

    /* --- RESULTS VIEW (MATCHING VIDEO) --- */
    .results-wrapper { padding: 10px 0; }
    .result-card {
      background: #ffffff; /* Pure white as seen in video */
      border-radius: 10px;
      margin-bottom: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      color: #1e293b;
    }
    .result-header {
      padding: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .result-info .category {
      font-size: 11px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .result-info .event-name {
      font-size: 18px;
      font-weight: 800;
      color: #0f172a;
      margin: 2px 0;
    }
    .result-actions { display: flex; align-items: center; gap: 10px; }
    .event-id-badge {
      font-size: 12px;
      font-weight: 600;
      color: #3b82f6;
      background: #eff6ff;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .btn-view {
      background: #0f172a;
      color: #fff;
      border: none;
      padding: 6px 18px;
      border-radius: 6px;
      font-weight: 600;
    }
    .result-body {
      background: #ffffff;
      padding: 0 16px 16px;
      border-top: 1px solid #f1f5f9;
    }
    .winner-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      margin-top: 10px;
    }
    .rank-circle {
      width: 30px; height: 30px; border-radius: 50%;
      background: #3b82f6; color: white;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; margin-right: 12px;
    }
    /* --- END RESULTS VIEW --- */

    .small-box { width: 65px; height: 65px; background: #334155; border-radius: 8px; margin: 5px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; }
    .small-box.selected { background: var(--accent-secondary); }
  </style>
</head>
<body>

<nav class="top-nav">
  <div class="container-wide d-flex justify-content-between align-items-center">
    <div style="font-weight: 900; color: var(--accent-main); font-size: 20px;">LEADER PANEL</div>
    <button id="btnLogout" class="btn btn-sm btn-outline-danger">Logout</button>
  </div>
  <div class="container-wide overflow-x-auto d-flex">
    <button class="btn nav-btn active" data-target="dashboard">Dashboard</button>
    <button class="btn nav-btn" data-target="events">Events</button>
    <button class="btn nav-btn" data-target="results">Results</button>
    <button class="btn nav-btn" data-target="team">Team</button>
  </div>
</nav>

<main class="container-wide">
  <section id="dashboard">
    <div class="card-neo d-flex align-items-center gap-3">
      <div id="u-avatar" style="width:50px; height:50px; background:var(--accent-secondary); border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:bold;">L</div>
      <div>
        <h4 id="u-name" style="margin:0;">Leader Name</h4>
        <small id="u-team" class="text-muted">Team ID: --</small>
      </div>
    </div>
    <div class="stat-grid">
      <div class="stat-box" style="background: #dc2626;"> <small>Score</small> <h2 id="s-score">0</h2> </div>
      <div class="stat-box" style="background: #f97316;"> <small>Members</small> <h2 id="s-members">0</h2> </div>
    </div>
  </section>

  <section id="events" class="d-none">
    <div class="row">
      <div class="col-md-5">
        <div class="card-neo">
          <h5>Events List</h5>
          <input type="text" id="eventSearch" class="form-control mb-2" placeholder="Search...">
          <div id="events-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="col-md-7">
        <div class="card-neo">
          <h5 id="sel-event-title">Select an event</h5>
          <div id="members-list" class="d-flex flex-wrap"></div>
          <button id="btnSubmit" class="btn btn-primary mt-3 w-100">Submit Selection</button>
        </div>
      </div>
    </div>
  </section>

  <section id="results" class="d-none">
    <h4 class="mb-3">Official Results</h4>
    <div id="results-container" class="results-wrapper">
      </div>
  </section>

  <section id="team" class="d-none">
    <div class="card-neo">
      <h5>Your Team Members</h5>
      <div id="team-members-list"></div>
    </div>
  </section>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, push } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
    authDomain: "gen7-3e139.firebaseapp.com",
    databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
    projectId: "gen7-3e139",
    storageBucket: "gen7-3e139.firebasestorage.app",
    messagingSenderId: "578412378966",
    appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let CACHE = { students: [], teams: [], events: [], results: [], parts: [] };
  let currentEventId = null;

  // Real-time Data Sync
  onValue(ref(db, '/'), (snap) => {
    const data = snap.val() || {};
    CACHE.students = Object.values(data.students || {});
    CACHE.teams = Object.values(data.teams || {});
    CACHE.events = Object.values(data.events || {});
    CACHE.results = Object.values(data.results || {});
    CACHE.parts = Object.values(data.participations || {});
    initApp();
  });

  function initApp() {
    const leaderId = sessionStorage.getItem('leaderId') || new URLSearchParams(window.location.search).get('leader');
    if (!leaderId) { window.location.href = 'index.html'; return; }
    sessionStorage.setItem('leaderId', leaderId);

    const leader = CACHE.students.find(s => String(s.id) === String(leaderId));
    const team = CACHE.teams.find(t => String(t.id) === String(leader?.teamId));

    if (team) {
      document.getElementById('u-name').innerText = leader.name;
      document.getElementById('u-team').innerText = `Team: ${team.name} (${team.id})`;
      document.getElementById('s-score').innerText = team.score || 0;
      document.getElementById('s-members').innerText = CACHE.students.filter(s => s.teamId === team.id).length;
    }

    renderEvents();
    renderResults();
    renderTeamMembers(team?.id);
  }

  function renderEvents() {
    const container = document.getElementById('events-list');
    container.innerHTML = CACHE.events.map(ev => `
      <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
        <span>${ev.name} <br><small class="text-muted">${ev.level}</small></span>
        <button class="btn btn-sm btn-primary" onclick="window.selectEvent('${ev.id}')">Select</button>
      </div>
    `).join('');
  }

  window.selectEvent = (id) => {
    currentEventId = id;
    const ev = CACHE.events.find(e => String(e.id) === String(id));
    document.getElementById('sel-event-title').innerText = ev.name;
    const leaderId = sessionStorage.getItem('leaderId');
    const leader = CACHE.students.find(s => String(s.id) === String(leaderId));
    
    const members = CACHE.students.filter(s => s.teamId === leader.teamId);
    document.getElementById('members-list').innerHTML = members.map(m => `
      <div class="small-box" id="mb-${m.id}" onclick="this.classList.toggle('selected')">
        <b>${m.id}</b>
        <span style="font-size:9px;">${m.name.split(' ')[0]}</span>
      </div>
    `).join('');
  };

  // --- RENDER RESULTS (UI FIX) ---
  function renderResults() {
    const container = document.getElementById('results-container');
    const publishedIds = [...new Set(CACHE.results.filter(r => r.published).map(r => String(r.eventId)))];
    
    if (publishedIds.length === 0) {
      container.innerHTML = `<div class="text-center p-5 text-muted">No results published yet.</div>`;
      return;
    }

    container.innerHTML = CACHE.events
      .filter(ev => publishedIds.includes(String(ev.id)))
      .map(ev => {
        const winners = CACHE.results
          .filter(r => String(r.eventId) === String(ev.id) && r.published)
          .sort((a,b) => a.position - b.position);

        const winnersHtml = winners.map(w => {
          const student = CACHE.students.find(s => String(s.id) === String(w.studentId));
          return `
            <div class="winner-item">
              <div class="rank-circle">${w.position}</div>
              <div>
                <div style="font-weight: 700; color: #0f172a;">${student?.name || 'Unknown'}</div>
                <div style="font-size: 12px; color: #64748b;">${w.alias || ''}</div>
              </div>
            </div>
          `;
        }).join('');

        return `
          <div class="result-card">
            <div class="result-header" data-bs-toggle="collapse" data-bs-target="#res-collapse-${ev.id}">
              <div class="result-info">
                <div class="category">${ev.level || 'General'}</div>
                <div class="event-name">${ev.name}</div>
              </div>
              <div class="result-actions">
                <span class="event-id-badge">#${ev.id}</span>
                <button class="btn-view">View</button>
              </div>
            </div>
            <div class="collapse" id="res-collapse-${ev.id}">
              <div class="result-body">
                ${winnersHtml}
              </div>
            </div>
          </div>
        `;
      }).join('');
  }

  function renderTeamMembers(teamId) {
    const list = document.getElementById('team-members-list');
    list.innerHTML = CACHE.students.filter(s => s.teamId === teamId).map(m => `
      <div class="p-2 border-bottom d-flex justify-content-between">
        <span>${m.name}</span>
        <span class="text-muted">${m.id}</span>
      </div>
    `).join('');
  }

  // Navigation Logic
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('section').forEach(s => s.classList.add('d-none'));
      document.getElementById(btn.dataset.target).classList.remove('d-none');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
  });

  document.getElementById('btnLogout').onclick = () => { sessionStorage.clear(); window.location.href='index.html'; };

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
