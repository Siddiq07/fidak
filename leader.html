<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader — Markaz Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* New UI/UX based on screenshots and modern dark theme */
    :root{
      --bg: #0f172a; /* Darker background */
      --card: #1e293b; /* Dark card background */
      --text: #f8fafc; /* Light text */
      --muted: #94a3b8; /* Muted text */
      --accent-orange: #f97316; /* Orange button/highlight */
      --accent-blue: #3b82f6; /* Blue button/highlight */
      --success: #10b981;
      --danger: #ef4444;
      --stat-red: #ef4444;
      --stat-orange: #f97316;
      --stat-pink: #db2777;
      --stat-dark: #1e3a8a;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background:var(--bg)}
    .container-wide{max-width:1100px;margin:14px auto;padding:0 12px}
    .card-neo{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.2);margin-bottom:14px}
    .section-title{font-weight:700;margin-bottom:12px;color:var(--text);font-size:1.2rem;}
    .muted{color:var(--muted)}
    .muted-small{color:var(--muted);font-size:13px}
    .btn-accent{background:var(--accent-orange);color:#fff;border:0}
    .btn-accent:hover{background:#ea580c;color:#fff}

    /* Top Nav Redesign */
    .top-nav{background:#0f172a;border-bottom:1px solid #1e293b;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    .brand{font-weight:800;color:var(--accent-orange);font-size:1.5rem}
    .nav-btn{color:var(--muted);border:1px solid #334155;background:#1e293b;}
    .nav-btn.active{background:var(--accent-blue);color:#fff;border-color:var(--accent-blue);box-shadow:none}

    /* Leader Info & Stats */
    .leader-info{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .leader-avatar{width:56px;height:56px;border-radius:10px;background:var(--accent-blue);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:1.5rem}
    .stats-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap:12px;
      margin-top:10px;
    }
    .stat{
      padding:20px;
      border-radius:10px;
      color:#fff;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      height: 100px;
      position: relative;
    }
    .stat .title{font-size:13px;font-weight:500;margin-bottom:4px}
    .stat .big{font-weight:800;font-size:2rem;line-height:1}
    .stat-bg-red{background-color:var(--stat-red);}
    .stat-bg-orange{background-color:var(--stat-orange);}
    .stat-bg-pink{background-color:var(--stat-pink);}
    .stat-bg-dark{background-color:var(--stat-dark);}

    /* Events Panel */
    .table-light, .table-light th{background-color:#334155 !important;color:var(--text);}
    .table{--bs-table-bg: var(--card);--bs-table-color: var(--text);}
    .participated-row{background:rgba(30, 41, 59, 0.5) !important;}

    /* Results Panel - Card/List style */
    .result-list-item {
        background: #1e293b;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        border-left: 5px solid var(--accent-orange);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .result-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    .result-event-name {
        font-weight: 700;
        font-size: 1.1rem;
        color: var(--accent-orange);
    }
    .result-status-badge {
        font-size: 0.8rem;
    }
    .result-position-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .result-position-list li {
        padding: 4px 0;
        border-bottom: 1px dashed #334155;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .result-position-list li:last-child {
        border-bottom: none;
    }
    .result-medal {
      font-size: 1.1rem;
      margin-right: 8px;
    }
    .participated-row .result-list-item { border-left-color: var(--success); }
    .participated-row .result-event-name { color: var(--success); }

    /* Small box for member selection */
    .small-box{
      width:70px;height:70px;
      border-radius:8px;
      background:#334155;
      display:inline-flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      margin:6px;cursor:pointer;font-weight:700;
      transition: background 0.2s;
    }
    .small-box .chess{font-weight:800;font-size:1.2rem;color:var(--text)}
    .small-box .name{font-size:11px;margin-top:2px;color:var(--muted);text-align:center;}
    .small-box.selected{background:var(--accent-blue);color:#fff}
    .small-box:hover{background:#475569}

    /* Modal Styling */
    .modal-content{background:var(--card);color:var(--text);}
    .modal-header{border-bottom-color: #334155;}
    .modal-footer{border-top-color: #334155;}
    .btn-close{filter: invert(1) grayscale(100%) brightness(200%);} /* Make close button white */

    @media (max-width:768px){
      .stats-grid{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width:500px){
      .stats-grid{grid-template-columns: 1fr;}
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="container container-wide d-flex align-items-center justify-content-between py-3">
      <div class="d-flex align-items-center gap-3">
        <div class="brand d-flex align-items-center gap-2"><i class="bi bi-person-badge-fill"></i> Leader Panel</div>
      </div>

      <div class="d-flex gap-2 align-items-center">
        <div class="muted-small d-none d-md-block">Year <span id="current-year"></span></div>
        <button id="btnLogout" class="btn btn-outline-light ms-2"><i class="bi bi-box-arrow-right"></i> Logout</button>
      </div>
    </div>

    <div class="container container-wide d-flex gap-2 py-2 overflow-x-auto">
      <button class="btn btn-light nav-btn active" data-target="#panel-dashboard">Dashboard</button>
      <button class="btn btn-light nav-btn" data-target="#panel-events">Events</button>
      <button class="btn btn-light nav-btn" data-target="#panel-results">Results</button>
      <button class="btn btn-light nav-btn" data-target="#panel-team">Team Info</button>
    </div>
  </nav>

  <main class="container container-wide">
    <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>

    <div id="panels-wrapper"></div>
    
    <section id="panel-dashboard">
      <div class="leader-info card-neo">
        <div id="leaderAvatar" class="leader-avatar">G</div>
        <div>
          <div id="leaderName" style="font-weight:800; font-size: 1.5rem;">Guest</div>
          <div id="leaderTeamName" class="muted-small">Team: -</div>
        </div>
      </div>
      <div id="lockedBanner" class="locked-banner d-none mt-3 card-neo" style="border-left: 5px solid var(--danger);">Your team is locked by admin. Please contact admin.</div>

      <div class="section-title mt-4">Team Overview</div>
      <div class="stats-grid">
        <div class="stat stat-bg-red">
          <div class="title">Team Score</div>
          <div id="statScore" class="big">0</div>
        </div>
        <div class="stat stat-bg-orange">
          <div class="title">Members</div>
          <div id="statMembers" class="big">0</div>
        </div>
        <div class="stat stat-bg-pink">
          <div class="title">Attendance % (team)</div>
          <div id="statAttendance" class="big">0%</div>
        </div>
        <div class="stat stat-bg-dark">
          <div class="title">Approved Events</div>
          <div id="quickApproved" class="big">0</div>
        </div>
      </div>

      <div class="mt-4 card-neo">
        <div class="section-title">Submission Summary</div>
        <div class="row g-3">
          <div class="col-6 col-md-4"><div class="muted-small">Total Events Nominated: <span id="quickAdded" style="font-weight:700">0</span></div></div>
          <div class="col-6 col-md-4"><div class="muted-small">Pending Submissions: <span id="quickPending" style="font-weight:700">0</span></div></div>
          <div class="col-12 col-md-4 text-md-end">
            <button id="btnDownloadTeamPdf" class="btn btn-outline-light btn-sm"><i class="bi bi-file-earmark-pdf"></i> Export Member List</button>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-events" class="card-neo d-none">
      <div class="section-title">Events — choose and submit participants</div>
      <div class="row g-3">
        <div class="col-lg-5">
          <div class="card-neo">
            <label class="form-label muted-small">Filter / Search</label>
            <div class="d-flex gap-2 mb-2">
              <input id="eventSearch" class="form-control form-control-dark" placeholder="Search by name / type / level" style="background:#334155;color:var(--text);border:1px solid #475569">
              <select id="filterType" class="form-select form-select-dark" style="background:#334155;color:var(--text);border:1px solid #475569"><option value="">All Types</option><option>Stage</option><option>Non-Stage</option><option>Off-Stage</option></select>
              <select id="filterLevel" class="form-select form-select-dark" style="background:#334155;color:var(--text);border:1px solid #475569"><option value="">All Levels</option><option>Junior</option><option>Senior</option><option>General</option><option>Special</option></select>
            </div>
            <div class="section-title mt-3">Available Events</div>
            <div class="table-responsive" style="max-height:400px;overflow:auto">
              <table class="table table-sm table-striped">
                <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Level</th><th></th></tr></thead>
                <tbody id="eventsList"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="col-lg-7">
          <div class="card-neo">
            <div class="section-title">Selected Event</div>
            <div id="selectedEventWrap" class="muted-small mb-2">Select an event to load team members for nomination.</div>
            <div id="selectedEventName" style="font-weight:800;font-size:1.3rem;"></div>
            <div id="selectedEventMeta" class="muted-small mb-3"></div>

            <div class="section-title">Team members (click Chess # to select)</div>
            <div id="membersSelection" style="min-height:180px;max-height:360px;overflow:auto;padding:6px;display:flex;flex-wrap:wrap;border:1px solid #334155;border-radius:8px;"></div>

            <div class="mt-3 d-flex gap-2">
              <button id="btnSubmitParticipation" class="btn btn-accent"><i class="bi bi-send-fill"></i> Submit Participation</button>
              <button id="btnClearSelection" class="btn btn-outline-secondary"><i class="bi bi-x-circle"></i> Clear</button>
              <button id="btnViewSubmissions" class="btn btn-outline-info"><i class="bi bi-check2-circle"></i> My Submissions</button>
              <div class="ms-auto muted-small align-self-center" id="selectionInfo">0 selected</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-results" class="card-neo d-none">
      <div class="section-title">Results (Published)</div>
      <div class="muted-small mb-3">Green bar indicates event has published results. Grey indicates draft or no results.</div>
      <div id="leaderResultsList" class="results-container">
        </div>
    </section>

    <section id="panel-team" class="card-neo d-none">
      <div class="section-title">Team Info</div>
      <div id="teamInfoWrap" class="muted-small mb-3"></div>
      <div class="section-title">Members List</div>
      <div id="teamMembersSmall" class="card-neo" style="max-height:360px;overflow:auto;padding:12px">
        </div>
    </section>
    
    <input type="hidden" id="leaderTeamDbKey">
    <input type="hidden" id="leaderTeamId">
    <input type="hidden" id="leaderStudentId">

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Confirm</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body" id="confirmBody">Are you sure?</div>
          <div class="modal-footer">
            <button id="confirmNo" class="btn btn-outline-secondary" data-bs-dismiss="modal">No</button>
            <button id="confirmYes" class="btn btn-accent">Yes</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="participationStatusModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Your Team Submissions</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <div class="alert alert-info muted-small">Showing **All** nominations. Only **Approved** ones will be included in the PDF export below.</div>
            <div id="yourSubmissionsList" style="max-height:420px;overflow:auto; border: 1px solid #334155; border-radius: 8px; padding: 10px;">
              </div>
          </div>
          <div class="modal-footer">
            <button id="btnDownloadSubmissionsPdf" class="btn btn-success me-auto"><i class="bi bi-file-earmark-pdf-fill"></i> Export Approved Events PDF</button>
            <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="namePopupModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header"><h5 class="modal-title">Student</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body" id="namePopupBody"></div>
        </div>
      </div>
    </div>
  </main>
<script type="module">
// ... existing firebase imports and helpers ...
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, push, set, update, onValue, get, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

/* Firebase config - use your project's config */
const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* helpers */
const $ = id => document.getElementById(id);
function toast(msg, type='success'){ const el=document.createElement('div'); el.className=`toast align-items-center text-bg-${type} border-0`; el.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`; $('toastRoot').appendChild(el); const t=new bootstrap.Toast(el,{delay:3000}); t.show(); el.addEventListener('hidden.bs.toast', ()=> el.remove()); }
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function encodeKey(k){ return encodeURIComponent(String(k)); }
function decodeKey(k){ return decodeURIComponent(String(k)); }

/* caches & keymaps */
let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
let KEYMAP = { students: {}, teams: {}, events: {}, participations: [], results: {} };

/* db refs */
const studentsRef = ref(db, 'students');
const teamsRef = ref(db, 'teams');
const eventsRef = ref(db, 'events');
const partsRef = ref(db, 'participations');
const resultsRef = ref(db, 'results');
const attendanceRef = ref(db, 'attendance');

/* realtime listeners */
onValue(studentsRef, snap => { const obj = snap.val() || {}; CACHE.students = Object.values(obj); KEYMAP.students = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.students[String(v.id)] = k)); renderAll(); });
onValue(teamsRef, snap => { const obj = snap.val() || {}; CACHE.teams = Object.values(obj); KEYMAP.teams = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.teams[String(v.id)] = k)); renderAll(); });
onValue(eventsRef, snap => { const obj = snap.val() || {}; CACHE.events = Object.values(obj); KEYMAP.events = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.events[String(v.id)] = k)); renderAll(); });
onValue(partsRef, snap => { const obj = snap.val() || {}; CACHE.participations = Object.values(obj); KEYMAP.participations = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.participations[String(v.id)] = k)); renderAll(); });
onValue(resultsRef, snap => { const obj = snap.val() || {}; CACHE.results = Object.values(obj); KEYMAP.results = {}; Object.entries(obj).forEach(([k,v])=> v && v.id !== undefined && (KEYMAP.results[String(v.id)] = k)); renderAll(); });
onValue(attendanceRef, snap => { CACHE.attendance = snap.val() || {}; renderAll(); });

/* nav wiring */
document.querySelectorAll('[data-target]').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    document.querySelectorAll('main > section').forEach(s => s.classList.add('d-none'));
    const panel = document.querySelector(btn.dataset.target);
    if(panel) panel.classList.remove('d-none');
    document.querySelectorAll('.nav-btn').forEach(b=> b.classList.remove('active'));
    btn.classList.add('active');
    window.scrollTo({top:0,behavior:'smooth'});
  });
});

/* leader state (driven by URL param ?leader=CHESS OR sessionStorage.leaderId), and home login should redirect to this page with ?leader=CHESS */
let LEADER = { active:false, leaderId:null, teamId:null, teamDbKey:null };

/* detect leader from ?leader=CHESS or sessionStorage */
function detectLeaderFromUrlOrSession(){
  const url = new URL(location.href);
  const q = url.searchParams.get('leader') || sessionStorage.getItem('leaderId') || '';
  if(!q) return false;
  // find student & team
  const student = CACHE.students.find(s => String(s.id) === String(q));
  const team = CACHE.teams.find(t => String(t.leaderId) === String(q));
  if(student && team){
    setLeaderState(q, team.id);
    return true;
  }
  return false;
}

/* set leader state */
function setLeaderState(leaderId, teamId){
  const stud = CACHE.students.find(s=> String(s.id) === String(leaderId));
  const team = CACHE.teams.find(t => String(t.id) === String(teamId));
  if(!stud || !team) return false;
  LEADER = { active:true, leaderId: String(leaderId), teamId: String(team.id), teamDbKey: KEYMAP.teams[team.id] || null };
  sessionStorage.setItem('leaderId', String(leaderId));
  $('leaderStudentId').value = leaderId;
  $('leaderTeamId').value = team.id;
  $('leaderTeamDbKey').value = LEADER.teamDbKey || '';
  $('leaderName').textContent = stud.name || leaderId;
  $('leaderAvatar').textContent = (stud.name||'L').slice(0,1).toUpperCase();
  $('leaderTeamName').textContent = `Team: ${team.name || ''}`;
  if(team.locked) $('lockedBanner').classList.remove('d-none'); else $('lockedBanner').classList.add('d-none');
  renderAll();
  return true;
}

/* logout clears leader session */
$('btnLogout').addEventListener('click', ()=> {
  sessionStorage.removeItem('leaderId');
  LEADER = { active:false, leaderId:null, teamId:null, teamDbKey:null };
  $('leaderName').textContent = 'Guest';
  $('leaderAvatar').textContent = 'G';
  $('leaderTeamName').textContent = 'Team: -';
  $('leaderTeamDbKey').value = '';
  // go to dashboard guest
  document.querySelector('[data-target="#panel-dashboard"]').click();
  renderAll();
});

/* boot */
setTimeout(()=> {
  try{ $('current-year').textContent = new Date().getFullYear(); }catch(e){}
  // attempt auto-detect (when caches have loaded it will be called again inside renderAll)
  detectLeaderFromUrlOrSession();
  // show dashboard by default
  document.querySelector('[data-target="#panel-dashboard"]').click();
}, 400);

/* ---------- renderAll: populate lists + stats ---------- */
function renderAll(){
  populateEventsList();
  renderLeaderDashboard();
  renderResultsList(); // Use new function for list rendering
  populateTeamLists();
  // renderAllStudentsBox(); // Removed from dashboard
  computeQuickStats();
  // attempt detect leader again at data arrival
  if(!LEADER.active) detectLeaderFromUrlOrSession();
}

/* ---------- EVENTS list with search/filter ---------- */
function populateEventsList(){
  const tbody = $('eventsList');
  const q = ($('eventSearch')?.value||'').trim().toLowerCase();
  const fType = ($('filterType')?.value || '').trim();
  const fLevel = ($('filterLevel')?.value || '').trim();
  if(!CACHE.events.length){ tbody.innerHTML = '<tr><td colspan="4" class="muted-small">No events</td></tr>'; return; }
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  let html = '';
  CACHE.events.forEach(ev => {
    if(fType && (ev.type||'').toLowerCase() !== fType.toLowerCase()) return;
    if(fLevel && (ev.level||'').toLowerCase() !== fLevel.toLowerCase()) return;
    if(q){
      const hay = `${ev.name} ${ev.type} ${ev.level}`.toLowerCase();
      if(!hay.includes(q)) return;
    }
    const anyPublished = CACHE.results.some(r => String(r.eventId) === String(ev.id) && r.published);
    const rowClass = anyPublished ? 'participated-row' : '';
    html += `<tr class="${rowClass}"><td>${escapeHtml(ev.name)}</td><td>${escapeHtml(ev.type)}</td><td>${escapeHtml(ev.level||'')}</td><td class="text-end"><button class="btn btn-sm btn-outline-primary btn-select-event" data-id="${ev.id}">Select</button></td></tr>`;
  });
  tbody.innerHTML = html || '<tr><td colspan="4" class="muted-small">No events match</td></tr>';
}
$('eventSearch')?.addEventListener('input', populateEventsList);
$('filterType')?.addEventListener('change', populateEventsList);
$('filterLevel')?.addEventListener('change', populateEventsList);

/* delegated click for selecting event */
document.addEventListener('click', (e)=>{
  const b = e.target.closest('.btn-select-event');
  if(!b) return;
  const evId = b.dataset.id;
  selectEvent(evId);
});

/* ---------- selectEvent: show team members only, choose by level rules ---------- */
function selectEvent(evId){
  const ev = CACHE.events.find(x => String(x.id) === String(evId));
  if(!ev) return toast('Event not found','danger');
  $('selectedEventName').textContent = ev.name;
  $('selectedEventMeta').textContent = `${ev.type} — ${ev.level || 'General'}`;
  $('selectedEventWrap').classList.remove('muted-small');

  // must have leader selected
  if(!LEADER.active || !LEADER.teamId) {
    $('membersSelection').innerHTML = '<div class="muted-small p-2">Open site from Home login to act as your team.</div>';
    return;
  }

  // candidate pool: only members of leader's team
  let members = CACHE.students.filter(s => String(s.teamId) === String(LEADER.teamId));
  if(!members.length){ $('membersSelection').innerHTML = '<div class="muted-small p-2">No members in your team</div>'; return; }

  // filter by event level if Junior/Senior
  const lvl = (ev.level||'').toLowerCase();
  if(lvl === 'junior') members = members.filter(m => String(m.level||'').toLowerCase() === 'junior');
  else if(lvl === 'senior') members = members.filter(m => String(m.level||'').toLowerCase() === 'senior');

  // get current selections for this event from this team
  const currentSelections = CACHE.participations
    .filter(p => String(p.eventId) === String(evId) && String(p.teamId) === String(LEADER.teamId))
    .map(p => String(p.studentId));

  const wrap = $('membersSelection');
  wrap.innerHTML = '';
  members.forEach(s => {
    const div = document.createElement('div');
    div.className = 'small-box';
    div.dataset.id = s.id;
    div.dataset.level = s.level || '';
    div.title = s.name || s.id;
    // Pre-select if already nominated
    if (currentSelections.includes(String(s.id))) {
        div.classList.add('selected');
    }

    // show chess# prominent and name below small
    div.innerHTML = `<div class="chess">${escapeHtml(s.id)}</div><div class="name">${escapeHtml(s.name.split(' ')[0])}</div>`; // show only first name
    
    div.addEventListener('click', (evClick)=>{
      const clickedText = evClick.target;
      if(clickedText && clickedText.classList && clickedText.classList.contains('name')){
        showNamePopup(s);
        return;
      }
      toggleMemberSelectForEvent(div, ev);
    });
    wrap.appendChild(div);
  });

  $('membersSelection').dataset.evId = evId;
  updateSelectionInfo();
}

/* show name popup */
function showNamePopup(student){
  $('namePopupBody').innerHTML = `<div style="font-weight:700">${escapeHtml(student.name)}</div><div class="muted-small">Chess #: ${escapeHtml(student.id)}</div><div class="muted-small">Level: ${escapeHtml(student.level||'')}</div>`;
  new bootstrap.Modal(document.getElementById('namePopupModal')).show();
}

/* toggle selection enforcing limits: */
function toggleMemberSelectForEvent(el, ev){
  if(!LEADER.active) return toast('You must be acting as leader (home login) to select','warning');
  if(!el) return;
  const evId = $('membersSelection').dataset.evId;
  if(!evId) return toast('Select event first','danger');

  // Get current state from the DOM (selected or not)
  const isSelected = el.classList.contains('selected');

  // Total selected currently in the UI
  const selectedBoxes = Array.from(document.querySelectorAll('#membersSelection .small-box.selected'));

  // 1. If currently selected => unselect (no limits check needed)
  if(isSelected) { 
    el.classList.remove('selected'); 
    updateSelectionInfo(); 
    return; 
  }

  // 2. If trying to select: check limits

  // a. Check per-event total limit
  if(selectedBoxes.length >= 2){
    return toast('Per-event limit reached: only 2 participants allowed from a single team for this event.','danger');
  }

  // b. Check per-member cumulative limits
  const memberId = el.dataset.id;
  const memberObj = CACHE.students.find(s => String(s.id) === String(memberId));
  const memberLevel = (memberObj && memberObj.level) ? String(memberObj.level) : 'Senior';
  const evTypeNormalized = ((ev.type||'Non-Stage').toLowerCase().includes('stage')) ? 'Stage' : 'Non-Stage';
  const caps = { Senior: { Stage:3, 'Non-Stage':4 }, Junior: { Stage:2, 'Non-Stage':3 } };
  const allowed = (caps[memberLevel] && caps[memberLevel][evTypeNormalized]) ? caps[memberLevel][evTypeNormalized] : (evTypeNormalized==='Stage'?3:4);

  // Count current *existing* (not just what's selected in the UI) nominations for this member by this team for events of same evTypeNormalized
  const teamId = LEADER.teamId;
  const existingNominations = memberNominationsCountForType(teamId, memberId, evTypeNormalized);

  // The count needs to *exclude* the current event if the member is already nominated in it,
  // but since we clear selection on submit, a simpler way is to count existing submissions *excluding* this event.
  // A safer check is: total submissions *plus one* (the current selection)
  
  if(existingNominations + 1 > allowed) {
    return toast(`This member (${memberObj ? memberObj.name : memberId}) already has ${existingNominations} ${evTypeNormalized} nomination(s). Allowed: ${allowed}.`,'danger');
  }

  // passed checks -> select
  el.classList.add('selected');
  updateSelectionInfo();
}

/* update selection info */
function updateSelectionInfo(){
  const sel = Array.from(document.querySelectorAll('#membersSelection .small-box.selected'));
  $('selectionInfo').textContent = `${sel.length} selected`;
}

/* clear selection */
$('btnClearSelection').addEventListener('click', ()=> {
  document.querySelectorAll('#membersSelection .small-box.selected').forEach(b=>b.classList.remove('selected'));
  updateSelectionInfo();
});

/* submit participation: create/update participation entries */
$('btnSubmitParticipation').addEventListener('click', async ()=>{
  if(!LEADER.active || !LEADER.teamId) return toast('You must be acting as leader (home login) to submit','danger');
  const evId = $('membersSelection').dataset.evId;
  if(!evId) return toast('Select an event first','danger');
  const sel = Array.from(document.querySelectorAll('#membersSelection .small-box.selected'));

  // Get existing nominations for this event and team
  const existingParts = CACHE.participations.filter(p => 
    String(p.eventId) === String(evId) && String(p.teamId) === String(LEADER.teamId)
  );
  
  const selectedIds = new Set(sel.map(b => b.dataset.id));
  const existingIds = new Set(existingParts.map(p => String(p.studentId)));

  let created = 0, skipped = 0, removed = 0;

  // 1. Create new participations (selected, but not existing)
  for(const studId of selectedIds){
    if(!existingIds.has(studId)){
      // Double-check per-event team limit at server side by current DB state before pushing new ones
      if(existingParts.length + created >= 2){
          // This should ideally be caught by the UI check, but as a final safeguard
          toast('Cannot submit: adding this member would exceed per-event limit (2).','danger');
          continue; 
      }
      const p = push(ref(db, 'participations'));
      const id = Date.now().toString() + Math.floor(Math.random()*9999);
      await set(p, { id, eventId: evId, studentId: studId, teamId: LEADER.teamId || null, status:'pending', submittedAt: Date.now() });
      created++;
    } else {
      skipped++; // already exists
    }
  }

  // 2. Remove old participations (existing, but not selected) - only if status is pending
  for(const part of existingParts){
    if(!selectedIds.has(String(part.studentId))){
      if (String(part.status||'').toLowerCase() === 'pending') {
        const partDbKey = KEYMAP.participations[part.id];
        if (partDbKey) {
            await remove(ref(db, `participations/${partDbKey}`));
            removed++;
        }
      } else {
        toast(`Could not remove ${part.studentId} from ${evId} because status is '${part.status}'.`,'warning');
        skipped++; // Not selected, but can't remove
      }
    }
  }

  if(created || removed) toast(`Submissions: ${created} created, ${removed} removed.`);
  if(skipped) toast(`${skipped} already submitted/irremovable (skipped)`, 'warning');

  // clear selection (will be re-rendered on data update from onValue)
  $('btnClearSelection').click();
  computeQuickStats();
}

/* view submissions modal */
$('btnViewSubmissions').addEventListener('click', ()=> {
  renderYourSubmissions();
  new bootstrap.Modal(document.getElementById('participationStatusModal')).show();
});

/* ---------- Dashboard & Team ---------- */
function populateTeamLists(){
  // The 'teamMembersList' is removed from the dashboard, only populating 'teamMembersSmall'
  const smallWrap = $('teamMembersSmall');
  const teamInfo = $('teamInfoWrap');
  smallWrap.innerHTML = ''; teamInfo.innerHTML = '';

  if(!LEADER.active || !LEADER.teamId){
    smallWrap.innerHTML = '<div class="muted-small">Act as leader to see team members</div>';
    teamInfo.innerHTML = '<div class="muted-small">No team information available.</div>';
    return;
  }
  
  const team = CACHE.teams.find(t => String(t.id) === String(LEADER.teamId)) || {};
  teamInfo.innerHTML = `
    <div>**Team Name:** ${escapeHtml(team.name || 'N/A')}</div>
    <div>**Team ID:** ${escapeHtml(team.id || 'N/A')}</div>
    <div>**Leader Chess #:** ${escapeHtml(LEADER.leaderId)}</div>
    <div>**Locked:** ${team.locked ? '<span class="badge bg-danger">YES</span>' : '<span class="badge bg-success">NO</span>'}</div>
  `;

  const members = CACHE.students.filter(s => String(s.teamId) === String(LEADER.teamId));
  if(!members.length){ smallWrap.innerHTML = '<div class="muted-small">No members</div>'; return; }
  
  members.forEach(m => {
    const small = document.createElement('div'); small.style.padding='6px 4px'; small.style.borderBottom='1px solid #334155';
    small.innerHTML = `<div><span style="font-weight:600">${escapeHtml(m.name)}</span> <span class="muted-small">(${escapeHtml(m.id)})</span></div><div class="muted-small">Level: ${escapeHtml(m.level||'')}</div>`;
    smallWrap.appendChild(small);
  });
}

/* compute team attendance %: only team members considered */
function computeTeamAttendancePercent(){
  if(!LEADER.active || !LEADER.teamId) return 0;
  const members = CACHE.students.filter(s => String(s.teamId) === String(LEADER.teamId)).map(s=>String(s.id));
  if(!members.length) return 0;
  const att = CACHE.attendance || {};
  let presentCount = 0;
  let possible = 0;
  Object.values(att).forEach(sess => {
    if(!sess || !sess.students) return;
    members.forEach(mid => {
      // Only count attendance if the session has a record for the student
      if(sess.students[mid] !== undefined){
        possible++;
        if(String(sess.students[mid]).toLowerCase() === 'present') presentCount++;
      }
    });
  });
  if(possible === 0) return 0;
  return Math.round((presentCount / possible) * 100);
}

/* render leader dashboard stats */
function renderLeaderDashboard(){
  let teamScore = 0;
  let membersCount = 0;
  if(LEADER.active && LEADER.teamId){
    const team = CACHE.teams.find(t => String(t.id) === String(LEADER.teamId));
    teamScore = team ? (Number(team.score) || 0) : 0;
    membersCount = CACHE.students.filter(s => String(s.teamId) === String(LEADER.teamId)).length;
  }
  $('statScore').textContent = teamScore;
  $('statMembers').textContent = membersCount;
  const attPct = computeTeamAttendancePercent();
  $('statAttendance').textContent = `${attPct}%`;
  populateTeamLists();
  computeQuickStats();
}

/* quick stats: added events, pending, approved for this team */
function computeQuickStats(){
  if(!LEADER.active || !LEADER.teamId){
    $('quickAdded').textContent = '0';
    $('quickPending').textContent = '0';
    $('quickApproved').textContent = '0';
    return;
  }
  const teamId = LEADER.teamId;
  const parts = CACHE.participations.filter(p => String(p.teamId) === String(teamId));
  const addedEvents = new Set(parts.map(p => p.eventId));
  const pending = parts.filter(p => String(p.status||'').toLowerCase() === 'pending').length;
  const approved = parts.filter(p => String(p.status||'').toLowerCase() === 'approved').length;
  $('quickAdded').textContent = addedEvents.size;
  $('quickPending').textContent = pending;
  $('quickApproved').textContent = approved; // Used in the Dashboard stats grid
}

/* ---------- Results view for leaders (Published List View) ---------- */
function renderResultsList(){
  const wrap = $('leaderResultsList');
  if(!CACHE.events.length){ wrap.innerHTML = '<div class="muted-small card-neo">No events available.</div>'; return; }
  
  const evMap = {};
  CACHE.results.forEach(r => {
    if(!evMap[r.eventId]) evMap[r.eventId] = {};
    evMap[r.eventId][r.position] = r;
  });
  
  let html = '';
  CACHE.events.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  
  CACHE.events.forEach(ev => {
    const pos = evMap[ev.id] || {};
    const anyResult = !!pos[1] || !!pos[2] || !!pos[3];
    const pub = (pos[1] && pos[1].published) || (pos[2] && pos[2].published) || (pos[3] && pos[3].published);
    
    // Skip if no results and not the current leader's event
    if (!anyResult) return; 

    const statusBadge = pub 
      ? '<span class="badge bg-success result-status-badge"><i class="bi bi-check-circle-fill"></i> Published</span>' 
      : '<span class="badge bg-secondary result-status-badge"><i class="bi bi-clock-history"></i> Draft</span>';

    const rowClass = pub ? 'participated-row' : '';

    const getPlacement = (position) => {
      const r = pos[position];
      if (!r) return { icon: '', text: 'No placement' };
      const stud = CACHE.students.find(s=>String(s.id)===String(r.studentId)) || {name:r.studentId, id:r.studentId};
      const icon = position === 1 ? '<i class="bi bi-trophy-fill text-warning result-medal"></i>' : 
                   position === 2 ? '<i class="bi bi-trophy-fill" style="color:#A9A9A9;"></i>' : 
                   position === 3 ? '<i class="bi bi-trophy-fill" style="color:#CD7F32;"></i>' : '';
      return { 
        icon, 
        text: `${escapeHtml(stud.name)} ${stud.id ? `(${escapeHtml(stud.id)})` : ''}` 
      };
    };

    const p1 = getPlacement(1);
    const p2 = getPlacement(2);
    const p3 = getPlacement(3);

    html += `
      <div class="result-list-item ${rowClass}">
        <div class="result-list-header">
          <div class="result-event-name">${escapeHtml(ev.name)}</div>
          ${statusBadge}
        </div>
        <ul class="result-position-list">
          <li>${p1.icon} **1st Place:** ${p1.text}</li>
          <li>${p2.icon} **2nd Place:** ${p2.text}</li>
          <li>${p3.icon} **3rd Place:** ${p3.text}</li>
        </ul>
        <div class="muted-small text-end mt-2">${escapeHtml(ev.level || 'General')} | ${escapeHtml(ev.type)}</div>
      </div>
    `;
  });
  
  wrap.innerHTML = html || '<div class="muted-small card-neo">No results published yet.</div>';
}

/* ---------- renderYourSubmissions (modal) ---------- */
function renderYourSubmissions(){
  const wrap = $('yourSubmissionsList');
  wrap.innerHTML = '';
  if(!LEADER.active || !LEADER.teamId) { wrap.innerHTML = '<div class="muted-small">Act as a leader to view submissions</div>'; return; }
  const subs = CACHE.participations.filter(p => String(p.teamId) === String(LEADER.teamId));
  if(!subs.length) { wrap.innerHTML = '<div class="muted-small">No submissions</div>'; return; }
  subs.sort((a,b)=> (b.submittedAt||0) - (a.submittedAt||0));
  
  subs.forEach(s => {
    const ev = CACHE.events.find(e => String(e.id) === String(s.eventId)) || {};
    const stud = CACHE.students.find(st => String(st.id) === String(s.studentId)) || { name: s.studentId };
    const status = s.status || 'pending';
    const statusClass = status.toLowerCase() === 'approved' ? 'text-success' : status.toLowerCase() === 'pending' ? 'text-warning' : 'text-danger';
    
    const row = document.createElement('div'); row.style.padding='8px'; row.style.borderBottom='1px solid #334155';
    row.innerHTML = `<div style="font-weight:700">${escapeHtml(ev.name||s.eventId)}</div>
      <div class="muted-small d-flex justify-content-between align-items-center">
        <span>${escapeHtml(stud.name)} (${escapeHtml(s.studentId)})</span>
        <span class="${statusClass}" style="font-weight:600">${escapeHtml(status.toUpperCase())}</span>
      </div>`;
    wrap.appendChild(row);
  });
}
document.getElementById('participationStatusModal')?.addEventListener('show.bs.modal', renderYourSubmissions);

/* ---------- Export team PDF (Member List) ---------- */
$('btnDownloadTeamPdf').addEventListener('click', ()=>{
  if(!LEADER.active || !LEADER.teamId) return toast('Act as leader to export team','danger');
  const team = CACHE.teams.find(t => String(t.id) === String(LEADER.teamId)) || {};
  const members = CACHE.students.filter(s => String(s.teamId) === String(LEADER.teamId));
  
  let html = `<h2 style="color:#f97316;">Team Member List: ${escapeHtml(team.name || 'N/A')}</h2>
    <p>Leader Chess #: ${escapeHtml(LEADER.leaderId)}</p>
    <table style="width:100%; border-collapse:collapse; margin-top:15px;">
      <thead>
        <tr style="background-color:#3b82f6; color:#fff;">
          <th style="padding:8px; border:1px solid #ddd;">Chess #</th>
          <th style="padding:8px; border:1px solid #ddd; text-align:left;">Name</th>
          <th style="padding:8px; border:1px solid #ddd;">Level</th>
        </tr>
      </thead>
      <tbody>`;
  members.forEach(m => html += `
        <tr>
          <td style="padding:8px; border:1px solid #ddd; text-align:center;">${escapeHtml(m.id)}</td>
          <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(m.name)}</td>
          <td style="padding:8px; border:1px solid #ddd; text-align:center;">${escapeHtml(m.level||'')}</td>
        </tr>`);
  html += '</tbody></table>';
  
  html2pdf().from(html).set({margin:10,filename:`team_members_${new Date().toISOString().slice(0,10)}.pdf`}).save();
});

/* ---------- NEW Export Approved Events PDF ---------- */
$('btnDownloadSubmissionsPdf').addEventListener('click', ()=>{
  if(!LEADER.active || !LEADER.teamId) return toast('Act as leader to export submissions','danger');

  // 1. Filter for Approved Submissions
  const approvedSubs = CACHE.participations.filter(p => 
    String(p.teamId) === String(LEADER.teamId) && 
    String(p.status||'').toLowerCase() === 'approved'
  );

  if (approvedSubs.length === 0) return toast('No approved submissions to export.','warning');

  // 2. Group by Event
  const eventsMap = new Map(); // Map<eventId, Array<studentId>>
  approvedSubs.forEach(p => {
    const eventId = String(p.eventId);
    if (!eventsMap.has(eventId)) eventsMap.set(eventId, []);
    eventsMap.get(eventId).push(String(p.studentId));
  });

  // 3. Build HTML for PDF in the requested format
  let html = `<h2>Approved Event Participation List</h2>
    <p>Team ID: ${escapeHtml(LEADER.teamId)} | Export Date: ${new Date().toLocaleDateString()}</p>
    <div style="margin-top: 20px;">`;
  
  let eventIndex = 1;
  for (const [eventId, studentIds] of eventsMap.entries()) {
    const ev = CACHE.events.find(e => String(e.id) === eventId) || {name:'Unknown Event'};
    
    html += `
      <div style="margin-bottom: 20px;">
        <h3 style="color:#3b82f6;">${eventIndex}. ${escapeHtml(ev.name)}</h3>
        <ol style="padding-left: 20px;">
    `;
    
    let memberIndex = 1;
    studentIds.forEach(studentId => {
      const stud = CACHE.students.find(s => String(s.id) === studentId) || { name: 'Unknown Member', id: studentId };
      html += `
        <li style="margin-bottom: 5px;">
          ${memberIndex}. **${escapeHtml(stud.name)}** (Chess # ${escapeHtml(stud.id)})
        </li>
      `;
      memberIndex++;
    });

    html += `</ol></div>`;
    eventIndex++;
  }

  html += '</div>';

  html2pdf().from(html).set({
    margin: 10,
    filename: `approved_events_${new Date().toISOString().slice(0,10)}.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).save();

  toast('Generating Approved Events PDF...','info');
});


/* ---------- Utility: compute per-member nominations count of type for team (used by UI checks) ---------- */
function memberNominationsCountForType(teamId, studentId, evTypeNormalized){
  const parts = CACHE.participations.filter(p => String(p.teamId) === String(teamId) && String(p.studentId) === String(studentId));
  let c = 0;
  parts.forEach(p => {
    const ev = CACHE.events.find(e => String(e.id) === String(p.eventId));
    if(!ev) return;
    const t = ((ev.type||'Non-Stage').toLowerCase().includes('stage')) ? 'Stage' : 'Non-Stage';
    if(t === evTypeNormalized) c++;
  });
  return c;
}

/* ---------- Final: expose few console helpers for debugging ---------- */
window._CACHE = CACHE;
window._LEADER = LEADER;
window._setLeader = setLeaderState;

console.log('Leader panel script loaded');
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
