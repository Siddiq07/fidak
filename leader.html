<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leader Dashboard - Fidak Fest</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --warning: #f72585;
      --danger: #e63946;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    /* Card Styles */
    .dashboard-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
      cursor: pointer;
      height: 100%;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }
    
    .event-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid var(--primary);
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .event-card:hover {
      transform: translateX(5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .member-card {
      background: white;
      border-radius: 10px;
      padding: 12px;
      margin: 5px;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .member-card.selected {
      border-color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }
    
    .member-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Badges */
    .badge-stage {
      background: linear-gradient(45deg, #ff9a9e, #fad0c4);
      color: #333;
    }
    
    .badge-offstage {
      background: linear-gradient(45deg, #a1c4fd, #c2e9fb);
      color: #333;
    }
    
    .badge-group {
      background: linear-gradient(45deg, #ffecd2, #fcb69f);
      color: #333;
    }
    
    .badge-open {
      background: linear-gradient(45deg, #84fab0, #8fd3f4);
      color: #333;
    }
    
    .badge-junior {
      background: linear-gradient(45deg, #fbc2eb, #a6c1ee);
      color: #333;
    }
    
    .badge-senior {
      background: linear-gradient(45deg, #f6d365, #fda085);
      color: #333;
    }
    
    /* Status Badges */
    .badge-pending {
      background: linear-gradient(45deg, #ffd89b, #19547b);
      color: white;
    }
    
    .badge-approved {
      background: linear-gradient(45deg, #56ab2f, #a8e063);
      color: white;
    }
    
    /* Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      padding: 10px 0;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      justify-content: space-around;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px 15px;
      border-radius: 10px;
      color: var(--gray);
      text-decoration: none;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .nav-item.active {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }
    
    .nav-item i {
      font-size: 22px;
      margin-bottom: 4px;
    }
    
    .nav-item span {
      font-size: 12px;
      font-weight: 500;
    }
    
    /* Tabs */
    .filter-tabs {
      display: flex;
      overflow-x: auto;
      padding: 10px 0;
      gap: 10px;
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
    }
    
    .filter-tab {
      padding: 8px 20px;
      border-radius: 25px;
      background: white;
      border: 2px solid var(--light-gray);
      color: var(--gray);
      font-weight: 600;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .filter-tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    /* Progress Bar */
    .limit-progress {
      height: 8px;
      border-radius: 4px;
      background: var(--light-gray);
      overflow: hidden;
      margin: 5px 0;
    }
    
    .limit-progress-fill {
      height: 100%;
      background: linear-gradient(45deg, var(--primary), var(--primary-light));
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    
    .custom-toast {
      background: white;
      border-radius: 10px;
      padding: 15px 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      margin-bottom: 10px;
      animation: slideIn 0.3s ease;
      max-width: 300px;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .main-container {
        padding: 15px;
        padding-bottom: 80px; /* Space for bottom nav */
      }
      
      .dashboard-card {
        margin-bottom: 15px;
      }
      
      .filter-tabs {
        padding: 10px 5px;
      }
      
      .filter-tab {
        padding: 6px 15px;
        font-size: 14px;
      }
    }
    
    @media (min-width: 769px) {
      .bottom-nav {
        display: none;
      }
      
      .desktop-nav {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
        gap: 20px;
      }
      
      .desktop-nav-item {
        padding: 12px 25px;
        border-radius: 25px;
        background: white;
        border: 2px solid transparent;
        color: var(--gray);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .desktop-nav-item.active {
        background: var(--primary);
        color: white;
        box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
      }
    }
    
    /* Loading Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--light-gray);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Utility Classes */
    .gradient-primary {
      background: linear-gradient(45deg, var(--primary), var(--primary-light));
      color: white;
    }
    
    .text-gradient {
      background: linear-gradient(45deg, var(--primary), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
  </style>
</head>
<body>
  <!-- Desktop Navigation -->
  <div class="desktop-nav">
    <div class="desktop-nav-item active" data-page="dashboard">
      <i class="bi bi-speedometer2 me-2"></i> Dashboard
    </div>
    <div class="desktop-nav-item" data-page="nominations">
      <i class="bi bi-calendar-plus me-2"></i> Nominations
    </div>
    <div class="desktop-nav-item" data-page="status">
      <i class="bi bi-check-circle me-2"></i> Status
    </div>
    <div class="desktop-nav-item" data-page="results">
      <i class="bi bi-trophy me-2"></i> Results
    </div>
  </div>

  <!-- Main Container -->
  <div class="main-container">
    
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="text-white mb-3">Team Leader Dashboard</h1>
      <div id="teamInfo" class="text-white opacity-75">
        <i class="bi bi-people-fill me-2"></i>
        <span id="teamName">Loading...</span>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Pages -->
    <div id="pages">
      
      <!-- DASHBOARD PAGE -->
      <div id="dashboardPage" class="page active">
        <div class="row g-4">
          <!-- Score Card -->
          <div class="col-md-3 col-sm-6">
            <div class="dashboard-card gradient-primary" onclick="showPage('nominations')">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <i class="bi bi-trophy-fill" style="font-size: 2rem;"></i>
                <span class="badge bg-white text-dark">Team</span>
              </div>
              <h2 class="mb-2" id="teamScore">0</h2>
              <p class="mb-0 opacity-75">Total Score</p>
            </div>
          </div>
          
          <!-- Attendance Card -->
          <div class="col-md-3 col-sm-6">
            <div class="dashboard-card" onclick="showPage('nominations')">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <i class="bi bi-clipboard-check" style="font-size: 2rem; color: var(--primary);"></i>
                <span class="badge bg-primary">Attendance</span>
              </div>
              <h2 class="mb-2 text-gradient" id="attendanceRate">0%</h2>
              <p class="mb-0 text-muted">Attendance Rate</p>
            </div>
          </div>
          
          <!-- Approved Events Card -->
          <div class="col-md-3 col-sm-6">
            <div class="dashboard-card" onclick="showPage('status')">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <i class="bi bi-check-circle-fill" style="font-size: 2rem; color: var(--success);"></i>
                <span class="badge bg-success">Approved</span>
              </div>
              <h2 class="mb-2" style="color: var(--success);" id="approvedCount">0</h2>
              <p class="mb-0 text-muted">Approved Events</p>
            </div>
          </div>
          
          <!-- Pending Events Card -->
          <div class="col-md-3 col-sm-6">
            <div class="dashboard-card" onclick="showPage('status')">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <i class="bi bi-clock-fill" style="font-size: 2rem; color: var(--warning);"></i>
                <span class="badge bg-warning">Pending</span>
              </div>
              <h2 class="mb-2" style="color: var(--warning);" id="pendingCount">0</h2>
              <p class="mb-0 text-muted">Pending Events</p>
            </div>
          </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="dashboard-card">
              <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>Quick Stats</h5>
              <div class="row">
                <div class="col-md-3 col-6">
                  <div class="text-center p-3">
                    <h4 class="text-gradient" id="totalMembers">0</h4>
                    <small class="text-muted">Team Members</small>
                  </div>
                </div>
                <div class="col-md-3 col-6">
                  <div class="text-center p-3">
                    <h4 class="text-gradient" id="stageEvents">0</h4>
                    <small class="text-muted">Stage Events</small>
                  </div>
                </div>
                <div class="col-md-3 col-6">
                  <div class="text-center p-3">
                    <h4 class="text-gradient" id="offstageEvents">0</h4>
                    <small class="text-muted">Off-Stage Events</small>
                  </div>
                </div>
                <div class="col-md-3 col-6">
                  <div class="text-center p-3">
                    <h4 class="text-gradient" id="groupEvents">0</h4>
                    <small class="text-muted">Group Events</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- NOMINATIONS PAGE -->
      <div id="nominationsPage" class="page" style="display: none;">
        <div class="dashboard-card mb-4">
          <h4 class="mb-3"><i class="bi bi-calendar-plus me-2"></i>Submit Nominations</h4>
          
          <!-- Event Type Tabs -->
          <div class="filter-tabs">
            <div class="filter-tab active" data-type="all">All Events</div>
            <div class="filter-tab" data-type="Stage">üé§ Stage</div>
            <div class="filter-tab" data-type="Non-Stage">üìù Off-Stage</div>
            <div class="filter-tab" data-type="Group">üë• Group</div>
            <div class="filter-tab" data-type="Open">üåç Open</div>
          </div>
          
          <!-- Level Filters -->
          <div class="filter-tabs">
            <div class="filter-tab active" data-level="all">All Levels</div>
            <div class="filter-tab" data-level="Junior">Junior</div>
            <div class="filter-tab" data-level="Senior">Senior</div>
            <div class="filter-tab" data-level="General">Open/Special</div>
          </div>
        </div>
        
        <!-- Events List -->
        <div id="eventsList" class="row">
          <!-- Events will be loaded here -->
        </div>
      </div>

      <!-- EVENT DETAIL PAGE -->
      <div id="eventDetailPage" class="page" style="display: none;">
        <div class="dashboard-card mb-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <button class="btn btn-outline-primary btn-sm" onclick="showPage('nominations')">
              <i class="bi bi-arrow-left me-1"></i> Back
            </button>
            <h4 class="mb-0"><i class="bi bi-calendar-event me-2"></i><span id="selectedEventName"></span></h4>
          </div>
          
          <!-- Event Info -->
          <div class="row mb-4">
            <div class="col-md-3 col-6">
              <div class="text-center p-2">
                <div class="badge" id="eventCategoryBadge">Stage</div>
                <small class="d-block mt-1 text-muted">Category</small>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="text-center p-2">
                <div class="badge" id="eventLevelBadge">Senior</div>
                <small class="d-block mt-1 text-muted">Level</small>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="text-center p-2">
                <h5 class="mb-0" id="eventMaxMembers">2</h5>
                <small class="d-block text-muted">Max Members</small>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="text-center p-2">
                <h5 class="mb-0" id="eventCurrentMembers">0</h5>
                <small class="d-block text-muted">Selected</small>
              </div>
            </div>
          </div>
          
          <!-- Members Selection -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6><i class="bi bi-people me-2"></i>Select Team Members</h6>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="selectAllMembers()">
                  <i class="bi bi-check-all me-1"></i> Select All
                </button>
                <button class="btn btn-outline-secondary btn-sm" onclick="deselectAllMembers()">
                  <i class="bi bi-x-circle me-1"></i> Clear All
                </button>
              </div>
            </div>
            
            <!-- Member Filters -->
            <div class="filter-tabs mb-3">
              <div class="filter-tab active" data-member-filter="all">All</div>
              <div class="filter-tab" data-member-filter="Senior">Senior</div>
              <div class="filter-tab" data-member-filter="Junior">Junior</div>
            </div>
            
            <!-- Search -->
            <div class="input-group mb-3">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input type="text" id="memberSearch" class="form-control" placeholder="Search members by name or ID...">
            </div>
            
            <!-- Members Grid -->
            <div id="membersGrid" class="row g-2">
              <!-- Members will be loaded here -->
            </div>
            
            <!-- Limit Info -->
            <div class="alert alert-info mt-3" id="limitInfo">
              <i class="bi bi-info-circle me-2"></i>
              <span id="limitText">Select members to nominate</span>
            </div>
          </div>
          
          <!-- Submit Button -->
          <div class="d-grid gap-2">
            <button class="btn btn-primary btn-lg" id="submitNominationBtn" onclick="submitNomination()">
              <i class="bi bi-send me-2"></i> Submit for Approval
            </button>
            <button class="btn btn-outline-secondary" onclick="showPage('nominations')">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- STATUS PAGE -->
      <div id="statusPage" class="page" style="display: none;">
        <div class="dashboard-card mb-4">
          <h4 class="mb-3"><i class="bi bi-check-circle me-2"></i>Approved & Pending Events</h4>
          
          <!-- Tabs -->
          <ul class="nav nav-tabs" id="statusTabs">
            <li class="nav-item">
              <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pendingTab">Pending</button>
            </li>
            <li class="nav-item">
              <button class="nav-link" data-bs-toggle="tab" data-bs-target="#approvedTab">Approved</button>
            </li>
          </ul>
          
          <!-- Tab Content -->
          <div class="tab-content mt-3">
            <!-- Pending Tab -->
            <div class="tab-pane fade show active" id="pendingTab">
              <div id="pendingEventsList">
                <!-- Pending events will be loaded here -->
              </div>
            </div>
            
            <!-- Approved Tab -->
            <div class="tab-pane fade" id="approvedTab">
              <div id="approvedEventsList">
                <!-- Approved events will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RESULTS PAGE -->
      <div id="resultsPage" class="page" style="display: none;">
        <div class="dashboard-card mb-4">
          <h4 class="mb-3"><i class="bi bi-trophy me-2"></i>Published Results</h4>
          <p class="text-muted mb-4">View scores and rankings for your team's approved events</p>
          
          <div id="resultsList">
            <!-- Results will be loaded here -->
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bottom Navigation (Mobile) -->
  <div class="bottom-nav">
    <div class="nav-item active" data-page="dashboard">
      <i class="bi bi-speedometer2"></i>
      <span>Dashboard</span>
    </div>
    <div class="nav-item" data-page="nominations">
      <i class="bi bi-calendar-plus"></i>
      <span>Nominations</span>
    </div>
    <div class="nav-item" data-page="status">
      <i class="bi bi-check-circle"></i>
      <span>Status</span>
    </div>
    <div class="nav-item" data-page="results">
      <i class="bi bi-trophy"></i>
      <span>Results</span>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Variables
    let currentUser = null;
    let currentTeam = null;
    let currentEvent = null;
    let selectedMembers = new Set();
    let events = [];
    let students = [];
    let participations = [];
    let results = [];
    let attendance = [];
    
    // Cache for quick access
    const cache = {
      events: {},
      students: {},
      participations: {},
      results: {}
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkLeaderSession();
      setupEventListeners();
    });

    // Check if leader is logged in
    function checkLeaderSession() {
      const leaderId = sessionStorage.getItem('leaderId') || localStorage.getItem('leaderId');
      if (!leaderId) {
        window.location.href = 'index.html';
        return;
      }
      loadData(leaderId);
    }

    // Setup Event Listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-item, .desktop-nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const page = item.dataset.page;
          showPage(page);
        });
      });

      // Filter Tabs
      document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          // Handle event type filters
          if (tab.dataset.type) {
            document.querySelectorAll('.filter-tab[data-type]').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            filterEvents(tab.dataset.type, 'type');
          }
          
          // Handle level filters
          if (tab.dataset.level) {
            document.querySelectorAll('.filter-tab[data-level]').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            filterEvents(tab.dataset.level, 'level');
          }
          
          // Handle member filters
          if (tab.dataset.memberFilter) {
            document.querySelectorAll('.filter-tab[data-member-filter]').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            filterMembers(tab.dataset.memberFilter);
          }
        });
      });

      // Member Search
      document.getElementById('memberSearch').addEventListener('input', (e) => {
        filterMembers('all', e.target.value);
      });

      // Bootstrap Tab Events
      document.querySelectorAll('#statusTabs button').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (event) => {
          if (event.target.dataset.bsTarget === '#pendingTab') {
            renderPendingEvents();
          } else {
            renderApprovedEvents();
          }
        });
      });
    }

    // Load Data from Firebase
    function loadData(leaderId) {
      // Listen for all data changes
      const refs = {
        students: ref(db, 'students'),
        teams: ref(db, 'teams'),
        events: ref(db, 'events'),
        participations: ref(db, 'participations'),
        results: ref(db, 'results'),
        attendance: ref(db, 'attendance')
      };

      Object.entries(refs).forEach(([key, ref]) => {
        onValue(ref, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            // Convert object to array
            const dataArray = Object.values(data).map(item => ({
              ...item,
              dbKey: Object.keys(data)[Object.values(data).indexOf(item)]
            }));

            switch(key) {
              case 'students':
                students = dataArray;
                cache.students = dataArray.reduce((acc, s) => {
                  acc[s.id] = s;
                  return acc;
                }, {});
                break;
              case 'teams':
                const userTeam = dataArray.find(t => {
                  const teamMembers = students.filter(s => s.teamId === t.id);
                  return teamMembers.some(m => m.id === leaderId);
                });
                if (userTeam) {
                  currentTeam = userTeam;
                  document.getElementById('teamName').textContent = currentTeam.name;
                }
                break;
              case 'events':
                events = dataArray;
                cache.events = dataArray.reduce((acc, e) => {
                  acc[e.id] = e;
                  return acc;
                }, {});
                renderEventsList();
                break;
              case 'participations':
                participations = dataArray;
                cache.participations = dataArray.reduce((acc, p) => {
                  if (!acc[p.eventId]) acc[p.eventId] = [];
                  acc[p.eventId].push(p);
                  return acc;
                }, {});
                updateDashboard();
                renderPendingEvents();
                renderApprovedEvents();
                break;
              case 'results':
                results = dataArray;
                cache.results = dataArray.reduce((acc, r) => {
                  if (!acc[r.eventId]) acc[r.eventId] = [];
                  acc[r.eventId].push(r);
                  return acc;
                }, {});
                renderResults();
                break;
              case 'attendance':
                attendance = Object.values(data);
                updateDashboard();
                break;
            }
          }
        });
      });
    }

    // Update Dashboard Stats
    function updateDashboard() {
      if (!currentTeam) return;

      // Team members
      const teamMembers = students.filter(s => s.teamId === currentTeam.id);
      document.getElementById('totalMembers').textContent = teamMembers.length;

      // Team score
      document.getElementById('teamScore').textContent = currentTeam.score || 0;

      // Attendance rate
      const totalAttendance = attendance.reduce((sum, session) => {
        return sum + (Object.values(session.students || {}).length || 0);
      }, 0);
      
      const presentCount = attendance.reduce((sum, session) => {
        return sum + (Object.values(session.students || {}).filter(s => s === 'Present').length || 0);
      }, 0);
      
      const attendanceRate = totalAttendance > 0 ? Math.round((presentCount / totalAttendance) * 100) : 0;
      document.getElementById('attendanceRate').textContent = attendanceRate + '%';

      // Event counts
      const teamParticipations = participations.filter(p => p.teamId === currentTeam.id);
      const approvedCount = teamParticipations.filter(p => p.status === 'approved').length;
      const pendingCount = teamParticipations.filter(p => p.status === 'pending').length;
      
      document.getElementById('approvedCount').textContent = approvedCount;
      document.getElementById('pendingCount').textContent = pendingCount;

      // Event type counts
      const stageEvents = events.filter(e => e.type === 'Stage' && e.section !== 'Open').length;
      const offstageEvents = events.filter(e => e.type === 'Offstage' && e.section !== 'Open').length;
      const groupEvents = events.filter(e => e.type === 'Group').length;
      
      document.getElementById('stageEvents').textContent = stageEvents;
      document.getElementById('offstageEvents').textContent = offstageEvents;
      document.getElementById('groupEvents').textContent = groupEvents;
    }

    // Show Toast Notification
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'custom-toast';
      
      let icon = 'bi-info-circle';
      let bgColor = '#4361ee';
      
      if (type === 'success') {
        icon = 'bi-check-circle';
        bgColor = '#4cc9f0';
      } else if (type === 'warning') {
        icon = 'bi-exclamation-triangle';
        bgColor = '#f72585';
      } else if (type === 'error') {
        icon = 'bi-x-circle';
        bgColor = '#e63946';
      }
      
      toast.innerHTML = `
        <div class="d-flex align-items-center">
          <i class="bi ${icon} me-3" style="font-size: 1.5rem; color: ${bgColor};"></i>
          <div>
            <div class="fw-semibold">${message}</div>
          </div>
        </div>
      `;
      
      container.appendChild(toast);
      
      // Remove toast after 3 seconds
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => {
          if (toast.parentNode === container) {
            container.removeChild(toast);
          }
        }, 300);
      }, 3000);
    }

    // Navigation Functions
    window.showPage = function(page) {
      // Update active states
      document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
      document.querySelectorAll('.nav-item, .desktop-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected page
      document.getElementById(page + 'Page').style.display = 'block';
      document.querySelectorAll(`[data-page="${page}"]`).forEach(item => {
        item.classList.add('active');
      });
      
      // Load data for the page
      if (page === 'nominations') {
        renderEventsList();
      } else if (page === 'status') {
        renderPendingEvents();
      } else if (page === 'results') {
        renderResults();
      }
    };

    // Filter Events
    function filterEvents(filterValue, filterType) {
      const eventType = document.querySelector('.filter-tab[data-type].active')?.dataset.type || 'all';
      const level = document.querySelector('.filter-tab[data-level].active')?.dataset.level || 'all';
      
      let filteredEvents = events;
      
      // Filter by type
      if (eventType !== 'all') {
        filteredEvents = filteredEvents.filter(e => e.type === eventType);
      }
      
      // Filter by level
      if (level !== 'all') {
        filteredEvents = filteredEvents.filter(e => e.section === level);
      }
      
      renderEventsList(filteredEvents);
    }

    // Render Events List
    function renderEventsList(filteredEvents = events) {
      const container = document.getElementById('eventsList');
      
      if (filteredEvents.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="event-card text-center py-5">
              <i class="bi bi-calendar-x mb-3" style="font-size: 3rem; color: var(--gray);"></i>
              <h5 class="text-muted">No events found</h5>
              <p class="text-muted">Try changing your filters</p>
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredEvents.map(event => {
        // Get participation status for this team
        const teamParticipations = participations.filter(p => 
          p.eventId === event.id && p.teamId === currentTeam.id
        );
        
        const pendingCount = teamParticipations.filter(p => p.status === 'pending').length;
        const approvedCount = teamParticipations.filter(p => p.status === 'approved').length;
        
        // Determine status
        let status = 'Available';
        let statusClass = 'badge bg-success';
        
        if (approvedCount > 0) {
          status = 'Approved';
          statusClass = 'badge-approved';
        } else if (pendingCount > 0) {
          status = 'Pending';
          statusClass = 'badge-pending';
        }
        
        // Get badge classes
        const typeClass = getEventTypeClass(event.type);
        const levelClass = getLevelClass(event.section);
        
        return `
          <div class="col-md-6 col-lg-4">
            <div class="event-card" onclick="selectEvent('${event.id}')">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <span class="badge ${typeClass} me-2">${event.type}</span>
                  <span class="badge ${levelClass}">${event.section}</span>
                </div>
                <span class="badge ${statusClass}">${status}</span>
              </div>
              
              <h6 class="mb-2">${event.name}</h6>
              
              <div class="d-flex justify-content-between align-items-center mt-3">
                <small class="text-muted">
                  <i class="bi bi-people me-1"></i> Max ${getMaxMembers(event.type)}
                </small>
                <button class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-plus-circle me-1"></i> Nominate
                </button>
              </div>
              
              ${approvedCount > 0 ? `
                <div class="mt-2 small text-success">
                  <i class="bi bi-check-circle me-1"></i> ${approvedCount} approved
                </div>
              ` : ''}
              
              ${pendingCount > 0 ? `
                <div class="mt-2 small text-warning">
                  <i class="bi bi-clock me-1"></i> ${pendingCount} pending
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // Select Event for Nomination
    window.selectEvent = function(eventId) {
      currentEvent = cache.events[eventId];
      selectedMembers.clear();
      
      if (!currentEvent) return;
      
      // Update UI
      document.getElementById('selectedEventName').textContent = currentEvent.name;
      
      // Set event info badges
      const typeBadge = document.getElementById('eventCategoryBadge');
      typeBadge.className = 'badge ' + getEventTypeClass(currentEvent.type);
      typeBadge.textContent = currentEvent.type;
      
      const levelBadge = document.getElementById('eventLevelBadge');
      levelBadge.className = 'badge ' + getLevelClass(currentEvent.section);
      levelBadge.textContent = currentEvent.section;
      
      // Set max members
      const maxMembers = getMaxMembers(currentEvent.type);
      document.getElementById('eventMaxMembers').textContent = maxMembers;
      
      // Check existing nominations
      const existingNominations = participations.filter(p => 
        p.eventId === eventId && 
        p.teamId === currentTeam.id && 
        p.status === 'pending'
      );
      
      // Load members based on event level
      loadMembersForEvent();
      
      // Show event detail page
      showPage('eventDetail');
    };

    // Load Members for Event
    function loadMembersForEvent() {
      let eligibleMembers = students.filter(s => s.teamId === currentTeam.id);
      
      // Filter by event level
      if (currentEvent.section === 'Senior') {
        eligibleMembers = eligibleMembers.filter(s => s.level === 'Senior');
      } else if (currentEvent.section === 'Junior') {
        eligibleMembers = eligibleMembers.filter(s => s.level === 'Junior');
      }
      // Open/Special events allow all levels
      
      // Check existing nominations
      const existingNominations = participations.filter(p => 
        p.eventId === currentEvent.id && 
        p.teamId === currentTeam.id && 
        p.status === 'pending'
      );
      
      // Pre-select pending members
      existingNominations.forEach(p => {
        selectedMembers.add(p.studentId);
      });
      
      // Update UI
      document.getElementById('eventCurrentMembers').textContent = selectedMembers.size;
      updateMembersGrid(eligibleMembers);
      updateLimitInfo();
    }

    // Update Members Grid
    function updateMembersGrid(members) {
      const container = document.getElementById('membersGrid');
      const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
      const activeFilter = document.querySelector('.filter-tab[data-member-filter].active')?.dataset.memberFilter || 'all';
      
      // Apply filters
      let filteredMembers = members;
      
      if (activeFilter !== 'all') {
        filteredMembers = filteredMembers.filter(m => m.level === activeFilter);
      }
      
      if (searchTerm) {
        filteredMembers = filteredMembers.filter(m => 
          m.name.toLowerCase().includes(searchTerm) || 
          m.id.toLowerCase().includes(searchTerm)
        );
      }
      
      if (filteredMembers.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-4">
            <i class="bi bi-people mb-3" style="font-size: 2rem; color: var(--gray);"></i>
            <p class="text-muted">No members found</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = filteredMembers.map(member => {
        const isSelected = selectedMembers.has(member.id);
        const canSelect = canMemberJoinEvent(member.id);
        
        let cardClass = 'member-card col-md-4 col-sm-6 col-12';
        if (isSelected) cardClass += ' selected';
        if (!canSelect.canJoin) cardClass += ' disabled';
        
        // Get personal limits
        const limits = getMemberLimits(member.id);
        
        return `
          <div class="${cardClass}" onclick="toggleMemberSelection('${member.id}')" 
               title="${!canSelect.canJoin ? canSelect.reason : ''}">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <h6 class="mb-1">${member.id}</h6>
                <small class="text-muted">${member.name}</small>
              </div>
              <span class="badge ${member.level === 'Senior' ? 'badge-senior' : 'badge-junior'}">
                ${member.level}
              </span>
            </div>
            
            <div class="small">
              <div class="d-flex justify-content-between mb-1">
                <span>Stage: ${limits.stageCount}/${limits.maxStage}</span>
                <span class="${limits.stageCount >= limits.maxStage ? 'text-danger' : 'text-success'}">
                  ${limits.stageCount >= limits.maxStage ? '‚úó' : '‚úì'}
                </span>
              </div>
              <div class="d-flex justify-content-between">
                <span>Off-Stage: ${limits.offstageCount}/${limits.maxOffstage}</span>
                <span class="${limits.offstageCount >= limits.maxOffstage ? 'text-danger' : 'text-success'}">
                  ${limits.offstageCount >= limits.maxOffstage ? '‚úó' : '‚úì'}
                </span>
              </div>
            </div>
            
            ${isSelected ? `
              <div class="text-center mt-2 text-success">
                <i class="bi bi-check-circle-fill"></i> Selected
              </div>
            ` : ''}
            
            ${!canSelect.canJoin ? `
              <div class="text-center mt-2 text-danger small">
                <i class="bi bi-exclamation-circle"></i> Cannot select
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    // Filter Members
    function filterMembers(filter, searchTerm = '') {
      if (!currentEvent) return;
      
      let eligibleMembers = students.filter(s => s.teamId === currentTeam.id);
      
      // Filter by event level
      if (currentEvent.section === 'Senior') {
        eligibleMembers = eligibleMembers.filter(s => s.level === 'Senior');
      } else if (currentEvent.section === 'Junior') {
        eligibleMembers = eligibleMembers.filter(s => s.level === 'Junior');
      }
      
      updateMembersGrid(eligibleMembers);
    }

    // Toggle Member Selection
    window.toggleMemberSelection = function(memberId) {
      const canSelect = canMemberJoinEvent(memberId);
      
      if (!canSelect.canJoin) {
        showToast(canSelect.reason, 'warning');
        return;
      }
      
      // Check event capacity
      const maxMembers = getMaxMembers(currentEvent.type);
      const existingNominations = participations.filter(p => 
        p.eventId === currentEvent.id && 
        p.teamId === currentTeam.id && 
        p.status === 'approved'
      );
      
      const totalSelected = existingNominations.length + selectedMembers.size;
      
      if (selectedMembers.has(memberId)) {
        // Deselect
        selectedMembers.delete(memberId);
      } else {
        // Check if we can add more
        if (totalSelected >= maxMembers) {
          showToast(`Maximum ${maxMembers} members allowed for ${currentEvent.type} events`, 'warning');
          return;
        }
        selectedMembers.add(memberId);
      }
      
      // Update UI
      document.getElementById('eventCurrentMembers').textContent = selectedMembers.size;
      loadMembersForEvent();
      updateLimitInfo();
    };

    // Select All Members
    window.selectAllMembers = function() {
      let eligibleMembers = students.filter(s => s.teamId === currentTeam.id);
      
      // Filter by event level
      if (currentEvent.section === 'Senior') {
        eligibleMembers = eligibleMembers.filter(s => s.level === 'Senior');
      } else if (currentEvent.section === 'Junior') {
        eligibleMembers = eligibleMembers.filter(s => s.level === 'Junior');
      }
      
      const maxMembers = getMaxMembers(currentEvent.type);
      const existingNominations = participations.filter(p => 
        p.eventId === currentEvent.id && 
        p.teamId === currentTeam.id && 
        p.status === 'approved'
      );
      
      let count = 0;
      eligibleMembers.forEach(member => {
        if (count + selectedMembers.size >= maxMembers) return;
        
        const canSelect = canMemberJoinEvent(member.id);
        if (canSelect.canJoin && !selectedMembers.has(member.id)) {
          selectedMembers.add(member.id);
          count++;
        }
      });
      
      loadMembersForEvent();
      updateLimitInfo();
    };

    // Deselect All Members
    window.deselectAllMembers = function() {
      selectedMembers.clear();
      loadMembersForEvent();
      updateLimitInfo();
    };

    // Check if member can join event
    function canMemberJoinEvent(memberId) {
      const member = cache.students[memberId];
      if (!member) return { canJoin: false, reason: 'Member not found' };
      
      // Check personal limits
      const limits = getMemberLimits(memberId);
      
      if (currentEvent.type === 'Stage') {
        if (limits.stageCount >= limits.maxStage) {
          return { 
            canJoin: false, 
            reason: `Stage limit reached (${limits.maxStage} max)` 
          };
        }
      } else if (currentEvent.type === 'Non-Stage') {
        if (limits.offstageCount >= limits.maxOffstage) {
          return { 
            canJoin: false, 
            reason: `Off-Stage limit reached (${limits.maxOffstage} max)` 
          };
        }
      }
      
      // Check if already nominated for this event
      const alreadyNominated = participations.some(p => 
        p.studentId === memberId && 
        p.eventId === currentEvent.id && 
        p.status === 'pending'
      );
      
      if (alreadyNominated) {
        return { canJoin: false, reason: 'Already nominated for this event' };
      }
      
      return { canJoin: true, reason: '' };
    }

    // Get member personal limits
    function getMemberLimits(memberId) {
      const member = cache.students[memberId];
      if (!member) return { stageCount: 0, offstageCount: 0, maxStage: 0, maxOffstage: 0 };
      
      // Get approved participations for this member
      const memberParticipations = participations.filter(p => 
        p.studentId === memberId && 
        p.status === 'approved'
      );
      
      let stageCount = 0;
      let offstageCount = 0;
      
      memberParticipations.forEach(p => {
        const event = cache.events[p.eventId];
        if (!event) return;
        
        if (event.type === 'Stage') {
          stageCount++;
        } else if (event.type === 'Non-Stage') {
          offstageCount++;
        }
      });
      
      // Set limits based on level
      const maxStage = member.level === 'Senior' ? 3 : 2;
      const maxOffstage = member.level === 'Senior' ? 4 : 3;
      
      return { stageCount, offstageCount, maxStage, maxOffstage };
    }

    // Get max members for event type
    function getMaxMembers(eventType) {
      switch(eventType) {
        case 'Stage':
        case 'Non-Stage':
          return 2;
        case 'Group':
        case 'Open':
          return 5;
        default:
          return 2;
      }
    }

    // Update limit info display
    function updateLimitInfo() {
      const maxMembers = getMaxMembers(currentEvent.type);
      const existingNominations = participations.filter(p => 
        p.eventId === currentEvent.id && 
        p.teamId === currentTeam.id && 
        p.status === 'approved'
      );
      
      const totalSelected = existingNominations.length + selectedMembers.size;
      const remaining = maxMembers - totalSelected;
      
      let message = '';
      let alertClass = 'alert-info';
      
      if (remaining <= 0) {
        message = `Event is full! ${totalSelected}/${maxMembers} members`;
        alertClass = 'alert-danger';
      } else {
        message = `${remaining} slot(s) remaining (${totalSelected}/${maxMembers})`;
        alertClass = remaining <= 1 ? 'alert-warning' : 'alert-success';
      }
      
      document.getElementById('limitInfo').className = `alert ${alertClass}`;
      document.getElementById('limitText').textContent = message;
    }

    // Submit Nomination
    window.submitNomination = async function() {
      if (!currentEvent || selectedMembers.size === 0) {
        showToast('Please select at least one member', 'warning');
        return;
      }
      
      try {
        // Remove existing pending nominations for this event
        const existingPending = participations.filter(p => 
          p.eventId === currentEvent.id && 
          p.teamId === currentTeam.id && 
          p.status === 'pending'
        );
        
        // Delete existing pending nominations
        for (const p of existingPending) {
          await remove(ref(db, `participations/${p.dbKey}`));
        }
        
        // Add new nominations
        for (const memberId of selectedMembers) {
          const nominationRef = push(ref(db, 'participations'));
          await set(nominationRef, {
            id: nominationRef.key,
            eventId: currentEvent.id,
            studentId: memberId,
            teamId: currentTeam.id,
            status: 'pending',
            submittedAt: Date.now(),
            eventName: currentEvent.name,
            eventType: currentEvent.type,
            eventSection: currentEvent.section
          });
        }
        
        showToast(`Submitted ${selectedMembers.size} member(s) for approval`, 'success');
        
        // Return to nominations page
        setTimeout(() => {
          showPage('nominations');
        }, 1500);
        
      } catch (error) {
        console.error('Error submitting nomination:', error);
        showToast('Error submitting nomination', 'error');
      }
    };

    // Render Pending Events
    function renderPendingEvents() {
      const container = document.getElementById('pendingEventsList');
      const pendingParticipations = participations.filter(p => 
        p.teamId === currentTeam.id && 
        p.status === 'pending'
      );
      
      if (pendingParticipations.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-clock mb-3" style="font-size: 3rem; color: var(--gray);"></i>
            <h5 class="text-muted">No pending events</h5>
            <p class="text-muted">Submit nominations to see them here</p>
          </div>
        `;
        return;
      }
      
      // Group by event
      const eventsMap = {};
      pendingParticipations.forEach(p => {
        if (!eventsMap[p.eventId]) {
          eventsMap[p.eventId] = {
            event: cache.events[p.eventId],
            members: []
          };
        }
        eventsMap[p.eventId].members.push(cache.students[p.studentId]);
      });
      
      container.innerHTML = Object.values(eventsMap).map(item => {
        const typeClass = getEventTypeClass(item.event.type);
        const levelClass = getLevelClass(item.event.section);
        
        return `
          <div class="event-card mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <span class="badge ${typeClass} me-2">${item.event.type}</span>
                <span class="badge ${levelClass}">${item.event.section}</span>
              </div>
              <span class="badge-pending">Pending</span>
            </div>
            
            <h6 class="mb-3">${item.event.name}</h6>
            
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Nominated Members:</small>
              <div class="d-flex flex-wrap gap-2">
                ${item.members.map(m => `
                  <span class="badge bg-light text-dark">
                    ${m.id} - ${m.name}
                  </span>
                `).join('')}
              </div>
            </div>
            
            <div class="small text-muted">
              <i class="bi bi-clock me-1"></i> Awaiting admin approval
            </div>
          </div>
        `;
      }).join('');
    }

    // Render Approved Events
    function renderApprovedEvents() {
      const container = document.getElementById('approvedEventsList');
      const approvedParticipations = participations.filter(p => 
        p.teamId === currentTeam.id && 
        p.status === 'approved'
      );
      
      if (approvedParticipations.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-check-circle mb-3" style="font-size: 3rem; color: var(--success);"></i>
            <h5 class="text-muted">No approved events</h5>
            <p class="text-muted">Approved events will appear here</p>
          </div>
        `;
        return;
      }
      
      // Group by event
      const eventsMap = {};
      approvedParticipations.forEach(p => {
        if (!eventsMap[p.eventId]) {
          eventsMap[p.eventId] = {
            event: cache.events[p.eventId],
            members: []
          };
        }
        eventsMap[p.eventId].members.push({
          student: cache.students[p.studentId],
          participation: p
        });
      });
      
      container.innerHTML = Object.values(eventsMap).map(item => {
        const typeClass = getEventTypeClass(item.event.type);
        const levelClass = getLevelClass(item.event.section);
        
        // Check if results are published
        const eventResults = cache.results[item.event.id] || [];
        const hasResults = eventResults.length > 0;
        
        return `
          <div class="event-card mb-3">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <span class="badge ${typeClass} me-2">${item.event.type}</span>
                <span class="badge ${levelClass}">${item.event.section}</span>
              </div>
              <span class="badge-approved">Approved</span>
            </div>
            
            <h6 class="mb-3">${item.event.name}</h6>
            
            <div class="mb-3">
              <small class="text-muted d-block mb-1">Approved Members:</small>
              <div class="d-flex flex-wrap gap-2">
                ${item.members.map(m => `
                  <span class="badge bg-success text-white">
                    ${m.student.id} - ${m.student.name}
                  </span>
                `).join('')}
              </div>
            </div>
            
            ${hasResults ? `
              <div class="alert alert-success py-2 mb-2">
                <i class="bi bi-trophy me-2"></i>
                <strong>Results Published!</strong>
                <div class="small mt-1">
                  ${eventResults.map(r => `
                    ${r.position}${getOrdinal(r.position)}: ${cache.students[r.studentId]?.name || r.studentId} - ${r.points} points
                  `).join('<br>')}
                </div>
              </div>
            ` : ''}
            
            <div class="small text-success">
              <i class="bi bi-check-circle-fill me-1"></i> Ready for participation
            </div>
          </div>
        `;
      }).join('');
    }

    // Render Results
    function renderResults() {
      const container = document.getElementById('resultsList');
      const approvedParticipations = participations.filter(p => 
        p.teamId === currentTeam.id && 
        p.status === 'approved'
      );
      
      // Get events with results
      const eventsWithResults = [];
      approvedParticipations.forEach(p => {
        const eventResults = cache.results[p.eventId];
        if (eventResults && eventResults.length > 0) {
          eventsWithResults.push({
            event: cache.events[p.eventId],
            results: eventResults
          });
        }
      });
      
      if (eventsWithResults.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="bi bi-trophy mb-3" style="font-size: 3rem; color: var(--gray);"></i>
            <h5 class="text-muted">No published results</h5>
            <p class="text-muted">Results will appear here when published by admin</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = eventsWithResults.map(item => {
        const typeClass = getEventTypeClass(item.event.type);
        const levelClass = getLevelClass(item.event.section);
        
        // Sort results by position
        const sortedResults = [...item.results].sort((a, b) => a.position - b.position);
        
        return `
          <div class="event-card mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <span class="badge ${typeClass} me-2">${item.event.type}</span>
                <span class="badge ${levelClass}">${item.event.section}</span>
              </div>
              <span class="badge-approved">Published</span>
            </div>
            
            <h5 class="mb-3">${item.event.name}</h5>
            
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Position</th>
                    <th>Member</th>
                    <th>Points</th>
                    <th>Team</th>
                  </tr>
                </thead>
                <tbody>
                  ${sortedResults.map(r => {
                    const student = cache.students[r.studentId];
                    const isTeamMember = student?.teamId === currentTeam.id;
                    
                    return `
                      <tr class="${isTeamMember ? 'table-success' : ''}">
                        <td>
                          <span class="badge ${r.position === 1 ? 'bg-warning' : r.position === 2 ? 'bg-secondary' : 'bg-danger'}">
                            ${r.position}${getOrdinal(r.position)}
                          </span>
                        </td>
                        <td>
                          ${student?.name || r.studentId}
                          ${isTeamMember ? '<span class="badge bg-success ms-2">Your Team</span>' : ''}
                        </td>
                        <td><strong>${r.points}</strong></td>
                        <td>${cache.students[r.studentId]?.teamId || 'N/A'}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
    }

    // Helper Functions
    function getEventTypeClass(type) {
      switch(type) {
        case 'Stage': return 'badge-stage';
        case 'Non-Stage': return 'badge-offstage';
        case 'Group': return 'badge-group';
        case 'Open': return 'badge-open';
        default: return 'badge bg-secondary';
      }
    }

    function getLevelClass(level) {
      switch(level) {
        case 'Senior': return 'badge-senior';
        case 'Junior': return 'badge-junior';
        case 'General': return 'badge bg-info';
        default: return 'badge bg-secondary';
      }
    }

    function getOrdinal(n) {
      const s = ["th", "st", "nd", "rd"];
      const v = n % 100;
      return s[(v - 20) % 10] || s[v] || s[0];
    }
  </script>
</body>
</html>