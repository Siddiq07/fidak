<!-- PART 1 - UPDATED (NO LOGIN PANEL) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader â€” Art Fest</title>

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f5f8ff; --card:#fff; --muted:#6b7280;
      --accent:#2563eb; --accent-2:#7c3aed;
      --success:#10b981; --danger:#ef4444;
    }
    html,body{margin:0;padding:0;height:100%;font-family:Inter;background:var(--bg);color:#0f172a;}
    .container-wide{max-width:1100px;margin:14px auto;padding:0 12px}
    .card-neo{background:#fff;padding:12px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.06);margin-bottom:14px}
    .section-title{font-weight:700;margin-bottom:8px}
    .muted{color:var(--muted)}
    .top-nav{background:#fff;border-bottom:1px solid #e7ecf8;box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .brand{font-size:20px;font-weight:800;color:var(--accent)}
    .nav-btn{font-size:15px}
    .small-box{padding:6px 10px;background:#eef2ff;border-radius:6px;margin:4px 0;font-size:14px;cursor:pointer}
    .student-item{padding:6px;border-bottom:1px solid #eef0f8}
  </style>
</head>

<body>

<!-- TOP NAV -->
<nav class="top-nav">
  <div class="container container-wide d-flex align-items-center justify-content-between py-2">
    <div class="brand d-flex align-items-center gap-2">
      <i class="bi bi-people-fill text-primary"></i> Art Fest Leader View
    </div>

    <div class="muted">Year <span id="current-year"></span></div>
  </div>

  <div class="container container-wide d-flex gap-2 py-2">
    <button class="btn btn-light nav-btn active" data-target="#panel-students">Students</button>
    <button class="btn btn-light nav-btn" data-target="#panel-events">Events</button>
    <button class="btn btn-light nav-btn" data-target="#panel-results">Results</button>
    <button class="btn btn-light nav-btn" data-target="#panel-team">Team</button>
  </div>
</nav>

<main class="container container-wide">
  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>

  <!-- PANELS START -->
  <div id="panels-wrapper">
  <!-- PART 2 - UPDATED -->

<!-- STUDENTS PANEL -->
<section id="panel-students" class="card-neo">
  <div class="section-title">All Students</div>
  <div class="muted mb-2">View list of all registered students.</div>

  <input id="studentSearch" class="form-control mb-2" placeholder="Search name or Chess #">

  <div id="studentsList" style="max-height:400px;overflow:auto">
    <!-- Filled by JS -->
  </div>
</section>

<!-- EVENTS PANEL -->
<section id="panel-events" class="card-neo d-none">
  <div class="section-title">Events</div>

  <div class="d-flex gap-2 mb-2">
    <select id="filterType" class="form-select"><option value="">All Types</option><option>Stage</option><option>Non-Stage</option></select>
    <select id="filterLevel" class="form-select"><option value="">All Levels</option><option>Junior</option><option>Senior</option><option>General</option><option>Special</option></select>
    <button id="btnFilterEvents" class="btn btn-outline-secondary">Search</button>
  </div>

  <div class="table-responsive" style="max-height:360px;overflow:auto">
    <table class="table table-sm">
      <thead class="table-light"><tr><th>Name</th><th>Type</th><th>Level</th></tr></thead>
      <tbody id="eventsList"></tbody>
    </table>
  </div>
</section>

<!-- RESULTS -->
<section id="panel-results" class="card-neo d-none">
  <div class="section-title">Results</div>
  <div class="muted-small mb-2">Published results only.</div>

  <table class="table table-sm">
    <thead class="table-light">
      <tr><th>Event</th><th>1st</th><th>2nd</th><th>3rd</th><th>Status</th></tr>
    </thead>
    <tbody id="leaderResultsTable"></tbody>
  </table>
</section>

<!-- TEAM -->
<section id="panel-team" class="card-neo d-none">
  <div class="section-title">Team</div>
  <div class="muted">View-only mode. No login required.</div>
  <div id="teamMembersSmall" style="max-height:360px;overflow:auto"></div>
</section>
<!-- PART 3 - UPDATED (NO LOGIN / NO PARTICIPATION MODALS) -->

<!-- Nothing required here because leader view is read-only -->
<!-- Keep only hidden fields if needed for future expansion -->

<input type="hidden" id="dummyState">
<!-- PART 4 - UPDATED SCRIPT -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
  authDomain: "gen7-3e139.firebaseapp.com",
  databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
  projectId: "gen7-3e139",
  storageBucket: "gen7-3e139.firebasestorage.app",
  messagingSenderId: "578412378966",
  appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7",
  measurementId: "G-QLW5J1HK94"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* Helpers */
const $ = id => document.getElementById(id);
function escapeHtml(s){
  if(!s) return "";
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

/* Cache */
let CACHE = {
  students: [],
  teams: [],
  events: [],
  results: []
};

let KEYMAP = {
  students:{}, teams:{}, events:{}, results:{}
};

/* DB listeners */
onValue(ref(db,"students"), snap => {
  const obj = snap.val() || {};
  CACHE.students = Object.values(obj);
  KEYMAP.students = {};
  Object.entries(obj).forEach(([k,v]) => KEYMAP.students[v.id] = k);
  renderStudents();
  renderTeamView();
});

onValue(ref(db,"teams"), snap => {
  const obj = snap.val() || {};
  CACHE.teams = Object.values(obj);
  KEYMAP.teams = {};
  Object.entries(obj).forEach(([k,v]) => KEYMAP.teams[v.id] = k);
  renderTeamView();
});

onValue(ref(db,"events"), snap => {
  const obj = snap.val() || {};
  CACHE.events = Object.values(obj);
  KEYMAP.events = {};
  Object.entries(obj).forEach(([k,v]) => KEYMAP.events[v.id] = k);
  renderEvents();
  renderResults();
});

onValue(ref(db,"results"), snap => {
  const obj = snap.val() || {};
  CACHE.results = Object.values(obj);
  KEYMAP.results = {};
  Object.entries(obj).forEach(([k,v]) => KEYMAP.results[v.id] = k);
  renderResults();
});

/* Navbar Navigation */
document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll("main section").forEach(sec=>sec.classList.add("d-none"));
    const target = btn.dataset.target;
    document.querySelector(target).classList.remove("d-none");
    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
  });
});

document.querySelector('[data-target="#panel-students"]').click();

/* ------------------------------------
   RENDER STUDENTS PANEL
------------------------------------- */
function renderStudents(){
  const wrap = $("studentsList");
  const q = ($("studentSearch").value || "").toLowerCase();
  let list = CACHE.students;

  if(q){
    list = list.filter(s =>
      String(s.name).toLowerCase().includes(q) ||
      String(s.id).toLowerCase().includes(q)
    );
  }

  if(!list.length){
    wrap.innerHTML = '<div class="muted-small">No matching students</div>';
    return;
  }

  wrap.innerHTML = "";
  list.forEach(s=>{
    const team = CACHE.teams.find(t=>String(t.id)===String(s.teamId));
    wrap.innerHTML += `
      <div class="student-item">
        <div style="font-weight:700">${escapeHtml(s.name)}
          <span class="muted">(${escapeHtml(s.id)})</span>
        </div>
        <div class="muted-small">Level: ${escapeHtml(s.level||'')}</div>
        <div class="muted-small">Team: ${escapeHtml(team ? team.name : '-')}</div>
      </div>
    `;
  });
}

$("studentSearch").addEventListener("keyup", renderStudents);

/* ------------------------------------
   RENDER EVENTS (READ ONLY)
------------------------------------- */
function renderEvents(){
  const tbody = $("eventsList");
  if(!CACHE.events.length){
    tbody.innerHTML = '<tr><td colspan="3" class="muted-small">No events</td></tr>';
    return;
  }

  const fType = $("filterType").value || "";
  const fLevel = $("filterLevel").value || "";

  tbody.innerHTML = "";
  CACHE.events.sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .forEach(ev=>{
      if(fType && ev.type!==fType) return;
      if(fLevel && ev.level!==fLevel) return;

      tbody.innerHTML += `
        <tr>
          <td>${escapeHtml(ev.name)}</td>
          <td>${escapeHtml(ev.type)}</td>
          <td>${escapeHtml(ev.level)}</td>
        </tr>
      `;
    });
}

$("btnFilterEvents").addEventListener("click", renderEvents);

/* ------------------------------------
   RENDER RESULTS
------------------------------------- */
function renderResults(){
  const tbody = $("leaderResultsTable");
  if(!CACHE.events.length){
    tbody.innerHTML = '<tr><td colspan="5" class="muted-small">No events</td></tr>';
    return;
  }

  const map = {};
  CACHE.results.forEach(r=>{
    if(!map[r.eventId]) map[r.eventId] = {};
    map[r.eventId][r.position] = r;
  });

  tbody.innerHTML = "";

  CACHE.events.sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .forEach(ev=>{
      const pos = map[ev.id] || {};
      const first  = pos[1] ? studentInfo(pos[1].studentId) : "";
      const second = pos[2] ? studentInfo(pos[2].studentId) : "";
      const third  = pos[3] ? studentInfo(pos[3].studentId) : "";
      const pub = (pos[1]&&pos[1].published)||(pos[2]&&pos[2].published)||(pos[3]&&pos[3].published);
      const badge = pub ? `<span class="badge bg-success">Published</span>` 
                        : `<span class="badge bg-secondary">Draft</span>`;

      tbody.innerHTML += `
        <tr>
          <td>${escapeHtml(ev.name)}</td>
          <td>${first}</td>
          <td>${second}</td>
          <td>${third}</td>
          <td>${badge}</td>
        </tr>
      `;
    });

  function studentInfo(id){
    const s = CACHE.students.find(x=>String(x.id)===String(id));
    if(!s) return id;
    return `${escapeHtml(s.name)} (${escapeHtml(s.id)})`;
  }
}

/* ------------------------------------
   RENDER TEAM SECTION (VIEW ONLY)
------------------------------------- */
function renderTeamView(){
  const wrap = $("teamMembersSmall");
  wrap.innerHTML = "";

  const teamGroups = {};
  CACHE.students.forEach(s=>{
    if(!teamGroups[s.teamId]) teamGroups[s.teamId] = [];
    teamGroups[s.teamId].push(s);
  });

  const teamsSorted = [...CACHE.teams].sort((a,b)=>(a.name||"").localeCompare(b.name||""));

  teamsSorted.forEach(team=>{
    wrap.innerHTML += `<h6 class="mt-2 mb-1" style="font-weight:700">${escapeHtml(team.name)}</h6>`;
    const members = teamGroups[team.id] || [];
    members.forEach(m=>{
      wrap.innerHTML += `<div class="muted-small">${escapeHtml(m.name)} (${escapeHtml(m.id)})</div>`;
    });
    wrap.innerHTML += "<hr>";
  });
}

/* current year */
$("current-year").textContent = new Date().getFullYear();

</script>
</body>
</html>