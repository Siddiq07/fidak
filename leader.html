<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader Pro â€” Markaz Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #0d121c; --card: #1c2738; --text: #e2e8f0; --muted: #94a3b8;
      --accent-main: #f97316; --accent-secondary: #3b82f6;
      --stat-red: #dc2626; --stat-orange: #f97316; --stat-pink: #d946ef; --stat-dark: #1d4ed8; 
      --border: #334155;
    }
    
    [data-theme="light"] {
      --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; --muted: #64748b;
      --border: #e2e8f0;
    }

    body { background: var(--bg); color: var(--text); font-family: 'Inter', system-ui, sans-serif; transition: background 0.3s; }
    .container-wide { max-width: 1100px; margin: auto; padding: 15px; }
    
    .card-neo { background: var(--card); border-radius: 12px; padding: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-bottom: 14px; border: 1px solid var(--border); transition: 0.3s; }
    
    /* Top Nav */
    .top-nav { background: var(--bg); border-bottom: 1px solid var(--border); }
    .nav-btn { color: var(--muted); border: 1px solid var(--border); background: var(--card); margin-right: 5px; font-weight: 600; font-size: 14px; }
    .nav-btn.active { background: var(--accent-secondary); color: #fff; border-color: var(--accent-secondary); }

    /* Results View (Video Style) - Always White Card */
    .res-container { padding: 0; background: transparent; }
    .res-card { background: #ffffff !important; color: #0f172a !important; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; border: none; }
    .res-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    .res-cat { font-weight: 700; font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
    .res-name { font-weight: 800; font-size: 1.1rem; color: #0f172a; }
    .btn-view-res { background: #0f172a; color: white; border: none; padding: 6px 18px; border-radius: 6px; font-weight: 600; font-size: 13px; }
    .res-body { padding: 0 20px 20px; background: #fff; border-top: 1px solid #f1f5f9; }
    .winner-row { display: flex; align-items: center; padding: 12px; background: #f8fafc; border-radius: 8px; margin-top: 10px; color: #1e293b; }
    .rank-num { width: 30px; height: 30px; border-radius: 50%; background: #3b82f6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-right: 12px; }

    /* Selection Boxes */
    .small-box { width: 70px; height: 70px; border-radius: 8px; background: var(--border); display: inline-flex; flex-direction: column; align-items: center; justify-content: center; margin: 6px; cursor: pointer; font-weight: 700; transition: 0.2s; }
    .small-box.selected { background: var(--accent-secondary); color: #fff; transform: scale(1.05); }
    .small-box span { font-size: 10px; font-weight: normal; margin-top: 2px; }

    .theme-toggle { cursor: pointer; font-size: 1.4rem; color: var(--accent-secondary); margin-right: 15px; }
  </style>
</head>
<body>

<nav class="top-nav">
  <div class="container-wide d-flex align-items-center justify-content-between py-3">
    <div style="font-weight: 900; color: var(--accent-main); font-size: 22px;">MARKAZ FEST</div>
    <div class="d-flex align-items-center">
      <i class="bi bi-moon-stars-fill theme-toggle" id="themeBtn"></i>
      <button id="btnLogout" class="btn btn-sm btn-outline-danger">Logout</button>
    </div>
  </div>
  <div class="container-wide d-flex gap-2 py-2 overflow-x-auto">
    <button class="btn nav-btn active" data-target="#panel-dashboard">Dashboard</button>
    <button class="btn nav-btn" data-target="#panel-events">Nominations</button>
    <button class="btn nav-btn" data-target="#panel-approved">Approved</button>
    <button class="btn nav-btn" data-target="#panel-results">Results</button>
  </div>
</nav>

<main class="container-wide">
  <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index: 12000"></div>

  <section id="panel-dashboard">
    <div class="card-neo d-flex align-items-center gap-3">
      <div id="u-avatar" style="width:60px;height:60px;background:var(--accent-secondary);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:24px;color:#fff">L</div>
      <div>
        <h3 id="u-name" class="m-0">Loading...</h3>
        <p id="u-team" class="text-muted m-0">Team: --</p>
      </div>
    </div>
    <div class="row g-3">
      <div class="col-6 col-md-3"><div class="card-neo text-center"><small>Score</small><h2 id="s-score">0</h2></div></div>
      <div class="col-6 col-md-3"><div class="card-neo text-center"><small>Members</small><h2 id="s-members">0</h2></div></div>
      <div class="col-6 col-md-3"><div class="card-neo text-center"><small>Attendance</small><h2 id="s-att">0%</h2></div></div>
      <div class="col-6 col-md-3"><div class="card-neo text-center"><small>Approved</small><h2 id="s-app">0</h2></div></div>
    </div>
  </section>

  <section id="panel-events" class="d-none">
    <div class="row g-3">
      <div class="col-lg-5">
        <div class="card-neo">
          <input type="text" id="evSearch" class="form-control mb-3" placeholder="Search events...">
          <div id="evList" style="max-height: 450px; overflow-y: auto;"></div>
        </div>
      </div>
      <div class="col-lg-7">
        <div class="card-neo">
          <h4 id="sel-ev-title">Select an Event</h4>
          <p id="sel-ev-meta" class="muted-small mb-3"></p>
          <div id="memberSelectionGrid" class="d-flex flex-wrap"></div>
          <button id="btnSaveNom" class="btn btn-primary w-100 mt-4 fw-bold py-2">Save Selection</button>
        </div>
      </div>
    </div>
  </section>

  <section id="panel-approved" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="m-0">Approved Events</h4>
      <button id="btnExportPdf" class="btn btn-success"><i class="bi bi-file-earmark-pdf"></i> Export PDF</button>
    </div>
    <div id="approvedContainer"></div>
  </section>

  <section id="panel-results" class="d-none">
    <h4 class="mb-3">Official Results</h4>
    <div id="resultsContainer" class="res-container"></div>
  </section>
</main>

<div class="modal fade" id="memberModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content card-neo border-0">
      <div class="modal-header border-0"><h5>Approved Members</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="memberModalBody"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
    authDomain: "gen7-3e139.firebaseapp.com",
    databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
    projectId: "gen7-3e139",
    storageBucket: "gen7-3e139.firebasestorage.app",
    messagingSenderId: "578412378966",
    appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let CACHE = { students: [], teams: [], events: [], participations: [], results: [], attendance: {} };
  let KEYMAP = { parts: {} };
  let LEADER = { id: null, teamId: null };
  let currentEventId = null;

  // Theme Logic
  const themeBtn = document.getElementById('themeBtn');
  themeBtn.onclick = () => {
    const isDark = document.body.getAttribute('data-theme') !== 'light';
    document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    themeBtn.className = isDark ? 'bi bi-sun-fill theme-toggle' : 'bi bi-moon-stars-fill theme-toggle';
  };

  // Data Sync
  onValue(ref(db, '/'), (snap) => {
    const d = snap.val() || {};
    CACHE.students = Object.values(d.students || {});
    CACHE.teams = Object.values(d.teams || {});
    CACHE.events = Object.values(d.events || {});
    CACHE.results = Object.values(d.results || {});
    CACHE.attendance = d.attendance || {};
    
    const partsRaw = d.participations || {};
    CACHE.participations = Object.entries(partsRaw).map(([k, v]) => {
        KEYMAP.parts[v.id || k] = k;
        return { ...v, dbKey: k };
    });

    boot();
  });

  function boot() {
    const qId = sessionStorage.getItem('leaderId') || new URLSearchParams(window.location.search).get('leader');
    if (!qId) return; sessionStorage.setItem('leaderId', qId);

    const user = CACHE.students.find(s => String(s.id) === String(qId));
    const team = CACHE.teams.find(t => t.id === user?.teamId);
    if (!team) return;

    LEADER = { id: qId, teamId: team.id };
    document.getElementById('u-name').innerText = user.name;
    document.getElementById('u-team').innerText = `Team: ${team.name} (#${team.id})`;
    document.getElementById('s-score').innerText = team.score || 0;
    document.getElementById('s-members').innerText = CACHE.students.filter(s => s.teamId === team.id).length;
    document.getElementById('s-app').innerText = CACHE.participations.filter(p => p.teamId === team.id && p.status === 'approved').length;

    renderEventsList();
    renderResults();
    renderApproved();
  }

  // Nomination Logic + Filter (Senior/Junior)
  function renderEventsList() {
    const list = document.getElementById('evList');
    const q = document.getElementById('evSearch').value.toLowerCase();
    list.innerHTML = CACHE.events.filter(e => e.name.toLowerCase().includes(q)).map(ev => `
      <div class="p-3 border-bottom d-flex justify-content-between align-items-center" style="cursor:pointer" onclick="window.loadSelection('${ev.id}')">
        <div><b>${ev.name}</b><br><small class="text-muted">${ev.level} | ${ev.type}</small></div>
        <i class="bi bi-chevron-right"></i>
      </div>
    `).join('');
  }

  window.loadSelection = (evId) => {
    currentEventId = evId;
    const ev = CACHE.events.find(e => String(e.id) === String(evId));
    document.getElementById('sel-ev-title').innerText = ev.name;
    document.getElementById('sel-ev-meta').innerText = `Category: ${ev.level} (Selection Restricted)`;

    const grid = document.getElementById('memberSelectionGrid');
    
    // FILTER LOGIC
    let teamMembers = CACHE.students.filter(s => s.teamId === LEADER.teamId);
    const cat = ev.level.toLowerCase();
    if (cat === 'senior') teamMembers = teamMembers.filter(s => s.level?.toLowerCase() === 'senior');
    else if (cat === 'junior') teamMembers = teamMembers.filter(s => s.level?.toLowerCase() === 'junior');

    const selected = CACHE.participations.filter(p => p.eventId == evId && p.teamId == LEADER.teamId).map(p => String(p.studentId));

    grid.innerHTML = teamMembers.map(m => `
      <div class="small-box ${selected.includes(String(m.id)) ? 'selected' : ''}" data-id="${m.id}" onclick="this.classList.toggle('selected')">
        <b>${m.id}</b><span>${m.name.split(' ')[0]}</span>
      </div>
    `).join('');
  };

  document.getElementById('btnSaveNom').onclick = async () => {
    if (!currentEventId) return;
    const selectedIds = Array.from(document.querySelectorAll('.small-box.selected')).map(el => el.dataset.id);
    
    // Cleanup old pending
    const oldOnes = CACHE.participations.filter(p => p.eventId == currentEventId && p.teamId == LEADER.teamId && p.status === 'pending');
    for (let o of oldOnes) await remove(ref(db, `participations/${o.dbKey}`));

    // Add new
    for (let sid of selectedIds) {
        const existing = CACHE.participations.find(p => p.eventId == currentEventId && p.studentId == sid);
        if(!existing) {
            await push(ref(db, 'participations'), {
                eventId: currentEventId, studentId: sid, teamId: LEADER.teamId, status: 'pending', id: Date.now() + sid
            });
        }
    }
    alert('Selection saved!');
  };

  // Results View (White Card Accordion)
  function renderResults() {
    const wrap = document.getElementById('resultsContainer');
    const publishedIds = [...new Set(CACHE.results.filter(r => r.published).map(r => String(r.eventId)))];
    
    wrap.innerHTML = CACHE.events.filter(e => publishedIds.includes(String(e.id))).map(ev => {
      const wins = CACHE.results.filter(r => String(r.eventId) == String(ev.id) && r.published).sort((a,b)=>a.position-b.position);
      return `
        <div class="res-card">
          <div class="res-header" onclick="const b=this.nextElementSibling; b.classList.toggle('d-none')">
            <div><div class="res-cat">${ev.level}</div><div class="res-name">${ev.name}</div></div>
            <button class="btn-view-res">View</button>
          </div>
          <div class="res-body d-none">
            ${wins.map(w => {
              const s = CACHE.students.find(st => String(st.id) === String(w.studentId));
              return `<div class="winner-row"><div class="rank-num">${w.position}</div><div><b>${s?.name || 'Unknown'}</b><br><small>${w.alias || ''}</small></div></div>`;
            }).join('')}
          </div>
        </div>
      `;
    }).join('');
  }

  // Approved Panel
  function renderApproved() {
    const wrap = document.getElementById('approvedContainer');
    const apps = CACHE.participations.filter(p => p.teamId === LEADER.teamId && p.status === 'approved');
    const grouped = apps.reduce((acc, p) => {
        acc[p.eventId] = acc[p.eventId] || [];
        acc[p.eventId].push(p.studentId);
        return acc;
    }, {});

    wrap.innerHTML = Object.entries(grouped).map(([evId, sids]) => {
      const ev = CACHE.events.find(e => String(e.id) === evId);
      return `
        <div class="card-neo d-flex justify-content-between align-items-center">
          <div><b>${ev?.name}</b><br><small class="text-muted">${sids.length} Approved</small></div>
          <button class="btn btn-sm btn-outline-primary" onclick="window.viewApp('${evId}')">View Members</button>
        </div>
      `;
    }).join('');
  }

  window.viewApp = (evId) => {
    const pList = CACHE.participations.filter(p => p.eventId == evId && p.teamId == LEADER.teamId && p.status === 'approved');
    const body = document.getElementById('memberModalBody');
    body.innerHTML = pList.map(p => {
        const s = CACHE.students.find(x => String(x.id) === String(p.studentId));
        return `<div class="p-2 border-bottom"><b>${p.studentId}</b> - ${s?.name}</div>`;
    }).join('');
    new bootstrap.Modal(document.getElementById('memberModal')).show();
  };

  // PDF Generation
  document.getElementById('btnExportPdf').onclick = () => {
    const apps = CACHE.participations.filter(p => p.teamId === LEADER.teamId && p.status === 'approved');
    let h = `<h2>Approved Participation List</h2><table border="1" style="width:100%; border-collapse: collapse;"><tr><th>Event</th><th>Level</th><th>Members</th></tr>`;
    const grouped = apps.reduce((acc, p) => { acc[p.eventId] = acc[p.eventId] || []; acc[p.eventId].push(p.studentId); return acc; }, {});
    Object.entries(grouped).forEach(([eid, sids]) => {
        const ev = CACHE.events.find(e => String(e.id) === eid);
        h += `<tr><td>${ev.name}</td><td>${ev.level}</td><td>${sids.join(', ')}</td></tr>`;
    });
    h += `</table>`;
    html2pdf().from(h).save('Approved_Participations.pdf');
  };

  // Nav Logic
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('section').forEach(s => s.classList.add('d-none'));
      document.querySelector(btn.dataset.target).classList.remove('d-none');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    };
  });

  document.getElementById('evSearch').oninput = renderEventsList;
  document.getElementById('btnLogout').onclick = () => { sessionStorage.clear(); location.href='index.html'; };

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
