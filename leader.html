<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader Dashboard — Fidak Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: #334155;
      --text-primary: #f8fafc; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
      --accent-primary: #3b82f6; --accent-secondary: #10b981;
      --accent-warning: #f59e0b; --accent-danger: #ef4444;
      --border-color: #475569; --shadow-color: rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="light"] {
      --bg-primary: #f1f5f9; --bg-secondary: #ffffff; --bg-card: #ffffff;
      --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #64748b;
      --accent-primary: #2563eb; --border-color: #e2e8f0; --shadow-color: rgba(0, 0, 0, 0.05);
    }

    body { background: var(--bg-primary); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100vh; }
    .container-wide { max-width: 1200px; margin: 0 auto; padding: 0 16px; }

    .main-header { background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); padding: 16px 0; position: sticky; top: 0; z-index: 1000; }
    .logo { font-weight: 900; font-size: 28px; color: var(--accent-primary); letter-spacing: -0.5px; }

    .nav-tabs-modern { display: flex; gap: 4px; padding: 16px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; overflow-x: auto; }
    .nav-tab { padding: 10px 20px; background: transparent; border: 2px solid var(--border-color); border-radius: 10px; color: var(--text-secondary); font-weight: 600; font-size: 14px; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .nav-tab.active { background: var(--accent-primary); border-color: var(--accent-primary); color: white; }

    .simple-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; border: 1px solid var(--border-color); }
    .stat-value { font-size: 32px; font-weight: 800; color: var(--text-primary); }

    .nominations-container { display: grid; grid-template-columns: 300px 1fr; gap: 20px; margin-top: 20px; }
    .event-list { max-height: 600px; overflow-y: auto; }
    .event-item { padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 8px; cursor: pointer; background: var(--bg-card); transition: 0.2s; }
    .event-item.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--accent-primary); }

    .members-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .member-box { background: var(--bg-card); border: 2px solid var(--border-color); border-radius: 8px; padding: 12px; text-align: center; cursor: pointer; position: relative; transition: 0.2s; }
    .member-box.selected { background: rgba(59, 130, 246, 0.1); border-color: var(--accent-primary); }
    .member-box.disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(0.8); }

    .toast-msg { position: fixed; bottom: 20px; right: 20px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 24px; z-index: 9999; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

    @media (max-width: 992px) { .nominations-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <header class="main-header">
    <div class="container-wide d-flex justify-content-between align-items-center">
      <div class="logo">FIDAK FEST</div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary btn-sm" onclick="toggleTheme()"><i class="bi bi-moon-stars" id="themeIcon"></i></button>
        <button class="btn btn-danger btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i></button>
      </div>
    </div>
  </header>

  <div class="container-wide">
    <div class="nav-tabs-modern">
      <button class="nav-tab active" data-target="dashboard"><i class="bi bi-speedometer2"></i> Dashboard</button>
      <button class="nav-tab" data-target="nominations"><i class="bi bi-calendar-plus"></i> Nominations</button>
      <button class="nav-tab" data-target="approved"><i class="bi bi-check-circle"></i> Approved/Pending</button>
      <button class="nav-tab" data-target="results"><i class="bi bi-trophy"></i> Results</button>
    </div>

    <section id="dashboard" class="content-section">
      <div class="simple-card d-flex align-items-center gap-3">
        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width:60px;height:60px;font-size:24px;font-weight:bold" id="userAvatar">?</div>
        <div>
          <h4 id="userName" class="mb-0">Loading...</h4>
          <p class="text-muted mb-0" id="userTeam">Team: --</p>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="teamScore">0</div><div class="text-muted small">TEAM SCORE</div></div>
        <div class="stat-card"><div class="stat-value" id="countApproved">0</div><div class="text-muted small">APPROVED</div></div>
        <div class="stat-card"><div class="stat-value" id="countPending">0</div><div class="text-muted small">PENDING</div></div>
      </div>
    </section>

    <section id="nominations" class="content-section d-none">
      <div class="simple-card">
        <div class="alert alert-info py-2 small"><i class="bi bi-info-circle me-2"></i> Limits: Individual Max 2 per event | Group Max 5 per event.</div>
        <div class="nominations-container">
          <div>
            <h5>Events</h5>
            <input type="text" class="form-control bg-dark text-white border-secondary mb-2" placeholder="Search..." id="eventSearch" oninput="renderEvents()">
            <div class="event-list" id="eventList"></div>
          </div>
          <div>
            <div id="selectionHeader"><h5>Select Members</h5><p class="text-muted">Pick an event to see eligible members.</p></div>
            <div class="members-grid mt-3" id="memberGrid"></div>
            <div class="mt-4 border-top pt-3">
              <button class="btn btn-primary w-100 fw-bold" id="btnSave" onclick="saveNominations()" disabled>SAVE NOMINATIONS</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="approved" class="content-section d-none">
      <div class="simple-card">
        <div class="d-flex justify-content-between mb-3">
            <h4>Submission Status</h4>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-success" onclick="exportExcel()">Excel</button>
                <button class="btn btn-sm btn-outline-danger" onclick="exportPDF()">PDF</button>
            </div>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-hover small">
            <thead><tr><th>Student</th><th>Level</th><th>Event</th><th>Status</th></tr></thead>
            <tbody id="statusTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="results" class="content-section d-none">
      <div class="row" id="resultsGrid"></div>
    </section>
  </div>

  <div id="toast" class="toast-msg d-none"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let CACHE = { students: [], teams: [], events: [], parts: [], results: [] };
    let USER = null;
    let selectedEventId = null;
    let selectedSet = new Set();

    // --- Initialization ---
    onValue(ref(db, '/'), (snap) => {
      const d = snap.val() || {};
      CACHE.students = Object.values(d.students || {});
      CACHE.teams = Object.values(d.teams || {});
      CACHE.events = Object.values(d.events || {});
      CACHE.results = Object.values(d.results || {});
      CACHE.parts = Object.entries(d.participations || {}).map(([k,v]) => ({...v, fbKey: k}));

      if(!USER) initUser();
      refreshUI();
    });

    function initUser() {
      const id = sessionStorage.getItem('leaderId') || new URLSearchParams(window.location.search).get('leader');
      if(!id) { window.location.href = 'index.html'; return; }
      const s = CACHE.students.find(x => String(x.id) === String(id));
      const t = CACHE.teams.find(x => x.id === s?.teamId);
      if(s && t) {
        USER = {...s, teamName: t.name, teamScore: t.score};
        document.getElementById('userName').innerText = s.name;
        document.getElementById('userTeam').innerText = `Team: ${t.name}`;
        document.getElementById('userAvatar').innerText = s.name[0];
      }
    }

    function refreshUI() {
      const myParts = CACHE.parts.filter(p => p.teamId === USER?.teamId);
      document.getElementById('teamScore').innerText = CACHE.teams.find(t => t.id === USER?.teamId)?.score || 0;
      document.getElementById('countApproved').innerText = myParts.filter(p => p.status === 'approved').length;
      document.getElementById('countPending').innerText = myParts.filter(p => p.status === 'pending').length;

      renderEvents();
      renderStatus();
      renderResults();
      if(selectedEventId) renderMembers();
    }

    // --- Event List ---
    window.renderEvents = () => {
      const q = document.getElementById('eventSearch').value.toLowerCase();
      const list = document.getElementById('eventList');
      list.innerHTML = CACHE.events.filter(e => e.name.toLowerCase().includes(q)).map(e => `
        <div class="event-item ${selectedEventId === e.id ? 'selected' : ''}" onclick="selectEvent('${e.id}')">
          <div class="small text-primary fw-bold">${e.level} • ${e.type}</div>
          <div class="fw-bold">${e.name}</div>
        </div>
      `).join('');
    };

    window.selectEvent = (id) => {
      selectedEventId = id;
      selectedSet.clear();
      const e = CACHE.events.find(x => x.id === id);
      document.getElementById('selectionHeader').innerHTML = `<h5>${e.name}</h5><span class="badge bg-primary">${e.type}</span> <span class="badge bg-secondary">${e.level}</span>`;
      
      // Load current pending choices
      CACHE.parts.filter(p => p.eventId === id && p.teamId === USER.teamId && p.status === 'pending')
                 .forEach(p => selectedSet.add(String(p.studentId)));

      renderMembers();
      renderEvents();
      document.getElementById('btnSave').disabled = false;
    };

    // --- Member Grid ---
    window.renderMembers = () => {
      const grid = document.getElementById('memberGrid');
      const event = CACHE.events.find(e => e.id === selectedEventId);
      const mates = CACHE.students.filter(s => s.teamId === USER.teamId);

      grid.innerHTML = mates.map(m => {
        const { eligible, reason } = checkEligible(m, event);
        const active = selectedSet.has(String(m.id));
        return `
          <div class="member-box ${active ? 'selected' : ''} ${!eligible && !active ? 'disabled' : ''}" 
               onclick="${eligible || active ? `toggleMem('${m.id}')` : ''}" title="${reason}">
            <div class="fw-bold">${m.id}</div>
            <div class="small text-truncate">${m.name}</div>
            <div style="font-size:10px" class="text-uppercase text-muted">${m.level}</div>
          </div>
        `;
      }).join('');
    };

    window.toggleMem = (id) => {
      const s = String(id);
      if(selectedSet.has(s)) selectedSet.delete(s);
      else selectedSet.add(s);
      renderMembers();
    };

    // --- Limits & Rules ---
    function checkEligible(student, event) {
      if(!event) return { eligible: false };
      // 1. Level Match
      if(event.level !== 'General' && event.level !== student.level) return { eligible: false, reason: "Wrong Level" };

      // 2. Personal Limits (Approved records only)
      const approved = CACHE.parts.filter(p => String(p.studentId) === String(student.id) && p.status === 'approved');
      const stages = approved.filter(p => CACHE.events.find(e => e.id === p.eventId)?.type === 'Stage').length;
      const nonStages = approved.filter(p => CACHE.events.find(e => e.id === p.eventId)?.type === 'Non-Stage').length;

      if(event.type === 'Stage' && stages >= (student.level === 'Senior' ? 3 : 2)) return { eligible: false, reason: "Stage Limit" };
      if(event.type === 'Non-Stage' && nonStages >= (student.level === 'Senior' ? 4 : 3)) return { eligible: false, reason: "Non-Stage Limit" };

      // 3. Team Capacity (2 for indv/stage, 5 for group)
      const inEvent = CACHE.parts.filter(p => p.eventId === event.id && p.teamId === USER.teamId).length;
      const max = (event.type === 'Group') ? 5 : 2;
      if(inEvent >= max && !selectedSet.has(String(student.id))) return { eligible: false, reason: "Team Full" };

      return { eligible: true };
    }

    // --- Database Save ---
    window.saveNominations = async () => {
      const btn = document.getElementById('btnSave');
      btn.disabled = true; btn.innerText = "Saving...";
      try {
        const old = CACHE.parts.filter(p => p.eventId === selectedEventId && p.teamId === USER.teamId && p.status === 'pending');
        for(let p of old) await remove(ref(db, `participations/${p.fbKey}`));

        for(let sId of selectedSet) {
          await push(ref(db, 'participations'), {
            eventId: selectedEventId, studentId: sId, teamId: USER.teamId, status: 'pending', ts: Date.now()
          });
        }
        showToast("Updated Successfully!");
      } catch(e) { showToast("Save Failed"); }
      finally { btn.disabled = false; btn.innerText = "SAVE NOMINATIONS"; }
    };

    // --- Helpers ---
    function renderStatus() {
      const my = CACHE.parts.filter(p => p.teamId === USER?.teamId);
      document.getElementById('statusTable').innerHTML = my.map(p => {
        const s = CACHE.students.find(x => String(x.id) === String(p.studentId));
        const e = CACHE.events.find(x => x.id === p.eventId);
        return `<tr><td>${s?.name}</td><td>${s?.level}</td><td>${e?.name}</td><td><span class="badge ${p.status === 'approved' ? 'bg-success' : 'bg-warning'}">${p.status}</span></td></tr>`;
      }).join('');
    }

    function renderResults() {
      const pub = CACHE.results.filter(r => r.published);
      document.getElementById('resultsGrid').innerHTML = pub.map(r => {
        const e = CACHE.events.find(x => x.id === r.eventId);
        const s = CACHE.students.find(x => String(x.id) === String(r.studentId));
        return `<div class="col-md-6"><div class="simple-card d-flex justify-content-between"><div><small class="text-primary">${e?.name}</small><h6>${s?.name}</h6></div><span class="badge bg-primary h-50">Rank ${r.position}</span></div></div>`;
      }).join('');
    }

    window.showToast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.classList.remove('d-none'); setTimeout(()=>t.classList.add('d-none'),3000); };
    window.toggleTheme = () => { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); };
    window.logout = () => { sessionStorage.clear(); window.location.href = 'index.html'; };

    document.querySelectorAll('.nav-tab').forEach(t => {
      t.onclick = () => {
        document.querySelectorAll('.nav-tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.content-section').forEach(x => x.classList.add('d-none'));
        t.classList.add('active');
        document.getElementById(t.dataset.target).classList.remove('d-none');
      }
    });

  </script>
</body>
</html>
