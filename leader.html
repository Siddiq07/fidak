<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Leader â€” Markaz Fest</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --bg: #0d121c; 
      --card: #1c2738; 
      --text: #e2e8f0; 
      --muted: #94a3b8; 
      --accent-main: #f97316; 
      --accent-secondary: #3b82f6; 
      --stat-red: #dc2626; 
      --stat-orange: #f97316;
      --stat-pink: #d946ef; 
      --stat-dark: #1d4ed8; 
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;color:var(--text);background:var(--bg)}
    .container-wide{max-width:1100px;margin:14px auto;padding:0 12px}
    .card-neo{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 4px 10px rgba(0,0,0,0.3);margin-bottom:14px;border:1px solid #334155;}
    .section-title{font-weight:700;margin-bottom:12px;color:var(--text);font-size:1.2rem;}
    .muted-small{color:var(--muted);font-size:13px}
    
    .btn-accent{background:var(--accent-main);color:#fff;border:0}
    .btn-accent:hover{background:#ea580c;color:#fff}
    
    .form-control, .form-select{background:#334155;color:var(--text);border:1px solid #475569;}
    
    .top-nav{background:var(--bg);border-bottom:1px solid #334155;}
    .brand{font-weight:800;color:var(--accent-main);font-size:1.5rem}
    .nav-btn{color:var(--muted);border:1px solid #334155;background:var(--card);}
    .nav-btn.active{background:var(--accent-secondary);color:#fff;border-color:var(--accent-secondary);}

    .leader-info{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .leader-avatar{width:56px;height:56px;border-radius:10px;background:var(--accent-secondary);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:1.5rem}
    .stats-grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));gap:12px;margin-top:10px;}
    .stat{padding:20px;border-radius:10px;color:#fff;height: 100px;position: relative;}
    .stat .title{font-size:13px;font-weight:500;margin-bottom:4px}
    .stat .big{font-weight:800;font-size:2rem;line-height:1}
    .stat-bg-red{background-color:var(--stat-red);}
    .stat-bg-orange{background-color:var(--stat-orange);}
    .stat-bg-pink{background-color:var(--stat-pink);}
    .stat-bg-dark{background-color:var(--stat-dark);}

    /* --- RESULTS UI (MATCHING VIDEO) --- */
    .results-container { padding: 0; background: transparent; }
    .result-list-item {
        background: #fff; /* White background for results cards */
        color: #1e293b;
        border-radius: 12px;
        padding: 0;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        overflow: hidden;
        border: none;
    }
    .result-header {
        padding: 14px 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .result-header-left { flex-grow: 1; }
    .result-zone {
        font-weight: 700;
        font-size: 0.7rem;
        color: #64748b;
        text-transform: uppercase;
        margin-bottom: 2px;
    }
    .result-event-name { font-weight: 700; font-size: 1.05rem; color: #0f172a; }
    .result-event-id {
        font-size: 0.75rem;
        color: #3b82f6;
        background: #eff6ff;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 600;
        margin-right: 8px;
    }
    .btn-view-results {
        background: #0f172a;
        color: #fff;
        border: none;
        padding: 6px 20px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.85rem;
        transition: opacity 0.2s;
    }
    .btn-view-results:hover { opacity: 0.9; color: #fff; }

    .result-body { padding: 0 18px 18px; background: #fff; border-top: 1px solid #f1f5f9; }
    .winner-row {
        display: flex;
        align-items: center;
        padding: 10px;
        background: #f8fafc;
        border-radius: 8px;
        margin-top: 8px;
    }
    .pos-circle {
        width: 26px; height: 26px; border-radius: 50%;
        background: #3b82f6; color: #fff;
        display: flex; align-items: center; justify-content: center;
        font-weight: 800; font-size: 0.75rem; margin-right: 12px;
    }

    .small-box{
      width:70px;height:70px;border-radius:8px;
      background:#334155;display:inline-flex;flex-direction:column;
      align-items:center;justify-content:center;margin:6px;
      cursor:pointer;font-weight:700;
    }
    .small-box.selected{background:var(--accent-secondary);color:#fff}
    .modal-content{background:var(--card);color:var(--text);}
    .btn-close{filter: invert(1) grayscale(100%) brightness(200%);}
    
    @media (max-width:768px){ .stats-grid{grid-template-columns: repeat(2, 1fr);} }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="container container-wide d-flex align-items-center justify-content-between py-3">
      <div class="brand d-flex align-items-center gap-2"><i class="bi bi-person-badge-fill"></i> Leader Panel</div>
      <button id="btnLogout" class="btn btn-outline-danger ms-2"><i class="bi bi-box-arrow-right"></i> Logout</button>
    </div>
    <div class="container container-wide d-flex gap-2 py-2 overflow-x-auto">
      <button class="btn btn-light nav-btn active" data-target="#panel-dashboard">Dashboard</button>
      <button class="btn btn-light nav-btn" data-target="#panel-events">Events</button>
      <button class="btn btn-light nav-btn" data-target="#panel-results">Results</button>
      <button class="btn btn-light nav-btn" data-target="#panel-team">Team Info</button>
    </div>
  </nav>

  <main class="container container-wide">
    <div id="toastRoot" class="position-fixed bottom-0 end-0 p-3" style="z-index:12000"></div>

    <section id="panel-dashboard">
      <div class="leader-info card-neo">
        <div id="leaderAvatar" class="leader-avatar">G</div>
        <div>
          <div id="leaderName" style="font-weight:800; font-size: 1.5rem;">Guest</div>
          <div id="leaderTeamName" class="muted-small">Team: -</div>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat stat-bg-red"><div class="title">Team Score</div><div id="statScore" class="big">0</div></div>
        <div class="stat stat-bg-orange"><div class="title">Members</div><div id="statMembers" class="big">0</div></div>
        <div class="stat stat-bg-pink"><div class="title">Attendance %</div><div id="statAttendance" class="big">0%</div></div>
        <div class="stat stat-bg-dark"><div class="title">Approved Events</div><div id="quickApproved" class="big">0</div></div>
      </div>
    </section>

    <section id="panel-events" class="card-neo d-none">
      <div class="row g-3">
        <div class="col-lg-5">
            <div class="section-title">Available Events</div>
            <input id="eventSearch" class="form-control mb-2" placeholder="Search events...">
            <div class="table-responsive" style="max-height:400px;overflow:auto">
              <table class="table table-sm table-dark">
                <tbody id="eventsList"></tbody>
              </table>
            </div>
        </div>
        <div class="col-lg-7">
          <div class="card-neo">
            <div id="selectedEventName" style="font-weight:800;font-size:1.3rem;">Select an Event</div>
            <div id="membersSelection" class="mt-3" style="display:flex;flex-wrap:wrap;"></div>
            <div class="mt-3">
              <button id="btnSubmitParticipation" class="btn btn-accent">Submit Participation</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-results" class="d-none">
      <div class="section-title text-white">Published Results</div>
      <div id="leaderResultsList" class="results-container">
        </div>
    </section>

    <section id="panel-team" class="card-neo d-none">
      <div class="section-title">Team Members</div>
      <div id="teamMembersSmall"></div>
    </section>
  </main>

<script type="module">
  document.addEventListener('DOMContentLoaded', async () => {
    const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js");
    const { getDatabase, ref, push, set, onValue, remove } = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-database.js");

    const firebaseConfig = {
      apiKey: "AIzaSyBMDGNukeonNa_-PWB-5cTO4GMofd3vyiM",
      authDomain: "gen7-3e139.firebaseapp.com",
      databaseURL: "https://gen7-3e139-default-rtdb.firebaseio.com",
      projectId: "gen7-3e139",
      storageBucket: "gen7-3e139.firebasestorage.app",
      messagingSenderId: "578412378966",
      appId: "1:578412378966:web:f76c1e69a01a4bbfbd74f7"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const $ = id => document.getElementById(id);
    let CACHE = { students: [], teams: [], events: [], participations: [], results: [] };
    let LEADER = { active:false, leaderId:null, teamId:null };

    onValue(ref(db, 'students'), s => { CACHE.students = Object.values(s.val()||{}); renderAll(); });
    onValue(ref(db, 'teams'), s => { CACHE.teams = Object.values(s.val()||{}); renderAll(); });
    onValue(ref(db, 'events'), s => { CACHE.events = Object.values(s.val()||{}); renderAll(); });
    onValue(ref(db, 'results'), s => { CACHE.results = Object.values(s.val()||{}); renderAll(); });
    onValue(ref(db, 'participations'), s => { CACHE.participations = Object.values(s.val()||{}); renderAll(); });

    function renderAll(){
        renderResultsList();
        populateEventsList();
        updateDashboard();
    }

    // --- RESULTS LOGIC: Filter only published and use white card UI ---
    function renderResultsList() {
        const wrap = $('leaderResultsList');
        wrap.innerHTML = '';
        
        const publishedIds = [...new Set(CACHE.results.filter(r => r.published).map(r => String(r.eventId)))];
        
        CACHE.events.filter(e => publishedIds.includes(String(e.id))).forEach(ev => {
            const winners = CACHE.results.filter(r => String(r.eventId) === String(ev.id) && r.published).sort((a,b)=>a.position-b.position);
            
            let winnersHtml = '';
            winners.forEach(w => {
                const s = CACHE.students.find(st => String(st.id) === String(w.studentId)) || {name:'Unknown'};
                winnersHtml += `<div class="winner-row"><div class="pos-circle">${w.position}</div><div><div style="font-weight:700">${s.name}</div><div class="muted-small">${w.alias||''}</div></div></div>`;
            });

            const card = document.createElement('div');
            card.className = 'result-list-item';
            card.innerHTML = `
                <div class="result-header">
                    <div class="result-header-left">
                        <div class="result-zone">${(ev.level||'General').toUpperCase()}</div>
                        <div class="result-event-name">${ev.name}</div>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="result-event-id">#${ev.id}</span>
                        <button class="btn btn-view-results" data-bs-toggle="collapse" data-bs-target="#res_${ev.id}">View</button>
                    </div>
                </div>
                <div class="collapse" id="res_${ev.id}"><div class="result-body">${winnersHtml}</div></div>
            `;
            wrap.appendChild(card);
        });
    }

    function populateEventsList(){
        const list = $('eventsList'); list.innerHTML = '';
        CACHE.events.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${ev.name}</td><td class="text-end"><button class="btn btn-sm btn-primary" onclick="window._selectEvent('${ev.id}')">Select</button></td>`;
            list.appendChild(tr);
        });
    }

    window._selectEvent = (id) => {
        const ev = CACHE.events.find(e => String(e.id) === String(id));
        $('selectedEventName').textContent = ev.name;
        const wrap = $('membersSelection'); wrap.innerHTML = '';
        CACHE.students.filter(s => String(s.teamId) === String(LEADER.teamId)).forEach(s => {
            const div = document.createElement('div');
            div.className = 'small-box';
            div.innerHTML = `<div>${s.id}</div><div style="font-size:10px">${s.name.split(' ')[0]}</div>`;
            div.onclick = () => div.classList.toggle('selected');
            wrap.appendChild(div);
        });
    };

    function updateDashboard(){
        const leaderId = sessionStorage.getItem('leaderId');
        if(!leaderId) return;
        const team = CACHE.teams.find(t => String(t.leaderId) === String(leaderId));
        if(team) {
            LEADER = { active:true, leaderId, teamId: team.id };
            $('leaderName').textContent = leaderId;
            $('leaderTeamName').textContent = `Team: ${team.name}`;
            $('statScore').textContent = team.score || 0;
        }
    }

    document.querySelectorAll('[data-target]').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('d-none'));
            $(btn.dataset.target.replace('#','')).classList.remove('d-none');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };
    });

    $('btnLogout').onclick = () => { sessionStorage.clear(); window.location.href='index.html'; };
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
